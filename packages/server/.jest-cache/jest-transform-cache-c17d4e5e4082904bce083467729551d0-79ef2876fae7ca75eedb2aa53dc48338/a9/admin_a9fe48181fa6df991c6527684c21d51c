89882ae71633081a78e4a7474b2d18dd
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const errorHandler_1 = require("../middleware/errorHandler");
const response_formats_1 = require("../constants/response-formats");
const shared_1 = require("@game/shared");
const database_fields_1 = require("../constants/database-fields");
const supabase_1 = require("../config/supabase");
const shared_2 = require("@game/shared");
const shared_3 = require("@game/shared");
const router = (0, express_1.Router)();
function requireAdminSecret(req, res) {
    const secret = process.env[shared_1.ENV_VARS.ADMIN_MAINTENANCE_SECRET];
    const provided = req.get('x-admin-maintenance-secret') || req.query.secret;
    if (!secret || !provided || secret !== String(provided)) {
        res.status(shared_2.HTTP_STATUS.UNAUTHORIZED).json({ success: false, error: response_formats_1.ERROR_MESSAGES.UNAUTHORIZED_ACCESS });
        return false;
    }
    return true;
}
// Seed a small universe of unowned planets in Supabase
router.post('/seed-supabase', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    if (!requireAdminSecret(req, res))
        return;
    const count = Math.min(Number(req.body?.count || 100), 2000);
    const serverId = 'A';
    const galaxy = 0; // A00
    const rows = [];
    for (let i = 1; i <= count; i++) {
        const region = Math.floor((i - 1) / 10); // arbitrary grouping
        const local = (i - 1) % 10;
        const coord = `${serverId}${galaxy.toString().padStart(2, '0')}:${region
            .toString()
            .padStart(2, '0')}:${local.toString().padStart(2, '0')}`;
        rows.push({ coord, type: 'planet', owner_id: null });
    }
    const { data, error } = await supabase_1.supabase
        .from(database_fields_1.DB_TABLES.LOCATIONS)
        .upsert(rows, { onConflict: 'coord' })
        .select('coord');
    if (error) {
        return res.status(shared_2.HTTP_STATUS.INTERNAL_SERVER_ERROR).json({ success: false, error: error.message });
    }
    res.json({ success: true, inserted: data?.length ?? 0 });
}));
// Backfill starter empire/colony/building for users without empire_id
router.post('/backfill-starters', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    if (!requireAdminSecret(req, res))
        return;
    // Fetch users with missing empire_id
    const { data: users, error: usersErr } = await supabase_1.supabase
        .from(database_fields_1.DB_TABLES.USERS)
        .select('id, email, username, empire_id, starting_coordinate')
        .is(database_fields_1.DB_FIELDS.BUILDINGS.EMPIRE_ID, null)
        .limit(200);
    if (usersErr) {
        return res.status(shared_2.HTTP_STATUS.INTERNAL_SERVER_ERROR).json({ success: false, error: usersErr.message });
    }
    let processed = 0;
    for (const u of users || []) {
        // Find an unowned planet
        const { data: planet, error: pickErr } = await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.LOCATIONS)
            .select('coord')
            .eq(database_fields_1.DB_FIELDS.CREDIT_TRANSACTIONS.TYPE, 'planet')
            .is(database_fields_1.DB_FIELDS.LOCATIONS.OWNER_ID, null)
            .limit(1)
            .single();
        if (pickErr || !planet) {
            break; // no more planets
        }
        const coord = planet.coord;
        // Claim planet
        const { error: claimErr } = await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.LOCATIONS)
            .update({ owner_id: u.id })
            .eq('coord', coord)
            .is(database_fields_1.DB_FIELDS.LOCATIONS.OWNER_ID, null);
        if (claimErr)
            continue;
        // Create empire
        const { data: empireRow, error: empErr } = await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.EMPIRES)
            .insert({
            user_id: u.id,
            name: u.username || 'Commander',
            home_system: coord,
            territories: [coord],
            credits: shared_3.GAME_CONSTANTS.STARTING_CREDITS,
            energy: 0,
        })
            .select(database_fields_1.DB_FIELDS.BUILDINGS.ID)
            .single();
        if (empErr || !empireRow)
            continue;
        // Create colony
        await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.COLONIES)
            .insert({ empire_id: empireRow.id, location_coord: coord, name: 'Home Base' });
        // Starter building
        await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.BUILDINGS)
            .insert({
            empire_id: empireRow.id,
            location_coord: coord,
            catalog_key: 'urban_structures',
            level: 1,
            is_active: true,
            construction_completed: new Date().toISOString(),
            credits_cost: 0,
        });
        // Update user
        await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.USERS)
            .update({ empire_id: empireRow.id, starting_coordinate: coord })
            .eq(database_fields_1.DB_FIELDS.BUILDINGS.ID, u.id);
        processed++;
    }
    res.json({ success: true, processed });
}));
exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFByb2plY3RzXFxBdHRyaXRpb25cXHBhY2thZ2VzXFxzZXJ2ZXJcXHNyY1xccm91dGVzXFxhZG1pbi50cyIsIm1hcHBpbmdzIjoiOztBQUFBLHFDQUFvRDtBQUNwRCw2REFBMEQ7QUFDMUQsb0VBQStEO0FBQy9ELHlDQUF3QztBQUN4QyxrRUFBb0U7QUFDcEUsaURBQThDO0FBRTlDLHlDQUEyQztBQUMzQyx5Q0FBOEM7QUFDOUMsTUFBTSxNQUFNLEdBQUcsSUFBQSxnQkFBTSxHQUFFLENBQUM7QUFFeEIsU0FBUyxrQkFBa0IsQ0FBQyxHQUFZLEVBQUUsR0FBYTtJQUNyRCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFRLENBQUMsd0JBQXdCLENBQUMsQ0FBQztJQUM5RCxNQUFNLFFBQVEsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLDRCQUE0QixDQUFDLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7SUFDM0UsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLFFBQVEsSUFBSSxNQUFNLEtBQUssTUFBTSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7UUFDeEQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxvQkFBVyxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLGlDQUFjLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDO1FBQ3pHLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQUVELHVEQUF1RDtBQUN2RCxNQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLElBQUEsMkJBQVksRUFBQyxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxFQUFFO0lBQy9FLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDO1FBQUUsT0FBTztJQUUxQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFD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U0FBUyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFcEMsU0FBUyxFQUFFLENBQUM7SUFDZCxDQUFDO0lBRUQsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztBQUN6QyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBRUosa0JBQWUsTUFBTSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxQcm9qZWN0c1xcQXR0cml0aW9uXFxwYWNrYWdlc1xcc2VydmVyXFxzcmNcXHJvdXRlc1xcYWRtaW4udHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUm91dGVyLCBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgYXN5bmNIYW5kbGVyIH0gZnJvbSAnLi4vbWlkZGxld2FyZS9lcnJvckhhbmRsZXInO1xuaW1wb3J0IHsgRVJST1JfTUVTU0FHRVMgfSBmcm9tICcuLi9jb25zdGFudHMvcmVzcG9uc2UtZm9ybWF0cyc7XG5pbXBvcnQgeyBFTlZfVkFSUyB9IGZyb20gJ0BnYW1lL3NoYXJlZCc7XG5pbXBvcnQgeyBEQl9UQUJMRVMsIERCX0ZJRUxEUyB9IGZyb20gJy4uL2NvbnN0YW50cy9kYXRhYmFzZS1maWVsZHMnO1xuaW1wb3J0IHsgc3VwYWJhc2UgfSBmcm9tICcuLi9jb25maWcvc3VwYWJhc2UnO1xuXG5pbXBvcnQgeyBIVFRQX1NUQVRVUyB9IGZyb20gJ0BnYW1lL3NoYXJlZCc7XG5pbXBvcnQgeyBHQU1FX0NPTlNUQU5UUyB9IGZyb20gJ0BnYW1lL3NoYXJlZCc7XG5jb25zdCByb3V0ZXIgPSBSb3V0ZXIoKTtcblxuZnVuY3Rpb24gcmVxdWlyZUFkbWluU2VjcmV0KHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IGJvb2xlYW4ge1xuICBjb25zdCBzZWNyZXQgPSBwcm9jZXNzLmVudltFTlZfVkFSUy5BRE1JTl9NQUlOVEVOQU5DRV9TRUNSRVRdO1xuICBjb25zdCBwcm92aWRlZCA9IHJlcS5nZXQoJ3gtYWRtaW4tbWFpbnRlbmFuY2Utc2VjcmV0JykgfHwgcmVxLnF1ZXJ5LnNlY3JldDtcbiAgaWYgKCFzZWNyZXQgfHwgIXByb3ZpZGVkIHx8IHNlY3JldCAhPT0gU3RyaW5nKHByb3ZpZGVkKSkge1xuICAgIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuVU5BVVRIT1JJWkVEKS5qc29uKHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBFUlJPUl9NRVNTQUdFUy5VTkFVVEhPUklaRURfQUNDRVNTIH0pO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuICByZXR1cm4gdHJ1ZTtcbn1cblxuLy8gU2VlZCBhIHNtYWxsIHVuaXZlcnNlIG9mIHVub3duZWQgcGxhbmV0cyBpbiBTdXBhYmFzZVxucm91dGVyLnBvc3QoJy9zZWVkLXN1cGFiYXNlJywgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgaWYgKCFyZXF1aXJlQWRtaW5TZWNyZXQocmVxLCByZXMpKSByZXR1cm47XG5cbiAgY29uc3QgY291bnQgPSBNYXRoLm1pbihOdW1iZXIocmVxLmJvZHk/LmNvdW50IHx8IDEwMCksIDIwMDApO1xuICBjb25zdCBzZXJ2ZXJJZCA9ICdBJztcbiAgY29uc3QgZ2FsYXh5ID0gMDsgLy8gQTAwXG5cbiAgY29uc3Qgcm93czogYW55W10gPSBbXTtcbiAgZm9yIChsZXQgaSA9IDE7IGkgPD0gY291bnQ7IGkrKykge1xuICAgIGNvbnN0IHJlZ2lvbiA9IE1hdGguZmxvb3IoKGkgLSAxKSAvIDEwKTsgLy8gYXJiaXRyYXJ5IGdyb3VwaW5nXG4gICAgY29uc3QgbG9jYWwgPSAoaSAtIDEpICUgMTA7XG4gICAgY29uc3QgY29vcmQgPSBgJHtzZXJ2ZXJJZH0ke2dhbGF4eS50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9OiR7cmVnaW9uXG4gICAgICAudG9TdHJpbmcoKVxuICAgICAgLnBhZFN0YXJ0KDIsICcwJyl9OiR7bG9jYWwudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfWA7XG4gICAgcm93cy5wdXNoKHsgY29vcmQsIHR5cGU6ICdwbGFuZXQnLCBvd25lcl9pZDogbnVsbCB9KTtcbiAgfVxuXG4gIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgLmZyb20oREJfVEFCTEVTLkxPQ0FUSU9OUylcbiAgICAudXBzZXJ0KHJvd3MsIHsgb25Db25mbGljdDogJ2Nvb3JkJyB9KVxuICAgIC5zZWxlY3QoJ2Nvb3JkJyk7XG5cbiAgaWYgKGVycm9yKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuSU5URVJOQUxfU0VSVkVSX0VSUk9SKS5qc29uKHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBlcnJvci5tZXNzYWdlIH0pO1xuICB9XG5cbiAgcmVzLmpzb24oeyBzdWNjZXNzOiB0cnVlLCBpbnNlcnRlZDogZGF0YT8ubGVuZ3RoID8/IDAgfSk7XG59KSk7XG5cbi8vIEJhY2tmaWxsIHN0YXJ0ZXIgZW1waXJlL2NvbG9ueS9idWlsZGluZyBmb3IgdXNlcnMgd2l0aG91dCBlbXBpcmVfaWRcbnJvdXRlci5wb3N0KCcvYmFja2ZpbGwtc3RhcnRlcnMnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICBpZiAoIXJlcXVpcmVBZG1pblNlY3JldChyZXEsIHJlcykpIHJldHVybjtcblxuICAvLyBGZXRjaCB1c2VycyB3aXRoIG1pc3NpbmcgZW1waXJlX2lkXG4gIGNvbnN0IHsgZGF0YTogdXNlcnMsIGVycm9yOiB1c2Vyc0VyciB9ID0gYXdhaXQgc3VwYWJhc2VcbiAgICAuZnJvbShEQl9UQUJMRVMuVVNFUlMpXG4gICAgLnNlbGVjdCgnaWQsIGVtYWlsLCB1c2VybmFtZSwgZW1waXJlX2lkLCBzdGFydGluZ19jb29yZGluYXRlJylcbiAgICAuaXMoREJfRklFTERTLkJVSUxESU5HUy5FTVBJUkVfSUQsIG51bGwpXG4gICAgLmxpbWl0KDIwMCk7XG5cbiAgaWYgKHVzZXJzRXJyKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuSU5URVJOQUxfU0VSVkVSX0VSUk9SKS5qc29uKHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiB1c2Vyc0Vyci5tZXNzYWdlIH0pO1xuICB9XG5cbiAgbGV0IHByb2Nlc3NlZCA9IDA7XG4gIGZvciAoY29uc3QgdSBvZiB1c2VycyB8fCBbXSkge1xuICAgIC8vIEZpbmQgYW4gdW5vd25lZCBwbGFuZXRcbiAgICBjb25zdCB7IGRhdGE6IHBsYW5ldCwgZXJyb3I6IHBpY2tFcnIgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgICAuZnJvbShEQl9UQUJMRVMuTE9DQVRJT05TKVxuICAgICAgLnNlbGVjdCgnY29vcmQnKVxuICAgICAgLmVxKERCX0ZJRUxEUy5DUkVESVRfVFJBTlNBQ1RJT05TLlRZUEUsICdwbGFuZXQnKVxuICAgICAgLmlzKERCX0ZJRUxEUy5MT0NBVElPTlMuT1dORVJfSUQsIG51bGwpXG4gICAgICAubGltaXQoMSlcbiAgICAgIC5zaW5nbGUoKTtcblxuICAgIGlmIChwaWNrRXJyIHx8ICFwbGFuZXQpIHtcbiAgICAgIGJyZWFrOyAvLyBubyBtb3JlIHBsYW5ldHNcbiAgICB9XG5cbiAgICBjb25zdCBjb29yZCA9IHBsYW5ldC5jb29yZCBhcyBzdHJpbmc7XG5cbiAgICAvLyBDbGFpbSBwbGFuZXRcbiAgICBjb25zdCB7IGVycm9yOiBjbGFpbUVyciB9ID0gYXdhaXQgc3VwYWJhc2VcbiAgICAgIC5mcm9tKERCX1RBQkxFUy5MT0NBVElPTlMpXG4gICAgICAudXBkYXRlKHsgb3duZXJfaWQ6IHUuaWQgfSlcbiAgICAgIC5lcSgnY29vcmQnLCBjb29yZClcbiAgICAgIC5pcyhEQl9GSUVMRFMuTE9DQVRJT05TLk9XTkVSX0lELCBudWxsKTtcbiAgICBpZiAoY2xhaW1FcnIpIGNvbnRpbnVlO1xuXG4gICAgLy8gQ3JlYXRlIGVtcGlyZVxuICAgIGNvbnN0IHsgZGF0YTogZW1waXJlUm93LCBlcnJvcjogZW1wRXJyIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgLmZyb20oREJfVEFCTEVTLkVNUElSRVMpXG4gICAgICAuaW5zZXJ0KHtcbiAgICAgICAgdXNlcl9pZDogdS5pZCxcbiAgICAgICAgbmFtZTogdS51c2VybmFtZSB8fCAnQ29tbWFuZGVyJyxcbiAgICAgICAgaG9tZV9zeXN0ZW06IGNvb3JkLFxuICAgICAgICB0ZXJyaXRvcmllczogW2Nvb3JkXSxcbiAgICAgICAgY3JlZGl0czogR0FNRV9DT05TVEFOVFMuU1RBUlRJTkdfQ1JFRElUUyxcbiAgICAgICAgZW5lcmd5OiAwLFxuICAgICAgfSlcbiAgICAgIC5zZWxlY3QoREJfRklFTERTLkJVSUxESU5HUy5JRClcbiAgICAgIC5zaW5nbGUoKTtcbiAgICBpZiAoZW1wRXJyIHx8ICFlbXBpcmVSb3cpIGNvbnRpbnVlO1xuXG4gICAgLy8gQ3JlYXRlIGNvbG9ueVxuICAgIGF3YWl0IHN1cGFiYXNlXG4gICAgICAuZnJvbShEQl9UQUJMRVMuQ09MT05JRVMpXG4gICAgICAuaW5zZXJ0KHsgZW1waXJlX2lkOiBlbXBpcmVSb3cuaWQsIGxvY2F0aW9uX2Nvb3JkOiBjb29yZCwgbmFtZTogJ0hvbWUgQmFzZScgfSk7XG5cbiAgICAvLyBTdGFydGVyIGJ1aWxkaW5nXG4gICAgYXdhaXQgc3VwYWJhc2VcbiAgICAgIC5mcm9tKERCX1RBQkxFUy5CVUlMRElOR1MpXG4gICAgICAuaW5zZXJ0KHtcbiAgICAgICAgZW1waXJlX2lkOiBlbXBpcmVSb3cuaWQsXG4gICAgICAgIGxvY2F0aW9uX2Nvb3JkOiBjb29yZCxcbiAgICAgICAgY2F0YWxvZ19rZXk6ICd1cmJhbl9zdHJ1Y3R1cmVzJyxcbiAgICAgICAgbGV2ZWw6IDEsXG4gICAgICAgIGlzX2FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgY29uc3RydWN0aW9uX2NvbXBsZXRlZDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICBjcmVkaXRzX2Nvc3Q6IDAsXG4gICAgICB9KTtcblxuICAgIC8vIFVwZGF0ZSB1c2VyXG4gICAgYXdhaXQgc3VwYWJhc2VcbiAgICAgIC5mcm9tKERCX1RBQkxFUy5VU0VSUylcbiAgICAgIC51cGRhdGUoeyBlbXBpcmVfaWQ6IGVtcGlyZVJvdy5pZCwgc3RhcnRpbmdfY29vcmRpbmF0ZTogY29vcmQgfSlcbiAgICAgIC5lcShEQl9GSUVMRFMuQlVJTERJTkdTLklELCB1LmlkKTtcblxuICAgIHByb2Nlc3NlZCsrO1xuICB9XG5cbiAgcmVzLmpzb24oeyBzdWNjZXNzOiB0cnVlLCBwcm9jZXNzZWQgfSk7XG59KSk7XG5cbmV4cG9ydCBkZWZhdWx0IHJvdXRlcjtcblxuXG4iXSwidmVyc2lvbiI6M30=