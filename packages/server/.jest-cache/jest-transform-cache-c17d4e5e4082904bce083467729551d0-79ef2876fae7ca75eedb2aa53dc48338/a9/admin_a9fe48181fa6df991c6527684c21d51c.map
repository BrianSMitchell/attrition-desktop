{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\routes\\admin.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\routes\\admin.ts"],"sourcesContent":["import { Router, Request, Response } from 'express';\nimport { asyncHandler } from '../middleware/errorHandler';\nimport { ERROR_MESSAGES } from '../constants/response-formats';\nimport { ENV_VARS } from '@game/shared';\nimport { DB_TABLES, DB_FIELDS } from '../constants/database-fields';\nimport { supabase } from '../config/supabase';\n\nimport { HTTP_STATUS } from '@game/shared';\nimport { GAME_CONSTANTS } from '@game/shared';\nconst router = Router();\n\nfunction requireAdminSecret(req: Request, res: Response): boolean {\n  const secret = process.env[ENV_VARS.ADMIN_MAINTENANCE_SECRET];\n  const provided = req.get('x-admin-maintenance-secret') || req.query.secret;\n  if (!secret || !provided || secret !== String(provided)) {\n    res.status(HTTP_STATUS.UNAUTHORIZED).json({ success: false, error: ERROR_MESSAGES.UNAUTHORIZED_ACCESS });\n    return false;\n  }\n  return true;\n}\n\n// Seed a small universe of unowned planets in Supabase\nrouter.post('/seed-supabase', asyncHandler(async (req: Request, res: Response) => {\n  if (!requireAdminSecret(req, res)) return;\n\n  const count = Math.min(Number(req.body?.count || 100), 2000);\n  const serverId = 'A';\n  const galaxy = 0; // A00\n\n  const rows: any[] = [];\n  for (let i = 1; i <= count; i++) {\n    const region = Math.floor((i - 1) / 10); // arbitrary grouping\n    const local = (i - 1) % 10;\n    const coord = `${serverId}${galaxy.toString().padStart(2, '0')}:${region\n      .toString()\n      .padStart(2, '0')}:${local.toString().padStart(2, '0')}`;\n    rows.push({ coord, type: 'planet', owner_id: null });\n  }\n\n  const { data, error } = await supabase\n    .from(DB_TABLES.LOCATIONS)\n    .upsert(rows, { onConflict: 'coord' })\n    .select('coord');\n\n  if (error) {\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({ success: false, error: error.message });\n  }\n\n  res.json({ success: true, inserted: data?.length ?? 0 });\n}));\n\n// Backfill starter empire/colony/building for users without empire_id\nrouter.post('/backfill-starters', asyncHandler(async (req: Request, res: Response) => {\n  if (!requireAdminSecret(req, res)) return;\n\n  // Fetch users with missing empire_id\n  const { data: users, error: usersErr } = await supabase\n    .from(DB_TABLES.USERS)\n    .select('id, email, username, empire_id, starting_coordinate')\n    .is(DB_FIELDS.BUILDINGS.EMPIRE_ID, null)\n    .limit(200);\n\n  if (usersErr) {\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({ success: false, error: usersErr.message });\n  }\n\n  let processed = 0;\n  for (const u of users || []) {\n    // Find an unowned planet\n    const { data: planet, error: pickErr } = await supabase\n      .from(DB_TABLES.LOCATIONS)\n      .select('coord')\n      .eq(DB_FIELDS.CREDIT_TRANSACTIONS.TYPE, 'planet')\n      .is(DB_FIELDS.LOCATIONS.OWNER_ID, null)\n      .limit(1)\n      .single();\n\n    if (pickErr || !planet) {\n      break; // no more planets\n    }\n\n    const coord = planet.coord as string;\n\n    // Claim planet\n    const { error: claimErr } = await supabase\n      .from(DB_TABLES.LOCATIONS)\n      .update({ owner_id: u.id })\n      .eq('coord', coord)\n      .is(DB_FIELDS.LOCATIONS.OWNER_ID, null);\n    if (claimErr) continue;\n\n    // Create empire\n    const { data: empireRow, error: empErr } = await supabase\n      .from(DB_TABLES.EMPIRES)\n      .insert({\n        user_id: u.id,\n        name: u.username || 'Commander',\n        home_system: coord,\n        territories: [coord],\n        credits: GAME_CONSTANTS.STARTING_CREDITS,\n        energy: 0,\n      })\n      .select(DB_FIELDS.BUILDINGS.ID)\n      .single();\n    if (empErr || !empireRow) continue;\n\n    // Create colony\n    await supabase\n      .from(DB_TABLES.COLONIES)\n      .insert({ empire_id: empireRow.id, location_coord: coord, name: 'Home Base' });\n\n    // Starter building\n    await supabase\n      .from(DB_TABLES.BUILDINGS)\n      .insert({\n        empire_id: empireRow.id,\n        location_coord: coord,\n        catalog_key: 'urban_structures',\n        level: 1,\n        is_active: true,\n        construction_completed: new Date().toISOString(),\n        credits_cost: 0,\n      });\n\n    // Update user\n    await supabase\n      .from(DB_TABLES.USERS)\n      .update({ empire_id: empireRow.id, starting_coordinate: coord })\n      .eq(DB_FIELDS.BUILDINGS.ID, u.id);\n\n    processed++;\n  }\n\n  res.json({ success: true, processed });\n}));\n\nexport default router;\n\n\n"],"version":3}