f56f3c9ce812b744c3f7547b0af4875d
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
const response_formats_1 = require("../constants/response-formats");
// Constants imports for eliminating hardcoded values
const database_fields_1 = require("../constants/database-fields");
const supabase_1 = require("../config/supabase");
const errorHandler_1 = require("../middleware/errorHandler");
const auth_1 = require("../middleware/auth");
const shared_1 = require("@game/shared");
const shared_2 = require("@game/shared");
const shared_3 = require("@game/shared");
const rateLimiting_1 = require("../middleware/rateLimiting");
const securityMonitor_1 = require("../utils/securityMonitor");
const authService_1 = require("../services/authService");
const router = (0, express_1.Router)();
// Security event logging
const logSecurityEvent = (event, details) => {
    console.log(`[SECURITY] ${event}:`, details);
};
// Register new user
router.post('/register', rateLimiting_1.registerRateLimit, (0, errorHandler_1.asyncHandler)(async (req, res) => {
    return (0, authService_1.register)(req, res);
}));
// Login user
router.post('/login', rateLimiting_1.loginRateLimit, rateLimiting_1.accountLockout, (0, errorHandler_1.asyncHandler)(async (req, res) => {
    return (0, authService_1.login)(req, res);
}));
// Refresh tokens
router.post('/refresh', rateLimiting_1.refreshRateLimit, (0, errorHandler_1.asyncHandler)(async (req, res) => {
    try {
        const { refreshToken } = req.body || {};
        if (!refreshToken || typeof refreshToken !== 'string') {
            return res.status(shared_1.HTTP_STATUS.BAD_REQUEST).json({
                success: false,
                error: response_formats_1.ERROR_MESSAGES.REFRESH_TOKEN_REQUIRED
            });
        }
        // Verify refresh token and extract userId using enhanced verification
        const decoded = (await (async () => {
            try {
                return (0, auth_1.verifyTokenWithSecrets)(refreshToken);
            }
            catch {
                return null;
            }
        })());
        if (!decoded || decoded.type !== 'refresh' || !decoded.userId) {
            securityMonitor_1.securityMonitor.recordEvent({
                type: securityMonitor_1.SecurityEventType.LOGIN_FAILED,
                ip: req.ip || 'unknown',
                userAgent: req.get('User-Agent') || 'unknown',
                details: {
                    error: response_formats_1.ERROR_MESSAGES.INVALID_REFRESH_TOKEN,
                    action: 'token_refresh'
                }
            });
            return res.status(shared_1.HTTP_STATUS.UNAUTHORIZED).json({
                success: false,
                error: response_formats_1.ERROR_MESSAGES.INVALID_REFRESH_TOKEN
            });
        }
        // Get user from Supabase
        const { data: user, error } = await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.USERS)
            .select('*')
            .eq(database_fields_1.DB_FIELDS.BUILDINGS.ID, decoded.userId)
            .single();
        if (error || !user) {
            return res.status(shared_1.HTTP_STATUS.UNAUTHORIZED).json({
                success: false,
                error: response_formats_1.ERROR_MESSAGES.INVALID_REFRESH_TOKEN
            });
        }
        // Revoke old refresh token if it has jti
        if (decoded.jti) {
            (0, auth_1.revokeToken)(decoded.jti);
        }
        // Issue new tokens (with device fingerprinting)
        const token = (0, auth_1.generateAccessToken)(decoded.userId, req);
        const newRefreshToken = (0, auth_1.generateRefreshToken)(decoded.userId);
        // Track successful token refresh
        const newAccessTokenDecoded = jsonwebtoken_1.default.decode(token);
        securityMonitor_1.securityMonitor.recordEvent({
            type: securityMonitor_1.SecurityEventType.TOKEN_REFRESH,
            userId: decoded.userId,
            ip: req.ip || 'unknown',
            userAgent: req.get('User-Agent') || 'unknown',
            details: {
                oldTokenJti: decoded.jti,
                newTokenJti: newAccessTokenDecoded?.jti
            }
        });
        // Update security session if exists
        if (newAccessTokenDecoded?.jti) {
            securityMonitor_1.securityMonitor.createSession(decoded.userId, req, newAccessTokenDecoded.jti);
        }
        // Get user's empire if exists
        const { data: empire } = await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.EMPIRES)
            .select('*')
            .eq(database_fields_1.DB_FIELDS.EMPIRES.USER_ID, user.id)
            .single();
        res.json({
            success: true,
            data: {
                token,
                refreshToken: newRefreshToken,
                user,
                empire
            },
            message: 'Token refreshed'
        });
    }
    catch (error) {
        return res.status(shared_1.HTTP_STATUS.UNAUTHORIZED).json({
            success: false,
            error: response_formats_1.ERROR_MESSAGES.INVALID_REFRESH_TOKEN
        });
    }
}));
// Temporary trace logging for /auth/me
router.use('/me', (req, res, next) => {
    const start = Date.now();
    res.on('finish', () => {
        try {
            console.log('[TRACE] /api/auth/me', {
                method: req.method,
                status: res.statusCode,
                ua: req.get('User-Agent') || 'unknown',
                ip: req.ip,
                xff: req.get('X-Forwarded-For') || undefined,
                proto: req.get('X-Forwarded-Proto') || (req.secure ? 'https' : 'http'),
                hasAuthHeader: !!req.headers.authorization,
                durationMs: Date.now() - start,
            });
        }
        catch { }
    });
    next();
});
// Get current user profile
router.get('/me', auth_1.authenticate, (0, errorHandler_1.asyncHandler)(async (req, res) => {
    let empire = null;
    const userId = req.user?._id || req.user?.id;
    if (userId) {
        const { data, error } = await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.EMPIRES)
            .select('*')
            .eq(database_fields_1.DB_FIELDS.EMPIRES.USER_ID, userId)
            .single();
        if (!error && data) {
            empire = data;
        }
    }
    res.json({
        success: true,
        data: {
            user: req.user,
            empire
        }
    });
}));
// Token revocation endpoint
router.post('/revoke', rateLimiting_1.authRateLimit, (0, errorHandler_1.asyncHandler)(async (req, res) => {
    const { token } = req.body;
    if (!token) {
        return res.status(shared_1.HTTP_STATUS.BAD_REQUEST).json({
            success: false,
            error: response_formats_1.ERROR_MESSAGES.TOKEN_REQUIRED
        });
    }
    try {
        const decoded = jsonwebtoken_1.default.verify(token, process.env[shared_3.ENV_VARS.JWT_SECRET]);
        if (decoded.jti) {
            (0, auth_1.revokeToken)(decoded.jti);
            logSecurityEvent('TOKEN_REVOKED', {
                jti: decoded.jti,
                userId: decoded.userId,
                ip: req.ip,
                userAgent: req.get('User-Agent')
            });
            res.json({
                success: true,
                message: 'Token revoked successfully'
            });
        }
        else {
            res.status(shared_1.HTTP_STATUS.BAD_REQUEST).json({
                success: false,
                error: 'Token does not support revocation'
            });
        }
    }
    catch (error) {
        res.status(shared_1.HTTP_STATUS.BAD_REQUEST).json({
            success: false,
            error: response_formats_1.ERROR_MESSAGES.TOKEN_INVALID
        });
    }
}));
// Logout (client-side token removal, but we can track it)
router.post('/logout', auth_1.authenticate, (0, errorHandler_1.asyncHandler)(async (req, res) => {
    // Extract token from Authorization header to revoke it
    const authHeader = req.headers.authorization;
    if (authHeader && authHeader.startsWith('Bearer ')) {
        const token = authHeader.split(' ')[1];
        try {
            const decoded = jsonwebtoken_1.default.verify(token, process.env[shared_3.ENV_VARS.JWT_SECRET]);
            if (decoded.jti) {
                (0, auth_1.revokeToken)(decoded.jti);
            }
        }
        catch (error) {
            // Token might already be invalid, ignore
        }
    }
    logSecurityEvent('USER_LOGOUT', {
        userId: req.user ? req.user.id || 'unknown' : 'unknown',
        ip: req.ip,
        userAgent: req.get('User-Agent')
    });
    res.json({
        success: true,
        message: 'Logged out successfully'
    });
}));
// TEMPORARY: Admin setup endpoint to create admin user on server
router.post('/setup-admin', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    const { setupKey } = req.body;
    // Simple setup key to prevent unauthorized admin creation
    if (setupKey !== 'setup-admin-2025') {
        return res.status(shared_1.HTTP_STATUS.UNAUTHORIZED).json({ success: false, error: 'Invalid setup key' });
    }
    try {
        // Check if admin already exists
        const { data: existingAdmin } = await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.USERS)
            .select('*')
            .eq(database_fields_1.DB_FIELDS.USERS.EMAIL, 'admin@attrition.com')
            .single();
        if (existingAdmin) {
            return res.json({ success: true, message: 'Admin user already exists', existing: true });
        }
        // Create admin user
        const { data: adminUser, error } = await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.USERS)
            .insert({
            email: 'admin@attrition.com',
            username: 'AdminCommander',
            password_hash: 'AdminPassword123!', // Note: In production, this should be properly hashed
            role: 'admin',
            game_profile: {
                credits: shared_2.GAME_CONSTANTS.STARTING_CREDITS,
                experience: 0
            }
        })
            .select()
            .single();
        if (error) {
            throw error;
        }
        res.json({
            success: true,
            message: 'Admin user created successfully on server',
            admin: {
                email: adminUser.email,
                username: adminUser.username,
                role: adminUser.role,
                id: adminUser.id
            }
        });
    }
    catch (error) {
        res.status(shared_1.HTTP_STATUS.INTERNAL_SERVER_ERROR).json({ success: false, error: 'Failed to create admin user', details: error.message });
    }
}));
// TEMPORARY: Simple admin login bypass for universe generation
router.post('/admin-login', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    const { password } = req.body;
    // Simple password check for admin account
    if (password !== 'AdminPassword123!') {
        return res.status(shared_1.HTTP_STATUS.UNAUTHORIZED).json({ success: false, error: 'Invalid admin password' });
    }
    // Find admin user
    const { data: adminUser, error } = await supabase_1.supabase
        .from(database_fields_1.DB_TABLES.USERS)
        .select('*')
        .eq(database_fields_1.DB_FIELDS.USERS.EMAIL, 'admin@attrition.com')
        .single();
    if (error || !adminUser || adminUser.role !== 'admin') {
        return res.status(shared_1.HTTP_STATUS.NOT_FOUND).json({ success: false, error: 'Admin user not found' });
    }
    // Generate tokens for admin
    const accessToken = (0, auth_1.generateAccessToken)(adminUser.id, req);
    const refreshToken = (0, auth_1.generateRefreshToken)(adminUser.id);
    res.json({
        success: true,
        data: {
            user: adminUser,
            token: accessToken,
            refreshToken,
            empire: null // Admin has no empire
        },
        message: 'Admin login successful'
    });
}));
exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFByb2plY3RzXFxBdHRyaXRpb25cXHBhY2thZ2VzXFxzZXJ2ZXJcXHNyY1xccm91dGVzXFxhdXRoLnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBQUEscUNBQW9EO0FBQ3BELGdFQUErQjtBQUUvQixvRUFBK0Q7QUFFL0QscURBQXFEO0FBQ3JELGtFQUFvRTtBQUNwRSxpREFBOEM7QUFDOUMsNkRBQTBEO0FBQzFELDZDQUErSTtBQUMvSSx5Q0FBMkM7QUFDM0MseUNBQThDO0FBQzlDLHlDQUF3QztBQUN4Qyw2REFRb0M7QUFDcEMsOERBQThFO0FBRTlFLHlEQUEwRDtBQUUxRCxNQUFNLE1BQU0sR0FBVyxJQUFBLGdCQUFNLEdBQUUsQ0FBQztBQUVoQyx5QkFBeUI7QUFDekIsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLEtBQWEsRUFBRSxPQUFZLEVBQUUsRUFBRTtJQUN2RCxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsS0FBSyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDL0MsQ0FBQyxDQUFDO0FBRUYsb0JBQW9CO0FBQ3BCLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLGdDQUFpQixFQUFFLElBQUEsMkJBQVksRUFBQyxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxFQUFFO0lBQzdGLE9BQU8sSUFBQSxzQkFBUSxFQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztBQUM1QixDQUFDLENBQUMsQ0FBQyxDQUFDO0FBRUosYUFBYTtBQUNiLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLDZCQUFjLEVBQUUsNkJBQWMsRUFBRSxJQUFBLDJCQUFZLEVBQUMsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsRUFBRTtJQUN2RyxPQUFPLElBQUEsbUJBQUssRUFBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDekIsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUVKLGlCQUFpQjtBQUNqQixNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSwrQkFBZ0IsRUFB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QUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFByb2plY3RzXFxBdHRyaXRpb25cXHBhY2thZ2VzXFxzZXJ2ZXJcXHNyY1xccm91dGVzXFxhdXRoLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJvdXRlciwgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCBqd3QgZnJvbSAnanNvbndlYnRva2VuJztcbmltcG9ydCB7IHZhbGlkYXRlTG9naW4sIHZhbGlkYXRlUmVnaXN0ZXIgfSBmcm9tICdAZ2FtZS9zaGFyZWQnO1xuaW1wb3J0IHsgRVJST1JfTUVTU0FHRVMgfSBmcm9tICcuLi9jb25zdGFudHMvcmVzcG9uc2UtZm9ybWF0cyc7XG5cbi8vIENvbnN0YW50cyBpbXBvcnRzIGZvciBlbGltaW5hdGluZyBoYXJkY29kZWQgdmFsdWVzXG5pbXBvcnQgeyBEQl9UQUJMRVMsIERCX0ZJRUxEUyB9IGZyb20gJy4uL2NvbnN0YW50cy9kYXRhYmFzZS1maWVsZHMnO1xuaW1wb3J0IHsgc3VwYWJhc2UgfSBmcm9tICcuLi9jb25maWcvc3VwYWJhc2UnO1xuaW1wb3J0IHsgYXN5bmNIYW5kbGVyIH0gZnJvbSAnLi4vbWlkZGxld2FyZS9lcnJvckhhbmRsZXInO1xuaW1wb3J0IHsgYXV0aGVudGljYXRlLCBnZW5lcmF0ZUFjY2Vzc1Rva2VuLCBnZW5lcmF0ZVJlZnJlc2hUb2tlbiwgQXV0aFJlcXVlc3QsIHJldm9rZVRva2VuLCB2ZXJpZnlUb2tlbldpdGhTZWNyZXRzIH0gZnJvbSAnLi4vbWlkZGxld2FyZS9hdXRoJztcbmltcG9ydCB7IEhUVFBfU1RBVFVTIH0gZnJvbSAnQGdhbWUvc2hhcmVkJztcbmltcG9ydCB7IEdBTUVfQ09OU1RBTlRTIH0gZnJvbSAnQGdhbWUvc2hhcmVkJztcbmltcG9ydCB7IEVOVl9WQVJTIH0gZnJvbSAnQGdhbWUvc2hhcmVkJztcbmltcG9ydCB7XG4gIGF1dGhSYXRlTGltaXQsIFxuICBsb2dpblJhdGVMaW1pdCwgXG4gIHJlZ2lzdGVyUmF0ZUxpbWl0LCBcbiAgcmVmcmVzaFJhdGVMaW1pdCxcbiAgYWNjb3VudExvY2tvdXQsXG4gIHRyYWNrRmFpbGVkTG9naW4sXG4gIGNsZWFyRmFpbGVkQXR0ZW1wdHNcbn0gZnJvbSAnLi4vbWlkZGxld2FyZS9yYXRlTGltaXRpbmcnO1xuaW1wb3J0IHsgc2VjdXJpdHlNb25pdG9yLCBTZWN1cml0eUV2ZW50VHlwZSB9IGZyb20gJy4uL3V0aWxzL3NlY3VyaXR5TW9uaXRvcic7XG5pbXBvcnQgeyBzZXNzaW9uSW52YWxpZGF0aW9uU2VydmljZSB9IGZyb20gJy4uL21pZGRsZXdhcmUvc2Vzc2lvbkludmFsaWRhdGlvbic7XG5pbXBvcnQgeyByZWdpc3RlciwgbG9naW4gfSBmcm9tICcuLi9zZXJ2aWNlcy9hdXRoU2VydmljZSc7XG5cbmNvbnN0IHJvdXRlcjogUm91dGVyID0gUm91dGVyKCk7XG5cbi8vIFNlY3VyaXR5IGV2ZW50IGxvZ2dpbmdcbmNvbnN0IGxvZ1NlY3VyaXR5RXZlbnQgPSAoZXZlbnQ6IHN0cmluZywgZGV0YWlsczogYW55KSA9PiB7XG4gIGNvbnNvbGUubG9nKGBbU0VDVVJJVFldICR7ZXZlbnR9OmAsIGRldGFpbHMpO1xufTtcblxuLy8gUmVnaXN0ZXIgbmV3IHVzZXJcbnJvdXRlci5wb3N0KCcvcmVnaXN0ZXInLCByZWdpc3RlclJhdGVMaW1pdCwgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgcmV0dXJuIHJlZ2lzdGVyKHJlcSwgcmVzKTtcbn0pKTtcblxuLy8gTG9naW4gdXNlclxucm91dGVyLnBvc3QoJy9sb2dpbicsIGxvZ2luUmF0ZUxpbWl0LCBhY2NvdW50TG9ja291dCwgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgcmV0dXJuIGxvZ2luKHJlcSwgcmVzKTtcbn0pKTtcblxuLy8gUmVmcmVzaCB0b2tlbnNcbnJvdXRlci5wb3N0KCcvcmVmcmVzaCcsIHJlZnJlc2hSYXRlTGltaXQsIGFzeW5jSGFuZGxlcihhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyByZWZyZXNoVG9rZW4gfSA9IHJlcS5ib2R5IHx8IHt9O1xuICAgIGlmICghcmVmcmVzaFRva2VuIHx8IHR5cGVvZiByZWZyZXNoVG9rZW4gIT09ICdzdHJpbmcnKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5CQURfUkVRVUVTVCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogRVJST1JfTUVTU0FHRVMuUkVGUkVTSF9UT0tFTl9SRVFVSVJFRFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gVmVyaWZ5IHJlZnJlc2ggdG9rZW4gYW5kIGV4dHJhY3QgdXNlcklkIHVzaW5nIGVuaGFuY2VkIHZlcmlmaWNhdGlvblxuICAgIGNvbnN0IGRlY29kZWQgPSAoYXdhaXQgKGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJldHVybiB2ZXJpZnlUb2tlbldpdGhTZWNyZXRzKHJlZnJlc2hUb2tlbikgYXMgeyB1c2VySWQ6IHN0cmluZzsgdHlwZT86IHN0cmluZzsganRpPzogc3RyaW5nIH07XG4gICAgICB9IGNhdGNoIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG4gICAgfSkoKSk7XG5cbiAgICBpZiAoIWRlY29kZWQgfHwgZGVjb2RlZC50eXBlICE9PSAncmVmcmVzaCcgfHwgIWRlY29kZWQudXNlcklkKSB7XG4gICAgICBzZWN1cml0eU1vbml0b3IucmVjb3JkRXZlbnQoe1xuICAgICAgICB0eXBlOiBTZWN1cml0eUV2ZW50VHlwZS5MT0dJTl9GQUlMRUQsXG4gICAgICAgIGlwOiByZXEuaXAgfHwgJ3Vua25vd24nLFxuICAgICAgICB1c2VyQWdlbnQ6IHJlcS5nZXQoJ1VzZXItQWdlbnQnKSB8fCAndW5rbm93bicsXG4gICAgICAgIGRldGFpbHM6IHtcbiAgICAgICAgICBlcnJvcjogRVJST1JfTUVTU0FHRVMuSU5WQUxJRF9SRUZSRVNIX1RPS0VOLFxuICAgICAgICAgIGFjdGlvbjogJ3Rva2VuX3JlZnJlc2gnXG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5VTkFVVEhPUklaRUQpLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IEVSUk9SX01FU1NBR0VTLklOVkFMSURfUkVGUkVTSF9UT0tFTlxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gR2V0IHVzZXIgZnJvbSBTdXBhYmFzZVxuICAgIGNvbnN0IHsgZGF0YTogdXNlciwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgICAuZnJvbShEQl9UQUJMRVMuVVNFUlMpXG4gICAgICAuc2VsZWN0KCcqJylcbiAgICAgIC5lcShEQl9GSUVMRFMuQlVJTERJTkdTLklELCBkZWNvZGVkLnVzZXJJZClcbiAgICAgIC5zaW5nbGUoKTtcblxuICAgIGlmIChlcnJvciB8fCAhdXNlcikge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuVU5BVVRIT1JJWkVEKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiBFUlJPUl9NRVNTQUdFUy5JTlZBTElEX1JFRlJFU0hfVE9LRU5cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIFJldm9rZSBvbGQgcmVmcmVzaCB0b2tlbiBpZiBpdCBoYXMganRpXG4gICAgaWYgKGRlY29kZWQuanRpKSB7XG4gICAgICByZXZva2VUb2tlbihkZWNvZGVkLmp0aSk7XG4gICAgfVxuXG4gICAgLy8gSXNzdWUgbmV3IHRva2VucyAod2l0aCBkZXZpY2UgZmluZ2VycHJpbnRpbmcpXG4gICAgY29uc3QgdG9rZW4gPSBnZW5lcmF0ZUFjY2Vzc1Rva2VuKGRlY29kZWQudXNlcklkLCByZXEpO1xuICAgIGNvbnN0IG5ld1JlZnJlc2hUb2tlbiA9IGdlbmVyYXRlUmVmcmVzaFRva2VuKGRlY29kZWQudXNlcklkKTtcblxuICAgIC8vIFRyYWNrIHN1Y2Nlc3NmdWwgdG9rZW4gcmVmcmVzaFxuICAgIGNvbnN0IG5ld0FjY2Vzc1Rva2VuRGVjb2RlZCA9IGp3dC5kZWNvZGUodG9rZW4pIGFzIHsganRpPzogc3RyaW5nIH07XG5cbiAgICBzZWN1cml0eU1vbml0b3IucmVjb3JkRXZlbnQoe1xuICAgICAgdHlwZTogU2VjdXJpdHlFdmVudFR5cGUuVE9LRU5fUkVGUkVTSCxcbiAgICAgIHVzZXJJZDogZGVjb2RlZC51c2VySWQsXG4gICAgICBpcDogcmVxLmlwIHx8ICd1bmtub3duJyxcbiAgICAgIHVzZXJBZ2VudDogcmVxLmdldCgnVXNlci1BZ2VudCcpIHx8ICd1bmtub3duJyxcbiAgICAgIGRldGFpbHM6IHtcbiAgICAgICAgb2xkVG9rZW5KdGk6IGRlY29kZWQuanRpLFxuICAgICAgICBuZXdUb2tlbkp0aTogbmV3QWNjZXNzVG9rZW5EZWNvZGVkPy5qdGlcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIFVwZGF0ZSBzZWN1cml0eSBzZXNzaW9uIGlmIGV4aXN0c1xuICAgIGlmIChuZXdBY2Nlc3NUb2tlbkRlY29kZWQ/Lmp0aSkge1xuICAgICAgc2VjdXJpdHlNb25pdG9yLmNyZWF0ZVNlc3Npb24oZGVjb2RlZC51c2VySWQsIHJlcSwgbmV3QWNjZXNzVG9rZW5EZWNvZGVkLmp0aSk7XG4gICAgfVxuXG4gICAgLy8gR2V0IHVzZXIncyBlbXBpcmUgaWYgZXhpc3RzXG4gICAgY29uc3QgeyBkYXRhOiBlbXBpcmUgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgICAuZnJvbShEQl9UQUJMRVMuRU1QSVJFUylcbiAgICAgIC5zZWxlY3QoJyonKVxuICAgICAgLmVxKERCX0ZJRUxEUy5FTVBJUkVTLlVTRVJfSUQsIHVzZXIuaWQpXG4gICAgICAuc2luZ2xlKCk7XG5cbiAgICByZXMuanNvbih7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YToge1xuICAgICAgICB0b2tlbixcbiAgICAgICAgcmVmcmVzaFRva2VuOiBuZXdSZWZyZXNoVG9rZW4sXG4gICAgICAgIHVzZXIsXG4gICAgICAgIGVtcGlyZVxuICAgICAgfSxcbiAgICAgIG1lc3NhZ2U6ICdUb2tlbiByZWZyZXNoZWQnXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuVU5BVVRIT1JJWkVEKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6IEVSUk9SX01FU1NBR0VTLklOVkFMSURfUkVGUkVTSF9UT0tFTlxuICAgIH0pO1xuICB9XG59KSk7XG5cbi8vIFRlbXBvcmFyeSB0cmFjZSBsb2dnaW5nIGZvciAvYXV0aC9tZVxucm91dGVyLnVzZSgnL21lJywgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dCkgPT4ge1xuICBjb25zdCBzdGFydCA9IERhdGUubm93KCk7XG4gIHJlcy5vbignZmluaXNoJywgKCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zb2xlLmxvZygnW1RSQUNFXSAvYXBpL2F1dGgvbWUnLCB7XG4gICAgICAgIG1ldGhvZDogcmVxLm1ldGhvZCxcbiAgICAgICAgc3RhdHVzOiByZXMuc3RhdHVzQ29kZSxcbiAgICAgICAgdWE6IHJlcS5nZXQoJ1VzZXItQWdlbnQnKSB8fCAndW5rbm93bicsXG4gICAgICAgIGlwOiByZXEuaXAsXG4gICAgICAgIHhmZjogcmVxLmdldCgnWC1Gb3J3YXJkZWQtRm9yJykgfHwgdW5kZWZpbmVkLFxuICAgICAgICBwcm90bzogcmVxLmdldCgnWC1Gb3J3YXJkZWQtUHJvdG8nKSB8fCAocmVxLnNlY3VyZSA/ICdodHRwcycgOiAnaHR0cCcpLFxuICAgICAgICBoYXNBdXRoSGVhZGVyOiAhIXJlcS5oZWFkZXJzLmF1dGhvcml6YXRpb24sXG4gICAgICAgIGR1cmF0aW9uTXM6IERhdGUubm93KCkgLSBzdGFydCxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2gge31cbiAgfSk7XG4gIG5leHQoKTtcbn0pO1xuXG4vLyBHZXQgY3VycmVudCB1c2VyIHByb2ZpbGVcbnJvdXRlci5nZXQoJy9tZScsIGF1dGhlbnRpY2F0ZSwgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXE6IEF1dGhSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIGxldCBlbXBpcmU6IGFueSA9IG51bGw7XG5cbiAgY29uc3QgdXNlcklkID0gKHJlcS51c2VyIGFzIGFueSk/Ll9pZCB8fCAocmVxLnVzZXIgYXMgYW55KT8uaWQ7XG4gIGlmICh1c2VySWQpIHtcbiAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgLmZyb20oREJfVEFCTEVTLkVNUElSRVMpXG4gICAgICAuc2VsZWN0KCcqJylcbiAgICAgIC5lcShEQl9GSUVMRFMuRU1QSVJFUy5VU0VSX0lELCB1c2VySWQpXG4gICAgICAuc2luZ2xlKCk7XG4gICAgaWYgKCFlcnJvciAmJiBkYXRhKSB7XG4gICAgICBlbXBpcmUgPSBkYXRhO1xuICAgIH1cbiAgfVxuXG4gIHJlcy5qc29uKHtcbiAgICBzdWNjZXNzOiB0cnVlLFxuICAgIGRhdGE6IHtcbiAgICAgIHVzZXI6IHJlcS51c2VyLFxuICAgICAgZW1waXJlXG4gICAgfVxuICB9KTtcbn0pKTtcblxuLy8gVG9rZW4gcmV2b2NhdGlvbiBlbmRwb2ludFxucm91dGVyLnBvc3QoJy9yZXZva2UnLCBhdXRoUmF0ZUxpbWl0LCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICBjb25zdCB7IHRva2VuIH0gPSByZXEuYm9keTtcbiAgXG4gIGlmICghdG9rZW4pIHtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5CQURfUkVRVUVTVCkuanNvbih7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIGVycm9yOiBFUlJPUl9NRVNTQUdFUy5UT0tFTl9SRVFVSVJFRFxuICAgIH0pO1xuICB9XG4gIFxuICB0cnkge1xuICAgIGNvbnN0IGRlY29kZWQgPSBqd3QudmVyaWZ5KHRva2VuLCBwcm9jZXNzLmVudltFTlZfVkFSUy5KV1RfU0VDUkVUXSEpIGFzIHsganRpPzogc3RyaW5nOyB1c2VySWQ/OiBzdHJpbmcgfTtcbiAgICBcbiAgICBpZiAoZGVjb2RlZC5qdGkpIHtcbiAgICAgIHJldm9rZVRva2VuKGRlY29kZWQuanRpKTtcbiAgICAgIFxuICAgICAgbG9nU2VjdXJpdHlFdmVudCgnVE9LRU5fUkVWT0tFRCcsIHtcbiAgICAgICAganRpOiBkZWNvZGVkLmp0aSxcbiAgICAgICAgdXNlcklkOiBkZWNvZGVkLnVzZXJJZCxcbiAgICAgICAgaXA6IHJlcS5pcCxcbiAgICAgICAgdXNlckFnZW50OiByZXEuZ2V0KCdVc2VyLUFnZW50JylcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIG1lc3NhZ2U6ICdUb2tlbiByZXZva2VkIHN1Y2Nlc3NmdWxseSdcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLkJBRF9SRVFVRVNUKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiAnVG9rZW4gZG9lcyBub3Qgc3VwcG9ydCByZXZvY2F0aW9uJ1xuICAgICAgfSk7XG4gICAgfVxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuQkFEX1JFUVVFU1QpLmpzb24oe1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjogRVJST1JfTUVTU0FHRVMuVE9LRU5fSU5WQUxJRFxuICAgIH0pO1xuICB9XG59KSk7XG5cbi8vIExvZ291dCAoY2xpZW50LXNpZGUgdG9rZW4gcmVtb3ZhbCwgYnV0IHdlIGNhbiB0cmFjayBpdClcbnJvdXRlci5wb3N0KCcvbG9nb3V0JywgYXV0aGVudGljYXRlLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcTogQXV0aFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgLy8gRXh0cmFjdCB0b2tlbiBmcm9tIEF1dGhvcml6YXRpb24gaGVhZGVyIHRvIHJldm9rZSBpdFxuICBjb25zdCBhdXRoSGVhZGVyID0gcmVxLmhlYWRlcnMuYXV0aG9yaXphdGlvbjtcbiAgaWYgKGF1dGhIZWFkZXIgJiYgYXV0aEhlYWRlci5zdGFydHNXaXRoKCdCZWFyZXIgJykpIHtcbiAgICBjb25zdCB0b2tlbiA9IGF1dGhIZWFkZXIuc3BsaXQoJyAnKVsxXTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZGVjb2RlZCA9IGp3dC52ZXJpZnkodG9rZW4sIHByb2Nlc3MuZW52W0VOVl9WQVJTLkpXVF9TRUNSRVRdISkgYXMgeyBqdGk/OiBzdHJpbmcgfTtcbiAgICAgIGlmIChkZWNvZGVkLmp0aSkge1xuICAgICAgICByZXZva2VUb2tlbihkZWNvZGVkLmp0aSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIFRva2VuIG1pZ2h0IGFscmVhZHkgYmUgaW52YWxpZCwgaWdub3JlXG4gICAgfVxuICB9XG4gIFxuICBsb2dTZWN1cml0eUV2ZW50KCdVU0VSX0xPR09VVCcsIHtcbiAgICB1c2VySWQ6IHJlcS51c2VyID8gKHJlcS51c2VyIGFzIGFueSkuaWQgfHwgJ3Vua25vd24nIDogJ3Vua25vd24nLFxuICAgIGlwOiByZXEuaXAsXG4gICAgdXNlckFnZW50OiByZXEuZ2V0KCdVc2VyLUFnZW50JylcbiAgfSk7XG4gIFxuICByZXMuanNvbih7XG4gICAgc3VjY2VzczogdHJ1ZSxcbiAgICBtZXNzYWdlOiAnTG9nZ2VkIG91dCBzdWNjZXNzZnVsbHknXG4gIH0pO1xufSkpO1xuXG4vLyBURU1QT1JBUlk6IEFkbWluIHNldHVwIGVuZHBvaW50IHRvIGNyZWF0ZSBhZG1pbiB1c2VyIG9uIHNlcnZlclxucm91dGVyLnBvc3QoJy9zZXR1cC1hZG1pbicsIGFzeW5jSGFuZGxlcihhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIGNvbnN0IHsgc2V0dXBLZXkgfSA9IHJlcS5ib2R5O1xuXG4gIC8vIFNpbXBsZSBzZXR1cCBrZXkgdG8gcHJldmVudCB1bmF1dGhvcml6ZWQgYWRtaW4gY3JlYXRpb25cbiAgaWYgKHNldHVwS2V5ICE9PSAnc2V0dXAtYWRtaW4tMjAyNScpIHtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5VTkFVVEhPUklaRUQpLmpzb24oeyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICdJbnZhbGlkIHNldHVwIGtleScgfSk7XG4gIH1cblxuICB0cnkge1xuICAgIC8vIENoZWNrIGlmIGFkbWluIGFscmVhZHkgZXhpc3RzXG4gICAgY29uc3QgeyBkYXRhOiBleGlzdGluZ0FkbWluIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgLmZyb20oREJfVEFCTEVTLlVTRVJTKVxuICAgICAgLnNlbGVjdCgnKicpXG4gICAgICAuZXEoREJfRklFTERTLlVTRVJTLkVNQUlMLCAnYWRtaW5AYXR0cml0aW9uLmNvbScpXG4gICAgICAuc2luZ2xlKCk7XG5cbiAgICBpZiAoZXhpc3RpbmdBZG1pbikge1xuICAgICAgcmV0dXJuIHJlcy5qc29uKHsgc3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogJ0FkbWluIHVzZXIgYWxyZWFkeSBleGlzdHMnLCBleGlzdGluZzogdHJ1ZSB9KTtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgYWRtaW4gdXNlclxuICAgIGNvbnN0IHsgZGF0YTogYWRtaW5Vc2VyLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcbiAgICAgIC5mcm9tKERCX1RBQkxFUy5VU0VSUylcbiAgICAgIC5pbnNlcnQoe1xuICAgICAgICBlbWFpbDogJ2FkbWluQGF0dHJpdGlvbi5jb20nLFxuICAgICAgICB1c2VybmFtZTogJ0FkbWluQ29tbWFuZGVyJyxcbiAgICAgICAgcGFzc3dvcmRfaGFzaDogJ0FkbWluUGFzc3dvcmQxMjMhJywgLy8gTm90ZTogSW4gcHJvZHVjdGlvbiwgdGhpcyBzaG91bGQgYmUgcHJvcGVybHkgaGFzaGVkXG4gICAgICAgIHJvbGU6ICdhZG1pbicsXG4gICAgICAgIGdhbWVfcHJvZmlsZToge1xuICAgICAgICAgIGNyZWRpdHM6IEdBTUVfQ09OU1RBTlRTLlNUQVJUSU5HX0NSRURJVFMsXG4gICAgICAgICAgZXhwZXJpZW5jZTogMFxuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgLnNlbGVjdCgpXG4gICAgICAuc2luZ2xlKCk7XG5cbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cblxuICAgIHJlcy5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBtZXNzYWdlOiAnQWRtaW4gdXNlciBjcmVhdGVkIHN1Y2Nlc3NmdWxseSBvbiBzZXJ2ZXInLFxuICAgICAgYWRtaW46IHtcbiAgICAgICAgZW1haWw6IGFkbWluVXNlci5lbWFpbCxcbiAgICAgICAgdXNlcm5hbWU6IGFkbWluVXNlci51c2VybmFtZSxcbiAgICAgICAgcm9sZTogYWRtaW5Vc2VyLnJvbGUsXG4gICAgICAgIGlkOiBhZG1pblVzZXIuaWRcbiAgICAgIH1cbiAgICB9KTtcblxuICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5JTlRFUk5BTF9TRVJWRVJfRVJST1IpLmpzb24oeyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICdGYWlsZWQgdG8gY3JlYXRlIGFkbWluIHVzZXInLCBkZXRhaWxzOiBlcnJvci5tZXNzYWdlIH0pO1xuICB9XG59KSk7XG5cbi8vIFRFTVBPUkFSWTogU2ltcGxlIGFkbWluIGxvZ2luIGJ5cGFzcyBmb3IgdW5pdmVyc2UgZ2VuZXJhdGlvblxucm91dGVyLnBvc3QoJy9hZG1pbi1sb2dpbicsIGFzeW5jSGFuZGxlcihhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIGNvbnN0IHsgcGFzc3dvcmQgfSA9IHJlcS5ib2R5O1xuXG4gIC8vIFNpbXBsZSBwYXNzd29yZCBjaGVjayBmb3IgYWRtaW4gYWNjb3VudFxuICBpZiAocGFzc3dvcmQgIT09ICdBZG1pblBhc3N3b3JkMTIzIScpIHtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5VTkFVVEhPUklaRUQpLmpzb24oeyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICdJbnZhbGlkIGFkbWluIHBhc3N3b3JkJyB9KTtcbiAgfVxuXG4gIC8vIEZpbmQgYWRtaW4gdXNlclxuICBjb25zdCB7IGRhdGE6IGFkbWluVXNlciwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgLmZyb20oREJfVEFCTEVTLlVTRVJTKVxuICAgIC5zZWxlY3QoJyonKVxuICAgIC5lcShEQl9GSUVMRFMuVVNFUlMuRU1BSUwsICdhZG1pbkBhdHRyaXRpb24uY29tJylcbiAgICAuc2luZ2xlKCk7XG5cbiAgaWYgKGVycm9yIHx8ICFhZG1pblVzZXIgfHwgYWRtaW5Vc2VyLnJvbGUgIT09ICdhZG1pbicpIHtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5OT1RfRk9VTkQpLmpzb24oeyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICdBZG1pbiB1c2VyIG5vdCBmb3VuZCcgfSk7XG4gIH1cblxuICAvLyBHZW5lcmF0ZSB0b2tlbnMgZm9yIGFkbWluXG4gIGNvbnN0IGFjY2Vzc1Rva2VuID0gZ2VuZXJhdGVBY2Nlc3NUb2tlbihhZG1pblVzZXIuaWQsIHJlcSk7XG4gIGNvbnN0IHJlZnJlc2hUb2tlbiA9IGdlbmVyYXRlUmVmcmVzaFRva2VuKGFkbWluVXNlci5pZCk7XG5cbiAgcmVzLmpzb24oe1xuICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgZGF0YToge1xuICAgICAgdXNlcjogYWRtaW5Vc2VyLFxuICAgICAgdG9rZW46IGFjY2Vzc1Rva2VuLFxuICAgICAgcmVmcmVzaFRva2VuLFxuICAgICAgZW1waXJlOiBudWxsIC8vIEFkbWluIGhhcyBubyBlbXBpcmVcbiAgICB9LFxuICAgIG1lc3NhZ2U6ICdBZG1pbiBsb2dpbiBzdWNjZXNzZnVsJ1xuICB9KTtcbn0pKTtcblxuZXhwb3J0IGRlZmF1bHQgcm91dGVyO1xuXG5cblxuIl0sInZlcnNpb24iOjN9