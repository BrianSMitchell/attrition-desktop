{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\routes\\auth.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\routes\\auth.ts"],"sourcesContent":["import { Router, Request, Response } from 'express';\nimport jwt from 'jsonwebtoken';\nimport { validateLogin, validateRegister } from '@game/shared';\nimport { ERROR_MESSAGES } from '../constants/response-formats';\n\n// Constants imports for eliminating hardcoded values\nimport { DB_TABLES, DB_FIELDS } from '../constants/database-fields';\nimport { supabase } from '../config/supabase';\nimport { asyncHandler } from '../middleware/errorHandler';\nimport { authenticate, generateAccessToken, generateRefreshToken, AuthRequest, revokeToken, verifyTokenWithSecrets } from '../middleware/auth';\nimport { HTTP_STATUS } from '@game/shared';\nimport { GAME_CONSTANTS } from '@game/shared';\nimport { ENV_VARS } from '@game/shared';\nimport {\n  authRateLimit, \n  loginRateLimit, \n  registerRateLimit, \n  refreshRateLimit,\n  accountLockout,\n  trackFailedLogin,\n  clearFailedAttempts\n} from '../middleware/rateLimiting';\nimport { securityMonitor, SecurityEventType } from '../utils/securityMonitor';\nimport { sessionInvalidationService } from '../middleware/sessionInvalidation';\nimport { register, login } from '../services/authService';\n\nconst router: Router = Router();\n\n// Security event logging\nconst logSecurityEvent = (event: string, details: any) => {\n  console.log(`[SECURITY] ${event}:`, details);\n};\n\n// Register new user\nrouter.post('/register', registerRateLimit, asyncHandler(async (req: Request, res: Response) => {\n  return register(req, res);\n}));\n\n// Login user\nrouter.post('/login', loginRateLimit, accountLockout, asyncHandler(async (req: Request, res: Response) => {\n  return login(req, res);\n}));\n\n// Refresh tokens\nrouter.post('/refresh', refreshRateLimit, asyncHandler(async (req: Request, res: Response) => {\n  try {\n    const { refreshToken } = req.body || {};\n    if (!refreshToken || typeof refreshToken !== 'string') {\n      return res.status(HTTP_STATUS.BAD_REQUEST).json({\n        success: false,\n        error: ERROR_MESSAGES.REFRESH_TOKEN_REQUIRED\n      });\n    }\n\n    // Verify refresh token and extract userId using enhanced verification\n    const decoded = (await (async () => {\n      try {\n        return verifyTokenWithSecrets(refreshToken) as { userId: string; type?: string; jti?: string };\n      } catch {\n        return null;\n      }\n    })());\n\n    if (!decoded || decoded.type !== 'refresh' || !decoded.userId) {\n      securityMonitor.recordEvent({\n        type: SecurityEventType.LOGIN_FAILED,\n        ip: req.ip || 'unknown',\n        userAgent: req.get('User-Agent') || 'unknown',\n        details: {\n          error: ERROR_MESSAGES.INVALID_REFRESH_TOKEN,\n          action: 'token_refresh'\n        }\n      });\n\n      return res.status(HTTP_STATUS.UNAUTHORIZED).json({\n        success: false,\n        error: ERROR_MESSAGES.INVALID_REFRESH_TOKEN\n      });\n    }\n\n    // Get user from Supabase\n    const { data: user, error } = await supabase\n      .from(DB_TABLES.USERS)\n      .select('*')\n      .eq(DB_FIELDS.BUILDINGS.ID, decoded.userId)\n      .single();\n\n    if (error || !user) {\n      return res.status(HTTP_STATUS.UNAUTHORIZED).json({\n        success: false,\n        error: ERROR_MESSAGES.INVALID_REFRESH_TOKEN\n      });\n    }\n\n    // Revoke old refresh token if it has jti\n    if (decoded.jti) {\n      revokeToken(decoded.jti);\n    }\n\n    // Issue new tokens (with device fingerprinting)\n    const token = generateAccessToken(decoded.userId, req);\n    const newRefreshToken = generateRefreshToken(decoded.userId);\n\n    // Track successful token refresh\n    const newAccessTokenDecoded = jwt.decode(token) as { jti?: string };\n\n    securityMonitor.recordEvent({\n      type: SecurityEventType.TOKEN_REFRESH,\n      userId: decoded.userId,\n      ip: req.ip || 'unknown',\n      userAgent: req.get('User-Agent') || 'unknown',\n      details: {\n        oldTokenJti: decoded.jti,\n        newTokenJti: newAccessTokenDecoded?.jti\n      }\n    });\n\n    // Update security session if exists\n    if (newAccessTokenDecoded?.jti) {\n      securityMonitor.createSession(decoded.userId, req, newAccessTokenDecoded.jti);\n    }\n\n    // Get user's empire if exists\n    const { data: empire } = await supabase\n      .from(DB_TABLES.EMPIRES)\n      .select('*')\n      .eq(DB_FIELDS.EMPIRES.USER_ID, user.id)\n      .single();\n\n    res.json({\n      success: true,\n      data: {\n        token,\n        refreshToken: newRefreshToken,\n        user,\n        empire\n      },\n      message: 'Token refreshed'\n    });\n  } catch (error) {\n    return res.status(HTTP_STATUS.UNAUTHORIZED).json({\n      success: false,\n      error: ERROR_MESSAGES.INVALID_REFRESH_TOKEN\n    });\n  }\n}));\n\n// Temporary trace logging for /auth/me\nrouter.use('/me', (req: Request, res: Response, next) => {\n  const start = Date.now();\n  res.on('finish', () => {\n    try {\n      console.log('[TRACE] /api/auth/me', {\n        method: req.method,\n        status: res.statusCode,\n        ua: req.get('User-Agent') || 'unknown',\n        ip: req.ip,\n        xff: req.get('X-Forwarded-For') || undefined,\n        proto: req.get('X-Forwarded-Proto') || (req.secure ? 'https' : 'http'),\n        hasAuthHeader: !!req.headers.authorization,\n        durationMs: Date.now() - start,\n      });\n    } catch {}\n  });\n  next();\n});\n\n// Get current user profile\nrouter.get('/me', authenticate, asyncHandler(async (req: AuthRequest, res: Response) => {\n  let empire: any = null;\n\n  const userId = (req.user as any)?._id || (req.user as any)?.id;\n  if (userId) {\n    const { data, error } = await supabase\n      .from(DB_TABLES.EMPIRES)\n      .select('*')\n      .eq(DB_FIELDS.EMPIRES.USER_ID, userId)\n      .single();\n    if (!error && data) {\n      empire = data;\n    }\n  }\n\n  res.json({\n    success: true,\n    data: {\n      user: req.user,\n      empire\n    }\n  });\n}));\n\n// Token revocation endpoint\nrouter.post('/revoke', authRateLimit, asyncHandler(async (req: Request, res: Response) => {\n  const { token } = req.body;\n  \n  if (!token) {\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({\n      success: false,\n      error: ERROR_MESSAGES.TOKEN_REQUIRED\n    });\n  }\n  \n  try {\n    const decoded = jwt.verify(token, process.env[ENV_VARS.JWT_SECRET]!) as { jti?: string; userId?: string };\n    \n    if (decoded.jti) {\n      revokeToken(decoded.jti);\n      \n      logSecurityEvent('TOKEN_REVOKED', {\n        jti: decoded.jti,\n        userId: decoded.userId,\n        ip: req.ip,\n        userAgent: req.get('User-Agent')\n      });\n      \n      res.json({\n        success: true,\n        message: 'Token revoked successfully'\n      });\n    } else {\n      res.status(HTTP_STATUS.BAD_REQUEST).json({\n        success: false,\n        error: 'Token does not support revocation'\n      });\n    }\n  } catch (error) {\n    res.status(HTTP_STATUS.BAD_REQUEST).json({\n      success: false,\n      error: ERROR_MESSAGES.TOKEN_INVALID\n    });\n  }\n}));\n\n// Logout (client-side token removal, but we can track it)\nrouter.post('/logout', authenticate, asyncHandler(async (req: AuthRequest, res: Response) => {\n  // Extract token from Authorization header to revoke it\n  const authHeader = req.headers.authorization;\n  if (authHeader && authHeader.startsWith('Bearer ')) {\n    const token = authHeader.split(' ')[1];\n    try {\n      const decoded = jwt.verify(token, process.env[ENV_VARS.JWT_SECRET]!) as { jti?: string };\n      if (decoded.jti) {\n        revokeToken(decoded.jti);\n      }\n    } catch (error) {\n      // Token might already be invalid, ignore\n    }\n  }\n  \n  logSecurityEvent('USER_LOGOUT', {\n    userId: req.user ? (req.user as any).id || 'unknown' : 'unknown',\n    ip: req.ip,\n    userAgent: req.get('User-Agent')\n  });\n  \n  res.json({\n    success: true,\n    message: 'Logged out successfully'\n  });\n}));\n\n// TEMPORARY: Admin setup endpoint to create admin user on server\nrouter.post('/setup-admin', asyncHandler(async (req: Request, res: Response) => {\n  const { setupKey } = req.body;\n\n  // Simple setup key to prevent unauthorized admin creation\n  if (setupKey !== 'setup-admin-2025') {\n    return res.status(HTTP_STATUS.UNAUTHORIZED).json({ success: false, error: 'Invalid setup key' });\n  }\n\n  try {\n    // Check if admin already exists\n    const { data: existingAdmin } = await supabase\n      .from(DB_TABLES.USERS)\n      .select('*')\n      .eq(DB_FIELDS.USERS.EMAIL, 'admin@attrition.com')\n      .single();\n\n    if (existingAdmin) {\n      return res.json({ success: true, message: 'Admin user already exists', existing: true });\n    }\n\n    // Create admin user\n    const { data: adminUser, error } = await supabase\n      .from(DB_TABLES.USERS)\n      .insert({\n        email: 'admin@attrition.com',\n        username: 'AdminCommander',\n        password_hash: 'AdminPassword123!', // Note: In production, this should be properly hashed\n        role: 'admin',\n        game_profile: {\n          credits: GAME_CONSTANTS.STARTING_CREDITS,\n          experience: 0\n        }\n      })\n      .select()\n      .single();\n\n    if (error) {\n      throw error;\n    }\n\n    res.json({\n      success: true,\n      message: 'Admin user created successfully on server',\n      admin: {\n        email: adminUser.email,\n        username: adminUser.username,\n        role: adminUser.role,\n        id: adminUser.id\n      }\n    });\n\n  } catch (error: any) {\n    res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({ success: false, error: 'Failed to create admin user', details: error.message });\n  }\n}));\n\n// TEMPORARY: Simple admin login bypass for universe generation\nrouter.post('/admin-login', asyncHandler(async (req: Request, res: Response) => {\n  const { password } = req.body;\n\n  // Simple password check for admin account\n  if (password !== 'AdminPassword123!') {\n    return res.status(HTTP_STATUS.UNAUTHORIZED).json({ success: false, error: 'Invalid admin password' });\n  }\n\n  // Find admin user\n  const { data: adminUser, error } = await supabase\n    .from(DB_TABLES.USERS)\n    .select('*')\n    .eq(DB_FIELDS.USERS.EMAIL, 'admin@attrition.com')\n    .single();\n\n  if (error || !adminUser || adminUser.role !== 'admin') {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: 'Admin user not found' });\n  }\n\n  // Generate tokens for admin\n  const accessToken = generateAccessToken(adminUser.id, req);\n  const refreshToken = generateRefreshToken(adminUser.id);\n\n  res.json({\n    success: true,\n    data: {\n      user: adminUser,\n      token: accessToken,\n      refreshToken,\n      empire: null // Admin has no empire\n    },\n    message: 'Admin login successful'\n  });\n}));\n\nexport default router;\n\n\n\n"],"version":3}