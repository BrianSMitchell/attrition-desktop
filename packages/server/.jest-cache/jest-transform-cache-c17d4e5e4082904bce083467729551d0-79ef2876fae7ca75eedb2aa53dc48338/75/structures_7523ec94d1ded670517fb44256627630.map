{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\routes\\game\\structures.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\routes\\game\\structures.ts"],"sourcesContent":["import { Router, Response } from 'express';\r\nimport { supabase } from '../../config/supabase';\r\nimport { ERROR_MESSAGES } from '../../constants/response-formats';\r\n\r\n\r\n// Constants imports for eliminating hardcoded values\r\nimport { DB_TABLES, DB_FIELDS } from '../../constants/database-fields';\r\nimport { HTTP_STATUS } from '@game/shared';\r\nimport { asyncHandler } from '../../middleware/errorHandler';\r\nimport { authenticate, AuthRequest } from '../../middleware/auth';\r\nimport { BuildingKey } from '@game/shared';\r\nimport { StructureService } from '../../services/structures/StructureService';\r\nimport { EmpireResolutionService } from '../../services/empire/EmpireResolutionService';\r\n\r\nconst router = Router();\r\n\r\nrouter.use(authenticate);\r\n\r\n/**\r\n * Get structures catalog\r\n */\r\nrouter.get('/catalog', asyncHandler(async (_req: AuthRequest, res: Response) => {\r\n  const { getStructuresCatalog } = await import('../../services/structures/structures.data');\r\n  const catalog = getStructuresCatalog();\r\n  res.json({ success: true, data: { catalog } });\r\n}));\r\n\r\n/**\r\n * Get details for base including structure capacities and levels\r\n */\r\nrouter.get('/status/:coord', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const user = req.user! as any;\r\n\r\n  // Resolve empire using established pattern (FR-14)\r\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\r\n  if (!empireRow) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\r\n  }\r\n\r\n  const empireId = String(empireRow.id);\r\n\r\n  const { coord } = req.params;\r\n  if (!coord) return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: ERROR_MESSAGES.COORDINATE_PARAMETER_REQUIRED });\r\n\r\n  const details = await StructureService.getStructureDetails(empireId, coord);\r\n  return res.json({ success: true, data: details });\r\n}));\r\n\r\n/**\r\n * Get structures queue\r\n */\r\nrouter.get('/queue', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const user = req.user! as any;\r\n\r\n  // Resolve empire using established pattern (FR-14)\r\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\r\n  if (!empireRow) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\r\n  }\r\n\r\n  const empireId = String(empireRow.id);\r\n\r\n  const locationCoord = String(req.query.base || '').trim() || undefined;\r\n  \r\n  try {\r\n    const queue = await StructureService.getQueue(empireId, locationCoord);\r\n    return res.json({ success: true, data: { queue } });\r\n  } catch (error) {\r\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({ success: false, error: 'Failed to fetch queue' });\r\n  }\r\n}));\r\n\r\n/**\r\n * Start construction of a structure\r\n */\r\nrouter.post('/start', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const user = req.user! as any;\r\n  const { locationCoord, catalogKey } = req.body as { locationCoord?: string; catalogKey?: BuildingKey };\r\n\r\n  if (!locationCoord || !catalogKey) {\r\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({ \r\n      success: false, \r\n      error: 'locationCoord and catalogKey are required' \r\n    });\r\n  }\r\n\r\n  // Resolve empire using established pattern (FR-14)\r\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\r\n  if (!empireRow) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\r\n  }\r\n\r\n  const empireId = String(empireRow.id);\r\n  const userId = user._id || user.id; // Still needed for StructureService\r\n\r\n  const result = await StructureService.startConstruction(userId, empireId, locationCoord, catalogKey);\r\n\r\n  // Handle status codes based on error type\r\n  if (!result.success) {\r\n    const statusCode = result.code === 'ALREADY_IN_PROGRESS' ? 409 : HTTP_STATUS.BAD_REQUEST;\r\n    return res.status(statusCode).json(result);\r\n  }\r\n\r\n  return res.json(result);\r\n}));\r\n\r\n/**\r\n * Cancel structure construction\r\n */\r\nrouter.delete('/cancel/:coord', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const user = req.user! as any;\r\n\r\n  // Resolve empire using established pattern (FR-14)\r\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\r\n  if (!empireRow) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\r\n  }\r\n\r\n  const empireId = String(empireRow.id);\r\n  const userId = user._id || user.id; // Still needed for location ownership check\r\n\r\n  const { coord } = req.params;\r\n  if (!coord) return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: ERROR_MESSAGES.COORDINATE_PARAMETER_REQUIRED });\r\n\r\n  // Validate location ownership\r\n  const { data: location } = await supabase\r\n    .from(DB_TABLES.LOCATIONS)\r\n    .select('coord, owner_id')\r\n    .eq('coord', coord)\r\n    .maybeSingle();\r\n\r\n  if (!location) return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.LOCATION_NOT_FOUND });\r\n  if (location.owner_id !== userId) {\r\n    return res.status(HTTP_STATUS.FORBIDDEN).json({ success: false, error: 'You do not own this location' });\r\n  }\r\n\r\n  const result = await StructureService.cancel(empireId, coord);\r\n\r\n  if (!result.success) {\r\n    const statusCode = result.code === 'NO_ACTIVE_CONSTRUCTION' ? HTTP_STATUS.NOT_FOUND : HTTP_STATUS.BAD_REQUEST;\r\n    return res.status(statusCode).json(result);\r\n  }\r\n\r\n  return res.json(result);\r\n}));\r\n\r\nexport default router;\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"version":3}