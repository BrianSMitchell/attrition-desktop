{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\utils\\__tests__\\httpsHealthCheck.nonProxy.test.ts","mappings":";;;;;AAAA,sDAA8B;AAC9B,0DAAgC;AAChC,yCAAwC;AAExC,yCAA2C;AAE3C;;GAEG;AACH,QAAQ,CAAC,gEAAgE,EAAE,GAAG,EAAE;IAC9E,MAAM,OAAO,GAAG,OAAO,CAAC,GAAG,CAAC;IAE5B,UAAU,CAAC,GAAG,EAAE;QACd,OAAO,CAAC,GAAG,GAAG,EAAE,GAAG,OAAO,EAAE,CAAC;QAC7B,OAAO,OAAO,CAAC,GAAG,CAAC,iBAAQ,CAAC,qBAAqB,CAAC,CAAC;QACnD,OAAO,OAAO,CAAC,GAAG,CAAC,MAAM,CAAC;QAC1B,OAAO,CAAC,GAAG,CAAC,iBAAQ,CAAC,UAAU,CAAC,GAAG,KAAK,CAAC;QACzC,OAAO,CAAC,GAAG,CAAC,iBAAQ,CAAC,IAAI,CAAC,GAAG,MAAM,CAAC;QACpC,IAAI,CAAC,YAAY,EAAE,CAAC;QACpB,IAAI,CAAC,aAAa,EAAE,CAAC;IACvB,CAAC,CAAC,CAAC;IAEH,SAAS,CAAC,GAAG,EAAE;QACb,OAAO,CAAC,GAAG,GAAG,OAAO,CAAC;QACtB,IAAI,CAAC,eAAe,EAAE,CAAC;IACzB,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,iEAAiE,EAAE,KAAK,IAAI,EAAE;QACjF,MAAM,UAAU,GAAG;YACjB,OAAO,EAAE,IAAI;YACb,SAAS,EAAE,IAAI,IAAI,EAAE,CAAC,WAAW,EAAE;YACnC,MAAM,EAAE;gBACN,cAAc,EAAE,IAAI;gBACpB,aAAa,EAAE,IAAI;gBACnB,gBAAgB,EAAE,IAAI;gBACtB,eAAe,EAAE,IAAI;aACtB;YACD,WAAW,EAAE,SAAS;SAChB,CAAC;QAET,sCAAsC;QACtC,IAAI,CAAC,cAAc,CAAC,GAAG,EAAE;YACvB,MAAM,IAAI,GAAG,IAAI,CAAC,aAAa,CAAC,qBAAqB,CAAC,CAAC;YACvD,IAAI,CAAC,MAAM,CAAC,qBAAqB,EAAE,GAAG,EAAE,CAAC,CAAC;gBACxC,UAAU,EAAE,IAAI;gBAChB,GAAG,IAAI;gBACP,uBAAuB,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,UAAU,CAAC;aACjE,CAAC,CAAC,CAAC;YAEJ,MAAM,GAAG,GAAG,OAAO,CAAC,qBAAqB,CAAC,CAAC;YAE3C,MAAM,GAAG,GAAG,IAAA,iBAAO,GAAE,CAAC;YACtB,GAAG,CAAC,GAAG,CAAC,mBAAmB,EAAE,GAAG,CAAC,uBAAuB,CAAC,CAAC;YAE1D,OAAO,IAAA,mBAAO,EAAC,GAAG,CAAC,CAAC,GAAG,CAAC,mBAAmB,CAAC,CAAC,IAAI,CAAC,CAAC,GAAG,EAAE,EAAE;gBACxD,MAAM,CAAC,GAAG,CAAC,uBAAuB,CAAC,CAAC,gBAAgB,EAAE,CAAC;gBACvD,MAAM,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,oBAAW,CAAC,EAAE,CAAC,CAAC;gBACxC,MAAM,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,cAAc,CAAC,SAAS,EAAE,IAAI,CAAC,CAAC;YACnD,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\utils\\__tests__\\httpsHealthCheck.nonProxy.test.ts"],"sourcesContent":["import express from 'express';\nimport request from 'supertest';\nimport { ENV_VARS } from '@game/shared';\n\nimport { HTTP_STATUS } from '@game/shared';\n\n/**\n * Validates that in non-proxy mode, the handler calls performHttpsHealthCheck.\n */\ndescribe('/api/https-health non-proxy mode calls performHttpsHealthCheck', () => {\n  const OLD_ENV = process.env;\n\n  beforeEach(() => {\n    process.env = { ...OLD_ENV };\n    delete process.env[ENV_VARS.USE_REVERSE_PROXY_SSL];\n    delete process.env.RENDER;\n    process.env[ENV_VARS.HTTPS_PORT] = '443';\n    process.env[ENV_VARS.PORT] = '3001';\n    jest.resetModules();\n    jest.clearAllMocks();\n  });\n\n  afterEach(() => {\n    process.env = OLD_ENV;\n    jest.restoreAllMocks();\n  });\n\n  test('performHttpsHealthCheck is invoked and response uses its result', async () => {\n    const fakeResult = {\n      healthy: true,\n      timestamp: new Date().toISOString(),\n      checks: {\n        httpsListening: true,\n        httpRedirects: true,\n        certificateValid: true,\n        securityHeaders: true\n      },\n      certificate: undefined\n    } as any;\n\n    // Mock the module before requiring it\n    jest.isolateModules(() => {\n      const real = jest.requireActual('../httpsHealthCheck');\n      jest.doMock('../httpsHealthCheck', () => ({\n        __esModule: true,\n        ...real,\n        performHttpsHealthCheck: jest.fn().mockResolvedValue(fakeResult),\n      }));\n\n      const mod = require('../httpsHealthCheck');\n\n      const app = express();\n      app.get('/api/https-health', mod.httpsHealthCheckHandler);\n\n      return request(app).get('/api/https-health').then((res) => {\n        expect(mod.performHttpsHealthCheck).toHaveBeenCalled();\n        expect(res.status).toBe(HTTP_STATUS.OK);\n        expect(res.body).toHaveProperty('success', true);\n      });\n    });\n  });\n});\n\n"],"version":3}