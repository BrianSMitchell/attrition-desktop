ff7f0c945fdcb30c97fa0b3d7bf1b813
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CapacityService = void 0;
const supabase_1 = require("../../config/supabase");
const database_fields_1 = require("../../constants/database-fields");
class CapacityService {
    static async getBaseCapacities(empireId, coord) {
        // Load active buildings for this base/empire
        const bRes = await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.BUILDINGS)
            .select('catalog_key, is_active, pending_upgrade, construction_completed, level')
            .eq(database_fields_1.DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)
            .eq(database_fields_1.DB_FIELDS.BUILDINGS.LOCATION_COORD, coord);
        const now = Date.now();
        const levels = new Map();
        for (const b of bRes.data || []) {
            const key = String(b.catalog_key || '');
            if (!key)
                continue;
            const level = Math.max(0, Number(b.level || 0));
            const isActive = b.is_active === true;
            const pending = b.pending_upgrade === true;
            const completes = b.construction_completed ? new Date(b.construction_completed).getTime() : 0;
            const effectiveActive = isActive || pending || (completes && completes <= now);
            if (effectiveActive)
                levels.set(key, (levels.get(key) || 0) + level);
        }
        // Metal yield from location
        let metalYield = 0;
        try {
            const loc = await supabase_1.supabase.from(database_fields_1.DB_TABLES.LOCATIONS).select(database_fields_1.DB_FIELDS.LOCATIONS.RESULT).eq('coord', coord).maybeSingle();
            metalYield = Math.max(0, Number(loc.data?.result?.yields?.metal || 0));
        }
        catch { }
        const construction = this.computeConstruction(levels, metalYield);
        const production = this.computeProduction(levels, metalYield);
        const research = this.computeResearch(levels);
        const citizen = this.computeCitizen(levels);
        // Citizens bonus (if colony present)
        try {
            const col = await supabase_1.supabase
                .from(database_fields_1.DB_TABLES.COLONIES)
                .select('citizens')
                .eq(database_fields_1.DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)
                .eq(database_fields_1.DB_FIELDS.BUILDINGS.LOCATION_COORD, coord)
                .maybeSingle();
            const citizens = Math.max(0, Number(col.data?.citizens || 0));
            // Citizen capacity per hour value mirrors legacy computeCitizen from CapacityService (sum of buildings elsewhere).
            // For Phase 1, keep citizen capacity as-is (0) and only apply citizens bonus to other capacities.
            const pct = citizens / 100000; // 1000 citizens -> 1%
            const applyPct = (res) => ({
                value: Math.round(res.value * (1 + pct)),
                breakdown: [...(res.breakdown || []), ...(pct > 0 ? [{ source: 'Citizens Bonus', value: pct, kind: 'percent' }] : [])],
            });
            return {
                construction: applyPct(construction),
                production: applyPct(production),
                research: applyPct(research),
                citizen,
            };
        }
        catch {
            return { construction, production, research, citizen };
        }
    }
    static result(value, breakdown = []) {
        return { value, breakdown };
    }
    static computeConstruction(levels, metalYield) {
        const breakdown = [];
        const baseline = 40;
        breakdown.push({ source: 'Baseline', value: baseline, kind: 'flat' });
        const robotic = Math.max(0, levels.get('robotic_factories') || 0) * 2;
        if (robotic)
            breakdown.push({ source: 'Robotic Factories', value: robotic, kind: 'flat' });
        const refineryLv = Math.max(0, levels.get('metal_refineries') || 0);
        const refineryFlat = refineryLv * Math.max(0, metalYield || 0);
        if (refineryFlat)
            breakdown.push({ source: 'Metal Refineries (+metal yield per level)', value: refineryFlat, kind: 'flat' });
        return this.result(baseline + robotic + refineryFlat, breakdown);
    }
    static computeProduction(levels, metalYield) {
        const breakdown = [];
        const baseline = 0;
        breakdown.push({ source: 'Baseline', value: baseline, kind: 'flat' });
        const shipyardFlat = Math.max(0, levels.get('shipyards') || 0) * 2;
        if (shipyardFlat)
            breakdown.push({ source: 'Shipyards (+2 per level)', value: shipyardFlat, kind: 'flat' });
        const roboFlat = Math.max(0, levels.get('robotic_factories') || 0) * 2;
        if (roboFlat)
            breakdown.push({ source: 'Robotic Factories', value: roboFlat, kind: 'flat' });
        const refineryLv = Math.max(0, levels.get('metal_refineries') || 0);
        const refineryFlat = refineryLv * Math.max(0, metalYield || 0);
        if (refineryFlat)
            breakdown.push({ source: 'Metal Refineries (+metal yield per level)', value: refineryFlat, kind: 'flat' });
        return this.result(baseline + shipyardFlat + roboFlat + refineryFlat, breakdown);
    }
    static computeResearch(levels) {
        const breakdown = [];
        const baseline = 0;
        breakdown.push({ source: 'Baseline', value: baseline, kind: 'flat' });
        const flat = Math.max(0, levels.get('research_labs') || 0) * 8;
        if (flat)
            breakdown.push({ source: 'Research Labs (+8 per level)', value: flat, kind: 'flat' });
        return this.result(baseline + flat, breakdown);
    }
    static computeCitizen(levels) {
        const breakdown = [];
        const sum = (key, perLevel, label) => {
            const lv = Math.max(0, levels.get(key) || 0);
            const v = lv * perLevel;
            if (v)
                breakdown.push({ source: label, value: v, kind: 'flat' });
            return v;
        };
        const total = sum('urban_structures', 3, 'Urban Structures') +
            sum('command_centers', 1, 'Command Centers') +
            sum('orbital_base', 5, 'Orbital Base') +
            sum('capital', 8, 'Capital') +
            sum('biosphere_modification', 10, 'Biosphere Modification');
        return this.result(total, breakdown);
    }
}
exports.CapacityService = CapacityService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFByb2plY3RzXFxBdHRyaXRpb25cXHBhY2thZ2VzXFxzZXJ2ZXJcXHNyY1xcc2VydmljZXNcXGJhc2VzXFxDYXBhY2l0eVNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQUEsb0RBQWlEO0FBR2pELHFFQUF1RTtBQUN2RSxNQUFhLGVBQWU7SUFDMUIsTUFBTSxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxRQUFnQixFQUFFLEtBQWE7UUFDNUQsNkNBQTZDO1FBQzdDLE1BQU0sSUFBSSxHQUFHLE1BQU0sbUJBQVE7YUFDeEIsSUFBSSxDQUFDLDJCQUFTLENBQUMsU0FBUyxDQUFDO2FBQ3pCLE1BQU0sQ0FBQyx3RUFBd0UsQ0FBQzthQUNoRixFQUFFLENBQUMsMkJBQVMsQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQzthQUMzQyxFQUFFLENBQUMsMkJBQVMsQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRWpELE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUN2QixNQUFNLE1BQU0sR0FBRyxJQUFJLEdBQUcsRUFBa0IsQ0FBQztRQUN6QyxLQUFLLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLElBQUksRUFBRSxFQUFFLENBQUM7WUFDaEMsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFFLENBQVMsQ0FBQyxXQUFXLElBQUksRUFBRSxDQUFDLENBQUM7WUFDakQsSUFBSSxDQUFDLEdBQUc7Z0JBQUUsU0FBUztZQUNuQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUUsQ0FBUyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3pELE1BQU0sUUFBUSxHQUFJLENBQVMsQ0FBQyxTQUFTLEtBQUssSUFBSSxDQUFDO1lBQy9DLE1BQU0sT0FBTyxHQUFJLENBQVMsQ0FBQyxlQUFlLEtBQUssSUFBSSxDQUFDO1lBQ3BELE1BQU0sU0FBUyxH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QUcsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFTyxNQUFNLENBQUMsY0FBYyxDQUFDLE1BQTJCO1FBQ3ZELE1BQU0sU0FBUyxHQUFnQyxFQUFFLENBQUM7UUFDbEQsTUFBTSxHQUFHLEdBQUcsQ0FBQyxHQUFXLEVBQUUsUUFBZ0IsRUFBRSxLQUFhLEVBQUUsRUFBRTtZQUMzRCxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQzdDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsR0FBRyxRQUFRLENBQUM7WUFDeEIsSUFBSSxDQUFDO2dCQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7WUFDakUsT0FBTyxDQUFDLENBQUM7UUFDWCxDQUFDLENBQUM7UUFDRixNQUFNLEtBQUssR0FDVCxHQUFHLENBQUMsa0JBQWtCLEVBQUUsQ0FBQyxFQUFFLGtCQUFrQixDQUFDO1lBQzlDLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLEVBQUUsaUJBQWlCLENBQUM7WUFDNUMsR0FBRyxDQUFDLGNBQWMsRUFBRSxDQUFDLEVBQUUsY0FBYyxDQUFDO1lBQ3RDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxFQUFFLFNBQVMsQ0FBQztZQUM1QixHQUFHLENBQUMsd0JBQXdCLEVBQUUsRUFBRSxFQUFFLHdCQUF3QixDQUFDLENBQUM7UUFDOUQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxTQUFTLENBQUMsQ0FBQztJQUN2QyxDQUFDO0NBQ0Y7QUFwSEQsMENBb0hDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxQcm9qZWN0c1xcQXR0cml0aW9uXFxwYWNrYWdlc1xcc2VydmVyXFxzcmNcXHNlcnZpY2VzXFxiYXNlc1xcQ2FwYWNpdHlTZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHN1cGFiYXNlIH0gZnJvbSAnLi4vLi4vY29uZmlnL3N1cGFiYXNlJztcbmltcG9ydCB0eXBlIHsgQmFzZUNhcGFjaXRpZXNEVE8sIENhcGFjaXR5UmVzdWx0IH0gZnJvbSAnQGdhbWUvc2hhcmVkJztcblxuaW1wb3J0IHsgREJfVEFCTEVTLCBEQl9GSUVMRFMgfSBmcm9tICcuLi8uLi9jb25zdGFudHMvZGF0YWJhc2UtZmllbGRzJztcbmV4cG9ydCBjbGFzcyBDYXBhY2l0eVNlcnZpY2Uge1xuICBzdGF0aWMgYXN5bmMgZ2V0QmFzZUNhcGFjaXRpZXMoZW1waXJlSWQ6IHN0cmluZywgY29vcmQ6IHN0cmluZyk6IFByb21pc2U8QmFzZUNhcGFjaXRpZXNEVE8+IHtcbiAgICAvLyBMb2FkIGFjdGl2ZSBidWlsZGluZ3MgZm9yIHRoaXMgYmFzZS9lbXBpcmVcbiAgICBjb25zdCBiUmVzID0gYXdhaXQgc3VwYWJhc2VcbiAgICAgIC5mcm9tKERCX1RBQkxFUy5CVUlMRElOR1MpXG4gICAgICAuc2VsZWN0KCdjYXRhbG9nX2tleSwgaXNfYWN0aXZlLCBwZW5kaW5nX3VwZ3JhZGUsIGNvbnN0cnVjdGlvbl9jb21wbGV0ZWQsIGxldmVsJylcbiAgICAgIC5lcShEQl9GSUVMRFMuQlVJTERJTkdTLkVNUElSRV9JRCwgZW1waXJlSWQpXG4gICAgICAuZXEoREJfRklFTERTLkJVSUxESU5HUy5MT0NBVElPTl9DT09SRCwgY29vcmQpO1xuXG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBjb25zdCBsZXZlbHMgPSBuZXcgTWFwPHN0cmluZywgbnVtYmVyPigpO1xuICAgIGZvciAoY29uc3QgYiBvZiBiUmVzLmRhdGEgfHwgW10pIHtcbiAgICAgIGNvbnN0IGtleSA9IFN0cmluZygoYiBhcyBhbnkpLmNhdGFsb2dfa2V5IHx8ICcnKTtcbiAgICAgIGlmICgha2V5KSBjb250aW51ZTtcbiAgICAgIGNvbnN0IGxldmVsID0gTWF0aC5tYXgoMCwgTnVtYmVyKChiIGFzIGFueSkubGV2ZWwgfHwgMCkpO1xuICAgICAgY29uc3QgaXNBY3RpdmUgPSAoYiBhcyBhbnkpLmlzX2FjdGl2ZSA9PT0gdHJ1ZTtcbiAgICAgIGNvbnN0IHBlbmRpbmcgPSAoYiBhcyBhbnkpLnBlbmRpbmdfdXBncmFkZSA9PT0gdHJ1ZTtcbiAgICAgIGNvbnN0IGNvbXBsZXRlcyA9IChiIGFzIGFueSkuY29uc3RydWN0aW9uX2NvbXBsZXRlZCA/IG5ldyBEYXRlKChiIGFzIGFueSkuY29uc3RydWN0aW9uX2NvbXBsZXRlZCkuZ2V0VGltZSgpIDogMDtcbiAgICAgIGNvbnN0IGVmZmVjdGl2ZUFjdGl2ZSA9IGlzQWN0aXZlIHx8IHBlbmRpbmcgfHwgKGNvbXBsZXRlcyAmJiBjb21wbGV0ZXMgPD0gbm93KTtcbiAgICAgIGlmIChlZmZlY3RpdmVBY3RpdmUpIGxldmVscy5zZXQoa2V5LCAobGV2ZWxzLmdldChrZXkpIHx8IDApICsgbGV2ZWwpO1xuICAgIH1cblxuICAgIC8vIE1ldGFsIHlpZWxkIGZyb20gbG9jYXRpb25cbiAgICBsZXQgbWV0YWxZaWVsZCA9IDA7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGxvYyA9IGF3YWl0IHN1cGFiYXNlLmZyb20oREJfVEFCTEVTLkxPQ0FUSU9OUykuc2VsZWN0KERCX0ZJRUxEUy5MT0NBVElPTlMuUkVTVUxUKS5lcSgnY29vcmQnLCBjb29yZCkubWF5YmVTaW5nbGUoKTtcbiAgICAgIG1ldGFsWWllbGQgPSBNYXRoLm1heCgwLCBOdW1iZXIoKGxvYy5kYXRhIGFzIGFueSk/LnJlc3VsdD8ueWllbGRzPy5tZXRhbCB8fCAwKSk7XG4gICAgfSBjYXRjaCB7fVxuXG4gICAgY29uc3QgY29uc3RydWN0aW9uID0gdGhpcy5jb21wdXRlQ29uc3RydWN0aW9uKGxldmVscywgbWV0YWxZaWVsZCk7XG4gICAgY29uc3QgcHJvZHVjdGlvbiA9IHRoaXMuY29tcHV0ZVByb2R1Y3Rpb24obGV2ZWxzLCBtZXRhbFlpZWxkKTtcbiAgICBjb25zdCByZXNlYXJjaCA9IHRoaXMuY29tcHV0ZVJlc2VhcmNoKGxldmVscyk7XG4gICAgY29uc3QgY2l0aXplbiA9IHRoaXMuY29tcHV0ZUNpdGl6ZW4obGV2ZWxzKTtcblxuICAgIC8vIENpdGl6ZW5zIGJvbnVzIChpZiBjb2xvbnkgcHJlc2VudClcbiAgICB0cnkge1xuICAgICAgY29uc3QgY29sID0gYXdhaXQgc3VwYWJhc2VcbiAgICAgICAgLmZyb20oREJfVEFCTEVTLkNPTE9OSUVTKVxuICAgICAgICAuc2VsZWN0KCdjaXRpemVucycpXG4gICAgICAgIC5lcShEQl9GSUVMRFMuQlVJTERJTkdTLkVNUElSRV9JRCwgZW1waXJlSWQpXG4gICAgICAgIC5lcShEQl9GSUVMRFMuQlVJTERJTkdTLkxPQ0FUSU9OX0NPT1JELCBjb29yZClcbiAgICAgICAgLm1heWJlU2luZ2xlKCk7XG4gICAgICBjb25zdCBjaXRpemVucyA9IE1hdGgubWF4KDAsIE51bWJlcigoY29sLmRhdGEgYXMgYW55KT8uY2l0aXplbnMgfHwgMCkpO1xuICAgICAgLy8gQ2l0aXplbiBjYXBhY2l0eSBwZXIgaG91ciB2YWx1ZSBtaXJyb3JzIGxlZ2FjeSBjb21wdXRlQ2l0aXplbiBmcm9tIENhcGFjaXR5U2VydmljZSAoc3VtIG9mIGJ1aWxkaW5ncyBlbHNld2hlcmUpLlxuICAgICAgLy8gRm9yIFBoYXNlIDEsIGtlZXAgY2l0aXplbiBjYXBhY2l0eSBhcy1pcyAoMCkgYW5kIG9ubHkgYXBwbHkgY2l0aXplbnMgYm9udXMgdG8gb3RoZXIgY2FwYWNpdGllcy5cbiAgICAgIGNvbnN0IHBjdCA9IGNpdGl6ZW5zIC8gMTAwMDAwOyAvLyAxMDAwIGNpdGl6ZW5zIC0+IDElXG4gICAgICBjb25zdCBhcHBseVBjdCA9IChyZXM6IENhcGFjaXR5UmVzdWx0KTogQ2FwYWNpdHlSZXN1bHQgPT4gKHtcbiAgICAgICAgdmFsdWU6IE1hdGgucm91bmQocmVzLnZhbHVlICogKDEgKyBwY3QpKSxcbiAgICAgICAgYnJlYWtkb3duOiBbLi4uKHJlcy5icmVha2Rvd24gfHwgW10pLCAuLi4ocGN0ID4gMCA/IFt7IHNvdXJjZTogJ0NpdGl6ZW5zIEJvbnVzJywgdmFsdWU6IHBjdCwga2luZDogJ3BlcmNlbnQnIGFzIGNvbnN0IH1dIDogW10pXSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgY29uc3RydWN0aW9uOiBhcHBseVBjdChjb25zdHJ1Y3Rpb24pLFxuICAgICAgICBwcm9kdWN0aW9uOiBhcHBseVBjdChwcm9kdWN0aW9uKSxcbiAgICAgICAgcmVzZWFyY2g6IGFwcGx5UGN0KHJlc2VhcmNoKSxcbiAgICAgICAgY2l0aXplbixcbiAgICAgIH07XG4gICAgfSBjYXRjaCB7XG4gICAgICByZXR1cm4geyBjb25zdHJ1Y3Rpb24sIHByb2R1Y3Rpb24sIHJlc2VhcmNoLCBjaXRpemVuIH07XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgcmVzdWx0KHZhbHVlOiBudW1iZXIsIGJyZWFrZG93bjogQ2FwYWNpdHlSZXN1bHRbJ2JyZWFrZG93biddID0gW10pOiBDYXBhY2l0eVJlc3VsdCB7XG4gICAgcmV0dXJuIHsgdmFsdWUsIGJyZWFrZG93biB9O1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgY29tcHV0ZUNvbnN0cnVjdGlvbihsZXZlbHM6IE1hcDxzdHJpbmcsIG51bWJlcj4sIG1ldGFsWWllbGQ6IG51bWJlcik6IENhcGFjaXR5UmVzdWx0IHtcbiAgICBjb25zdCBicmVha2Rvd246IENhcGFjaXR5UmVzdWx0WydicmVha2Rvd24nXSA9IFtdO1xuICAgIGNvbnN0IGJhc2VsaW5lID0gNDA7XG4gICAgYnJlYWtkb3duLnB1c2goeyBzb3VyY2U6ICdCYXNlbGluZScsIHZhbHVlOiBiYXNlbGluZSwga2luZDogJ2ZsYXQnIH0pO1xuICAgIGNvbnN0IHJvYm90aWMgPSBNYXRoLm1heCgwLCBsZXZlbHMuZ2V0KCdyb2JvdGljX2ZhY3RvcmllcycpIHx8IDApICogMjtcbiAgICBpZiAocm9ib3RpYykgYnJlYWtkb3duLnB1c2goeyBzb3VyY2U6ICdSb2JvdGljIEZhY3RvcmllcycsIHZhbHVlOiByb2JvdGljLCBraW5kOiAnZmxhdCcgfSk7XG4gICAgY29uc3QgcmVmaW5lcnlMdiA9IE1hdGgubWF4KDAsIGxldmVscy5nZXQoJ21ldGFsX3JlZmluZXJpZXMnKSB8fCAwKTtcbiAgICBjb25zdCByZWZpbmVyeUZsYXQgPSByZWZpbmVyeUx2ICogTWF0aC5tYXgoMCwgbWV0YWxZaWVsZCB8fCAwKTtcbiAgICBpZiAocmVmaW5lcnlGbGF0KSBicmVha2Rvd24ucHVzaCh7IHNvdXJjZTogJ01ldGFsIFJlZmluZXJpZXMgKCttZXRhbCB5aWVsZCBwZXIgbGV2ZWwpJywgdmFsdWU6IHJlZmluZXJ5RmxhdCwga2luZDogJ2ZsYXQnIH0pO1xuICAgIHJldHVybiB0aGlzLnJlc3VsdChiYXNlbGluZSArIHJvYm90aWMgKyByZWZpbmVyeUZsYXQsIGJyZWFrZG93bik7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBjb21wdXRlUHJvZHVjdGlvbihsZXZlbHM6IE1hcDxzdHJpbmcsIG51bWJlcj4sIG1ldGFsWWllbGQ6IG51bWJlcik6IENhcGFjaXR5UmVzdWx0IHtcbiAgICBjb25zdCBicmVha2Rvd246IENhcGFjaXR5UmVzdWx0WydicmVha2Rvd24nXSA9IFtdO1xuICAgIGNvbnN0IGJhc2VsaW5lID0gMDtcbiAgICBicmVha2Rvd24ucHVzaCh7IHNvdXJjZTogJ0Jhc2VsaW5lJywgdmFsdWU6IGJhc2VsaW5lLCBraW5kOiAnZmxhdCcgfSk7XG4gICAgY29uc3Qgc2hpcHlhcmRGbGF0ID0gTWF0aC5tYXgoMCwgbGV2ZWxzLmdldCgnc2hpcHlhcmRzJykgfHwgMCkgKiAyO1xuICAgIGlmIChzaGlweWFyZEZsYXQpIGJyZWFrZG93bi5wdXNoKHsgc291cmNlOiAnU2hpcHlhcmRzICgrMiBwZXIgbGV2ZWwpJywgdmFsdWU6IHNoaXB5YXJkRmxhdCwga2luZDogJ2ZsYXQnIH0pO1xuICAgIGNvbnN0IHJvYm9GbGF0ID0gTWF0aC5tYXgoMCwgbGV2ZWxzLmdldCgncm9ib3RpY19mYWN0b3JpZXMnKSB8fCAwKSAqIDI7XG4gICAgaWYgKHJvYm9GbGF0KSBicmVha2Rvd24ucHVzaCh7IHNvdXJjZTogJ1JvYm90aWMgRmFjdG9yaWVzJywgdmFsdWU6IHJvYm9GbGF0LCBraW5kOiAnZmxhdCcgfSk7XG4gICAgY29uc3QgcmVmaW5lcnlMdiA9IE1hdGgubWF4KDAsIGxldmVscy5nZXQoJ21ldGFsX3JlZmluZXJpZXMnKSB8fCAwKTtcbiAgICBjb25zdCByZWZpbmVyeUZsYXQgPSByZWZpbmVyeUx2ICogTWF0aC5tYXgoMCwgbWV0YWxZaWVsZCB8fCAwKTtcbiAgICBpZiAocmVmaW5lcnlGbGF0KSBicmVha2Rvd24ucHVzaCh7IHNvdXJjZTogJ01ldGFsIFJlZmluZXJpZXMgKCttZXRhbCB5aWVsZCBwZXIgbGV2ZWwpJywgdmFsdWU6IHJlZmluZXJ5RmxhdCwga2luZDogJ2ZsYXQnIH0pO1xuICAgIHJldHVybiB0aGlzLnJlc3VsdChiYXNlbGluZSArIHNoaXB5YXJkRmxhdCArIHJvYm9GbGF0ICsgcmVmaW5lcnlGbGF0LCBicmVha2Rvd24pO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgY29tcHV0ZVJlc2VhcmNoKGxldmVsczogTWFwPHN0cmluZywgbnVtYmVyPik6IENhcGFjaXR5UmVzdWx0IHtcbiAgICBjb25zdCBicmVha2Rvd246IENhcGFjaXR5UmVzdWx0WydicmVha2Rvd24nXSA9IFtdO1xuICAgIGNvbnN0IGJhc2VsaW5lID0gMDtcbiAgICBicmVha2Rvd24ucHVzaCh7IHNvdXJjZTogJ0Jhc2VsaW5lJywgdmFsdWU6IGJhc2VsaW5lLCBraW5kOiAnZmxhdCcgfSk7XG4gICAgY29uc3QgZmxhdCA9IE1hdGgubWF4KDAsIGxldmVscy5nZXQoJ3Jlc2VhcmNoX2xhYnMnKSB8fCAwKSAqIDg7XG4gICAgaWYgKGZsYXQpIGJyZWFrZG93bi5wdXNoKHsgc291cmNlOiAnUmVzZWFyY2ggTGFicyAoKzggcGVyIGxldmVsKScsIHZhbHVlOiBmbGF0LCBraW5kOiAnZmxhdCcgfSk7XG4gICAgcmV0dXJuIHRoaXMucmVzdWx0KGJhc2VsaW5lICsgZmxhdCwgYnJlYWtkb3duKTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGNvbXB1dGVDaXRpemVuKGxldmVsczogTWFwPHN0cmluZywgbnVtYmVyPik6IENhcGFjaXR5UmVzdWx0IHtcbiAgICBjb25zdCBicmVha2Rvd246IENhcGFjaXR5UmVzdWx0WydicmVha2Rvd24nXSA9IFtdO1xuICAgIGNvbnN0IHN1bSA9IChrZXk6IHN0cmluZywgcGVyTGV2ZWw6IG51bWJlciwgbGFiZWw6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgbHYgPSBNYXRoLm1heCgwLCBsZXZlbHMuZ2V0KGtleSkgfHwgMCk7XG4gICAgICBjb25zdCB2ID0gbHYgKiBwZXJMZXZlbDtcbiAgICAgIGlmICh2KSBicmVha2Rvd24ucHVzaCh7IHNvdXJjZTogbGFiZWwsIHZhbHVlOiB2LCBraW5kOiAnZmxhdCcgfSk7XG4gICAgICByZXR1cm4gdjtcbiAgICB9O1xuICAgIGNvbnN0IHRvdGFsID1cbiAgICAgIHN1bSgndXJiYW5fc3RydWN0dXJlcycsIDMsICdVcmJhbiBTdHJ1Y3R1cmVzJykgK1xuICAgICAgc3VtKCdjb21tYW5kX2NlbnRlcnMnLCAxLCAnQ29tbWFuZCBDZW50ZXJzJykgK1xuICAgICAgc3VtKCdvcmJpdGFsX2Jhc2UnLCA1LCAnT3JiaXRhbCBCYXNlJykgK1xuICAgICAgc3VtKCdjYXBpdGFsJywgOCwgJ0NhcGl0YWwnKSArXG4gICAgICBzdW0oJ2Jpb3NwaGVyZV9tb2RpZmljYXRpb24nLCAxMCwgJ0Jpb3NwaGVyZSBNb2RpZmljYXRpb24nKTtcbiAgICByZXR1cm4gdGhpcy5yZXN1bHQodG90YWwsIGJyZWFrZG93bik7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==