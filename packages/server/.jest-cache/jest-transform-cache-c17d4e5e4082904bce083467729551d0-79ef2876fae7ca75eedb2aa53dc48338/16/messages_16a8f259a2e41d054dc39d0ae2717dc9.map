{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\routes\\messages.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\routes\\messages.ts"],"sourcesContent":["import express from 'express';\r\nimport { authenticate, AuthRequest } from '../middleware/auth';\r\nimport { Response } from 'express';\r\nimport { asyncHandler } from '../middleware/errorHandler';\r\nimport { supabase } from '../config/supabase';\r\nimport { DB_TABLES, DB_FIELDS } from '../constants/database-fields';\r\nimport { HTTP_STATUS, RESPONSE_FORMAT } from '../constants/response-formats';\r\n\r\nconst router = express.Router();\r\n\r\n// Get message summary (unread count, etc.)\r\nrouter.get('/summary', authenticate, asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const userId = (req.user as any)?._id || (req.user as any)?.id || (req.user as any)?.userId;\r\n  const uid = String(userId);\r\n\r\n  // Perform counts using Supabase exact counts (head requests to avoid payloads)\r\n  const [inboxRes, sentRes, unreadRes] = await Promise.all([\r\n    supabase\r\n      .from(DB_TABLES.MESSAGES)\r\n      .select('*', { count: 'exact', head: true })\r\n      .eq('to_user_id', uid),\r\n    supabase\r\n      .from(DB_TABLES.MESSAGES)\r\n      .select('*', { count: 'exact', head: true })\r\n      .eq('from_user_id', uid),\r\n    supabase\r\n      .from(DB_TABLES.MESSAGES)\r\n      .select('*', { count: 'exact', head: true })\r\n      .eq('to_user_id', uid)\r\n      .eq('is_read', false),\r\n  ]);\r\n\r\n  const inboxCount = inboxRes.error ? 0 : (inboxRes.count ?? 0);\r\n  const sentCount = sentRes.error ? 0 : (sentRes.count ?? 0);\r\n  const unreadMessages = unreadRes.error ? 0 : (unreadRes.count ?? 0);\r\n  const totalMessages = inboxCount + sentCount;\r\n\r\n  if (inboxRes.error || sentRes.error || unreadRes.error) {\r\n    // Log minimal error context; return what we have\r\n    return res.status(HTTP_STATUS.OK).json({\r\n      success: true,\r\n      data: { totalMessages, unreadMessages, inboxCount, sentCount },\r\n      warnings: [\r\n        inboxRes.error?.message,\r\n        sentRes.error?.message,\r\n        unreadRes.error?.message,\r\n      ].filter(Boolean),\r\n    });\r\n  }\r\n\r\n  return res.json({\r\n    success: true,\r\n    data: { totalMessages, unreadMessages, inboxCount, sentCount }\r\n  });\r\n}));\r\n\r\n// Get inbox messages\r\nrouter.get('/inbox', authenticate, asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const userId = req.user!.userId;\r\n  const page = parseInt(req.query.page as string) || 1;\r\n  const limit = Math.min(parseInt(req.query.limit as string) || 20, 50); // Max 50 per page\r\n  const offset = (page - 1) * limit;\r\n  const uid = String(userId);\r\n\r\n  // Get paginated messages\r\n  const { data: messages, error: messagesError } = await supabase\r\n    .from(DB_TABLES.MESSAGES)\r\n    .select('*')\r\n    .eq('to_user_id', uid)\r\n    .order(DB_FIELDS.BUILDINGS.CREATED_AT, { ascending: false })\r\n    .range(offset, offset + limit - 1);\r\n\r\n  if (messagesError) {\r\n    console.error('Error fetching inbox messages:', messagesError);\r\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({\r\n      success: false,\r\n      error: 'Failed to fetch inbox messages'\r\n    });\r\n  }\r\n\r\n  // Get total count\r\n  const { count: totalCount, error: countError } = await supabase\r\n    .from(DB_TABLES.MESSAGES)\r\n    .select('*', { count: 'exact', head: true })\r\n    .eq('to_user_id', uid);\r\n\r\n  if (countError) {\r\n    console.error('Error counting inbox messages:', countError);\r\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({\r\n      success: false,\r\n      error: 'Failed to count inbox messages'\r\n    });\r\n  }\r\n\r\n  const totalPages = Math.ceil((totalCount || 0) / limit);\r\n\r\n  return res.json({\r\n    success: true,\r\n    data: {\r\n      messages: messages || [],\r\n      totalPages\r\n    }\r\n  });\r\n}));\r\n\r\n// Get sent messages\r\nrouter.get('/sent', authenticate, asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const userId = req.user!.userId;\r\n  const page = parseInt(req.query.page as string) || 1;\r\n  const limit = Math.min(parseInt(req.query.limit as string) || 20, 50); // Max 50 per page\r\n  const offset = (page - 1) * limit;\r\n  const uid = String(userId);\r\n\r\n  // Get paginated messages\r\n  const { data: messages, error: messagesError } = await supabase\r\n    .from(DB_TABLES.MESSAGES)\r\n    .select('*')\r\n    .eq('from_user_id', uid)\r\n    .order(DB_FIELDS.BUILDINGS.CREATED_AT, { ascending: false })\r\n    .range(offset, offset + limit - 1);\r\n\r\n  if (messagesError) {\r\n    console.error('Error fetching sent messages:', messagesError);\r\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({\r\n      success: false,\r\n      error: 'Failed to fetch sent messages'\r\n    });\r\n  }\r\n\r\n  // Get total count\r\n  const { count: totalCount, error: countError } = await supabase\r\n    .from(DB_TABLES.MESSAGES)\r\n    .select('*', { count: 'exact', head: true })\r\n    .eq('from_user_id', uid);\r\n\r\n  if (countError) {\r\n    console.error('Error counting sent messages:', countError);\r\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({\r\n      success: false,\r\n      error: 'Failed to count sent messages'\r\n    });\r\n  }\r\n\r\n  const totalPages = Math.ceil((totalCount || 0) / limit);\r\n\r\n  return res.json({\r\n    success: true,\r\n    data: {\r\n      messages: messages || [],\r\n      totalPages\r\n    }\r\n  });\r\n}));\r\n\r\n// Get message by ID\r\nrouter.get('/:messageId', authenticate, asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const userId = req.user!.userId;\r\n  const messageId = req.params.messageId;\r\n  const uid = String(userId);\r\n\r\n  // Basic UUID validation (Supabase uses UUID for IDs)\r\n  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\r\n  if (!uuidRegex.test(messageId)) {\r\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({\r\n      success: false,\r\n      code: 'INVALID_MESSAGE_ID',\r\n      message: 'Invalid message ID format'\r\n    });\r\n  }\r\n\r\n  // Get message with authorization check\r\n  const { data: message, error } = await supabase\r\n    .from(DB_TABLES.MESSAGES)\r\n    .select('*')\r\n    .eq(DB_FIELDS.BUILDINGS.ID, messageId)\r\n    .or(`from_user_id.eq.${uid},to_user_id.eq.${uid}`)\r\n    .maybeSingle();\r\n\r\n  if (error) {\r\n    console.error('Error fetching message by ID:', error);\r\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({\r\n      success: false,\r\n      error: 'Failed to fetch message'\r\n    });\r\n  }\r\n\r\n  if (!message) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({\r\n      success: false,\r\n      code: 'MESSAGE_NOT_FOUND',\r\n      message: 'Message not found'\r\n    });\r\n  }\r\n\r\n  return res.json({\r\n    success: true,\r\n    data: message\r\n  });\r\n}));\r\n\r\n// Send a new message\r\nrouter.post('/', authenticate, asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const userId = req.user!.userId;\r\n  const { toUsername, subject, content } = req.body;\r\n\r\n  // Validation\r\n  if (!toUsername || !subject || !content) {\r\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({\r\n      success: false,\r\n      code: 'MISSING_FIELDS',\r\n      message: 'Missing required fields: toUsername, subject, content'\r\n    });\r\n  }\r\n\r\n  if (subject.length > 200) {\r\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({\r\n      success: false,\r\n      code: 'SUBJECT_TOO_LONG',\r\n      message: 'Subject must be 200 characters or less'\r\n    });\r\n  }\r\n\r\n  if (content.length > 2000) {\r\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({\r\n      success: false,\r\n      code: 'CONTENT_TOO_LONG',\r\n      message: 'Content must be 2000 characters or less'\r\n    });\r\n  }\r\n\r\n  const uid = String(userId);\r\n\r\n  // Find sender\r\n  const { data: sender, error: senderError } = await supabase\r\n    .from(DB_TABLES.USERS)\r\n    .select('id, username')\r\n    .eq(DB_FIELDS.BUILDINGS.ID, uid)\r\n    .maybeSingle();\r\n\r\n  if (senderError || !sender) {\r\n    console.error('Error finding sender:', senderError);\r\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({\r\n      success: false,\r\n      code: 'SENDER_NOT_FOUND',\r\n      message: 'Sender not found'\r\n    });\r\n  }\r\n\r\n  // Find sender's empire\r\n  const { data: senderEmpire } = await supabase\r\n    .from(DB_TABLES.EMPIRES)\r\n    .select('id, name')\r\n    .eq(DB_FIELDS.EMPIRES.USER_ID, uid)\r\n    .maybeSingle();\r\n\r\n  // Find recipient\r\n  const { data: recipient, error: recipientError } = await supabase\r\n    .from(DB_TABLES.USERS)\r\n    .select('id, username')\r\n    .eq(DB_FIELDS.USERS.USERNAME, toUsername)\r\n    .maybeSingle();\r\n\r\n  if (recipientError || !recipient) {\r\n    console.error('Error finding recipient:', recipientError);\r\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({\r\n      success: false,\r\n      code: 'RECIPIENT_NOT_FOUND',\r\n      message: 'Recipient not found'\r\n    });\r\n  }\r\n\r\n  // Find recipient's empire\r\n  const { data: recipientEmpire } = await supabase\r\n    .from(DB_TABLES.EMPIRES)\r\n    .select('id, name')\r\n    .eq(DB_FIELDS.EMPIRES.USER_ID, String(recipient.id))\r\n    .maybeSingle();\r\n\r\n  // Create message\r\n  const { data: message, error: messageError } = await supabase\r\n    .from(DB_TABLES.MESSAGES)\r\n    .insert({\r\n      from_user_id: sender.id,\r\n      to_user_id: recipient.id,\r\n      from_username: sender.username,\r\n      to_username: recipient.username,\r\n      from_empire_name: senderEmpire?.name || null,\r\n      to_empire_name: recipientEmpire?.name || null,\r\n      subject: subject.trim(),\r\n      content: content.trim(),\r\n      is_read: false,\r\n      created_at: new Date().toISOString()\r\n    })\r\n    .select('*')\r\n    .single();\r\n\r\n  if (messageError) {\r\n    console.error('Error creating message:', messageError);\r\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({\r\n      success: false,\r\n      error: 'Failed to create message'\r\n    });\r\n  }\r\n\r\n  return res.status(HTTP_STATUS.CREATED).json({\r\n    success: true,\r\n    data: message\r\n  });\r\n}));\r\n\r\n// Mark message as read\r\nrouter.patch('/:messageId/read', authenticate, asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const userId = req.user!.userId;\r\n  const messageId = req.params.messageId;\r\n  const uid = String(userId);\r\n\r\n  // Basic UUID validation (Supabase uses UUID for IDs)\r\n  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\r\n  if (!uuidRegex.test(messageId)) {\r\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({\r\n      success: false,\r\n      code: 'INVALID_MESSAGE_ID',\r\n      message: 'Invalid message ID format'\r\n    });\r\n  }\r\n\r\n  // Update message to mark as read (only if user is recipient)\r\n  const { data, error } = await supabase\r\n    .from(DB_TABLES.MESSAGES)\r\n    .update({ is_read: true })\r\n    .eq(DB_FIELDS.BUILDINGS.ID, messageId)\r\n    .eq('to_user_id', uid) // Only recipient can mark as read\r\n    .select(DB_FIELDS.BUILDINGS.ID)\r\n    .single();\r\n\r\n  if (error) {\r\n    console.error('Error marking message as read:', error);\r\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({\r\n      success: false,\r\n      error: 'Failed to mark message as read'\r\n    });\r\n  }\r\n\r\n  if (!data) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({\r\n      success: false,\r\n      code: 'MESSAGE_NOT_FOUND',\r\n      message: 'Message not found or not authorized'\r\n    });\r\n  }\r\n\r\n  return res.json({\r\n    success: true,\r\n    message: 'Message marked as read'\r\n  });\r\n}));\r\n\r\n// Mark all messages as read\r\nrouter.patch('/mark-all-read', authenticate, asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const userId = req.user!.userId;\r\n  const uid = String(userId);\r\n\r\n  // Update all messages for this user as read\r\n  const { error } = await supabase\r\n    .from(DB_TABLES.MESSAGES)\r\n    .update({ is_read: true })\r\n    .eq('to_user_id', uid);\r\n\r\n  if (error) {\r\n    console.error('Error marking all messages as read:', error);\r\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({\r\n      success: false,\r\n      error: 'Failed to mark all messages as read'\r\n    });\r\n  }\r\n\r\n  return res.json({\r\n    success: true,\r\n    message: 'All messages marked as read'\r\n  });\r\n}));\r\n\r\n// Delete a message\r\nrouter.delete('/:messageId', authenticate, asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const userId = req.user!.userId;\r\n  const messageId = req.params.messageId;\r\n  const uid = String(userId);\r\n\r\n  // Basic UUID validation (Supabase uses UUID for IDs)\r\n  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\r\n  if (!uuidRegex.test(messageId)) {\r\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({\r\n      success: false,\r\n      code: 'INVALID_MESSAGE_ID',\r\n      message: 'Invalid message ID format'\r\n    });\r\n  }\r\n\r\n  // Delete message (only if user is sender or recipient)\r\n  const { data, error } = await supabase\r\n    .from(DB_TABLES.MESSAGES)\r\n    .delete()\r\n    .eq(DB_FIELDS.BUILDINGS.ID, messageId)\r\n    .or(`from_user_id.eq.${uid},to_user_id.eq.${uid}`)\r\n    .select(DB_FIELDS.BUILDINGS.ID)\r\n    .single();\r\n\r\n  if (error) {\r\n    console.error('Error deleting message:', error);\r\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({\r\n      success: false,\r\n      error: 'Failed to delete message'\r\n    });\r\n  }\r\n\r\n  if (!data) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({\r\n      success: false,\r\n      code: 'MESSAGE_NOT_FOUND',\r\n      message: 'Message not found or not authorized'\r\n    });\r\n  }\r\n\r\n  return res.json({\r\n    success: true,\r\n    message: 'Message deleted'\r\n  });\r\n}));\r\n\r\nexport default router;\r\n\r\n"],"version":3}