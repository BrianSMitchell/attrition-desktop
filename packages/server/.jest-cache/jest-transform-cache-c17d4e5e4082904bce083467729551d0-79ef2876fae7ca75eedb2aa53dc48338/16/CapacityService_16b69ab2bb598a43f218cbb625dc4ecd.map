{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\services\\bases\\CapacityService.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\services\\bases\\CapacityService.ts"],"sourcesContent":["import { supabase } from '../../config/supabase';\nimport type { BaseCapacitiesDTO, CapacityResult } from '@game/shared';\n\nimport { DB_TABLES, DB_FIELDS } from '../../constants/database-fields';\nexport class CapacityService {\n  static async getBaseCapacities(empireId: string, coord: string): Promise<BaseCapacitiesDTO> {\n    // Load active buildings for this base/empire\n    const bRes = await supabase\n      .from(DB_TABLES.BUILDINGS)\n      .select('catalog_key, is_active, pending_upgrade, construction_completed, level')\n      .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n      .eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, coord);\n\n    const now = Date.now();\n    const levels = new Map<string, number>();\n    for (const b of bRes.data || []) {\n      const key = String((b as any).catalog_key || '');\n      if (!key) continue;\n      const level = Math.max(0, Number((b as any).level || 0));\n      const isActive = (b as any).is_active === true;\n      const pending = (b as any).pending_upgrade === true;\n      const completes = (b as any).construction_completed ? new Date((b as any).construction_completed).getTime() : 0;\n      const effectiveActive = isActive || pending || (completes && completes <= now);\n      if (effectiveActive) levels.set(key, (levels.get(key) || 0) + level);\n    }\n\n    // Metal yield from location\n    let metalYield = 0;\n    try {\n      const loc = await supabase.from(DB_TABLES.LOCATIONS).select(DB_FIELDS.LOCATIONS.RESULT).eq('coord', coord).maybeSingle();\n      metalYield = Math.max(0, Number((loc.data as any)?.result?.yields?.metal || 0));\n    } catch {}\n\n    const construction = this.computeConstruction(levels, metalYield);\n    const production = this.computeProduction(levels, metalYield);\n    const research = this.computeResearch(levels);\n    const citizen = this.computeCitizen(levels);\n\n    // Citizens bonus (if colony present)\n    try {\n      const col = await supabase\n        .from(DB_TABLES.COLONIES)\n        .select('citizens')\n        .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n        .eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, coord)\n        .maybeSingle();\n      const citizens = Math.max(0, Number((col.data as any)?.citizens || 0));\n      // Citizen capacity per hour value mirrors legacy computeCitizen from CapacityService (sum of buildings elsewhere).\n      // For Phase 1, keep citizen capacity as-is (0) and only apply citizens bonus to other capacities.\n      const pct = citizens / 100000; // 1000 citizens -> 1%\n      const applyPct = (res: CapacityResult): CapacityResult => ({\n        value: Math.round(res.value * (1 + pct)),\n        breakdown: [...(res.breakdown || []), ...(pct > 0 ? [{ source: 'Citizens Bonus', value: pct, kind: 'percent' as const }] : [])],\n      });\n      return {\n        construction: applyPct(construction),\n        production: applyPct(production),\n        research: applyPct(research),\n        citizen,\n      };\n    } catch {\n      return { construction, production, research, citizen };\n    }\n  }\n\n  private static result(value: number, breakdown: CapacityResult['breakdown'] = []): CapacityResult {\n    return { value, breakdown };\n  }\n\n  private static computeConstruction(levels: Map<string, number>, metalYield: number): CapacityResult {\n    const breakdown: CapacityResult['breakdown'] = [];\n    const baseline = 40;\n    breakdown.push({ source: 'Baseline', value: baseline, kind: 'flat' });\n    const robotic = Math.max(0, levels.get('robotic_factories') || 0) * 2;\n    if (robotic) breakdown.push({ source: 'Robotic Factories', value: robotic, kind: 'flat' });\n    const refineryLv = Math.max(0, levels.get('metal_refineries') || 0);\n    const refineryFlat = refineryLv * Math.max(0, metalYield || 0);\n    if (refineryFlat) breakdown.push({ source: 'Metal Refineries (+metal yield per level)', value: refineryFlat, kind: 'flat' });\n    return this.result(baseline + robotic + refineryFlat, breakdown);\n  }\n\n  private static computeProduction(levels: Map<string, number>, metalYield: number): CapacityResult {\n    const breakdown: CapacityResult['breakdown'] = [];\n    const baseline = 0;\n    breakdown.push({ source: 'Baseline', value: baseline, kind: 'flat' });\n    const shipyardFlat = Math.max(0, levels.get('shipyards') || 0) * 2;\n    if (shipyardFlat) breakdown.push({ source: 'Shipyards (+2 per level)', value: shipyardFlat, kind: 'flat' });\n    const roboFlat = Math.max(0, levels.get('robotic_factories') || 0) * 2;\n    if (roboFlat) breakdown.push({ source: 'Robotic Factories', value: roboFlat, kind: 'flat' });\n    const refineryLv = Math.max(0, levels.get('metal_refineries') || 0);\n    const refineryFlat = refineryLv * Math.max(0, metalYield || 0);\n    if (refineryFlat) breakdown.push({ source: 'Metal Refineries (+metal yield per level)', value: refineryFlat, kind: 'flat' });\n    return this.result(baseline + shipyardFlat + roboFlat + refineryFlat, breakdown);\n  }\n\n  private static computeResearch(levels: Map<string, number>): CapacityResult {\n    const breakdown: CapacityResult['breakdown'] = [];\n    const baseline = 0;\n    breakdown.push({ source: 'Baseline', value: baseline, kind: 'flat' });\n    const flat = Math.max(0, levels.get('research_labs') || 0) * 8;\n    if (flat) breakdown.push({ source: 'Research Labs (+8 per level)', value: flat, kind: 'flat' });\n    return this.result(baseline + flat, breakdown);\n  }\n\n  private static computeCitizen(levels: Map<string, number>): CapacityResult {\n    const breakdown: CapacityResult['breakdown'] = [];\n    const sum = (key: string, perLevel: number, label: string) => {\n      const lv = Math.max(0, levels.get(key) || 0);\n      const v = lv * perLevel;\n      if (v) breakdown.push({ source: label, value: v, kind: 'flat' });\n      return v;\n    };\n    const total =\n      sum('urban_structures', 3, 'Urban Structures') +\n      sum('command_centers', 1, 'Command Centers') +\n      sum('orbital_base', 5, 'Orbital Base') +\n      sum('capital', 8, 'Capital') +\n      sum('biosphere_modification', 10, 'Biosphere Modification');\n    return this.result(total, breakdown);\n  }\n}\n"],"version":3}