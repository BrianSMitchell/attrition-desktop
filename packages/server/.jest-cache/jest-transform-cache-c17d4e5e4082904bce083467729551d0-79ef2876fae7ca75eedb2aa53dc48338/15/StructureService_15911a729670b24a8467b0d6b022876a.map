{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\services\\structures\\StructureService.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\services\\structures\\StructureService.ts"],"sourcesContent":["import { supabase } from '../../config/supabase';\r\nimport { ERROR_MESSAGES } from '../../constants/response-formats';\r\nimport { DB_TABLES, DB_FIELDS } from '../../constants/database-fields';\r\nimport { \r\n  getBuildingSpec, \r\n  BuildingKey, \r\n  computeEnergyBalance, \r\n  getStructureCreditCostForLevel \r\n} from '@game/shared';\r\nimport { StatsService } from '../bases/StatsService';\r\nimport { CapacityService } from '../bases/CapacityService';\r\n\r\nexport interface Structure {\r\n  catalogKey: string;\r\n  level: number;\r\n  isActive: boolean;\r\n  pendingUpgrade: boolean;\r\n  constructionStarted: Date | null;\r\n  constructionCompleted: Date | null;\r\n  creditsCost: number | null;\r\n}\r\n\r\nexport interface BaseStats {\r\n  area: {\r\n    total: number;\r\n    used: number;\r\n    free: number;\r\n  };\r\n  population: {\r\n    capacity: number;\r\n    used: number;\r\n    free: number;\r\n  };\r\n}\r\n\r\nexport class StructureService {\r\n  /**\r\n   * Get structures catalog\r\n   */\r\n  static async getCatalog(): Promise<{ data: any; error: string | null }> {\r\n    try {\r\n      const { getStructuresCatalog } = await import('../../services/structures/structures.data');\r\n      const catalog = getStructuresCatalog();\r\n      return { data: catalog, error: null };\r\n    } catch (e: any) {\r\n      return { data: null, error: e?.message || 'Failed to load structures catalog' };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the current queue of structures being built or upgraded\r\n   */\r\n  static async getQueue(empireId: string, locationCoord?: string) {\r\n    let query = supabase\r\n      .from(DB_TABLES.BUILDINGS)\r\n      .select('catalog_key, level, is_active, pending_upgrade, construction_started, construction_completed')\r\n      .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\r\n      .eq(DB_FIELDS.BUILDINGS.IS_ACTIVE, false)\r\n      .gt(DB_FIELDS.BUILDINGS.CONSTRUCTION_COMPLETED, new Date().toISOString());\r\n\r\n    if (locationCoord) {\r\n      query = query.eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, locationCoord);\r\n    }\r\n\r\n    const { data, error } = await query;\r\n    \r\n    if (error) {\r\n      throw new Error('Failed to fetch structure queue');\r\n    }\r\n\r\n    return data.map(b => ({\r\n      catalogKey: b.catalog_key,\r\n      level: b.level,\r\n      isActive: b.is_active,\r\n      pendingUpgrade: b.pending_upgrade,\r\n      constructionStarted: b.construction_started ? new Date(b.construction_started) : null,\r\n      constructionCompleted: b.construction_completed ? new Date(b.construction_completed) : null\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Cancel structure construction at a base\r\n   */\r\n  static async cancel(empireId: string, locationCoord: string) {\r\n    // Verify base has an active construction\r\n    const now = new Date();\r\n    const { data: active } = await supabase\r\n      .from(DB_TABLES.BUILDINGS)\r\n      .select('id, catalog_key, level, credits_cost, construction_completed, pending_upgrade')\r\n      .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\r\n      .eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, locationCoord)\r\n      .eq(DB_FIELDS.BUILDINGS.IS_ACTIVE, false)\r\n      .gt(DB_FIELDS.BUILDINGS.CONSTRUCTION_COMPLETED, now.toISOString());\r\n\r\n    if (!active?.length) {\r\n      return {\r\n        success: false,\r\n        code: 'NO_ACTIVE_CONSTRUCTION',\r\n        error: 'No active construction to cancel'\r\n      };\r\n    }\r\n\r\n    // Get item to cancel (earliest completion)\r\n    const item = active.reduce((earliest, current) => {\r\n      const eCompletes = earliest.construction_completed ? new Date(earliest.construction_completed).getTime() : Infinity;\r\n      const cCompletes = current.construction_completed ? new Date(current.construction_completed).getTime() : Infinity;\r\n      return cCompletes < eCompletes ? current : earliest;\r\n    });\r\n\r\n    // Refund credits\r\n    let refundedCredits = 0;\r\n    if (item.credits_cost) {\r\n      refundedCredits = item.credits_cost;\r\n      await supabase\r\n        .from(DB_TABLES.EMPIRES)\r\n        .select(DB_FIELDS.EMPIRES.CREDITS)\r\n        .eq(DB_FIELDS.BUILDINGS.ID, empireId)\r\n        .single()\r\n        .then(({ data }) => {\r\n          if (data) {\r\n            const currentCredits = Number(data.credits || 0);\r\n            return supabase\r\n              .from(DB_TABLES.EMPIRES)\r\n              .update({ credits: currentCredits + refundedCredits })\r\n              .eq(DB_FIELDS.BUILDINGS.ID, empireId);\r\n          }\r\n        });\r\n    }\r\n\r\n    // If upgrading, reactivate the building\r\n    if (item.pending_upgrade) {\r\n      await supabase\r\n        .from(DB_TABLES.BUILDINGS)\r\n        .update({\r\n          is_active: true,\r\n          pending_upgrade: false,\r\n          construction_started: null,\r\n          construction_completed: null,\r\n          credits_cost: null\r\n        })\r\n        .eq(DB_FIELDS.BUILDINGS.ID, item.id);\r\n    } else {\r\n      // Otherwise delete the in-progress building\r\n      await supabase\r\n        .from(DB_TABLES.BUILDINGS)\r\n        .delete()\r\n        .eq(DB_FIELDS.BUILDINGS.ID, item.id);\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      data: { cancelledId: item.id, refundedCredits },\r\n      message: 'Construction cancelled'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Start construction of a new structure or upgrade\r\n   */\r\n  static async startConstruction(\r\n    userId: string,\r\n    empireId: string,\r\n    locationCoord: string,\r\n    catalogKey: BuildingKey,\r\n  ) {\r\n    // Ownership check: location owner must be user\r\n    const { data: location } = await supabase\r\n      .from(DB_TABLES.LOCATIONS)\r\n      .select('owner_id, result')\r\n      .eq('coord', locationCoord)\r\n      .maybeSingle();\r\n\r\n    if (!location) {\r\n      return { success: false, error: ERROR_MESSAGES.LOCATION_NOT_FOUND };\r\n    }\r\n    if (String(location.owner_id || '') !== String(userId)) {\r\n      return { success: false, error: 'You do not own this location' };\r\n    }\r\n\r\n    // Reject if construction already in progress\r\n    const now = Date.now();\r\n    const { data: inProgress } = await supabase\r\n      .from(DB_TABLES.BUILDINGS)\r\n      .select(DB_FIELDS.BUILDINGS.ID)\r\n      .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\r\n      .eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, locationCoord)\r\n      .eq(DB_FIELDS.BUILDINGS.IS_ACTIVE, false)\r\n      .gt(DB_FIELDS.BUILDINGS.CONSTRUCTION_COMPLETED, new Date(now).toISOString());\r\n\r\n    if ((inProgress || []).length > 0) {\r\n      return {\r\n        success: false,\r\n        code: 'ALREADY_IN_PROGRESS',\r\n        error: 'Construction already underway at this base'\r\n      };\r\n    }\r\n\r\n    // Prevent duplicate key queued\r\n    const { data: duplicates } = await supabase\r\n      .from(DB_TABLES.BUILDINGS)\r\n      .select(DB_FIELDS.BUILDINGS.ID)\r\n      .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\r\n      .eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, locationCoord)\r\n      .eq(DB_FIELDS.BUILDINGS.CATALOG_KEY, catalogKey)\r\n      .eq(DB_FIELDS.BUILDINGS.IS_ACTIVE, false)\r\n      .limit(1);\r\n\r\n    if ((duplicates || []).length > 0) {\r\n      return {\r\n        success: false,\r\n        code: 'ALREADY_IN_PROGRESS',\r\n        error: 'Construction for this structure is already queued or upgrading at this base'\r\n      };\r\n    }\r\n\r\n    // Get capacity\r\n    const caps = await CapacityService.getBaseCapacities(empireId, locationCoord);\r\n    const constructionPerHour = Math.max(0, Number((caps as any)?.construction?.value || 0));\r\n    if (!(constructionPerHour > 0)) {\r\n      return {\r\n        success: false,\r\n        code: 'NO_CAPACITY',\r\n        error: 'This base has no construction capacity'\r\n      };\r\n    }\r\n\r\n    // Determine current level\r\n    const { data: existingActive } = await supabase\r\n      .from(DB_TABLES.BUILDINGS)\r\n      .select('id, level')\r\n      .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\r\n      .eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, locationCoord)\r\n      .eq(DB_FIELDS.BUILDINGS.CATALOG_KEY, catalogKey)\r\n      .eq(DB_FIELDS.BUILDINGS.IS_ACTIVE, true)\r\n      .maybeSingle();\r\n\r\n    const currentLevel = existingActive ? Math.max(1, Number(existingActive.level || 1)) : 0;\r\n    const nextLevel = currentLevel + 1;\r\n\r\n    // Calculate cost\r\n    let cost: number | null = null;\r\n    try {\r\n      cost = getStructureCreditCostForLevel(catalogKey, nextLevel);\r\n    } catch {\r\n      const spec = getBuildingSpec(catalogKey);\r\n      cost = currentLevel === 0 ? spec.creditsCost : null;\r\n    }\r\n    if (typeof cost !== 'number') {\r\n      return {\r\n        success: false,\r\n        code: 'NO_COST_DEFINED',\r\n        error: 'No cost defined for this level'\r\n      };\r\n    }\r\n\r\n    // Validate credits\r\n    const { data: empire } = await supabase\r\n      .from(DB_TABLES.EMPIRES)\r\n      .select(DB_FIELDS.EMPIRES.CREDITS)\r\n      .eq(DB_FIELDS.BUILDINGS.ID, empireId)\r\n      .maybeSingle();\r\n\r\n    const availableCredits = Math.max(0, Number(empire?.credits || 0));\r\n    if (availableCredits < cost) {\r\n      return {\r\n        success: false,\r\n        code: 'INSUFFICIENT_RESOURCES',\r\n        error: `Insufficient credits. Requires ${cost}, you have ${availableCredits}.`,\r\n        details: {\r\n          requiredCredits: cost,\r\n          availableCredits,\r\n          shortfall: cost - availableCredits\r\n        }\r\n      };\r\n    }\r\n\r\n    // Energy validation\r\n    const spec = getBuildingSpec(catalogKey);\r\n    const energyDelta = Number(spec?.energyDelta || 0);\r\n    if (energyDelta < 0) {\r\n      // Get current active buildings\r\n      const { data: activeBuildings } = await supabase\r\n        .from(DB_TABLES.BUILDINGS)\r\n        .select('catalog_key, level, is_active, pending_upgrade, construction_completed')\r\n        .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\r\n        .eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, locationCoord);\r\n\r\n      const activeStructures = [];\r\n      for (const b of activeBuildings || []) {\r\n        const isActive = b.is_active === true;\r\n        const pending = b.pending_upgrade === true;\r\n        const completes = b.construction_completed ? new Date(b.construction_completed).getTime() : 0;\r\n        const effective = isActive || pending || (completes && completes <= now);\r\n        const level = Math.max(0, Number(b.level || 0));\r\n        const key = String(b.catalog_key || '');\r\n        if (effective && key && level > 0) {\r\n          activeStructures.push({ key, level, isActive: true });\r\n        }\r\n      }\r\n\r\n      const solar = Math.max(0, Number(location.result?.solarEnergy ?? 0));\r\n      const gas = Math.max(0, Number(location.result?.yields?.gas ?? 0));\r\n      const { produced, consumed, balance } = computeEnergyBalance({\r\n        buildingsAtBase: activeStructures,\r\n        location: { solarEnergy: solar, gasYield: gas },\r\n        includeQueuedReservations: false\r\n      });\r\n\r\n      const projected = balance + energyDelta;\r\n      if (projected < 0) {\r\n        return {\r\n          success: false,\r\n          code: 'INSUFFICIENT_ENERGY',\r\n          error: 'Insufficient energy capacity to start this construction.',\r\n          details: { produced, consumed, balance, energyDelta, projectedEnergy: projected }\r\n        };\r\n      }\r\n    }\r\n\r\n    // Area and population validation\r\n    const stats = await StatsService.getBaseStats(empireId, locationCoord);\r\n    const areaRequired = Math.max(0, Number(spec?.areaRequired ?? 1));\r\n    if (areaRequired > 0 && stats.area.free < areaRequired) {\r\n      return {\r\n        success: false,\r\n        code: 'INSUFFICIENT_AREA',\r\n        error: 'Insufficient area capacity to start this construction.',\r\n        details: {\r\n          required: areaRequired,\r\n          available: stats.area.free,\r\n          used: stats.area.used,\r\n          total: stats.area.total\r\n        }\r\n      };\r\n    }\r\n\r\n    const populationRequired = Math.max(0, Number(spec?.populationRequired || 0));\r\n    if (populationRequired > 0 && stats.population.free < populationRequired) {\r\n      return {\r\n        success: false,\r\n        code: 'INSUFFICIENT_POPULATION',\r\n        error: 'Insufficient population capacity to start this construction.',\r\n        details: {\r\n          required: populationRequired,\r\n          available: stats.population.free,\r\n          used: stats.population.used,\r\n          capacity: stats.population.capacity\r\n        }\r\n      };\r\n    }\r\n\r\n    // Calculate completion time\r\n    const hours = cost / constructionPerHour;\r\n    const startedAt = new Date(now).toISOString();\r\n    const completesAt = new Date(now + Math.max(1, Math.ceil(hours * 3600)) * 1000).toISOString();\r\n\r\n    try {\r\n      // Start transaction\r\n      if (!existingActive) {\r\n        // Insert new structure\r\n        await supabase\r\n          .from(DB_TABLES.BUILDINGS)\r\n          .insert({\r\n            empire_id: empireId,\r\n            location_coord: locationCoord,\r\n            catalog_key: catalogKey,\r\n            type: catalogKey,\r\n            display_name: spec.name,\r\n            level: 1,\r\n            is_active: false,\r\n            pending_upgrade: false,\r\n            credits_cost: cost,\r\n            construction_started: startedAt,\r\n            construction_completed: completesAt,\r\n          });\r\n      } else {\r\n        // Upgrade existing\r\n        await supabase\r\n          .from(DB_TABLES.BUILDINGS)\r\n          .update({\r\n            is_active: false,\r\n            pending_upgrade: true,\r\n            credits_cost: cost,\r\n            construction_started: startedAt,\r\n            construction_completed: completesAt,\r\n          })\r\n          .eq(DB_FIELDS.BUILDINGS.ID, existingActive.id);\r\n      }\r\n\r\n      // Deduct credits\r\n      await supabase\r\n        .from(DB_TABLES.EMPIRES)\r\n        .update({ credits: availableCredits - cost })\r\n        .eq(DB_FIELDS.BUILDINGS.ID, empireId);\r\n\r\n      return {\r\n        success: true,\r\n        data: {\r\n          coord: locationCoord,\r\n          key: catalogKey,\r\n          completesAt\r\n        },\r\n        message: 'Construction started'\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('[StructureService] Failed to start construction:', error);\r\n      return {\r\n        success: false,\r\n        code: 'DB_ERROR',\r\n        error: 'Failed to start construction'\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get structure details for a base\r\n   */\r\n  static async getStructureDetails(empireId: string, locationCoord: string) {\r\n    const caps = await CapacityService.getBaseCapacities(empireId, locationCoord);\r\n    const constructionPerHour = Math.max(0, Number((caps as any)?.construction?.value || 0));\r\n\r\n    // Get all buildings at base\r\n    const { data: buildings } = await supabase\r\n      .from(DB_TABLES.BUILDINGS)\r\n      .select('catalog_key, level, is_active, pending_upgrade, construction_started, construction_completed, credits_cost')\r\n      .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\r\n      .eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, locationCoord);\r\n\r\n    if (!buildings) {\r\n      return {\r\n        constructionPerHour: 0,\r\n        activeConstruction: null,\r\n        levelByKey: {}\r\n      };\r\n    }\r\n\r\n    // Process current levels\r\n    const nowTs = Date.now();\r\n    const levelByKey = new Map<string, number>();\r\n    \r\n    for (const b of buildings) {\r\n      const key = String(b.catalog_key || '');\r\n      if (!key) continue;\r\n\r\n      const level = Math.max(0, Number(b.level || 0));\r\n      const isActive = b.is_active === true;\r\n      const pendingUpgrade = b.pending_upgrade === true;\r\n      const completes = b.construction_completed ? new Date(b.construction_completed).getTime() : 0;\r\n      const effectiveActive = isActive || pendingUpgrade || (completes && completes <= nowTs);\r\n      \r\n      if (effectiveActive) {\r\n        levelByKey.set(key, (levelByKey.get(key) || 0) + level);\r\n      }\r\n    }\r\n\r\n    // Find active construction\r\n    let activeConstruction = null;\r\n    let earliest = Number.POSITIVE_INFINITY;\r\n\r\n    for (const b of buildings) {\r\n      const completes = b.construction_completed ? new Date(b.construction_completed).getTime() : 0;\r\n      const starts = b.construction_started ? new Date(b.construction_started).getTime() : 0;\r\n      if (!b.catalog_key || !completes || !starts || completes <= nowTs) continue;\r\n      \r\n      const isActive = b.is_active === true;\r\n      const pendingUpgrade = b.pending_upgrade === true;\r\n      if (isActive || pendingUpgrade) continue;\r\n\r\n      if (completes < earliest) {\r\n        earliest = completes;\r\n        activeConstruction = {\r\n          key: b.catalog_key as BuildingKey,\r\n          completionAt: new Date(completes).toISOString(),\r\n          startedAt: new Date(starts).toISOString(),\r\n          currentLevel: Math.max(0, Number(b.level || 0)),\r\n          targetLevel: Math.max(1, Number(b.level || 0)),\r\n          creditsCost: Number(b.credits_cost || 0),\r\n          pendingUpgrade: false\r\n        };\r\n      }\r\n    }\r\n\r\n    return {\r\n      constructionPerHour,\r\n      activeConstruction,\r\n      levelByKey: Object.fromEntries(levelByKey)\r\n    };\r\n  }\r\n}\r\n\r\n\r\n"],"version":3}