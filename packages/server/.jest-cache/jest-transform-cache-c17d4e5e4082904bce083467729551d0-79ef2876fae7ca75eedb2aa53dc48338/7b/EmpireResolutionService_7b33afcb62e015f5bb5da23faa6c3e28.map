{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\services\\EmpireResolutionService.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\services\\EmpireResolutionService.ts"],"sourcesContent":["import { supabase } from '../config/supabase';\n\n// Constants imports for eliminating hardcoded values\nimport { DB_TABLES, DB_FIELDS } from '../constants/database-fields';\n\nimport { GAME_CONSTANTS } from '@game/shared';\n/**\n * EmpireResolutionService - Handles empire lookup and auto-bootstrap logic\n * Eliminates code duplication by providing centralized empire resolution methods\n */\nexport class EmpireResolutionService {\n  /**\n   * Resolve empire by user ID with fallback to users.empire_id\n   * @param userId - The user ID to resolve empire for\n   * @returns Promise<Empire | null>\n   */\n  static async resolveEmpireByUserId(userId: string): Promise<any | null> {\n    // Try to fetch empire by user_id first\n    let { data: empireRow } = await supabase\n      .from(DB_TABLES.EMPIRES)\n      .select('*')\n      .eq(DB_FIELDS.EMPIRES.USER_ID, userId)\n      .maybeSingle();\n\n    // Fallback: if user has an explicit empire_id, read by id\n    if (!empireRow) {\n      const { data: userRow } = await supabase\n        .from(DB_TABLES.USERS)\n        .select(DB_FIELDS.BUILDINGS.EMPIRE_ID)\n        .eq(DB_FIELDS.BUILDINGS.ID, userId)\n        .maybeSingle();\n\n      if (userRow?.empire_id) {\n        const byId = await supabase\n          .from(DB_TABLES.EMPIRES)\n          .select('*')\n          .eq(DB_FIELDS.BUILDINGS.ID, userRow.empire_id)\n          .maybeSingle();\n        empireRow = byId.data as any;\n      }\n    }\n\n    return empireRow;\n  }\n\n  /**\n   * Resolve empire by user object with fallback logic\n   * @param user - User object containing id or _id field\n   * @returns Promise<Empire | null>\n   */\n  static async resolveEmpireByUserObject(user: any): Promise<any | null> {\n    const userId = user?._id || user?.id;\n    return this.resolveEmpireByUserId(userId);\n  }\n\n  /**\n   * Auto-bootstrap empire for new users\n   * Creates empire, colony, and starter building if no empire exists\n   * @param userId - The user ID to bootstrap empire for\n   * @returns Promise<Empire>\n   */\n  static async autoBootstrapEmpire(userId: string): Promise<any> {\n    // Pick an unowned planet\n    const pick = await supabase\n      .from(DB_TABLES.LOCATIONS)\n      .select('coord')\n      .eq(DB_FIELDS.CREDIT_TRANSACTIONS.TYPE, 'planet')\n      .is(DB_FIELDS.LOCATIONS.OWNER_ID, null)\n      .limit(1)\n      .single();\n\n    if (!pick.data?.coord) {\n      throw new Error('No available starter planets');\n    }\n\n    const coord = pick.data.coord as string;\n\n    // Claim the planet\n    await supabase\n      .from(DB_TABLES.LOCATIONS)\n      .update({ owner_id: userId })\n      .eq('coord', coord)\n      .is(DB_FIELDS.LOCATIONS.OWNER_ID, null);\n\n    // Get user info for empire name\n    const { data: userRow } = await supabase\n      .from(DB_TABLES.USERS)\n      .select('username, email')\n      .eq(DB_FIELDS.BUILDINGS.ID, userId)\n      .single();\n\n    // Create empire\n    const displayName = (userRow?.username || userRow?.email?.split?.('@')?.[0] || 'Commander') as string;\n    const insertEmpire = await supabase\n      .from(DB_TABLES.EMPIRES)\n      .insert({\n        user_id: userId,\n        name: `${displayName}`,\n        home_system: coord,\n        territories: [coord],\n        credits: GAME_CONSTANTS.STARTING_CREDITS,\n        energy: 0,\n      })\n      .select('*')\n      .single();\n\n    if (!insertEmpire.data) {\n      throw new Error('Failed to create empire');\n    }\n\n    const empireRow = insertEmpire.data as any;\n\n    // Create colony and starter building (best-effort)\n    await supabase\n      .from(DB_TABLES.COLONIES)\n      .insert({ empire_id: empireRow.id, location_coord: coord, name: 'Home Base' });\n\n    await supabase\n      .from(DB_TABLES.BUILDINGS)\n      .insert({\n        empire_id: empireRow.id,\n        location_coord: coord,\n        catalog_key: 'urban_structures',\n        level: 1,\n        is_active: true,\n        construction_completed: new Date().toISOString(),\n        credits_cost: 0,\n      });\n\n    // Update user linkage\n    await supabase\n      .from(DB_TABLES.USERS)\n      .update({ empire_id: empireRow.id, starting_coordinate: coord })\n      .eq(DB_FIELDS.BUILDINGS.ID, userId);\n\n    return empireRow;\n  }\n}"],"version":3}