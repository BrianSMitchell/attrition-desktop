{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\services\\tech\\TechService.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\services\\tech\\TechService.ts"],"sourcesContent":["import { supabase } from '../../config/supabase';\r\nimport { CapacityService } from '../bases/CapacityService';\r\nimport { ERROR_MESSAGES } from '../../constants/response-formats';\r\nimport { DB_TABLES, DB_FIELDS } from '../../constants/database-fields';\r\nimport { getTechnologyList, getTechSpec, canStartTechLevel, getTechCreditCostForLevel, TechnologyKey } from '@game/shared';\r\nexport class TechService {\r\n  static async getTechLevels(empireId: string): Promise<Record<string, number>> {\r\n    const { data } = await supabase\r\n      .from(DB_TABLES.TECH_LEVELS)\r\n      .select('tech_key, level')\r\n      .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId);\r\n    const out: Record<string, number> = {};\r\n    for (const row of data || []) {\r\n      const key = String((row as any).tech_key || '');\r\n      const level = Math.max(0, Number((row as any).level || 0));\r\n      if (key) out[key] = level;\r\n    }\r\n    return out;\r\n  }\r\n\r\n  static async getBaseLabTotal(empireId: string, coord: string): Promise<number> {\r\n    // Sum levels of research_labs where active/effective\r\n    const bRes = await supabase\r\n      .from(DB_TABLES.BUILDINGS)\r\n      .select('level, is_active, pending_upgrade, construction_completed, catalog_key')\r\n      .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\r\n      .eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, coord)\r\n      .eq(DB_FIELDS.BUILDINGS.CATALOG_KEY, 'research_labs');\r\n    const now = Date.now();\r\n    let total = 0;\r\n    for (const b of bRes.data || []) {\r\n      const lvl = Math.max(0, Number((b as any).level || 0));\r\n      const isActive = (b as any).is_active === true;\r\n      const pending = (b as any).pending_upgrade === true;\r\n      const completes = (b as any).construction_completed ? new Date((b as any).construction_completed).getTime() : 0;\r\n      const effective = isActive || pending || (completes && completes <= now);\r\n      if (effective) total += lvl;\r\n    }\r\n    return total;\r\n  }\r\n\r\n  static async getStatus(userId: string, empireId: string, baseCoord: string) {\r\n    // credits\r\n    const eRes = await supabase.from(DB_TABLES.EMPIRES).select(DB_FIELDS.EMPIRES.CREDITS).eq(DB_FIELDS.BUILDINGS.ID, empireId).maybeSingle();\r\n    const credits = Math.max(0, Number((eRes.data as any)?.credits || 0));\r\n\r\n    const [techLevels, baseLabTotal] = await Promise.all([\r\n      this.getTechLevels(empireId),\r\n      this.getBaseLabTotal(empireId, baseCoord),\r\n    ]);\r\n\r\n    const eligibility: Record<string, { canStart: boolean; reasons: string[] }> = {} as any;\r\n    const list = getTechnologyList();\r\n    for (const spec of list) {\r\n      const current = Math.max(0, techLevels[spec.key] ?? 0);\r\n      const desired = current + 1;\r\n      eligibility[spec.key] = canStartTechLevel({ techLevels, baseLabTotal, credits }, spec, desired);\r\n    }\r\n\r\n    return { techLevels, baseLabTotal, eligibility, credits };\r\n  }\r\n\r\n  static async getQueue(empireId: string, baseCoord?: string) {\r\n    let q = supabase\r\n      .from(DB_TABLES.TECH_QUEUE)\r\n      .select('id, tech_key, level, started_at, completes_at, status, location_coord')\r\n      .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\r\n      .eq(DB_FIELDS.TECH_QUEUE.STATUS, 'pending')\r\n      .order(DB_FIELDS.TECH_QUEUE.COMPLETES_AT, { ascending: true });\r\n    if (baseCoord) {\r\n      q = q.eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, baseCoord);\r\n    }\r\n    const { data } = await q;\r\n    return data || [];\r\n  }\r\n\r\n  static async start(userId: string, empireId: string, baseCoord: string, techKey: TechnologyKey) {\r\n    console.log('[SupabaseTechService.start]', { userId, empireId, baseCoord, techKey });\r\n    \r\n    // Ownership\r\n    const loc = await supabase.from(DB_TABLES.LOCATIONS).select(DB_FIELDS.LOCATIONS.OWNER_ID).eq('coord', baseCoord).maybeSingle();\r\n    console.log('[SupabaseTechService.start] Location check:', { found: !!loc.data, ownerId: loc.data?.owner_id });\r\n    \r\n    if (!loc.data) {\r\n      console.log('[SupabaseTechService.start] Location not found');\r\n      return { success: false as const, code: ERROR_MESSAGES.NOT_FOUND, message: ERROR_MESSAGES.LOCATION_NOT_FOUND };\r\n    }\r\n    if (String(loc.data.owner_id || '') !== String(userId)) {\r\n      console.log('[SupabaseTechService.start] Not owner:', { expected: userId, actual: loc.data.owner_id });\r\n      return { success: false as const, code: 'NOT_OWNER', message: 'You do not own this location' };\r\n    }\r\n\r\n    // State\r\n    const spec = getTechSpec(techKey);\r\n    console.log('[SupabaseTechService.start] Tech spec:', spec);\r\n    \r\n    const techLevels = await this.getTechLevels(empireId);\r\n    console.log('[SupabaseTechService.start] Tech levels:', techLevels);\r\n    \r\n    const currentLevel = Math.max(0, techLevels[techKey] ?? 0);\r\n    const desiredLevel = currentLevel + 1;\r\n    console.log('[SupabaseTechService.start] Current/Desired level:', { currentLevel, desiredLevel });\r\n    \r\n    const eRes = await supabase.from(DB_TABLES.EMPIRES).select(DB_FIELDS.EMPIRES.CREDITS).eq(DB_FIELDS.BUILDINGS.ID, empireId).maybeSingle();\r\n    const credits = Math.max(0, Number((eRes.data as any)?.credits || 0));\r\n    console.log('[SupabaseTechService.start] Credits:', credits);\r\n    \r\n    const baseLabTotal = await this.getBaseLabTotal(empireId, baseCoord);\r\n    console.log('[SupabaseTechService.start] Base lab total:', baseLabTotal);\r\n\r\n    // Check eligibility\r\n    const check = canStartTechLevel({ techLevels, baseLabTotal, credits }, spec, desiredLevel);\r\n    console.log('[SupabaseTechService.start] Eligibility check:', check);\r\n    \r\n    if (!check.canStart) {\r\n      console.log('[SupabaseTechService.start] Requirements not met:', check.reasons);\r\n      return { success: false as const, code: 'TECH_REQUIREMENTS', message: check.reasons.join(' ') };\r\n    }\r\n\r\n    // Capacity & cost\r\n    console.log('[SupabaseTechService.start] Getting capacities...');\r\n    let caps;\r\n    try {\r\n      caps = await CapacityService.getBaseCapacities(empireId, baseCoord);\r\n      console.log('[SupabaseTechService.start] Capacities:', caps);\r\n    } catch (error) {\r\n      console.error('[SupabaseTechService.start] Error getting capacities:', error);\r\n      return { success: false as const, code: 'CAPACITY_ERROR', message: `Failed to get capacity: ${error}` };\r\n    }\r\n    \r\n    const perHour = Math.max(0, Number((caps as any)?.research?.value || 0));\r\n    console.log('[SupabaseTechService.start] Research capacity per hour:', perHour);\r\n    \r\n    if (!(perHour > 0)) {\r\n      console.log('[SupabaseTechService.start] No research capacity');\r\n      return { success: false as const, code: 'NO_CAPACITY', message: 'Research capacity is zero at this base.' };\r\n    }\r\n\r\n    const cost = getTechCreditCostForLevel(spec, desiredLevel);\r\n    const nowIso = new Date().toISOString();\r\n    \r\n    // Generate identity key for idempotency (prevent duplicate queue entries)\r\n    const identityKey = `${empireId}:${baseCoord}:${techKey}:${desiredLevel}:${Date.now()}`;\r\n    console.log('[SupabaseTechService.start] Generated identity key:', identityKey);\r\n\r\n    if (credits < cost) {\r\n      // Queue uncharged\r\n      console.log('[SupabaseTechService.start] Insufficient credits, queuing research without charge');\r\n      const insertRes = await supabase\r\n        .from(DB_TABLES.TECH_QUEUE)\r\n        .insert({\r\n          empire_id: empireId,\r\n          location_coord: baseCoord,\r\n          tech_key: techKey,\r\n          level: desiredLevel,\r\n          identity_key: identityKey,\r\n          started_at: nowIso,\r\n          status: 'pending',\r\n        });\r\n      \r\n      if (insertRes.error) {\r\n        console.error('[SupabaseTechService.start] Failed to insert tech_queue entry (uncharged):', insertRes.error);\r\n        return { success: false as const, code: 'DB_ERROR', message: `Failed to queue research: ${insertRes.error.message}` };\r\n      }\r\n      console.log('[SupabaseTechService.start] Successfully queued research (uncharged)');\r\n      \r\n      return {\r\n        success: true as const,\r\n        data: { techKey, etaMinutes: null, researchCapacityCredPerHour: perHour },\r\n        message: `${spec.name} queued. Will start automatically when sufficient credits are available.`,\r\n      };\r\n    }\r\n\r\n    const hours = cost / perHour;\r\n    const etaMinutes = Math.max(1, Math.ceil(hours * 60));\r\n    const completesAt = new Date(Date.now() + etaMinutes * 60000).toISOString();\r\n\r\n    // Insert queue charged and deduct credits\r\n    console.log('[SupabaseTechService.start] Inserting tech_queue entry with ETA:', { completesAt, etaMinutes });\r\n    const insertRes = await supabase\r\n      .from(DB_TABLES.TECH_QUEUE)\r\n      .insert({\r\n        empire_id: empireId,\r\n        location_coord: baseCoord,\r\n        tech_key: techKey,\r\n        level: desiredLevel,\r\n        identity_key: identityKey,\r\n        started_at: nowIso,\r\n        completes_at: completesAt,\r\n        status: 'pending',\r\n      });\r\n\r\n    if (insertRes.error) {\r\n      console.error('[SupabaseTechService.start] Failed to insert tech_queue entry:', insertRes.error);\r\n      return { success: false as const, code: 'DB_ERROR', message: `Failed to start research: ${insertRes.error.message}` };\r\n    }\r\n    console.log('[SupabaseTechService.start] Successfully inserted tech_queue entry');\r\n\r\n    console.log('[SupabaseTechService.start] Deducting credits:', { cost, newBalance: credits - cost });\r\n    const updateRes = await supabase.from(DB_TABLES.EMPIRES).update({ credits: credits - cost }).eq(DB_FIELDS.BUILDINGS.ID, empireId);\r\n    if (updateRes.error) {\r\n      console.error('[SupabaseTechService.start] Failed to deduct credits:', updateRes.error);\r\n      // Research was queued but credits not deducted - this is recoverable as the credit deduction\r\n      // will happen when research completes. Log but continue.\r\n    } else {\r\n    // Log credit transaction (best effort)\r\n    try {\r\n      const { CreditLedgerService } = await import('../../constants/response-formats');\r\n      await CreditLedgerService.logTransaction({\r\n        empireId,\r\n        amount: -cost,\r\n        type: 'research',\r\n        note: `Research started: ${spec.name} level ${desiredLevel} at ${baseCoord}`,\r\n        meta: { coord: baseCoord, techKey, level: desiredLevel },\r\n        balanceAfter: credits - cost,\r\n      });\r\n    } catch (logErr) {\r\n      console.warn('[SupabaseTechService] Failed to log credit transaction:', logErr);\r\n    }\r\n    }\r\n\r\n    return {\r\n      success: true as const,\r\n      data: { techKey, completesAt, etaMinutes, researchCapacityCredPerHour: perHour },\r\n      message: `${spec.name} research started. ETA ${etaMinutes} minute(s).`,\r\n    };\r\n  }\r\n\r\n  static async getRefundCredits(spec: any, level: number): Promise<number> {\r\n    // Calculate refund amount for cancelled research\r\n    // Typically would be a percentage of the full cost\r\n    const fullCost = getTechCreditCostForLevel(spec, level);\r\n    // Return 80% refund for cancelled research\r\n    return Math.floor(fullCost * 0.8);\r\n  }\r\n}\r\n"],"version":3}