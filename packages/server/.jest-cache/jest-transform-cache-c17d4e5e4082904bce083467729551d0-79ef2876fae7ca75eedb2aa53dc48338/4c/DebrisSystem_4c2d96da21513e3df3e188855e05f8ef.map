{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\systems\\DebrisSystem.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\systems\\DebrisSystem.ts"],"sourcesContent":["import { Empire, Location, randomInt } from '@game/shared';\r\n\r\nexport class DebrisSystem {\r\n  private static readonly DEBRIS_TICK_INTERVAL = 1000; // 1 second tick\r\n  private static readonly MIN_GENERATION_RATE = 1;\r\n  private static readonly MAX_GENERATION_RATE = 10;\r\n  private static readonly COLLECTION_RATE = 10; // debris per second per recycler\r\n  private static readonly CREDITS_PER_DEBRIS = 1;\r\n\r\n  private tickInterval: NodeJS.Timeout | null = null;\r\n\r\n  constructor(\r\n    private locations: Map<string, Location>,\r\n    private empires: Map<string, Empire>\r\n  ) {\r\n    this.startDebrisGeneration();\r\n  }\r\n\r\n  /**\r\n   * Start the debris generation system\r\n   */\r\n  private startDebrisGeneration(): void {\r\n    if (this.tickInterval) {\r\n      clearInterval(this.tickInterval);\r\n    }\r\n\r\n    this.tickInterval = setInterval(() => {\r\n      this.processTick();\r\n    }, DebrisSystem.DEBRIS_TICK_INTERVAL);\r\n  }\r\n\r\n  /**\r\n   * Stop the debris generation system\r\n   */\r\n  public stop(): void {\r\n    if (this.tickInterval) {\r\n      clearInterval(this.tickInterval);\r\n      this.tickInterval = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Process a single tick for all asteroids\r\n   */\r\n  private processTick(): void {\r\n    for (const [coord, location] of this.locations.entries()) {\r\n      if (location.type === 'asteroid') {\r\n        this.processAsteroidTick(coord, location);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Process a single tick for one asteroid\r\n   */\r\n  private processAsteroidTick(coord: string, location: Location): void {\r\n    // Initialize debris object if it doesn't exist\r\n    if (!location.debris) {\r\n      location.debris = {\r\n        amount: 0,\r\n        generationRate: this.generateRandomRate(),\r\n        recyclers: []\r\n      };\r\n    }\r\n\r\n    // Generate debris\r\n    location.debris.amount += location.debris.generationRate;\r\n\r\n    // Process recyclers\r\n    if (location.debris.recyclers.length > 0) {\r\n      this.processRecyclers(coord, location);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Process recyclers at an asteroid\r\n   */\r\n  private processRecyclers(coord: string, location: Location): void {\r\n    if (!location.debris) return;\r\n\r\n    // Calculate total debris to collect this tick\r\n    const totalToCollect = Math.min(\r\n      location.debris.amount,\r\n      location.debris.recyclers.length * DebrisSystem.COLLECTION_RATE\r\n    );\r\n\r\n    if (totalToCollect <= 0) return;\r\n\r\n    // Distribute debris evenly among recyclers\r\n    const perRecycler = Math.floor(totalToCollect / location.debris.recyclers.length);\r\n    const remainder = totalToCollect % location.debris.recyclers.length;\r\n\r\n    // Process each recycler\r\n    location.debris.recyclers.forEach((recycler, index) => {\r\n      const empire = this.empires.get(recycler.empireId);\r\n      if (!empire) return;\r\n\r\n      // Calculate debris for this recycler (including remainder distribution)\r\n      let debrisForRecycler = perRecycler;\r\n      if (index < remainder) {\r\n        debrisForRecycler++;\r\n      }\r\n\r\n      // Convert debris to credits\r\n      const credits = debrisForRecycler * DebrisSystem.CREDITS_PER_DEBRIS;\r\n      empire.resources.credits += credits;\r\n    });\r\n\r\n    // Remove collected debris\r\n    location.debris.amount -= totalToCollect;\r\n  }\r\n\r\n  /**\r\n   * Add a recycler to an asteroid\r\n   */\r\n  public addRecycler(coord: string, empireId: string): boolean {\r\n    const location = this.locations.get(coord);\r\n    if (!location || location.type !== 'asteroid') return false;\r\n\r\n    // Initialize debris object if needed\r\n    if (!location.debris) {\r\n      location.debris = {\r\n        amount: 0,\r\n        generationRate: this.generateRandomRate(),\r\n        recyclers: []\r\n      };\r\n    }\r\n\r\n    // Add recycler if not already present\r\n    if (!location.debris.recyclers.some(r => r.empireId === empireId)) {\r\n      location.debris.recyclers.push({\r\n        empireId,\r\n        startedAt: new Date()\r\n      });\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Remove a recycler from an asteroid\r\n   */\r\n  public removeRecycler(coord: string, empireId: string): boolean {\r\n    const location = this.locations.get(coord);\r\n    if (!location || !location.debris) return false;\r\n\r\n    const initialLength = location.debris.recyclers.length;\r\n    location.debris.recyclers = location.debris.recyclers.filter(r => r.empireId !== empireId);\r\n\r\n    return location.debris.recyclers.length !== initialLength;\r\n  }\r\n\r\n  /**\r\n   * Generate a random debris generation rate\r\n   */\r\n  private generateRandomRate(): number {\r\n    return randomInt(\r\n      DebrisSystem.MIN_GENERATION_RATE,\r\n      DebrisSystem.MAX_GENERATION_RATE\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get current debris amount at a location\r\n   */\r\n  public getDebrisAmount(coord: string): number {\r\n    const location = this.locations.get(coord);\r\n    return location?.debris?.amount ?? 0;\r\n  }\r\n\r\n  /**\r\n   * Get debris generation rate at a location\r\n   */\r\n  public getGenerationRate(coord: string): number {\r\n    const location = this.locations.get(coord);\r\n    return location?.debris?.generationRate ?? 0;\r\n  }\r\n\r\n  /**\r\n   * Get all recyclers at a location\r\n   */\r\n  public getRecyclers(coord: string): { empireId: string; startedAt: Date }[] {\r\n    const location = this.locations.get(coord);\r\n    return location?.debris?.recyclers ?? [];\r\n  }\r\n}"],"version":3}