{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\middleware\\auth.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\middleware\\auth.ts"],"sourcesContent":["import { Request, Response, NextFunction } from 'express';\nimport jwt from 'jsonwebtoken';\nimport { supabase } from '../config/supabase';\nimport { asyncHandler } from './errorHandler';\nimport { DB_TABLES, DB_FIELDS } from '../constants/database-fields';\nimport { HTTP_STATUS } from '../constants/response-formats';\nimport { ENV_VALUES } from '@game/shared';\nimport { ENV_VARS } from '@game/shared';\nimport { \n  DeviceFingerprint,\n  generateDeviceFingerprint,\n  compareDeviceFingerprints,\n  sanitizeFingerprint,\n  isSuspiciousFingerprint\n} from '../utils/deviceFingerprint';\n\nexport interface SupabaseUser {\n  _id: string;\n  id: string;\n  userId: string;\n  email: string;\n  username: string;\n  role: 'user' | 'admin';\n  gameProfile: {\n    startingCoordinate?: string | null;\n    empireId?: string | null;\n  };\n}\n\nexport interface AuthRequest extends Request {\n  user?: SupabaseUser;\n  deviceFingerprint?: DeviceFingerprint;\n}\n\n// Token revocation store (in-memory for now, should be Redis in production)\nconst revokedTokens = new Set<string>();\n\n// JWT secret management\nconst getJWTSecrets = (): string[] => {\n  const current = process.env[ENV_VARS.JWT_SECRET];\n  const previous = process.env[ENV_VARS.JWT_SECRET + '_PREVIOUS']; // For rotation support\n  \n  if (!current) {\n    throw new Error('JWT_SECRET environment variable is required');\n  }\n  \n  // Validate secret strength\n  if (current.length < 32) {\n    console.warn('JWT_SECRET should be at least 32 characters for security');\n  }\n  \n  return [current, previous].filter(Boolean) as string[];\n};\n\n// Enhanced JWT verification with multiple secrets support\nexport const verifyTokenWithSecrets = (token: string): any => {\n  const secrets = getJWTSecrets();\n  \n  for (const secret of secrets) {\n    try {\n      return jwt.verify(token, secret);\n    } catch (error) {\n      // Try next secret\n      continue;\n    }\n  }\n  \n  throw new Error('Token verification failed with all secrets');\n};\n\nexport const revokeToken = (jti: string): void => {\n  revokedTokens.add(jti);\n};\n\nexport const isTokenRevoked = (jti: string): boolean => {\n  return revokedTokens.has(jti);\n};\n\nexport const authenticate = asyncHandler(async (req: AuthRequest, res: Response, next: NextFunction) => {\n  let token: string | undefined;\n\n  // Get token from header\n  if (req.headers.authorization && req.headers.authorization.startsWith('Bearer')) {\n    token = req.headers.authorization.split(' ')[1];\n  }\n\n  if (!token) {\n    return res.status(HTTP_STATUS.UNAUTHORIZED).json({\n      success: false,\n      error: 'Access denied. No token provided.'\n    });\n  }\n\n  try {\n    // Verify token with multiple secrets support\n    const decoded = verifyTokenWithSecrets(token) as { \n      userId: string; \n      type: string; \n      jti?: string; \n      iat?: number;\n      deviceFingerprint?: DeviceFingerprint;\n    };\n    \n    // Check if token is revoked (if jti is present)\n    if (decoded.jti && isTokenRevoked(decoded.jti)) {\n      return res.status(HTTP_STATUS.UNAUTHORIZED).json({\n        success: false,\n        error: 'Token has been revoked'\n      });\n    }\n    \n    // Verify token type\n    if (decoded.type !== 'access') {\n      return res.status(HTTP_STATUS.UNAUTHORIZED).json({\n        success: false,\n        error: 'Invalid token type'\n      });\n    }\n    \n    // Generate current device fingerprint\n    const currentFingerprint = generateDeviceFingerprint(req);\n    \n    // Check device fingerprint binding (if present in token)\n    if (decoded.deviceFingerprint) {\n      const similarity = compareDeviceFingerprints(currentFingerprint, decoded.deviceFingerprint);\n\n      // Configurable threshold (defaults to 0.3 to tolerate IP-network shifts behind CDNs/proxies)\n      const threshold = (() => {\n        const raw = process.env[ENV_VARS.DEVICE_BINDING_THRESHOLD];\n        const n = raw ? Number(raw) : NaN;\n        return Number.isFinite(n) ? n : 0.3;\n      })();\n      \n      // Allow some flexibility but detect major changes\n      if (similarity < threshold) {\n        console.warn(`[SECURITY] Suspicious device fingerprint mismatch for user ${decoded.userId}:`, {\n          similarity,\n          threshold,\n          current: sanitizeFingerprint(currentFingerprint),\n          token: sanitizeFingerprint(decoded.deviceFingerprint)\n        });\n        \n        // In strict mode, reject the token\n        if (process.env[ENV_VARS.DEVICE_BINDING_STRICT] === 'true') {\n          return res.status(HTTP_STATUS.UNAUTHORIZED).json({\n            success: false,\n            error: 'Token device binding verification failed'\n          });\n        }\n      }\n    }\n    \n    // Check for suspicious fingerprint patterns\n    if (decoded.deviceFingerprint && isSuspiciousFingerprint(currentFingerprint, decoded.deviceFingerprint)) {\n      console.warn(`[SECURITY] Suspicious fingerprint detected for user ${decoded.userId}:`, {\n        current: sanitizeFingerprint(currentFingerprint),\n        token: sanitizeFingerprint(decoded.deviceFingerprint)\n      });\n    }\n    \n    // Get user from database\n    const { data, error } = await supabase\n      .from(DB_TABLES.USERS)\n      .select('id, email, username, empire_id, starting_coordinate, role')\n      .eq(DB_FIELDS.BUILDINGS.ID, decoded.userId)\n      .single();\n\n    if (error || !data) {\n      return res.status(HTTP_STATUS.UNAUTHORIZED).json({ success: false, error: 'Token is not valid' });\n    }\n\n    // Map Supabase row to legacy user shape expected downstream\n    const user: SupabaseUser = {\n      _id: data.id,\n      id: data.id,\n      userId: data.id,\n      email: data.email,\n      username: data.username,\n      role: data.role,\n      gameProfile: {\n        startingCoordinate: data.starting_coordinate || null,\n        empireId: data.empire_id || null,\n      },\n    };\n\n    req.user = user as any;\n    req.deviceFingerprint = currentFingerprint;\n    next();\n  } catch (error) {\n    return res.status(HTTP_STATUS.UNAUTHORIZED).json({\n      success: false,\n      error: 'Token is not valid'\n    });\n  }\n});\n\nexport const generateAccessToken = (userId: string, req?: Request): string => {\n  // Use shorter TTL for production, longer for development\n  const expiresIn = process.env[ENV_VARS.NODE_ENV] === ENV_VALUES.PRODUCTION ? '15m' : '1h';\n  \n  // Generate device fingerprint if request is provided\n  let deviceFingerprint: DeviceFingerprint | undefined;\n  if (req && process.env[ENV_VARS.ENABLE_DEVICE_BINDING] !== 'false') {\n    deviceFingerprint = generateDeviceFingerprint(req);\n  }\n  \n  const payload: any = {\n    userId, \n    type: 'access',\n    jti: crypto.randomUUID(), // Add JWT ID for revocation tracking\n    iat: Math.floor(Date.now() / 1000) // Add issued at time\n  };\n  \n  // Add device fingerprint if available\n  if (deviceFingerprint) {\n    payload.deviceFingerprint = deviceFingerprint;\n  }\n  \n  return jwt.sign(\n    payload,\n    getJWTSecrets()[0], // Use current secret for signing\n    {\n      expiresIn,\n      algorithm: 'HS256'\n    }\n  );\n};\n\nexport const generateRefreshToken = (userId: string): string => {\n  // Refresh tokens get shorter TTL too\n  const expiresIn = process.env[ENV_VARS.NODE_ENV] === ENV_VALUES.PRODUCTION ? '7d' : '30d';\n  \n  return jwt.sign(\n    { \n      userId, \n      type: 'refresh',\n      jti: crypto.randomUUID(), // Add JWT ID for revocation tracking\n      iat: Math.floor(Date.now() / 1000)\n    },\n    getJWTSecrets()[0], // Use current secret for signing\n    {\n      expiresIn,\n      algorithm: 'HS256'\n    }\n  );\n};\n\n/** Backward compatibility for existing call sites */\nexport const generateToken = generateAccessToken;\n"],"version":3}