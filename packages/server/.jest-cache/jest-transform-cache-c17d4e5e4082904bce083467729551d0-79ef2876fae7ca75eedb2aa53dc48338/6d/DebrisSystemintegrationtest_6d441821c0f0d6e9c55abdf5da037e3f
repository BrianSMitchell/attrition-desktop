ad847b945514777ca6af8db5107aeb43
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const DebrisSystem_1 = require("../DebrisSystem");
const shared_1 = require("@game/shared");
describe('DebrisSystem Integration', () => {
    let debrisSystem;
    let locations;
    let empires;
    const ASTEROID_COUNT = 10;
    const EMPIRE_COUNT = 5;
    const SIMULATION_TIME = 5000; // 5 seconds
    beforeEach(() => {
        locations = new Map();
        empires = new Map();
        // Create test asteroids
        for (let i = 0; i < ASTEROID_COUNT; i++) {
            const coord = `A00:10:22:${i.toString().padStart(2, '0')}`;
            locations.set(coord, createTestLocation(coord));
        }
        // Create test empires
        for (let i = 0; i < EMPIRE_COUNT; i++) {
            const id = `empire${i + 1}`;
            empires.set(id, createTestEmpire(id));
        }
        debrisSystem = new DebrisSystem_1.DebrisSystem(locations, empires);
    });
    afterEach(() => {
        debrisSystem.stop();
    });
    test('complete system simulation', async () => {
        // Track initial credits
        const initialCredits = new Map();
        empires.forEach((empire, id) => {
            initialCredits.set(id, empire.resources.credits);
        });
        // Add recyclers randomly to asteroids
        for (const [coord] of locations) {
            // Randomly select 1-3 empires to add recyclers
            const recyclerCount = Math.floor(Math.random() * 3) + 1;
            const empireIds = Array.from(empires.keys());
            for (let i = 0; i < recyclerCount; i++) {
                const randomIndex = Math.floor(Math.random() * empireIds.length);
                const empireId = empireIds[randomIndex];
                empireIds.splice(randomIndex, 1); // Remove used empire
                debrisSystem.addRecycler(coord, empireId);
            }
            // Verify recycler setup
            const location = locations.get(coord);
            expect(location).toHaveValidRecyclerSetup();
        }
        // Let the system run
        await new Promise(resolve => setTimeout(resolve, SIMULATION_TIME));
        // Verify results
        for (const [coord, location] of locations) {
            // Check debris state
            expect(location).toHaveValidDebrisState();
            // Verify debris amount is reasonable
            if (location.debris.recyclers.length > 0) {
                // With active recyclers, debris should be relatively low
                expect(location.debris.amount).toBeLessThan(100);
            }
            else {
                // Without recyclers, debris should have accumulated
                const expectedMinimum = location.debris.generationRate * (SIMULATION_TIME / 1000);
                expect(location.debris.amount).toBeGreaterThan(expectedMinimum * 0.9); // Allow 10% margin
            }
        }
        // Verify empire credits increased appropriately
        empires.forEach((empire, id) => {
            const initialCredit = initialCredits.get(id);
            const creditIncrease = empire.resources.credits - initialCredit;
            // Count how many recyclers this empire has
            let recyclerCount = 0;
            locations.forEach(location => {
                recyclerCount += location.debris?.recyclers.filter(r => r.empireId === id).length ?? 0;
            });
            if (recyclerCount > 0) {
                // Empire should have earned credits
                expect(creditIncrease).toBeGreaterThan(0);
                // Rough estimate of expected credits
                // Each recycler collects 10 debris/second = 10 credits/second
                const expectedMinimum = recyclerCount * 10 * (SIMULATION_TIME / 1000) * 0.5; // 50% margin for competition
                expect(creditIncrease).toBeGreaterThan(expectedMinimum);
            }
            else {
                // Empire without recyclers shouldn't earn credits
                expect(creditIncrease).toBe(0);
            }
        });
    });
    test('system resilience', async () => {
        // Add and remove recyclers rapidly
        const coord = 'A00:10:22:00';
        const empireId = 'empire1';
        // Start a loop of adding/removing recyclers
        const interval = setInterval(() => {
            if (Math.random() < 0.5) {
                debrisSystem.addRecycler(coord, empireId);
            }
            else {
                debrisSystem.removeRecycler(coord, empireId);
            }
        }, 100);
        // Let it run
        await new Promise(resolve => setTimeout(resolve, shared_1.TIMEOUTS.TWO_SECONDS));
        clearInterval(interval);
        // System should still be stable
        const location = locations.get(coord);
        expect(location).toHaveValidDebrisState();
    });
    test('performance under load', async () => {
        // Add maximum recyclers to all asteroids
        for (const [coord] of locations) {
            for (const [empireId] of empires) {
                debrisSystem.addRecycler(coord, empireId);
            }
        }
        const startTime = Date.now();
        // Run for 1 second
        await new Promise(resolve => setTimeout(resolve, shared_1.TIMEOUTS.ONE_SECOND));
        const endTime = Date.now();
        const duration = endTime - startTime;
        // Should not have significant timing drift
        expect(duration).toBeLessThan(1200); // Allow 20% margin
        // All locations should still be valid
        for (const [, location] of locations) {
            expect(location).toHaveValidDebrisState();
            expect(location).toHaveValidRecyclerSetup();
        }
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFByb2plY3RzXFxBdHRyaXRpb25cXHBhY2thZ2VzXFxzZXJ2ZXJcXHNyY1xcc3lzdGVtc1xcX190ZXN0c19fXFxEZWJyaXNTeXN0ZW0uaW50ZWdyYXRpb24udGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLGtEQUErQztBQUcvQyx5Q0FBd0M7QUFDeEMsUUFBUSxDQUFDLDBCQUEwQixFQUFFLEdBQUcsRUFBRTtJQUN4QyxJQUFJLFlBQTBCLENBQUM7SUFDL0IsSUFBSSxTQUFnQyxDQUFDO0lBQ3JDLElBQUksT0FBNEIsQ0FBQztJQUVqQyxNQUFNLGNBQWMsR0FBRyxFQUFFLENBQUM7SUFDMUIsTUFBTSxZQUFZLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZCLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxDQUFDLFlBQVk7SUFFMUMsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLFNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBb0IsQ0FBQztRQUN4QyxPQUFPLEdBQUcsSUFBSSxHQUFHLEVBQWtCLENBQUM7UUFFcEMsd0JBQXdCO1FBQ3hCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxjQUFjLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUN4QyxNQUFNLEtBQUssR0FBRyxhQUFhLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDM0QsU0FBUyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsa0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNsRCxDQUFDO1FBRUQsc0JBQXNCO1FBQ3RCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxZQUFZLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUN0QyxNQUFNLEVBQUUsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUM1QixPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxnQkFBZ0IsQ0FB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LENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLGlCQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztRQUV2RSxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDM0IsTUFBTSxRQUFRLEdBQUcsT0FBTyxHQUFHLFNBQVMsQ0FBQztRQUVyQywyQ0FBMkM7UUFDM0MsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLG1CQUFtQjtRQUV4RCxzQ0FBc0M7UUFDdEMsS0FBSyxNQUFNLENBQUMsRUFBRSxRQUFRLENBQUMsSUFBSSxTQUFTLEVBQUUsQ0FBQztZQUNyQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztZQUMxQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztRQUM5QyxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcUHJvamVjdHNcXEF0dHJpdGlvblxccGFja2FnZXNcXHNlcnZlclxcc3JjXFxzeXN0ZW1zXFxfX3Rlc3RzX19cXERlYnJpc1N5c3RlbS5pbnRlZ3JhdGlvbi50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERlYnJpc1N5c3RlbSB9IGZyb20gJy4uL0RlYnJpc1N5c3RlbSc7XG5pbXBvcnQgeyBMb2NhdGlvbiwgRW1waXJlIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2hhcmVkL3NyYy90eXBlcyc7XG5cbmltcG9ydCB7IFRJTUVPVVRTIH0gZnJvbSAnQGdhbWUvc2hhcmVkJztcbmRlc2NyaWJlKCdEZWJyaXNTeXN0ZW0gSW50ZWdyYXRpb24nLCAoKSA9PiB7XG4gIGxldCBkZWJyaXNTeXN0ZW06IERlYnJpc1N5c3RlbTtcbiAgbGV0IGxvY2F0aW9uczogTWFwPHN0cmluZywgTG9jYXRpb24+O1xuICBsZXQgZW1waXJlczogTWFwPHN0cmluZywgRW1waXJlPjtcbiAgXG4gIGNvbnN0IEFTVEVST0lEX0NPVU5UID0gMTA7XG4gIGNvbnN0IEVNUElSRV9DT1VOVCA9IDU7XG4gIGNvbnN0IFNJTVVMQVRJT05fVElNRSA9IDUwMDA7IC8vIDUgc2Vjb25kc1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGxvY2F0aW9ucyA9IG5ldyBNYXA8c3RyaW5nLCBMb2NhdGlvbj4oKTtcbiAgICBlbXBpcmVzID0gbmV3IE1hcDxzdHJpbmcsIEVtcGlyZT4oKTtcblxuICAgIC8vIENyZWF0ZSB0ZXN0IGFzdGVyb2lkc1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgQVNURVJPSURfQ09VTlQ7IGkrKykge1xuICAgICAgY29uc3QgY29vcmQgPSBgQTAwOjEwOjIyOiR7aS50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9YDtcbiAgICAgIGxvY2F0aW9ucy5zZXQoY29vcmQsIGNyZWF0ZVRlc3RMb2NhdGlvbihjb29yZCkpO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSB0ZXN0IGVtcGlyZXNcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IEVNUElSRV9DT1VOVDsgaSsrKSB7XG4gICAgICBjb25zdCBpZCA9IGBlbXBpcmUke2kgKyAxfWA7XG4gICAgICBlbXBpcmVzLnNldChpZCwgY3JlYXRlVGVzdEVtcGlyZShpZCkpO1xuICAgIH1cblxuICAgIGRlYnJpc1N5c3RlbSA9IG5ldyBEZWJyaXNTeXN0ZW0obG9jYXRpb25zLCBlbXBpcmVzKTtcbiAgfSk7XG5cbiAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICBkZWJyaXNTeXN0ZW0uc3RvcCgpO1xuICB9KTtcblxuICB0ZXN0KCdjb21wbGV0ZSBzeXN0ZW0gc2ltdWxhdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAvLyBUcmFjayBpbml0aWFsIGNyZWRpdHNcbiAgICBjb25zdCBpbml0aWFsQ3JlZGl0cyA9IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KCk7XG4gICAgZW1waXJlcy5mb3JFYWNoKChlbXBpcmUsIGlkKSA9PiB7XG4gICAgICBpbml0aWFsQ3JlZGl0cy5zZXQoaWQsIGVtcGlyZS5yZXNvdXJjZXMuY3JlZGl0cyk7XG4gICAgfSk7XG5cbiAgICAvLyBBZGQgcmVjeWNsZXJzIHJhbmRvbWx5IHRvIGFzdGVyb2lkc1xuICAgIGZvciAoY29uc3QgW2Nvb3JkXSBvZiBsb2NhdGlvbnMpIHtcbiAgICAgIC8vIFJhbmRvbWx5IHNlbGVjdCAxLTMgZW1waXJlcyB0byBhZGQgcmVjeWNsZXJzXG4gICAgICBjb25zdCByZWN5Y2xlckNvdW50ID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMykgKyAxO1xuICAgICAgY29uc3QgZW1waXJlSWRzID0gQXJyYXkuZnJvbShlbXBpcmVzLmtleXMoKSk7XG4gICAgICBcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVjeWNsZXJDb3VudDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHJhbmRvbUluZGV4ID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogZW1waXJlSWRzLmxlbmd0aCk7XG4gICAgICAgIGNvbnN0IGVtcGlyZUlkID0gZW1waXJlSWRzW3JhbmRvbUluZGV4XTtcbiAgICAgICAgZW1waXJlSWRzLnNwbGljZShyYW5kb21JbmRleCwgMSk7IC8vIFJlbW92ZSB1c2VkIGVtcGlyZVxuICAgICAgICBcbiAgICAgICAgZGVicmlzU3lzdGVtLmFkZFJlY3ljbGVyKGNvb3JkLCBlbXBpcmVJZCk7XG4gICAgICB9XG5cbiAgICAgIC8vIFZlcmlmeSByZWN5Y2xlciBzZXR1cFxuICAgICAgY29uc3QgbG9jYXRpb24gPSBsb2NhdGlvbnMuZ2V0KGNvb3JkKSE7XG4gICAgICBleHBlY3QobG9jYXRpb24pLnRvSGF2ZVZhbGlkUmVjeWNsZXJTZXR1cCgpO1xuICAgIH1cblxuICAgIC8vIExldCB0aGUgc3lzdGVtIHJ1blxuICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBTSU1VTEFUSU9OX1RJTUUpKTtcblxuICAgIC8vIFZlcmlmeSByZXN1bHRzXG4gICAgZm9yIChjb25zdCBbY29vcmQsIGxvY2F0aW9uXSBvZiBsb2NhdGlvbnMpIHtcbiAgICAgIC8vIENoZWNrIGRlYnJpcyBzdGF0ZVxuICAgICAgZXhwZWN0KGxvY2F0aW9uKS50b0hhdmVWYWxpZERlYnJpc1N0YXRlKCk7XG4gICAgICBcbiAgICAgIC8vIFZlcmlmeSBkZWJyaXMgYW1vdW50IGlzIHJlYXNvbmFibGVcbiAgICAgIGlmIChsb2NhdGlvbi5kZWJyaXMhLnJlY3ljbGVycy5sZW5ndGggPiAwKSB7XG4gICAgICAgIC8vIFdpdGggYWN0aXZlIHJlY3ljbGVycywgZGVicmlzIHNob3VsZCBiZSByZWxhdGl2ZWx5IGxvd1xuICAgICAgICBleHBlY3QobG9jYXRpb24uZGVicmlzIS5hbW91bnQpLnRvQmVMZXNzVGhhbigxMDApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gV2l0aG91dCByZWN5Y2xlcnMsIGRlYnJpcyBzaG91bGQgaGF2ZSBhY2N1bXVsYXRlZFxuICAgICAgICBjb25zdCBleHBlY3RlZE1pbmltdW0gPSBsb2NhdGlvbi5kZWJyaXMhLmdlbmVyYXRpb25SYXRlICogKFNJTVVMQVRJT05fVElNRSAvIDEwMDApO1xuICAgICAgICBleHBlY3QobG9jYXRpb24uZGVicmlzIS5hbW91bnQpLnRvQmVHcmVhdGVyVGhhbihleHBlY3RlZE1pbmltdW0gKiAwLjkpOyAvLyBBbGxvdyAxMCUgbWFyZ2luXG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gVmVyaWZ5IGVtcGlyZSBjcmVkaXRzIGluY3JlYXNlZCBhcHByb3ByaWF0ZWx5XG4gICAgZW1waXJlcy5mb3JFYWNoKChlbXBpcmUsIGlkKSA9PiB7XG4gICAgICBjb25zdCBpbml0aWFsQ3JlZGl0ID0gaW5pdGlhbENyZWRpdHMuZ2V0KGlkKSE7XG4gICAgICBjb25zdCBjcmVkaXRJbmNyZWFzZSA9IGVtcGlyZS5yZXNvdXJjZXMuY3JlZGl0cyAtIGluaXRpYWxDcmVkaXQ7XG4gICAgICBcbiAgICAgIC8vIENvdW50IGhvdyBtYW55IHJlY3ljbGVycyB0aGlzIGVtcGlyZSBoYXNcbiAgICAgIGxldCByZWN5Y2xlckNvdW50ID0gMDtcbiAgICAgIGxvY2F0aW9ucy5mb3JFYWNoKGxvY2F0aW9uID0+IHtcbiAgICAgICAgcmVjeWNsZXJDb3VudCArPSBsb2NhdGlvbi5kZWJyaXM/LnJlY3ljbGVycy5maWx0ZXIociA9PiByLmVtcGlyZUlkID09PSBpZCkubGVuZ3RoID8/IDA7XG4gICAgICB9KTtcblxuICAgICAgaWYgKHJlY3ljbGVyQ291bnQgPiAwKSB7XG4gICAgICAgIC8vIEVtcGlyZSBzaG91bGQgaGF2ZSBlYXJuZWQgY3JlZGl0c1xuICAgICAgICBleHBlY3QoY3JlZGl0SW5jcmVhc2UpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICAgICAgXG4gICAgICAgIC8vIFJvdWdoIGVzdGltYXRlIG9mIGV4cGVjdGVkIGNyZWRpdHNcbiAgICAgICAgLy8gRWFjaCByZWN5Y2xlciBjb2xsZWN0cyAxMCBkZWJyaXMvc2Vjb25kID0gMTAgY3JlZGl0cy9zZWNvbmRcbiAgICAgICAgY29uc3QgZXhwZWN0ZWRNaW5pbXVtID0gcmVjeWNsZXJDb3VudCAqIDEwICogKFNJTVVMQVRJT05fVElNRSAvIDEwMDApICogMC41OyAvLyA1MCUgbWFyZ2luIGZvciBjb21wZXRpdGlvblxuICAgICAgICBleHBlY3QoY3JlZGl0SW5jcmVhc2UpLnRvQmVHcmVhdGVyVGhhbihleHBlY3RlZE1pbmltdW0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gRW1waXJlIHdpdGhvdXQgcmVjeWNsZXJzIHNob3VsZG4ndCBlYXJuIGNyZWRpdHNcbiAgICAgICAgZXhwZWN0KGNyZWRpdEluY3JlYXNlKS50b0JlKDApO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdzeXN0ZW0gcmVzaWxpZW5jZScsIGFzeW5jICgpID0+IHtcbiAgICAvLyBBZGQgYW5kIHJlbW92ZSByZWN5Y2xlcnMgcmFwaWRseVxuICAgIGNvbnN0IGNvb3JkID0gJ0EwMDoxMDoyMjowMCc7XG4gICAgY29uc3QgZW1waXJlSWQgPSAnZW1waXJlMSc7XG4gICAgXG4gICAgLy8gU3RhcnQgYSBsb29wIG9mIGFkZGluZy9yZW1vdmluZyByZWN5Y2xlcnNcbiAgICBjb25zdCBpbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgMC41KSB7XG4gICAgICAgIGRlYnJpc1N5c3RlbS5hZGRSZWN5Y2xlcihjb29yZCwgZW1waXJlSWQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZGVicmlzU3lzdGVtLnJlbW92ZVJlY3ljbGVyKGNvb3JkLCBlbXBpcmVJZCk7XG4gICAgICB9XG4gICAgfSwgMTAwKTtcblxuICAgIC8vIExldCBpdCBydW5cbiAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgVElNRU9VVFMuVFdPX1NFQ09ORFMpKTtcbiAgICBcbiAgICBjbGVhckludGVydmFsKGludGVydmFsKTtcblxuICAgIC8vIFN5c3RlbSBzaG91bGQgc3RpbGwgYmUgc3RhYmxlXG4gICAgY29uc3QgbG9jYXRpb24gPSBsb2NhdGlvbnMuZ2V0KGNvb3JkKSE7XG4gICAgZXhwZWN0KGxvY2F0aW9uKS50b0hhdmVWYWxpZERlYnJpc1N0YXRlKCk7XG4gIH0pO1xuXG4gIHRlc3QoJ3BlcmZvcm1hbmNlIHVuZGVyIGxvYWQnLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gQWRkIG1heGltdW0gcmVjeWNsZXJzIHRvIGFsbCBhc3Rlcm9pZHNcbiAgICBmb3IgKGNvbnN0IFtjb29yZF0gb2YgbG9jYXRpb25zKSB7XG4gICAgICBmb3IgKGNvbnN0IFtlbXBpcmVJZF0gb2YgZW1waXJlcykge1xuICAgICAgICBkZWJyaXNTeXN0ZW0uYWRkUmVjeWNsZXIoY29vcmQsIGVtcGlyZUlkKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIFxuICAgIC8vIFJ1biBmb3IgMSBzZWNvbmRcbiAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgVElNRU9VVFMuT05FX1NFQ09ORCkpO1xuICAgIFxuICAgIGNvbnN0IGVuZFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IGR1cmF0aW9uID0gZW5kVGltZSAtIHN0YXJ0VGltZTtcblxuICAgIC8vIFNob3VsZCBub3QgaGF2ZSBzaWduaWZpY2FudCB0aW1pbmcgZHJpZnRcbiAgICBleHBlY3QoZHVyYXRpb24pLnRvQmVMZXNzVGhhbigxMjAwKTsgLy8gQWxsb3cgMjAlIG1hcmdpblxuXG4gICAgLy8gQWxsIGxvY2F0aW9ucyBzaG91bGQgc3RpbGwgYmUgdmFsaWRcbiAgICBmb3IgKGNvbnN0IFssIGxvY2F0aW9uXSBvZiBsb2NhdGlvbnMpIHtcbiAgICAgIGV4cGVjdChsb2NhdGlvbikudG9IYXZlVmFsaWREZWJyaXNTdGF0ZSgpO1xuICAgICAgZXhwZWN0KGxvY2F0aW9uKS50b0hhdmVWYWxpZFJlY3ljbGVyU2V0dXAoKTtcbiAgICB9XG4gIH0pO1xufSk7Il0sInZlcnNpb24iOjN9