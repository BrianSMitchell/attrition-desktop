{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\systems\\__tests__\\DebrisSystem.integration.test.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\systems\\__tests__\\DebrisSystem.integration.test.ts"],"sourcesContent":["import { DebrisSystem } from '../DebrisSystem';\nimport { Location, Empire } from '../../../../shared/src/types';\n\nimport { TIMEOUTS } from '@game/shared';\ndescribe('DebrisSystem Integration', () => {\n  let debrisSystem: DebrisSystem;\n  let locations: Map<string, Location>;\n  let empires: Map<string, Empire>;\n  \n  const ASTEROID_COUNT = 10;\n  const EMPIRE_COUNT = 5;\n  const SIMULATION_TIME = 5000; // 5 seconds\n\n  beforeEach(() => {\n    locations = new Map<string, Location>();\n    empires = new Map<string, Empire>();\n\n    // Create test asteroids\n    for (let i = 0; i < ASTEROID_COUNT; i++) {\n      const coord = `A00:10:22:${i.toString().padStart(2, '0')}`;\n      locations.set(coord, createTestLocation(coord));\n    }\n\n    // Create test empires\n    for (let i = 0; i < EMPIRE_COUNT; i++) {\n      const id = `empire${i + 1}`;\n      empires.set(id, createTestEmpire(id));\n    }\n\n    debrisSystem = new DebrisSystem(locations, empires);\n  });\n\n  afterEach(() => {\n    debrisSystem.stop();\n  });\n\n  test('complete system simulation', async () => {\n    // Track initial credits\n    const initialCredits = new Map<string, number>();\n    empires.forEach((empire, id) => {\n      initialCredits.set(id, empire.resources.credits);\n    });\n\n    // Add recyclers randomly to asteroids\n    for (const [coord] of locations) {\n      // Randomly select 1-3 empires to add recyclers\n      const recyclerCount = Math.floor(Math.random() * 3) + 1;\n      const empireIds = Array.from(empires.keys());\n      \n      for (let i = 0; i < recyclerCount; i++) {\n        const randomIndex = Math.floor(Math.random() * empireIds.length);\n        const empireId = empireIds[randomIndex];\n        empireIds.splice(randomIndex, 1); // Remove used empire\n        \n        debrisSystem.addRecycler(coord, empireId);\n      }\n\n      // Verify recycler setup\n      const location = locations.get(coord)!;\n      expect(location).toHaveValidRecyclerSetup();\n    }\n\n    // Let the system run\n    await new Promise(resolve => setTimeout(resolve, SIMULATION_TIME));\n\n    // Verify results\n    for (const [coord, location] of locations) {\n      // Check debris state\n      expect(location).toHaveValidDebrisState();\n      \n      // Verify debris amount is reasonable\n      if (location.debris!.recyclers.length > 0) {\n        // With active recyclers, debris should be relatively low\n        expect(location.debris!.amount).toBeLessThan(100);\n      } else {\n        // Without recyclers, debris should have accumulated\n        const expectedMinimum = location.debris!.generationRate * (SIMULATION_TIME / 1000);\n        expect(location.debris!.amount).toBeGreaterThan(expectedMinimum * 0.9); // Allow 10% margin\n      }\n    }\n\n    // Verify empire credits increased appropriately\n    empires.forEach((empire, id) => {\n      const initialCredit = initialCredits.get(id)!;\n      const creditIncrease = empire.resources.credits - initialCredit;\n      \n      // Count how many recyclers this empire has\n      let recyclerCount = 0;\n      locations.forEach(location => {\n        recyclerCount += location.debris?.recyclers.filter(r => r.empireId === id).length ?? 0;\n      });\n\n      if (recyclerCount > 0) {\n        // Empire should have earned credits\n        expect(creditIncrease).toBeGreaterThan(0);\n        \n        // Rough estimate of expected credits\n        // Each recycler collects 10 debris/second = 10 credits/second\n        const expectedMinimum = recyclerCount * 10 * (SIMULATION_TIME / 1000) * 0.5; // 50% margin for competition\n        expect(creditIncrease).toBeGreaterThan(expectedMinimum);\n      } else {\n        // Empire without recyclers shouldn't earn credits\n        expect(creditIncrease).toBe(0);\n      }\n    });\n  });\n\n  test('system resilience', async () => {\n    // Add and remove recyclers rapidly\n    const coord = 'A00:10:22:00';\n    const empireId = 'empire1';\n    \n    // Start a loop of adding/removing recyclers\n    const interval = setInterval(() => {\n      if (Math.random() < 0.5) {\n        debrisSystem.addRecycler(coord, empireId);\n      } else {\n        debrisSystem.removeRecycler(coord, empireId);\n      }\n    }, 100);\n\n    // Let it run\n    await new Promise(resolve => setTimeout(resolve, TIMEOUTS.TWO_SECONDS));\n    \n    clearInterval(interval);\n\n    // System should still be stable\n    const location = locations.get(coord)!;\n    expect(location).toHaveValidDebrisState();\n  });\n\n  test('performance under load', async () => {\n    // Add maximum recyclers to all asteroids\n    for (const [coord] of locations) {\n      for (const [empireId] of empires) {\n        debrisSystem.addRecycler(coord, empireId);\n      }\n    }\n\n    const startTime = Date.now();\n    \n    // Run for 1 second\n    await new Promise(resolve => setTimeout(resolve, TIMEOUTS.ONE_SECOND));\n    \n    const endTime = Date.now();\n    const duration = endTime - startTime;\n\n    // Should not have significant timing drift\n    expect(duration).toBeLessThan(1200); // Allow 20% margin\n\n    // All locations should still be valid\n    for (const [, location] of locations) {\n      expect(location).toHaveValidDebrisState();\n      expect(location).toHaveValidRecyclerSetup();\n    }\n  });\n});"],"version":3}