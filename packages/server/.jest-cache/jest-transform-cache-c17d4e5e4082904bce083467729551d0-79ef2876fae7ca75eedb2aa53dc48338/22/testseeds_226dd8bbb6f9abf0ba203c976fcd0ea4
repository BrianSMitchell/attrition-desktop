2ddc51520996c4b230da29959d21ccba
"use strict";
/**
 * Test Seeding Routes
 *
 * Test-only endpoints for seeding data in E2E testing environments.
 * All routes are guarded by NODE_ENV === 'test' check.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const supabase_1 = require("../../config/supabase");
const errorHandler_1 = require("../../middleware/errorHandler");
const response_formats_1 = require("../../constants/response-formats");
const database_fields_1 = require("../../constants/database-fields");
const shared_1 = require("@game/shared");
const shared_2 = require("@game/shared");
const EmpireResolutionService_1 = require("../../services/empire/EmpireResolutionService");
const router = (0, express_1.Router)();
/**
 * Test-only seeding endpoint to make Research Start deterministic in E2E.
 * Guarded by NODE_ENV === 'test'
 */
router.post('/seed-research', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    if (process.env[shared_2.ENV_VARS.NODE_ENV] !== 'test') {
        return res.status(shared_1.HTTP_STATUS.FORBIDDEN).json({
            success: false,
            error: response_formats_1.ERROR_MESSAGES.FEATURE_DISABLED
        });
    }
    // Test seed research endpoint now uses only Supabase implementation
    return res.status(shared_1.HTTP_STATUS.NOT_IMPLEMENTED).json({
        success: false,
        error: 'Test seeding not yet fully implemented for research'
    });
}));
/**
 * Test-only seeding endpoint to make Defenses Start deterministic in E2E.
 * - Tops up credits
 * - Ensures tech prereqs for jump_gate (warp_drive 12, energy 20)
 * - Ensures positive energy projection by adding active solar plants at the base
 * Guarded by NODE_ENV === 'test'
 */
router.post('/seed-defenses', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    if (process.env[shared_2.ENV_VARS.NODE_ENV] !== 'test') {
        return res.status(shared_1.HTTP_STATUS.FORBIDDEN).json({
            success: false,
            error: response_formats_1.ERROR_MESSAGES.FEATURE_DISABLED
        });
    }
    // Test seed defenses endpoint now uses only Supabase implementation
    return res.status(shared_1.HTTP_STATUS.NOT_IMPLEMENTED).json({
        success: false,
        error: 'Test seeding not yet fully implemented for defenses'
    });
}));
/**
 * Test-only seeding endpoint to make Structures Start deterministic in E2E.
 * - Tops up credits
 * - Broadly raises tech levels so most structures are eligible
 * - Ensures positive energy projection and construction capacity (solar + robotics)
 * Guarded by NODE_ENV === 'test'
 */
router.post('/seed-structures', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    if (process.env[shared_2.ENV_VARS.NODE_ENV] !== 'test') {
        return res.status(shared_1.HTTP_STATUS.FORBIDDEN).json({
            success: false,
            error: response_formats_1.ERROR_MESSAGES.FEATURE_DISABLED
        });
    }
    // Test seeding endpoint uses Supabase implementation
    const user = req.user;
    // Resolve empire using the service
    const empireRow = await EmpireResolutionService_1.EmpireResolutionService.resolveEmpireByUserObject(user);
    if (!empireRow) {
        return res.status(shared_1.HTTP_STATUS.NOT_FOUND).json({ success: false, error: response_formats_1.ERROR_MESSAGES.EMPIRE_NOT_FOUND });
    }
    const empireId = String(empireRow.id);
    // Determine target base coordinate
    let baseCoord = '';
    try {
        baseCoord = String((req.body?.baseCoord ?? '')).trim();
    }
    catch {
        baseCoord = '';
    }
    if (!baseCoord) {
        const emp = await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.EMPIRES)
            .select(database_fields_1.DB_FIELDS.EMPIRES.TERRITORIES)
            .eq(database_fields_1.DB_FIELDS.BUILDINGS.ID, empireId)
            .maybeSingle();
        const territories = Array.isArray(emp.data?.territories) ? emp.data.territories : [];
        if (territories.length > 0)
            baseCoord = territories[0];
    }
    if (!baseCoord) {
        return res.status(shared_1.HTTP_STATUS.BAD_REQUEST).json({
            success: false,
            error: 'No base coordinate available to seed (provide baseCoord or colonize first)'
        });
    }
    // Top up credits
    const creditsTargetRaw = (req.body && typeof req.body.credits !== 'undefined') ? Number(req.body.credits) : 100000;
    const creditsTarget = Number.isFinite(creditsTargetRaw) ? creditsTargetRaw : 100000;
    const eRow = await supabase_1.supabase
        .from(database_fields_1.DB_TABLES.EMPIRES)
        .select(database_fields_1.DB_FIELDS.EMPIRES.CREDITS)
        .eq(database_fields_1.DB_FIELDS.BUILDINGS.ID, empireId)
        .maybeSingle();
    const currentCredits = Math.max(0, Number(eRow.data?.credits || 0));
    if (currentCredits < creditsTarget) {
        await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.EMPIRES)
            .update({ credits: creditsTarget })
            .eq(database_fields_1.DB_FIELDS.BUILDINGS.ID, empireId);
    }
    // Ensure positive energy projection with active solar plants
    const existingSolar = await supabase_1.supabase
        .from(database_fields_1.DB_TABLES.BUILDINGS)
        .select('id, level')
        .eq(database_fields_1.DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)
        .eq(database_fields_1.DB_FIELDS.BUILDINGS.LOCATION_COORD, baseCoord)
        .eq(database_fields_1.DB_FIELDS.BUILDINGS.CATALOG_KEY, 'solar_plants')
        .eq(database_fields_1.DB_FIELDS.BUILDINGS.IS_ACTIVE, true)
        .maybeSingle();
    if (!existingSolar.data) {
        await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.BUILDINGS)
            .insert({
            empire_id: empireId,
            location_coord: baseCoord,
            catalog_key: 'solar_plants',
            level: 30,
            is_active: true,
            construction_completed: new Date().toISOString(),
            credits_cost: 0,
        });
    }
    return res.json({
        success: true,
        message: 'Test structures seeded successfully',
        data: {
            empireId,
            baseCoord,
            credits: creditsTarget
        }
    });
}));
/**
 * Test-only endpoint to delete queued buildings by catalog key.
 * Guarded by NODE_ENV === 'test'
 */
router.delete('/buildings/queued/:catalogKey', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    if (process.env[shared_2.ENV_VARS.NODE_ENV] !== 'test') {
        return res.status(shared_1.HTTP_STATUS.FORBIDDEN).json({
            success: false,
            error: response_formats_1.ERROR_MESSAGES.FEATURE_DISABLED
        });
    }
    const user = req.user;
    // Resolve empire using the service
    const empireRow = await EmpireResolutionService_1.EmpireResolutionService.resolveEmpireByUserObject(user);
    if (!empireRow) {
        return res.status(shared_1.HTTP_STATUS.NOT_FOUND).json({ success: false, error: response_formats_1.ERROR_MESSAGES.EMPIRE_NOT_FOUND });
    }
    const empireId = String(empireRow.id);
    const { catalogKey } = req.params;
    if (!catalogKey) {
        return res.status(shared_1.HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'catalogKey required' });
    }
    // Remove any inactive (queued) buildings with this catalogKey for this empire
    const { data, error } = await supabase_1.supabase
        .from(database_fields_1.DB_TABLES.BUILDINGS)
        .delete()
        .eq(database_fields_1.DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)
        .eq(database_fields_1.DB_FIELDS.BUILDINGS.CATALOG_KEY, catalogKey)
        .eq(database_fields_1.DB_FIELDS.BUILDINGS.IS_ACTIVE, false)
        .select(database_fields_1.DB_FIELDS.BUILDINGS.ID);
    if (error) {
        return res.status(shared_1.HTTP_STATUS.INTERNAL_SERVER_ERROR).json({ success: false, error: error.message });
    }
    return res.json({
        success: true,
        message: `Deleted ${data?.length ?? 0} queued building(s) with catalogKey: ${catalogKey}`,
        data: { deleted: data?.length ?? 0 }
    });
}));
exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFByb2plY3RzXFxBdHRyaXRpb25cXHBhY2thZ2VzXFxzZXJ2ZXJcXHNyY1xccm91dGVzXFxnYW1lXFx0ZXN0LXNlZWRzLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7R0FLRzs7QUFFSCxxQ0FBMkM7QUFDM0Msb0RBQWlEO0FBQ2pELGdFQUE2RDtBQUU3RCx1RUFBa0U7QUFFbEUscUVBQXVFO0FBQ3ZFLHlDQUEyQztBQUMzQyx5Q0FBd0M7QUFDeEMsMkZBQXdGO0FBRXhGLE1BQU0sTUFBTSxHQUFXLElBQUEsZ0JBQU0sR0FBRSxDQUFDO0FBRWhDOzs7R0FHRztBQUNILE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsSUFBQSwyQkFBWSxFQUFDLEtBQUssRUFBRSxHQUFnQixFQUFFLEdBQWEsRUFBRSxFQUFFO0lBQ25GLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBUSxDQUFDLFFBQVEsQ0FBQyxLQUFLLE1BQU0sRUFBRSxDQUFDO1FBQzlDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxvQkFBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUM1QyxPQUFPLEVBQUUsS0FBSztZQUNkLEtBQUssRUFBRSxpQ0FBYyxDQUFDLGdCQUFnQjtTQUN2QyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsb0VBQW9FO0lBQ3BFLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxvQkFBVyxDQUFDLGVBQWUsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUNsRCxPQUFPLEVBQUUsS0FBSztRQUNkLEtBQUssRUFBRSxxREFBcUQ7S0FDN0QsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUVKOzs7Ozs7R0FNRztBQUNILE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsSUFBQSwyQkFBWSxFQUFDLEtBQUssRUFBRSxHQUFnQixFQUFFLEdBQWEsRUFBRSxFQUFFO0lBQ25GLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBUSxDQUFDLFFBQVEsQ0FBQyxLQUFLLE1BQU0sRUFBRSxDQUFDO1FBQzlDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxvQkFBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUM1QyxPQUFPLEVBQUUsS0FBSztZQUNkLEtBQUssRUFBRSxpQ0FBYyxDQUFDLGdCQUFnQjtTQUN2QyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsb0VBQW9FO0lBQ3BFLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxvQkFBVyxDQUFDLGVBQWUsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUNsRCxPQUFPLEVBQUUsS0FBSztRQUNkLEtBQUssRUFBRSxxREFBcUQ7S0FDN0QsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUVKOzs7Ozs7R0FNRztBQUNILE1BQU0sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsSUFBQSwyQkFBWSxFQUFDLEtBQUssRUFBRSxHQUFnQixFQUFFLEdBQWEsRUFBRSxFQUFFO0lBQ3JGLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBUSxDQUFDLFFBQVEsQ0FBQyxLQUFLLE1BQU0sRUFBRSxDQUFDO1FBQzlDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxvQkFBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUM1QyxPQUFPLEVBQUUsS0FBSztZQUNkLEtBQUssRUFBRSxpQ0FBYyxDQUFDLGdCQUFnQjtTQUN2QyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQscURBQXFEO0lBQ3JELE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFZLENBQUM7SUFFOUIsbUNBQW1DO0lBQ25DLE1BQU0sU0FBUyxHQUFHLE1BQU0saURBQXVCLENBQUMseUJBQXlCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEYsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2YsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLG9CQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsaUNBQWMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLENBQUM7SUFDNUcsQ0FBQztJQUVELE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7SUFFdEMsbUNBQW1DO0lBQ25DLElBQUksU0FBUyxHQUFHLEVBQUUsQ0FBQztJQUNuQixJQUFJLENBQUM7UUFDSCxTQUFTLEdBQUcsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxTQUFTLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUN6RCxDQUFDO0lBQUMsTUFBTSxDQUFDO1FBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztJQUFDLENBQUM7SUFFM0IsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2YsTUFBTSxHQUFHLEdBQUcsTUFBTSxtQkFBUTthQUN2QixJQUFJLENBQUMsMkJBQVMsQ0FBQyxPQUFPLENBQUM7YUFDdkIsTUFBTSxDQUFDLDJCQUFTLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQzthQUNyQyxFQUFFLENBQUMsMkJBQVMsQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFLFFBQVEsQ0FBQzthQUNwQyxXQUFXLEVBQUUsQ0FBQztRQUNqQixNQUFNLFdBQVcsR0FBYSxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFLLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDaEcsSUFBSSxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUM7WUFBRSxTQUFTLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3pELENBQUM7SUFFRCxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDZixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsb0JBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDOUMsT0FBTyxFQUFFLEtBQUs7WUFDZCxLQUFLLEVBQUUsNEVBQTRFO1NBQ3BGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxpQkFBaUI7SUFDakIsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUNuSCxNQUFNLGFBQWEsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFFcEYsTUFBTSxJQUFJLEdBQUcsTUFBTSxtQkFBUTtTQUN4QixJQUFJLENBQUMsMkJBQVMsQ0FBQyxPQUFPLENBQUM7U0FDdkIsTUFBTSxDQUFDLDJCQUFTLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQztTQUNqQyxFQUFFLENBQUMsMkJBQVMsQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFLFFBQVEsQ0FBQztTQUNwQyxXQUFXLEVBQUUsQ0FBQztJQUNqQixNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUUsSUFBSSxDQUFDLElBQVksRUFBRSxPQUFPLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUU3RSxJQUFJLGNBQWMsR0FBRyxhQUFhLEVBQUUsQ0FBQztRQUNuQyxNQUFNLG1CQUFRO2FBQ1gsSUFBSSxDQUFDLDJCQUFTLENBQUMsT0FBTyxDQUFDO2FBQ3ZCLE1BQU0sQ0FBQyxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsQ0FBQzthQUNsQyxFQUFFLENBQUMsMkJBQVMsQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFFRCw2REFBNkQ7SUFDN0QsTUFBTSxhQUFhLEdBQUcsTUFBTSxtQkFBUTtTQUNqQyxJQUFJLENBQUMsMkJBQVMsQ0FBQyxTQUFTLENBQUM7U0FDekIsTUFBTSxDQUFDLFdBQVcsQ0FBQztTQUNuQixFQUFFLENBQUMsMkJBQVMsQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQztTQUMzQyxFQUFFLENBQUMsMkJBQVMsQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLFNBQVMsQ0FBQztTQUNqRCxFQUFFLENBQUMsMkJBQVMsQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLGNBQWMsQ0FBQztTQUNuRCxFQUFFLENBQUMsMkJBQVMsQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQztTQUN2QyxXQUFXLEVBQUUsQ0FBQztJQUVqQixJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3hCLE1BQU0sbUJBQVE7YUFDWCxJQUFJLENBQUMsMkJBQVMsQ0FBQyxTQUFTLENBQUM7YUFDekIsTUFBTSxDQUFDO1lBQ04sU0FBUyxFQUFFLFFBQVE7WUFDbkIsY0FBYyxFQUFFLFNBQVM7WUFDekIsV0FBVyxFQUFFLGNBQWM7WUFDM0IsS0FBSyxFQUFFLEVBQUU7WUFDVCxTQUFTLEVBQUUsSUFBSTtZQUNmLHNCQUFzQixFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1lBQ2hELFlBQVksRUFBRSxDQUFDO1NBQ2hCLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFDZCxPQUFPLEVBQUUsSUFBSTtRQUNiLE9BQU8sRUFBRSxxQ0FBcUM7UUFDOUMsSUFBSSxFQUFFO1lBQ0osUUFBUTtZQUNSLFNBQVM7WUFDVCxPQUFPLEVBQUUsYUFBYTtTQUN2QjtLQUNGLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFFSjs7O0dBR0c7QUFDSCxNQUFNLENBQUMsTUFBTSxDQUFDLCtCQUErQixFQUFFLElBQUEsMkJBQVksRUFBQyxLQUFLLEVBQUUsR0FBZ0IsRUFBRSxHQUFhLEVBQUUsRUFBRTtJQUNwRyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQVEsQ0FBQyxRQUFRLENBQUMsS0FBSyxNQUFNLEVBQUUsQ0FBQztRQUM5QyxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsb0JBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDNUMsT0FBTyxFQUFFLEtBQUs7WUFDZCxLQUFLLEVBQUUsaUNBQWMsQ0FBQyxnQkFBZ0I7U0FDdkMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFZLENBQUM7SUFFOUIsbUNBQW1DO0lBQ25DLE1BQU0sU0FBUyxHQUFHLE1BQU0saURBQXVCLENBQUMseUJBQXlCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEYsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2YsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLG9CQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsaUNBQWMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLENBQUM7SUFDNUcsQ0FBQztJQUVELE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDdEMsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUM7SUFFbEMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ2hCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxvQkFBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLHFCQUFxQixFQUFFLENBQUMsQ0FBQztJQUNwRyxDQUFDO0lBRUQsOEVBQThFO0lBQzlFLE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSxtQkFBUTtTQUNuQyxJQUFJLENBQUMsMkJBQVMsQ0FBQyxTQUFTLENBQUM7U0FDekIsTUFBTSxFQUFFO1NBQ1IsRUFBRSxDQUFDLDJCQUFTLENBQUMsU0FBUyxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUM7U0FDM0MsRUFBRSxDQUFDLDJCQUFTLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxVQUFVLENBQUM7U0FDL0MsRUFBRSxDQUFDLDJCQUFTLENBQUMsU0FBUyxDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUM7U0FDeEMsTUFBTSxDQUFDLDJCQUFTLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBRWxDLElBQUksS0FBSyxFQUFFLENBQUM7UUFDVixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsb0JBQVcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO0lBQ3RHLENBQUM7SUFFRCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFDZCxPQUFPLEVBQUUsSUFBSTtRQUNiLE9BQU8sRUFBRSxXQUFXLElBQUksRUFBRSxNQUFNLElBQUksQ0FBQyx3Q0FBd0MsVUFBVSxFQUFFO1FBQ3pGLElBQUksRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxJQUFJLENBQUMsRUFBRTtLQUNyQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBRUosa0JBQWUsTUFBTSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxQcm9qZWN0c1xcQXR0cml0aW9uXFxwYWNrYWdlc1xcc2VydmVyXFxzcmNcXHJvdXRlc1xcZ2FtZVxcdGVzdC1zZWVkcy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogVGVzdCBTZWVkaW5nIFJvdXRlc1xyXG4gKiBcclxuICogVGVzdC1vbmx5IGVuZHBvaW50cyBmb3Igc2VlZGluZyBkYXRhIGluIEUyRSB0ZXN0aW5nIGVudmlyb25tZW50cy5cclxuICogQWxsIHJvdXRlcyBhcmUgZ3VhcmRlZCBieSBOT0RFX0VOViA9PT0gJ3Rlc3QnIGNoZWNrLlxyXG4gKi9cclxuXHJcbmltcG9ydCB7IFJvdXRlciwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcclxuaW1wb3J0IHsgc3VwYWJhc2UgfSBmcm9tICcuLi8uLi9jb25maWcvc3VwYWJhc2UnO1xyXG5pbXBvcnQgeyBhc3luY0hhbmRsZXIgfSBmcm9tICcuLi8uLi9taWRkbGV3YXJlL2Vycm9ySGFuZGxlcic7XHJcbmltcG9ydCB7IGF1dGhlbnRpY2F0ZSwgQXV0aFJlcXVlc3QgfSBmcm9tICcuLi8uLi9taWRkbGV3YXJlL2F1dGgnO1xyXG5pbXBvcnQgeyBFUlJPUl9NRVNTQUdFUyB9IGZyb20gJy4uLy4uL2NvbnN0YW50cy9yZXNwb25zZS1mb3JtYXRzJztcclxuaW1wb3J0IHsgRU5WX1ZBTFVFUyB9IGZyb20gJ0BnYW1lL3NoYXJlZCc7XHJcbmltcG9ydCB7IERCX1RBQkxFUywgREJfRklFTERTIH0gZnJvbSAnLi4vLi4vY29uc3RhbnRzL2RhdGFiYXNlLWZpZWxkcyc7XHJcbmltcG9ydCB7IEhUVFBfU1RBVFVTIH0gZnJvbSAnQGdhbWUvc2hhcmVkJztcclxuaW1wb3J0IHsgRU5WX1ZBUlMgfSBmcm9tICdAZ2FtZS9zaGFyZWQnO1xyXG5pbXBvcnQgeyBFbXBpcmVSZXNvbHV0aW9uU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2VtcGlyZS9FbXBpcmVSZXNvbHV0aW9uU2VydmljZSc7XHJcblxyXG5jb25zdCByb3V0ZXI6IFJvdXRlciA9IFJvdXRlcigpO1xyXG5cclxuLyoqXHJcbiAqIFRlc3Qtb25seSBzZWVkaW5nIGVuZHBvaW50IHRvIG1ha2UgUmVzZWFyY2ggU3RhcnQgZGV0ZXJtaW5pc3RpYyBpbiBFMkUuXHJcbiAqIEd1YXJkZWQgYnkgTk9ERV9FTlYgPT09ICd0ZXN0J1xyXG4gKi9cclxucm91dGVyLnBvc3QoJy9zZWVkLXJlc2VhcmNoJywgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXE6IEF1dGhSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XHJcbiAgaWYgKHByb2Nlc3MuZW52W0VOVl9WQVJTLk5PREVfRU5WXSAhPT0gJ3Rlc3QnKSB7XHJcbiAgICByZXR1cm4gcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5GT1JCSURERU4pLmpzb24oe1xyXG4gICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgZXJyb3I6IEVSUk9SX01FU1NBR0VTLkZFQVRVUkVfRElTQUJMRURcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLy8gVGVzdCBzZWVkIHJlc2VhcmNoIGVuZHBvaW50IG5vdyB1c2VzIG9ubHkgU3VwYWJhc2UgaW1wbGVtZW50YXRpb25cclxuICByZXR1cm4gcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5OT1RfSU1QTEVNRU5URUQpLmpzb24oe1xyXG4gICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICBlcnJvcjogJ1Rlc3Qgc2VlZGluZyBub3QgeWV0IGZ1bGx5IGltcGxlbWVudGVkIGZvciByZXNlYXJjaCdcclxuICB9KTtcclxufSkpO1xyXG5cclxuLyoqXHJcbiAqIFRlc3Qtb25seSBzZWVkaW5nIGVuZHBvaW50IHRvIG1ha2UgRGVmZW5zZXMgU3RhcnQgZGV0ZXJtaW5pc3RpYyBpbiBFMkUuXHJcbiAqIC0gVG9wcyB1cCBjcmVkaXRzXHJcbiAqIC0gRW5zdXJlcyB0ZWNoIHByZXJlcXMgZm9yIGp1bXBfZ2F0ZSAod2FycF9kcml2ZSAxMiwgZW5lcmd5IDIwKVxyXG4gKiAtIEVuc3VyZXMgcG9zaXRpdmUgZW5lcmd5IHByb2plY3Rpb24gYnkgYWRkaW5nIGFjdGl2ZSBzb2xhciBwbGFudHMgYXQgdGhlIGJhc2VcclxuICogR3VhcmRlZCBieSBOT0RFX0VOViA9PT0gJ3Rlc3QnXHJcbiAqL1xyXG5yb3V0ZXIucG9zdCgnL3NlZWQtZGVmZW5zZXMnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcTogQXV0aFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICBpZiAocHJvY2Vzcy5lbnZbRU5WX1ZBUlMuTk9ERV9FTlZdICE9PSAndGVzdCcpIHtcclxuICAgIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLkZPUkJJRERFTikuanNvbih7XHJcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICBlcnJvcjogRVJST1JfTUVTU0FHRVMuRkVBVFVSRV9ESVNBQkxFRFxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvLyBUZXN0IHNlZWQgZGVmZW5zZXMgZW5kcG9pbnQgbm93IHVzZXMgb25seSBTdXBhYmFzZSBpbXBsZW1lbnRhdGlvblxyXG4gIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLk5PVF9JTVBMRU1FTlRFRCkuanNvbih7XHJcbiAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgIGVycm9yOiAnVGVzdCBzZWVkaW5nIG5vdCB5ZXQgZnVsbHkgaW1wbGVtZW50ZWQgZm9yIGRlZmVuc2VzJ1xyXG4gIH0pO1xyXG59KSk7XHJcblxyXG4vKipcclxuICogVGVzdC1vbmx5IHNlZWRpbmcgZW5kcG9pbnQgdG8gbWFrZSBTdHJ1Y3R1cmVzIFN0YXJ0IGRldGVybWluaXN0aWMgaW4gRTJFLlxyXG4gKiAtIFRvcHMgdXAgY3JlZGl0c1xyXG4gKiAtIEJyb2FkbHkgcmFpc2VzIHRlY2ggbGV2ZWxzIHNvIG1vc3Qgc3RydWN0dXJlcyBhcmUgZWxpZ2libGVcclxuICogLSBFbnN1cmVzIHBvc2l0aXZlIGVuZXJneSBwcm9qZWN0aW9uIGFuZCBjb25zdHJ1Y3Rpb24gY2FwYWNpdHkgKHNvbGFyICsgcm9ib3RpY3MpXHJcbiAqIEd1YXJkZWQgYnkgTk9ERV9FTlYgPT09ICd0ZXN0J1xyXG4gKi9cclxucm91dGVyLnBvc3QoJy9zZWVkLXN0cnVjdHVyZXMnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcTogQXV0aFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICBpZiAocHJvY2Vzcy5lbnZbRU5WX1ZBUlMuTk9ERV9FTlZdICE9PSAndGVzdCcpIHtcclxuICAgIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLkZPUkJJRERFTikuanNvbih7XHJcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICBlcnJvcjogRVJST1JfTUVTU0FHRVMuRkVBVFVSRV9ESVNBQkxFRFxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvLyBUZXN0IHNlZWRpbmcgZW5kcG9pbnQgdXNlcyBTdXBhYmFzZSBpbXBsZW1lbnRhdGlvblxyXG4gIGNvbnN0IHVzZXIgPSByZXEudXNlciEgYXMgYW55O1xyXG5cclxuICAvLyBSZXNvbHZlIGVtcGlyZSB1c2luZyB0aGUgc2VydmljZVxyXG4gIGNvbnN0IGVtcGlyZVJvdyA9IGF3YWl0IEVtcGlyZVJlc29sdXRpb25TZXJ2aWNlLnJlc29sdmVFbXBpcmVCeVVzZXJPYmplY3QodXNlcik7XHJcbiAgaWYgKCFlbXBpcmVSb3cpIHtcclxuICAgIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLk5PVF9GT1VORCkuanNvbih7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogRVJST1JfTUVTU0FHRVMuRU1QSVJFX05PVF9GT1VORCB9KTtcclxuICB9XHJcblxyXG4gIGNvbnN0IGVtcGlyZUlkID0gU3RyaW5nKGVtcGlyZVJvdy5pZCk7XHJcblxyXG4gIC8vIERldGVybWluZSB0YXJnZXQgYmFzZSBjb29yZGluYXRlXHJcbiAgbGV0IGJhc2VDb29yZCA9ICcnO1xyXG4gIHRyeSB7XHJcbiAgICBiYXNlQ29vcmQgPSBTdHJpbmcoKHJlcS5ib2R5Py5iYXNlQ29vcmQgPz8gJycpKS50cmltKCk7XHJcbiAgfSBjYXRjaCB7IGJhc2VDb29yZCA9ICcnOyB9XHJcbiAgXHJcbiAgaWYgKCFiYXNlQ29vcmQpIHtcclxuICAgIGNvbnN0IGVtcCA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgIC5mcm9tKERCX1RBQkxFUy5FTVBJUkVTKVxyXG4gICAgICAuc2VsZWN0KERCX0ZJRUxEUy5FTVBJUkVTLlRFUlJJVE9SSUVTKVxyXG4gICAgICAuZXEoREJfRklFTERTLkJVSUxESU5HUy5JRCwgZW1waXJlSWQpXHJcbiAgICAgIC5tYXliZVNpbmdsZSgpO1xyXG4gICAgY29uc3QgdGVycml0b3JpZXM6IHN0cmluZ1tdID0gQXJyYXkuaXNBcnJheShlbXAuZGF0YT8udGVycml0b3JpZXMpID8gZW1wLmRhdGEhLnRlcnJpdG9yaWVzIDogW107XHJcbiAgICBpZiAodGVycml0b3JpZXMubGVuZ3RoID4gMCkgYmFzZUNvb3JkID0gdGVycml0b3JpZXNbMF07XHJcbiAgfVxyXG4gIFxyXG4gIGlmICghYmFzZUNvb3JkKSB7XHJcbiAgICByZXR1cm4gcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5CQURfUkVRVUVTVCkuanNvbih7XHJcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICBlcnJvcjogJ05vIGJhc2UgY29vcmRpbmF0ZSBhdmFpbGFibGUgdG8gc2VlZCAocHJvdmlkZSBiYXNlQ29vcmQgb3IgY29sb25pemUgZmlyc3QpJ1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvLyBUb3AgdXAgY3JlZGl0c1xyXG4gIGNvbnN0IGNyZWRpdHNUYXJnZXRSYXcgPSAocmVxLmJvZHkgJiYgdHlwZW9mIHJlcS5ib2R5LmNyZWRpdHMgIT09ICd1bmRlZmluZWQnKSA/IE51bWJlcihyZXEuYm9keS5jcmVkaXRzKSA6IDEwMDAwMDtcclxuICBjb25zdCBjcmVkaXRzVGFyZ2V0ID0gTnVtYmVyLmlzRmluaXRlKGNyZWRpdHNUYXJnZXRSYXcpID8gY3JlZGl0c1RhcmdldFJhdyA6IDEwMDAwMDtcclxuXHJcbiAgY29uc3QgZVJvdyA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAuZnJvbShEQl9UQUJMRVMuRU1QSVJFUylcclxuICAgIC5zZWxlY3QoREJfRklFTERTLkVNUElSRVMuQ1JFRElUUylcclxuICAgIC5lcShEQl9GSUVMRFMuQlVJTERJTkdTLklELCBlbXBpcmVJZClcclxuICAgIC5tYXliZVNpbmdsZSgpO1xyXG4gIGNvbnN0IGN1cnJlbnRDcmVkaXRzID0gTWF0aC5tYXgoMCwgTnVtYmVyKChlUm93LmRhdGEgYXMgYW55KT8uY3JlZGl0cyB8fCAwKSk7XHJcbiAgXHJcbiAgaWYgKGN1cnJlbnRDcmVkaXRzIDwgY3JlZGl0c1RhcmdldCkge1xyXG4gICAgYXdhaXQgc3VwYWJhc2VcclxuICAgICAgLmZyb20oREJfVEFCTEVTLkVNUElSRVMpXHJcbiAgICAgIC51cGRhdGUoeyBjcmVkaXRzOiBjcmVkaXRzVGFyZ2V0IH0pXHJcbiAgICAgIC5lcShEQl9GSUVMRFMuQlVJTERJTkdTLklELCBlbXBpcmVJZCk7XHJcbiAgfVxyXG5cclxuICAvLyBFbnN1cmUgcG9zaXRpdmUgZW5lcmd5IHByb2plY3Rpb24gd2l0aCBhY3RpdmUgc29sYXIgcGxhbnRzXHJcbiAgY29uc3QgZXhpc3RpbmdTb2xhciA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAuZnJvbShEQl9UQUJMRVMuQlVJTERJTkdTKVxyXG4gICAgLnNlbGVjdCgnaWQsIGxldmVsJylcclxuICAgIC5lcShEQl9GSUVMRFMuQlVJTERJTkdTLkVNUElSRV9JRCwgZW1waXJlSWQpXHJcbiAgICAuZXEoREJfRklFTERTLkJVSUxESU5HUy5MT0NBVElPTl9DT09SRCwgYmFzZUNvb3JkKVxyXG4gICAgLmVxKERCX0ZJRUxEUy5CVUlMRElOR1MuQ0FUQUxPR19LRVksICdzb2xhcl9wbGFudHMnKVxyXG4gICAgLmVxKERCX0ZJRUxEUy5CVUlMRElOR1MuSVNfQUNUSVZFLCB0cnVlKVxyXG4gICAgLm1heWJlU2luZ2xlKCk7XHJcblxyXG4gIGlmICghZXhpc3RpbmdTb2xhci5kYXRhKSB7XHJcbiAgICBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAuZnJvbShEQl9UQUJMRVMuQlVJTERJTkdTKVxyXG4gICAgICAuaW5zZXJ0KHtcclxuICAgICAgICBlbXBpcmVfaWQ6IGVtcGlyZUlkLFxyXG4gICAgICAgIGxvY2F0aW9uX2Nvb3JkOiBiYXNlQ29vcmQsXHJcbiAgICAgICAgY2F0YWxvZ19rZXk6ICdzb2xhcl9wbGFudHMnLFxyXG4gICAgICAgIGxldmVsOiAzMCxcclxuICAgICAgICBpc19hY3RpdmU6IHRydWUsXHJcbiAgICAgICAgY29uc3RydWN0aW9uX2NvbXBsZXRlZDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gICAgICAgIGNyZWRpdHNfY29zdDogMCxcclxuICAgICAgfSk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gcmVzLmpzb24oe1xyXG4gICAgc3VjY2VzczogdHJ1ZSxcclxuICAgIG1lc3NhZ2U6ICdUZXN0IHN0cnVjdHVyZXMgc2VlZGVkIHN1Y2Nlc3NmdWxseScsXHJcbiAgICBkYXRhOiB7XHJcbiAgICAgIGVtcGlyZUlkLFxyXG4gICAgICBiYXNlQ29vcmQsXHJcbiAgICAgIGNyZWRpdHM6IGNyZWRpdHNUYXJnZXRcclxuICAgIH1cclxuICB9KTtcclxufSkpO1xyXG5cclxuLyoqXHJcbiAqIFRlc3Qtb25seSBlbmRwb2ludCB0byBkZWxldGUgcXVldWVkIGJ1aWxkaW5ncyBieSBjYXRhbG9nIGtleS5cclxuICogR3VhcmRlZCBieSBOT0RFX0VOViA9PT0gJ3Rlc3QnXHJcbiAqL1xyXG5yb3V0ZXIuZGVsZXRlKCcvYnVpbGRpbmdzL3F1ZXVlZC86Y2F0YWxvZ0tleScsIGFzeW5jSGFuZGxlcihhc3luYyAocmVxOiBBdXRoUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xyXG4gIGlmIChwcm9jZXNzLmVudltFTlZfVkFSUy5OT0RFX0VOVl0gIT09ICd0ZXN0Jykge1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuRk9SQklEREVOKS5qc29uKHtcclxuICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgIGVycm9yOiBFUlJPUl9NRVNTQUdFUy5GRUFUVVJFX0RJU0FCTEVEXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGNvbnN0IHVzZXIgPSByZXEudXNlciEgYXMgYW55O1xyXG5cclxuICAvLyBSZXNvbHZlIGVtcGlyZSB1c2luZyB0aGUgc2VydmljZVxyXG4gIGNvbnN0IGVtcGlyZVJvdyA9IGF3YWl0IEVtcGlyZVJlc29sdXRpb25TZXJ2aWNlLnJlc29sdmVFbXBpcmVCeVVzZXJPYmplY3QodXNlcik7XHJcbiAgaWYgKCFlbXBpcmVSb3cpIHtcclxuICAgIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLk5PVF9GT1VORCkuanNvbih7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogRVJST1JfTUVTU0FHRVMuRU1QSVJFX05PVF9GT1VORCB9KTtcclxuICB9XHJcblxyXG4gIGNvbnN0IGVtcGlyZUlkID0gU3RyaW5nKGVtcGlyZVJvdy5pZCk7XHJcbiAgY29uc3QgeyBjYXRhbG9nS2V5IH0gPSByZXEucGFyYW1zO1xyXG4gIFxyXG4gIGlmICghY2F0YWxvZ0tleSkge1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuQkFEX1JFUVVFU1QpLmpzb24oeyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICdjYXRhbG9nS2V5IHJlcXVpcmVkJyB9KTtcclxuICB9XHJcblxyXG4gIC8vIFJlbW92ZSBhbnkgaW5hY3RpdmUgKHF1ZXVlZCkgYnVpbGRpbmdzIHdpdGggdGhpcyBjYXRhbG9nS2V5IGZvciB0aGlzIGVtcGlyZVxyXG4gIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAuZnJvbShEQl9UQUJMRVMuQlVJTERJTkdTKVxyXG4gICAgLmRlbGV0ZSgpXHJcbiAgICAuZXEoREJfRklFTERTLkJVSUxESU5HUy5FTVBJUkVfSUQsIGVtcGlyZUlkKVxyXG4gICAgLmVxKERCX0ZJRUxEUy5CVUlMRElOR1MuQ0FUQUxPR19LRVksIGNhdGFsb2dLZXkpXHJcbiAgICAuZXEoREJfRklFTERTLkJVSUxESU5HUy5JU19BQ1RJVkUsIGZhbHNlKVxyXG4gICAgLnNlbGVjdChEQl9GSUVMRFMuQlVJTERJTkdTLklEKTtcclxuXHJcbiAgaWYgKGVycm9yKSB7XHJcbiAgICByZXR1cm4gcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5JTlRFUk5BTF9TRVJWRVJfRVJST1IpLmpzb24oeyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfSk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gcmVzLmpzb24oe1xyXG4gICAgc3VjY2VzczogdHJ1ZSxcclxuICAgIG1lc3NhZ2U6IGBEZWxldGVkICR7ZGF0YT8ubGVuZ3RoID8/IDB9IHF1ZXVlZCBidWlsZGluZyhzKSB3aXRoIGNhdGFsb2dLZXk6ICR7Y2F0YWxvZ0tleX1gLFxyXG4gICAgZGF0YTogeyBkZWxldGVkOiBkYXRhPy5sZW5ndGggPz8gMCB9XHJcbiAgfSk7XHJcbn0pKTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IHJvdXRlcjtcclxuIl0sInZlcnNpb24iOjN9