{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\routes\\game\\test-seeds.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\routes\\game\\test-seeds.ts"],"sourcesContent":["/**\r\n * Test Seeding Routes\r\n * \r\n * Test-only endpoints for seeding data in E2E testing environments.\r\n * All routes are guarded by NODE_ENV === 'test' check.\r\n */\r\n\r\nimport { Router, Response } from 'express';\r\nimport { supabase } from '../../config/supabase';\r\nimport { asyncHandler } from '../../middleware/errorHandler';\r\nimport { authenticate, AuthRequest } from '../../middleware/auth';\r\nimport { ERROR_MESSAGES } from '../../constants/response-formats';\r\nimport { ENV_VALUES } from '@game/shared';\r\nimport { DB_TABLES, DB_FIELDS } from '../../constants/database-fields';\r\nimport { HTTP_STATUS } from '@game/shared';\r\nimport { ENV_VARS } from '@game/shared';\r\nimport { EmpireResolutionService } from '../../services/empire/EmpireResolutionService';\r\n\r\nconst router: Router = Router();\r\n\r\n/**\r\n * Test-only seeding endpoint to make Research Start deterministic in E2E.\r\n * Guarded by NODE_ENV === 'test'\r\n */\r\nrouter.post('/seed-research', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  if (process.env[ENV_VARS.NODE_ENV] !== 'test') {\r\n    return res.status(HTTP_STATUS.FORBIDDEN).json({\r\n      success: false,\r\n      error: ERROR_MESSAGES.FEATURE_DISABLED\r\n    });\r\n  }\r\n\r\n  // Test seed research endpoint now uses only Supabase implementation\r\n  return res.status(HTTP_STATUS.NOT_IMPLEMENTED).json({\r\n    success: false,\r\n    error: 'Test seeding not yet fully implemented for research'\r\n  });\r\n}));\r\n\r\n/**\r\n * Test-only seeding endpoint to make Defenses Start deterministic in E2E.\r\n * - Tops up credits\r\n * - Ensures tech prereqs for jump_gate (warp_drive 12, energy 20)\r\n * - Ensures positive energy projection by adding active solar plants at the base\r\n * Guarded by NODE_ENV === 'test'\r\n */\r\nrouter.post('/seed-defenses', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  if (process.env[ENV_VARS.NODE_ENV] !== 'test') {\r\n    return res.status(HTTP_STATUS.FORBIDDEN).json({\r\n      success: false,\r\n      error: ERROR_MESSAGES.FEATURE_DISABLED\r\n    });\r\n  }\r\n\r\n  // Test seed defenses endpoint now uses only Supabase implementation\r\n  return res.status(HTTP_STATUS.NOT_IMPLEMENTED).json({\r\n    success: false,\r\n    error: 'Test seeding not yet fully implemented for defenses'\r\n  });\r\n}));\r\n\r\n/**\r\n * Test-only seeding endpoint to make Structures Start deterministic in E2E.\r\n * - Tops up credits\r\n * - Broadly raises tech levels so most structures are eligible\r\n * - Ensures positive energy projection and construction capacity (solar + robotics)\r\n * Guarded by NODE_ENV === 'test'\r\n */\r\nrouter.post('/seed-structures', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  if (process.env[ENV_VARS.NODE_ENV] !== 'test') {\r\n    return res.status(HTTP_STATUS.FORBIDDEN).json({\r\n      success: false,\r\n      error: ERROR_MESSAGES.FEATURE_DISABLED\r\n    });\r\n  }\r\n\r\n  // Test seeding endpoint uses Supabase implementation\r\n  const user = req.user! as any;\r\n\r\n  // Resolve empire using the service\r\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\r\n  if (!empireRow) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\r\n  }\r\n\r\n  const empireId = String(empireRow.id);\r\n\r\n  // Determine target base coordinate\r\n  let baseCoord = '';\r\n  try {\r\n    baseCoord = String((req.body?.baseCoord ?? '')).trim();\r\n  } catch { baseCoord = ''; }\r\n  \r\n  if (!baseCoord) {\r\n    const emp = await supabase\r\n      .from(DB_TABLES.EMPIRES)\r\n      .select(DB_FIELDS.EMPIRES.TERRITORIES)\r\n      .eq(DB_FIELDS.BUILDINGS.ID, empireId)\r\n      .maybeSingle();\r\n    const territories: string[] = Array.isArray(emp.data?.territories) ? emp.data!.territories : [];\r\n    if (territories.length > 0) baseCoord = territories[0];\r\n  }\r\n  \r\n  if (!baseCoord) {\r\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({\r\n      success: false,\r\n      error: 'No base coordinate available to seed (provide baseCoord or colonize first)'\r\n    });\r\n  }\r\n\r\n  // Top up credits\r\n  const creditsTargetRaw = (req.body && typeof req.body.credits !== 'undefined') ? Number(req.body.credits) : 100000;\r\n  const creditsTarget = Number.isFinite(creditsTargetRaw) ? creditsTargetRaw : 100000;\r\n\r\n  const eRow = await supabase\r\n    .from(DB_TABLES.EMPIRES)\r\n    .select(DB_FIELDS.EMPIRES.CREDITS)\r\n    .eq(DB_FIELDS.BUILDINGS.ID, empireId)\r\n    .maybeSingle();\r\n  const currentCredits = Math.max(0, Number((eRow.data as any)?.credits || 0));\r\n  \r\n  if (currentCredits < creditsTarget) {\r\n    await supabase\r\n      .from(DB_TABLES.EMPIRES)\r\n      .update({ credits: creditsTarget })\r\n      .eq(DB_FIELDS.BUILDINGS.ID, empireId);\r\n  }\r\n\r\n  // Ensure positive energy projection with active solar plants\r\n  const existingSolar = await supabase\r\n    .from(DB_TABLES.BUILDINGS)\r\n    .select('id, level')\r\n    .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\r\n    .eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, baseCoord)\r\n    .eq(DB_FIELDS.BUILDINGS.CATALOG_KEY, 'solar_plants')\r\n    .eq(DB_FIELDS.BUILDINGS.IS_ACTIVE, true)\r\n    .maybeSingle();\r\n\r\n  if (!existingSolar.data) {\r\n    await supabase\r\n      .from(DB_TABLES.BUILDINGS)\r\n      .insert({\r\n        empire_id: empireId,\r\n        location_coord: baseCoord,\r\n        catalog_key: 'solar_plants',\r\n        level: 30,\r\n        is_active: true,\r\n        construction_completed: new Date().toISOString(),\r\n        credits_cost: 0,\r\n      });\r\n  }\r\n\r\n  return res.json({\r\n    success: true,\r\n    message: 'Test structures seeded successfully',\r\n    data: {\r\n      empireId,\r\n      baseCoord,\r\n      credits: creditsTarget\r\n    }\r\n  });\r\n}));\r\n\r\n/**\r\n * Test-only endpoint to delete queued buildings by catalog key.\r\n * Guarded by NODE_ENV === 'test'\r\n */\r\nrouter.delete('/buildings/queued/:catalogKey', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  if (process.env[ENV_VARS.NODE_ENV] !== 'test') {\r\n    return res.status(HTTP_STATUS.FORBIDDEN).json({\r\n      success: false,\r\n      error: ERROR_MESSAGES.FEATURE_DISABLED\r\n    });\r\n  }\r\n\r\n  const user = req.user! as any;\r\n\r\n  // Resolve empire using the service\r\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\r\n  if (!empireRow) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\r\n  }\r\n\r\n  const empireId = String(empireRow.id);\r\n  const { catalogKey } = req.params;\r\n  \r\n  if (!catalogKey) {\r\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'catalogKey required' });\r\n  }\r\n\r\n  // Remove any inactive (queued) buildings with this catalogKey for this empire\r\n  const { data, error } = await supabase\r\n    .from(DB_TABLES.BUILDINGS)\r\n    .delete()\r\n    .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\r\n    .eq(DB_FIELDS.BUILDINGS.CATALOG_KEY, catalogKey)\r\n    .eq(DB_FIELDS.BUILDINGS.IS_ACTIVE, false)\r\n    .select(DB_FIELDS.BUILDINGS.ID);\r\n\r\n  if (error) {\r\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({ success: false, error: error.message });\r\n  }\r\n\r\n  return res.json({\r\n    success: true,\r\n    message: `Deleted ${data?.length ?? 0} queued building(s) with catalogKey: ${catalogKey}`,\r\n    data: { deleted: data?.length ?? 0 }\r\n  });\r\n}));\r\n\r\nexport default router;\r\n"],"version":3}