{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\services\\resources\\ResourceCalculationService.ts","mappings":";;;AAAA,oDAAiD;AACjD,yCAA0D;AAC1D,8DAA2D;AAC3D,qEAAuE;AACvE,yCAAwC;AACxC,yCAA4C;AAC5C;;;GAGG;AACH,MAAa,0BAA0B;IAErC;;;;OAIG;IACH,MAAM,CAAC,sBAAsB,CAAC,MAAW;QACvC,MAAM,UAAU,GAAG,MAAM,CAAC,UAA6C,CAAC;QACxE,IAAI,CAAC,UAAU;YAAE,OAAO,qBAAY,CAAC,OAAO,CAAC;QAE7C,IAAI,UAAU,GAAG,CAAC,CAAC;QACnB,KAAK,MAAM,CAAC,OAAO,EAAE,KAAK,CAAC,IAAI,UAAU,CAAC,OAAO,EAAE,EAAE,CAAC;YACpD,IAAI,KAAK,IAAI,CAAC,EAAE,CAAC;gBACf,IAAI,CAAC;oBACH,MAAM,IAAI,GAAG,IAAA,oBAAW,EAAC,OAAwB,CAAC,CAAC;oBACnD,UAAU,IAAI,IAAI,CAAC,WAAW,CAAC;gBACjC,CAAC;gBAAC,OAAO,KAAK,EAAE,CAAC;oBACf,yBAAyB;oBACzB,OAAO,CAAC,IAAI,CAAC,qBAAqB,OAAO,EAAE,CAAC,CAAC;gBAC/C,CAAC;YACH,CAAC;QACH,CAAC;QACD,OAAO,UAAU,CAAC;IACpB,CAAC;IAED;;;;OAIG;IACH,MAAM,CAAC,kCAAkC,CAAC,SAA+E;QACvH,IAAI,KAAK,GAAG,CAAC,CAAC;QACd,KAAK,MAAM,CAAC,IAAI,SAAS,EAAE,CAAC;YAC1B,IAAI,CAAC,CAAC,CAAC,SAAS;gBAAE,SAAS;YAC3B,MAAM,GAAG,GAAG,CAAC,CAAC,CAAC,WAAW,IAAI,EAAE,CAAC,CAAC,WAAW,EAAE,CAAC;YAChD,MAAM,GAAG,GAAG,MAAM,CAAC,CAAC,CAAC,KAAK,IAAI,CAAC,CAAC,CAAC;YACjC,sEAAsE;YACtE,QAAQ,GAAG,EAAE,CAAC;gBACZ,KAAK,kBAAkB,CAAC;gBACxB,KAAK,SAAS;oBACZ,KAAK,IAAI,EAAE,GAAG,GAAG,CAAC,CAAC,uCAAuC;oBAC1D,MAAM;gBACR;oBACE,MAAM;YACV,CAAC;QACH,CAAC;QACD,OAAO,KAAK,CAAC;IACf,CAAC;IAED;;;;;OAKG;IACH,MAAM,CAAC,KAAK,CAAC,oBAAoB,CAAC,MAAW,EAAE,cAAsB;QACnE,IAAI,eAAe,GAAG,CAAC,CAAC;QAExB,IAAI,CAAC;YACH,MAAM,KAAK,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;YACzB,MAAM,aAAa,GAAI,MAAc,CAAC,oBAAiD,CAAC;YACxF,MAAM,MAAM,GAAG,aAAa,CAAC,CAAC,CAAC,IAAI,IAAI,CAAC,aAAa,CAAC,CAAC,OAAO,EAAE,CAAC,CAAC,CAAC,KAAK,CAAC;YACzE,IAAI,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,KAAK,GAAG,CAAC,MAAM,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC;YAEhF,+BAA+B;YAC/B,IAAI,OAAO,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,MAAM,CAAE,MAAc,CAAC,uBAAuB,IAAI,CAAC,CAAC,CAAC,CAAC;YAEhF,IAAI,cAAc,GAAG,CAAC,EAAE,CAAC;gBACvB,MAAM,OAAO,GAAG,SAAS,GAAG,OAAO,CAAC;gBACpC,MAAM,UAAU,GAAG,cAAc,GAAG,CAAC,OAAO,GAAG,OAAO,CAAC,CAAC;gBACxD,MAAM,SAAS,GAAG,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;gBACzC,MAAM,WAAW,GAAG,OAAO,GAAG,OAAO,CAAC;gBAEtC,IAAI,SAAS,GAAG,CAAC,IAAI,SAAS,GAAG,CAAC,IAAI,OAAO,KAAK,WAAW,EAAE,CAAC;oBAC9D,MAAM,UAAU,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,MAAM,CAAE,MAAc,CAAC,OAAO,IAAI,CAAC,CAAC,CAAC,CAAC;oBACrE,MAAM,UAAU,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,UAAU,GAAG,SAAS,CAAC,CAAC;oBACvD,eAAe,GAAG,SAAS,CAAC;oBAE5B,MAAM,EAAE,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;oBACtB,MAAM,GAAG,GAAG,MAAM,mBAAQ;yBACvB,IAAI,CAAC,2BAAS,CAAC,OAAO,CAAC;yBACvB,MAAM,CAAC;wBACN,OAAO,EAAE,UAAU;wBACnB,oBAAoB,EAAE,IAAI,IAAI,CAAC,KAAK,CAAC,CAAC,WAAW,EAAE;wBACnD,uBAAuB,EAAE,WAAW;qBACrC,CAAC;yBACD,EAAE,CAAC,2BAAS,CAAC,SAAS,CAAC,EAAE,EAAG,MAAc,CAAC,EAAE,CAAC;yBAC9C,MAAM,CAAC,4DAA4D,CAAC;yBACpE,MAAM,EAAE,CAAC;oBACZ,MAAM,EAAE,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,EAAE,CAAC;oBAE3B,IAAI,CAAC,GAAG,CAAC,KAAK,IAAI,GAAG,CAAC,IAAI,EAAE,CAAC;wBAC1B,MAAc,CAAC,OAAO,GAAG,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC;wBAC1C,MAAc,CAAC,oBAAoB,GAAG,GAAG,CAAC,IAAI,CAAC,oBAAoB,CAAC;wBACpE,MAAc,CAAC,uBAAuB,GAAG,GAAG,CAAC,IAAI,CAAC,uBAAuB,CAAC;oBAC7E,CAAC;oBAED,IAAI,OAAO,CAAC,GAAG,CAAC,iBAAQ,CAAC,aAAa,CAAC,KAAK,MAAM,EAAE,CAAC;wBACnD,OAAO,CAAC,GAAG,CAAC,WAAW,EAAE;4BACvB,QAAQ,EAAE,MAAM,CAAE,MAAc,CAAC,EAAE,CAAC;4BACpC,cAAc;4BACd,SAAS;4BACT,OAAO;4BACP,SAAS;4BACT,WAAW;4BACX,UAAU;4BACV,UAAU;4BACV,QAAQ,EAAE,EAAE;yBACb,CAAC,CAAC;oBACL,CAAC;gBACH,CAAC;YACH,CAAC;iBAAM,CAAC;gBACN,4FAA4F;gBAC5F,IAAI,SAAS,GAAG,CAAC,IAAI,OAAO,KAAK,CAAC,IAAI,CAAE,MAAc,CAAC,oBAAoB,EAAE,CAAC;oBAC5E,MAAM,mBAAQ;yBACX,IAAI,CAAC,2BAAS,CAAC,OAAO,CAAC;yBACvB,MAAM,CAAC;wBACN,oBAAoB,EAAE,IAAI,IAAI,CAAC,KAAK,CAAC,CAAC,WAAW,EAAE;wBACnD,uBAAuB,EAAE,CAAC;qBAC3B,CAAC;yBACD,EAAE,CAAC,2BAAS,CAAC,SAAS,CAAC,EAAE,EAAG,MAAc,CAAC,EAAE,CAAC,CAAC;oBACjD,MAAc,CAAC,oBAAoB,GAAG,IAAI,IAAI,CAAC,KAAK,CAAC,CAAC,WAAW,EAAE,CAAC;oBACpE,MAAc,CAAC,uBAAuB,GAAG,CAAC,CAAC;gBAC9C,CAAC;YACH,CAAC;QACH,CAAC;QAAC,MAAM,CAAC;YACP,qCAAqC;QACvC,CAAC;QAED,OAAO,EAAE,eAAe,EAAE,aAAa,EAAE,MAAM,EAAE,CAAC;IACpD,CAAC;IAED;;;;;OAKG;IACH,MAAM,CAAC,KAAK,CAAC,2BAA2B,CAAC,MAAW,EAAE,MAAc;QAWlE,sEAAsE;QACtE,MAAM,cAAc,GAAG,MAAM,+BAAc,CAAC,0BAA0B,CAAC,MAAM,CAAE,MAAc,CAAC,EAAE,CAAC,CAAC,CAAC;QAEnG,qCAAqC;QACrC,MAAM,EAAE,eAAe,EAAE,aAAa,EAAE,GAAG,MAAM,IAAI,CAAC,oBAAoB,CAAC,MAAM,EAAE,cAAc,CAAC,CAAC;QAEnG,qEAAqE;QACrE,MAAM,eAAe,GAAG,IAAI,CAAC,sBAAsB,CAAC,MAAM,CAAC,CAAC;QAC5D,MAAM,UAAU,GAAG,CAAC,CAAC;QACrB,MAAM,KAAK,GAAG,IAAI,CAAC,GAAG,CAAC,cAAc,GAAG,GAAG,GAAG,UAAU,GAAG,eAAe,EAAE,IAAI,CAAC,CAAC;QAElF,MAAM,OAAO,GAAG;YACd,cAAc,EAAE,cAAc;YAC9B,UAAU;YACV,eAAe;YACf,KAAK;SACN,CAAC;QAEF,OAAO;YACL,eAAe;YACf,cAAc;YACd,OAAO;YACP,aAAa;SACd,CAAC;IACJ,CAAC;IAED;;;;OAIG;IACH,MAAM,CAAC,KAAK,CAAC,qBAAqB,CAAC,QAAgB;QACjD,OAAO,MAAM,+BAAc,CAAC,0BAA0B,CAAC,QAAQ,CAAC,CAAC;IACnE,CAAC;CACF;AAxLD,gEAwLC","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\services\\resources\\ResourceCalculationService.ts"],"sourcesContent":["import { supabase } from '../../config/supabase';\nimport { getTechSpec, TechnologyKey } from '@game/shared';\nimport { EconomyService } from '../economy/EconomyService';\nimport { DB_TABLES, DB_FIELDS } from '../../constants/database-fields';\nimport { ENV_VARS } from '@game/shared';\nimport { STATUS_CODES } from '@game/shared';\n/**\n * Service for handling complex resource and economy calculations.\n * Extracted from dashboard route to centralize resource computation logic.\n */\nexport class ResourceCalculationService {\n\n  /**\n   * Computes technology score from researched technologies in an empire.\n   * @param empire - Empire object containing techLevels Map\n   * @returns Total technology score based on researched technology costs\n   */\n  static computeTechnologyScore(empire: any): number {\n    const techLevels = empire.techLevels as Map<string, number> | undefined;\n    if (!techLevels) return STATUS_CODES.SUCCESS;\n\n    let totalScore = 0;\n    for (const [techKey, level] of techLevels.entries()) {\n      if (level >= 1) {\n        try {\n          const spec = getTechSpec(techKey as TechnologyKey);\n          totalScore += spec.creditsCost;\n        } catch (error) {\n          // Skip unknown tech keys\n          console.warn(`Unknown tech key: ${techKey}`);\n        }\n      }\n    }\n    return totalScore;\n  }\n\n  /**\n   * Computes economy per hour from active buildings using a simple catalog mapping.\n   * @param buildings - Array of building objects with catalog_key, level, and is_active properties\n   * @returns Total economy per hour from active buildings\n   */\n  static computeEconomyPerHourFromBuildings(buildings: Array<{ catalog_key?: string; level?: number; is_active?: boolean }>): number {\n    let total = 0;\n    for (const b of buildings) {\n      if (!b.is_active) continue;\n      const key = (b.catalog_key || '').toLowerCase();\n      const lvl = Number(b.level || 1);\n      // Simple mapping (can be refined later or loaded from shared catalog)\n      switch (key) {\n        case 'urban_structures':\n        case 'habitat':\n          total += 50 * lvl; // placeholder yield per hour per level\n          break;\n        default:\n          break;\n      }\n    }\n    return total;\n  }\n\n  /**\n   * Performs complex credit accrual calculation with time-based increments and database updates.\n   * @param empire - Empire object with credits, last_resource_update, and credits_remainder_milli\n   * @param creditsPerHour - Credits per hour rate for the empire\n   * @returns Object containing resourcesGained amount and updated empire data\n   */\n  static async performCreditAccrual(empire: any, creditsPerHour: number): Promise<{ resourcesGained: number; updatedEmpire: any }> {\n    let resourcesGained = 0;\n\n    try {\n      const nowTs = Date.now();\n      const lastUpdateRaw = (empire as any).last_resource_update as string | null | undefined;\n      const lastTs = lastUpdateRaw ? new Date(lastUpdateRaw).getTime() : nowTs;\n      let elapsedMs = Math.max(0, nowTs - (Number.isFinite(lastTs) ? lastTs : nowTs));\n\n      // Carry remainder milliseconds\n      let carryMs = Math.max(0, Number((empire as any).credits_remainder_milli || 0));\n\n      if (creditsPerHour > 0) {\n        const totalMs = elapsedMs + carryMs;\n        const fractional = creditsPerHour * (totalMs / 3600000);\n        const increment = Math.floor(fractional);\n        const remainderMs = totalMs % 3600000;\n\n        if (increment > 0 || elapsedMs > 0 || carryMs !== remainderMs) {\n          const oldCredits = Math.max(0, Number((empire as any).credits || 0));\n          const newCredits = Math.max(0, oldCredits + increment);\n          resourcesGained = increment;\n\n          const t0 = Date.now();\n          const upd = await supabase\n            .from(DB_TABLES.EMPIRES)\n            .update({\n              credits: newCredits,\n              last_resource_update: new Date(nowTs).toISOString(),\n              credits_remainder_milli: remainderMs,\n            })\n            .eq(DB_FIELDS.BUILDINGS.ID, (empire as any).id)\n            .select('id, credits, last_resource_update, credits_remainder_milli')\n            .single();\n          const dt = Date.now() - t0;\n\n          if (!upd.error && upd.data) {\n            (empire as any).credits = upd.data.credits;\n            (empire as any).last_resource_update = upd.data.last_resource_update;\n            (empire as any).credits_remainder_milli = upd.data.credits_remainder_milli;\n          }\n\n          if (process.env[ENV_VARS.ECONOMY_DEBUG] === 'true') {\n            console.log('[ACCRUAL]', {\n              empireId: String((empire as any).id),\n              creditsPerHour,\n              elapsedMs,\n              carryMs,\n              increment,\n              remainderMs,\n              oldCredits,\n              newCredits,\n              updateMs: dt,\n            });\n          }\n        }\n      } else {\n        // No economy rate; still advance the timestamp and clear remainder to avoid unbounded carry\n        if (elapsedMs > 0 || carryMs !== 0 || !(empire as any).last_resource_update) {\n          await supabase\n            .from(DB_TABLES.EMPIRES)\n            .update({\n              last_resource_update: new Date(nowTs).toISOString(),\n              credits_remainder_milli: 0,\n            })\n            .eq(DB_FIELDS.BUILDINGS.ID, (empire as any).id);\n          (empire as any).last_resource_update = new Date(nowTs).toISOString();\n          (empire as any).credits_remainder_milli = 0;\n        }\n      }\n    } catch {\n      // Non-fatal: leave credits unchanged\n    }\n\n    return { resourcesGained, updatedEmpire: empire };\n  }\n\n  /**\n   * Calculates comprehensive dashboard resources including accrual, profile, and current state.\n   * @param empire - Empire object\n   * @param userId - User ID for context (currently unused but reserved for future features)\n   * @returns Dashboard resources object with computed values\n   */\n  static async calculateDashboardResources(empire: any, userId: string): Promise<{\n    resourcesGained: number;\n    creditsPerHour: number;\n    profile: {\n      economyPerHour: number;\n      fleetScore: number;\n      technologyScore: number;\n      level: number;\n    };\n    updatedEmpire: any;\n  }> {\n    // Compute credits per hour from Supabase buildings via catalog yields\n    const creditsPerHour = await EconomyService.sumCreditsPerHourForEmpire(String((empire as any).id));\n\n    // Perform credit accrual calculation\n    const { resourcesGained, updatedEmpire } = await this.performCreditAccrual(empire, creditsPerHour);\n\n    // Calculate profile scores (fleet score is currently hardcoded to 0)\n    const technologyScore = this.computeTechnologyScore(empire);\n    const fleetScore = 0;\n    const level = Math.pow(creditsPerHour * 100 + fleetScore + technologyScore, 0.25);\n\n    const profile = {\n      economyPerHour: creditsPerHour,\n      fleetScore,\n      technologyScore,\n      level,\n    };\n\n    return {\n      resourcesGained,\n      creditsPerHour,\n      profile,\n      updatedEmpire,\n    };\n  }\n\n  /**\n   * Legacy method for backward compatibility - computes credits per hour for a specific empire.\n   * @param empireId - Empire ID string\n   * @returns Credits per hour for the empire\n   */\n  static async computeCreditsPerHour(empireId: string): Promise<number> {\n    return await EconomyService.sumCreditsPerHourForEmpire(empireId);\n  }\n}\n"],"version":3}