{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\utils\\securityMonitor.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\utils\\securityMonitor.ts"],"sourcesContent":["/**\n * Advanced Security Monitoring and Session Invalidation System\n * \n * Provides comprehensive monitoring of authentication events and automatic\n * session invalidation when suspicious patterns are detected.\n */\n\nimport { DB_FIELDS, ENV_VARS } from '@game/shared';\n\nimport { Request } from 'express';\nimport { EventEmitter } from 'events';\nimport { revokeToken } from '../middleware/auth';\nimport { DeviceFingerprint, generateDeviceFingerprint, compareDeviceFingerprints } from './deviceFingerprint';\n\nexport interface SecurityEvent {\n  id: string;\n  type: SecurityEventType;\n  userId?: string;\n  ip: string;\n  userAgent: string;\n  timestamp: Date;\n  details: any;\n  riskScore: number;\n  location?: {\n    country?: string;\n    region?: string;\n    city?: string;\n  };\n}\n\nexport enum SecurityEventType {\n  LOGIN_SUCCESS = 'LOGIN_SUCCESS',\n  LOGIN_FAILED = 'LOGIN_FAILED',\n  LOGIN_BRUTE_FORCE = 'LOGIN_BRUTE_FORCE',\n  TOKEN_REFRESH = 'TOKEN_REFRESH',\n  TOKEN_REVOKED = 'TOKEN_REVOKED',\n  DEVICE_CHANGE = 'DEVICE_CHANGE',\n  SUSPICIOUS_IP = 'SUSPICIOUS_IP',\n  MULTIPLE_CONCURRENT_SESSIONS = 'MULTIPLE_CONCURRENT_SESSIONS',\n  UNUSUAL_ACCESS_PATTERN = 'UNUSUAL_ACCESS_PATTERN',\n  SECURITY_VIOLATION = 'SECURITY_VIOLATION'\n}\n\nexport enum ThreatLevel {\n  LOW = 'LOW',\n  MEDIUM = 'MEDIUM',\n  HIGH = 'HIGH',\n  CRITICAL = 'CRITICAL'\n}\n\nexport interface UserSessionInfo {\n  userId: string;\n  sessionId: string;\n  deviceFingerprint: DeviceFingerprint;\n  ip: string;\n  userAgent: string;\n  lastActivity: Date;\n  loginTime: Date;\n  tokenJti?: string;\n  isActive: boolean;\n}\n\nexport interface SuspiciousPattern {\n  type: string;\n  description: string;\n  riskScore: number;\n  threatLevel: ThreatLevel;\n  autoAction?: 'REVOKE_TOKEN' | 'LOCK_ACCOUNT' | 'ALERT_ONLY';\n}\n\n/**\n * Advanced Security Monitor with pattern detection and automated response\n */\nexport class SecurityMonitor extends EventEmitter {\n  private events: SecurityEvent[] = [];\n  private userSessions: Map<string, UserSessionInfo[]> = new Map();\n  private ipReputationCache: Map<string, { score: number; lastChecked: Date }> = new Map();\n  private suspiciousPatterns: Map<string, SuspiciousPattern[]> = new Map();\n  \n  private readonly config = {\n    maxEventsRetention: parseInt(process.env[ENV_VARS.SECURITY_EVENTS_RETENTION] || '10000'),\n    maxSessionsPerUser: parseInt(process.env[ENV_VARS.MAX_SESSIONS_PER_USER] || '5'),\n    deviceFingerprintThreshold: parseFloat(process.env[ENV_VARS.DEVICE_FINGERPRINT_THRESHOLD] || '0.7'),\n    autoRevokeOnSuspicious: process.env[ENV_VARS.AUTO_REVOKE_ON_SUSPICIOUS] === 'true',\n    alertThresholds: {\n      failedLogins: parseInt(process.env.FAILED_LOGIN_THRESHOLD || '10'),\n      deviceChanges: parseInt(process.env.DEVICE_CHANGE_THRESHOLD || '3'),\n      ipChanges: parseInt(process.env.IP_CHANGE_THRESHOLD || '5'),\n      concurrentSessions: parseInt(process.env.CONCURRENT_SESSION_THRESHOLD || '3')\n    }\n  };\n\n  constructor() {\n    super();\n    this.startCleanupTasks();\n    this.setupPatternDetection();\n  }\n\n  /**\n   * Record a security event and analyze for suspicious patterns\n   */\n  recordEvent(event: Omit<SecurityEvent, 'id' | 'timestamp' | 'riskScore'>): SecurityEvent {\n    const fullEvent: SecurityEvent = {\n      ...event,\n      id: this.generateEventId(),\n      timestamp: new Date(),\n      riskScore: this.calculateRiskScore(event)\n    };\n\n    this.events.push(fullEvent);\n    this.trimEvents();\n\n    // Analyze patterns and take action if needed\n    this.analyzePatterns(fullEvent);\n\n    // Emit event for external listeners\n    this.emit('securityEvent', fullEvent);\n\n    return fullEvent;\n  }\n\n  /**\n   * Create or update user session information\n   */\n  createSession(userId: string, req: Request, tokenJti?: string): UserSessionInfo {\n    const deviceFingerprint = generateDeviceFingerprint(req);\n    const sessionId = this.generateSessionId();\n    const ip = req.ip || req.connection.remoteAddress || 'unknown';\n    const userAgent = req.get('User-Agent') || 'unknown';\n\n    const session: UserSessionInfo = {\n      userId,\n      sessionId,\n      deviceFingerprint,\n      ip,\n      userAgent,\n      lastActivity: new Date(),\n      loginTime: new Date(),\n      tokenJti,\n      isActive: true\n    };\n\n    // Add to user sessions\n    const userSessions = this.userSessions.get(userId) || [];\n    userSessions.push(session);\n\n    // Check for concurrent session limits\n    if (userSessions.length > this.config.maxSessionsPerUser) {\n      this.recordEvent({\n        type: SecurityEventType.MULTIPLE_CONCURRENT_SESSIONS,\n        userId,\n        ip,\n        userAgent,\n        details: { \n          sessionCount: userSessions.length,\n          maxAllowed: this.config.maxSessionsPerUser\n        }\n      });\n\n      // Revoke oldest sessions\n      const sessionsToRevoke = userSessions\n        .sort((a, b) => a.lastActivity.getTime() - b.lastActivity.getTime())\n        .slice(0, userSessions.length - this.config.maxSessionsPerUser);\n\n      for (const sessionToRevoke of sessionsToRevoke) {\n        this.revokeSession(sessionToRevoke);\n      }\n    }\n\n    this.userSessions.set(userId, userSessions);\n\n    // Check for device fingerprint changes\n    this.checkDeviceChanges(userId, deviceFingerprint, ip, userAgent);\n\n    return session;\n  }\n\n  /**\n   * Update session activity\n   */\n  updateSessionActivity(userId: string, sessionId: string): void {\n    const sessions = this.userSessions.get(userId);\n    if (sessions) {\n      const session = sessions.find(s => s.sessionId === sessionId);\n      if (session) {\n        session.lastActivity = new Date();\n      }\n    }\n  }\n\n  /**\n   * Revoke a user session\n   */\n  revokeSession(session: UserSessionInfo): void {\n    session.isActive = false;\n    \n    if (session.tokenJti) {\n      revokeToken(session.tokenJti);\n    }\n\n    this.recordEvent({\n      type: SecurityEventType.TOKEN_REVOKED,\n      userId: session.userId,\n      ip: session.ip,\n      userAgent: session.userAgent,\n      details: {\n        reason: 'Suspicious activity detected',\n        sessionId: session.sessionId\n      }\n    });\n  }\n\n  /**\n   * Check for suspicious device fingerprint changes\n   */\n  private checkDeviceChanges(userId: string, currentFingerprint: DeviceFingerprint, ip: string, userAgent: string): void {\n    const existingSessions = this.userSessions.get(userId) || [];\n    const recentSessions = existingSessions.filter(s => \n      s.isActive && (Date.now() - s.lastActivity.getTime()) < 24 * 60 * 60 * 1000 // Last 24 hours\n    );\n\n    for (const session of recentSessions) {\n      const similarity = compareDeviceFingerprints(currentFingerprint, session.deviceFingerprint);\n      \n      if (similarity < this.config.deviceFingerprintThreshold) {\n        const riskScore = this.calculateDeviceChangeRisk(similarity, session, currentFingerprint);\n        \n        this.recordEvent({\n          type: SecurityEventType.DEVICE_CHANGE,\n          userId,\n          ip,\n          userAgent,\n          details: {\n            similarity,\n            previousDevice: session.deviceFingerprint,\n            currentDevice: currentFingerprint,\n            sessionId: session.sessionId\n          }\n        });\n\n        // Auto-revoke if risk is too high\n        if (riskScore > 0.8 && this.config.autoRevokeOnSuspicious) {\n          this.revokeSession(session);\n        }\n      }\n    }\n  }\n\n  /**\n   * Analyze patterns in security events\n   */\n  private analyzePatterns(event: SecurityEvent): void {\n    const patterns = this.detectPatterns(event);\n    \n    for (const pattern of patterns) {\n      console.warn(`[SECURITY] Suspicious pattern detected: ${pattern.type}`, {\n        description: pattern.description,\n        riskScore: pattern.riskScore,\n        threatLevel: pattern.threatLevel,\n        event: {\n          type: event.type,\n          userId: event.userId,\n          ip: event.ip\n        }\n      });\n\n      // Take automated action based on pattern\n      if (pattern.autoAction && event.userId) {\n        this.executeAutomatedAction(pattern.autoAction, event.userId, event, pattern);\n      }\n\n      // Emit high-risk patterns for real-time alerting\n      if (pattern.threatLevel === ThreatLevel.HIGH || pattern.threatLevel === ThreatLevel.CRITICAL) {\n        this.emit('highRiskPattern', { pattern, event });\n      }\n    }\n  }\n\n  /**\n   * Detect suspicious patterns in events\n   */\n  private detectPatterns(event: SecurityEvent): SuspiciousPattern[] {\n    const patterns: SuspiciousPattern[] = [];\n\n    // Pattern 1: Rapid failed logins\n    if (event.type === SecurityEventType.LOGIN_FAILED) {\n      const recentFailures = this.getRecentEventsByType(SecurityEventType.LOGIN_FAILED, 15 * 60 * 1000) // 15 minutes\n        .filter(e => e.ip === event.ip);\n      \n      if (recentFailures.length >= this.config.alertThresholds.failedLogins) {\n        patterns.push({\n          type: 'RAPID_FAILED_LOGINS',\n          description: `${recentFailures.length} failed login attempts from IP ${event.ip}`,\n          riskScore: 0.9,\n          threatLevel: ThreatLevel.HIGH,\n          autoAction: 'ALERT_ONLY'\n        });\n      }\n    }\n\n    // Pattern 2: Multiple device changes\n    if (event.type === SecurityEventType.DEVICE_CHANGE && event.userId) {\n      const recentDeviceChanges = this.getRecentEventsByUserAndType(event.userId, SecurityEventType.DEVICE_CHANGE, 60 * 60 * 1000); // 1 hour\n      \n      if (recentDeviceChanges.length >= this.config.alertThresholds.deviceChanges) {\n        patterns.push({\n          type: 'MULTIPLE_DEVICE_CHANGES',\n          description: `${recentDeviceChanges.length} device changes for user ${event.userId}`,\n          riskScore: 0.8,\n          threatLevel: ThreatLevel.HIGH,\n          autoAction: 'REVOKE_TOKEN'\n        });\n      }\n    }\n\n    // Pattern 3: Suspicious IP patterns\n    if (event.ip && this.isSuspiciousIP(event.ip)) {\n      patterns.push({\n        type: 'SUSPICIOUS_IP',\n        description: `Activity from suspicious IP ${event.ip}`,\n        riskScore: 0.7,\n        threatLevel: ThreatLevel.MEDIUM,\n        autoAction: 'ALERT_ONLY'\n      });\n    }\n\n    // Pattern 4: Unusual access patterns (e.g., off-hours access)\n    if (this.isUnusualAccessTime(event.timestamp) && event.userId) {\n      const userHistory = this.getUserLoginHistory(event.userId);\n      if (userHistory.length > 10 && !this.isNormalTimeForUser(event.userId, event.timestamp)) {\n        patterns.push({\n          type: 'UNUSUAL_ACCESS_TIME',\n          description: `Access at unusual time for user ${event.userId}`,\n          riskScore: 0.6,\n          threatLevel: ThreatLevel.MEDIUM,\n          autoAction: 'ALERT_ONLY'\n        });\n      }\n    }\n\n    return patterns;\n  }\n\n  /**\n   * Execute automated security actions\n   */\n  private executeAutomatedAction(action: string, userId: string, event: SecurityEvent, pattern: SuspiciousPattern): void {\n    switch (action) {\n      case 'REVOKE_TOKEN':\n        const sessions = this.userSessions.get(userId) || [];\n        sessions.forEach(session => {\n          if (session.isActive) {\n            this.revokeSession(session);\n          }\n        });\n        break;\n\n      case 'LOCK_ACCOUNT':\n        // Implementation would depend on user model having a locked field\n        console.warn(`[SECURITY] Account lock triggered for user ${userId}`, { pattern, event });\n        break;\n\n      case 'ALERT_ONLY':\n        // Already logged, emit alert event\n        this.emit('securityAlert', { action, userId, event, pattern });\n        break;\n    }\n  }\n\n  /**\n   * Get recent events by type\n   */\n  private getRecentEventsByType(type: SecurityEventType, timeWindowMs: number): SecurityEvent[] {\n    const cutoff = Date.now() - timeWindowMs;\n    return this.events.filter(e => e.type === type && e.timestamp.getTime() > cutoff);\n  }\n\n  /**\n   * Get recent events by user and type\n   */\n  private getRecentEventsByUserAndType(userId: string, type: SecurityEventType, timeWindowMs: number): SecurityEvent[] {\n    const cutoff = Date.now() - timeWindowMs;\n    return this.events.filter(e => \n      e.userId === userId && \n      e.type === type && \n      e.timestamp.getTime() > cutoff\n    );\n  }\n\n  /**\n   * Calculate risk score for an event\n   */\n  private calculateRiskScore(event: Omit<SecurityEvent, 'id' | 'timestamp' | 'riskScore'>): number {\n    let score = 0;\n\n    // Base scores by event type\n    switch (event.type) {\n      case SecurityEventType.LOGIN_FAILED:\n        score += 0.3;\n        break;\n      case SecurityEventType.DEVICE_CHANGE:\n        score += 0.6;\n        break;\n      case SecurityEventType.SUSPICIOUS_IP:\n        score += 0.7;\n        break;\n      case SecurityEventType.MULTIPLE_CONCURRENT_SESSIONS:\n        score += 0.5;\n        break;\n      default:\n        score += 0.1;\n    }\n\n    // Increase score based on details\n    if (event.details) {\n      if (event.details.similarity && event.details.similarity < 0.3) {\n        score += 0.4; // Very different device fingerprint\n      }\n      if (event.details.sessionCount > this.config.maxSessionsPerUser) {\n        score += 0.3;\n      }\n    }\n\n    return Math.min(score, 1.0); // Cap at 1.0\n  }\n\n  /**\n   * Calculate device change risk\n   */\n  private calculateDeviceChangeRisk(similarity: number, session: UserSessionInfo, currentFingerprint: DeviceFingerprint): number {\n    let risk = 1.0 - similarity; // Lower similarity = higher risk\n\n    // Increase risk if IP changed dramatically\n    if (session.ip !== currentFingerprint.ipNetwork) {\n      risk += 0.3;\n    }\n\n    // Increase risk if user agent changed completely\n    if (!session.userAgent.includes(currentFingerprint.userAgent.split(' ')[0])) {\n      risk += 0.2;\n    }\n\n    return Math.min(risk, 1.0);\n  }\n\n  /**\n   * Check if IP is suspicious (simple heuristics)\n   */\n  private isSuspiciousIP(ip: string): boolean {\n    // Check against known suspicious patterns\n    const suspiciousPatterns = [\n      /^10\\./, // Private IPs might be suspicious depending on context\n      /^192\\.168\\./, // Private IPs\n      /^127\\./, // Localhost\n      /^0\\.0\\.0\\.0$/ // Invalid IP\n    ];\n\n    // In a real implementation, you'd check against threat intelligence feeds\n    return suspiciousPatterns.some(pattern => pattern.test(ip));\n  }\n\n  /**\n   * Check if access time is unusual\n   */\n  private isUnusualAccessTime(timestamp: Date): boolean {\n    const hour = timestamp.getHours();\n    // Consider 2 AM to 6 AM as unusual hours\n    return hour >= 2 && hour < 6;\n  }\n\n  /**\n   * Get user login history\n   */\n  private getUserLoginHistory(userId: string): SecurityEvent[] {\n    return this.events.filter(e => \n      e.userId === userId && \n      e.type === SecurityEventType.LOGIN_SUCCESS\n    ).slice(-50); // Last 50 logins\n  }\n\n  /**\n   * Check if timestamp is normal for user\n   */\n  private isNormalTimeForUser(userId: string, timestamp: Date): boolean {\n    const history = this.getUserLoginHistory(userId);\n    const hour = timestamp.getHours();\n    \n    // Calculate user's typical login hours\n    const loginHours = history.map(e => e.timestamp.getHours());\n    const averageHour = loginHours.reduce((a, b) => a + b, 0) / loginHours.length;\n    \n    // Allow Â±3 hours from average\n    return Math.abs(hour - averageHour) <= 3;\n  }\n\n  /**\n   * Get security statistics\n   */\n  getStatistics(timeWindowMs: number = 24 * 60 * 60 * 1000): {\n    totalEvents: number;\n    eventsByType: { [key: string]: number };\n    riskDistribution: { [key: string]: number };\n    activeAlerts: number;\n  } {\n    const cutoff = Date.now() - timeWindowMs;\n    const recentEvents = this.events.filter(e => e.timestamp.getTime() > cutoff);\n\n    const eventsByType: { [key: string]: number } = {};\n    const riskDistribution = { low: 0, medium: 0, high: 0, critical: 0 };\n\n    for (const event of recentEvents) {\n      eventsByType[event.type] = (eventsByType[event.type] || 0) + 1;\n      \n      if (event.riskScore < 0.3) riskDistribution.low++;\n      else if (event.riskScore < 0.6) riskDistribution.medium++;\n      else if (event.riskScore < 0.8) riskDistribution.high++;\n      else riskDistribution.critical++;\n    }\n\n    return {\n      totalEvents: recentEvents.length,\n      eventsByType,\n      riskDistribution,\n      activeAlerts: this.getActiveAlerts().length\n    };\n  }\n\n  /**\n   * Get active security alerts\n   */\n  getActiveAlerts(): SecurityEvent[] {\n    const cutoff = Date.now() - (60 * 60 * 1000); // Last hour\n    return this.events.filter(e => \n      e.riskScore > 0.7 && \n      e.timestamp.getTime() > cutoff\n    );\n  }\n\n  /**\n   * Setup pattern detection rules\n   */\n  private setupPatternDetection(): void {\n    // Initialize pattern detection rules\n    console.log('[SECURITY] Security monitor initialized with pattern detection');\n  }\n\n  /**\n   * Start cleanup tasks\n   */\n  private startCleanupTasks(): void {\n    // Clean up old events every hour\n    setInterval(() => {\n      this.trimEvents();\n      this.cleanupInactiveSessions();\n    }, 60 * 60 * 1000);\n  }\n\n  /**\n   * Trim events to maximum retention\n   */\n  private trimEvents(): void {\n    if (this.events.length > this.config.maxEventsRetention) {\n      this.events = this.events.slice(-this.config.maxEventsRetention);\n    }\n  }\n\n  /**\n   * Clean up inactive sessions\n   */\n  private cleanupInactiveSessions(): void {\n    const cutoff = Date.now() - (7 * 24 * 60 * 60 * 1000); // 7 days\n    \n    for (const [userId, sessions] of this.userSessions.entries()) {\n      const activeSessions = sessions.filter(s => \n        s.isActive && s.lastActivity.getTime() > cutoff\n      );\n      \n      if (activeSessions.length !== sessions.length) {\n        this.userSessions.set(userId, activeSessions);\n      }\n    }\n  }\n\n  /**\n   * Generate unique event ID\n   */\n  private generateEventId(): string {\n    return `sec_${Date.now()}_${Math.random().toString(36).substring(2)}`;\n  }\n\n  /**\n   * Generate unique session ID\n   */\n  private generateSessionId(): string {\n    return `sess_${Date.now()}_${Math.random().toString(36).substring(2)}`;\n  }\n}\n\n// Global security monitor instance\nexport const securityMonitor = new SecurityMonitor();\n\n/**\n * Middleware to track authentication events\n */\nexport const trackSecurityEvent = (eventType: SecurityEventType, details?: any) => {\n  return (req: any, res: any, next: any) => {\n    const event = {\n      type: eventType,\n      userId: req.user?._id?.toString(),\n      ip: req.ip || req.connection.remoteAddress || 'unknown',\n      userAgent: req.get('User-Agent') || 'unknown',\n      details: details || {}\n    };\n\n    securityMonitor.recordEvent(event);\n    next();\n  };\n};\n\nexport default securityMonitor;\n"],"version":3}