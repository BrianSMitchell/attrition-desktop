{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\services\\bases\\CitizenService.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\services\\bases\\CitizenService.ts"],"sourcesContent":["import { supabase } from '../../config/supabase';\nimport { CapacityService } from './CapacityService';\nimport { DB_TABLES, DB_FIELDS } from '../../constants/database-fields';\nimport { ENV_VARS } from '@game/shared';\n\n/**\n * CitizenService - maintains citizen accrual per base.\n * Uses aligned payout periods with milli-citizens remainder to avoid fractional loss,\n * similar to Empire credits.\n */\nexport class CitizenService {\n  /** Update citizens for all colonies owned by an empire */\n  static async updateEmpireBases(empireId: string): Promise<{ updated: number; errors: number }> {\n    let updated = 0;\n    let errors = 0;\n    try {\n      // Fetch all colonies for this empire\n      const { data: colonies, error: fetchError } = await supabase\n        .from(DB_TABLES.COLONIES)\n        .select('id, location_coord, citizens, last_citizen_update, citizen_remainder_milli, created_at')\n        .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId);\n\n      if (fetchError) {\n        console.error('[CitizenService] Error fetching colonies:', fetchError);\n        return { updated: 0, errors: 1 };\n      }\n\n      for (const c of colonies || []) {\n        try {\n          const coord = String(c.location_coord || '');\n          if (!coord) continue;\n\n          // Determine aligned period (default 1 minute)\n          const periodMinutes = parseInt(process.env.CITIZEN_PAYOUT_PERIOD_MINUTES || '1', 10);\n          const periodMs = Math.max(60000, periodMinutes * 60 * 1000); // ensure >= 60s\n          const now = new Date();\n          const getBoundary = (date: Date) => new Date(Math.floor(date.getTime() / periodMs) * periodMs);\n\n          const lastUpdate: Date = c.last_citizen_update ? new Date(c.last_citizen_update) : new Date(c.created_at);\n          const lastBoundary = getBoundary(lastUpdate);\n          const currentBoundary = getBoundary(now);\n          const periodsElapsed = Math.floor((currentBoundary.getTime() - lastBoundary.getTime()) / periodMs);\n\n          if (periodsElapsed <= 0) {\n            continue;\n          }\n\n          // Get per-hour citizen generation\n          const caps = await CapacityService.getBaseCapacities(empireId, coord);\n          const perHour = Math.max(0, Number(caps?.citizen?.value || 0));\n\n          if (!(perHour > 0)) {\n            // Still advance last_citizen_update so we don't accumulate infinite periods\n            await supabase\n              .from(DB_TABLES.COLONIES)\n              .update({\n                last_citizen_update: new Date(lastBoundary.getTime() + periodsElapsed * periodMs).toISOString(),\n              })\n              .eq(DB_FIELDS.BUILDINGS.ID, c.id);\n            continue;\n          }\n\n          // Micro-citizens per period (milli-units)\n          const microPerPeriod = Math.round(perHour * (periodMs / (60 * 60 * 1000)) * 1000);\n          const totalMicro = microPerPeriod * periodsElapsed;\n\n          const prevRema = Math.max(0, Number(c.citizen_remainder_milli || 0));\n          const newMicroWithRema = prevRema + totalMicro;\n          const wholeCitizens = Math.floor(newMicroWithRema / 1000);\n          const newRema = newMicroWithRema % 1000;\n\n          const newCount = Math.max(0, Number(c.citizens || 0)) + wholeCitizens;\n\n          // Update colony\n          const { error: updateError } = await supabase\n            .from(DB_TABLES.COLONIES)\n            .update({\n              citizens: newCount,\n              citizen_remainder_milli: newRema,\n              last_citizen_update: new Date(lastBoundary.getTime() + periodsElapsed * periodMs).toISOString(),\n            })\n            .eq(DB_FIELDS.BUILDINGS.ID, c.id);\n\n          if (updateError) {\n            console.error(`[CitizenService] Error updating colony ${c.id}:`, updateError);\n            errors++;\n            continue;\n          }\n\n          updated++;\n\n          // Debug logging\n          if (process.env[ENV_VARS.DEBUG_RESOURCES] === 'true' && wholeCitizens > 0) {\n            console.log(`ðŸ‘¥ Colony ${coord}:`);\n            console.log(`   Citizens/Hour: ${perHour}`);\n            console.log(`   Periods Elapsed: ${periodsElapsed} (${periodMinutes}min each)`);\n            console.log(`   Whole Citizens Added: ${wholeCitizens}`);\n            console.log(`   New Total: ${newCount}`);\n          }\n        } catch (e) {\n          errors++;\n          console.error('[CitizenService] update colony error', e);\n        }\n      }\n    } catch (e) {\n      console.error('[CitizenService] top-level error', e);\n    }\n    return { updated, errors };\n  }\n}\n"],"version":3}