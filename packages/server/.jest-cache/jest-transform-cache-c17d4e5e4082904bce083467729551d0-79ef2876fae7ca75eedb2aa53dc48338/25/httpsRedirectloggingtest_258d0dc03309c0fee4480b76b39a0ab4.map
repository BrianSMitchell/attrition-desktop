{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\middleware\\__tests__\\httpsRedirect.logging.test.ts","mappings":";;;;;AAAA,sDAA8B;AAC9B,0DAAgC;AAChC,oDAA2D;AAC3D,8DAA2D;AAC3D,yCAAwC;AAIxC,kBAAkB;AAClB,MAAM,OAAO,GAAG,OAAO,CAAC,GAAG,CAAC;AAC5B,OAAO,CAAC,GAAG,GAAG,EAAE,GAAG,OAAO,EAAE,QAAQ,EAAE,MAAM,EAAE,CAAC;AAE/C,QAAQ,CAAC,0CAA0C,EAAE,GAAG,EAAE;IACxD,QAAQ,CAAC,GAAG,EAAE;QACZ,OAAO,CAAC,GAAG,GAAG,OAAO,CAAC;IACxB,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,4EAA4E,EAAE,KAAK,IAAI,EAAE;QAC5F,OAAO,CAAC,GAAG,CAAC,iBAAQ,CAAC,QAAQ,CAAC,GAAG,YAAY,CAAC;QAC9C,OAAO,CAAC,GAAG,CAAC,iBAAQ,CAAC,qBAAqB,CAAC,GAAG,MAAM,CAAC;QACrD,MAAM,GAAG,GAAG,IAAA,iBAAO,GAAE,CAAC;QACtB,GAAG,CAAC,GAAG,CAAC,aAAa,EAAE,CAAC,CAAC,CAAC;QAC1B,GAAG,CAAC,GAAG,CAAC,uCAAuB,CAAC,CAAC;QAErC,MAAM,OAAO,GAAG,IAAI,CAAC,KAAK,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC,kBAAkB,CAAC,GAAG,EAAE,CAAC,SAAS,CAAC,CAAC;QAE5E,MAAM,GAAG,GAAG,MAAM,IAAA,mBAAO,EAAC,GAAG,CAAC;aAC3B,GAAG,CAAC,6BAAa,CAAC,MAAM,CAAC,MAAM,CAAC;aAChC,GAAG,CAAC,MAAM,EAAE,gBAAgB,CAAC;aAC7B,GAAG,CAAC,mBAAmB,EAAE,MAAM,CAAC,CAAC;QAEpC,MAAM,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QAC7B,MAAM,CAAC,OAAO,CAAC,CAAC,GAAG,CAAC,gBAAgB,EAAE,CAAC;QACvC,OAAO,CAAC,WAAW,EAAE,CAAC;IACxB,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,qDAAqD,EAAE,KAAK,IAAI,EAAE;QACrE,OAAO,CAAC,GAAG,CAAC,iBAAQ,CAAC,QAAQ,CAAC,GAAG,YAAY,CAAC;QAC9C,OAAO,CAAC,GAAG,CAAC,iBAAQ,CAAC,qBAAqB,CAAC,GAAG,MAAM,CAAC;QACrD,MAAM,GAAG,GAAG,IAAA,iBAAO,GAAE,CAAC;QACtB,GAAG,CAAC,GAAG,CAAC,aAAa,EAAE,CAAC,CAAC,CAAC;QAC1B,GAAG,CAAC,GAAG,CAAC,uCAAuB,CAAC,CAAC;QAErC,MAAM,OAAO,GAAG,IAAI,CAAC,KAAK,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC,kBAAkB,CAAC,GAAG,EAAE,CAAC,SAAS,CAAC,CAAC;QAE5E,MAAM,GAAG,GAAG,MAAM,IAAA,mBAAO,EAAC,GAAG,CAAC;aAC3B,GAAG,CAAC,OAAO,CAAC;aACZ,GAAG,CAAC,MAAM,EAAE,gBAAgB,CAAC;aAC7B,GAAG,CAAC,mBAAmB,EAAE,MAAM,CAAC,CAAC;QAEpC,MAAM,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QAC7B,MAAM,CAAC,OAAO,CAAC,CAAC,gBAAgB,EAAE,CAAC;QACnC,OAAO,CAAC,WAAW,EAAE,CAAC;IACxB,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\middleware\\__tests__\\httpsRedirect.logging.test.ts"],"sourcesContent":["import express from 'express';\r\nimport request from 'supertest';\r\nimport { httpsRedirectMiddleware } from '../httpsRedirect';\r\nimport { API_ENDPOINTS } from '../constants/api-endpoints';\r\nimport { ENV_VARS } from '@game/shared';\n\n\r\n\r\n// Ensure test env\r\nconst OLD_ENV = process.env;\r\nprocess.env = { ...OLD_ENV, NODE_ENV: 'test' };\r\n\r\ndescribe('httpsRedirectMiddleware logging behavior', () => {\r\n  afterAll(() => {\r\n    process.env = OLD_ENV;\r\n  });\r\n\r\n  test('suppresses WARN for exempt /health in reverse proxy mode (still redirects)', async () => {\r\n    process.env[ENV_VARS.NODE_ENV] = 'production';\r\n    process.env[ENV_VARS.USE_REVERSE_PROXY_SSL] = 'true';\r\n    const app = express();\r\n    app.set('trust proxy', 1);\r\n    app.use(httpsRedirectMiddleware);\r\n\r\nconst warnSpy = jest.spyOn(console, 'warn').mockImplementation(() => undefined);\r\n\r\n    const res = await request(app)\r\n      .get(API_ENDPOINTS.SYSTEM.HEALTH)\r\n      .set('Host', 'localhost:3001')\r\n      .set('X-Forwarded-Proto', 'http');\r\n\r\n    expect(res.status).toBe(301);\r\n    expect(warnSpy).not.toHaveBeenCalled();\r\n    warnSpy.mockRestore();\r\n  });\r\n\r\n  test('logs WARN for non-exempt path in reverse proxy mode', async () => {\r\n    process.env[ENV_VARS.NODE_ENV] = 'production';\r\n    process.env[ENV_VARS.USE_REVERSE_PROXY_SSL] = 'true';\r\n    const app = express();\r\n    app.set('trust proxy', 1);\r\n    app.use(httpsRedirectMiddleware);\r\n\r\nconst warnSpy = jest.spyOn(console, 'warn').mockImplementation(() => undefined);\r\n\r\n    const res = await request(app)\r\n      .get('/game')\r\n      .set('Host', 'localhost:3001')\r\n      .set('X-Forwarded-Proto', 'http');\r\n\r\n    expect(res.status).toBe(301);\r\n    expect(warnSpy).toHaveBeenCalled();\r\n    warnSpy.mockRestore();\r\n  });\r\n});\r\n\r\n"],"version":3}