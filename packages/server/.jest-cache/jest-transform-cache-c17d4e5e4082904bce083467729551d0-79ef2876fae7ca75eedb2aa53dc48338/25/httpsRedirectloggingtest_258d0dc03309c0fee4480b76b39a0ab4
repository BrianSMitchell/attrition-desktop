b5fc4f4fdd7ed4d266a68770c918ce08
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const supertest_1 = __importDefault(require("supertest"));
const httpsRedirect_1 = require("../httpsRedirect");
const api_endpoints_1 = require("../constants/api-endpoints");
const shared_1 = require("@game/shared");
// Ensure test env
const OLD_ENV = process.env;
process.env = { ...OLD_ENV, NODE_ENV: 'test' };
describe('httpsRedirectMiddleware logging behavior', () => {
    afterAll(() => {
        process.env = OLD_ENV;
    });
    test('suppresses WARN for exempt /health in reverse proxy mode (still redirects)', async () => {
        process.env[shared_1.ENV_VARS.NODE_ENV] = 'production';
        process.env[shared_1.ENV_VARS.USE_REVERSE_PROXY_SSL] = 'true';
        const app = (0, express_1.default)();
        app.set('trust proxy', 1);
        app.use(httpsRedirect_1.httpsRedirectMiddleware);
        const warnSpy = jest.spyOn(console, 'warn').mockImplementation(() => undefined);
        const res = await (0, supertest_1.default)(app)
            .get(api_endpoints_1.API_ENDPOINTS.SYSTEM.HEALTH)
            .set('Host', 'localhost:3001')
            .set('X-Forwarded-Proto', 'http');
        expect(res.status).toBe(301);
        expect(warnSpy).not.toHaveBeenCalled();
        warnSpy.mockRestore();
    });
    test('logs WARN for non-exempt path in reverse proxy mode', async () => {
        process.env[shared_1.ENV_VARS.NODE_ENV] = 'production';
        process.env[shared_1.ENV_VARS.USE_REVERSE_PROXY_SSL] = 'true';
        const app = (0, express_1.default)();
        app.set('trust proxy', 1);
        app.use(httpsRedirect_1.httpsRedirectMiddleware);
        const warnSpy = jest.spyOn(console, 'warn').mockImplementation(() => undefined);
        const res = await (0, supertest_1.default)(app)
            .get('/game')
            .set('Host', 'localhost:3001')
            .set('X-Forwarded-Proto', 'http');
        expect(res.status).toBe(301);
        expect(warnSpy).toHaveBeenCalled();
        warnSpy.mockRestore();
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFByb2plY3RzXFxBdHRyaXRpb25cXHBhY2thZ2VzXFxzZXJ2ZXJcXHNyY1xcbWlkZGxld2FyZVxcX190ZXN0c19fXFxodHRwc1JlZGlyZWN0LmxvZ2dpbmcudGVzdC50cyIsIm1hcHBpbmdzIjoiOzs7OztBQUFBLHNEQUE4QjtBQUM5QiwwREFBZ0M7QUFDaEMsb0RBQTJEO0FBQzNELDhEQUEyRDtBQUMzRCx5Q0FBd0M7QUFJeEMsa0JBQWtCO0FBQ2xCLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUM7QUFDNUIsT0FBTyxDQUFDLEdBQUcsR0FBRyxFQUFFLEdBQUcsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsQ0FBQztBQUUvQyxRQUFRLENBQUMsMENBQTBDLEVBQUUsR0FBRyxFQUFFO0lBQ3hELFFBQVEsQ0FBQyxHQUFHLEVBQUU7UUFDWixPQUFPLENBQUMsR0FBRyxHQUFHLE9BQU8sQ0FBQztJQUN4QixDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyw0RUFBNEUsRUFBRSxLQUFLLElBQUksRUFBRTtRQUM1RixPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsWUFBWSxDQUFDO1FBQzlDLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQVEsQ0FBQyxxQkFBcUIsQ0FBQyxHQUFHLE1BQU0sQ0FBQztRQUNyRCxNQUFNLEdBQUcsR0FBRyxJQUFBLGlCQUFPLEdBQUUsQ0FBQztRQUN0QixHQUFHLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUMxQixHQUFHLENBQUMsR0FBRyxDQUFDLHVDQUF1QixDQUFDLENBQUM7UUFFckMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFNUUsTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFBLG1CQUFPLEVBQUMsR0FBRyxDQUFDO2FBQzNCLEdBQUcsQ0FBQyw2QkFBYSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7YUFDaEMsR0FBRyxDQUFDLE1BQU0sRUFBRSxnQkFBZ0IsQ0FBQzthQUM3QixHQUFHLENBQUMsbUJBQW1CLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFcEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDN0IsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ3ZDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUN4QixDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyxxREFBcUQsRUFBRSxLQUFLLElBQUksRUFBRTtRQUNyRSxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsWUFBWSxDQUFDO1FBQzlDLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQVEsQ0FBQyxxQkFBcUIsQ0FBQyxHQUFHLE1BQU0sQ0FBQztRQUNyRCxNQUFNLEdBQUcsR0FBRyxJQUFBLGlCQUFPLEdBQUUsQ0FBQztRQUN0QixHQUFHLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUMxQixHQUFHLENBQUMsR0FBRyxDQUFDLHVDQUF1QixDQUFDLENBQUM7UUFFckMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFNUUsTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFBLG1CQUFPLEVBQUMsR0FBRyxDQUFDO2FBQzNCLEdBQUcsQ0FBQyxPQUFPLENBQUM7YUFDWixHQUFHLENBQUMsTUFBTSxFQUFFLGdCQUFnQixDQUFDO2FBQzdCLEdBQUcsQ0FBQyxtQkFBbUIsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUVwQyxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM3QixNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUNuQyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDeEIsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcUHJvamVjdHNcXEF0dHJpdGlvblxccGFja2FnZXNcXHNlcnZlclxcc3JjXFxtaWRkbGV3YXJlXFxfX3Rlc3RzX19cXGh0dHBzUmVkaXJlY3QubG9nZ2luZy50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQgcmVxdWVzdCBmcm9tICdzdXBlcnRlc3QnO1xyXG5pbXBvcnQgeyBodHRwc1JlZGlyZWN0TWlkZGxld2FyZSB9IGZyb20gJy4uL2h0dHBzUmVkaXJlY3QnO1xyXG5pbXBvcnQgeyBBUElfRU5EUE9JTlRTIH0gZnJvbSAnLi4vY29uc3RhbnRzL2FwaS1lbmRwb2ludHMnO1xyXG5pbXBvcnQgeyBFTlZfVkFSUyB9IGZyb20gJ0BnYW1lL3NoYXJlZCc7XG5cblxyXG5cclxuLy8gRW5zdXJlIHRlc3QgZW52XHJcbmNvbnN0IE9MRF9FTlYgPSBwcm9jZXNzLmVudjtcclxucHJvY2Vzcy5lbnYgPSB7IC4uLk9MRF9FTlYsIE5PREVfRU5WOiAndGVzdCcgfTtcclxuXHJcbmRlc2NyaWJlKCdodHRwc1JlZGlyZWN0TWlkZGxld2FyZSBsb2dnaW5nIGJlaGF2aW9yJywgKCkgPT4ge1xyXG4gIGFmdGVyQWxsKCgpID0+IHtcclxuICAgIHByb2Nlc3MuZW52ID0gT0xEX0VOVjtcclxuICB9KTtcclxuXHJcbiAgdGVzdCgnc3VwcHJlc3NlcyBXQVJOIGZvciBleGVtcHQgL2hlYWx0aCBpbiByZXZlcnNlIHByb3h5IG1vZGUgKHN0aWxsIHJlZGlyZWN0cyknLCBhc3luYyAoKSA9PiB7XHJcbiAgICBwcm9jZXNzLmVudltFTlZfVkFSUy5OT0RFX0VOVl0gPSAncHJvZHVjdGlvbic7XHJcbiAgICBwcm9jZXNzLmVudltFTlZfVkFSUy5VU0VfUkVWRVJTRV9QUk9YWV9TU0xdID0gJ3RydWUnO1xyXG4gICAgY29uc3QgYXBwID0gZXhwcmVzcygpO1xyXG4gICAgYXBwLnNldCgndHJ1c3QgcHJveHknLCAxKTtcclxuICAgIGFwcC51c2UoaHR0cHNSZWRpcmVjdE1pZGRsZXdhcmUpO1xyXG5cclxuY29uc3Qgd2FyblNweSA9IGplc3Quc3B5T24oY29uc29sZSwgJ3dhcm4nKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gdW5kZWZpbmVkKTtcclxuXHJcbiAgICBjb25zdCByZXMgPSBhd2FpdCByZXF1ZXN0KGFwcClcclxuICAgICAgLmdldChBUElfRU5EUE9JTlRTLlNZU1RFTS5IRUFMVEgpXHJcbiAgICAgIC5zZXQoJ0hvc3QnLCAnbG9jYWxob3N0OjMwMDEnKVxyXG4gICAgICAuc2V0KCdYLUZvcndhcmRlZC1Qcm90bycsICdodHRwJyk7XHJcblxyXG4gICAgZXhwZWN0KHJlcy5zdGF0dXMpLnRvQmUoMzAxKTtcclxuICAgIGV4cGVjdCh3YXJuU3B5KS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgd2FyblNweS5tb2NrUmVzdG9yZSgpO1xyXG4gIH0pO1xyXG5cclxuICB0ZXN0KCdsb2dzIFdBUk4gZm9yIG5vbi1leGVtcHQgcGF0aCBpbiByZXZlcnNlIHByb3h5IG1vZGUnLCBhc3luYyAoKSA9PiB7XHJcbiAgICBwcm9jZXNzLmVudltFTlZfVkFSUy5OT0RFX0VOVl0gPSAncHJvZHVjdGlvbic7XHJcbiAgICBwcm9jZXNzLmVudltFTlZfVkFSUy5VU0VfUkVWRVJTRV9QUk9YWV9TU0xdID0gJ3RydWUnO1xyXG4gICAgY29uc3QgYXBwID0gZXhwcmVzcygpO1xyXG4gICAgYXBwLnNldCgndHJ1c3QgcHJveHknLCAxKTtcclxuICAgIGFwcC51c2UoaHR0cHNSZWRpcmVjdE1pZGRsZXdhcmUpO1xyXG5cclxuY29uc3Qgd2FyblNweSA9IGplc3Quc3B5T24oY29uc29sZSwgJ3dhcm4nKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gdW5kZWZpbmVkKTtcclxuXHJcbiAgICBjb25zdCByZXMgPSBhd2FpdCByZXF1ZXN0KGFwcClcclxuICAgICAgLmdldCgnL2dhbWUnKVxyXG4gICAgICAuc2V0KCdIb3N0JywgJ2xvY2FsaG9zdDozMDAxJylcclxuICAgICAgLnNldCgnWC1Gb3J3YXJkZWQtUHJvdG8nLCAnaHR0cCcpO1xyXG5cclxuICAgIGV4cGVjdChyZXMuc3RhdHVzKS50b0JlKDMwMSk7XHJcbiAgICBleHBlY3Qod2FyblNweSkudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgd2FyblNweS5tb2NrUmVzdG9yZSgpO1xyXG4gIH0pO1xyXG59KTtcclxuXHJcbiJdLCJ2ZXJzaW9uIjozfQ==