{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\services\\completionService.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\services\\completionService.ts"],"sourcesContent":["import { supabase } from '../config/supabase';\r\nimport { getTechSpec } from '@game/shared';\r\n\r\n// Constants imports for eliminating hardcoded values\r\nimport { DB_TABLES, DB_FIELDS } from '../constants/database-fields';\r\n\r\nexport interface CompletionStats {\r\n  completed: number;\r\n  cancelled: number;\r\n  errors: number;\r\n}\r\n\r\nexport class SupabaseCompletionService {\r\n  /**\r\n   * Complete tech queue items that have finished\r\n   */\r\n  static async completeTechQueue(): Promise<CompletionStats> {\r\n    let completed = 0;\r\n    let cancelled = 0;\r\n    let errors = 0;\r\n\r\n    try {\r\n      const now = new Date().toISOString();\r\n\r\n      // Find all pending items that have completed\r\n      const { data: dueItems, error } = await supabase\r\n        .from(DB_TABLES.TECH_QUEUE)\r\n        .select('id, empire_id, tech_key, level, location_coord')\r\n        .eq(DB_FIELDS.TECH_QUEUE.STATUS, 'pending')\r\n        .not(DB_FIELDS.TECH_QUEUE.COMPLETES_AT, 'is', null)\r\n        .lte(DB_FIELDS.TECH_QUEUE.COMPLETES_AT, now);\r\n\r\n      if (error) {\r\n        console.error('[SupabaseCompletion] Error fetching due tech items:', error);\r\n        return { completed: 0, cancelled: 0, errors: 1 };\r\n      }\r\n\r\n      for (const item of dueItems || []) {\r\n        try {\r\n          const empireId = item.empire_id;\r\n          const techKey = item.tech_key;\r\n          const targetLevel = Math.max(1, Number(item.level || 1));\r\n\r\n          // Check if empire exists\r\n          const { data: empire, error: empireError } = await supabase\r\n            .from(DB_TABLES.EMPIRES)\r\n            .select(DB_FIELDS.BUILDINGS.ID)\r\n            .eq(DB_FIELDS.BUILDINGS.ID, empireId)\r\n            .maybeSingle();\r\n\r\n          if (empireError || !empire) {\r\n            // Mark as cancelled if empire is missing\r\n            await supabase\r\n              .from(DB_TABLES.TECH_QUEUE)\r\n              .update({ status: 'cancelled' })\r\n              .eq(DB_FIELDS.BUILDINGS.ID, item.id);\r\n            cancelled++;\r\n            console.warn(`[SupabaseCompletion] Tech cancelled - missing empire: techKey=${techKey}`);\r\n            continue;\r\n          }\r\n\r\n          // Upsert tech level (insert or update to max level)\r\n          const { error: upsertError } = await supabase\r\n            .from(DB_TABLES.TECH_LEVELS)\r\n            .upsert({\r\n              empire_id: empireId,\r\n              tech_key: techKey,\r\n              level: targetLevel\r\n            }, {\r\n              onConflict: 'empire_id,tech_key',\r\n              ignoreDuplicates: false\r\n            });\r\n\r\n          if (upsertError) {\r\n            // Try updating existing record\r\n            const { data: existing } = await supabase\r\n              .from(DB_TABLES.TECH_LEVELS)\r\n              .select(DB_FIELDS.BUILDINGS.LEVEL)\r\n              .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\r\n              .eq(DB_FIELDS.TECH_QUEUE.TECH_KEY, techKey)\r\n              .maybeSingle();\r\n\r\n            const currentLevel = existing ? Number(existing.level || 0) : 0;\r\n            const newLevel = Math.max(currentLevel, targetLevel);\r\n\r\n            await supabase\r\n              .from(DB_TABLES.TECH_LEVELS)\r\n              .update({ level: newLevel })\r\n              .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\r\n              .eq(DB_FIELDS.TECH_QUEUE.TECH_KEY, techKey);\r\n          }\r\n\r\n          // Mark queue item as completed\r\n          await supabase\r\n            .from(DB_TABLES.TECH_QUEUE)\r\n            .update({ status: 'completed' })\r\n            .eq(DB_FIELDS.BUILDINGS.ID, item.id);\r\n\r\n          completed++;\r\n          console.log(`[SupabaseCompletion] Tech completed: key=${techKey} empire=${empireId} location=${item.location_coord} level=${targetLevel}`);\r\n        } catch (err) {\r\n          errors++;\r\n          console.error('[SupabaseCompletion] Error completing tech item:', err);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('[SupabaseCompletion] Error in completeTechQueue:', error);\r\n    }\r\n\r\n    return { completed, cancelled, errors };\r\n  }\r\n\r\n  /**\r\n   * Complete unit queue items that have finished\r\n   */\r\n  static async completeUnitQueue(): Promise<CompletionStats> {\r\n    let completed = 0;\r\n    let cancelled = 0;\r\n    let errors = 0;\r\n\r\n    try {\r\n      const now = new Date().toISOString();\r\n\r\n      // Find all pending items that have completed\r\n      const { data: dueItems, error } = await supabase\r\n        .from(DB_TABLES.UNIT_QUEUE)\r\n        .select('id, empire_id, unit_key, location_coord')\r\n        .eq(DB_FIELDS.TECH_QUEUE.STATUS, 'pending')\r\n        .not(DB_FIELDS.TECH_QUEUE.COMPLETES_AT, 'is', null)\r\n        .lte(DB_FIELDS.TECH_QUEUE.COMPLETES_AT, now);\r\n\r\n      if (error) {\r\n        console.error('[SupabaseCompletion] Error fetching due unit items:', error);\r\n        return { completed: 0, cancelled: 0, errors: 1 };\r\n      }\r\n\r\n      for (const item of dueItems || []) {\r\n        try {\r\n          const empireId = item.empire_id;\r\n          const unitKey = item.unit_key;\r\n          const baseCoord = item.location_coord;\r\n\r\n          // Check if empire exists\r\n          const { data: empire, error: empireError } = await supabase\r\n            .from(DB_TABLES.EMPIRES)\r\n            .select('id, next_fleet_number')\r\n            .eq(DB_FIELDS.BUILDINGS.ID, empireId)\r\n            .maybeSingle();\r\n\r\n          if (empireError || !empire) {\r\n            // Mark as cancelled if empire is missing\r\n            await supabase\r\n              .from(DB_TABLES.UNIT_QUEUE)\r\n              .update({ status: 'cancelled' })\r\n              .eq(DB_FIELDS.BUILDINGS.ID, item.id);\r\n            cancelled++;\r\n            console.warn(`[SupabaseCompletion] Unit cancelled - missing empire: unitKey=${unitKey}`);\r\n            continue;\r\n          }\r\n\r\n          // Mark unit production as completed\r\n          await supabase\r\n            .from(DB_TABLES.UNIT_QUEUE)\r\n            .update({ status: 'completed' })\r\n            .eq(DB_FIELDS.BUILDINGS.ID, item.id);\r\n\r\n          // Find or create fleet at this base\r\n          const { data: existingFleets } = await supabase\r\n            .from(DB_TABLES.FLEETS)\r\n            .select('id, name, units, size_credits')\r\n            .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\r\n            .eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, baseCoord)\r\n            .order(DB_FIELDS.BUILDINGS.CREATED_AT, { ascending: false })\r\n            .limit(1);\r\n\r\n          let fleetId: string;\r\n          let units: Array<{ unit_key: string; count: number }> = [];\r\n          let sizeCredits = 0;\r\n\r\n          if (existingFleets && existingFleets.length > 0) {\r\n            // Add to existing fleet\r\n            const fleet = existingFleets[0];\r\n            fleetId = fleet.id;\r\n            units = Array.isArray(fleet.units) ? fleet.units : [];\r\n            sizeCredits = Number(fleet.size_credits || 0);\r\n          } else {\r\n            // Create new fleet\r\n            const nextNum = Math.max(1, Number(empire.next_fleet_number || 1));\r\n            const name = `Fleet ${nextNum}`;\r\n\r\n            const { data: newFleet, error: fleetError } = await supabase\r\n              .from(DB_TABLES.FLEETS)\r\n              .insert({\r\n                empire_id: empireId,\r\n                location_coord: baseCoord,\r\n                name,\r\n                units: [],\r\n                size_credits: 0\r\n              })\r\n              .select(DB_FIELDS.BUILDINGS.ID)\r\n              .single();\r\n\r\n            if (fleetError || !newFleet) {\r\n              errors++;\r\n              console.error('[SupabaseCompletion] Error creating fleet:', fleetError);\r\n              continue;\r\n            }\r\n\r\n            fleetId = newFleet.id;\r\n\r\n            // Increment empire's next fleet number\r\n            await supabase\r\n              .from(DB_TABLES.EMPIRES)\r\n              .update({ next_fleet_number: nextNum + 1 })\r\n              .eq(DB_FIELDS.BUILDINGS.ID, empireId);\r\n          }\r\n\r\n          // Add unit to fleet\r\n          const { getUnitSpec } = await import('@game/shared');\r\n          const spec = getUnitSpec(unitKey as any);\r\n          const unitCredits = Number(spec?.creditsCost || 0);\r\n\r\n          const existing = units.find(u => u.unit_key === unitKey);\r\n          if (existing) {\r\n            existing.count += 1;\r\n          } else {\r\n            units.push({ unit_key: unitKey, count: 1 });\r\n          }\r\n\r\n          sizeCredits += unitCredits;\r\n\r\n          // Update fleet\r\n          await supabase\r\n            .from(DB_TABLES.FLEETS)\r\n            .update({\r\n              units,\r\n              size_credits: sizeCredits\r\n            })\r\n            .eq(DB_FIELDS.BUILDINGS.ID, fleetId);\r\n\r\n          completed++;\r\n          console.log(`[SupabaseCompletion] Unit completed: unitKey=${unitKey} empire=${empireId} base=${baseCoord}`);\r\n        } catch (err) {\r\n          errors++;\r\n          console.error('[SupabaseCompletion] Error completing unit item:', err);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('[SupabaseCompletion] Error in completeUnitQueue:', error);\r\n    }\r\n\r\n    return { completed, cancelled, errors };\r\n  }\r\n\r\n  /**\r\n   * Complete defense queue items that have finished\r\n   */\r\n  static async completeDefenseQueue(): Promise<{ completed: number; errors: number }> {\r\n    let completed = 0;\r\n    let errors = 0;\r\n\r\n    try {\r\n      const now = new Date().toISOString();\r\n\r\n      // Find all pending items that have completed\r\n      const { data: dueItems, error } = await supabase\r\n        .from(DB_TABLES.DEFENSE_QUEUE)\r\n        .select(DB_FIELDS.BUILDINGS.ID)\r\n        .eq(DB_FIELDS.TECH_QUEUE.STATUS, 'pending')\r\n        .not(DB_FIELDS.TECH_QUEUE.COMPLETES_AT, 'is', null)\r\n        .lte(DB_FIELDS.TECH_QUEUE.COMPLETES_AT, now);\r\n\r\n      if (error) {\r\n        console.error('[SupabaseCompletion] Error fetching due defense items:', error);\r\n        return { completed: 0, errors: 1 };\r\n      }\r\n\r\n      for (const item of dueItems || []) {\r\n        try {\r\n          await supabase\r\n            .from(DB_TABLES.DEFENSE_QUEUE)\r\n            .update({ status: 'completed' })\r\n            .eq(DB_FIELDS.BUILDINGS.ID, item.id);\r\n          completed++;\r\n        } catch (err) {\r\n          errors++;\r\n          console.error('[SupabaseCompletion] Error completing defense item:', err);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('[SupabaseCompletion] Error in completeDefenseQueue:', error);\r\n    }\r\n\r\n    return { completed, errors };\r\n  }\r\n}\r\n"],"version":3}