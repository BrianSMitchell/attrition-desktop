{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\routes\\game\\defenses.ts","mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,qCAA2C;AAC3C,oDAAiD;AACjD,gEAA6D;AAC7D,gDAAkE;AAClE,uEAAkE;AAClE,qEAAuE;AACvE,yCAA2C;AAC3C,yCAA2D;AAC3D,2FAAwF;AAExF,MAAM,MAAM,GAAG,IAAA,gBAAM,GAAE,CAAC;AAExB,MAAM,CAAC,GAAG,CAAC,mBAAY,CAAC,CAAC;AAEzB;;GAEG;AACH,MAAM,CAAC,GAAG,CAAC,UAAU,EAAE,IAAA,2BAAY,EAAC,KAAK,EAAE,IAAiB,EAAE,GAAa,EAAE,EAAE;IAC7E,MAAM,OAAO,GAAG,IAAA,wBAAe,GAAE,CAAC;IAClC,GAAG,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE,IAAI,EAAE,EAAE,OAAO,EAAE,EAAE,CAAC,CAAC;AACjD,CAAC,CAAC,CAAC,CAAC;AAEJ;;GAEG;AACH,MAAM,CAAC,GAAG,CAAC,SAAS,EAAE,IAAA,2BAAY,EAAC,KAAK,EAAE,GAAgB,EAAE,GAAa,EAAE,EAAE;IAC3E,MAAM,IAAI,GAAG,GAAG,CAAC,IAAY,CAAC;IAE9B,2CAA2C;IAC3C,MAAM,SAAS,GAAG,MAAM,iDAAuB,CAAC,yBAAyB,CAAC,IAAI,CAAC,CAAC;IAChF,IAAI,CAAC,SAAS,EAAE,CAAC;QACf,OAAO,GAAG,CAAC,MAAM,CAAC,oBAAW,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,KAAK,EAAE,iCAAc,CAAC,gBAAgB,EAAE,CAAC,CAAC;IAC5G,CAAC;IAED,MAAM,QAAQ,GAAG,MAAM,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC;IAEtC,MAAM,EAAE,eAAe,EAAE,GAAG,wDAAa,yCAAyC,GAAC,CAAC;IACpF,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC,SAAS,CAAC,QAAQ,CAAC,CAAC;IACzD,OAAO,GAAG,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE,IAAI,EAAE,EAAE,MAAM,EAAE,EAAE,CAAC,CAAC;AACvD,CAAC,CAAC,CAAC,CAAC;AAEJ;;GAEG;AACH,MAAM,CAAC,GAAG,CAAC,QAAQ,EAAE,IAAA,2BAAY,EAAC,KAAK,EAAE,GAAgB,EAAE,GAAa,EAAE,EAAE;IAC1E,MAAM,IAAI,GAAG,GAAG,CAAC,IAAY,CAAC;IAE9B,2CAA2C;IAC3C,MAAM,SAAS,GAAG,MAAM,iDAAuB,CAAC,yBAAyB,CAAC,IAAI,CAAC,CAAC;IAChF,IAAI,CAAC,SAAS,EAAE,CAAC;QACf,OAAO,GAAG,CAAC,MAAM,CAAC,oBAAW,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,KAAK,EAAE,iCAAc,CAAC,gBAAgB,EAAE,CAAC,CAAC;IAC5G,CAAC;IAED,MAAM,QAAQ,GAAG,MAAM,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC;IACtC,MAAM,aAAa,GAAG,MAAM,CAAC,GAAG,CAAC,KAAK,CAAC,aAAa,IAAI,EAAE,CAAC,CAAC,IAAI,EAAE,IAAI,SAAS,CAAC;IAEhF,gCAAgC;IAChC,IAAI,KAAK,GAAG,mBAAQ;SACjB,IAAI,CAAC,2BAAS,CAAC,aAAa,CAAC;SAC7B,MAAM,CAAC,2DAA2D,CAAC;SACnE,EAAE,CAAC,2BAAS,CAAC,SAAS,CAAC,SAAS,EAAE,QAAQ,CAAC;SAC3C,EAAE,CAAC,2BAAS,CAAC,UAAU,CAAC,MAAM,EAAE,SAAS,CAAC,CAAC;IAE9C,IAAI,aAAa,EAAE,CAAC;QAClB,KAAK,GAAG,KAAK,CAAC,EAAE,CAAC,2BAAS,CAAC,SAAS,CAAC,cAAc,EAAE,aAAa,CAAC,CAAC;IACtE,CAAC;IAED,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,KAAK,CAAC,KAAK,CAAC,2BAAS,CAAC,UAAU,CAAC,YAAY,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,UAAU,EAAE,KAAK,EAAE,CAAC,CAAC;IAErH,MAAM,KAAK,GAAG,CAAC,KAAK,IAAI,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,EAAO,EAAE,EAAE,CAAC,CAAC;QAC5C,EAAE,EAAE,MAAM,CAAC,EAAE,CAAC,EAAE,IAAI,EAAE,CAAC;QACvB,UAAU,EAAE,MAAM,CAAC,EAAE,CAAC,WAAW,IAAI,EAAE,CAAC;QACxC,SAAS,EAAE,EAAE,CAAC,UAAU,IAAI,IAAI;QAChC,WAAW,EAAE,EAAE,CAAC,YAAY,IAAI,IAAI;QACpC,SAAS,EAAE,MAAM,CAAC,EAAE,CAAC,cAAc,IAAI,EAAE,CAAC;KAC3C,CAAC,CAAC,CAAC;IAEJ,OAAO,GAAG,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE,IAAI,EAAE,EAAE,KAAK,EAAE,EAAE,CAAC,CAAC;AACtD,CAAC,CAAC,CAAC,CAAC;AAEJ;;GAEG;AACH,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,IAAA,2BAAY,EAAC,KAAK,EAAE,GAAgB,EAAE,GAAa,EAAE,EAAE;IAC3E,MAAM,IAAI,GAAG,GAAG,CAAC,IAAY,CAAC;IAE9B,2CAA2C;IAC3C,MAAM,SAAS,GAAG,MAAM,iDAAuB,CAAC,yBAAyB,CAAC,IAAI,CAAC,CAAC;IAChF,IAAI,CAAC,SAAS,EAAE,CAAC;QACf,OAAO,GAAG,CAAC,MAAM,CAAC,oBAAW,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,KAAK,EAAE,iCAAc,CAAC,gBAAgB,EAAE,CAAC,CAAC;IAC5G,CAAC;IAED,MAAM,QAAQ,GAAG,MAAM,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC;IACtC,MAAM,EAAE,aAAa,EAAE,UAAU,EAAE,GAAG,GAAG,CAAC,IAA2D,CAAC;IAEtG,IAAI,CAAC,aAAa,IAAI,CAAC,UAAU,EAAE,CAAC;QAClC,OAAO,GAAG,CAAC,MAAM,CAAC,oBAAW,CAAC,WAAW,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,KAAK,EAAE,2CAA2C,EAAE,CAAC,CAAC;IAC1H,CAAC;IAED,MAAM,EAAE,eAAe,EAAE,GAAG,wDAAa,yCAAyC,GAAC,CAAC;IACpF,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC,KAAK,CAAC,QAAQ,EAAE,aAAa,EAAE,UAAU,CAAC,CAAC;IAEhF,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE,CAAC;QACpB,MAAM,aAAa,GAAQ;YACzB,OAAO,EAAE,KAAK;YACd,KAAK,EAAG,MAAc,CAAC,KAAK,IAAK,MAAc,CAAC,OAAO;YACvD,OAAO,EAAG,MAAc,CAAC,OAAO,IAAK,MAAc,CAAC,KAAK;SAC1D,CAAC;QACF,IAAK,MAAc,CAAC,IAAI;YAAE,aAAa,CAAC,IAAI,GAAI,MAAc,CAAC,IAAI,CAAC;QACpE,IAAK,MAAc,CAAC,OAAO;YAAE,aAAa,CAAC,OAAO,GAAI,MAAc,CAAC,OAAO,CAAC;QAC7E,IAAK,MAAc,CAAC,OAAO;YAAE,aAAa,CAAC,OAAO,GAAI,MAAc,CAAC,OAAO,CAAC;QAC7E,MAAM,UAAU,GAAI,MAAc,CAAC,IAAI,KAAK,qBAAqB,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,oBAAW,CAAC,WAAW,CAAC;QAClG,OAAO,GAAG,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;IACpD,CAAC;IAED,OAAO,GAAG,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,CAAC,IAAI,EAAE,OAAO,EAAE,MAAM,CAAC,OAAO,EAAE,CAAC,CAAC;AACjF,CAAC,CAAC,CAAC,CAAC;AAEJ;;GAEG;AACH,MAAM,CAAC,MAAM,CAAC,YAAY,EAAE,IAAA,2BAAY,EAAC,KAAK,EAAE,GAAgB,EAAE,GAAa,EAAE,EAAE;IACjF,MAAM,IAAI,GAAG,GAAG,CAAC,IAAY,CAAC;IAE9B,2CAA2C;IAC3C,MAAM,SAAS,GAAG,MAAM,iDAAuB,CAAC,yBAAyB,CAAC,IAAI,CAAC,CAAC;IAChF,IAAI,CAAC,SAAS,EAAE,CAAC;QACf,OAAO,GAAG,CAAC,MAAM,CAAC,oBAAW,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,KAAK,EAAE,iCAAc,CAAC,gBAAgB,EAAE,CAAC,CAAC;IAC5G,CAAC;IAED,MAAM,QAAQ,GAAG,MAAM,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC;IACtC,MAAM,EAAE,GAAG,MAAM,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,IAAI,EAAE,CAAC,CAAC,IAAI,EAAE,CAAC;IAE9C,IAAI,CAAC,EAAE;QAAE,OAAO,GAAG,CAAC,MAAM,CAAC,oBAAW,CAAC,WAAW,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,KAAK,EAAE,uBAAuB,EAAE,CAAC,CAAC;IAE7G,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,mBAAQ;SACnC,IAAI,CAAC,2BAAS,CAAC,aAAa,CAAC;SAC7B,MAAM,CAAC,8DAA8D,CAAC;SACtE,EAAE,CAAC,2BAAS,CAAC,SAAS,CAAC,EAAE,EAAE,EAAE,CAAC;SAC9B,WAAW,EAAE,CAAC;IAEjB,IAAI,CAAC,KAAK,IAAI,MAAM,CAAE,KAAa,CAAC,SAAS,CAAC,KAAK,QAAQ,EAAE,CAAC;QAC5D,OAAO,GAAG,CAAC,MAAM,CAAC,oBAAW,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,KAAK,EAAE,iCAAc,CAAC,oBAAoB,EAAE,CAAC,CAAC;IAChH,CAAC;IAED,IAAI,MAAM,CAAE,KAAa,CAAC,MAAM,IAAI,EAAE,CAAC,KAAK,SAAS,EAAE,CAAC;QACtD,OAAO,GAAG,CAAC,MAAM,CAAC,oBAAW,CAAC,WAAW,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,KAAK,EAAE,qCAAqC,EAAE,CAAC,CAAC;IACpH,CAAC;IAED,2DAA2D;IAC3D,IAAK,KAAa,CAAC,UAAU,IAAK,KAAa,CAAC,YAAY,EAAE,CAAC;QAC7D,MAAM,WAAW,GAAG,IAAI,IAAI,CAAE,KAAa,CAAC,YAAY,CAAC,CAAC,OAAO,EAAE,CAAC;QACpE,IAAI,WAAW,GAAG,IAAI,CAAC,GAAG,EAAE,EAAE,CAAC;YAC7B,OAAO,GAAG,CAAC,MAAM,CAAC,oBAAW,CAAC,WAAW,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,KAAK,EAAE,0CAA0C,EAAE,CAAC,CAAC;QACzH,CAAC;IACH,CAAC;IAED,MAAM,mBAAQ,CAAC,IAAI,CAAC,2BAAS,CAAC,aAAa,CAAC,CAAC,MAAM,CAAC,EAAE,MAAM,EAAE,WAAW,EAAE,CAAC,CAAC,EAAE,CAAC,2BAAS,CAAC,SAAS,CAAC,EAAE,EAAE,EAAE,CAAC,CAAC;IAC5G,OAAO,GAAG,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE,IAAI,EAAE,EAAE,WAAW,EAAE,EAAE,EAAE,EAAE,OAAO,EAAE,gCAAgC,EAAE,CAAC,CAAC;AAC3G,CAAC,CAAC,CAAC,CAAC;AAEJ,kBAAe,MAAM,CAAC","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\routes\\game\\defenses.ts"],"sourcesContent":["import { Router, Response } from 'express';\r\nimport { supabase } from '../../config/supabase';\r\nimport { asyncHandler } from '../../middleware/errorHandler';\r\nimport { authenticate, AuthRequest } from '../../middleware/auth';\r\nimport { ERROR_MESSAGES } from '../../constants/response-formats';\r\nimport { DB_TABLES, DB_FIELDS } from '../../constants/database-fields';\r\nimport { HTTP_STATUS } from '@game/shared';\r\nimport { DefenseKey, getDefensesList } from '@game/shared';\r\nimport { EmpireResolutionService } from '../../services/empire/EmpireResolutionService';\r\n\r\nconst router = Router();\r\n\r\nrouter.use(authenticate);\r\n\r\n/**\r\n * Get defenses catalog\r\n */\r\nrouter.get('/catalog', asyncHandler(async (_req: AuthRequest, res: Response) => {\r\n  const catalog = getDefensesList();\r\n  res.json({ success: true, data: { catalog } });\r\n}));\r\n\r\n/**\r\n * Get defenses status\r\n */\r\nrouter.get('/status', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const user = req.user! as any;\r\n\r\n  // Resolve empire using established pattern\r\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\r\n  if (!empireRow) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\r\n  }\r\n\r\n  const empireId = String(empireRow.id);\r\n\r\n  const { DefensesService } = await import('../../services/defenses/DefensesService');\r\n  const status = await DefensesService.getStatus(empireId);\r\n  return res.json({ success: true, data: { status } });\r\n}));\r\n\r\n/**\r\n * Get defenses queue\r\n */\r\nrouter.get('/queue', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const user = req.user! as any;\r\n\r\n  // Resolve empire using established pattern\r\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\r\n  if (!empireRow) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\r\n  }\r\n\r\n  const empireId = String(empireRow.id);\r\n  const locationCoord = String(req.query.locationCoord || '').trim() || undefined;\r\n\r\n  // Build query for defense queue\r\n  let query = supabase\r\n    .from(DB_TABLES.DEFENSE_QUEUE)\r\n    .select('id, defense_key, started_at, completes_at, location_coord')\r\n    .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\r\n    .eq(DB_FIELDS.TECH_QUEUE.STATUS, 'pending');\r\n\r\n  if (locationCoord) {\r\n    query = query.eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, locationCoord);\r\n  }\r\n\r\n  const { data: items } = await query.order(DB_FIELDS.TECH_QUEUE.COMPLETES_AT, { ascending: true, nullsFirst: false });\r\n\r\n  const queue = (items || []).map((it: any) => ({\r\n    id: String(it.id || ''),\r\n    defenseKey: String(it.defense_key || ''),\r\n    startedAt: it.started_at || null,\r\n    completesAt: it.completes_at || null,\r\n    baseCoord: String(it.location_coord || '')\r\n  }));\r\n\r\n  return res.json({ success: true, data: { queue } });\r\n}));\r\n\r\n/**\r\n * Start defense construction\r\n */\r\nrouter.post('/start', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const user = req.user! as any;\r\n\r\n  // Resolve empire using established pattern\r\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\r\n  if (!empireRow) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\r\n  }\r\n\r\n  const empireId = String(empireRow.id);\r\n  const { locationCoord, defenseKey } = req.body as { locationCoord?: string; defenseKey?: DefenseKey };\r\n  \r\n  if (!locationCoord || !defenseKey) {\r\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'locationCoord and defenseKey are required' });\r\n  }\r\n\r\n  const { DefensesService } = await import('../../services/defenses/DefensesService');\r\n  const result = await DefensesService.start(empireId, locationCoord, defenseKey);\r\n  \r\n  if (!result.success) {\r\n    const errorResponse: any = {\r\n      success: false,\r\n      error: (result as any).error ?? (result as any).message,\r\n      message: (result as any).message ?? (result as any).error\r\n    };\r\n    if ((result as any).code) errorResponse.code = (result as any).code;\r\n    if ((result as any).details) errorResponse.details = (result as any).details;\r\n    if ((result as any).reasons) errorResponse.reasons = (result as any).reasons;\r\n    const statusCode = (result as any).code === 'ALREADY_IN_PROGRESS' ? 409 : HTTP_STATUS.BAD_REQUEST;\r\n    return res.status(statusCode).json(errorResponse);\r\n  }\r\n\r\n  return res.json({ success: true, data: result.data, message: result.message });\r\n}));\r\n\r\n/**\r\n * Cancel a pending defense item\r\n */\r\nrouter.delete('/queue/:id', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const user = req.user! as any;\r\n\r\n  // Resolve empire using established pattern\r\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\r\n  if (!empireRow) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\r\n  }\r\n\r\n  const empireId = String(empireRow.id);\r\n  const id = String(req.params.id || '').trim();\r\n  \r\n  if (!id) return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'Invalid queue item id' });\r\n\r\n  const { data: qItem } = await supabase\r\n    .from(DB_TABLES.DEFENSE_QUEUE)\r\n    .select('id, empire_id, defense_key, status, started_at, completes_at')\r\n    .eq(DB_FIELDS.BUILDINGS.ID, id)\r\n    .maybeSingle();\r\n\r\n  if (!qItem || String((qItem as any).empire_id) !== empireId) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.QUEUE_ITEM_NOT_FOUND });\r\n  }\r\n\r\n  if (String((qItem as any).status || '') !== 'pending') {\r\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'Only pending items can be cancelled' });\r\n  }\r\n\r\n  // Check if in progress (has started and not yet completed)\r\n  if ((qItem as any).started_at && (qItem as any).completes_at) {\r\n    const completesAt = new Date((qItem as any).completes_at).getTime();\r\n    if (completesAt > Date.now()) {\r\n      return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'Cannot cancel an in-progress defense yet' });\r\n    }\r\n  }\r\n\r\n  await supabase.from(DB_TABLES.DEFENSE_QUEUE).update({ status: 'cancelled' }).eq(DB_FIELDS.BUILDINGS.ID, id);\r\n  return res.json({ success: true, data: { cancelledId: id }, message: 'Defense construction cancelled' });\r\n}));\r\n\r\nexport default router;\r\n"],"version":3}