19d2cc0694cd2c4534355ad3842bd0de
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const errorHandler_1 = require("../../../middleware/errorHandler");
const express_1 = require("express");
const database_fields_1 = require("../../../constants/database-fields");
const response_formats_1 = require("../../../constants/response-formats");
const database_fields_2 = require("../../../constants/database-fields");
const supabase_1 = require("../../../config/supabase");
const EmpireResolutionService_1 = require("../../../services/empire/EmpireResolutionService");
const router = (0, express_1.Router)();
/**
 * Get empire territories
 * GET /api/game/territories
 *
 * Returns the list of territories (bases/colonies) owned by the authenticated user's empire.
 * Prefers colonies table (with names), falls back to empires.territories if no colonies exist.
 */
router.get('/', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    const user = req.user;
    // Resolve empire using the service
    const empireRow = await EmpireResolutionService_1.EmpireResolutionService.resolveEmpireByUserObject(user);
    if (!empireRow) {
        return res.status(response_formats_1.HTTP_STATUS.NOT_FOUND).json({
            success: false,
            error: response_formats_1.ERROR_MESSAGES.EMPIRE_NOT_FOUND
        });
    }
    const empireId = String(empireRow.id);
    // Prefer colonies (name + coord). If none, fall back to empires.territories and fetch locations.
    const coloniesRes = await supabase_1.supabase
        .from(database_fields_1.DB_TABLES.COLONIES)
        .select('location_coord, name')
        .eq(database_fields_2.DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId);
    let territories = [];
    if ((coloniesRes.data || []).length > 0) {
        // Use colonies data with names
        territories = coloniesRes.data.map((c) => ({
            coord: String(c.location_coord),
            name: c.name || undefined
        }));
    }
    else {
        // Fall back to empires.territories
        const emp = await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.EMPIRES)
            .select(database_fields_2.DB_FIELDS.EMPIRES.TERRITORIES)
            .eq(database_fields_2.DB_FIELDS.BUILDINGS.ID, empireId)
            .maybeSingle();
        const coords = Array.isArray(emp.data?.territories) ? emp.data.territories : [];
        if (coords.length > 0) {
            // Verify coordinates exist in locations table
            const locs = await supabase_1.supabase
                .from(database_fields_1.DB_TABLES.LOCATIONS)
                .select('coord')
                .in('coord', coords);
            territories = (locs.data || []).map((l) => ({
                coord: String(l.coord)
            }));
        }
    }
    return res.json({
        success: true,
        data: { territories }
    });
}));
/**
 * Get detailed territory information
 * GET /api/game/territories/:coord
 *
 * Returns detailed information about a specific territory including:
 * - Basic location info
 * - Colony name (if named)
 * - Owner verification
 */
router.get('/:coord', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    const user = req.user;
    const { coord } = req.params;
    if (!coord) {
        return res.status(response_formats_1.HTTP_STATUS.BAD_REQUEST).json({
            success: false,
            error: 'Territory coordinate is required'
        });
    }
    // Resolve empire using the service
    const empireRow = await EmpireResolutionService_1.EmpireResolutionService.resolveEmpireByUserObject(user);
    if (!empireRow) {
        return res.status(response_formats_1.HTTP_STATUS.NOT_FOUND).json({
            success: false,
            error: response_formats_1.ERROR_MESSAGES.EMPIRE_NOT_FOUND
        });
    }
    const empireId = String(empireRow.id);
    // Get location info
    const { data: location } = await supabase_1.supabase
        .from(database_fields_1.DB_TABLES.LOCATIONS)
        .select('coord, owner_id, result')
        .eq('coord', coord)
        .maybeSingle();
    if (!location) {
        return res.status(response_formats_1.HTTP_STATUS.NOT_FOUND).json({
            success: false,
            error: response_formats_1.ERROR_MESSAGES.TERRITORY_NOT_FOUND
        });
    }
    // Verify ownership
    const userId = user.id || user._id;
    if (String(location.owner_id || '') !== String(userId)) {
        return res.status(response_formats_1.HTTP_STATUS.FORBIDDEN).json({
            success: false,
            error: 'Access denied - territory not owned by your empire'
        });
    }
    // Get colony name if it exists
    const { data: colony } = await supabase_1.supabase
        .from(database_fields_1.DB_TABLES.COLONIES)
        .select(database_fields_2.DB_FIELDS.EMPIRES.NAME)
        .eq(database_fields_2.DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)
        .eq(database_fields_2.DB_FIELDS.BUILDINGS.LOCATION_COORD, coord)
        .maybeSingle();
    const territoryData = {
        coord: location.coord,
        name: colony?.name || null,
        result: location.result,
        owned: true
    };
    return res.json({
        success: true,
        data: territoryData
    });
}));
exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFByb2plY3RzXFxBdHRyaXRpb25cXHBhY2thZ2VzXFxzZXJ2ZXJcXHNyY1xccm91dGVzXFxnYW1lXFx0ZXJyaXRvcmllc1xcaW5kZXgudHMiLCJtYXBwaW5ncyI6Ijs7QUFDQSxtRUFBZ0U7QUFDaEUscUNBQTJDO0FBQzNDLHdFQUErRDtBQUMvRCwwRUFBa0Y7QUFFbEYsd0VBQStEO0FBQy9ELHVEQUFvRDtBQUNwRCw4RkFBMkY7QUFDM0YsTUFBTSxNQUFNLEdBQVcsSUFBQSxnQkFBTSxHQUFFLENBQUM7QUFFaEM7Ozs7OztHQU1HO0FBQ0gsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsSUFBQSwyQkFBWSxFQUFDLEtBQUssRUFBRSxHQUFnQixFQUFFLEdBQWEsRUFBRSxFQUFFO0lBQ3JFLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFZLENBQUM7SUFFOUIsbUNBQW1DO0lBQ25DLE1BQU0sU0FBUyxHQUFHLE1BQU0saURBQXVCLENBQUMseUJBQXlCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEYsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2YsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLDhCQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzVDLE9BQU8sRUFBRSxLQUFLO1lBQ2QsS0FBSyxFQUFFLGlDQUFjLENBQUMsZ0JBQWdCO1NBQ3ZDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBRXRDLGlHQUFpRztJQUNqRyxNQUFNLFdBQVcsR0FBRyxNQUFNLG1CQUFRO1NBQy9CLElBQUksQ0FBQywyQkFBUyxDQUFDLFFBQVEsQ0FBQztTQUN4QixNQUFNLENBQUMsc0JBQXNCLENBQUM7U0FDOUIsRUFBRSxDQUFDLDJCQUFTLENBQUMsU0FBUyxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUUvQyxJQUFJLFdBQVcsR0FBNEMsRUFBRSxDQUFDO0lB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UyxDQUFDLGNBQWMsRUFBRSxLQUFLLENBQUM7U0FDN0MsV0FBVyxFQUFFLENBQUM7SUFFakIsTUFBTSxhQUFhLEdBQUc7UUFDcEIsS0FBSyxFQUFFLFFBQVEsQ0FBQyxLQUFLO1FBQ3JCLElBQUksRUFBRSxNQUFNLEVBQUUsSUFBSSxJQUFJLElBQUk7UUFDMUIsTUFBTSxFQUFFLFFBQVEsQ0FBQyxNQUFNO1FBQ3ZCLEtBQUssRUFBRSxJQUFJO0tBQ1osQ0FBQztJQUVGLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQztRQUNkLE9BQU8sRUFBRSxJQUFJO1FBQ2IsSUFBSSxFQUFFLGFBQWE7S0FDcEIsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUVKLGtCQUFlLE1BQU0sQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcUHJvamVjdHNcXEF0dHJpdGlvblxccGFja2FnZXNcXHNlcnZlclxcc3JjXFxyb3V0ZXNcXGdhbWVcXHRlcnJpdG9yaWVzXFxpbmRleC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBdXRoUmVxdWVzdCB9IGZyb20gJy4uLy4uLy4uL21pZGRsZXdhcmUvYXV0aCc7XG5pbXBvcnQgeyBhc3luY0hhbmRsZXIgfSBmcm9tICcuLi8uLi8uLi9taWRkbGV3YXJlL2Vycm9ySGFuZGxlcic7XG5pbXBvcnQgeyBSb3V0ZXIsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBEQl9UQUJMRVMgfSBmcm9tICcuLi8uLi8uLi9jb25zdGFudHMvZGF0YWJhc2UtZmllbGRzJztcbmltcG9ydCB7IEhUVFBfU1RBVFVTLCBFUlJPUl9NRVNTQUdFUyB9IGZyb20gJy4uLy4uLy4uL2NvbnN0YW50cy9yZXNwb25zZS1mb3JtYXRzJztcblxuaW1wb3J0IHsgREJfRklFTERTIH0gZnJvbSAnLi4vLi4vLi4vY29uc3RhbnRzL2RhdGFiYXNlLWZpZWxkcyc7XG5pbXBvcnQgeyBzdXBhYmFzZSB9IGZyb20gJy4uLy4uLy4uL2NvbmZpZy9zdXBhYmFzZSc7XG5pbXBvcnQgeyBFbXBpcmVSZXNvbHV0aW9uU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2VzL2VtcGlyZS9FbXBpcmVSZXNvbHV0aW9uU2VydmljZSc7XG5jb25zdCByb3V0ZXI6IFJvdXRlciA9IFJvdXRlcigpO1xuXG4vKipcbiAqIEdldCBlbXBpcmUgdGVycml0b3JpZXNcbiAqIEdFVCAvYXBpL2dhbWUvdGVycml0b3JpZXNcbiAqIFxuICogUmV0dXJucyB0aGUgbGlzdCBvZiB0ZXJyaXRvcmllcyAoYmFzZXMvY29sb25pZXMpIG93bmVkIGJ5IHRoZSBhdXRoZW50aWNhdGVkIHVzZXIncyBlbXBpcmUuXG4gKiBQcmVmZXJzIGNvbG9uaWVzIHRhYmxlICh3aXRoIG5hbWVzKSwgZmFsbHMgYmFjayB0byBlbXBpcmVzLnRlcnJpdG9yaWVzIGlmIG5vIGNvbG9uaWVzIGV4aXN0LlxuICovXG5yb3V0ZXIuZ2V0KCcvJywgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXE6IEF1dGhSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIGNvbnN0IHVzZXIgPSByZXEudXNlciEgYXMgYW55O1xuXG4gIC8vIFJlc29sdmUgZW1waXJlIHVzaW5nIHRoZSBzZXJ2aWNlXG4gIGNvbnN0IGVtcGlyZVJvdyA9IGF3YWl0IEVtcGlyZVJlc29sdXRpb25TZXJ2aWNlLnJlc29sdmVFbXBpcmVCeVVzZXJPYmplY3QodXNlcik7XG4gIGlmICghZW1waXJlUm93KSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuTk9UX0ZPVU5EKS5qc29uKHsgXG4gICAgICBzdWNjZXNzOiBmYWxzZSwgXG4gICAgICBlcnJvcjogRVJST1JfTUVTU0FHRVMuRU1QSVJFX05PVF9GT1VORCBcbiAgICB9KTtcbiAgfVxuXG4gIGNvbnN0IGVtcGlyZUlkID0gU3RyaW5nKGVtcGlyZVJvdy5pZCk7XG5cbiAgLy8gUHJlZmVyIGNvbG9uaWVzIChuYW1lICsgY29vcmQpLiBJZiBub25lLCBmYWxsIGJhY2sgdG8gZW1waXJlcy50ZXJyaXRvcmllcyBhbmQgZmV0Y2ggbG9jYXRpb25zLlxuICBjb25zdCBjb2xvbmllc1JlcyA9IGF3YWl0IHN1cGFiYXNlXG4gICAgLmZyb20oREJfVEFCTEVTLkNPTE9OSUVTKVxuICAgIC5zZWxlY3QoJ2xvY2F0aW9uX2Nvb3JkLCBuYW1lJylcbiAgICAuZXEoREJfRklFTERTLkJVSUxESU5HUy5FTVBJUkVfSUQsIGVtcGlyZUlkKTtcblxuICBsZXQgdGVycml0b3JpZXM6IEFycmF5PHsgY29vcmQ6IHN0cmluZzsgbmFtZT86IHN0cmluZyB9PiA9IFtdO1xuICBcbiAgaWYgKChjb2xvbmllc1Jlcy5kYXRhIHx8IFtdKS5sZW5ndGggPiAwKSB7XG4gICAgLy8gVXNlIGNvbG9uaWVzIGRhdGEgd2l0aCBuYW1lc1xuICAgIHRlcnJpdG9yaWVzID0gKGNvbG9uaWVzUmVzLmRhdGEgYXMgYW55W10pLm1hcCgoYykgPT4gKHsgXG4gICAgICBjb29yZDogU3RyaW5nKGMubG9jYXRpb25fY29vcmQpLCBcbiAgICAgIG5hbWU6IGMubmFtZSB8fCB1bmRlZmluZWQgXG4gICAgfSkpO1xuICB9IGVsc2Uge1xuICAgIC8vIEZhbGwgYmFjayB0byBlbXBpcmVzLnRlcnJpdG9yaWVzXG4gICAgY29uc3QgZW1wID0gYXdhaXQgc3VwYWJhc2VcbiAgICAgIC5mcm9tKERCX1RBQkxFUy5FTVBJUkVTKVxuICAgICAgLnNlbGVjdChEQl9GSUVMRFMuRU1QSVJFUy5URVJSSVRPUklFUylcbiAgICAgIC5lcShEQl9GSUVMRFMuQlVJTERJTkdTLklELCBlbXBpcmVJZClcbiAgICAgIC5tYXliZVNpbmdsZSgpO1xuICAgIFxuICAgIGNvbnN0IGNvb3Jkczogc3RyaW5nW10gPSBBcnJheS5pc0FycmF5KGVtcC5kYXRhPy50ZXJyaXRvcmllcykgPyBlbXAuZGF0YSEudGVycml0b3JpZXMgOiBbXTtcbiAgICBcbiAgICBpZiAoY29vcmRzLmxlbmd0aCA+IDApIHtcbiAgICAgIC8vIFZlcmlmeSBjb29yZGluYXRlcyBleGlzdCBpbiBsb2NhdGlvbnMgdGFibGVcbiAgICAgIGNvbnN0IGxvY3MgPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgICAuZnJvbShEQl9UQUJMRVMuTE9DQVRJT05TKVxuICAgICAgICAuc2VsZWN0KCdjb29yZCcpXG4gICAgICAgIC5pbignY29vcmQnLCBjb29yZHMpO1xuICAgICAgXG4gICAgICB0ZXJyaXRvcmllcyA9IChsb2NzLmRhdGEgfHwgW10pLm1hcCgobDogYW55KSA9PiAoeyBcbiAgICAgICAgY29vcmQ6IFN0cmluZyhsLmNvb3JkKSBcbiAgICAgIH0pKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVzLmpzb24oeyBcbiAgICBzdWNjZXNzOiB0cnVlLCBcbiAgICBkYXRhOiB7IHRlcnJpdG9yaWVzIH0gXG4gIH0pO1xufSkpO1xuXG4vKipcbiAqIEdldCBkZXRhaWxlZCB0ZXJyaXRvcnkgaW5mb3JtYXRpb25cbiAqIEdFVCAvYXBpL2dhbWUvdGVycml0b3JpZXMvOmNvb3JkXG4gKiBcbiAqIFJldHVybnMgZGV0YWlsZWQgaW5mb3JtYXRpb24gYWJvdXQgYSBzcGVjaWZpYyB0ZXJyaXRvcnkgaW5jbHVkaW5nOlxuICogLSBCYXNpYyBsb2NhdGlvbiBpbmZvXG4gKiAtIENvbG9ueSBuYW1lIChpZiBuYW1lZClcbiAqIC0gT3duZXIgdmVyaWZpY2F0aW9uXG4gKi9cbnJvdXRlci5nZXQoJy86Y29vcmQnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcTogQXV0aFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgY29uc3QgdXNlciA9IHJlcS51c2VyISBhcyBhbnk7XG4gIGNvbnN0IHsgY29vcmQgfSA9IHJlcS5wYXJhbXM7XG5cbiAgaWYgKCFjb29yZCkge1xuICAgIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLkJBRF9SRVFVRVNUKS5qc29uKHsgXG4gICAgICBzdWNjZXNzOiBmYWxzZSwgXG4gICAgICBlcnJvcjogJ1RlcnJpdG9yeSBjb29yZGluYXRlIGlzIHJlcXVpcmVkJyBcbiAgICB9KTtcbiAgfVxuXG4gIC8vIFJlc29sdmUgZW1waXJlIHVzaW5nIHRoZSBzZXJ2aWNlXG4gIGNvbnN0IGVtcGlyZVJvdyA9IGF3YWl0IEVtcGlyZVJlc29sdXRpb25TZXJ2aWNlLnJlc29sdmVFbXBpcmVCeVVzZXJPYmplY3QodXNlcik7XG4gIGlmICghZW1waXJlUm93KSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuTk9UX0ZPVU5EKS5qc29uKHsgXG4gICAgICBzdWNjZXNzOiBmYWxzZSwgXG4gICAgICBlcnJvcjogRVJST1JfTUVTU0FHRVMuRU1QSVJFX05PVF9GT1VORCBcbiAgICB9KTtcbiAgfVxuXG4gIGNvbnN0IGVtcGlyZUlkID0gU3RyaW5nKGVtcGlyZVJvdy5pZCk7XG5cbiAgLy8gR2V0IGxvY2F0aW9uIGluZm9cbiAgY29uc3QgeyBkYXRhOiBsb2NhdGlvbiB9ID0gYXdhaXQgc3VwYWJhc2VcbiAgICAuZnJvbShEQl9UQUJMRVMuTE9DQVRJT05TKVxuICAgIC5zZWxlY3QoJ2Nvb3JkLCBvd25lcl9pZCwgcmVzdWx0JylcbiAgICAuZXEoJ2Nvb3JkJywgY29vcmQpXG4gICAgLm1heWJlU2luZ2xlKCk7XG5cbiAgaWYgKCFsb2NhdGlvbikge1xuICAgIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLk5PVF9GT1VORCkuanNvbih7IFxuICAgICAgc3VjY2VzczogZmFsc2UsIFxuICAgICAgZXJyb3I6IEVSUk9SX01FU1NBR0VTLlRFUlJJVE9SWV9OT1RfRk9VTkQgXG4gICAgfSk7XG4gIH1cblxuICAvLyBWZXJpZnkgb3duZXJzaGlwXG4gIGNvbnN0IHVzZXJJZCA9IHVzZXIuaWQgfHwgdXNlci5faWQ7XG4gIGlmIChTdHJpbmcobG9jYXRpb24ub3duZXJfaWQgfHwgJycpICE9PSBTdHJpbmcodXNlcklkKSkge1xuICAgIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLkZPUkJJRERFTikuanNvbih7IFxuICAgICAgc3VjY2VzczogZmFsc2UsIFxuICAgICAgZXJyb3I6ICdBY2Nlc3MgZGVuaWVkIC0gdGVycml0b3J5IG5vdCBvd25lZCBieSB5b3VyIGVtcGlyZScgXG4gICAgfSk7XG4gIH1cblxuICAvLyBHZXQgY29sb255IG5hbWUgaWYgaXQgZXhpc3RzXG4gIGNvbnN0IHsgZGF0YTogY29sb255IH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgIC5mcm9tKERCX1RBQkxFUy5DT0xPTklFUylcbiAgICAuc2VsZWN0KERCX0ZJRUxEUy5FTVBJUkVTLk5BTUUpXG4gICAgLmVxKERCX0ZJRUxEUy5CVUlMRElOR1MuRU1QSVJFX0lELCBlbXBpcmVJZClcbiAgICAuZXEoREJfRklFTERTLkJVSUxESU5HUy5MT0NBVElPTl9DT09SRCwgY29vcmQpXG4gICAgLm1heWJlU2luZ2xlKCk7XG5cbiAgY29uc3QgdGVycml0b3J5RGF0YSA9IHtcbiAgICBjb29yZDogbG9jYXRpb24uY29vcmQsXG4gICAgbmFtZTogY29sb255Py5uYW1lIHx8IG51bGwsXG4gICAgcmVzdWx0OiBsb2NhdGlvbi5yZXN1bHQsXG4gICAgb3duZWQ6IHRydWVcbiAgfTtcblxuICByZXR1cm4gcmVzLmpzb24oeyBcbiAgICBzdWNjZXNzOiB0cnVlLCBcbiAgICBkYXRhOiB0ZXJyaXRvcnlEYXRhIFxuICB9KTtcbn0pKTtcblxuZXhwb3J0IGRlZmF1bHQgcm91dGVyO1xuXG5cblxuXG5cblxuIl0sInZlcnNpb24iOjN9