{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\routes\\game\\territories\\index.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\routes\\game\\territories\\index.ts"],"sourcesContent":["import { AuthRequest } from '../../../middleware/auth';\nimport { asyncHandler } from '../../../middleware/errorHandler';\nimport { Router, Response } from 'express';\nimport { DB_TABLES } from '../../../constants/database-fields';\nimport { HTTP_STATUS, ERROR_MESSAGES } from '../../../constants/response-formats';\n\nimport { DB_FIELDS } from '../../../constants/database-fields';\nimport { supabase } from '../../../config/supabase';\nimport { EmpireResolutionService } from '../../../services/empire/EmpireResolutionService';\nconst router: Router = Router();\n\n/**\n * Get empire territories\n * GET /api/game/territories\n * \n * Returns the list of territories (bases/colonies) owned by the authenticated user's empire.\n * Prefers colonies table (with names), falls back to empires.territories if no colonies exist.\n */\nrouter.get('/', asyncHandler(async (req: AuthRequest, res: Response) => {\n  const user = req.user! as any;\n\n  // Resolve empire using the service\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\n  if (!empireRow) {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ \n      success: false, \n      error: ERROR_MESSAGES.EMPIRE_NOT_FOUND \n    });\n  }\n\n  const empireId = String(empireRow.id);\n\n  // Prefer colonies (name + coord). If none, fall back to empires.territories and fetch locations.\n  const coloniesRes = await supabase\n    .from(DB_TABLES.COLONIES)\n    .select('location_coord, name')\n    .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId);\n\n  let territories: Array<{ coord: string; name?: string }> = [];\n  \n  if ((coloniesRes.data || []).length > 0) {\n    // Use colonies data with names\n    territories = (coloniesRes.data as any[]).map((c) => ({ \n      coord: String(c.location_coord), \n      name: c.name || undefined \n    }));\n  } else {\n    // Fall back to empires.territories\n    const emp = await supabase\n      .from(DB_TABLES.EMPIRES)\n      .select(DB_FIELDS.EMPIRES.TERRITORIES)\n      .eq(DB_FIELDS.BUILDINGS.ID, empireId)\n      .maybeSingle();\n    \n    const coords: string[] = Array.isArray(emp.data?.territories) ? emp.data!.territories : [];\n    \n    if (coords.length > 0) {\n      // Verify coordinates exist in locations table\n      const locs = await supabase\n        .from(DB_TABLES.LOCATIONS)\n        .select('coord')\n        .in('coord', coords);\n      \n      territories = (locs.data || []).map((l: any) => ({ \n        coord: String(l.coord) \n      }));\n    }\n  }\n\n  return res.json({ \n    success: true, \n    data: { territories } \n  });\n}));\n\n/**\n * Get detailed territory information\n * GET /api/game/territories/:coord\n * \n * Returns detailed information about a specific territory including:\n * - Basic location info\n * - Colony name (if named)\n * - Owner verification\n */\nrouter.get('/:coord', asyncHandler(async (req: AuthRequest, res: Response) => {\n  const user = req.user! as any;\n  const { coord } = req.params;\n\n  if (!coord) {\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({ \n      success: false, \n      error: 'Territory coordinate is required' \n    });\n  }\n\n  // Resolve empire using the service\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\n  if (!empireRow) {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ \n      success: false, \n      error: ERROR_MESSAGES.EMPIRE_NOT_FOUND \n    });\n  }\n\n  const empireId = String(empireRow.id);\n\n  // Get location info\n  const { data: location } = await supabase\n    .from(DB_TABLES.LOCATIONS)\n    .select('coord, owner_id, result')\n    .eq('coord', coord)\n    .maybeSingle();\n\n  if (!location) {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ \n      success: false, \n      error: ERROR_MESSAGES.TERRITORY_NOT_FOUND \n    });\n  }\n\n  // Verify ownership\n  const userId = user.id || user._id;\n  if (String(location.owner_id || '') !== String(userId)) {\n    return res.status(HTTP_STATUS.FORBIDDEN).json({ \n      success: false, \n      error: 'Access denied - territory not owned by your empire' \n    });\n  }\n\n  // Get colony name if it exists\n  const { data: colony } = await supabase\n    .from(DB_TABLES.COLONIES)\n    .select(DB_FIELDS.EMPIRES.NAME)\n    .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n    .eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, coord)\n    .maybeSingle();\n\n  const territoryData = {\n    coord: location.coord,\n    name: colony?.name || null,\n    result: location.result,\n    owned: true\n  };\n\n  return res.json({ \n    success: true, \n    data: territoryData \n  });\n}));\n\nexport default router;\n\n\n\n\n\n\n"],"version":3}