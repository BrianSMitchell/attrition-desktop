{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\routes\\sync.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\routes\\sync.ts"],"sourcesContent":["import { Router, Response } from 'express';\nimport { ERROR_MESSAGES } from '../constants/response-formats';\nimport { API_ENDPOINTS } from '../constants/api-endpoints';\n\n\n// Constants imports for eliminating hardcoded values\nimport { DB_TABLES, DB_FIELDS } from '../constants/database-fields';\n\nimport { supabase } from '../config/supabase';\nimport { asyncHandler } from '../middleware/errorHandler';\nimport { authenticate, AuthRequest } from '../middleware/auth';\nimport { ResourceService } from '../services/resources/ResourceService';\nimport { EconomyService } from '../services/economy/EconomyService';\n\nimport { HTTP_STATUS } from '@game/shared';\nimport { STATUS_CODES } from '@game/shared';\nimport { getTechSpec, getTechnologyList } from '@game/shared';\nimport { getBuildingsList, getDefensesList, getUnitsList } from '@game/shared';\nconst router: Router = Router();\n\n// All sync routes require authentication\nrouter.use(authenticate);\n\n/**\n * Simple status endpoint for network connectivity testing\n * Returns basic server status information\n */\nrouter.get(API_ENDPOINTS.SYSTEM.STATUS, (req, res) => {\n  res.json({\n    success: true,\n    data: {\n      status: 'OK',\n      version: '1.0.0',\n      startedAt: new Date(process.uptime() * 1000).toISOString(),\n      uptimeSeconds: Math.floor(process.uptime()),\n      playersOnline: 0, // TODO: Implement actual player count\n      socketsConnected: 0 // TODO: Implement actual socket count\n    }\n  });\n});\n\n/**\n * Bootstrap endpoint for desktop application\n * Returns all catalog data (tech, buildings, defenses, units) and current profile snapshot\n * This endpoint provides all the static data needed for offline caching plus current user state\n */\nrouter.get('/bootstrap', asyncHandler(async (req: AuthRequest, res: Response) => {\n  const user = req.user!;\n  const userId = user.id; // Supabase uses UUID directly, no ObjectId casting needed\n\n  // Get user's empire using Supabase query\n  const { data: empire, error: empireError } = await supabase\n    .from(DB_TABLES.EMPIRES)\n    .select('*')\n    .eq(DB_FIELDS.EMPIRES.USER_ID, userId)\n    .maybeSingle();\n\n  if (empireError || !empire) {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({\n      success: false,\n      code: ERROR_MESSAGES.NOT_FOUND,\n      message: ERROR_MESSAGES.EMPIRE_NOT_FOUND,\n      details: { userId }\n    });\n  }\n\n  // Update empire resources before creating snapshot\n  const empireId = empire.id; // Supabase uses UUID directly as string\n  const resourceUpdate = await ResourceService.updateEmpireResources(empireId);\n\n// Compute economy breakdown for profile (using Supabase-based EconomyService)\nconst totalCreditsPerHour = await EconomyService.sumCreditsPerHourForEmpire(empireId);\nconst economyBreakdown = { totalCreditsPerHour } as { totalCreditsPerHour: number };\n\n  // Compute technology score from researched technologies\n  function computeTechnologyScore(empireData: any): number {\n    const techLevels = empireData.tech_levels as Record<string, number> | undefined;\n    if (!techLevels) return STATUS_CODES.SUCCESS;\n\n    let totalScore = 0;\n    for (const [techKey, level] of Object.entries(techLevels)) {\n      if (level >= 1) {\n        try {\n          const spec = getTechSpec(techKey as any);\n          totalScore += spec.creditsCost;\n        } catch (error) {\n          // Skip unknown tech keys\n          console.warn(`[SyncService.bootstrap] Unknown tech key: ${techKey}`);\n        }\n      }\n    }\n    return totalScore;\n  }\n\nconst technologyScore = computeTechnologyScore(empire);\n  const fleetScore = 0; // Placeholder until fleet system is implemented\n  const level = Math.pow(economyBreakdown.totalCreditsPerHour * 100 + fleetScore + technologyScore, 0.25);\n\n  // Gather all catalog data\n  const catalogs = {\n    technologies: getTechnologyList(),\n    buildings: getBuildingsList(),\n    defenses: getDefensesList(),\n    units: getUnitsList()\n  };\n\n  // Create profile snapshot\n  const profileSnapshot = {\n    user: {\n      id: user.id,\n      username: user.username,\n      email: user.email\n    },\nempire,\n    profile: {\n      economyPerHour: economyBreakdown.totalCreditsPerHour,\n      fleetScore,\n      technologyScore,\n      level\n    },\n    lastResourceUpdate: resourceUpdate.resourcesGained,\n    creditsPerHour: resourceUpdate.creditsPerHour,\n    serverInfo: {\n      name: 'Alpha Server',\n      version: '1.0.0',\n      universeSize: { width: 100, height: 100 }\n    }\n  };\n\n  // Generate version identifiers for caching validation\n  const version = {\n    catalogs: Date.now().toString(), // Simple timestamp-based versioning for now\n    profile: empire.last_resource_update?.getTime()?.toString() || Date.now().toString(),\n    timestamp: new Date().toISOString()\n  };\n\n  console.log(`[SyncService.bootstrap] Generated bootstrap data for empire ${empire.id} with ${catalogs.technologies.length} technologies, ${catalogs.buildings.length} buildings, ${catalogs.defenses.length} defenses, ${catalogs.units.length} units`);\n\n  res.json({\n    success: true,\n    data: {\n      version,\n      catalogs,\n      profileSnapshot\n    },\n    message: 'Bootstrap data loaded successfully'\n  });\n}));\n\nexport default router;\n\n\n\n\n\n"],"version":3}