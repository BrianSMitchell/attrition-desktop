{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\systems\\__tests__\\DebrisSystem.test.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\systems\\__tests__\\DebrisSystem.test.ts"],"sourcesContent":["import { DebrisSystem } from '../DebrisSystem';\nimport { Location, Empire } from '../../../../shared/src/types';\n\nimport { TIMEOUTS, GAME_CONSTANTS } from '@game/shared';\ndescribe('DebrisSystem', () => {\n  let debrisSystem: DebrisSystem;\n  let locations: Map<string, Location>;\n  let empires: Map<string, Empire>;\n\n  beforeEach(() => {\n    // Set up test data\n    locations = new Map<string, Location>();\n    empires = new Map<string, Empire>();\n\n    // Create test asteroid\n    locations.set('A00:10:22:10', {\n      coord: 'A00:10:22:10',\n      type: 'asteroid',\n      properties: {\n        fertility: 0,\n        resources: {\n          metal: 100,\n          energy: GAME_CONSTANTS.STARTING_ENERGY,\n          research: 0\n        }\n      },\n      owner: null,\n      createdAt: new Date()\n    });\n\n    // Create test empire\n    empires.set('empire1', {\n      _id: 'empire1',\n      userId: 'user1',\n      name: 'Test Empire',\n      resources: {\n        credits: 1000,\n        energy: GAME_CONSTANTS.STARTING_ENERGY\n      },\n      creditsRemainderMilli: 0,\n      baseCount: 1,\n      hasDeletedBase: false,\n      territories: [],\n      createdAt: new Date(),\n      updatedAt: new Date()\n    });\n\n    // Initialize system\n    debrisSystem = new DebrisSystem(locations, empires);\n  });\n\n  afterEach(() => {\n    // Clean up\n    debrisSystem.stop();\n  });\n\n  test('adds recycler to asteroid', () => {\n    const result = debrisSystem.addRecycler('A00:10:22:10', 'empire1');\n    expect(result).toBe(true);\n\n    const location = locations.get('A00:10:22:10');\n    expect(location?.debris?.recyclers.length).toBe(1);\n    expect(location?.debris?.recyclers[0].empireId).toBe('empire1');\n  });\n\n  test('prevents duplicate recyclers from same empire', () => {\n    debrisSystem.addRecycler('A00:10:22:10', 'empire1');\n    const result = debrisSystem.addRecycler('A00:10:22:10', 'empire1');\n    expect(result).toBe(false);\n\n    const location = locations.get('A00:10:22:10');\n    expect(location?.debris?.recyclers.length).toBe(1);\n  });\n\n  test('removes recycler from asteroid', () => {\n    debrisSystem.addRecycler('A00:10:22:10', 'empire1');\n    const result = debrisSystem.removeRecycler('A00:10:22:10', 'empire1');\n    expect(result).toBe(true);\n\n    const location = locations.get('A00:10:22:10');\n    expect(location?.debris?.recyclers.length).toBe(0);\n  });\n\n  test('generates debris over time', async () => {\n    const location = locations.get('A00:10:22:10')!;\n    \n    // Ensure debris is initialized\n    expect(location.debris).toBeDefined();\n    const initialAmount = location.debris!.amount;\n    const generationRate = location.debris!.generationRate;\n\n    // Wait for 2 seconds of debris generation\n    await new Promise(resolve => setTimeout(resolve, TIMEOUTS.TWO_SECONDS));\n\n    // Should have approximately 2 seconds worth of debris\n    const expectedMinimum = initialAmount + (generationRate * 1.5); // Allow some wiggle room\n    expect(location.debris!.amount).toBeGreaterThan(expectedMinimum);\n  });\n\n  test('collects and distributes debris among recyclers', async () => {\n    // Add two empires with recyclers\n    empires.set('empire2', {\n      _id: 'empire2',\n      userId: 'user2',\n      name: 'Test Empire 2',\n      resources: {\n        credits: 1000,\n        energy: GAME_CONSTANTS.STARTING_ENERGY\n      },\n      creditsRemainderMilli: 0,\n      baseCount: 1,\n      hasDeletedBase: false,\n      territories: [],\n      createdAt: new Date(),\n      updatedAt: new Date()\n    });\n\n    const location = locations.get('A00:10:22:10')!;\n    location.debris = {\n      amount: 100,\n      generationRate: 5,\n      recyclers: []\n    };\n\n    // Add recyclers from both empires\n    debrisSystem.addRecycler('A00:10:22:10', 'empire1');\n    debrisSystem.addRecycler('A00:10:22:10', 'empire2');\n\n    // Wait for collection to occur\n    await new Promise(resolve => setTimeout(resolve, 1100));\n\n    // Check that debris was collected and credits distributed\n    const empire1 = empires.get('empire1')!;\n    const empire2 = empires.get('empire2')!;\n\n    // Both empires should have received credits\n    expect(empire1.resources.credits).toBeGreaterThan(1000);\n    expect(empire2.resources.credits).toBeGreaterThan(1000);\n\n    // Credits should be roughly equal between empires\n    const creditDiff = Math.abs(empire1.resources.credits - empire2.resources.credits);\n    expect(creditDiff).toBeLessThanOrEqual(1); // Allow for rounding differences\n  });\n});"],"version":3}