ca10d3f047c2e52a66da8f34f2aabf5f
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const DebrisSystem_1 = require("../DebrisSystem");
const shared_1 = require("@game/shared");
describe('DebrisSystem', () => {
    let debrisSystem;
    let locations;
    let empires;
    beforeEach(() => {
        // Set up test data
        locations = new Map();
        empires = new Map();
        // Create test asteroid
        locations.set('A00:10:22:10', {
            coord: 'A00:10:22:10',
            type: 'asteroid',
            properties: {
                fertility: 0,
                resources: {
                    metal: 100,
                    energy: shared_1.GAME_CONSTANTS.STARTING_ENERGY,
                    research: 0
                }
            },
            owner: null,
            createdAt: new Date()
        });
        // Create test empire
        empires.set('empire1', {
            _id: 'empire1',
            userId: 'user1',
            name: 'Test Empire',
            resources: {
                credits: 1000,
                energy: shared_1.GAME_CONSTANTS.STARTING_ENERGY
            },
            creditsRemainderMilli: 0,
            baseCount: 1,
            hasDeletedBase: false,
            territories: [],
            createdAt: new Date(),
            updatedAt: new Date()
        });
        // Initialize system
        debrisSystem = new DebrisSystem_1.DebrisSystem(locations, empires);
    });
    afterEach(() => {
        // Clean up
        debrisSystem.stop();
    });
    test('adds recycler to asteroid', () => {
        const result = debrisSystem.addRecycler('A00:10:22:10', 'empire1');
        expect(result).toBe(true);
        const location = locations.get('A00:10:22:10');
        expect(location?.debris?.recyclers.length).toBe(1);
        expect(location?.debris?.recyclers[0].empireId).toBe('empire1');
    });
    test('prevents duplicate recyclers from same empire', () => {
        debrisSystem.addRecycler('A00:10:22:10', 'empire1');
        const result = debrisSystem.addRecycler('A00:10:22:10', 'empire1');
        expect(result).toBe(false);
        const location = locations.get('A00:10:22:10');
        expect(location?.debris?.recyclers.length).toBe(1);
    });
    test('removes recycler from asteroid', () => {
        debrisSystem.addRecycler('A00:10:22:10', 'empire1');
        const result = debrisSystem.removeRecycler('A00:10:22:10', 'empire1');
        expect(result).toBe(true);
        const location = locations.get('A00:10:22:10');
        expect(location?.debris?.recyclers.length).toBe(0);
    });
    test('generates debris over time', async () => {
        const location = locations.get('A00:10:22:10');
        // Ensure debris is initialized
        expect(location.debris).toBeDefined();
        const initialAmount = location.debris.amount;
        const generationRate = location.debris.generationRate;
        // Wait for 2 seconds of debris generation
        await new Promise(resolve => setTimeout(resolve, shared_1.TIMEOUTS.TWO_SECONDS));
        // Should have approximately 2 seconds worth of debris
        const expectedMinimum = initialAmount + (generationRate * 1.5); // Allow some wiggle room
        expect(location.debris.amount).toBeGreaterThan(expectedMinimum);
    });
    test('collects and distributes debris among recyclers', async () => {
        // Add two empires with recyclers
        empires.set('empire2', {
            _id: 'empire2',
            userId: 'user2',
            name: 'Test Empire 2',
            resources: {
                credits: 1000,
                energy: shared_1.GAME_CONSTANTS.STARTING_ENERGY
            },
            creditsRemainderMilli: 0,
            baseCount: 1,
            hasDeletedBase: false,
            territories: [],
            createdAt: new Date(),
            updatedAt: new Date()
        });
        const location = locations.get('A00:10:22:10');
        location.debris = {
            amount: 100,
            generationRate: 5,
            recyclers: []
        };
        // Add recyclers from both empires
        debrisSystem.addRecycler('A00:10:22:10', 'empire1');
        debrisSystem.addRecycler('A00:10:22:10', 'empire2');
        // Wait for collection to occur
        await new Promise(resolve => setTimeout(resolve, 1100));
        // Check that debris was collected and credits distributed
        const empire1 = empires.get('empire1');
        const empire2 = empires.get('empire2');
        // Both empires should have received credits
        expect(empire1.resources.credits).toBeGreaterThan(1000);
        expect(empire2.resources.credits).toBeGreaterThan(1000);
        // Credits should be roughly equal between empires
        const creditDiff = Math.abs(empire1.resources.credits - empire2.resources.credits);
        expect(creditDiff).toBeLessThanOrEqual(1); // Allow for rounding differences
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFByb2plY3RzXFxBdHRyaXRpb25cXHBhY2thZ2VzXFxzZXJ2ZXJcXHNyY1xcc3lzdGVtc1xcX190ZXN0c19fXFxEZWJyaXNTeXN0ZW0udGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLGtEQUErQztBQUcvQyx5Q0FBd0Q7QUFDeEQsUUFBUSxDQUFDLGNBQWMsRUFBRSxHQUFHLEVBQUU7SUFDNUIsSUFBSSxZQUEwQixDQUFDO0lBQy9CLElBQUksU0FBZ0MsQ0FBQztJQUNyQyxJQUFJLE9BQTRCLENBQUM7SUFFakMsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLG1CQUFtQjtRQUNuQixTQUFTLEdBQUcsSUFBSSxHQUFHLEVBQW9CLENBQUM7UUFDeEMsT0FBTyxHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO1FBRXBDLHVCQUF1QjtRQUN2QixTQUFTLENBQUMsR0FBRyxDQUFDLGNBQWMsRUFBRTtZQUM1QixLQUFLLEVBQUUsY0FBYztZQUNyQixJQUFJLEVBQUUsVUFBVTtZQUNoQixVQUFVLEVBQUU7Z0JBQ1YsU0FBUyxFQUFFLENBQUM7Z0JBQ1osU0FBUyxFQUFFO29CQUNULEtBQUssRUFBRSxHQUFHO29CQUNWLE1BQU0sRUFBRSx1QkFBYyxDQUFDLGVBQWU7b0JBQ3RDLFFBQVEsRUFBRSxDQUFDO2lCQUNaO2FBQ0Y7WUFDRCxLQUFLLEVBQUUsSUFBSTtZQUNYLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtTQUN0QixDQUFDLENBQUM7UUFFSCxxQkFBcUI7UUFDckIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUU7WUFDckIsR0FBRyxFQUFFLFNBQVM7WUFDZCxNQUFNLEVBQUUsT0FBTztZQUNmLElBQUksRUFBRSxhQUFhO1lBQ25CLFNBQVMsRUFBRTtnQkFDVCxPQUFPLEVBQUUsSUFBSTtnQkFDYixNQUFNLEVBQUUsdUJBQWMsQ0FBQyxlQUFlO2FBQ3ZDO1lBQ0QscUJBQXFCLEVBQUUsQ0FBQztZQUN4QixTQUFTLEVBQUUsQ0FBQztZQUNaLGNBQWMsRUFBRSxLQUFLO1lBQ3JC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QUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7UUFFeEQsMERBQTBEO1FBQzFELE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFFLENBQUM7UUFDeEMsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUUsQ0FBQztRQUV4Qyw0Q0FBNEM7UUFDNUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3hELE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUV4RCxrREFBa0Q7UUFDbEQsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ25GLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLGlDQUFpQztJQUM5RSxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxQcm9qZWN0c1xcQXR0cml0aW9uXFxwYWNrYWdlc1xcc2VydmVyXFxzcmNcXHN5c3RlbXNcXF9fdGVzdHNfX1xcRGVicmlzU3lzdGVtLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGVicmlzU3lzdGVtIH0gZnJvbSAnLi4vRGVicmlzU3lzdGVtJztcbmltcG9ydCB7IExvY2F0aW9uLCBFbXBpcmUgfSBmcm9tICcuLi8uLi8uLi8uLi9zaGFyZWQvc3JjL3R5cGVzJztcblxuaW1wb3J0IHsgVElNRU9VVFMsIEdBTUVfQ09OU1RBTlRTIH0gZnJvbSAnQGdhbWUvc2hhcmVkJztcbmRlc2NyaWJlKCdEZWJyaXNTeXN0ZW0nLCAoKSA9PiB7XG4gIGxldCBkZWJyaXNTeXN0ZW06IERlYnJpc1N5c3RlbTtcbiAgbGV0IGxvY2F0aW9uczogTWFwPHN0cmluZywgTG9jYXRpb24+O1xuICBsZXQgZW1waXJlczogTWFwPHN0cmluZywgRW1waXJlPjtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAvLyBTZXQgdXAgdGVzdCBkYXRhXG4gICAgbG9jYXRpb25zID0gbmV3IE1hcDxzdHJpbmcsIExvY2F0aW9uPigpO1xuICAgIGVtcGlyZXMgPSBuZXcgTWFwPHN0cmluZywgRW1waXJlPigpO1xuXG4gICAgLy8gQ3JlYXRlIHRlc3QgYXN0ZXJvaWRcbiAgICBsb2NhdGlvbnMuc2V0KCdBMDA6MTA6MjI6MTAnLCB7XG4gICAgICBjb29yZDogJ0EwMDoxMDoyMjoxMCcsXG4gICAgICB0eXBlOiAnYXN0ZXJvaWQnLFxuICAgICAgcHJvcGVydGllczoge1xuICAgICAgICBmZXJ0aWxpdHk6IDAsXG4gICAgICAgIHJlc291cmNlczoge1xuICAgICAgICAgIG1ldGFsOiAxMDAsXG4gICAgICAgICAgZW5lcmd5OiBHQU1FX0NPTlNUQU5UUy5TVEFSVElOR19FTkVSR1ksXG4gICAgICAgICAgcmVzZWFyY2g6IDBcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIG93bmVyOiBudWxsLFxuICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgdGVzdCBlbXBpcmVcbiAgICBlbXBpcmVzLnNldCgnZW1waXJlMScsIHtcbiAgICAgIF9pZDogJ2VtcGlyZTEnLFxuICAgICAgdXNlcklkOiAndXNlcjEnLFxuICAgICAgbmFtZTogJ1Rlc3QgRW1waXJlJyxcbiAgICAgIHJlc291cmNlczoge1xuICAgICAgICBjcmVkaXRzOiAxMDAwLFxuICAgICAgICBlbmVyZ3k6IEdBTUVfQ09OU1RBTlRTLlNUQVJUSU5HX0VORVJHWVxuICAgICAgfSxcbiAgICAgIGNyZWRpdHNSZW1haW5kZXJNaWxsaTogMCxcbiAgICAgIGJhc2VDb3VudDogMSxcbiAgICAgIGhhc0RlbGV0ZWRCYXNlOiBmYWxzZSxcbiAgICAgIHRlcnJpdG9yaWVzOiBbXSxcbiAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKVxuICAgIH0pO1xuXG4gICAgLy8gSW5pdGlhbGl6ZSBzeXN0ZW1cbiAgICBkZWJyaXNTeXN0ZW0gPSBuZXcgRGVicmlzU3lzdGVtKGxvY2F0aW9ucywgZW1waXJlcyk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgLy8gQ2xlYW4gdXBcbiAgICBkZWJyaXNTeXN0ZW0uc3RvcCgpO1xuICB9KTtcblxuICB0ZXN0KCdhZGRzIHJlY3ljbGVyIHRvIGFzdGVyb2lkJywgKCkgPT4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGRlYnJpc1N5c3RlbS5hZGRSZWN5Y2xlcignQTAwOjEwOjIyOjEwJywgJ2VtcGlyZTEnKTtcbiAgICBleHBlY3QocmVzdWx0KS50b0JlKHRydWUpO1xuXG4gICAgY29uc3QgbG9jYXRpb24gPSBsb2NhdGlvbnMuZ2V0KCdBMDA6MTA6MjI6MTAnKTtcbiAgICBleHBlY3QobG9jYXRpb24/LmRlYnJpcz8ucmVjeWNsZXJzLmxlbmd0aCkudG9CZSgxKTtcbiAgICBleHBlY3QobG9jYXRpb24/LmRlYnJpcz8ucmVjeWNsZXJzWzBdLmVtcGlyZUlkKS50b0JlKCdlbXBpcmUxJyk7XG4gIH0pO1xuXG4gIHRlc3QoJ3ByZXZlbnRzIGR1cGxpY2F0ZSByZWN5Y2xlcnMgZnJvbSBzYW1lIGVtcGlyZScsICgpID0+IHtcbiAgICBkZWJyaXNTeXN0ZW0uYWRkUmVjeWNsZXIoJ0EwMDoxMDoyMjoxMCcsICdlbXBpcmUxJyk7XG4gICAgY29uc3QgcmVzdWx0ID0gZGVicmlzU3lzdGVtLmFkZFJlY3ljbGVyKCdBMDA6MTA6MjI6MTAnLCAnZW1waXJlMScpO1xuICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoZmFsc2UpO1xuXG4gICAgY29uc3QgbG9jYXRpb24gPSBsb2NhdGlvbnMuZ2V0KCdBMDA6MTA6MjI6MTAnKTtcbiAgICBleHBlY3QobG9jYXRpb24/LmRlYnJpcz8ucmVjeWNsZXJzLmxlbmd0aCkudG9CZSgxKTtcbiAgfSk7XG5cbiAgdGVzdCgncmVtb3ZlcyByZWN5Y2xlciBmcm9tIGFzdGVyb2lkJywgKCkgPT4ge1xuICAgIGRlYnJpc1N5c3RlbS5hZGRSZWN5Y2xlcignQTAwOjEwOjIyOjEwJywgJ2VtcGlyZTEnKTtcbiAgICBjb25zdCByZXN1bHQgPSBkZWJyaXNTeXN0ZW0ucmVtb3ZlUmVjeWNsZXIoJ0EwMDoxMDoyMjoxMCcsICdlbXBpcmUxJyk7XG4gICAgZXhwZWN0KHJlc3VsdCkudG9CZSh0cnVlKTtcblxuICAgIGNvbnN0IGxvY2F0aW9uID0gbG9jYXRpb25zLmdldCgnQTAwOjEwOjIyOjEwJyk7XG4gICAgZXhwZWN0KGxvY2F0aW9uPy5kZWJyaXM/LnJlY3ljbGVycy5sZW5ndGgpLnRvQmUoMCk7XG4gIH0pO1xuXG4gIHRlc3QoJ2dlbmVyYXRlcyBkZWJyaXMgb3ZlciB0aW1lJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGxvY2F0aW9uID0gbG9jYXRpb25zLmdldCgnQTAwOjEwOjIyOjEwJykhO1xuICAgIFxuICAgIC8vIEVuc3VyZSBkZWJyaXMgaXMgaW5pdGlhbGl6ZWRcbiAgICBleHBlY3QobG9jYXRpb24uZGVicmlzKS50b0JlRGVmaW5lZCgpO1xuICAgIGNvbnN0IGluaXRpYWxBbW91bnQgPSBsb2NhdGlvbi5kZWJyaXMhLmFtb3VudDtcbiAgICBjb25zdCBnZW5lcmF0aW9uUmF0ZSA9IGxvY2F0aW9uLmRlYnJpcyEuZ2VuZXJhdGlvblJhdGU7XG5cbiAgICAvLyBXYWl0IGZvciAyIHNlY29uZHMgb2YgZGVicmlzIGdlbmVyYXRpb25cbiAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgVElNRU9VVFMuVFdPX1NFQ09ORFMpKTtcblxuICAgIC8vIFNob3VsZCBoYXZlIGFwcHJveGltYXRlbHkgMiBzZWNvbmRzIHdvcnRoIG9mIGRlYnJpc1xuICAgIGNvbnN0IGV4cGVjdGVkTWluaW11bSA9IGluaXRpYWxBbW91bnQgKyAoZ2VuZXJhdGlvblJhdGUgKiAxLjUpOyAvLyBBbGxvdyBzb21lIHdpZ2dsZSByb29tXG4gICAgZXhwZWN0KGxvY2F0aW9uLmRlYnJpcyEuYW1vdW50KS50b0JlR3JlYXRlclRoYW4oZXhwZWN0ZWRNaW5pbXVtKTtcbiAgfSk7XG5cbiAgdGVzdCgnY29sbGVjdHMgYW5kIGRpc3RyaWJ1dGVzIGRlYnJpcyBhbW9uZyByZWN5Y2xlcnMnLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gQWRkIHR3byBlbXBpcmVzIHdpdGggcmVjeWNsZXJzXG4gICAgZW1waXJlcy5zZXQoJ2VtcGlyZTInLCB7XG4gICAgICBfaWQ6ICdlbXBpcmUyJyxcbiAgICAgIHVzZXJJZDogJ3VzZXIyJyxcbiAgICAgIG5hbWU6ICdUZXN0IEVtcGlyZSAyJyxcbiAgICAgIHJlc291cmNlczoge1xuICAgICAgICBjcmVkaXRzOiAxMDAwLFxuICAgICAgICBlbmVyZ3k6IEdBTUVfQ09OU1RBTlRTLlNUQVJUSU5HX0VORVJHWVxuICAgICAgfSxcbiAgICAgIGNyZWRpdHNSZW1haW5kZXJNaWxsaTogMCxcbiAgICAgIGJhc2VDb3VudDogMSxcbiAgICAgIGhhc0RlbGV0ZWRCYXNlOiBmYWxzZSxcbiAgICAgIHRlcnJpdG9yaWVzOiBbXSxcbiAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKVxuICAgIH0pO1xuXG4gICAgY29uc3QgbG9jYXRpb24gPSBsb2NhdGlvbnMuZ2V0KCdBMDA6MTA6MjI6MTAnKSE7XG4gICAgbG9jYXRpb24uZGVicmlzID0ge1xuICAgICAgYW1vdW50OiAxMDAsXG4gICAgICBnZW5lcmF0aW9uUmF0ZTogNSxcbiAgICAgIHJlY3ljbGVyczogW11cbiAgICB9O1xuXG4gICAgLy8gQWRkIHJlY3ljbGVycyBmcm9tIGJvdGggZW1waXJlc1xuICAgIGRlYnJpc1N5c3RlbS5hZGRSZWN5Y2xlcignQTAwOjEwOjIyOjEwJywgJ2VtcGlyZTEnKTtcbiAgICBkZWJyaXNTeXN0ZW0uYWRkUmVjeWNsZXIoJ0EwMDoxMDoyMjoxMCcsICdlbXBpcmUyJyk7XG5cbiAgICAvLyBXYWl0IGZvciBjb2xsZWN0aW9uIHRvIG9jY3VyXG4gICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDExMDApKTtcblxuICAgIC8vIENoZWNrIHRoYXQgZGVicmlzIHdhcyBjb2xsZWN0ZWQgYW5kIGNyZWRpdHMgZGlzdHJpYnV0ZWRcbiAgICBjb25zdCBlbXBpcmUxID0gZW1waXJlcy5nZXQoJ2VtcGlyZTEnKSE7XG4gICAgY29uc3QgZW1waXJlMiA9IGVtcGlyZXMuZ2V0KCdlbXBpcmUyJykhO1xuXG4gICAgLy8gQm90aCBlbXBpcmVzIHNob3VsZCBoYXZlIHJlY2VpdmVkIGNyZWRpdHNcbiAgICBleHBlY3QoZW1waXJlMS5yZXNvdXJjZXMuY3JlZGl0cykudG9CZUdyZWF0ZXJUaGFuKDEwMDApO1xuICAgIGV4cGVjdChlbXBpcmUyLnJlc291cmNlcy5jcmVkaXRzKS50b0JlR3JlYXRlclRoYW4oMTAwMCk7XG5cbiAgICAvLyBDcmVkaXRzIHNob3VsZCBiZSByb3VnaGx5IGVxdWFsIGJldHdlZW4gZW1waXJlc1xuICAgIGNvbnN0IGNyZWRpdERpZmYgPSBNYXRoLmFicyhlbXBpcmUxLnJlc291cmNlcy5jcmVkaXRzIC0gZW1waXJlMi5yZXNvdXJjZXMuY3JlZGl0cyk7XG4gICAgZXhwZWN0KGNyZWRpdERpZmYpLnRvQmVMZXNzVGhhbk9yRXF1YWwoMSk7IC8vIEFsbG93IGZvciByb3VuZGluZyBkaWZmZXJlbmNlc1xuICB9KTtcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==