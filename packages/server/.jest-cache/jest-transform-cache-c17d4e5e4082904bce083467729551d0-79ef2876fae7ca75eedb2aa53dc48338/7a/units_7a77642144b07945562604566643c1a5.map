{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\routes\\game\\units.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\routes\\game\\units.ts"],"sourcesContent":["import { Router, Response } from 'express';\r\nimport { supabase } from '../../config/supabase';\r\nimport { asyncHandler } from '../../middleware/errorHandler';\r\nimport { authenticate, AuthRequest } from '../../middleware/auth';\r\nimport { ERROR_MESSAGES } from '../../constants/response-formats';\r\nimport { DB_TABLES, DB_FIELDS } from '../../constants/database-fields';\r\nimport { HTTP_STATUS } from '@game/shared';\r\nimport { UnitKey, getUnitsList, getUnitSpec } from '@game/shared';\r\nimport { EmpireResolutionService } from '../../services/empire/EmpireResolutionService';\r\n\r\nconst router = Router();\r\n\r\nrouter.use(authenticate);\r\n\r\n/**\r\n * Get units catalog\r\n */\r\nrouter.get('/catalog', asyncHandler(async (_req: AuthRequest, res: Response) => {\r\n  const catalog = getUnitsList();\r\n  res.json({ success: true, data: { catalog } });\r\n}));\r\n\r\n/**\r\n * Get units status\r\n */\r\nrouter.get('/status', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const user = req.user! as any;\r\n\r\n  // Resolve empire using established pattern\r\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\r\n  if (!empireRow) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\r\n  }\r\n\r\n  const empireId = String(empireRow.id);\r\n  const locationCoord = String(req.query.locationCoord || '').trim() || undefined;\r\n\r\n  const { UnitsService } = await import('../../services/units/UnitsService');\r\n  const status = await UnitsService.getStatus(empireId, locationCoord);\r\n  return res.json({ success: true, data: { status } });\r\n}));\r\n\r\n/**\r\n * Start unit production\r\n */\r\nrouter.post('/start', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const user = req.user! as any;\r\n  const userId = user._id || user.id;\r\n\r\n  // Resolve empire using established pattern\r\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\r\n  if (!empireRow) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\r\n  }\r\n\r\n  const empireId = String(empireRow.id);\r\n  const { locationCoord, unitKey } = req.body as { locationCoord?: string; unitKey?: UnitKey };\r\n  \r\n  if (!locationCoord || !unitKey) {\r\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'locationCoord and unitKey are required' });\r\n  }\r\n\r\n  const { UnitsService } = await import('../../services/units/UnitsService');\r\n  const result = await UnitsService.start(userId, empireId, locationCoord, unitKey);\r\n  \r\n  if (!(result as any).success) {\r\n    const errorResponse: any = {\r\n      success: false,\r\n      error: (result as any).error ?? (result as any).message,\r\n      message: (result as any).message ?? (result as any).error,\r\n    };\r\n    if ((result as any).code) errorResponse.code = (result as any).code;\r\n    if ((result as any).details) errorResponse.details = (result as any).details;\r\n    if ((result as any).reasons) errorResponse.reasons = (result as any).reasons;\r\n    const statusCode = (result as any).code === 'ALREADY_IN_PROGRESS' ? 409 : HTTP_STATUS.BAD_REQUEST;\r\n    return res.status(statusCode).json(errorResponse);\r\n  }\r\n\r\n  return res.json({ success: true, data: (result as any).data, message: (result as any).message });\r\n}));\r\n\r\n/**\r\n * Get units production queue\r\n * Lists active unit production (capacity-driven) for the authenticated empire.\r\n * Optional ?base=A00:10:22:10 to filter by a specific base coord.\r\n */\r\nrouter.get('/queue', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const user = req.user! as any;\r\n\r\n  // Resolve empire using established pattern\r\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\r\n  if (!empireRow) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\r\n  }\r\n\r\n  const empireId = String(empireRow.id);\r\n  const base = String(req.query.base || '').trim() || undefined;\r\n\r\n  const { UnitsService } = await import('../../services/units/UnitsService');\r\n  const queue = await UnitsService.getQueue(empireId, base);\r\n\r\n  const transformed = (queue || []).map((item: any) => {\r\n    const key = String(item.unit_key || '');\r\n    let unitName = key;\r\n    let creditsCost = 0;\r\n    try {\r\n      const spec = getUnitSpec(key as UnitKey);\r\n      unitName = spec?.name || key;\r\n      creditsCost = Math.max(0, Number(spec?.creditsCost || 0));\r\n    } catch {}\r\n    return {\r\n      id: String(item.id || ''),\r\n      unitKey: key,\r\n      unitName,\r\n      quantity: 1,\r\n      totalQuantity: 1,\r\n      startedAt: String(item.started_at || new Date().toISOString()),\r\n      completesAt: String(item.completes_at || new Date().toISOString()),\r\n      creditsCost,\r\n      baseCoord: String(item.location_coord || ''),\r\n    };\r\n  });\r\n\r\n  return res.json({ success: true, data: { queue: transformed } });\r\n}));\r\n\r\n/**\r\n * Cancel a pending unit production queue item\r\n */\r\nrouter.delete('/queue/:id', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const user = req.user! as any;\r\n\r\n  // Resolve empire using established pattern\r\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\r\n  if (!empireRow) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\r\n  }\r\n\r\n  const empireId = String(empireRow.id);\r\n  const id = String(req.params.id || '').trim();\r\n  \r\n  if (!id) return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'Invalid queue item id' });\r\n\r\n  const { data: qItem } = await supabase\r\n    .from(DB_TABLES.UNIT_QUEUE)\r\n    .select('id, empire_id, unit_key, status, completes_at')\r\n    .eq(DB_FIELDS.BUILDINGS.ID, id)\r\n    .maybeSingle();\r\n\r\n  if (!qItem || String((qItem as any).empire_id) !== empireId) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.QUEUE_ITEM_NOT_FOUND });\r\n  }\r\n\r\n  if (String((qItem as any).status || '') !== 'pending') {\r\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'Only pending items can be cancelled' });\r\n  }\r\n\r\n  // Optional refund\r\n  let refundedCredits: number | null = null;\r\n  try {\r\n    const spec = getUnitSpec(String((qItem as any).unit_key) as UnitKey);\r\n    refundedCredits = Math.max(0, Number(spec?.creditsCost || 0));\r\n    \r\n    // Get current credits\r\n    const { data: empireData } = await supabase\r\n      .from(DB_TABLES.EMPIRES)\r\n      .select('credits')\r\n      .eq(DB_FIELDS.BUILDINGS.ID, empireId)\r\n      .single();\r\n    \r\n    const currentCredits = Math.max(0, Number(empireData?.credits || 0));\r\n    await supabase.from(DB_TABLES.EMPIRES).update({ credits: currentCredits + refundedCredits }).eq(DB_FIELDS.BUILDINGS.ID, empireId);\r\n  } catch {}\r\n\r\n  await supabase.from(DB_TABLES.UNIT_QUEUE).update({ status: 'cancelled' }).eq(DB_FIELDS.BUILDINGS.ID, id);\r\n\r\n  return res.json({ success: true, data: { cancelledId: id, refundedCredits }, message: 'Unit production cancelled' });\r\n}));\r\n\r\nexport default router;\r\n"],"version":3}