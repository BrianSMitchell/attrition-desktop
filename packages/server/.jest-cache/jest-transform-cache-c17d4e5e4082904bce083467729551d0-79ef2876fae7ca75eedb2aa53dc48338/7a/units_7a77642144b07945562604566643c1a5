6609c6392b28ba82b47cb04ee6f65c22
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const supabase_1 = require("../../config/supabase");
const errorHandler_1 = require("../../middleware/errorHandler");
const auth_1 = require("../../middleware/auth");
const response_formats_1 = require("../../constants/response-formats");
const database_fields_1 = require("../../constants/database-fields");
const shared_1 = require("@game/shared");
const shared_2 = require("@game/shared");
const EmpireResolutionService_1 = require("../../services/empire/EmpireResolutionService");
const router = (0, express_1.Router)();
router.use(auth_1.authenticate);
/**
 * Get units catalog
 */
router.get('/catalog', (0, errorHandler_1.asyncHandler)(async (_req, res) => {
    const catalog = (0, shared_2.getUnitsList)();
    res.json({ success: true, data: { catalog } });
}));
/**
 * Get units status
 */
router.get('/status', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    const user = req.user;
    // Resolve empire using established pattern
    const empireRow = await EmpireResolutionService_1.EmpireResolutionService.resolveEmpireByUserObject(user);
    if (!empireRow) {
        return res.status(shared_1.HTTP_STATUS.NOT_FOUND).json({ success: false, error: response_formats_1.ERROR_MESSAGES.EMPIRE_NOT_FOUND });
    }
    const empireId = String(empireRow.id);
    const locationCoord = String(req.query.locationCoord || '').trim() || undefined;
    const { UnitsService } = await Promise.resolve().then(() => __importStar(require('../../services/units/UnitsService')));
    const status = await UnitsService.getStatus(empireId, locationCoord);
    return res.json({ success: true, data: { status } });
}));
/**
 * Start unit production
 */
router.post('/start', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    const user = req.user;
    const userId = user._id || user.id;
    // Resolve empire using established pattern
    const empireRow = await EmpireResolutionService_1.EmpireResolutionService.resolveEmpireByUserObject(user);
    if (!empireRow) {
        return res.status(shared_1.HTTP_STATUS.NOT_FOUND).json({ success: false, error: response_formats_1.ERROR_MESSAGES.EMPIRE_NOT_FOUND });
    }
    const empireId = String(empireRow.id);
    const { locationCoord, unitKey } = req.body;
    if (!locationCoord || !unitKey) {
        return res.status(shared_1.HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'locationCoord and unitKey are required' });
    }
    const { UnitsService } = await Promise.resolve().then(() => __importStar(require('../../services/units/UnitsService')));
    const result = await UnitsService.start(userId, empireId, locationCoord, unitKey);
    if (!result.success) {
        const errorResponse = {
            success: false,
            error: result.error ?? result.message,
            message: result.message ?? result.error,
        };
        if (result.code)
            errorResponse.code = result.code;
        if (result.details)
            errorResponse.details = result.details;
        if (result.reasons)
            errorResponse.reasons = result.reasons;
        const statusCode = result.code === 'ALREADY_IN_PROGRESS' ? 409 : shared_1.HTTP_STATUS.BAD_REQUEST;
        return res.status(statusCode).json(errorResponse);
    }
    return res.json({ success: true, data: result.data, message: result.message });
}));
/**
 * Get units production queue
 * Lists active unit production (capacity-driven) for the authenticated empire.
 * Optional ?base=A00:10:22:10 to filter by a specific base coord.
 */
router.get('/queue', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    const user = req.user;
    // Resolve empire using established pattern
    const empireRow = await EmpireResolutionService_1.EmpireResolutionService.resolveEmpireByUserObject(user);
    if (!empireRow) {
        return res.status(shared_1.HTTP_STATUS.NOT_FOUND).json({ success: false, error: response_formats_1.ERROR_MESSAGES.EMPIRE_NOT_FOUND });
    }
    const empireId = String(empireRow.id);
    const base = String(req.query.base || '').trim() || undefined;
    const { UnitsService } = await Promise.resolve().then(() => __importStar(require('../../services/units/UnitsService')));
    const queue = await UnitsService.getQueue(empireId, base);
    const transformed = (queue || []).map((item) => {
        const key = String(item.unit_key || '');
        let unitName = key;
        let creditsCost = 0;
        try {
            const spec = (0, shared_2.getUnitSpec)(key);
            unitName = spec?.name || key;
            creditsCost = Math.max(0, Number(spec?.creditsCost || 0));
        }
        catch { }
        return {
            id: String(item.id || ''),
            unitKey: key,
            unitName,
            quantity: 1,
            totalQuantity: 1,
            startedAt: String(item.started_at || new Date().toISOString()),
            completesAt: String(item.completes_at || new Date().toISOString()),
            creditsCost,
            baseCoord: String(item.location_coord || ''),
        };
    });
    return res.json({ success: true, data: { queue: transformed } });
}));
/**
 * Cancel a pending unit production queue item
 */
router.delete('/queue/:id', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    const user = req.user;
    // Resolve empire using established pattern
    const empireRow = await EmpireResolutionService_1.EmpireResolutionService.resolveEmpireByUserObject(user);
    if (!empireRow) {
        return res.status(shared_1.HTTP_STATUS.NOT_FOUND).json({ success: false, error: response_formats_1.ERROR_MESSAGES.EMPIRE_NOT_FOUND });
    }
    const empireId = String(empireRow.id);
    const id = String(req.params.id || '').trim();
    if (!id)
        return res.status(shared_1.HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'Invalid queue item id' });
    const { data: qItem } = await supabase_1.supabase
        .from(database_fields_1.DB_TABLES.UNIT_QUEUE)
        .select('id, empire_id, unit_key, status, completes_at')
        .eq(database_fields_1.DB_FIELDS.BUILDINGS.ID, id)
        .maybeSingle();
    if (!qItem || String(qItem.empire_id) !== empireId) {
        return res.status(shared_1.HTTP_STATUS.NOT_FOUND).json({ success: false, error: response_formats_1.ERROR_MESSAGES.QUEUE_ITEM_NOT_FOUND });
    }
    if (String(qItem.status || '') !== 'pending') {
        return res.status(shared_1.HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'Only pending items can be cancelled' });
    }
    // Optional refund
    let refundedCredits = null;
    try {
        const spec = (0, shared_2.getUnitSpec)(String(qItem.unit_key));
        refundedCredits = Math.max(0, Number(spec?.creditsCost || 0));
        // Get current credits
        const { data: empireData } = await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.EMPIRES)
            .select('credits')
            .eq(database_fields_1.DB_FIELDS.BUILDINGS.ID, empireId)
            .single();
        const currentCredits = Math.max(0, Number(empireData?.credits || 0));
        await supabase_1.supabase.from(database_fields_1.DB_TABLES.EMPIRES).update({ credits: currentCredits + refundedCredits }).eq(database_fields_1.DB_FIELDS.BUILDINGS.ID, empireId);
    }
    catch { }
    await supabase_1.supabase.from(database_fields_1.DB_TABLES.UNIT_QUEUE).update({ status: 'cancelled' }).eq(database_fields_1.DB_FIELDS.BUILDINGS.ID, id);
    return res.json({ success: true, data: { cancelledId: id, refundedCredits }, message: 'Unit production cancelled' });
}));
exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFByb2plY3RzXFxBdHRyaXRpb25cXHBhY2thZ2VzXFxzZXJ2ZXJcXHNyY1xccm91dGVzXFxnYW1lXFx1bml0cy50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLHFDQUEyQztBQUMzQyxvREFBaUQ7QUFDakQsZ0VBQTZEO0FBQzdELGdEQUFrRTtBQUNsRSx1RUFBa0U7QUFDbEUscUVBQXVFO0FBQ3ZFLHlDQUEyQztBQUMzQyx5Q0FBa0U7QUFDbEUsMkZBQXdGO0FBRXhGLE1BQU0sTUFBTSxHQUFHLElBQUEsZ0JBQU0sR0FBRSxDQUFDO0FBRXhCLE1BQU0sQ0FBQyxHQUFHLENBQUMsbUJBQVksQ0FBQyxDQUFDO0FBRXpCOztHQUVHO0FBQ0gsTUFBTSxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsSUFBQSwyQkFBWSxFQUFDLEtBQUssRUFBRSxJQUFpQixFQUFFLEdBQWEsRUFBRSxFQUFFO0lBQzdFLE1BQU0sT0FBTyxHQUFHLElBQUEscUJBQVksR0FBRSxDQUFDO0lBQy9CLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxFQUFFLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQztBQUNqRCxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBRUo7O0dBRUc7QUFDSCxNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxJQUFBLDJCQUFZLEVBQUMsS0FBSyxFQUFFLEdBQWdCLEVBQUUsR0FBYSxFQUFFLEVBQUU7SUFDM0UsTUFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQVksQ0FBQztJQUU5QiwyQ0FBMkM7SUFDM0MsTUFBTSxTQUFTLEdBQUcsTUFBTSxpREFBdUIsQ0FBQyx5QkFBeUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNoRixJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDZixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsb0JBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMs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UyxDQUFDLE9BQU8sQ0FBQzthQUN2QixNQUFNLENBQUMsU0FBUyxDQUFDO2FBQ2pCLEVBQUUsQ0FBQywyQkFBUyxDQUFDLFNBQVMsQ0FBQyxFQUFFLEVBQUUsUUFBUSxDQUFDO2FBQ3BDLE1BQU0sRUFBRSxDQUFDO1FBRVosTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLFVBQVUsRUFBRSxPQUFPLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNyRSxNQUFNLG1CQUFRLENBQUMsSUFBSSxDQUFDLDJCQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsT0FBTyxFQUFFLGNBQWMsR0FBRyxlQUFlLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQywyQkFBUyxDQUFDLFNBQVMsQ0FBQyxFQUFFLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDcEksQ0FBQztJQUFDLE1BQU0sQ0FBQyxDQUFBLENBQUM7SUFFVixNQUFNLG1CQUFRLENBQUMsSUFBSSxDQUFDLDJCQUFTLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLDJCQUFTLENBQUMsU0FBUyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUV6RyxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxFQUFFLFdBQVcsRUFBRSxFQUFFLEVBQUUsZUFBZSxFQUFFLEVBQUUsT0FBTyxFQUFFLDJCQUEyQixFQUFFLENBQUMsQ0FBQztBQUN2SCxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBRUosa0JBQWUsTUFBTSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxQcm9qZWN0c1xcQXR0cml0aW9uXFxwYWNrYWdlc1xcc2VydmVyXFxzcmNcXHJvdXRlc1xcZ2FtZVxcdW5pdHMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUm91dGVyLCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQgeyBzdXBhYmFzZSB9IGZyb20gJy4uLy4uL2NvbmZpZy9zdXBhYmFzZSc7XHJcbmltcG9ydCB7IGFzeW5jSGFuZGxlciB9IGZyb20gJy4uLy4uL21pZGRsZXdhcmUvZXJyb3JIYW5kbGVyJztcclxuaW1wb3J0IHsgYXV0aGVudGljYXRlLCBBdXRoUmVxdWVzdCB9IGZyb20gJy4uLy4uL21pZGRsZXdhcmUvYXV0aCc7XHJcbmltcG9ydCB7IEVSUk9SX01FU1NBR0VTIH0gZnJvbSAnLi4vLi4vY29uc3RhbnRzL3Jlc3BvbnNlLWZvcm1hdHMnO1xyXG5pbXBvcnQgeyBEQl9UQUJMRVMsIERCX0ZJRUxEUyB9IGZyb20gJy4uLy4uL2NvbnN0YW50cy9kYXRhYmFzZS1maWVsZHMnO1xyXG5pbXBvcnQgeyBIVFRQX1NUQVRVUyB9IGZyb20gJ0BnYW1lL3NoYXJlZCc7XHJcbmltcG9ydCB7IFVuaXRLZXksIGdldFVuaXRzTGlzdCwgZ2V0VW5pdFNwZWMgfSBmcm9tICdAZ2FtZS9zaGFyZWQnO1xyXG5pbXBvcnQgeyBFbXBpcmVSZXNvbHV0aW9uU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2VtcGlyZS9FbXBpcmVSZXNvbHV0aW9uU2VydmljZSc7XHJcblxyXG5jb25zdCByb3V0ZXIgPSBSb3V0ZXIoKTtcclxuXHJcbnJvdXRlci51c2UoYXV0aGVudGljYXRlKTtcclxuXHJcbi8qKlxyXG4gKiBHZXQgdW5pdHMgY2F0YWxvZ1xyXG4gKi9cclxucm91dGVyLmdldCgnL2NhdGFsb2cnLCBhc3luY0hhbmRsZXIoYXN5bmMgKF9yZXE6IEF1dGhSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XHJcbiAgY29uc3QgY2F0YWxvZyA9IGdldFVuaXRzTGlzdCgpO1xyXG4gIHJlcy5qc29uKHsgc3VjY2VzczogdHJ1ZSwgZGF0YTogeyBjYXRhbG9nIH0gfSk7XHJcbn0pKTtcclxuXHJcbi8qKlxyXG4gKiBHZXQgdW5pdHMgc3RhdHVzXHJcbiAqL1xyXG5yb3V0ZXIuZ2V0KCcvc3RhdHVzJywgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXE6IEF1dGhSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XHJcbiAgY29uc3QgdXNlciA9IHJlcS51c2VyISBhcyBhbnk7XHJcblxyXG4gIC8vIFJlc29sdmUgZW1waXJlIHVzaW5nIGVzdGFibGlzaGVkIHBhdHRlcm5cclxuICBjb25zdCBlbXBpcmVSb3cgPSBhd2FpdCBFbXBpcmVSZXNvbHV0aW9uU2VydmljZS5yZXNvbHZlRW1waXJlQnlVc2VyT2JqZWN0KHVzZXIpO1xyXG4gIGlmICghZW1waXJlUm93KSB7XHJcbiAgICByZXR1cm4gcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5OT1RfRk9VTkQpLmpzb24oeyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IEVSUk9SX01FU1NBR0VTLkVNUElSRV9OT1RfRk9VTkQgfSk7XHJcbiAgfVxyXG5cclxuICBjb25zdCBlbXBpcmVJZCA9IFN0cmluZyhlbXBpcmVSb3cuaWQpO1xyXG4gIGNvbnN0IGxvY2F0aW9uQ29vcmQgPSBTdHJpbmcocmVxLnF1ZXJ5LmxvY2F0aW9uQ29vcmQgfHwgJycpLnRyaW0oKSB8fCB1bmRlZmluZWQ7XHJcblxyXG4gIGNvbnN0IHsgVW5pdHNTZXJ2aWNlIH0gPSBhd2FpdCBpbXBvcnQoJy4uLy4uL3NlcnZpY2VzL3VuaXRzL1VuaXRzU2VydmljZScpO1xyXG4gIGNvbnN0IHN0YXR1cyA9IGF3YWl0IFVuaXRzU2VydmljZS5nZXRTdGF0dXMoZW1waXJlSWQsIGxvY2F0aW9uQ29vcmQpO1xyXG4gIHJldHVybiByZXMuanNvbih7IHN1Y2Nlc3M6IHRydWUsIGRhdGE6IHsgc3RhdHVzIH0gfSk7XHJcbn0pKTtcclxuXHJcbi8qKlxyXG4gKiBTdGFydCB1bml0IHByb2R1Y3Rpb25cclxuICovXHJcbnJvdXRlci5wb3N0KCcvc3RhcnQnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcTogQXV0aFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICBjb25zdCB1c2VyID0gcmVxLnVzZXIhIGFzIGFueTtcclxuICBjb25zdCB1c2VySWQgPSB1c2VyLl9pZCB8fCB1c2VyLmlkO1xyXG5cclxuICAvLyBSZXNvbHZlIGVtcGlyZSB1c2luZyBlc3RhYmxpc2hlZCBwYXR0ZXJuXHJcbiAgY29uc3QgZW1waXJlUm93ID0gYXdhaXQgRW1waXJlUmVzb2x1dGlvblNlcnZpY2UucmVzb2x2ZUVtcGlyZUJ5VXNlck9iamVjdCh1c2VyKTtcclxuICBpZiAoIWVtcGlyZVJvdykge1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuTk9UX0ZPVU5EKS5qc29uKHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBFUlJPUl9NRVNTQUdFUy5FTVBJUkVfTk9UX0ZPVU5EIH0pO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgZW1waXJlSWQgPSBTdHJpbmcoZW1waXJlUm93LmlkKTtcclxuICBjb25zdCB7IGxvY2F0aW9uQ29vcmQsIHVuaXRLZXkgfSA9IHJlcS5ib2R5IGFzIHsgbG9jYXRpb25Db29yZD86IHN0cmluZzsgdW5pdEtleT86IFVuaXRLZXkgfTtcclxuICBcclxuICBpZiAoIWxvY2F0aW9uQ29vcmQgfHwgIXVuaXRLZXkpIHtcclxuICAgIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLkJBRF9SRVFVRVNUKS5qc29uKHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnbG9jYXRpb25Db29yZCBhbmQgdW5pdEtleSBhcmUgcmVxdWlyZWQnIH0pO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgeyBVbml0c1NlcnZpY2UgfSA9IGF3YWl0IGltcG9ydCgnLi4vLi4vc2VydmljZXMvdW5pdHMvVW5pdHNTZXJ2aWNlJyk7XHJcbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgVW5pdHNTZXJ2aWNlLnN0YXJ0KHVzZXJJZCwgZW1waXJlSWQsIGxvY2F0aW9uQ29vcmQsIHVuaXRLZXkpO1xyXG4gIFxyXG4gIGlmICghKHJlc3VsdCBhcyBhbnkpLnN1Y2Nlc3MpIHtcclxuICAgIGNvbnN0IGVycm9yUmVzcG9uc2U6IGFueSA9IHtcclxuICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgIGVycm9yOiAocmVzdWx0IGFzIGFueSkuZXJyb3IgPz8gKHJlc3VsdCBhcyBhbnkpLm1lc3NhZ2UsXHJcbiAgICAgIG1lc3NhZ2U6IChyZXN1bHQgYXMgYW55KS5tZXNzYWdlID8/IChyZXN1bHQgYXMgYW55KS5lcnJvcixcclxuICAgIH07XHJcbiAgICBpZiAoKHJlc3VsdCBhcyBhbnkpLmNvZGUpIGVycm9yUmVzcG9uc2UuY29kZSA9IChyZXN1bHQgYXMgYW55KS5jb2RlO1xyXG4gICAgaWYgKChyZXN1bHQgYXMgYW55KS5kZXRhaWxzKSBlcnJvclJlc3BvbnNlLmRldGFpbHMgPSAocmVzdWx0IGFzIGFueSkuZGV0YWlscztcclxuICAgIGlmICgocmVzdWx0IGFzIGFueSkucmVhc29ucykgZXJyb3JSZXNwb25zZS5yZWFzb25zID0gKHJlc3VsdCBhcyBhbnkpLnJlYXNvbnM7XHJcbiAgICBjb25zdCBzdGF0dXNDb2RlID0gKHJlc3VsdCBhcyBhbnkpLmNvZGUgPT09ICdBTFJFQURZX0lOX1BST0dSRVNTJyA/IDQwOSA6IEhUVFBfU1RBVFVTLkJBRF9SRVFVRVNUO1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoc3RhdHVzQ29kZSkuanNvbihlcnJvclJlc3BvbnNlKTtcclxuICB9XHJcblxyXG4gIHJldHVybiByZXMuanNvbih7IHN1Y2Nlc3M6IHRydWUsIGRhdGE6IChyZXN1bHQgYXMgYW55KS5kYXRhLCBtZXNzYWdlOiAocmVzdWx0IGFzIGFueSkubWVzc2FnZSB9KTtcclxufSkpO1xyXG5cclxuLyoqXHJcbiAqIEdldCB1bml0cyBwcm9kdWN0aW9uIHF1ZXVlXHJcbiAqIExpc3RzIGFjdGl2ZSB1bml0IHByb2R1Y3Rpb24gKGNhcGFjaXR5LWRyaXZlbikgZm9yIHRoZSBhdXRoZW50aWNhdGVkIGVtcGlyZS5cclxuICogT3B0aW9uYWwgP2Jhc2U9QTAwOjEwOjIyOjEwIHRvIGZpbHRlciBieSBhIHNwZWNpZmljIGJhc2UgY29vcmQuXHJcbiAqL1xyXG5yb3V0ZXIuZ2V0KCcvcXVldWUnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcTogQXV0aFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICBjb25zdCB1c2VyID0gcmVxLnVzZXIhIGFzIGFueTtcclxuXHJcbiAgLy8gUmVzb2x2ZSBlbXBpcmUgdXNpbmcgZXN0YWJsaXNoZWQgcGF0dGVyblxyXG4gIGNvbnN0IGVtcGlyZVJvdyA9IGF3YWl0IEVtcGlyZVJlc29sdXRpb25TZXJ2aWNlLnJlc29sdmVFbXBpcmVCeVVzZXJPYmplY3QodXNlcik7XHJcbiAgaWYgKCFlbXBpcmVSb3cpIHtcclxuICAgIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLk5PVF9GT1VORCkuanNvbih7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogRVJST1JfTUVTU0FHRVMuRU1QSVJFX05PVF9GT1VORCB9KTtcclxuICB9XHJcblxyXG4gIGNvbnN0IGVtcGlyZUlkID0gU3RyaW5nKGVtcGlyZVJvdy5pZCk7XHJcbiAgY29uc3QgYmFzZSA9IFN0cmluZyhyZXEucXVlcnkuYmFzZSB8fCAnJykudHJpbSgpIHx8IHVuZGVmaW5lZDtcclxuXHJcbiAgY29uc3QgeyBVbml0c1NlcnZpY2UgfSA9IGF3YWl0IGltcG9ydCgnLi4vLi4vc2VydmljZXMvdW5pdHMvVW5pdHNTZXJ2aWNlJyk7XHJcbiAgY29uc3QgcXVldWUgPSBhd2FpdCBVbml0c1NlcnZpY2UuZ2V0UXVldWUoZW1waXJlSWQsIGJhc2UpO1xyXG5cclxuICBjb25zdCB0cmFuc2Zvcm1lZCA9IChxdWV1ZSB8fCBbXSkubWFwKChpdGVtOiBhbnkpID0+IHtcclxuICAgIGNvbnN0IGtleSA9IFN0cmluZyhpdGVtLnVuaXRfa2V5IHx8ICcnKTtcclxuICAgIGxldCB1bml0TmFtZSA9IGtleTtcclxuICAgIGxldCBjcmVkaXRzQ29zdCA9IDA7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBzcGVjID0gZ2V0VW5pdFNwZWMoa2V5IGFzIFVuaXRLZXkpO1xyXG4gICAgICB1bml0TmFtZSA9IHNwZWM/Lm5hbWUgfHwga2V5O1xyXG4gICAgICBjcmVkaXRzQ29zdCA9IE1hdGgubWF4KDAsIE51bWJlcihzcGVjPy5jcmVkaXRzQ29zdCB8fCAwKSk7XHJcbiAgICB9IGNhdGNoIHt9XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBpZDogU3RyaW5nKGl0ZW0uaWQgfHwgJycpLFxyXG4gICAgICB1bml0S2V5OiBrZXksXHJcbiAgICAgIHVuaXROYW1lLFxyXG4gICAgICBxdWFudGl0eTogMSxcclxuICAgICAgdG90YWxRdWFudGl0eTogMSxcclxuICAgICAgc3RhcnRlZEF0OiBTdHJpbmcoaXRlbS5zdGFydGVkX2F0IHx8IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSksXHJcbiAgICAgIGNvbXBsZXRlc0F0OiBTdHJpbmcoaXRlbS5jb21wbGV0ZXNfYXQgfHwgbmV3IERhdGUoKS50b0lTT1N0cmluZygpKSxcclxuICAgICAgY3JlZGl0c0Nvc3QsXHJcbiAgICAgIGJhc2VDb29yZDogU3RyaW5nKGl0ZW0ubG9jYXRpb25fY29vcmQgfHwgJycpLFxyXG4gICAgfTtcclxuICB9KTtcclxuXHJcbiAgcmV0dXJuIHJlcy5qc29uKHsgc3VjY2VzczogdHJ1ZSwgZGF0YTogeyBxdWV1ZTogdHJhbnNmb3JtZWQgfSB9KTtcclxufSkpO1xyXG5cclxuLyoqXHJcbiAqIENhbmNlbCBhIHBlbmRpbmcgdW5pdCBwcm9kdWN0aW9uIHF1ZXVlIGl0ZW1cclxuICovXHJcbnJvdXRlci5kZWxldGUoJy9xdWV1ZS86aWQnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcTogQXV0aFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICBjb25zdCB1c2VyID0gcmVxLnVzZXIhIGFzIGFueTtcclxuXHJcbiAgLy8gUmVzb2x2ZSBlbXBpcmUgdXNpbmcgZXN0YWJsaXNoZWQgcGF0dGVyblxyXG4gIGNvbnN0IGVtcGlyZVJvdyA9IGF3YWl0IEVtcGlyZVJlc29sdXRpb25TZXJ2aWNlLnJlc29sdmVFbXBpcmVCeVVzZXJPYmplY3QodXNlcik7XHJcbiAgaWYgKCFlbXBpcmVSb3cpIHtcclxuICAgIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLk5PVF9GT1VORCkuanNvbih7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogRVJST1JfTUVTU0FHRVMuRU1QSVJFX05PVF9GT1VORCB9KTtcclxuICB9XHJcblxyXG4gIGNvbnN0IGVtcGlyZUlkID0gU3RyaW5nKGVtcGlyZVJvdy5pZCk7XHJcbiAgY29uc3QgaWQgPSBTdHJpbmcocmVxLnBhcmFtcy5pZCB8fCAnJykudHJpbSgpO1xyXG4gIFxyXG4gIGlmICghaWQpIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLkJBRF9SRVFVRVNUKS5qc29uKHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnSW52YWxpZCBxdWV1ZSBpdGVtIGlkJyB9KTtcclxuXHJcbiAgY29uc3QgeyBkYXRhOiBxSXRlbSB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgIC5mcm9tKERCX1RBQkxFUy5VTklUX1FVRVVFKVxyXG4gICAgLnNlbGVjdCgnaWQsIGVtcGlyZV9pZCwgdW5pdF9rZXksIHN0YXR1cywgY29tcGxldGVzX2F0JylcclxuICAgIC5lcShEQl9GSUVMRFMuQlVJTERJTkdTLklELCBpZClcclxuICAgIC5tYXliZVNpbmdsZSgpO1xyXG5cclxuICBpZiAoIXFJdGVtIHx8IFN0cmluZygocUl0ZW0gYXMgYW55KS5lbXBpcmVfaWQpICE9PSBlbXBpcmVJZCkge1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuTk9UX0ZPVU5EKS5qc29uKHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBFUlJPUl9NRVNTQUdFUy5RVUVVRV9JVEVNX05PVF9GT1VORCB9KTtcclxuICB9XHJcblxyXG4gIGlmIChTdHJpbmcoKHFJdGVtIGFzIGFueSkuc3RhdHVzIHx8ICcnKSAhPT0gJ3BlbmRpbmcnKSB7XHJcbiAgICByZXR1cm4gcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5CQURfUkVRVUVTVCkuanNvbih7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ09ubHkgcGVuZGluZyBpdGVtcyBjYW4gYmUgY2FuY2VsbGVkJyB9KTtcclxuICB9XHJcblxyXG4gIC8vIE9wdGlvbmFsIHJlZnVuZFxyXG4gIGxldCByZWZ1bmRlZENyZWRpdHM6IG51bWJlciB8IG51bGwgPSBudWxsO1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBzcGVjID0gZ2V0VW5pdFNwZWMoU3RyaW5nKChxSXRlbSBhcyBhbnkpLnVuaXRfa2V5KSBhcyBVbml0S2V5KTtcclxuICAgIHJlZnVuZGVkQ3JlZGl0cyA9IE1hdGgubWF4KDAsIE51bWJlcihzcGVjPy5jcmVkaXRzQ29zdCB8fCAwKSk7XHJcbiAgICBcclxuICAgIC8vIEdldCBjdXJyZW50IGNyZWRpdHNcclxuICAgIGNvbnN0IHsgZGF0YTogZW1waXJlRGF0YSB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgLmZyb20oREJfVEFCTEVTLkVNUElSRVMpXHJcbiAgICAgIC5zZWxlY3QoJ2NyZWRpdHMnKVxyXG4gICAgICAuZXEoREJfRklFTERTLkJVSUxESU5HUy5JRCwgZW1waXJlSWQpXHJcbiAgICAgIC5zaW5nbGUoKTtcclxuICAgIFxyXG4gICAgY29uc3QgY3VycmVudENyZWRpdHMgPSBNYXRoLm1heCgwLCBOdW1iZXIoZW1waXJlRGF0YT8uY3JlZGl0cyB8fCAwKSk7XHJcbiAgICBhd2FpdCBzdXBhYmFzZS5mcm9tKERCX1RBQkxFUy5FTVBJUkVTKS51cGRhdGUoeyBjcmVkaXRzOiBjdXJyZW50Q3JlZGl0cyArIHJlZnVuZGVkQ3JlZGl0cyB9KS5lcShEQl9GSUVMRFMuQlVJTERJTkdTLklELCBlbXBpcmVJZCk7XHJcbiAgfSBjYXRjaCB7fVxyXG5cclxuICBhd2FpdCBzdXBhYmFzZS5mcm9tKERCX1RBQkxFUy5VTklUX1FVRVVFKS51cGRhdGUoeyBzdGF0dXM6ICdjYW5jZWxsZWQnIH0pLmVxKERCX0ZJRUxEUy5CVUlMRElOR1MuSUQsIGlkKTtcclxuXHJcbiAgcmV0dXJuIHJlcy5qc29uKHsgc3VjY2VzczogdHJ1ZSwgZGF0YTogeyBjYW5jZWxsZWRJZDogaWQsIHJlZnVuZGVkQ3JlZGl0cyB9LCBtZXNzYWdlOiAnVW5pdCBwcm9kdWN0aW9uIGNhbmNlbGxlZCcgfSk7XHJcbn0pKTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IHJvdXRlcjtcclxuIl0sInZlcnNpb24iOjN9