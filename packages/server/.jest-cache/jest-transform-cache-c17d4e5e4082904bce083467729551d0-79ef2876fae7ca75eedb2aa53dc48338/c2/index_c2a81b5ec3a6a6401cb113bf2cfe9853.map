{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\routes\\game\\bases\\index.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\routes\\game\\bases\\index.ts"],"sourcesContent":["import { Router, Response } from 'express';\nimport { supabase } from '../../../config/supabase';\nimport { asyncHandler } from '../../../middleware/errorHandler';\nimport { authenticate, AuthRequest } from '../../../middleware/auth';\nimport { HTTP_STATUS, ERROR_MESSAGES } from '../../../constants/response-formats';\nimport { DB_TABLES, DB_FIELDS } from '../../../constants/database-fields';\nimport {\n  BuildingKey,\n  DefenseKey,\n  TechnologyKey,\n  UnitKey,\n  getTechnologyList,\n  getBuildingsList,\n  getDefensesList,\n  getUnitsList,\n  getUnitSpec,\n  getTechSpec,\n  getStructureCreditCostForLevel,\n  getBuildingSpec \n} from '@game/shared';\nimport { EmpireResolutionService } from '../../../services/EmpireResolutionService';\n\nconst router = Router();\n\nrouter.use(authenticate);\n\n/**\n * List empire territories/bases\n * GET /api/game/bases\n * \n * Migrated from /api/v1/territory - Essential functionality for base management\n * Returns list of bases with coordinates and names (FR-16)\n * \n * Response DTO: { success: boolean, data: { territories: Array<{coord: string, name?: string}> } }\n */\nrouter.get('/', asyncHandler(async (req: AuthRequest, res: Response) => {\n  const user = req.user! as any;\n\n  // Resolve empire using established pattern (FR-14)\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\n  if (!empireRow) {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\n  }\n\n  const empireId = String(empireRow.id);\n\n  // Prefer colonies (name + coord). If none, fall back to empires.territories and fetch locations.\n  const coloniesRes = await supabase\n    .from(DB_TABLES.COLONIES)\n    .select('location_coord, name')\n    .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId);\n\n  let territories: Array<{ coord: string; name?: string }> = [];\n  if ((coloniesRes.data || []).length > 0) {\n    territories = (coloniesRes.data as any[]).map((c) => ({ coord: String(c.location_coord), name: c.name || undefined }));\n  } else {\n    const emp = await supabase.from(DB_TABLES.EMPIRES).select(DB_FIELDS.EMPIRES.TERRITORIES).eq(DB_FIELDS.BUILDINGS.ID, empireId).maybeSingle();\n    const coords: string[] = Array.isArray(emp.data?.territories) ? emp.data!.territories : [];\n    if (coords.length > 0) {\n      const locs = await supabase.from(DB_TABLES.LOCATIONS).select('coord').in('coord', coords);\n      territories = (locs.data || []).map((l: any) => ({ coord: String(l.coord) }));\n    }\n  }\n\n  return res.json({ success: true, data: { territories } });\n}));\n\n/**\n * Base Statistics endpoint\n * GET /api/game/bases/:coord/stats\n * \n * Migrated from /api/v1/territory/base-stats/:coord - Essential for base management UI (FR-16)\n * Returns area, energy, population budgets and owner income for a base\n * \n * Response DTO: { success: boolean, data: { stats: object } }\n */\nrouter.get('/:coord/stats', asyncHandler(async (req: AuthRequest, res: Response) => {\n  const user = req.user! as any;\n  const { coord } = req.params as { coord: string };\n  if (!coord) return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: ERROR_MESSAGES.COORDINATE_PARAMETER_REQUIRED });\n\n  // Resolve empire using established pattern (FR-14)\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\n  if (!empireRow) {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\n  }\n\n  const empireId = String(empireRow.id);\n\n  const { StatsService } = await import('../../../services/bases/StatsService');\n  const stats = await StatsService.getBaseStats(empireId, coord);\n  return res.json({ success: true, data: { stats } });\n}));\n\n/**\n * Base Capacities endpoint\n * GET /api/game/bases/:coord/capacities\n * \n * Migrated from /api/v1/territory/capacities/:coord - Required for construction/production planning (FR-16)\n * Computes Construction/Production/Research capacities for a base\n * \n * Response DTO: { success: boolean, data: capacities }\n */\nrouter.get('/:coord/capacities', asyncHandler(async (req: AuthRequest, res: Response) => {\n  const user = req.user! as any;\n  const { coord } = req.params as { coord: string };\n  if (!coord) return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: ERROR_MESSAGES.COORDINATE_PARAMETER_REQUIRED });\n\n  // Resolve empire using established pattern (FR-14)\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\n  if (!empireRow) {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\n  }\n\n  const empireId = String(empireRow.id);\n\n  const { CapacityService } = await import('../../../services/bases/CapacityService');\n  const caps = await CapacityService.getBaseCapacities(empireId, coord);\n  return res.json({ success: true, data: caps });\n}));\n\n/**\n * Combined Base Stats endpoint\n * GET /api/game/bases/:coord/combined-stats\n * \n * Migrated from /api/v1/territory/bases/:coord/stats - Convenience endpoint combining stats + capacities (FR-16)\n * Returns comprehensive base information with stats and capacities\n * \n * Response DTO: { success: boolean, data: { coord, stats, capacities }, message }\n */\nrouter.get('/:coord/combined-stats', asyncHandler(async (req: AuthRequest, res: Response) => {\n  const user = req.user! as any;\n  const { coord } = req.params as { coord: string };\n  if (!coord) return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: ERROR_MESSAGES.COORDINATE_PARAMETER_REQUIRED });\n\n  // Resolve empire using established pattern (FR-14)\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\n  if (!empireRow) {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\n  }\n\n  const empireId = String(empireRow.id);\n\n  const { StatsService } = await import('../../../services/bases/StatsService');\n  const { CapacityService } = await import('../../../services/bases/CapacityService');\n\n  const [stats, capacities] = await Promise.all([\n    StatsService.getBaseStats(empireId, coord),\n    CapacityService.getBaseCapacities(empireId, coord)\n  ]);\n\n  return res.json({ success: true, data: { coord, stats, capacities }, message: 'Base stats loaded' });\n}));\n\n/**\n * Base summaries for Empire page\n * Returns compact info per base: name, location, economy, occupier, construction, production, research\n */\nrouter.get('/summary', asyncHandler(async (req: AuthRequest, res: Response) => {\n  const user = req.user! as any;\n  const userId = user?._id || user?.id;\n\n  // Load user and empire (by user_id then by users.empire_id)\n  const { data: userRow } = await supabase\n    .from(DB_TABLES.USERS)\n    .select('id, username, email, empire_id')\n    .eq(DB_FIELDS.BUILDINGS.ID, userId)\n    .single();\n\n  let { data: empireRow } = await supabase\n    .from(DB_TABLES.EMPIRES)\n    .select('id, territories')\n    .eq(DB_FIELDS.EMPIRES.USER_ID, userId)\n    .maybeSingle();\n\n  if (!empireRow && userRow?.empire_id) {\n    const byId = await supabase\n      .from(DB_TABLES.EMPIRES)\n      .select('id, territories')\n      .eq(DB_FIELDS.BUILDINGS.ID, userRow.empire_id)\n      .maybeSingle();\n    empireRow = byId.data as any;\n  }\n\n  if (!empireRow) {\n    return res.json({ success: true, data: { bases: [] } });\n  }\n\n  const coords: string[] = Array.isArray((empireRow as any).territories) ? (empireRow as any).territories : [];\n  if (!coords.length) {\n    return res.json({ success: true, data: { bases: [] } });\n  }\n\n  // Load locations and colonies\n  const [locRes, colRes] = await Promise.all([\n    supabase.from(DB_TABLES.LOCATIONS).select('coord').in('coord', coords),\n    supabase.from(DB_TABLES.COLONIES).select('location_coord, name').eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, (empireRow as any).id).in(DB_FIELDS.BUILDINGS.LOCATION_COORD, coords),\n  ]);\n\n  const locations = locRes.data || [];\n  const colonies = colRes.data || [];\n  const colonyByCoord = new Map<string, any>((colonies as any[]).map((c) => [c.location_coord, c]));\n\n  // Research summary: earliest scheduled pending; otherwise earliest unscheduled pending\n  let researchSummary: { name: string; remaining: number; percent: number } | null = null;\n  try {\n    const now = Date.now();\n    // Scheduled\n    const sched = await supabase\n      .from(DB_TABLES.TECH_QUEUE)\n      .select('tech_key, started_at, completes_at')\n      .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, (empireRow as any).id)\n      .eq(DB_FIELDS.TECH_QUEUE.STATUS, 'pending')\n      .not(DB_FIELDS.TECH_QUEUE.COMPLETES_AT, 'is', null)\n      .order(DB_FIELDS.TECH_QUEUE.COMPLETES_AT, { ascending: true })\n      .limit(1);\n\n    let item: any = (sched.data && sched.data[0]) || null;\n\n    if (!item) {\n      // Unscheduled: order by created_at\n      const unsched = await supabase\n        .from(DB_TABLES.TECH_QUEUE)\n        .select('tech_key, started_at, completes_at, created_at')\n        .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, (empireRow as any).id)\n        .eq(DB_FIELDS.TECH_QUEUE.STATUS, 'pending')\n        .is(DB_FIELDS.TECH_QUEUE.COMPLETES_AT, null)\n        .order(DB_FIELDS.BUILDINGS.CREATED_AT, { ascending: true })\n        .limit(1);\n      item = (unsched.data && unsched.data[0]) || null;\n    }\n\n    if (item) {\n      let name = '';\n      try {\n        name = getTechSpec(String(item.tech_key) as any).name;\n      } catch {\n        name = String(item.tech_key || '');\n      }\n      let remaining = 0;\n      let percent = 0;\n      if (item.completes_at && item.started_at) {\n        const st = new Date(item.started_at as any).getTime();\n        const et = new Date(item.completes_at as any).getTime();\n        if (Number.isFinite(st) && Number.isFinite(et) && et > st) {\n          remaining = Math.max(0, et - now);\n          const total = et - st;\n          const elapsed = Math.max(0, now - st);\n          percent = Math.min(100, Math.max(0, Math.floor((elapsed / total) * 100)));\n        }\n      }\n      researchSummary = { name, remaining, percent };\n    }\n  } catch {\n    // non-fatal\n  }\n\n  // Construction/Production/Defense queues (pending) by base\n  const nowTs = Date.now();\n  const [buildingQ, unitQ, defQ] = await Promise.all([\n    supabase\n      .from(DB_TABLES.BUILDINGS)\n      .select('catalog_key, location_coord, construction_started, construction_completed')\n      .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, (empireRow as any).id)\n      .eq(DB_FIELDS.BUILDINGS.IS_ACTIVE, false)\n      .gt(DB_FIELDS.BUILDINGS.CONSTRUCTION_COMPLETED, new Date(nowTs).toISOString())\n      .in(DB_FIELDS.BUILDINGS.LOCATION_COORD, coords),\n    supabase\n      .from(DB_TABLES.UNIT_QUEUE)\n      .select('unit_key, location_coord, started_at, completes_at, created_at')\n      .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, (empireRow as any).id)\n      .eq(DB_FIELDS.TECH_QUEUE.STATUS, 'pending')\n      .in(DB_FIELDS.BUILDINGS.LOCATION_COORD, coords),\n    supabase\n      .from(DB_TABLES.DEFENSE_QUEUE)\n      .select('defense_key, location_coord, started_at, completes_at, created_at')\n      .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, (empireRow as any).id)\n      .eq(DB_FIELDS.TECH_QUEUE.STATUS, 'pending')\n      .in(DB_FIELDS.BUILDINGS.LOCATION_COORD, coords),\n  ]);\n\n  const consQueuedByCoord = new Map<string, number>();\n  const consEarliestByCoord = new Map<string, { name: string; remaining: number; percent?: number; ts: number }>();\n  const prodQueuedByCoord = new Map<string, number>();\n  const prodEarliestByCoord = new Map<string, { name: string; remaining: number; percent?: number; ts: number }>();\n  const defQueuedByCoord = new Map<string, number>();\n  const defEarliestByCoord = new Map<string, { name: string; remaining: number; percent?: number; ts: number }>();\n\n  // Buildings (construction)\n  for (const b of buildingQ.data || []) {\n    const lc = String((b as any).location_coord || '');\n    if (!lc) continue;\n    consQueuedByCoord.set(lc, 1); // single active construction model\n\n    // Determine ordering\n    const completesVal = (b as any).construction_completed as string | null;\n    const startedVal = (b as any).construction_started as string | null;\n    const orderTs = completesVal ? new Date(completesVal).getTime() : Number.POSITIVE_INFINITY;\n\n    // Resolve display name\n    let name = '';\n    const key = String((b as any).catalog_key || '');\n    if (key) {\n      try {\n        const spec = getBuildingSpec(key as any);\n        name = spec?.name || key;\n      } catch {\n        name = key;\n      }\n    }\n\n    // Remaining/percent if scheduled\n    let remaining = 0;\n    let percent: number | undefined = undefined;\n    if (completesVal && startedVal) {\n      const st = new Date(startedVal).getTime();\n      const et = new Date(completesVal).getTime();\n      if (Number.isFinite(st) && Number.isFinite(et) && et > st) {\n        remaining = Math.max(0, et - nowTs);\n        const total = et - st;\n        const elapsed = Math.max(0, nowTs - st);\n        percent = Math.min(100, Math.max(0, Math.floor((elapsed / total) * 100)));\n      }\n    }\n\n    const prev = consEarliestByCoord.get(lc);\n    if (!prev || orderTs < prev.ts) {\n      consEarliestByCoord.set(lc, { name, remaining, percent, ts: orderTs });\n    }\n  }\n\n  // Units\n  for (const u of unitQ.data || []) {\n    const lc = String((u as any).location_coord || '');\n    if (!lc) continue;\n    prodQueuedByCoord.set(lc, (prodQueuedByCoord.get(lc) || 0) + 1);\n\n    // Determine ordering\n    const completesVal = (u as any).completes_at as string | null;\n    const createdVal = (u as any).created_at as string | null;\n    const startedVal = (u as any).started_at as string | null;\n    const orderTs = completesVal ? new Date(completesVal).getTime() : (createdVal ? new Date(createdVal).getTime() : Number.POSITIVE_INFINITY);\n\n    // Resolve display name\n    let name = '';\n    const key = String((u as any).unit_key || '');\n    if (key) {\n      try {\n        const spec = getUnitSpec(key as any);\n        name = spec?.name || key;\n      } catch {\n        name = key;\n      }\n    }\n\n    // Remaining/percent if scheduled\n    let remaining = 0;\n    let percent: number | undefined = undefined;\n    if (completesVal && startedVal) {\n      const st = new Date(startedVal).getTime();\n      const et = new Date(completesVal).getTime();\n      if (Number.isFinite(st) && Number.isFinite(et) && et > st) {\n        remaining = Math.max(0, et - nowTs);\n        const total = et - st;\n        const elapsed = Math.max(0, nowTs - st);\n        percent = Math.min(100, Math.max(0, Math.floor((elapsed / total) * 100)));\n      }\n    }\n\n    const prev = prodEarliestByCoord.get(lc);\n    if (!prev || orderTs < prev.ts) {\n      prodEarliestByCoord.set(lc, { name, remaining, percent, ts: orderTs });\n    }\n  }\n\n  // Defenses\n  for (const d of defQ.data || []) {\n    const lc = String((d as any).location_coord || '');\n    if (!lc) continue;\n    defQueuedByCoord.set(lc, (defQueuedByCoord.get(lc) || 0) + 1);\n\n    const completesVal = (d as any).completes_at as string | null;\n    const createdVal = (d as any).created_at as string | null;\n    const startedVal = (d as any).started_at as string | null;\n    const orderTs = completesVal ? new Date(completesVal).getTime() : (createdVal ? new Date(createdVal).getTime() : Number.POSITIVE_INFINITY);\n\n    let name = '';\n    const key = String((d as any).defense_key || '');\n    if (key) {\n      try {\n        const spec = getDefensesList().find((it) => String((it as any).key) === key);\n        name = (spec as any)?.name || key;\n      } catch {\n        name = key;\n      }\n    }\n\n    let remaining = 0;\n    let percent: number | undefined = undefined;\n    if (completesVal && startedVal) {\n      const st = new Date(startedVal).getTime();\n      const et = new Date(completesVal).getTime();\n      if (Number.isFinite(st) && Number.isFinite(et) && et > st) {\n        remaining = Math.max(0, et - nowTs);\n        const total = et - st;\n        const elapsed = Math.max(0, nowTs - st);\n        percent = Math.min(100, Math.max(0, Math.floor((elapsed / total) * 100)));\n      }\n    }\n\n    const prev = defEarliestByCoord.get(lc);\n    if (!prev || orderTs < prev.ts) {\n      defEarliestByCoord.set(lc, { name, remaining, percent, ts: orderTs });\n    }\n  }\n\n  const bases = (locations as any[]).map((loc) => {\n    const coord = String(loc.coord);\n    const colony = colonyByCoord.get(coord);\n    return {\n      baseId: coord,\n      name: colony?.name || `Base ${coord}`,\n      location: coord,\n      economy: { metalPerHour: 0, energyPerHour: 0, researchPerHour: 0 },\n      occupier: null,\n      construction: { queued: consQueuedByCoord.get(coord) || 0, next: (() => { const n = consEarliestByCoord.get(coord); if (!n) return undefined; const { ts, ...rest } = n; return rest; })() },\n      production: { queued: prodQueuedByCoord.get(coord) || 0, next: (() => { const n = prodEarliestByCoord.get(coord); if (!n) return undefined; const { ts, ...rest } = n; return rest; })() },\n      defenses: { queued: defQueuedByCoord.get(coord) || 0, next: (() => { const n = defEarliestByCoord.get(coord); if (!n) return undefined; const { ts, ...rest } = n; return rest; })() },\n      research: researchSummary,\n    };\n  });\n\n  return res.json({ success: true, data: { bases } });\n}));\n\n/**\n * Base Defenses (aggregated levels per defense type at a base)\n * DTO: { success, data: { coord, defenseLevels: Array<{ key, name, level, energyDelta }>, inProgress: Array<{ key, name, completesAt }> }, message }\n */\nrouter.get('/:coord/defenses', asyncHandler(async (req: AuthRequest, res: Response) => {\n  // Supabase implementation: defenses not yet modeled -> return empty but valid payload\n  const { coord } = req.params as { coord: string };\n  if (!coord) return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: ERROR_MESSAGES.COORDINATE_PARAMETER_REQUIRED });\n  return res.json({ success: true, data: { coord, defenseLevels: [], inProgress: [] }, message: 'Base defenses loaded' });\n}));\n\n/**\n * Structures list for a specific base (catalogKey-first with ETA)\n * DTO: { success, data: { coord, constructionPerHour, items: [...] }, message }\n */\nrouter.get('/:coord/structures', asyncHandler(async (req: AuthRequest, res: Response) => {\n  const user = req.user! as any;\n  const userId = user?._id || user?.id;\n\n  // Resolve empire id\n  let empireId: string | null = null;\n  const userRow = await supabase.from(DB_TABLES.USERS).select('id, empire_id').eq(DB_FIELDS.BUILDINGS.ID, userId).maybeSingle();\n  if (userRow.data?.empire_id) empireId = String(userRow.data.empire_id);\n  if (!empireId) {\n    const e = await supabase.from(DB_TABLES.EMPIRES).select(DB_FIELDS.BUILDINGS.ID).eq(DB_FIELDS.EMPIRES.USER_ID, userId).maybeSingle();\n    if (e.data?.id) empireId = String(e.data.id);\n  }\n  if (!empireId) return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\n\n  const { coord } = req.params as { coord: string };\n  if (!coord) return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: ERROR_MESSAGES.COORDINATE_PARAMETER_REQUIRED });\n\n  const { CapacityService } = await import('../../../services/bases/CapacityService');\n  const caps = await CapacityService.getBaseCapacities(empireId, coord);\n\n  // Current buildings at base\n  const bRes = await supabase\n    .from(DB_TABLES.BUILDINGS)\n    .select('catalog_key, level, is_active, pending_upgrade, construction_started, construction_completed, credits_cost')\n    .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n    .eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, coord);\n\n  // Finalize any completed constructions client-side-like: if completed <= now, treat as active\n  const nowTs = Date.now();\n\n  // Compute current levels by catalog_key (active + pendingUpgrade treated as current)\n  const levelByKey = new Map<string, number>();\n  for (const b of bRes.data || []) {\n    const key = String((b as any).catalog_key || '');\n    if (!key) continue;\n    const level = Math.max(0, Number((b as any).level || 0));\n    const isActive = (b as any).is_active === true;\n    const pendingUpgrade = (b as any).pending_upgrade === true;\n    const completes = (b as any).construction_completed ? new Date((b as any).construction_completed as any).getTime() : 0;\n    const effectiveActive = isActive || pendingUpgrade || (completes && completes <= nowTs);\n    if (effectiveActive) {\n      levelByKey.set(key, (levelByKey.get(key) || 0) + level);\n    }\n  }\n\n  // Determine currently active construction (earliest future completion among inactive docs)\n  let activeConstruction: { key: BuildingKey; completionAt: string; startedAt?: string; currentLevel: number; targetLevel: number; creditsCost: number; pendingUpgrade: boolean } | null = null;\n  let earliest = Number.POSITIVE_INFINITY;\n  for (const b of bRes.data || []) {\n    const isActive = (b as any).is_active === true;\n    const completes = (b as any).construction_completed ? new Date((b as any).construction_completed as any).getTime() : 0;\n    if (!isActive && completes && completes > nowTs && completes < earliest) {\n      earliest = completes;\n      const key = String((b as any).catalog_key || '') as BuildingKey;\n      const st = (b as any).construction_started ? new Date((b as any).construction_started as any).toISOString() : undefined;\n      const level = Math.max(1, Number((b as any).level || 1));\n      const pendingUpgrade = (b as any).pending_upgrade === true;\n      const currentLevel = pendingUpgrade ? level : 0;\n      const targetLevel = pendingUpgrade ? level + 1 : level;\n      const creditsCost = Math.max(0, Number((b as any).credits_cost || 0));\n      activeConstruction = { key, completionAt: new Date(completes).toISOString(), startedAt: st, currentLevel, targetLevel, creditsCost, pendingUpgrade };\n    }\n  }\n\n  const constructionPerHour = Math.max(0, Number((caps as any)?.construction?.value || 0));\n\n  const catalog = getBuildingsList();\n  const items = catalog.map((spec) => {\n    const key = spec.key as BuildingKey;\n    const currentLevel = levelByKey.get(key) ?? 0;\n    const nextLevel = currentLevel + 1;\n    let creditsCostNext: number | null = null;\n    try {\n      creditsCostNext = getStructureCreditCostForLevel(key, nextLevel);\n    } catch {\n      creditsCostNext = currentLevel === 0 ? spec.creditsCost : null;\n    }\n    // For Phase 1, report eligibility as default-true; detailed gating enforced on start()\n    const canStart = true;\n    const reasons: string[] = [];\n\n    let etaMinutes: number | null = null;\n    if (typeof creditsCostNext === 'number' && constructionPerHour > 0) {\n      const hours = creditsCostNext / constructionPerHour;\n      etaMinutes = Math.max(1, Math.ceil(hours * 60));\n    }\n\n    return {\n      key,\n      name: spec.name,\n      currentLevel,\n      nextLevel,\n      creditsCostNext,\n      energyDelta: Number(spec.energyDelta || 0),\n      requires: spec.techPrereqs?.map((p) => ({ key: p.key, level: p.level })) || [],\n      canStart,\n      reasons,\n      etaMinutes,\n    };\n  });\n\n  return res.json({ success: true, data: { coord, constructionPerHour, items, activeConstruction }, message: 'Base structures loaded' });\n}));\n\n/**\n * Base Resources\n */\nrouter.get('/:coord/resources', asyncHandler(async (req: AuthRequest, res: Response) => {\n  const { coord } = req.params as { coord: string };\n  if (!coord) return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: ERROR_MESSAGES.COORDINATE_PARAMETER_REQUIRED });\n\n  // Not implemented yet\n  return res.json({ success: true, data: { coord } });\n}));\n\nexport default router;\n\n\n\n\n\n\n"],"version":3}