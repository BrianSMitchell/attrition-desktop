{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\middleware\\errorHandler.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\middleware\\errorHandler.ts"],"sourcesContent":["import { Request, Response, NextFunction } from 'express';\r\nimport winston from 'winston';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { HTTP_STATUS, ERROR_MESSAGES } from '../constants/response-formats';\r\nimport { ENV_VARS, ENV_VALUES } from '@game/shared';\n\r\n\r\n// Create Winston logger instance\r\nconst logger = winston.createLogger({\r\n  level: process.env[ENV_VARS.LOG_LEVEL] || 'info',\r\n  format: winston.format.combine(\r\n    winston.format.timestamp(),\r\n    winston.format.errors({ stack: true }),\r\n    winston.format.json()\r\n  ),\r\n  defaultMeta: { service: 'attrition-api' },\r\n  transports: [\r\n    new winston.transports.Console({\r\n      format: winston.format.combine(\r\n        winston.format.colorize(),\r\n        winston.format.simple()\r\n      )\r\n    })\r\n  ]\r\n});\r\n\r\nexport interface AppError extends Error {\r\n  statusCode?: number;\r\n  isOperational?: boolean;\r\n  errorCode?: string;\r\n  correlationId?: string;\r\n  context?: Record<string, any>;\r\n}\r\n\r\n// Error categories for better classification\r\nexport enum ErrorCategory {\r\n  VALIDATION = 'VALIDATION',\r\n  AUTHENTICATION = 'AUTHENTICATION',\r\n  AUTHORIZATION = 'AUTHORIZATION',\r\n  DATABASE = 'DATABASE',\r\n  NETWORK = 'NETWORK',\r\n  BUSINESS_LOGIC = 'BUSINESS_LOGIC',\r\n  EXTERNAL_SERVICE = 'EXTERNAL_SERVICE',\r\n  SYSTEM = 'SYSTEM'\r\n}\r\n\r\n// Enhanced error handler middleware\r\nexport const errorHandler = (\r\n  error: AppError,\r\n  req: Request,\r\n  res: Response,\r\n  next: NextFunction\r\n): void => {\r\n  // Generate correlation ID for request tracing\r\n  const correlationId = error.correlationId || uuidv4();\r\n  error.correlationId = correlationId;\r\n\r\n  // Default error values\r\n  let {\r\n    statusCode = HTTP_STATUS.INTERNAL_SERVER_ERROR,\r\n    message = ERROR_MESSAGES.INTERNAL_ERROR,\r\n    errorCode = ERROR_MESSAGES.INTERNAL_ERROR\r\n  } = error;\r\n\r\n  // Enhanced error categorization\r\n  let category = ErrorCategory.SYSTEM;\r\n\r\n  // Generic validation error\r\n  if (error.name === 'ValidationError') {\r\n    statusCode = HTTP_STATUS.BAD_REQUEST;\r\n    message = ERROR_MESSAGES.VALIDATION_ERROR;\r\n    errorCode = 'VALIDATION_ERROR';\r\n    category = ErrorCategory.VALIDATION;\r\n  }\r\n\r\n  // Database constraint errors (Supabase/PostgreSQL)\r\n  if ((error as any).code === '23505' || error.message?.includes('duplicate') || error.message?.includes('unique')) {\r\n    statusCode = HTTP_STATUS.BAD_REQUEST;\r\n    message = 'Duplicate field value';\r\n    errorCode = 'DUPLICATE_VALUE';\r\n    category = ErrorCategory.DATABASE;\r\n  }\r\n\r\n  // JWT errors\r\n  if (error.name === 'JsonWebTokenError') {\r\n    statusCode = HTTP_STATUS.UNAUTHORIZED;\r\n    message = ERROR_MESSAGES.TOKEN_INVALID;\r\n    errorCode = 'INVALID_TOKEN';\r\n    category = ErrorCategory.AUTHENTICATION;\r\n  }\r\n\r\n  if (error.name === 'TokenExpiredError') {\r\n    statusCode = HTTP_STATUS.UNAUTHORIZED;\r\n    message = ERROR_MESSAGES.TOKEN_EXPIRED;\r\n    errorCode = 'TOKEN_EXPIRED';\r\n    category = ErrorCategory.AUTHENTICATION;\r\n  }\r\n\r\n  // Database connection errors (Supabase)\r\n  if (error.message?.includes('connection') || error.message?.includes('timeout')) {\r\n    statusCode = 503;\r\n    message = 'Database unavailable';\r\n    errorCode = 'DATABASE_UNAVAILABLE';\r\n    category = ErrorCategory.DATABASE;\r\n  }\r\n\r\n  // Log error with structured format\r\n  const errorLog = {\r\n    correlationId,\r\n    timestamp: new Date().toISOString(),\r\n    level: 'error',\r\n    category,\r\n    errorCode,\r\n    message: error.message,\r\n    stack: error.stack,\r\n    statusCode,\r\n    isOperational: error.isOperational,\r\n    context: error.context || {},\r\n    request: {\r\n      method: req.method,\r\n      url: req.url,\r\n      headers: req.headers,\r\n      userAgent: req.get('User-Agent'),\r\n      ip: req.ip,\r\n      correlationId\r\n    }\r\n  };\r\n\r\n  // Log error\r\n  logger.error('Application Error', errorLog);\r\n\r\n  // Don't leak internal error details in production\r\n  const isDevelopment = process.env[ENV_VARS.NODE_ENV] === ENV_VALUES.DEVELOPMENT;\r\n  \r\n  const response = {\r\n    success: false,\r\n    error: message,\r\n    errorCode,\r\n    correlationId,\r\n    ...(isDevelopment && { stack: error.stack }),\r\n    ...(statusCode >= HTTP_STATUS.INTERNAL_SERVER_ERROR && { \r\n      message: 'An internal server error occurred. Please try again later.' \r\n    })\r\n  };\r\n\r\n  res.status(statusCode).json(response);\r\n};\r\n\r\n// Async handler wrapper for better error handling\r\nexport const asyncHandler = (fn: Function) => (req: Request, res: Response, next: NextFunction) => {\r\n  Promise.resolve(fn(req, res, next)).catch(next);\r\n};\r\n\r\n// Validation error handler\r\nexport const handleValidationError = (error: any, fieldName: string) => {\r\n  const appError: AppError = new Error(`Invalid ${fieldName}`);\r\n  appError.statusCode = HTTP_STATUS.BAD_REQUEST;\r\n  appError.errorCode = 'VALIDATION_ERROR';\r\n  appError.context = { field: fieldName, originalError: error.message };\r\n  return appError;\r\n};\r\n\r\n// Database error handler\r\nexport const handleDatabaseError = (error: any, operation: string) => {\r\n  const appError: AppError = new Error(`Database operation failed: ${operation}`);\r\n  appError.statusCode = HTTP_STATUS.INTERNAL_SERVER_ERROR;\r\n  appError.errorCode = 'DATABASE_ERROR';\r\n  appError.context = { operation, originalError: error.message };\r\n  \r\n  // Log database errors with higher severity\r\n  logger.error(ERROR_MESSAGES.DATABASE_ERROR, {\r\n    operation,\r\n    error: error.message,\r\n    stack: error.stack\r\n  });\r\n  \r\n  return appError;\r\n};\r\n\r\n// Business logic error handler\r\nexport const handleBusinessLogicError = (message: string, errorCode: string = 'BUSINESS_LOGIC_ERROR') => {\r\n  const appError: AppError = new Error(message);\r\n  appError.statusCode = HTTP_STATUS.BAD_REQUEST;\r\n  appError.errorCode = errorCode;\r\n  appError.isOperational = true;\r\n  return appError;\r\n};\r\n\r\n// External service error handler\r\nexport const handleExternalServiceError = (service: string, error: any) => {\r\n  const appError: AppError = new Error(`External service error: ${service}`);\r\n  appError.statusCode = 502;\r\n  appError.errorCode = 'EXTERNAL_SERVICE_ERROR';\r\n  appError.context = { service, originalError: error.message };\r\n  \r\n  logger.error('External Service Error', {\r\n    service,\r\n    error: error.message,\r\n    stack: error.stack\r\n  });\r\n  \r\n  return appError;\r\n};\r\n\r\n// Get logger instance for use in other modules\r\nexport const getLogger = () => logger;\r\n\r\n// Performance monitoring middleware\r\nexport const performanceMonitor = (req: Request, res: Response, next: NextFunction) => {\r\n  const startTime = Date.now();\r\n  const correlationId = uuidv4();\r\n  \r\n  // Add correlation ID to request\r\n  (req as any).correlationId = correlationId;\r\n\r\n  // Log request start\r\n  logger.info('Request Started', {\r\n    correlationId,\r\n    method: req.method,\r\n    url: req.url,\r\n    timestamp: new Date().toISOString()\r\n  });\r\n\r\n  // Log response completion\r\n  res.on('finish', () => {\r\n    const duration = Date.now() - startTime;\r\n    const logLevel = duration > 1000 ? 'warn' : 'info';\r\n    \r\n    logger.log(logLevel, 'Request Completed', {\r\n      correlationId,\r\n      method: req.method,\r\n      url: req.url,\r\n      statusCode: res.statusCode,\r\n      durationMs: duration,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n  });\r\n\r\n  next();\r\n};\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"version":3}