300177adbf4cded490c0660e1c82647e
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.performanceMonitor = exports.getLogger = exports.handleExternalServiceError = exports.handleBusinessLogicError = exports.handleDatabaseError = exports.handleValidationError = exports.asyncHandler = exports.errorHandler = exports.ErrorCategory = void 0;
const winston_1 = __importDefault(require("winston"));
const uuid_1 = require("uuid");
const response_formats_1 = require("../constants/response-formats");
const shared_1 = require("@game/shared");
// Create Winston logger instance
const logger = winston_1.default.createLogger({
    level: process.env[shared_1.ENV_VARS.LOG_LEVEL] || 'info',
    format: winston_1.default.format.combine(winston_1.default.format.timestamp(), winston_1.default.format.errors({ stack: true }), winston_1.default.format.json()),
    defaultMeta: { service: 'attrition-api' },
    transports: [
        new winston_1.default.transports.Console({
            format: winston_1.default.format.combine(winston_1.default.format.colorize(), winston_1.default.format.simple())
        })
    ]
});
// Error categories for better classification
var ErrorCategory;
(function (ErrorCategory) {
    ErrorCategory["VALIDATION"] = "VALIDATION";
    ErrorCategory["AUTHENTICATION"] = "AUTHENTICATION";
    ErrorCategory["AUTHORIZATION"] = "AUTHORIZATION";
    ErrorCategory["DATABASE"] = "DATABASE";
    ErrorCategory["NETWORK"] = "NETWORK";
    ErrorCategory["BUSINESS_LOGIC"] = "BUSINESS_LOGIC";
    ErrorCategory["EXTERNAL_SERVICE"] = "EXTERNAL_SERVICE";
    ErrorCategory["SYSTEM"] = "SYSTEM";
})(ErrorCategory || (exports.ErrorCategory = ErrorCategory = {}));
// Enhanced error handler middleware
const errorHandler = (error, req, res, next) => {
    // Generate correlation ID for request tracing
    const correlationId = error.correlationId || (0, uuid_1.v4)();
    error.correlationId = correlationId;
    // Default error values
    let { statusCode = response_formats_1.HTTP_STATUS.INTERNAL_SERVER_ERROR, message = response_formats_1.ERROR_MESSAGES.INTERNAL_ERROR, errorCode = response_formats_1.ERROR_MESSAGES.INTERNAL_ERROR } = error;
    // Enhanced error categorization
    let category = ErrorCategory.SYSTEM;
    // Generic validation error
    if (error.name === 'ValidationError') {
        statusCode = response_formats_1.HTTP_STATUS.BAD_REQUEST;
        message = response_formats_1.ERROR_MESSAGES.VALIDATION_ERROR;
        errorCode = 'VALIDATION_ERROR';
        category = ErrorCategory.VALIDATION;
    }
    // Database constraint errors (Supabase/PostgreSQL)
    if (error.code === '23505' || error.message?.includes('duplicate') || error.message?.includes('unique')) {
        statusCode = response_formats_1.HTTP_STATUS.BAD_REQUEST;
        message = 'Duplicate field value';
        errorCode = 'DUPLICATE_VALUE';
        category = ErrorCategory.DATABASE;
    }
    // JWT errors
    if (error.name === 'JsonWebTokenError') {
        statusCode = response_formats_1.HTTP_STATUS.UNAUTHORIZED;
        message = response_formats_1.ERROR_MESSAGES.TOKEN_INVALID;
        errorCode = 'INVALID_TOKEN';
        category = ErrorCategory.AUTHENTICATION;
    }
    if (error.name === 'TokenExpiredError') {
        statusCode = response_formats_1.HTTP_STATUS.UNAUTHORIZED;
        message = response_formats_1.ERROR_MESSAGES.TOKEN_EXPIRED;
        errorCode = 'TOKEN_EXPIRED';
        category = ErrorCategory.AUTHENTICATION;
    }
    // Database connection errors (Supabase)
    if (error.message?.includes('connection') || error.message?.includes('timeout')) {
        statusCode = 503;
        message = 'Database unavailable';
        errorCode = 'DATABASE_UNAVAILABLE';
        category = ErrorCategory.DATABASE;
    }
    // Log error with structured format
    const errorLog = {
        correlationId,
        timestamp: new Date().toISOString(),
        level: 'error',
        category,
        errorCode,
        message: error.message,
        stack: error.stack,
        statusCode,
        isOperational: error.isOperational,
        context: error.context || {},
        request: {
            method: req.method,
            url: req.url,
            headers: req.headers,
            userAgent: req.get('User-Agent'),
            ip: req.ip,
            correlationId
        }
    };
    // Log error
    logger.error('Application Error', errorLog);
    // Don't leak internal error details in production
    const isDevelopment = process.env[shared_1.ENV_VARS.NODE_ENV] === shared_1.ENV_VALUES.DEVELOPMENT;
    const response = {
        success: false,
        error: message,
        errorCode,
        correlationId,
        ...(isDevelopment && { stack: error.stack }),
        ...(statusCode >= response_formats_1.HTTP_STATUS.INTERNAL_SERVER_ERROR && {
            message: 'An internal server error occurred. Please try again later.'
        })
    };
    res.status(statusCode).json(response);
};
exports.errorHandler = errorHandler;
// Async handler wrapper for better error handling
const asyncHandler = (fn) => (req, res, next) => {
    Promise.resolve(fn(req, res, next)).catch(next);
};
exports.asyncHandler = asyncHandler;
// Validation error handler
const handleValidationError = (error, fieldName) => {
    const appError = new Error(`Invalid ${fieldName}`);
    appError.statusCode = response_formats_1.HTTP_STATUS.BAD_REQUEST;
    appError.errorCode = 'VALIDATION_ERROR';
    appError.context = { field: fieldName, originalError: error.message };
    return appError;
};
exports.handleValidationError = handleValidationError;
// Database error handler
const handleDatabaseError = (error, operation) => {
    const appError = new Error(`Database operation failed: ${operation}`);
    appError.statusCode = response_formats_1.HTTP_STATUS.INTERNAL_SERVER_ERROR;
    appError.errorCode = 'DATABASE_ERROR';
    appError.context = { operation, originalError: error.message };
    // Log database errors with higher severity
    logger.error(response_formats_1.ERROR_MESSAGES.DATABASE_ERROR, {
        operation,
        error: error.message,
        stack: error.stack
    });
    return appError;
};
exports.handleDatabaseError = handleDatabaseError;
// Business logic error handler
const handleBusinessLogicError = (message, errorCode = 'BUSINESS_LOGIC_ERROR') => {
    const appError = new Error(message);
    appError.statusCode = response_formats_1.HTTP_STATUS.BAD_REQUEST;
    appError.errorCode = errorCode;
    appError.isOperational = true;
    return appError;
};
exports.handleBusinessLogicError = handleBusinessLogicError;
// External service error handler
const handleExternalServiceError = (service, error) => {
    const appError = new Error(`External service error: ${service}`);
    appError.statusCode = 502;
    appError.errorCode = 'EXTERNAL_SERVICE_ERROR';
    appError.context = { service, originalError: error.message };
    logger.error('External Service Error', {
        service,
        error: error.message,
        stack: error.stack
    });
    return appError;
};
exports.handleExternalServiceError = handleExternalServiceError;
// Get logger instance for use in other modules
const getLogger = () => logger;
exports.getLogger = getLogger;
// Performance monitoring middleware
const performanceMonitor = (req, res, next) => {
    const startTime = Date.now();
    const correlationId = (0, uuid_1.v4)();
    // Add correlation ID to request
    req.correlationId = correlationId;
    // Log request start
    logger.info('Request Started', {
        correlationId,
        method: req.method,
        url: req.url,
        timestamp: new Date().toISOString()
    });
    // Log response completion
    res.on('finish', () => {
        const duration = Date.now() - startTime;
        const logLevel = duration > 1000 ? 'warn' : 'info';
        logger.log(logLevel, 'Request Completed', {
            correlationId,
            method: req.method,
            url: req.url,
            statusCode: res.statusCode,
            durationMs: duration,
            timestamp: new Date().toISOString()
        });
    });
    next();
};
exports.performanceMonitor = performanceMonitor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFByb2plY3RzXFxBdHRyaXRpb25cXHBhY2thZ2VzXFxzZXJ2ZXJcXHNyY1xcbWlkZGxld2FyZVxcZXJyb3JIYW5kbGVyLnRzIiwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLHNEQUE4QjtBQUM5QiwrQkFBb0M7QUFDcEMsb0VBQTRFO0FBQzVFLHlDQUFvRDtBQUdwRCxpQ0FBaUM7QUFDakMsTUFBTSxNQUFNLEdBQUcsaUJBQU8sQ0FBQyxZQUFZLENBQUM7SUFDbEMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQVEsQ0FBQyxTQUFTLENBQUMsSUFBSSxNQUFNO0lBQ2hELE1BQU0sRUFBRSxpQkFBTyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQzVCLGlCQUFPLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxFQUMxQixpQkFBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFDdEMsaUJBQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQ3RCO0lBQ0QsV0FBVyxFQUFFLEVBQUUsT0FBTyxFQUFFLGVBQWUsRUFBRTtJQUN6QyxVQUFVLEVBQUU7UUFDVixJQUFJLGlCQUFPLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQztZQUM3QixNQUFNLEVBQUUsaUJBQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUM1QixpQkFBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsRUFDekIsaUJBQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQ3hCO1NBQ0YsQ0FBQztLQUNIO0NBQ0YsQ0FBQyxDQUFDO0FBVUgsNkNBQTZDO0FBQzdDLElBQVksYUFTWDtBQVRELFdBQVksYUFBYTtJQUN2QiwwQ0FBeUIsQ0FBQTtJQUN6QixrREFBaUMsQ0FBQTtJQUNqQyxnREFBK0IsQ0FBQTtJQUMvQixzQ0FBcUIsQ0FBQTtJQUNyQixvQ0FBbUIsQ0FBQTtJQUNuQixrREFBaUMsQ0FBQTtJQUNqQyxzREFBcUMsQ0FBQTtJQUNyQyxrQ0FBaUIsQ0FB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QUFrQixzQkErQjdCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxQcm9qZWN0c1xcQXR0cml0aW9uXFxwYWNrYWdlc1xcc2VydmVyXFxzcmNcXG1pZGRsZXdhcmVcXGVycm9ySGFuZGxlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSwgTmV4dEZ1bmN0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XHJcbmltcG9ydCB3aW5zdG9uIGZyb20gJ3dpbnN0b24nO1xyXG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tICd1dWlkJztcclxuaW1wb3J0IHsgSFRUUF9TVEFUVVMsIEVSUk9SX01FU1NBR0VTIH0gZnJvbSAnLi4vY29uc3RhbnRzL3Jlc3BvbnNlLWZvcm1hdHMnO1xyXG5pbXBvcnQgeyBFTlZfVkFSUywgRU5WX1ZBTFVFUyB9IGZyb20gJ0BnYW1lL3NoYXJlZCc7XG5cclxuXHJcbi8vIENyZWF0ZSBXaW5zdG9uIGxvZ2dlciBpbnN0YW5jZVxyXG5jb25zdCBsb2dnZXIgPSB3aW5zdG9uLmNyZWF0ZUxvZ2dlcih7XHJcbiAgbGV2ZWw6IHByb2Nlc3MuZW52W0VOVl9WQVJTLkxPR19MRVZFTF0gfHwgJ2luZm8nLFxyXG4gIGZvcm1hdDogd2luc3Rvbi5mb3JtYXQuY29tYmluZShcclxuICAgIHdpbnN0b24uZm9ybWF0LnRpbWVzdGFtcCgpLFxyXG4gICAgd2luc3Rvbi5mb3JtYXQuZXJyb3JzKHsgc3RhY2s6IHRydWUgfSksXHJcbiAgICB3aW5zdG9uLmZvcm1hdC5qc29uKClcclxuICApLFxyXG4gIGRlZmF1bHRNZXRhOiB7IHNlcnZpY2U6ICdhdHRyaXRpb24tYXBpJyB9LFxyXG4gIHRyYW5zcG9ydHM6IFtcclxuICAgIG5ldyB3aW5zdG9uLnRyYW5zcG9ydHMuQ29uc29sZSh7XHJcbiAgICAgIGZvcm1hdDogd2luc3Rvbi5mb3JtYXQuY29tYmluZShcclxuICAgICAgICB3aW5zdG9uLmZvcm1hdC5jb2xvcml6ZSgpLFxyXG4gICAgICAgIHdpbnN0b24uZm9ybWF0LnNpbXBsZSgpXHJcbiAgICAgIClcclxuICAgIH0pXHJcbiAgXVxyXG59KTtcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQXBwRXJyb3IgZXh0ZW5kcyBFcnJvciB7XHJcbiAgc3RhdHVzQ29kZT86IG51bWJlcjtcclxuICBpc09wZXJhdGlvbmFsPzogYm9vbGVhbjtcclxuICBlcnJvckNvZGU/OiBzdHJpbmc7XHJcbiAgY29ycmVsYXRpb25JZD86IHN0cmluZztcclxuICBjb250ZXh0PzogUmVjb3JkPHN0cmluZywgYW55PjtcclxufVxyXG5cclxuLy8gRXJyb3IgY2F0ZWdvcmllcyBmb3IgYmV0dGVyIGNsYXNzaWZpY2F0aW9uXHJcbmV4cG9ydCBlbnVtIEVycm9yQ2F0ZWdvcnkge1xyXG4gIFZBTElEQVRJT04gPSAnVkFMSURBVElPTicsXHJcbiAgQVVUSEVOVElDQVRJT04gPSAnQVVUSEVOVElDQVRJT04nLFxyXG4gIEFVVEhPUklaQVRJT04gPSAnQVVUSE9SSVpBVElPTicsXHJcbiAgREFUQUJBU0UgPSAnREFUQUJBU0UnLFxyXG4gIE5FVFdPUksgPSAnTkVUV09SSycsXHJcbiAgQlVTSU5FU1NfTE9HSUMgPSAnQlVTSU5FU1NfTE9HSUMnLFxyXG4gIEVYVEVSTkFMX1NFUlZJQ0UgPSAnRVhURVJOQUxfU0VSVklDRScsXHJcbiAgU1lTVEVNID0gJ1NZU1RFTSdcclxufVxyXG5cclxuLy8gRW5oYW5jZWQgZXJyb3IgaGFuZGxlciBtaWRkbGV3YXJlXHJcbmV4cG9ydCBjb25zdCBlcnJvckhhbmRsZXIgPSAoXHJcbiAgZXJyb3I6IEFwcEVycm9yLFxyXG4gIHJlcTogUmVxdWVzdCxcclxuICByZXM6IFJlc3BvbnNlLFxyXG4gIG5leHQ6IE5leHRGdW5jdGlvblxyXG4pOiB2b2lkID0+IHtcclxuICAvLyBHZW5lcmF0ZSBjb3JyZWxhdGlvbiBJRCBmb3IgcmVxdWVzdCB0cmFjaW5nXHJcbiAgY29uc3QgY29ycmVsYXRpb25JZCA9IGVycm9yLmNvcnJlbGF0aW9uSWQgfHwgdXVpZHY0KCk7XHJcbiAgZXJyb3IuY29ycmVsYXRpb25JZCA9IGNvcnJlbGF0aW9uSWQ7XHJcblxyXG4gIC8vIERlZmF1bHQgZXJyb3IgdmFsdWVzXHJcbiAgbGV0IHtcclxuICAgIHN0YXR1c0NvZGUgPSBIVFRQX1NUQVRVUy5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXHJcbiAgICBtZXNzYWdlID0gRVJST1JfTUVTU0FHRVMuSU5URVJOQUxfRVJST1IsXHJcbiAgICBlcnJvckNvZGUgPSBFUlJPUl9NRVNTQUdFUy5JTlRFUk5BTF9FUlJPUlxyXG4gIH0gPSBlcnJvcjtcclxuXHJcbiAgLy8gRW5oYW5jZWQgZXJyb3IgY2F0ZWdvcml6YXRpb25cclxuICBsZXQgY2F0ZWdvcnkgPSBFcnJvckNhdGVnb3J5LlNZU1RFTTtcclxuXHJcbiAgLy8gR2VuZXJpYyB2YWxpZGF0aW9uIGVycm9yXHJcbiAgaWYgKGVycm9yLm5hbWUgPT09ICdWYWxpZGF0aW9uRXJyb3InKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gSFRUUF9TVEFUVVMuQkFEX1JFUVVFU1Q7XHJcbiAgICBtZXNzYWdlID0gRVJST1JfTUVTU0FHRVMuVkFMSURBVElPTl9FUlJPUjtcclxuICAgIGVycm9yQ29kZSA9ICdWQUxJREFUSU9OX0VSUk9SJztcclxuICAgIGNhdGVnb3J5ID0gRXJyb3JDYXRlZ29yeS5WQUxJREFUSU9OO1xyXG4gIH1cclxuXHJcbiAgLy8gRGF0YWJhc2UgY29uc3RyYWludCBlcnJvcnMgKFN1cGFiYXNlL1Bvc3RncmVTUUwpXHJcbiAgaWYgKChlcnJvciBhcyBhbnkpLmNvZGUgPT09ICcyMzUwNScgfHwgZXJyb3IubWVzc2FnZT8uaW5jbHVkZXMoJ2R1cGxpY2F0ZScpIHx8IGVycm9yLm1lc3NhZ2U/LmluY2x1ZGVzKCd1bmlxdWUnKSkge1xyXG4gICAgc3RhdHVzQ29kZSA9IEhUVFBfU1RBVFVTLkJBRF9SRVFVRVNUO1xyXG4gICAgbWVzc2FnZSA9ICdEdXBsaWNhdGUgZmllbGQgdmFsdWUnO1xyXG4gICAgZXJyb3JDb2RlID0gJ0RVUExJQ0FURV9WQUxVRSc7XHJcbiAgICBjYXRlZ29yeSA9IEVycm9yQ2F0ZWdvcnkuREFUQUJBU0U7XHJcbiAgfVxyXG5cclxuICAvLyBKV1QgZXJyb3JzXHJcbiAgaWYgKGVycm9yLm5hbWUgPT09ICdKc29uV2ViVG9rZW5FcnJvcicpIHtcclxuICAgIHN0YXR1c0NvZGUgPSBIVFRQX1NUQVRVUy5VTkFVVEhPUklaRUQ7XHJcbiAgICBtZXNzYWdlID0gRVJST1JfTUVTU0FHRVMuVE9LRU5fSU5WQUxJRDtcclxuICAgIGVycm9yQ29kZSA9ICdJTlZBTElEX1RPS0VOJztcclxuICAgIGNhdGVnb3J5ID0gRXJyb3JDYXRlZ29yeS5BVVRIRU5USUNBVElPTjtcclxuICB9XHJcblxyXG4gIGlmIChlcnJvci5uYW1lID09PSAnVG9rZW5FeHBpcmVkRXJyb3InKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gSFRUUF9TVEFUVVMuVU5BVVRIT1JJWkVEO1xyXG4gICAgbWVzc2FnZSA9IEVSUk9SX01FU1NBR0VTLlRPS0VOX0VYUElSRUQ7XHJcbiAgICBlcnJvckNvZGUgPSAnVE9LRU5fRVhQSVJFRCc7XHJcbiAgICBjYXRlZ29yeSA9IEVycm9yQ2F0ZWdvcnkuQVVUSEVOVElDQVRJT047XHJcbiAgfVxyXG5cclxuICAvLyBEYXRhYmFzZSBjb25uZWN0aW9uIGVycm9ycyAoU3VwYWJhc2UpXHJcbiAgaWYgKGVycm9yLm1lc3NhZ2U/LmluY2x1ZGVzKCdjb25uZWN0aW9uJykgfHwgZXJyb3IubWVzc2FnZT8uaW5jbHVkZXMoJ3RpbWVvdXQnKSkge1xyXG4gICAgc3RhdHVzQ29kZSA9IDUwMztcclxuICAgIG1lc3NhZ2UgPSAnRGF0YWJhc2UgdW5hdmFpbGFibGUnO1xyXG4gICAgZXJyb3JDb2RlID0gJ0RBVEFCQVNFX1VOQVZBSUxBQkxFJztcclxuICAgIGNhdGVnb3J5ID0gRXJyb3JDYXRlZ29yeS5EQVRBQkFTRTtcclxuICB9XHJcblxyXG4gIC8vIExvZyBlcnJvciB3aXRoIHN0cnVjdHVyZWQgZm9ybWF0XHJcbiAgY29uc3QgZXJyb3JMb2cgPSB7XHJcbiAgICBjb3JyZWxhdGlvbklkLFxyXG4gICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICBsZXZlbDogJ2Vycm9yJyxcclxuICAgIGNhdGVnb3J5LFxyXG4gICAgZXJyb3JDb2RlLFxyXG4gICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSxcclxuICAgIHN0YWNrOiBlcnJvci5zdGFjayxcclxuICAgIHN0YXR1c0NvZGUsXHJcbiAgICBpc09wZXJhdGlvbmFsOiBlcnJvci5pc09wZXJhdGlvbmFsLFxyXG4gICAgY29udGV4dDogZXJyb3IuY29udGV4dCB8fCB7fSxcclxuICAgIHJlcXVlc3Q6IHtcclxuICAgICAgbWV0aG9kOiByZXEubWV0aG9kLFxyXG4gICAgICB1cmw6IHJlcS51cmwsXHJcbiAgICAgIGhlYWRlcnM6IHJlcS5oZWFkZXJzLFxyXG4gICAgICB1c2VyQWdlbnQ6IHJlcS5nZXQoJ1VzZXItQWdlbnQnKSxcclxuICAgICAgaXA6IHJlcS5pcCxcclxuICAgICAgY29ycmVsYXRpb25JZFxyXG4gICAgfVxyXG4gIH07XHJcblxyXG4gIC8vIExvZyBlcnJvclxyXG4gIGxvZ2dlci5lcnJvcignQXBwbGljYXRpb24gRXJyb3InLCBlcnJvckxvZyk7XHJcblxyXG4gIC8vIERvbid0IGxlYWsgaW50ZXJuYWwgZXJyb3IgZGV0YWlscyBpbiBwcm9kdWN0aW9uXHJcbiAgY29uc3QgaXNEZXZlbG9wbWVudCA9IHByb2Nlc3MuZW52W0VOVl9WQVJTLk5PREVfRU5WXSA9PT0gRU5WX1ZBTFVFUy5ERVZFTE9QTUVOVDtcclxuICBcclxuICBjb25zdCByZXNwb25zZSA9IHtcclxuICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgZXJyb3I6IG1lc3NhZ2UsXHJcbiAgICBlcnJvckNvZGUsXHJcbiAgICBjb3JyZWxhdGlvbklkLFxyXG4gICAgLi4uKGlzRGV2ZWxvcG1lbnQgJiYgeyBzdGFjazogZXJyb3Iuc3RhY2sgfSksXHJcbiAgICAuLi4oc3RhdHVzQ29kZSA+PSBIVFRQX1NUQVRVUy5JTlRFUk5BTF9TRVJWRVJfRVJST1IgJiYgeyBcclxuICAgICAgbWVzc2FnZTogJ0FuIGludGVybmFsIHNlcnZlciBlcnJvciBvY2N1cnJlZC4gUGxlYXNlIHRyeSBhZ2FpbiBsYXRlci4nIFxyXG4gICAgfSlcclxuICB9O1xyXG5cclxuICByZXMuc3RhdHVzKHN0YXR1c0NvZGUpLmpzb24ocmVzcG9uc2UpO1xyXG59O1xyXG5cclxuLy8gQXN5bmMgaGFuZGxlciB3cmFwcGVyIGZvciBiZXR0ZXIgZXJyb3IgaGFuZGxpbmdcclxuZXhwb3J0IGNvbnN0IGFzeW5jSGFuZGxlciA9IChmbjogRnVuY3Rpb24pID0+IChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xyXG4gIFByb21pc2UucmVzb2x2ZShmbihyZXEsIHJlcywgbmV4dCkpLmNhdGNoKG5leHQpO1xyXG59O1xyXG5cclxuLy8gVmFsaWRhdGlvbiBlcnJvciBoYW5kbGVyXHJcbmV4cG9ydCBjb25zdCBoYW5kbGVWYWxpZGF0aW9uRXJyb3IgPSAoZXJyb3I6IGFueSwgZmllbGROYW1lOiBzdHJpbmcpID0+IHtcclxuICBjb25zdCBhcHBFcnJvcjogQXBwRXJyb3IgPSBuZXcgRXJyb3IoYEludmFsaWQgJHtmaWVsZE5hbWV9YCk7XHJcbiAgYXBwRXJyb3Iuc3RhdHVzQ29kZSA9IEhUVFBfU1RBVFVTLkJBRF9SRVFVRVNUO1xyXG4gIGFwcEVycm9yLmVycm9yQ29kZSA9ICdWQUxJREFUSU9OX0VSUk9SJztcclxuICBhcHBFcnJvci5jb250ZXh0ID0geyBmaWVsZDogZmllbGROYW1lLCBvcmlnaW5hbEVycm9yOiBlcnJvci5tZXNzYWdlIH07XHJcbiAgcmV0dXJuIGFwcEVycm9yO1xyXG59O1xyXG5cclxuLy8gRGF0YWJhc2UgZXJyb3IgaGFuZGxlclxyXG5leHBvcnQgY29uc3QgaGFuZGxlRGF0YWJhc2VFcnJvciA9IChlcnJvcjogYW55LCBvcGVyYXRpb246IHN0cmluZykgPT4ge1xyXG4gIGNvbnN0IGFwcEVycm9yOiBBcHBFcnJvciA9IG5ldyBFcnJvcihgRGF0YWJhc2Ugb3BlcmF0aW9uIGZhaWxlZDogJHtvcGVyYXRpb259YCk7XHJcbiAgYXBwRXJyb3Iuc3RhdHVzQ29kZSA9IEhUVFBfU1RBVFVTLklOVEVSTkFMX1NFUlZFUl9FUlJPUjtcclxuICBhcHBFcnJvci5lcnJvckNvZGUgPSAnREFUQUJBU0VfRVJST1InO1xyXG4gIGFwcEVycm9yLmNvbnRleHQgPSB7IG9wZXJhdGlvbiwgb3JpZ2luYWxFcnJvcjogZXJyb3IubWVzc2FnZSB9O1xyXG4gIFxyXG4gIC8vIExvZyBkYXRhYmFzZSBlcnJvcnMgd2l0aCBoaWdoZXIgc2V2ZXJpdHlcclxuICBsb2dnZXIuZXJyb3IoRVJST1JfTUVTU0FHRVMuREFUQUJBU0VfRVJST1IsIHtcclxuICAgIG9wZXJhdGlvbixcclxuICAgIGVycm9yOiBlcnJvci5tZXNzYWdlLFxyXG4gICAgc3RhY2s6IGVycm9yLnN0YWNrXHJcbiAgfSk7XHJcbiAgXHJcbiAgcmV0dXJuIGFwcEVycm9yO1xyXG59O1xyXG5cclxuLy8gQnVzaW5lc3MgbG9naWMgZXJyb3IgaGFuZGxlclxyXG5leHBvcnQgY29uc3QgaGFuZGxlQnVzaW5lc3NMb2dpY0Vycm9yID0gKG1lc3NhZ2U6IHN0cmluZywgZXJyb3JDb2RlOiBzdHJpbmcgPSAnQlVTSU5FU1NfTE9HSUNfRVJST1InKSA9PiB7XHJcbiAgY29uc3QgYXBwRXJyb3I6IEFwcEVycm9yID0gbmV3IEVycm9yKG1lc3NhZ2UpO1xyXG4gIGFwcEVycm9yLnN0YXR1c0NvZGUgPSBIVFRQX1NUQVRVUy5CQURfUkVRVUVTVDtcclxuICBhcHBFcnJvci5lcnJvckNvZGUgPSBlcnJvckNvZGU7XHJcbiAgYXBwRXJyb3IuaXNPcGVyYXRpb25hbCA9IHRydWU7XHJcbiAgcmV0dXJuIGFwcEVycm9yO1xyXG59O1xyXG5cclxuLy8gRXh0ZXJuYWwgc2VydmljZSBlcnJvciBoYW5kbGVyXHJcbmV4cG9ydCBjb25zdCBoYW5kbGVFeHRlcm5hbFNlcnZpY2VFcnJvciA9IChzZXJ2aWNlOiBzdHJpbmcsIGVycm9yOiBhbnkpID0+IHtcclxuICBjb25zdCBhcHBFcnJvcjogQXBwRXJyb3IgPSBuZXcgRXJyb3IoYEV4dGVybmFsIHNlcnZpY2UgZXJyb3I6ICR7c2VydmljZX1gKTtcclxuICBhcHBFcnJvci5zdGF0dXNDb2RlID0gNTAyO1xyXG4gIGFwcEVycm9yLmVycm9yQ29kZSA9ICdFWFRFUk5BTF9TRVJWSUNFX0VSUk9SJztcclxuICBhcHBFcnJvci5jb250ZXh0ID0geyBzZXJ2aWNlLCBvcmlnaW5hbEVycm9yOiBlcnJvci5tZXNzYWdlIH07XHJcbiAgXHJcbiAgbG9nZ2VyLmVycm9yKCdFeHRlcm5hbCBTZXJ2aWNlIEVycm9yJywge1xyXG4gICAgc2VydmljZSxcclxuICAgIGVycm9yOiBlcnJvci5tZXNzYWdlLFxyXG4gICAgc3RhY2s6IGVycm9yLnN0YWNrXHJcbiAgfSk7XHJcbiAgXHJcbiAgcmV0dXJuIGFwcEVycm9yO1xyXG59O1xyXG5cclxuLy8gR2V0IGxvZ2dlciBpbnN0YW5jZSBmb3IgdXNlIGluIG90aGVyIG1vZHVsZXNcclxuZXhwb3J0IGNvbnN0IGdldExvZ2dlciA9ICgpID0+IGxvZ2dlcjtcclxuXHJcbi8vIFBlcmZvcm1hbmNlIG1vbml0b3JpbmcgbWlkZGxld2FyZVxyXG5leHBvcnQgY29uc3QgcGVyZm9ybWFuY2VNb25pdG9yID0gKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XHJcbiAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcclxuICBjb25zdCBjb3JyZWxhdGlvbklkID0gdXVpZHY0KCk7XHJcbiAgXHJcbiAgLy8gQWRkIGNvcnJlbGF0aW9uIElEIHRvIHJlcXVlc3RcclxuICAocmVxIGFzIGFueSkuY29ycmVsYXRpb25JZCA9IGNvcnJlbGF0aW9uSWQ7XHJcblxyXG4gIC8vIExvZyByZXF1ZXN0IHN0YXJ0XHJcbiAgbG9nZ2VyLmluZm8oJ1JlcXVlc3QgU3RhcnRlZCcsIHtcclxuICAgIGNvcnJlbGF0aW9uSWQsXHJcbiAgICBtZXRob2Q6IHJlcS5tZXRob2QsXHJcbiAgICB1cmw6IHJlcS51cmwsXHJcbiAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gIH0pO1xyXG5cclxuICAvLyBMb2cgcmVzcG9uc2UgY29tcGxldGlvblxyXG4gIHJlcy5vbignZmluaXNoJywgKCkgPT4ge1xyXG4gICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xyXG4gICAgY29uc3QgbG9nTGV2ZWwgPSBkdXJhdGlvbiA+IDEwMDAgPyAnd2FybicgOiAnaW5mbyc7XHJcbiAgICBcclxuICAgIGxvZ2dlci5sb2cobG9nTGV2ZWwsICdSZXF1ZXN0IENvbXBsZXRlZCcsIHtcclxuICAgICAgY29ycmVsYXRpb25JZCxcclxuICAgICAgbWV0aG9kOiByZXEubWV0aG9kLFxyXG4gICAgICB1cmw6IHJlcS51cmwsXHJcbiAgICAgIHN0YXR1c0NvZGU6IHJlcy5zdGF0dXNDb2RlLFxyXG4gICAgICBkdXJhdGlvbk1zOiBkdXJhdGlvbixcclxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBuZXh0KCk7XHJcbn07XHJcblxyXG5cclxuXHJcblxyXG5cclxuXHJcbiJdLCJ2ZXJzaW9uIjozfQ==