{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\services\\empire\\EmpireResolutionService.ts","mappings":";;;AACA,oDAAiD;AACjD,qEAAuE;AAWvE,MAAa,uBAAuB;IAClC,YACU,SAAgC,EAChC,OAA4B;QAD5B,cAAS,GAAT,SAAS,CAAuB;QAChC,YAAO,GAAP,OAAO,CAAqB;IACnC,CAAC;IAEJ;;OAEG;IACI,aAAa,CAAC,QAAgB;QACnC,OAAO,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;IACpC,CAAC;IAED;;OAEG;IACI,eAAe,CAAC,KAAa;QAClC,OAAO,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;IACnC,CAAC;IAED;;OAEG;IACI,YAAY,CAAC,QAAgB,EAAE,KAAa;QACjD,MAAM,QAAQ,GAAG,IAAI,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC;QAC7C,OAAO,QAAQ,EAAE,KAAK,KAAK,QAAQ,CAAC;IACtC,CAAC;IAED;;OAEG;IACI,eAAe,CAAC,KAAa;QAClC,MAAM,QAAQ,GAAG,IAAI,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC;QAC7C,OAAO,CAAC,CAAC,QAAQ,EAAE,KAAK,CAAC;IAC3B,CAAC;IAED;;;;OAIG;IACI,MAAM,CAAC,KAAK,CAAC,yBAAyB,CAAC,IAAgB;QAC5D,MAAM,MAAM,GAAG,IAAI,CAAC,GAAG,IAAI,IAAI,CAAC,EAAE,CAAC;QACnC,IAAI,CAAC,MAAM;YAAE,OAAO,IAAI,CAAC;QAEzB,2BAA2B;QAC3B,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC;YACnB,MAAM,EAAE,IAAI,EAAE,SAAS,EAAE,GAAG,MAAM,mBAAQ;iBACvC,IAAI,CAAC,2BAAS,CAAC,OAAO,CAAC;iBACvB,MAAM,CAAC,iDAAiD,CAAC;iBACzD,EAAE,CAAC,2BAAS,CAAC,SAAS,CAAC,EAAE,EAAE,IAAI,CAAC,SAAS,CAAC;iBAC1C,WAAW,EAAE,CAAC;YAEjB,IAAI,SAAS,EAAE,EAAE;gBAAE,OAAO,SAAS,CAAC;QACtC,CAAC;QAED,4BAA4B;QAC5B,MAAM,EAAE,IAAI,EAAE,SAAS,EAAE,GAAG,MAAM,mBAAQ;aACvC,IAAI,CAAC,2BAAS,CAAC,OAAO,CAAC;aACvB,MAAM,CAAC,iDAAiD,CAAC;aACzD,EAAE,CAAC,2BAAS,CAAC,OAAO,CAAC,OAAO,EAAE,MAAM,CAAC;aACrC,WAAW,EAAE,CAAC;QAEjB,OAAO,SAAS,IAAI,IAAI,CAAC;IAC3B,CAAC;CACF;AAjED,0DAiEC","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\services\\empire\\EmpireResolutionService.ts"],"sourcesContent":["import { Empire, Location } from '@game/shared';\nimport { supabase } from '../../config/supabase';\nimport { DB_TABLES, DB_FIELDS } from '../../constants/database-fields';\n/**\n * Service for resolving empire-related operations and validations\n */\nexport interface UserObject {\n  _id?: string;\n  id?: string;\n  email: string;\n  empire_id?: string;\n}\n\nexport class EmpireResolutionService {\n  constructor(\n    private locations: Map<string, Location>,\n    private empires: Map<string, Empire>\n  ) {}\n\n  /**\n   * Resolve an empire by ID\n   */\n  public resolveEmpire(empireId: string): Empire | undefined {\n    return this.empires.get(empireId);\n  }\n\n  /**\n   * Resolve a location by coordinate\n   */\n  public resolveLocation(coord: string): Location | undefined {\n    return this.locations.get(coord);\n  }\n\n  /**\n   * Check if an empire owns a location\n   */\n  public ownsLocation(empireId: string, coord: string): boolean {\n    const location = this.resolveLocation(coord);\n    return location?.owner === empireId;\n  }\n\n  /**\n   * Check if a location is owned by any empire\n   */\n  public locationIsOwned(coord: string): boolean {\n    const location = this.resolveLocation(coord);\n    return !!location?.owner;\n  }\n\n  /**\n   * Resolve empire by user object.\n   * First checks user.empire_id, then looks up by user_id in empires table.\n   * Returns complete empire data needed by routes.\n   */\n  public static async resolveEmpireByUserObject(user: UserObject): Promise<any | null> {\n    const userId = user._id || user.id;\n    if (!userId) return null;\n\n    // Try user.empire_id first\n    if (user.empire_id) {\n      const { data: empireRow } = await supabase\n        .from(DB_TABLES.EMPIRES)\n        .select('id, name, territories, credits, energy, user_id')\n        .eq(DB_FIELDS.BUILDINGS.ID, user.empire_id)\n        .maybeSingle();\n\n      if (empireRow?.id) return empireRow;\n    }\n\n    // Try looking up by user_id\n    const { data: empireRow } = await supabase\n      .from(DB_TABLES.EMPIRES)\n      .select('id, name, territories, credits, energy, user_id')\n      .eq(DB_FIELDS.EMPIRES.USER_ID, userId)\n      .maybeSingle();\n\n    return empireRow || null;\n  }\n}\n\n"],"version":3}