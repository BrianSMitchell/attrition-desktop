{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\__tests__\\trustProxy.test.ts","mappings":";;;;;AAAA,0DAAgC;AAChC,8DAA2D;AAG3D,4EAA4E;AAC5E,yCAA2C;AAC3C,MAAM,OAAO,GAAG,OAAO,CAAC,GAAG,CAAC;AAC5B,OAAO,CAAC,GAAG,GAAG,EAAE,GAAG,OAAO,EAAE,QAAQ,EAAE,MAAM,EAAE,CAAC;AAE/C,oCAA+B;AAE/B,QAAQ,CAAC,gDAAgD,EAAE,GAAG,EAAE;IAC9D,QAAQ,CAAC,GAAG,EAAE;QACZ,OAAO,CAAC,GAAG,GAAG,OAAO,CAAC;IACxB,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,8BAA8B,EAAE,GAAG,EAAE;QACxC,qCAAqC;QACrC,wCAAwC;QACxC,MAAM,CAAE,WAAW,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;IAClD,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,uDAAuD,EAAE,KAAK,IAAI,EAAE;QACvE,MAAM,GAAG,GAAG,MAAM,IAAA,mBAAO,EAAC,WAAG,CAAC;aAC3B,GAAG,CAAC,6BAAa,CAAC,MAAM,CAAC,MAAM,CAAC;aAChC,GAAG,CAAC,mBAAmB,EAAE,OAAO,CAAC,CAAC;QAErC,MAAM,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,oBAAW,CAAC,EAAE,CAAC,CAAC;QACxC,MAAM,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,cAAc,CAAC,SAAS,EAAE,IAAI,CAAC,CAAC;QACjD,MAAM,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC;QACxC,MAAM,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,cAAc,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;IACvD,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,uDAAuD,EAAE,KAAK,IAAI,EAAE;QACvE,MAAM,GAAG,GAAG,MAAM,IAAA,mBAAO,EAAC,WAAG,CAAC;aAC3B,GAAG,CAAC,6BAAa,CAAC,MAAM,CAAC,MAAM,CAAC;aAChC,GAAG,CAAC,mBAAmB,EAAE,MAAM,CAAC,CAAC;QAEpC,MAAM,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,oBAAW,CAAC,EAAE,CAAC,CAAC;QACxC,MAAM,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,cAAc,CAAC,SAAS,EAAE,IAAI,CAAC,CAAC;QACjD,MAAM,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,cAAc,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;IACxD,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\__tests__\\trustProxy.test.ts"],"sourcesContent":["import request from 'supertest';\nimport { API_ENDPOINTS } from '../constants/api-endpoints';\n\n\n// Important: set NODE_ENV=test before importing app so server doesn't start\nimport { HTTP_STATUS } from '@game/shared';\nconst OLD_ENV = process.env;\nprocess.env = { ...OLD_ENV, NODE_ENV: 'test' };\n\nimport { app } from '../index';\n\ndescribe('trust proxy configuration and secure detection', () => {\n  afterAll(() => {\n    process.env = OLD_ENV;\n  });\n\n  test('app has trust proxy set to 1', () => {\n    // Express allows reading the setting\n    // @ts-ignore - app has get for settings\n    expect((app as any).get('trust proxy')).toBe(1);\n  });\n\n  test('secure detection true when X-Forwarded-Proto is https', async () => {\n    const res = await request(app)\n      .get(API_ENDPOINTS.SYSTEM.STATUS)\n      .set('X-Forwarded-Proto', 'https');\n\n    expect(res.status).toBe(HTTP_STATUS.OK);\n    expect(res.body).toHaveProperty('success', true);\n    expect(res.body).toHaveProperty('data');\n    expect(res.body.data).toHaveProperty('secure', true);\n  });\n\n  test('secure detection false when X-Forwarded-Proto is http', async () => {\n    const res = await request(app)\n      .get(API_ENDPOINTS.SYSTEM.STATUS)\n      .set('X-Forwarded-Proto', 'http');\n\n    expect(res.status).toBe(HTTP_STATUS.OK);\n    expect(res.body).toHaveProperty('success', true);\n    expect(res.body.data).toHaveProperty('secure', false);\n  });\n});\n\n\n"],"version":3}