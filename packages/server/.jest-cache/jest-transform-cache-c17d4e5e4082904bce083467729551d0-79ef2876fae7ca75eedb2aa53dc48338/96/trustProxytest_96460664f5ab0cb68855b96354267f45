08f8a71f3b5de4b152ec3315a9e65e02
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const supertest_1 = __importDefault(require("supertest"));
const api_endpoints_1 = require("../constants/api-endpoints");
// Important: set NODE_ENV=test before importing app so server doesn't start
const shared_1 = require("@game/shared");
const OLD_ENV = process.env;
process.env = { ...OLD_ENV, NODE_ENV: 'test' };
const index_1 = require("../index");
describe('trust proxy configuration and secure detection', () => {
    afterAll(() => {
        process.env = OLD_ENV;
    });
    test('app has trust proxy set to 1', () => {
        // Express allows reading the setting
        // @ts-ignore - app has get for settings
        expect(index_1.app.get('trust proxy')).toBe(1);
    });
    test('secure detection true when X-Forwarded-Proto is https', async () => {
        const res = await (0, supertest_1.default)(index_1.app)
            .get(api_endpoints_1.API_ENDPOINTS.SYSTEM.STATUS)
            .set('X-Forwarded-Proto', 'https');
        expect(res.status).toBe(shared_1.HTTP_STATUS.OK);
        expect(res.body).toHaveProperty('success', true);
        expect(res.body).toHaveProperty('data');
        expect(res.body.data).toHaveProperty('secure', true);
    });
    test('secure detection false when X-Forwarded-Proto is http', async () => {
        const res = await (0, supertest_1.default)(index_1.app)
            .get(api_endpoints_1.API_ENDPOINTS.SYSTEM.STATUS)
            .set('X-Forwarded-Proto', 'http');
        expect(res.status).toBe(shared_1.HTTP_STATUS.OK);
        expect(res.body).toHaveProperty('success', true);
        expect(res.body.data).toHaveProperty('secure', false);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFByb2plY3RzXFxBdHRyaXRpb25cXHBhY2thZ2VzXFxzZXJ2ZXJcXHNyY1xcX190ZXN0c19fXFx0cnVzdFByb3h5LnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSwwREFBZ0M7QUFDaEMsOERBQTJEO0FBRzNELDRFQUE0RTtBQUM1RSx5Q0FBMkM7QUFDM0MsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQztBQUM1QixPQUFPLENBQUMsR0FBRyxHQUFHLEVBQUUsR0FBRyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxDQUFDO0FBRS9DLG9DQUErQjtBQUUvQixRQUFRLENBQUMsZ0RBQWdELEVBQUUsR0FBRyxFQUFFO0lBQzlELFFBQVEsQ0FBQyxHQUFHLEVBQUU7UUFDWixPQUFPLENBQUMsR0FBRyxHQUFHLE9BQU8sQ0FBQztJQUN4QixDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyw4QkFBOEIsRUFBRSxHQUFHLEVBQUU7UUFDeEMscUNBQXFDO1FBQ3JDLHdDQUF3QztRQUN4QyxNQUFNLENBQUUsV0FBVyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsRCxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyx1REFBdUQsRUFBRSxLQUFLLElBQUksRUFBRTtRQUN2RSxNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUEsbUJBQU8sRUFBQyxXQUFHLENBQUM7YUFDM0IsR0FBRyxDQUFDLDZCQUFhLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQzthQUNoQyxHQUFHLENBQUMsbUJBQW1CLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFFckMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsb0JBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN4QyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLGNBQWMsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDakQsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDeEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN2RCxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyx1REFBdUQsRUFBRSxLQUFLLElBQUksRUFBRTtRQUN2RSxNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUEsbUJBQU8sRUFBQyxXQUFHLENBQUM7YUFDM0IsR0FBRyxDQUFDLDZCQUFhLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQzthQUNoQyxHQUFHLENBQUMsbUJBQW1CLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFcEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsb0JBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN4QyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLGNBQWMsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDakQsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUN4RCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxQcm9qZWN0c1xcQXR0cml0aW9uXFxwYWNrYWdlc1xcc2VydmVyXFxzcmNcXF9fdGVzdHNfX1xcdHJ1c3RQcm94eS50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByZXF1ZXN0IGZyb20gJ3N1cGVydGVzdCc7XG5pbXBvcnQgeyBBUElfRU5EUE9JTlRTIH0gZnJvbSAnLi4vY29uc3RhbnRzL2FwaS1lbmRwb2ludHMnO1xuXG5cbi8vIEltcG9ydGFudDogc2V0IE5PREVfRU5WPXRlc3QgYmVmb3JlIGltcG9ydGluZyBhcHAgc28gc2VydmVyIGRvZXNuJ3Qgc3RhcnRcbmltcG9ydCB7IEhUVFBfU1RBVFVTIH0gZnJvbSAnQGdhbWUvc2hhcmVkJztcbmNvbnN0IE9MRF9FTlYgPSBwcm9jZXNzLmVudjtcbnByb2Nlc3MuZW52ID0geyAuLi5PTERfRU5WLCBOT0RFX0VOVjogJ3Rlc3QnIH07XG5cbmltcG9ydCB7IGFwcCB9IGZyb20gJy4uL2luZGV4JztcblxuZGVzY3JpYmUoJ3RydXN0IHByb3h5IGNvbmZpZ3VyYXRpb24gYW5kIHNlY3VyZSBkZXRlY3Rpb24nLCAoKSA9PiB7XG4gIGFmdGVyQWxsKCgpID0+IHtcbiAgICBwcm9jZXNzLmVudiA9IE9MRF9FTlY7XG4gIH0pO1xuXG4gIHRlc3QoJ2FwcCBoYXMgdHJ1c3QgcHJveHkgc2V0IHRvIDEnLCAoKSA9PiB7XG4gICAgLy8gRXhwcmVzcyBhbGxvd3MgcmVhZGluZyB0aGUgc2V0dGluZ1xuICAgIC8vIEB0cy1pZ25vcmUgLSBhcHAgaGFzIGdldCBmb3Igc2V0dGluZ3NcbiAgICBleHBlY3QoKGFwcCBhcyBhbnkpLmdldCgndHJ1c3QgcHJveHknKSkudG9CZSgxKTtcbiAgfSk7XG5cbiAgdGVzdCgnc2VjdXJlIGRldGVjdGlvbiB0cnVlIHdoZW4gWC1Gb3J3YXJkZWQtUHJvdG8gaXMgaHR0cHMnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAuZ2V0KEFQSV9FTkRQT0lOVFMuU1lTVEVNLlNUQVRVUylcbiAgICAgIC5zZXQoJ1gtRm9yd2FyZGVkLVByb3RvJywgJ2h0dHBzJyk7XG5cbiAgICBleHBlY3QocmVzLnN0YXR1cykudG9CZShIVFRQX1NUQVRVUy5PSyk7XG4gICAgZXhwZWN0KHJlcy5ib2R5KS50b0hhdmVQcm9wZXJ0eSgnc3VjY2VzcycsIHRydWUpO1xuICAgIGV4cGVjdChyZXMuYm9keSkudG9IYXZlUHJvcGVydHkoJ2RhdGEnKTtcbiAgICBleHBlY3QocmVzLmJvZHkuZGF0YSkudG9IYXZlUHJvcGVydHkoJ3NlY3VyZScsIHRydWUpO1xuICB9KTtcblxuICB0ZXN0KCdzZWN1cmUgZGV0ZWN0aW9uIGZhbHNlIHdoZW4gWC1Gb3J3YXJkZWQtUHJvdG8gaXMgaHR0cCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCByZXMgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgIC5nZXQoQVBJX0VORFBPSU5UUy5TWVNURU0uU1RBVFVTKVxuICAgICAgLnNldCgnWC1Gb3J3YXJkZWQtUHJvdG8nLCAnaHR0cCcpO1xuXG4gICAgZXhwZWN0KHJlcy5zdGF0dXMpLnRvQmUoSFRUUF9TVEFUVVMuT0spO1xuICAgIGV4cGVjdChyZXMuYm9keSkudG9IYXZlUHJvcGVydHkoJ3N1Y2Nlc3MnLCB0cnVlKTtcbiAgICBleHBlY3QocmVzLmJvZHkuZGF0YSkudG9IYXZlUHJvcGVydHkoJ3NlY3VyZScsIGZhbHNlKTtcbiAgfSk7XG59KTtcblxuXG4iXSwidmVyc2lvbiI6M30=