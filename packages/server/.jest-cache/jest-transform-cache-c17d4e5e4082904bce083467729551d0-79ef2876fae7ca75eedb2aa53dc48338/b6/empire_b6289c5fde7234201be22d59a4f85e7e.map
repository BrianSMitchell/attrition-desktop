{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\routes\\game\\empire.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\routes\\game\\empire.ts"],"sourcesContent":["import { Router, Response } from 'express';\nimport { supabase } from '../../config/supabase';\nimport { ERROR_MESSAGES } from '../../constants/response-formats';\n\n// Constants imports for eliminating hardcoded values\nimport { DB_TABLES, DB_FIELDS } from '../../constants/database-fields';\nimport { HTTP_STATUS } from '@game/shared';\nimport { asyncHandler } from '../../middleware/errorHandler';\nimport { authenticate, AuthRequest } from '../../middleware/auth';\nimport { EmpireResolutionService } from '../../services/empire/EmpireResolutionService';\n\nconst router = Router();\n\nrouter.use(authenticate);\n\n/**\n * Get empire details\n */\nrouter.get('/', asyncHandler(async (req: AuthRequest, res: Response) => {\n  const user = req.user! as any;\n\n  // Resolve empire using the service\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\n\n  if (!empireRow) {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\n  }\n\n  return res.json({\n    success: true,\n    data: {\n      empire: {\n        id: empireRow.id,\n        name: empireRow.name,\n        territories: Array.isArray(empireRow.territories) ? empireRow.territories : [],\n        resources: {\n          credits: Math.max(0, Number(empireRow.credits || 0)),\n          energy: Math.max(0, Number(empireRow.energy || 0)),\n        },\n      },\n      creditsPerHour: 0, // Placeholder - implement production calculation\n      resourcesGained: 0, // Placeholder - implement resource gains\n    },\n  });\n}));\n\n/**\n * Credit transaction history for the empire\n * Supports pagination through limit parameter (?limit=50)\n */\nrouter.get('/credits/history', asyncHandler(async (req: AuthRequest, res: Response) => {\n  const limitRaw = Number(req.query.limit || 50);\n  const limit = Number.isFinite(limitRaw) ? Math.min(Math.max(1, limitRaw), 200) : 50;\n\n  const user = req.user! as any;\n\n  // Resolve empire using the service\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\n  if (!empireRow) {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\n  }\n\n  const empireId = String(empireRow.id);\n\n  // Fetch credit transactions from Supabase\n  const { data: txns, error } = await supabase\n    .from(DB_TABLES.CREDIT_TRANSACTIONS)\n    .select('id, amount, type, note, balance_after, created_at')\n    .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n    .order(DB_FIELDS.BUILDINGS.CREATED_AT, { ascending: false })\n    .limit(limit);\n\n  if (error) {\n    console.error('Error fetching credit history:', error);\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({ success: false, error: 'Failed to fetch credit history' });\n  }\n\n  return res.json({\n    success: true,\n    data: {\n      history: (txns || []).map(t => ({\n        _id: t.id,\n        amount: t.amount,\n        type: t.type,\n        note: t.note || null,\n        balanceAfter: typeof t.balance_after === 'number' ? t.balance_after : null,\n        createdAt: t.created_at,\n      }))\n    }\n  });\n}));\n\n/**\n * @deprecated Empire creation is automatic during registration\n */\nrouter.post('/', (_req: AuthRequest, res: Response) => {\n  return res.status(HTTP_STATUS.GONE).json({\n    success: false,\n    error: 'Empire creation is automatic during registration. This endpoint is deprecated.'\n  });\n});\n\n/**\n * @deprecated Manual resource updates are no longer supported\n */\nrouter.post('/update-resources', (_req: AuthRequest, res: Response) => {\n  return res.status(HTTP_STATUS.GONE).json({\n    success: false,\n    error: 'Manual resource updates are no longer supported. Resources are updated automatically.'\n  });\n});\n\nexport default router;\n\n\n\n\n\n\n\n"],"version":3}