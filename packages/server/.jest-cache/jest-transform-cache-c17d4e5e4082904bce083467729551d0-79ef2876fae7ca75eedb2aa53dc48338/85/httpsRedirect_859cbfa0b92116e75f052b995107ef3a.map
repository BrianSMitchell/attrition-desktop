{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\middleware\\httpsRedirect.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\middleware\\httpsRedirect.ts"],"sourcesContent":["import { Request, Response, NextFunction } from 'express';\nimport { isReverseProxySSL } from '../utils/runtimeEnv';\nimport { API_ENDPOINTS } from '../constants/api-endpoints';\nimport { ENV_VALUES } from '@game/shared';\n\n\nimport { HTTP_STATUS } from '@game/shared';\nimport { ENV_VARS } from '@game/shared';\n\n/**\n * HTTPS Enforcement Middleware\n * \n * Redirects all HTTP requests to HTTPS in production environments.\n * Ensures secure communication for all desktop app connections.\n * \n * Features:\n * - Production-only enforcement (allows HTTP in development)\n * - Proper redirect status codes (301 for permanent redirect)\n * - Preserves original request path and query parameters\n * - Handles reverse proxy scenarios (X-Forwarded-Proto header)\n * - Health check exemptions to avoid redirect loops\n */\n\n/**\n * Configuration for HTTPS redirect behavior\n */\ninterface HttpsRedirectConfig {\n  /** Force HTTPS even in development (default: false) */\n  forceHttps?: boolean;\n  /** Custom HTTPS port (default: 443) */\n  httpsPort?: number;\n  /** Custom hostname for redirects (default: use request hostname) */\n  hostname?: string;\n  /** Paths to exempt from HTTPS redirect (for health checks, etc.) */\n  exemptPaths?: string[];\n  /** Trust proxy headers (X-Forwarded-Proto, X-Forwarded-Host) */\n  trustProxy?: boolean;\n}\n\n/**\n * Create HTTPS redirect middleware\n * @param config Configuration options\n * @returns Express middleware function\n */\nexport function createHttpsRedirectMiddleware(config: HttpsRedirectConfig = {}) {\n  const {\n    forceHttps = false,\n    httpsPort = 443,\n    hostname,\n    exemptPaths = [API_ENDPOINTS.SYSTEM.HEALTH, API_ENDPOINTS.SYSTEM.STATUS],\n    trustProxy = true\n  } = config;\n\n  return function httpsRedirectMiddleware(req: Request, res: Response, next: NextFunction) {\n    const reverseProxy = isReverseProxySSL();\n    // Skip HTTPS enforcement in development unless explicitly forced\n    if (process.env[ENV_VARS.NODE_ENV] !== 'production' && !forceHttps) {\n      return next();\n    }\n\n    // Check if request is already secure\n    const isSecure = isRequestSecure(req, trustProxy);\n    \n    if (isSecure) {\n      // Request is already HTTPS, continue\n      return next();\n    }\n\n    // Check if this path should be exempt from HTTPS redirect\n    const isExempt = exemptPaths.some(exemptPath => {\n      if (exemptPath.endsWith('*')) {\n        return req.path.startsWith(exemptPath.slice(0, -1));\n      }\n      return req.path === exemptPath;\n    });\n\n    if (isExempt && process.env[ENV_VARS.NODE_ENV] !== 'production') {\n      // Allow HTTP for exempt paths ONLY in development\n      // In production, even exempt paths should use HTTPS\n      return next();\n    }\n\n    // Enhanced security logging for production\n    const clientInfo = {\n      ip: req.ip || req.connection.remoteAddress || 'unknown',\n      userAgent: req.get('User-Agent') || 'unknown',\n      method: req.method,\n      originalUrl: req.originalUrl,\n      timestamp: new Date().toISOString(),\n      forwardedProto: req.get('X-Forwarded-Proto') || 'none',\n      host: req.get('Host') || 'unknown'\n    };\n\n    try {\n      // Build HTTPS redirect URL\n      const redirectUrl = buildHttpsUrl(req, { hostname, httpsPort });\n      \n      // Enhanced logging based on environment\n      if (process.env[ENV_VARS.NODE_ENV] === ENV_VALUES.PRODUCTION) {\n        // Suppress noisy WARN logs for known exempt paths under reverse proxy mode\n        const shouldWarn = !(reverseProxy && isExempt);\n        if (shouldWarn) {\n          console.warn(`?? PRODUCTION HTTP?HTTPS redirect:`, {\n          ...clientInfo,\n          redirectTo: redirectUrl,\n          severity: 'WARNING',\n          message: 'Insecure HTTP request redirected to HTTPS in production'\n        });\n        } else {\n          // Downgrade to INFO for exempt health/status checks in reverse proxy mode\n          console.log(`?? PRODUCTION redirect (exempt path in reverse proxy mode): ${req.method} ${req.originalUrl} ? ${redirectUrl}`);\n        }\n      } else {\n        console.log(`?? HTTP ? HTTPS redirect: ${req.method} ${req.originalUrl} ? ${redirectUrl}`);\n      }\n\n      // Enhanced security headers for production redirects\n      const redirectHeaders: Record<string, string> = {\n        'Location': redirectUrl,\n        'Strict-Transport-Security': 'max-age=31536000; includeSubDomains; preload',\n        'Cache-Control': 'no-cache, no-store, must-revalidate, proxy-revalidate',\n        'Pragma': 'no-cache',\n        'Expires': '0'\n      };\n\n      // Add additional security headers for production\n      if (process.env[ENV_VARS.NODE_ENV] === ENV_VALUES.PRODUCTION) {\n        redirectHeaders['X-Content-Type-Options'] = 'nosniff';\n        redirectHeaders['X-Frame-Options'] = 'DENY';\n        redirectHeaders['X-XSS-Protection'] = '1; mode=block';\n        redirectHeaders['Referrer-Policy'] = 'strict-origin-when-cross-origin';\n      }\n\n      // Perform the redirect with enhanced headers\n      res.status(HTTP_STATUS.MOVED_PERMANENTLY).set(redirectHeaders).end();\n      \n    } catch (error) {\n      // Error handling for redirect failures\n      const errorMessage = error instanceof Error ? error.message : 'Unknown redirect error';\n      \n      console.error(`? HTTPS redirect failed:`, {\n        ...clientInfo,\n        error: errorMessage,\n        severity: 'ERROR'\n      });\n      \n      // In production, fail securely - don't allow HTTP fallback\n      if (process.env[ENV_VARS.NODE_ENV] === ENV_VALUES.PRODUCTION) {\n        res.status(HTTP_STATUS.UPGRADE_REQUIRED)\n          .set({\n            'Content-Type': 'application/json',\n            'Strict-Transport-Security': 'max-age=31536000; includeSubDomains; preload',\n            'X-Content-Type-Options': 'nosniff',\n            'X-Frame-Options': 'DENY'\n          })\n          .json({\n            success: false,\n            error: 'HTTPS Required',\n            message: 'This service requires HTTPS. Please use https:// instead of http://',\n            code: 'HTTPS_REQUIRED'\n          });\n        return;\n      }\n      \n      // In development, log error but continue\n      console.warn('??  HTTPS redirect failed in development, continuing with HTTP');\n      next();\n    }\n  };\n}\n\n/**\n * Determine if a request is secure (HTTPS)\n * @param req Express request object\n * @param trustProxy Whether to trust proxy headers\n * @returns True if the request is secure\n */\nfunction isRequestSecure(req: Request, trustProxy: boolean): boolean {\n  // Direct HTTPS connection\n  if (req.secure) {\n    return true;\n  }\n\n  // Check for secure connection via protocol property\n  if (req.protocol === 'https') {\n    return true;\n  }\n\n  if (!trustProxy) {\n    return false;\n  }\n\n  // Check proxy headers (common in production deployments)\n  const forwardedProto = req.get('X-Forwarded-Proto');\n  if (forwardedProto === 'https') {\n    return true;\n  }\n\n  // Check for CloudFlare's custom header\n  const cfVisitorHeader = req.get('CF-Visitor');\n  if (cfVisitorHeader) {\n    try {\n      const cfVisitor = JSON.parse(cfVisitorHeader);\n      if (cfVisitor.scheme === 'https') {\n        return true;\n      }\n    } catch {\n      // Ignore malformed CF-Visitor header\n    }\n  }\n\n  // Check for Azure Front Door header\n  if (req.get('X-Forwarded-Proto') === 'https' || req.get('X-Azure-HTTPS') === 'on') {\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * Build the HTTPS redirect URL\n * @param req Express request object\n * @param options Configuration options\n * @returns Complete HTTPS URL for redirect\n */\nfunction buildHttpsUrl(req: Request, options: { hostname?: string; httpsPort?: number }): string {\n  const { hostname, httpsPort = 443 } = options;\n  \n  // Use custom hostname or extract from request\n  const host = hostname || req.get('Host') || req.hostname || 'localhost';\n  \n  // Remove any existing port from hostname\n  const cleanHostname = host.split(':')[0];\n  \n  // Build the URL\n  let httpsUrl = `https://${cleanHostname}`;\n  \n  // Add port if not default HTTPS port\n  if (httpsPort !== 443) {\n    httpsUrl += `:${httpsPort}`;\n  }\n  \n  // Add original path and query string\n  httpsUrl += req.originalUrl;\n  \n  return httpsUrl;\n}\n\n/**\n * Express middleware to enforce HTTPS in production\n * Simple version with default configuration\n */\nexport const httpsRedirectMiddleware = createHttpsRedirectMiddleware();\n\n/**\n * Strict HTTPS enforcement middleware that also works in development\n * Use this for testing HTTPS redirect behavior\n */\nexport const strictHttpsMiddleware = createHttpsRedirectMiddleware({\n  forceHttps: true,\n  exemptPaths: [API_ENDPOINTS.SYSTEM.HEALTH, API_ENDPOINTS.SYSTEM.STATUS, '/test-http']\n});\n\n/**\n * Middleware to set secure headers for HTTPS responses\n * Should be used after HTTPS redirect to set additional security headers\n */\nexport function httpsSecurityHeadersMiddleware(req: Request, res: Response, next: NextFunction) {\n  // Only apply to HTTPS requests\n  if (!isRequestSecure(req, true)) {\n    return next();\n  }\n\n  // Set security headers for HTTPS responses\n  res.set({\n    'Strict-Transport-Security': 'max-age=31536000; includeSubDomains; preload',\n    'Secure': 'true'\n  });\n\n  next();\n}\n\nexport default {\n  createHttpsRedirectMiddleware,\n  httpsRedirectMiddleware,\n  strictHttpsMiddleware,\n  httpsSecurityHeadersMiddleware\n};\n\n\n\n"],"version":3}