900c879ff211e11d8acb52b82b288267
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const auth_1 = require("../../../middleware/auth");
const errorHandler_1 = require("../../../middleware/errorHandler");
const response_formats_1 = require("../../../constants/response-formats");
const api_endpoints_1 = require("../../../constants/api-endpoints");
const database_fields_1 = require("../../../constants/database-fields");
const supabase_1 = require("../../../config/supabase");
const EmpireResolutionService_1 = require("../../../services/empire/EmpireResolutionService");
const shared_1 = require("@game/shared");
const TechService_1 = require("../../../services/tech/TechService");
const router = (0, express_1.Router)();
// All game routes require authentication
router.use(auth_1.authenticate);
// Get technology catalog
router.get('/catalog', (0, errorHandler_1.asyncHandler)(async (_req, res) => {
    const catalog = (0, shared_1.getTechnologyList)();
    res.json({
        success: true,
        data: { catalog }
    });
}));
// Get tech status for a specific base (labs, eligibility, credits)
router.get(api_endpoints_1.API_ENDPOINTS.SYSTEM.STATUS, (0, errorHandler_1.asyncHandler)(async (req, res) => {
    const user = req.user;
    const baseCoord = String(req.query.base || '').trim();
    if (!baseCoord)
        return res.status(response_formats_1.HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'Missing base coordinate (?base=...)' });
    // Resolve empire using established pattern (FR-14)
    const empireRow = await EmpireResolutionService_1.EmpireResolutionService.resolveEmpireByUserObject(user);
    if (!empireRow) {
        return res.status(response_formats_1.HTTP_STATUS.NOT_FOUND).json({ success: false, error: response_formats_1.ERROR_MESSAGES.EMPIRE_NOT_FOUND });
    }
    const empireId = String(empireRow.id);
    const userId = user._id || user.id; // Still needed for TechService
    const status = await TechService_1.TechService.getStatus(userId, empireId, baseCoord);
    res.json({
        success: true,
        data: { status }
    });
}));
// Start technology research with capacity-driven ETA
router.post('/start', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    const user = req.user;
    const { locationCoord, techKey } = req.body;
    if (!locationCoord || !techKey) {
        return res.status(response_formats_1.HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'locationCoord and techKey are required' });
    }
    // Resolve empire using established pattern (FR-14)
    const empireRow = await EmpireResolutionService_1.EmpireResolutionService.resolveEmpireByUserObject(user);
    if (!empireRow) {
        return res.status(response_formats_1.HTTP_STATUS.NOT_FOUND).json({ success: false, error: response_formats_1.ERROR_MESSAGES.EMPIRE_NOT_FOUND });
    }
    const empireId = String(empireRow.id);
    const userId = user._id || user.id; // Still needed for TechService
    const result = await TechService_1.TechService.start(userId, empireId, locationCoord, techKey);
    if (!result.success) {
        const statusCode = result.code === 'ALREADY_IN_PROGRESS' ? 409 : response_formats_1.HTTP_STATUS.BAD_REQUEST;
        return res.status(statusCode).json({
            success: false,
            error: result.error || 'Failed to start research'
        });
    }
    return res.json({ success: true, data: result.data, message: result.message });
}));
// Get research queue
router.get('/queue', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    const user = req.user;
    const base = String(req.query.base || '').trim();
    // Resolve empire using established pattern (FR-14)
    const empireRow = await EmpireResolutionService_1.EmpireResolutionService.resolveEmpireByUserObject(user);
    if (!empireRow) {
        return res.status(response_formats_1.HTTP_STATUS.NOT_FOUND).json({ success: false, error: response_formats_1.ERROR_MESSAGES.EMPIRE_NOT_FOUND });
    }
    const empireId = String(empireRow.id);
    const queue = await TechService_1.TechService.getQueue(empireId, base || undefined);
    return res.json({ success: true, data: { queue } });
}));
// Cancel a pending technology research queue item
router.delete('/queue/:id', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    const user = req.user;
    // Resolve empire using established pattern (FR-14)
    const empireRow = await EmpireResolutionService_1.EmpireResolutionService.resolveEmpireByUserObject(user);
    if (!empireRow) {
        return res.status(response_formats_1.HTTP_STATUS.NOT_FOUND).json({ success: false, error: response_formats_1.ERROR_MESSAGES.EMPIRE_NOT_FOUND });
    }
    const empireId = String(empireRow.id);
    const id = String(req.params.id || '').trim();
    if (!id)
        return res.status(response_formats_1.HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'Invalid queue item id' });
    // Fetch the queue item
    const { data: qItem, error: fetchError } = await supabase_1.supabase
        .from(database_fields_1.DB_TABLES.TECH_QUEUE)
        .select('id, empire_id, tech_key, level, status, location_coord')
        .eq(database_fields_1.DB_FIELDS.BUILDINGS.ID, id)
        .maybeSingle();
    if (fetchError) {
        console.error('[tech/queue/:id DELETE] Error fetching item:', fetchError);
        return res.status(response_formats_1.HTTP_STATUS.INTERNAL_SERVER_ERROR).json({ success: false, error: 'Error fetching queue item' });
    }
    if (!qItem || String(qItem.empire_id) !== empireId) {
        return res.status(response_formats_1.HTTP_STATUS.NOT_FOUND).json({ success: false, error: response_formats_1.ERROR_MESSAGES.QUEUE_ITEM_NOT_FOUND });
    }
    if (String(qItem.status || '') !== 'pending') {
        return res.status(response_formats_1.HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'Only pending items can be cancelled' });
    }
    // Calculate refund
    let refundedCredits = null;
    try {
        const techKey = String(qItem.tech_key || '');
        const level = Math.max(1, Number(qItem.level || 1));
        const spec = (0, shared_1.getTechSpec)(techKey);
        // Cost function for tech handled by service
        refundedCredits = await TechService_1.TechService.getRefundCredits(spec, level);
        // Update empire credits
        const { data: empire } = await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.EMPIRES)
            .select(database_fields_1.DB_FIELDS.EMPIRES.CREDITS)
            .eq(database_fields_1.DB_FIELDS.BUILDINGS.ID, empireId)
            .single();
        if (empire && refundedCredits) {
            const currentCredits = Number(empire.credits || 0);
            await supabase_1.supabase
                .from(database_fields_1.DB_TABLES.EMPIRES)
                .update({ credits: currentCredits + refundedCredits })
                .eq(database_fields_1.DB_FIELDS.BUILDINGS.ID, empireId);
        }
    }
    catch {
        // If refund calculation fails, still proceed with cancellation
        console.warn('[tech/queue/:id DELETE] Refund calculation failed');
    }
    // Update status to cancelled
    const { error: updateError } = await supabase_1.supabase
        .from(database_fields_1.DB_TABLES.TECH_QUEUE)
        .update({ status: 'cancelled' })
        .eq(database_fields_1.DB_FIELDS.BUILDINGS.ID, id);
    if (updateError) {
        console.error('[tech/queue/:id DELETE] Error cancelling item:', updateError);
        return res.status(response_formats_1.HTTP_STATUS.INTERNAL_SERVER_ERROR).json({ success: false, error: 'Failed to cancel queue item' });
    }
    return res.json({
        success: true,
        data: { cancelledId: id, refundedCredits },
        message: 'Research queue item cancelled'
    });
}));
exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFByb2plY3RzXFxBdHRyaXRpb25cXHBhY2thZ2VzXFxzZXJ2ZXJcXHNyY1xccm91dGVzXFxnYW1lXFx0ZWNoXFxpbmRleC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLHFDQUEyQztBQUMzQyxtREFBcUU7QUFDckUsbUVBQWdFO0FBQ2hFLDBFQUFrRjtBQUNsRixvRUFBaUU7QUFDakUsd0VBQTBFO0FBQzFFLHVEQUFvRDtBQUNwRCw4RkFBMkY7QUFDM0YseUNBQTZFO0FBQzdFLG9FQUFpRTtBQUVqRSxNQUFNLE1BQU0sR0FBVyxJQUFBLGdCQUFNLEdBQUUsQ0FBQztBQUVoQyx5Q0FBeUM7QUFDekMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxtQkFBWSxDQUFDLENBQUM7QUFFekIseUJBQXlCO0FBQ3pCLE1BQU0sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLElBQUEsMkJBQVksRUFBQyxLQUFLLEVBQUUsSUFBaUIsRUFBRSxHQUFhLEVBQUUsRUFBRTtJQUM3RSxNQUFNLE9BQU8sR0FBRyxJQUFBLDBCQUFpQixHQUFFLENBQUM7SUFDcEMsR0FBRyxDQUFDLElBQUksQ0FBQztRQUNQLE9BQU8sRUFBRSxJQUFJO1FBQ2IsSUFBSSxFQUFFLEVBQUUsT0FBTyxFQUFFO0tBQ2xCLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFFSixtRUFBbUU7QUFDbkUsTUFBTSxDQUFDLEdBQUcsQ0FBQyw2QkFBYSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsSUFBQSwyQkFBWSxFQUFDLEtBQUssRUFBRSxHQUFnQixFQUFFLEdBQWEsRUFBRSxFQUFFO0lBQzdGLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFZLENBQUM7SUFDOUIsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3RELElBQUksQ0FBQyxTQUFTO1FBQUUsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLDhCQUFXLENB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QyxTQUFTLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBRWxDLElBQUksV0FBVyxFQUFFLENBQUM7UUFDaEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxnREFBZ0QsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUM3RSxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsOEJBQVcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLDZCQUE2QixFQUFFLENBQUMsQ0FBQztJQUN0SCxDQUFDO0lBRUQsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQ2QsT0FBTyxFQUFFLElBQUk7UUFDYixJQUFJLEVBQUUsRUFBRSxXQUFXLEVBQUUsRUFBRSxFQUFFLGVBQWUsRUFBRTtRQUMxQyxPQUFPLEVBQUUsK0JBQStCO0tBQ3pDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFFSixrQkFBZSxNQUFNLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFByb2plY3RzXFxBdHRyaXRpb25cXHBhY2thZ2VzXFxzZXJ2ZXJcXHNyY1xccm91dGVzXFxnYW1lXFx0ZWNoXFxpbmRleC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSb3V0ZXIsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBBdXRoUmVxdWVzdCwgYXV0aGVudGljYXRlIH0gZnJvbSAnLi4vLi4vLi4vbWlkZGxld2FyZS9hdXRoJztcbmltcG9ydCB7IGFzeW5jSGFuZGxlciB9IGZyb20gJy4uLy4uLy4uL21pZGRsZXdhcmUvZXJyb3JIYW5kbGVyJztcbmltcG9ydCB7IEhUVFBfU1RBVFVTLCBFUlJPUl9NRVNTQUdFUyB9IGZyb20gJy4uLy4uLy4uL2NvbnN0YW50cy9yZXNwb25zZS1mb3JtYXRzJztcbmltcG9ydCB7IEFQSV9FTkRQT0lOVFMgfSBmcm9tICcuLi8uLi8uLi9jb25zdGFudHMvYXBpLWVuZHBvaW50cyc7XG5pbXBvcnQgeyBEQl9UQUJMRVMsIERCX0ZJRUxEUyB9IGZyb20gJy4uLy4uLy4uL2NvbnN0YW50cy9kYXRhYmFzZS1maWVsZHMnO1xuaW1wb3J0IHsgc3VwYWJhc2UgfSBmcm9tICcuLi8uLi8uLi9jb25maWcvc3VwYWJhc2UnO1xuaW1wb3J0IHsgRW1waXJlUmVzb2x1dGlvblNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlcy9lbXBpcmUvRW1waXJlUmVzb2x1dGlvblNlcnZpY2UnO1xuaW1wb3J0IHsgZ2V0VGVjaFNwZWMsIGdldFRlY2hub2xvZ3lMaXN0LCBUZWNobm9sb2d5S2V5IH0gZnJvbSAnQGdhbWUvc2hhcmVkJztcbmltcG9ydCB7IFRlY2hTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc2VydmljZXMvdGVjaC9UZWNoU2VydmljZSc7XG5cbmNvbnN0IHJvdXRlcjogUm91dGVyID0gUm91dGVyKCk7XG5cbi8vIEFsbCBnYW1lIHJvdXRlcyByZXF1aXJlIGF1dGhlbnRpY2F0aW9uXG5yb3V0ZXIudXNlKGF1dGhlbnRpY2F0ZSk7XG5cbi8vIEdldCB0ZWNobm9sb2d5IGNhdGFsb2dcbnJvdXRlci5nZXQoJy9jYXRhbG9nJywgYXN5bmNIYW5kbGVyKGFzeW5jIChfcmVxOiBBdXRoUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICBjb25zdCBjYXRhbG9nID0gZ2V0VGVjaG5vbG9neUxpc3QoKTtcbiAgcmVzLmpzb24oe1xuICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgZGF0YTogeyBjYXRhbG9nIH1cbiAgfSk7XG59KSk7XG5cbi8vIEdldCB0ZWNoIHN0YXR1cyBmb3IgYSBzcGVjaWZpYyBiYXNlIChsYWJzLCBlbGlnaWJpbGl0eSwgY3JlZGl0cylcbnJvdXRlci5nZXQoQVBJX0VORFBPSU5UUy5TWVNURU0uU1RBVFVTLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcTogQXV0aFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgY29uc3QgdXNlciA9IHJlcS51c2VyISBhcyBhbnk7XG4gIGNvbnN0IGJhc2VDb29yZCA9IFN0cmluZyhyZXEucXVlcnkuYmFzZSB8fCAnJykudHJpbSgpO1xuICBpZiAoIWJhc2VDb29yZCkgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuQkFEX1JFUVVFU1QpLmpzb24oeyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICdNaXNzaW5nIGJhc2UgY29vcmRpbmF0ZSAoP2Jhc2U9Li4uKScgfSk7XG5cbiAgLy8gUmVzb2x2ZSBlbXBpcmUgdXNpbmcgZXN0YWJsaXNoZWQgcGF0dGVybiAoRlItMTQpXG4gIGNvbnN0IGVtcGlyZVJvdyA9IGF3YWl0IEVtcGlyZVJlc29sdXRpb25TZXJ2aWNlLnJlc29sdmVFbXBpcmVCeVVzZXJPYmplY3QodXNlcik7XG4gIGlmICghZW1waXJlUm93KSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuTk9UX0ZPVU5EKS5qc29uKHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBFUlJPUl9NRVNTQUdFUy5FTVBJUkVfTk9UX0ZPVU5EIH0pO1xuICB9XG5cbiAgY29uc3QgZW1waXJlSWQgPSBTdHJpbmcoZW1waXJlUm93LmlkKTtcbiAgY29uc3QgdXNlcklkID0gdXNlci5faWQgfHwgdXNlci5pZDsgLy8gU3RpbGwgbmVlZGVkIGZvciBUZWNoU2VydmljZVxuXG4gIGNvbnN0IHN0YXR1cyA9IGF3YWl0IFRlY2hTZXJ2aWNlLmdldFN0YXR1cyh1c2VySWQsIGVtcGlyZUlkLCBiYXNlQ29vcmQpO1xuICByZXMuanNvbih7XG4gICAgc3VjY2VzczogdHJ1ZSxcbiAgICBkYXRhOiB7IHN0YXR1cyB9XG4gIH0pO1xufSkpO1xuXG4vLyBTdGFydCB0ZWNobm9sb2d5IHJlc2VhcmNoIHdpdGggY2FwYWNpdHktZHJpdmVuIEVUQVxucm91dGVyLnBvc3QoJy9zdGFydCcsIGFzeW5jSGFuZGxlcihhc3luYyAocmVxOiBBdXRoUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICBjb25zdCB1c2VyID0gcmVxLnVzZXIhIGFzIGFueTtcbiAgY29uc3QgeyBsb2NhdGlvbkNvb3JkLCB0ZWNoS2V5IH0gPSByZXEuYm9keSBhcyB7IGxvY2F0aW9uQ29vcmQ/OiBzdHJpbmc7IHRlY2hLZXk/OiBUZWNobm9sb2d5S2V5IH07XG4gIGlmICghbG9jYXRpb25Db29yZCB8fCAhdGVjaEtleSkge1xuICAgIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLkJBRF9SRVFVRVNUKS5qc29uKHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnbG9jYXRpb25Db29yZCBhbmQgdGVjaEtleSBhcmUgcmVxdWlyZWQnIH0pO1xuICB9XG5cbiAgLy8gUmVzb2x2ZSBlbXBpcmUgdXNpbmcgZXN0YWJsaXNoZWQgcGF0dGVybiAoRlItMTQpXG4gIGNvbnN0IGVtcGlyZVJvdyA9IGF3YWl0IEVtcGlyZVJlc29sdXRpb25TZXJ2aWNlLnJlc29sdmVFbXBpcmVCeVVzZXJPYmplY3QodXNlcik7XG4gIGlmICghZW1waXJlUm93KSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuTk9UX0ZPVU5EKS5qc29uKHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBFUlJPUl9NRVNTQUdFUy5FTVBJUkVfTk9UX0ZPVU5EIH0pO1xuICB9XG5cbiAgY29uc3QgZW1waXJlSWQgPSBTdHJpbmcoZW1waXJlUm93LmlkKTtcbiAgY29uc3QgdXNlcklkID0gdXNlci5faWQgfHwgdXNlci5pZDsgLy8gU3RpbGwgbmVlZGVkIGZvciBUZWNoU2VydmljZVxuXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFRlY2hTZXJ2aWNlLnN0YXJ0KHVzZXJJZCwgZW1waXJlSWQsIGxvY2F0aW9uQ29vcmQsIHRlY2hLZXkgYXMgYW55KTtcbiAgaWYgKCFyZXN1bHQuc3VjY2Vzcykge1xuICAgIGNvbnN0IHN0YXR1c0NvZGUgPSAocmVzdWx0IGFzIGFueSkuY29kZSA9PT0gJ0FMUkVBRFlfSU5fUFJPR1JFU1MnID8gNDA5IDogSFRUUF9TVEFUVVMuQkFEX1JFUVVFU1Q7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoc3RhdHVzQ29kZSkuanNvbih7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIGVycm9yOiAocmVzdWx0IGFzIGFueSkuZXJyb3IgfHwgJ0ZhaWxlZCB0byBzdGFydCByZXNlYXJjaCdcbiAgICB9KTtcbiAgfVxuICByZXR1cm4gcmVzLmpzb24oeyBzdWNjZXNzOiB0cnVlLCBkYXRhOiAocmVzdWx0IGFzIGFueSkuZGF0YSwgbWVzc2FnZTogKHJlc3VsdCBhcyBhbnkpLm1lc3NhZ2UgfSk7XG59KSk7XG5cbi8vIEdldCByZXNlYXJjaCBxdWV1ZVxucm91dGVyLmdldCgnL3F1ZXVlJywgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXE6IEF1dGhSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIGNvbnN0IHVzZXIgPSByZXEudXNlciEgYXMgYW55O1xuICBjb25zdCBiYXNlID0gU3RyaW5nKHJlcS5xdWVyeS5iYXNlIHx8ICcnKS50cmltKCk7XG5cbiAgLy8gUmVzb2x2ZSBlbXBpcmUgdXNpbmcgZXN0YWJsaXNoZWQgcGF0dGVybiAoRlItMTQpXG4gIGNvbnN0IGVtcGlyZVJvdyA9IGF3YWl0IEVtcGlyZVJlc29sdXRpb25TZXJ2aWNlLnJlc29sdmVFbXBpcmVCeVVzZXJPYmplY3QodXNlcik7XG4gIGlmICghZW1waXJlUm93KSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuTk9UX0ZPVU5EKS5qc29uKHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBFUlJPUl9NRVNTQUdFUy5FTVBJUkVfTk9UX0ZPVU5EIH0pO1xuICB9XG5cbiAgY29uc3QgZW1waXJlSWQgPSBTdHJpbmcoZW1waXJlUm93LmlkKTtcblxuICBjb25zdCBxdWV1ZSA9IGF3YWl0IFRlY2hTZXJ2aWNlLmdldFF1ZXVlKGVtcGlyZUlkLCBiYXNlIHx8IHVuZGVmaW5lZCk7XG4gIHJldHVybiByZXMuanNvbih7IHN1Y2Nlc3M6IHRydWUsIGRhdGE6IHsgcXVldWUgfSB9KTtcbn0pKTtcblxuLy8gQ2FuY2VsIGEgcGVuZGluZyB0ZWNobm9sb2d5IHJlc2VhcmNoIHF1ZXVlIGl0ZW1cbnJvdXRlci5kZWxldGUoJy9xdWV1ZS86aWQnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcTogQXV0aFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgY29uc3QgdXNlciA9IHJlcS51c2VyISBhcyBhbnk7XG5cbiAgLy8gUmVzb2x2ZSBlbXBpcmUgdXNpbmcgZXN0YWJsaXNoZWQgcGF0dGVybiAoRlItMTQpXG4gIGNvbnN0IGVtcGlyZVJvdyA9IGF3YWl0IEVtcGlyZVJlc29sdXRpb25TZXJ2aWNlLnJlc29sdmVFbXBpcmVCeVVzZXJPYmplY3QodXNlcik7XG4gIGlmICghZW1waXJlUm93KSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuTk9UX0ZPVU5EKS5qc29uKHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBFUlJPUl9NRVNTQUdFUy5FTVBJUkVfTk9UX0ZPVU5EIH0pO1xuICB9XG5cbiAgY29uc3QgZW1waXJlSWQgPSBTdHJpbmcoZW1waXJlUm93LmlkKTtcblxuICBjb25zdCBpZCA9IFN0cmluZyhyZXEucGFyYW1zLmlkIHx8ICcnKS50cmltKCk7XG4gIGlmICghaWQpIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLkJBRF9SRVFVRVNUKS5qc29uKHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnSW52YWxpZCBxdWV1ZSBpdGVtIGlkJyB9KTtcblxuICAvLyBGZXRjaCB0aGUgcXVldWUgaXRlbVxuICBjb25zdCB7IGRhdGE6IHFJdGVtLCBlcnJvcjogZmV0Y2hFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcbiAgICAuZnJvbShEQl9UQUJMRVMuVEVDSF9RVUVVRSlcbiAgICAuc2VsZWN0KCdpZCwgZW1waXJlX2lkLCB0ZWNoX2tleSwgbGV2ZWwsIHN0YXR1cywgbG9jYXRpb25fY29vcmQnKVxuICAgIC5lcShEQl9GSUVMRFMuQlVJTERJTkdTLklELCBpZClcbiAgICAubWF5YmVTaW5nbGUoKTtcblxuICBpZiAoZmV0Y2hFcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ1t0ZWNoL3F1ZXVlLzppZCBERUxFVEVdIEVycm9yIGZldGNoaW5nIGl0ZW06JywgZmV0Y2hFcnJvcik7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuSU5URVJOQUxfU0VSVkVSX0VSUk9SKS5qc29uKHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnRXJyb3IgZmV0Y2hpbmcgcXVldWUgaXRlbScgfSk7XG4gIH1cblxuICBpZiAoIXFJdGVtIHx8IFN0cmluZygocUl0ZW0gYXMgYW55KS5lbXBpcmVfaWQpICE9PSBlbXBpcmVJZCkge1xuICAgIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLk5PVF9GT1VORCkuanNvbih7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogRVJST1JfTUVTU0FHRVMuUVVFVUVfSVRFTV9OT1RfRk9VTkQgfSk7XG4gIH1cblxuICBpZiAoU3RyaW5nKChxSXRlbSBhcyBhbnkpLnN0YXR1cyB8fCAnJykgIT09ICdwZW5kaW5nJykge1xuICAgIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLkJBRF9SRVFVRVNUKS5qc29uKHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnT25seSBwZW5kaW5nIGl0ZW1zIGNhbiBiZSBjYW5jZWxsZWQnIH0pO1xuICB9XG5cbiAgLy8gQ2FsY3VsYXRlIHJlZnVuZFxuICBsZXQgcmVmdW5kZWRDcmVkaXRzOiBudW1iZXIgfCBudWxsID0gbnVsbDtcbiAgdHJ5IHtcbiAgICBjb25zdCB0ZWNoS2V5ID0gU3RyaW5nKChxSXRlbSBhcyBhbnkpLnRlY2hfa2V5IHx8ICcnKTtcbiAgICBjb25zdCBsZXZlbCA9IE1hdGgubWF4KDEsIE51bWJlcigocUl0ZW0gYXMgYW55KS5sZXZlbCB8fCAxKSk7XG4gICAgY29uc3Qgc3BlYyA9IGdldFRlY2hTcGVjKHRlY2hLZXkgYXMgVGVjaG5vbG9neUtleSk7XG4gICAgLy8gQ29zdCBmdW5jdGlvbiBmb3IgdGVjaCBoYW5kbGVkIGJ5IHNlcnZpY2VcbiAgICByZWZ1bmRlZENyZWRpdHMgPSBhd2FpdCBUZWNoU2VydmljZS5nZXRSZWZ1bmRDcmVkaXRzKHNwZWMsIGxldmVsKTtcblxuICAgIC8vIFVwZGF0ZSBlbXBpcmUgY3JlZGl0c1xuICAgIGNvbnN0IHsgZGF0YTogZW1waXJlIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgLmZyb20oREJfVEFCTEVTLkVNUElSRVMpXG4gICAgICAuc2VsZWN0KERCX0ZJRUxEUy5FTVBJUkVTLkNSRURJVFMpXG4gICAgICAuZXEoREJfRklFTERTLkJVSUxESU5HUy5JRCwgZW1waXJlSWQpXG4gICAgICAuc2luZ2xlKCk7XG5cbiAgICBpZiAoZW1waXJlICYmIHJlZnVuZGVkQ3JlZGl0cykge1xuICAgICAgY29uc3QgY3VycmVudENyZWRpdHMgPSBOdW1iZXIoZW1waXJlLmNyZWRpdHMgfHwgMCk7XG4gICAgICBhd2FpdCBzdXBhYmFzZVxuICAgICAgICAuZnJvbShEQl9UQUJMRVMuRU1QSVJFUylcbiAgICAgICAgLnVwZGF0ZSh7IGNyZWRpdHM6IGN1cnJlbnRDcmVkaXRzICsgcmVmdW5kZWRDcmVkaXRzIH0pXG4gICAgICAgIC5lcShEQl9GSUVMRFMuQlVJTERJTkdTLklELCBlbXBpcmVJZCk7XG4gICAgfVxuICB9IGNhdGNoIHtcbiAgICAvLyBJZiByZWZ1bmQgY2FsY3VsYXRpb24gZmFpbHMsIHN0aWxsIHByb2NlZWQgd2l0aCBjYW5jZWxsYXRpb25cbiAgICBjb25zb2xlLndhcm4oJ1t0ZWNoL3F1ZXVlLzppZCBERUxFVEVdIFJlZnVuZCBjYWxjdWxhdGlvbiBmYWlsZWQnKTtcbiAgfVxuXG4gIC8vIFVwZGF0ZSBzdGF0dXMgdG8gY2FuY2VsbGVkXG4gIGNvbnN0IHsgZXJyb3I6IHVwZGF0ZUVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgIC5mcm9tKERCX1RBQkxFUy5URUNIX1FVRVVFKVxuICAgIC51cGRhdGUoeyBzdGF0dXM6ICdjYW5jZWxsZWQnIH0pXG4gICAgLmVxKERCX0ZJRUxEUy5CVUlMRElOR1MuSUQsIGlkKTtcblxuICBpZiAodXBkYXRlRXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdbdGVjaC9xdWV1ZS86aWQgREVMRVRFXSBFcnJvciBjYW5jZWxsaW5nIGl0ZW06JywgdXBkYXRlRXJyb3IpO1xuICAgIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLklOVEVSTkFMX1NFUlZFUl9FUlJPUikuanNvbih7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ0ZhaWxlZCB0byBjYW5jZWwgcXVldWUgaXRlbScgfSk7XG4gIH1cblxuICByZXR1cm4gcmVzLmpzb24oe1xuICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgZGF0YTogeyBjYW5jZWxsZWRJZDogaWQsIHJlZnVuZGVkQ3JlZGl0cyB9LFxuICAgIG1lc3NhZ2U6ICdSZXNlYXJjaCBxdWV1ZSBpdGVtIGNhbmNlbGxlZCdcbiAgfSk7XG59KSk7XG5cbmV4cG9ydCBkZWZhdWx0IHJvdXRlcjtcblxuXG5cblxuXG5cblxuXG4iXSwidmVyc2lvbiI6M30=