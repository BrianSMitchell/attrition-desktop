{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\routes\\game\\tech\\index.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\routes\\game\\tech\\index.ts"],"sourcesContent":["import { Router, Response } from 'express';\nimport { AuthRequest, authenticate } from '../../../middleware/auth';\nimport { asyncHandler } from '../../../middleware/errorHandler';\nimport { HTTP_STATUS, ERROR_MESSAGES } from '../../../constants/response-formats';\nimport { API_ENDPOINTS } from '../../../constants/api-endpoints';\nimport { DB_TABLES, DB_FIELDS } from '../../../constants/database-fields';\nimport { supabase } from '../../../config/supabase';\nimport { EmpireResolutionService } from '../../../services/empire/EmpireResolutionService';\nimport { getTechSpec, getTechnologyList, TechnologyKey } from '@game/shared';\nimport { TechService } from '../../../services/tech/TechService';\n\nconst router: Router = Router();\n\n// All game routes require authentication\nrouter.use(authenticate);\n\n// Get technology catalog\nrouter.get('/catalog', asyncHandler(async (_req: AuthRequest, res: Response) => {\n  const catalog = getTechnologyList();\n  res.json({\n    success: true,\n    data: { catalog }\n  });\n}));\n\n// Get tech status for a specific base (labs, eligibility, credits)\nrouter.get(API_ENDPOINTS.SYSTEM.STATUS, asyncHandler(async (req: AuthRequest, res: Response) => {\n  const user = req.user! as any;\n  const baseCoord = String(req.query.base || '').trim();\n  if (!baseCoord) return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'Missing base coordinate (?base=...)' });\n\n  // Resolve empire using established pattern (FR-14)\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\n  if (!empireRow) {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\n  }\n\n  const empireId = String(empireRow.id);\n  const userId = user._id || user.id; // Still needed for TechService\n\n  const status = await TechService.getStatus(userId, empireId, baseCoord);\n  res.json({\n    success: true,\n    data: { status }\n  });\n}));\n\n// Start technology research with capacity-driven ETA\nrouter.post('/start', asyncHandler(async (req: AuthRequest, res: Response) => {\n  const user = req.user! as any;\n  const { locationCoord, techKey } = req.body as { locationCoord?: string; techKey?: TechnologyKey };\n  if (!locationCoord || !techKey) {\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'locationCoord and techKey are required' });\n  }\n\n  // Resolve empire using established pattern (FR-14)\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\n  if (!empireRow) {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\n  }\n\n  const empireId = String(empireRow.id);\n  const userId = user._id || user.id; // Still needed for TechService\n\n  const result = await TechService.start(userId, empireId, locationCoord, techKey as any);\n  if (!result.success) {\n    const statusCode = (result as any).code === 'ALREADY_IN_PROGRESS' ? 409 : HTTP_STATUS.BAD_REQUEST;\n    return res.status(statusCode).json({\n      success: false,\n      error: (result as any).error || 'Failed to start research'\n    });\n  }\n  return res.json({ success: true, data: (result as any).data, message: (result as any).message });\n}));\n\n// Get research queue\nrouter.get('/queue', asyncHandler(async (req: AuthRequest, res: Response) => {\n  const user = req.user! as any;\n  const base = String(req.query.base || '').trim();\n\n  // Resolve empire using established pattern (FR-14)\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\n  if (!empireRow) {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\n  }\n\n  const empireId = String(empireRow.id);\n\n  const queue = await TechService.getQueue(empireId, base || undefined);\n  return res.json({ success: true, data: { queue } });\n}));\n\n// Cancel a pending technology research queue item\nrouter.delete('/queue/:id', asyncHandler(async (req: AuthRequest, res: Response) => {\n  const user = req.user! as any;\n\n  // Resolve empire using established pattern (FR-14)\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\n  if (!empireRow) {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.EMPIRE_NOT_FOUND });\n  }\n\n  const empireId = String(empireRow.id);\n\n  const id = String(req.params.id || '').trim();\n  if (!id) return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'Invalid queue item id' });\n\n  // Fetch the queue item\n  const { data: qItem, error: fetchError } = await supabase\n    .from(DB_TABLES.TECH_QUEUE)\n    .select('id, empire_id, tech_key, level, status, location_coord')\n    .eq(DB_FIELDS.BUILDINGS.ID, id)\n    .maybeSingle();\n\n  if (fetchError) {\n    console.error('[tech/queue/:id DELETE] Error fetching item:', fetchError);\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({ success: false, error: 'Error fetching queue item' });\n  }\n\n  if (!qItem || String((qItem as any).empire_id) !== empireId) {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({ success: false, error: ERROR_MESSAGES.QUEUE_ITEM_NOT_FOUND });\n  }\n\n  if (String((qItem as any).status || '') !== 'pending') {\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({ success: false, error: 'Only pending items can be cancelled' });\n  }\n\n  // Calculate refund\n  let refundedCredits: number | null = null;\n  try {\n    const techKey = String((qItem as any).tech_key || '');\n    const level = Math.max(1, Number((qItem as any).level || 1));\n    const spec = getTechSpec(techKey as TechnologyKey);\n    // Cost function for tech handled by service\n    refundedCredits = await TechService.getRefundCredits(spec, level);\n\n    // Update empire credits\n    const { data: empire } = await supabase\n      .from(DB_TABLES.EMPIRES)\n      .select(DB_FIELDS.EMPIRES.CREDITS)\n      .eq(DB_FIELDS.BUILDINGS.ID, empireId)\n      .single();\n\n    if (empire && refundedCredits) {\n      const currentCredits = Number(empire.credits || 0);\n      await supabase\n        .from(DB_TABLES.EMPIRES)\n        .update({ credits: currentCredits + refundedCredits })\n        .eq(DB_FIELDS.BUILDINGS.ID, empireId);\n    }\n  } catch {\n    // If refund calculation fails, still proceed with cancellation\n    console.warn('[tech/queue/:id DELETE] Refund calculation failed');\n  }\n\n  // Update status to cancelled\n  const { error: updateError } = await supabase\n    .from(DB_TABLES.TECH_QUEUE)\n    .update({ status: 'cancelled' })\n    .eq(DB_FIELDS.BUILDINGS.ID, id);\n\n  if (updateError) {\n    console.error('[tech/queue/:id DELETE] Error cancelling item:', updateError);\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({ success: false, error: 'Failed to cancel queue item' });\n  }\n\n  return res.json({\n    success: true,\n    data: { cancelledId: id, refundedCredits },\n    message: 'Research queue item cancelled'\n  });\n}));\n\nexport default router;\n\n\n\n\n\n\n\n\n"],"version":3}