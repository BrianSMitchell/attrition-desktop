{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\routes\\game\\fleets.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\routes\\game\\fleets.ts"],"sourcesContent":["import { Router, Response } from 'express';\nimport { supabase } from '../../config/supabase';\nimport { ERROR_MESSAGES } from '../../constants/response-formats';\n\n// Constants imports for eliminating hardcoded values\nimport { DB_TABLES, DB_FIELDS } from '../../constants/database-fields';\nimport { HTTP_STATUS } from '@game/shared';\nimport { STATUS_CODES } from '@game/shared';\nimport { asyncHandler } from '../../middleware/errorHandler';\nimport { authenticate, AuthRequest } from '../../middleware/auth';\nimport { getUnitSpec } from '@game/shared';\nimport { EmpireResolutionService } from '../../services/empire/EmpireResolutionService';\nimport { FleetMovementService } from '../../services/fleets/FleetMovementService';\n\nconst router: Router = Router();\n\nrouter.use(authenticate);\n\n/**\n * Calculate fleet size in credits based on unit composition (FR-6)\n * @param units - Array of fleet units with unitKey and count\n * @returns Total credits value of the fleet\n */\nfunction calculateFleetSizeCredits(units: Array<{ unitKey?: string; unit_key?: string; count: number }>): number {\n  if (!Array.isArray(units)) {\n    return 0;\n  }\n\n  let totalCredits = 0;\n  \n  for (const unit of units) {\n    const unitKey = unit?.unitKey || unit?.unit_key;\n    const count = Number(unit?.count || 0);\n    \n    if (unitKey && count > 0) {\n      try {\n        const unitSpec = getUnitSpec(unitKey as any);\n        if (unitSpec && typeof unitSpec.creditsCost === 'number') {\n          totalCredits += unitSpec.creditsCost * count;\n        }\n      } catch {\n        // Ignore units with missing specs\n      }\n    }\n  }\n  \n  return totalCredits;\n}\n\n/**\n * List fleets for current empire\n * GET /api/game/fleets\n * GET /api/game/fleets?base=:coord (filtered by base coordinate)\n * \n * Implements FR-1: List all fleets for authenticated empire\n * Implements FR-2: Filter fleets by base coordinate\n * \n * Response Format (FR-12): { success: boolean, data: any, error?: string }\n * DTO: { success, data: { fleets: [{ _id, name, ownerName, arrival, sizeCredits }] } }\n */\nrouter.get('/', asyncHandler(async (req: AuthRequest, res: Response) => {\n  const user = req.user! as any;\n  \n  // Resolve empire using established pattern (FR-14)\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\n  if (!empireRow) {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({\n      success: false,\n      error: ERROR_MESSAGES.EMPIRE_NOT_FOUND\n    });\n  }\n\n  const empireId = String(empireRow.id);\n  const empireName = String((empireRow as any).name || 'Unknown');\n\n  // Build query for fleets including units for size calculation (FR-6)\n  const baseCoord = String(req.query.base || '').trim();\n  let query = supabase\n    .from(DB_TABLES.FLEETS)\n    .select('id, name, size_credits, created_at, location_coord, units')\n    .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId);\n\n  // Add location filter if base coordinate provided (FR-2)\n  if (baseCoord) {\n    query = query.eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, baseCoord);\n  }\n  \n  // Apply ordering and execute query\n  const { data: fleets, error } = await query.order(DB_FIELDS.BUILDINGS.CREATED_AT, { ascending: true });\n\n  if (error) {\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({\n      success: false,\n      error: 'Failed to fetch fleets'\n    });\n  }\n\n  // Format response to match established DTO structure (FR-12)\n  const rows = (fleets || []).map((f: any) => {\n    // Calculate fleet size dynamically from units (FR-6)\n    const calculatedSize = calculateFleetSizeCredits(f.units || []);\n    // Use calculated size if available, fallback to stored value\n    const sizeCredits = calculatedSize > 0 ? calculatedSize : Number(f.size_credits || 0);\n    \n    return {\n      _id: String(f.id),\n      name: String(f.name),\n      ownerName: empireName,\n      arrival: null as null, // stationed at base\n      sizeCredits,\n      locationCoord: String(f.location_coord || '')\n    };\n  });\n\n  return res.json({\n    success: true,\n    data: { fleets: rows }\n  });\n}));\n\n/**\n * Get fleet overview for a base (frontend compatibility)\n * GET /api/game/fleets/overview?base=:coord\n * \n * Implements FR-5: Fleet overview endpoint compatible with existing frontend expectations\n * Implements FR-7: Handle fleet unit composition (type and count arrays)\n * \n * DTO: { success, data: { fleets: Array<{ _id, name, units: Array<{type, count}> }> } }\n */\nrouter.get('/overview', asyncHandler(async (req: AuthRequest, res: Response) => {\n  const user = req.user! as any;\n\n  // Resolve empire using established pattern (FR-14)\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\n  if (!empireRow) {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({\n      success: false,\n      error: ERROR_MESSAGES.EMPIRE_NOT_FOUND\n    });\n  }\n\n  const empireId = String(empireRow.id);\n\n  // Validate base coordinate parameter\n  const baseCoord = String(req.query.base || '').trim();\n  if (!baseCoord) {\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({\n      success: false,\n      error: 'base parameter is required'\n    });\n  }\n\n  // Query fleets at this base with unit composition\n  const { data: fleets, error } = await supabase\n    .from(DB_TABLES.FLEETS)\n    .select('id, name, units')\n    .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n    .eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, baseCoord);\n\n  if (error) {\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({\n      success: false,\n      error: 'Failed to fetch fleet overview'\n    });\n  }\n\n  // Format fleet units for overview (FR-7)\n  const overview = (fleets || []).map((f: any) => {\n    const units = Array.isArray(f.units) ? f.units : [];\n    const formattedUnits = units.map((u: any) => ({\n      type: String(u?.unitKey || u?.unit_key || ''),\n      count: Number(u?.count || 0)\n    }));\n\n    return {\n      _id: String(f.id),\n      name: String(f.name),\n      units: formattedUnits\n    };\n  });\n\n  return res.json({\n    success: true,\n    data: { fleets: overview }\n  });\n}));\n\n/**\n * Get detailed information about a specific fleet\n * GET /api/game/fleets/:id\n * \n * Implements FR-3: Fleet detail endpoint with composition and metadata\n * \n * Response DTO: { \n *   success: boolean, \n *   data: { \n *     fleet: { \n *       _id: string, \n *       name: string, \n *       locationCoord: string, \n *       ownerName: string, \n *       units: Array<{unitKey: string, name: string, count: number}>, \n *       sizeCredits: number \n *     } \n *   } \n * }\n */\nrouter.get('/:id', asyncHandler(async (req: AuthRequest, res: Response) => {\n  const fleetId = String(req.params.id || '').trim();\n  if (!fleetId) {\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({\n      success: false,\n      error: 'Invalid fleet id'\n    });\n  }\n\n  const user = req.user! as any;\n  \n  // Resolve empire using established pattern (FR-14)\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\n  if (!empireRow) {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({\n      success: false,\n      error: ERROR_MESSAGES.EMPIRE_NOT_FOUND\n    });\n  }\n\n  const empireId = String(empireRow.id);\n  const empireName = String((empireRow as any).name || 'Unknown');\n\n  // Query fleet by ID with empire ownership check\n  const { data: fleet, error } = await supabase\n    .from(DB_TABLES.FLEETS)\n    .select('id, name, location_coord, units, size_credits')\n    .eq(DB_FIELDS.BUILDINGS.ID, fleetId)\n    .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n    .single();\n\n  if (error) {\n    if (error.code === 'PGRST116') { // No rows returned\n      return res.status(HTTP_STATUS.NOT_FOUND).json({\n        success: false,\n        error: ERROR_MESSAGES.FLEET_NOT_FOUND\n      });\n    }\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({\n      success: false,\n      error: 'Failed to fetch fleet details'\n    });\n  }\n\n  // Parse and format fleet composition (FR-7)\n  const units = Array.isArray(fleet.units) ? fleet.units : [];\n  const composition = units.map((u: any) => {\n    const unitKey = String(u?.unitKey || u?.unit_key || '');\n    let unitName = unitKey;\n    try {\n      const spec = getUnitSpec(unitKey as any);\n      unitName = spec?.name || unitKey;\n    } catch {\n      // Fallback to key if spec not found\n    }\n    return { \n      unitKey, \n      name: unitName, \n      count: Number(u?.count || 0) \n    };\n  });\n\n  return res.json({\n    success: true,\n    data: {\n      fleet: {\n        _id: String(fleet.id),\n        name: String(fleet.name),\n        locationCoord: String(fleet.location_coord || ''),\n        ownerName: empireName,\n        units: composition,\n        sizeCredits: Number(fleet.size_credits || 0),\n      }\n    }\n  });\n}));\n\n/**\n * Initiate fleet movement to a destination\n * POST /api/game/fleets/:id/move\n * Body: { destinationCoord: string }\n * \n * Implements FR-4: Fleet movement endpoint to initiate fleet movement\n * \n * Request Body: { destinationCoord: string }\n * Response DTO: { \n *   success: boolean, \n *   data: { movement: any }, \n *   message?: string,\n *   error?: string,\n *   code?: string\n * }\n */\nrouter.post('/:id/move', asyncHandler(async (req: AuthRequest, res: Response) => {\n  const fleetId = String(req.params.id || '').trim();\n  if (!fleetId) {\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({\n      success: false,\n      error: 'Invalid fleet id'\n    });\n  }\n\n  // Validate request body\n  const { destinationCoord } = req.body as { destinationCoord?: string };\n  if (!destinationCoord || typeof destinationCoord !== 'string') {\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({\n      success: false,\n      error: 'destinationCoord is required'\n    });\n  }\n\n  const user = req.user! as any;\n  \n  // Resolve empire using established pattern (FR-14)\n  const empireRow = await EmpireResolutionService.resolveEmpireByUserObject(user);\n  if (!empireRow) {\n    return res.status(HTTP_STATUS.NOT_FOUND).json({\n      success: false,\n      error: ERROR_MESSAGES.EMPIRE_NOT_FOUND\n    });\n  }\n\n  const empireId = String(empireRow.id);\n\n  try {\n    // Use existing FleetMovementService to handle the fleet dispatch\n    const result = await FleetMovementService.dispatchFleet(\n      fleetId,\n      empireId,\n      { destinationCoord }\n    );\n\n    if (!result.success) {\n      // Map service error codes to appropriate HTTP status codes (FR-15)\n      let statusCode: number = HTTP_STATUS.BAD_REQUEST; // Default to bad request\n      switch (result.code) {\n        case 'FLEET_NOT_FOUND':\n          statusCode = HTTP_STATUS.NOT_FOUND;\n          break;\n        case 'EMPTY_FLEET':\n        case 'FLEET_ALREADY_MOVING':\n        case 'ALREADY_AT_DESTINATION':\n        case 'INVALID_DESTINATION':\n          statusCode = HTTP_STATUS.BAD_REQUEST;\n          break;\n        case 'DISPATCH_ERROR':\n          statusCode = HTTP_STATUS.INTERNAL_SERVER_ERROR;\n          break;\n        default:\n          statusCode = HTTP_STATUS.BAD_REQUEST;\n      }\n\n      return res.status(statusCode).json({\n        success: false,\n        error: result.error || 'Failed to move fleet'\n      });\n    }\n\n    // Success response (FR-12)\n    return res.json({\n      success: true,\n      data: { movement: result.movement },\n      message: 'Fleet movement initiated successfully'\n    });\n  } catch (error) {\n    console.error('Error initiating fleet movement:', error);\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({\n      success: false,\n      error: 'Failed to initiate fleet movement'\n    });\n  }\n}));\n\nexport default router;\n\n\n\n\n"],"version":3}