16b6d20506404b2c33b100436f1d61ce
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const supabase_1 = require("../../config/supabase");
const response_formats_1 = require("../../constants/response-formats");
// Constants imports for eliminating hardcoded values
const database_fields_1 = require("../../constants/database-fields");
const shared_1 = require("@game/shared");
const errorHandler_1 = require("../../middleware/errorHandler");
const auth_1 = require("../../middleware/auth");
const shared_2 = require("@game/shared");
const EmpireResolutionService_1 = require("../../services/empire/EmpireResolutionService");
const FleetMovementService_1 = require("../../services/fleets/FleetMovementService");
const router = (0, express_1.Router)();
router.use(auth_1.authenticate);
/**
 * Calculate fleet size in credits based on unit composition (FR-6)
 * @param units - Array of fleet units with unitKey and count
 * @returns Total credits value of the fleet
 */
function calculateFleetSizeCredits(units) {
    if (!Array.isArray(units)) {
        return 0;
    }
    let totalCredits = 0;
    for (const unit of units) {
        const unitKey = unit?.unitKey || unit?.unit_key;
        const count = Number(unit?.count || 0);
        if (unitKey && count > 0) {
            try {
                const unitSpec = (0, shared_2.getUnitSpec)(unitKey);
                if (unitSpec && typeof unitSpec.creditsCost === 'number') {
                    totalCredits += unitSpec.creditsCost * count;
                }
            }
            catch {
                // Ignore units with missing specs
            }
        }
    }
    return totalCredits;
}
/**
 * List fleets for current empire
 * GET /api/game/fleets
 * GET /api/game/fleets?base=:coord (filtered by base coordinate)
 *
 * Implements FR-1: List all fleets for authenticated empire
 * Implements FR-2: Filter fleets by base coordinate
 *
 * Response Format (FR-12): { success: boolean, data: any, error?: string }
 * DTO: { success, data: { fleets: [{ _id, name, ownerName, arrival, sizeCredits }] } }
 */
router.get('/', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    const user = req.user;
    // Resolve empire using established pattern (FR-14)
    const empireRow = await EmpireResolutionService_1.EmpireResolutionService.resolveEmpireByUserObject(user);
    if (!empireRow) {
        return res.status(shared_1.HTTP_STATUS.NOT_FOUND).json({
            success: false,
            error: response_formats_1.ERROR_MESSAGES.EMPIRE_NOT_FOUND
        });
    }
    const empireId = String(empireRow.id);
    const empireName = String(empireRow.name || 'Unknown');
    // Build query for fleets including units for size calculation (FR-6)
    const baseCoord = String(req.query.base || '').trim();
    let query = supabase_1.supabase
        .from(database_fields_1.DB_TABLES.FLEETS)
        .select('id, name, size_credits, created_at, location_coord, units')
        .eq(database_fields_1.DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId);
    // Add location filter if base coordinate provided (FR-2)
    if (baseCoord) {
        query = query.eq(database_fields_1.DB_FIELDS.BUILDINGS.LOCATION_COORD, baseCoord);
    }
    // Apply ordering and execute query
    const { data: fleets, error } = await query.order(database_fields_1.DB_FIELDS.BUILDINGS.CREATED_AT, { ascending: true });
    if (error) {
        return res.status(shared_1.HTTP_STATUS.INTERNAL_SERVER_ERROR).json({
            success: false,
            error: 'Failed to fetch fleets'
        });
    }
    // Format response to match established DTO structure (FR-12)
    const rows = (fleets || []).map((f) => {
        // Calculate fleet size dynamically from units (FR-6)
        const calculatedSize = calculateFleetSizeCredits(f.units || []);
        // Use calculated size if available, fallback to stored value
        const sizeCredits = calculatedSize > 0 ? calculatedSize : Number(f.size_credits || 0);
        return {
            _id: String(f.id),
            name: String(f.name),
            ownerName: empireName,
            arrival: null, // stationed at base
            sizeCredits,
            locationCoord: String(f.location_coord || '')
        };
    });
    return res.json({
        success: true,
        data: { fleets: rows }
    });
}));
/**
 * Get fleet overview for a base (frontend compatibility)
 * GET /api/game/fleets/overview?base=:coord
 *
 * Implements FR-5: Fleet overview endpoint compatible with existing frontend expectations
 * Implements FR-7: Handle fleet unit composition (type and count arrays)
 *
 * DTO: { success, data: { fleets: Array<{ _id, name, units: Array<{type, count}> }> } }
 */
router.get('/overview', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    const user = req.user;
    // Resolve empire using established pattern (FR-14)
    const empireRow = await EmpireResolutionService_1.EmpireResolutionService.resolveEmpireByUserObject(user);
    if (!empireRow) {
        return res.status(shared_1.HTTP_STATUS.NOT_FOUND).json({
            success: false,
            error: response_formats_1.ERROR_MESSAGES.EMPIRE_NOT_FOUND
        });
    }
    const empireId = String(empireRow.id);
    // Validate base coordinate parameter
    const baseCoord = String(req.query.base || '').trim();
    if (!baseCoord) {
        return res.status(shared_1.HTTP_STATUS.BAD_REQUEST).json({
            success: false,
            error: 'base parameter is required'
        });
    }
    // Query fleets at this base with unit composition
    const { data: fleets, error } = await supabase_1.supabase
        .from(database_fields_1.DB_TABLES.FLEETS)
        .select('id, name, units')
        .eq(database_fields_1.DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)
        .eq(database_fields_1.DB_FIELDS.BUILDINGS.LOCATION_COORD, baseCoord);
    if (error) {
        return res.status(shared_1.HTTP_STATUS.INTERNAL_SERVER_ERROR).json({
            success: false,
            error: 'Failed to fetch fleet overview'
        });
    }
    // Format fleet units for overview (FR-7)
    const overview = (fleets || []).map((f) => {
        const units = Array.isArray(f.units) ? f.units : [];
        const formattedUnits = units.map((u) => ({
            type: String(u?.unitKey || u?.unit_key || ''),
            count: Number(u?.count || 0)
        }));
        return {
            _id: String(f.id),
            name: String(f.name),
            units: formattedUnits
        };
    });
    return res.json({
        success: true,
        data: { fleets: overview }
    });
}));
/**
 * Get detailed information about a specific fleet
 * GET /api/game/fleets/:id
 *
 * Implements FR-3: Fleet detail endpoint with composition and metadata
 *
 * Response DTO: {
 *   success: boolean,
 *   data: {
 *     fleet: {
 *       _id: string,
 *       name: string,
 *       locationCoord: string,
 *       ownerName: string,
 *       units: Array<{unitKey: string, name: string, count: number}>,
 *       sizeCredits: number
 *     }
 *   }
 * }
 */
router.get('/:id', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    const fleetId = String(req.params.id || '').trim();
    if (!fleetId) {
        return res.status(shared_1.HTTP_STATUS.BAD_REQUEST).json({
            success: false,
            error: 'Invalid fleet id'
        });
    }
    const user = req.user;
    // Resolve empire using established pattern (FR-14)
    const empireRow = await EmpireResolutionService_1.EmpireResolutionService.resolveEmpireByUserObject(user);
    if (!empireRow) {
        return res.status(shared_1.HTTP_STATUS.NOT_FOUND).json({
            success: false,
            error: response_formats_1.ERROR_MESSAGES.EMPIRE_NOT_FOUND
        });
    }
    const empireId = String(empireRow.id);
    const empireName = String(empireRow.name || 'Unknown');
    // Query fleet by ID with empire ownership check
    const { data: fleet, error } = await supabase_1.supabase
        .from(database_fields_1.DB_TABLES.FLEETS)
        .select('id, name, location_coord, units, size_credits')
        .eq(database_fields_1.DB_FIELDS.BUILDINGS.ID, fleetId)
        .eq(database_fields_1.DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)
        .single();
    if (error) {
        if (error.code === 'PGRST116') { // No rows returned
            return res.status(shared_1.HTTP_STATUS.NOT_FOUND).json({
                success: false,
                error: response_formats_1.ERROR_MESSAGES.FLEET_NOT_FOUND
            });
        }
        return res.status(shared_1.HTTP_STATUS.INTERNAL_SERVER_ERROR).json({
            success: false,
            error: 'Failed to fetch fleet details'
        });
    }
    // Parse and format fleet composition (FR-7)
    const units = Array.isArray(fleet.units) ? fleet.units : [];
    const composition = units.map((u) => {
        const unitKey = String(u?.unitKey || u?.unit_key || '');
        let unitName = unitKey;
        try {
            const spec = (0, shared_2.getUnitSpec)(unitKey);
            unitName = spec?.name || unitKey;
        }
        catch {
            // Fallback to key if spec not found
        }
        return {
            unitKey,
            name: unitName,
            count: Number(u?.count || 0)
        };
    });
    return res.json({
        success: true,
        data: {
            fleet: {
                _id: String(fleet.id),
                name: String(fleet.name),
                locationCoord: String(fleet.location_coord || ''),
                ownerName: empireName,
                units: composition,
                sizeCredits: Number(fleet.size_credits || 0),
            }
        }
    });
}));
/**
 * Initiate fleet movement to a destination
 * POST /api/game/fleets/:id/move
 * Body: { destinationCoord: string }
 *
 * Implements FR-4: Fleet movement endpoint to initiate fleet movement
 *
 * Request Body: { destinationCoord: string }
 * Response DTO: {
 *   success: boolean,
 *   data: { movement: any },
 *   message?: string,
 *   error?: string,
 *   code?: string
 * }
 */
router.post('/:id/move', (0, errorHandler_1.asyncHandler)(async (req, res) => {
    const fleetId = String(req.params.id || '').trim();
    if (!fleetId) {
        return res.status(shared_1.HTTP_STATUS.BAD_REQUEST).json({
            success: false,
            error: 'Invalid fleet id'
        });
    }
    // Validate request body
    const { destinationCoord } = req.body;
    if (!destinationCoord || typeof destinationCoord !== 'string') {
        return res.status(shared_1.HTTP_STATUS.BAD_REQUEST).json({
            success: false,
            error: 'destinationCoord is required'
        });
    }
    const user = req.user;
    // Resolve empire using established pattern (FR-14)
    const empireRow = await EmpireResolutionService_1.EmpireResolutionService.resolveEmpireByUserObject(user);
    if (!empireRow) {
        return res.status(shared_1.HTTP_STATUS.NOT_FOUND).json({
            success: false,
            error: response_formats_1.ERROR_MESSAGES.EMPIRE_NOT_FOUND
        });
    }
    const empireId = String(empireRow.id);
    try {
        // Use existing FleetMovementService to handle the fleet dispatch
        const result = await FleetMovementService_1.FleetMovementService.dispatchFleet(fleetId, empireId, { destinationCoord });
        if (!result.success) {
            // Map service error codes to appropriate HTTP status codes (FR-15)
            let statusCode = shared_1.HTTP_STATUS.BAD_REQUEST; // Default to bad request
            switch (result.code) {
                case 'FLEET_NOT_FOUND':
                    statusCode = shared_1.HTTP_STATUS.NOT_FOUND;
                    break;
                case 'EMPTY_FLEET':
                case 'FLEET_ALREADY_MOVING':
                case 'ALREADY_AT_DESTINATION':
                case 'INVALID_DESTINATION':
                    statusCode = shared_1.HTTP_STATUS.BAD_REQUEST;
                    break;
                case 'DISPATCH_ERROR':
                    statusCode = shared_1.HTTP_STATUS.INTERNAL_SERVER_ERROR;
                    break;
                default:
                    statusCode = shared_1.HTTP_STATUS.BAD_REQUEST;
            }
            return res.status(statusCode).json({
                success: false,
                error: result.error || 'Failed to move fleet'
            });
        }
        // Success response (FR-12)
        return res.json({
            success: true,
            data: { movement: result.movement },
            message: 'Fleet movement initiated successfully'
        });
    }
    catch (error) {
        console.error('Error initiating fleet movement:', error);
        return res.status(shared_1.HTTP_STATUS.INTERNAL_SERVER_ERROR).json({
            success: false,
            error: 'Failed to initiate fleet movement'
        });
    }
}));
exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFByb2plY3RzXFxBdHRyaXRpb25cXHBhY2thZ2VzXFxzZXJ2ZXJcXHNyY1xccm91dGVzXFxnYW1lXFxmbGVldHMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSxxQ0FBMkM7QUFDM0Msb0RBQWlEO0FBQ2pELHVFQUFrRTtBQUVsRSxxREFBcUQ7QUFDckQscUVBQXVFO0FBQ3ZFLHlDQUEyQztBQUUzQyxnRUFBNkQ7QUFDN0QsZ0RBQWtFO0FBQ2xFLHlDQUEyQztBQUMzQywyRkFBd0Y7QUFDeEYscUZBQWtGO0FBRWxGLE1BQU0sTUFBTSxHQUFXLElBQUEsZ0JBQU0sR0FBRSxDQUFDO0FBRWhDLE1BQU0sQ0FBQyxHQUFHLENBQUMsbUJBQVksQ0FBQyxDQUFDO0FBRXpCOzs7O0dBSUc7QUFDSCxTQUFTLHlCQUF5QixDQUFDLEtBQW9FO0lBQ3JHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDMUIsT0FBTyxDQUFDLENBQUM7SUFDWCxDQUFDO0lBRUQsSUFBSSxZQUFZLEdBQUcsQ0FBQyxDQUFDO0lBRXJCLEtBQUssTUFBTSxJQUFJLElBQUksS0FBSyxFQUFFLENBQUM7UUFDekIsTUFBTSxPQUFPLEdBQUcsSUFBSSxFQUFFLE9BQU8sSUFBSSxJQUFJLEVBQUUsUUFBUSxDQUFDO1FBQ2hELE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxJQUFJLEVBQUUsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRXZDLElBQUksT0FBTyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUN6QixJQUFJLENBQUM7Z0JBQ0gsTUFBTSxRQUFRLEdBQUcsSUFBQSxvQkFBVyxFQUFDLE9BQWMsQ0FBQyxDQUFDO2dCQUM3QyxJQUFJLFFBQVEsSUFBSSxPQUFPLFFBQVEsQ0FBQyxXQUFXLEtBQUssUUFBUSxFQUFFLENBQUM7b0JBQ3pELFlBQVksSUFBSSxRQUFRLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQztnQkFDL0MsQ0FBQztZQUNILENBQUM7WUFBQyxN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QUFRLEVBQUU7WUFDbkMsT0FBTyxFQUFFLHVDQUF1QztTQUNqRCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsa0NBQWtDLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDekQsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLG9CQUFXLENBQUMscUJBQXFCLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDeEQsT0FBTyxFQUFFLEtBQUs7WUFDZCxLQUFLLEVBQUUsbUNBQW1DO1NBQzNDLENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBRUosa0JBQWUsTUFBTSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxQcm9qZWN0c1xcQXR0cml0aW9uXFxwYWNrYWdlc1xcc2VydmVyXFxzcmNcXHJvdXRlc1xcZ2FtZVxcZmxlZXRzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJvdXRlciwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IHN1cGFiYXNlIH0gZnJvbSAnLi4vLi4vY29uZmlnL3N1cGFiYXNlJztcbmltcG9ydCB7IEVSUk9SX01FU1NBR0VTIH0gZnJvbSAnLi4vLi4vY29uc3RhbnRzL3Jlc3BvbnNlLWZvcm1hdHMnO1xuXG4vLyBDb25zdGFudHMgaW1wb3J0cyBmb3IgZWxpbWluYXRpbmcgaGFyZGNvZGVkIHZhbHVlc1xuaW1wb3J0IHsgREJfVEFCTEVTLCBEQl9GSUVMRFMgfSBmcm9tICcuLi8uLi9jb25zdGFudHMvZGF0YWJhc2UtZmllbGRzJztcbmltcG9ydCB7IEhUVFBfU1RBVFVTIH0gZnJvbSAnQGdhbWUvc2hhcmVkJztcbmltcG9ydCB7IFNUQVRVU19DT0RFUyB9IGZyb20gJ0BnYW1lL3NoYXJlZCc7XG5pbXBvcnQgeyBhc3luY0hhbmRsZXIgfSBmcm9tICcuLi8uLi9taWRkbGV3YXJlL2Vycm9ySGFuZGxlcic7XG5pbXBvcnQgeyBhdXRoZW50aWNhdGUsIEF1dGhSZXF1ZXN0IH0gZnJvbSAnLi4vLi4vbWlkZGxld2FyZS9hdXRoJztcbmltcG9ydCB7IGdldFVuaXRTcGVjIH0gZnJvbSAnQGdhbWUvc2hhcmVkJztcbmltcG9ydCB7IEVtcGlyZVJlc29sdXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvZW1waXJlL0VtcGlyZVJlc29sdXRpb25TZXJ2aWNlJztcbmltcG9ydCB7IEZsZWV0TW92ZW1lbnRTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvZmxlZXRzL0ZsZWV0TW92ZW1lbnRTZXJ2aWNlJztcblxuY29uc3Qgcm91dGVyOiBSb3V0ZXIgPSBSb3V0ZXIoKTtcblxucm91dGVyLnVzZShhdXRoZW50aWNhdGUpO1xuXG4vKipcbiAqIENhbGN1bGF0ZSBmbGVldCBzaXplIGluIGNyZWRpdHMgYmFzZWQgb24gdW5pdCBjb21wb3NpdGlvbiAoRlItNilcbiAqIEBwYXJhbSB1bml0cyAtIEFycmF5IG9mIGZsZWV0IHVuaXRzIHdpdGggdW5pdEtleSBhbmQgY291bnRcbiAqIEByZXR1cm5zIFRvdGFsIGNyZWRpdHMgdmFsdWUgb2YgdGhlIGZsZWV0XG4gKi9cbmZ1bmN0aW9uIGNhbGN1bGF0ZUZsZWV0U2l6ZUNyZWRpdHModW5pdHM6IEFycmF5PHsgdW5pdEtleT86IHN0cmluZzsgdW5pdF9rZXk/OiBzdHJpbmc7IGNvdW50OiBudW1iZXIgfT4pOiBudW1iZXIge1xuICBpZiAoIUFycmF5LmlzQXJyYXkodW5pdHMpKSB7XG4gICAgcmV0dXJuIDA7XG4gIH1cblxuICBsZXQgdG90YWxDcmVkaXRzID0gMDtcbiAgXG4gIGZvciAoY29uc3QgdW5pdCBvZiB1bml0cykge1xuICAgIGNvbnN0IHVuaXRLZXkgPSB1bml0Py51bml0S2V5IHx8IHVuaXQ/LnVuaXRfa2V5O1xuICAgIGNvbnN0IGNvdW50ID0gTnVtYmVyKHVuaXQ/LmNvdW50IHx8IDApO1xuICAgIFxuICAgIGlmICh1bml0S2V5ICYmIGNvdW50ID4gMCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgdW5pdFNwZWMgPSBnZXRVbml0U3BlYyh1bml0S2V5IGFzIGFueSk7XG4gICAgICAgIGlmICh1bml0U3BlYyAmJiB0eXBlb2YgdW5pdFNwZWMuY3JlZGl0c0Nvc3QgPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgdG90YWxDcmVkaXRzICs9IHVuaXRTcGVjLmNyZWRpdHNDb3N0ICogY291bnQ7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2gge1xuICAgICAgICAvLyBJZ25vcmUgdW5pdHMgd2l0aCBtaXNzaW5nIHNwZWNzXG4gICAgICB9XG4gICAgfVxuICB9XG4gIFxuICByZXR1cm4gdG90YWxDcmVkaXRzO1xufVxuXG4vKipcbiAqIExpc3QgZmxlZXRzIGZvciBjdXJyZW50IGVtcGlyZVxuICogR0VUIC9hcGkvZ2FtZS9mbGVldHNcbiAqIEdFVCAvYXBpL2dhbWUvZmxlZXRzP2Jhc2U9OmNvb3JkIChmaWx0ZXJlZCBieSBiYXNlIGNvb3JkaW5hdGUpXG4gKiBcbiAqIEltcGxlbWVudHMgRlItMTogTGlzdCBhbGwgZmxlZXRzIGZvciBhdXRoZW50aWNhdGVkIGVtcGlyZVxuICogSW1wbGVtZW50cyBGUi0yOiBGaWx0ZXIgZmxlZXRzIGJ5IGJhc2UgY29vcmRpbmF0ZVxuICogXG4gKiBSZXNwb25zZSBGb3JtYXQgKEZSLTEyKTogeyBzdWNjZXNzOiBib29sZWFuLCBkYXRhOiBhbnksIGVycm9yPzogc3RyaW5nIH1cbiAqIERUTzogeyBzdWNjZXNzLCBkYXRhOiB7IGZsZWV0czogW3sgX2lkLCBuYW1lLCBvd25lck5hbWUsIGFycml2YWwsIHNpemVDcmVkaXRzIH1dIH0gfVxuICovXG5yb3V0ZXIuZ2V0KCcvJywgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXE6IEF1dGhSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIGNvbnN0IHVzZXIgPSByZXEudXNlciEgYXMgYW55O1xuICBcbiAgLy8gUmVzb2x2ZSBlbXBpcmUgdXNpbmcgZXN0YWJsaXNoZWQgcGF0dGVybiAoRlItMTQpXG4gIGNvbnN0IGVtcGlyZVJvdyA9IGF3YWl0IEVtcGlyZVJlc29sdXRpb25TZXJ2aWNlLnJlc29sdmVFbXBpcmVCeVVzZXJPYmplY3QodXNlcik7XG4gIGlmICghZW1waXJlUm93KSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuTk9UX0ZPVU5EKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6IEVSUk9SX01FU1NBR0VTLkVNUElSRV9OT1RfRk9VTkRcbiAgICB9KTtcbiAgfVxuXG4gIGNvbnN0IGVtcGlyZUlkID0gU3RyaW5nKGVtcGlyZVJvdy5pZCk7XG4gIGNvbnN0IGVtcGlyZU5hbWUgPSBTdHJpbmcoKGVtcGlyZVJvdyBhcyBhbnkpLm5hbWUgfHwgJ1Vua25vd24nKTtcblxuICAvLyBCdWlsZCBxdWVyeSBmb3IgZmxlZXRzIGluY2x1ZGluZyB1bml0cyBmb3Igc2l6ZSBjYWxjdWxhdGlvbiAoRlItNilcbiAgY29uc3QgYmFzZUNvb3JkID0gU3RyaW5nKHJlcS5xdWVyeS5iYXNlIHx8ICcnKS50cmltKCk7XG4gIGxldCBxdWVyeSA9IHN1cGFiYXNlXG4gICAgLmZyb20oREJfVEFCTEVTLkZMRUVUUylcbiAgICAuc2VsZWN0KCdpZCwgbmFtZSwgc2l6ZV9jcmVkaXRzLCBjcmVhdGVkX2F0LCBsb2NhdGlvbl9jb29yZCwgdW5pdHMnKVxuICAgIC5lcShEQl9GSUVMRFMuQlVJTERJTkdTLkVNUElSRV9JRCwgZW1waXJlSWQpO1xuXG4gIC8vIEFkZCBsb2NhdGlvbiBmaWx0ZXIgaWYgYmFzZSBjb29yZGluYXRlIHByb3ZpZGVkIChGUi0yKVxuICBpZiAoYmFzZUNvb3JkKSB7XG4gICAgcXVlcnkgPSBxdWVyeS5lcShEQl9GSUVMRFMuQlVJTERJTkdTLkxPQ0FUSU9OX0NPT1JELCBiYXNlQ29vcmQpO1xuICB9XG4gIFxuICAvLyBBcHBseSBvcmRlcmluZyBhbmQgZXhlY3V0ZSBxdWVyeVxuICBjb25zdCB7IGRhdGE6IGZsZWV0cywgZXJyb3IgfSA9IGF3YWl0IHF1ZXJ5Lm9yZGVyKERCX0ZJRUxEUy5CVUlMRElOR1MuQ1JFQVRFRF9BVCwgeyBhc2NlbmRpbmc6IHRydWUgfSk7XG5cbiAgaWYgKGVycm9yKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuSU5URVJOQUxfU0VSVkVSX0VSUk9SKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6ICdGYWlsZWQgdG8gZmV0Y2ggZmxlZXRzJ1xuICAgIH0pO1xuICB9XG5cbiAgLy8gRm9ybWF0IHJlc3BvbnNlIHRvIG1hdGNoIGVzdGFibGlzaGVkIERUTyBzdHJ1Y3R1cmUgKEZSLTEyKVxuICBjb25zdCByb3dzID0gKGZsZWV0cyB8fCBbXSkubWFwKChmOiBhbnkpID0+IHtcbiAgICAvLyBDYWxjdWxhdGUgZmxlZXQgc2l6ZSBkeW5hbWljYWxseSBmcm9tIHVuaXRzIChGUi02KVxuICAgIGNvbnN0IGNhbGN1bGF0ZWRTaXplID0gY2FsY3VsYXRlRmxlZXRTaXplQ3JlZGl0cyhmLnVuaXRzIHx8IFtdKTtcbiAgICAvLyBVc2UgY2FsY3VsYXRlZCBzaXplIGlmIGF2YWlsYWJsZSwgZmFsbGJhY2sgdG8gc3RvcmVkIHZhbHVlXG4gICAgY29uc3Qgc2l6ZUNyZWRpdHMgPSBjYWxjdWxhdGVkU2l6ZSA+IDAgPyBjYWxjdWxhdGVkU2l6ZSA6IE51bWJlcihmLnNpemVfY3JlZGl0cyB8fCAwKTtcbiAgICBcbiAgICByZXR1cm4ge1xuICAgICAgX2lkOiBTdHJpbmcoZi5pZCksXG4gICAgICBuYW1lOiBTdHJpbmcoZi5uYW1lKSxcbiAgICAgIG93bmVyTmFtZTogZW1waXJlTmFtZSxcbiAgICAgIGFycml2YWw6IG51bGwgYXMgbnVsbCwgLy8gc3RhdGlvbmVkIGF0IGJhc2VcbiAgICAgIHNpemVDcmVkaXRzLFxuICAgICAgbG9jYXRpb25Db29yZDogU3RyaW5nKGYubG9jYXRpb25fY29vcmQgfHwgJycpXG4gICAgfTtcbiAgfSk7XG5cbiAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICBzdWNjZXNzOiB0cnVlLFxuICAgIGRhdGE6IHsgZmxlZXRzOiByb3dzIH1cbiAgfSk7XG59KSk7XG5cbi8qKlxuICogR2V0IGZsZWV0IG92ZXJ2aWV3IGZvciBhIGJhc2UgKGZyb250ZW5kIGNvbXBhdGliaWxpdHkpXG4gKiBHRVQgL2FwaS9nYW1lL2ZsZWV0cy9vdmVydmlldz9iYXNlPTpjb29yZFxuICogXG4gKiBJbXBsZW1lbnRzIEZSLTU6IEZsZWV0IG92ZXJ2aWV3IGVuZHBvaW50IGNvbXBhdGlibGUgd2l0aCBleGlzdGluZyBmcm9udGVuZCBleHBlY3RhdGlvbnNcbiAqIEltcGxlbWVudHMgRlItNzogSGFuZGxlIGZsZWV0IHVuaXQgY29tcG9zaXRpb24gKHR5cGUgYW5kIGNvdW50IGFycmF5cylcbiAqIFxuICogRFRPOiB7IHN1Y2Nlc3MsIGRhdGE6IHsgZmxlZXRzOiBBcnJheTx7IF9pZCwgbmFtZSwgdW5pdHM6IEFycmF5PHt0eXBlLCBjb3VudH0+IH0+IH0gfVxuICovXG5yb3V0ZXIuZ2V0KCcvb3ZlcnZpZXcnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcTogQXV0aFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgY29uc3QgdXNlciA9IHJlcS51c2VyISBhcyBhbnk7XG5cbiAgLy8gUmVzb2x2ZSBlbXBpcmUgdXNpbmcgZXN0YWJsaXNoZWQgcGF0dGVybiAoRlItMTQpXG4gIGNvbnN0IGVtcGlyZVJvdyA9IGF3YWl0IEVtcGlyZVJlc29sdXRpb25TZXJ2aWNlLnJlc29sdmVFbXBpcmVCeVVzZXJPYmplY3QodXNlcik7XG4gIGlmICghZW1waXJlUm93KSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuTk9UX0ZPVU5EKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6IEVSUk9SX01FU1NBR0VTLkVNUElSRV9OT1RfRk9VTkRcbiAgICB9KTtcbiAgfVxuXG4gIGNvbnN0IGVtcGlyZUlkID0gU3RyaW5nKGVtcGlyZVJvdy5pZCk7XG5cbiAgLy8gVmFsaWRhdGUgYmFzZSBjb29yZGluYXRlIHBhcmFtZXRlclxuICBjb25zdCBiYXNlQ29vcmQgPSBTdHJpbmcocmVxLnF1ZXJ5LmJhc2UgfHwgJycpLnRyaW0oKTtcbiAgaWYgKCFiYXNlQ29vcmQpIHtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5CQURfUkVRVUVTVCkuanNvbih7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIGVycm9yOiAnYmFzZSBwYXJhbWV0ZXIgaXMgcmVxdWlyZWQnXG4gICAgfSk7XG4gIH1cblxuICAvLyBRdWVyeSBmbGVldHMgYXQgdGhpcyBiYXNlIHdpdGggdW5pdCBjb21wb3NpdGlvblxuICBjb25zdCB7IGRhdGE6IGZsZWV0cywgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgLmZyb20oREJfVEFCTEVTLkZMRUVUUylcbiAgICAuc2VsZWN0KCdpZCwgbmFtZSwgdW5pdHMnKVxuICAgIC5lcShEQl9GSUVMRFMuQlVJTERJTkdTLkVNUElSRV9JRCwgZW1waXJlSWQpXG4gICAgLmVxKERCX0ZJRUxEUy5CVUlMRElOR1MuTE9DQVRJT05fQ09PUkQsIGJhc2VDb29yZCk7XG5cbiAgaWYgKGVycm9yKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuSU5URVJOQUxfU0VSVkVSX0VSUk9SKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6ICdGYWlsZWQgdG8gZmV0Y2ggZmxlZXQgb3ZlcnZpZXcnXG4gICAgfSk7XG4gIH1cblxuICAvLyBGb3JtYXQgZmxlZXQgdW5pdHMgZm9yIG92ZXJ2aWV3IChGUi03KVxuICBjb25zdCBvdmVydmlldyA9IChmbGVldHMgfHwgW10pLm1hcCgoZjogYW55KSA9PiB7XG4gICAgY29uc3QgdW5pdHMgPSBBcnJheS5pc0FycmF5KGYudW5pdHMpID8gZi51bml0cyA6IFtdO1xuICAgIGNvbnN0IGZvcm1hdHRlZFVuaXRzID0gdW5pdHMubWFwKCh1OiBhbnkpID0+ICh7XG4gICAgICB0eXBlOiBTdHJpbmcodT8udW5pdEtleSB8fCB1Py51bml0X2tleSB8fCAnJyksXG4gICAgICBjb3VudDogTnVtYmVyKHU/LmNvdW50IHx8IDApXG4gICAgfSkpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIF9pZDogU3RyaW5nKGYuaWQpLFxuICAgICAgbmFtZTogU3RyaW5nKGYubmFtZSksXG4gICAgICB1bml0czogZm9ybWF0dGVkVW5pdHNcbiAgICB9O1xuICB9KTtcblxuICByZXR1cm4gcmVzLmpzb24oe1xuICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgZGF0YTogeyBmbGVldHM6IG92ZXJ2aWV3IH1cbiAgfSk7XG59KSk7XG5cbi8qKlxuICogR2V0IGRldGFpbGVkIGluZm9ybWF0aW9uIGFib3V0IGEgc3BlY2lmaWMgZmxlZXRcbiAqIEdFVCAvYXBpL2dhbWUvZmxlZXRzLzppZFxuICogXG4gKiBJbXBsZW1lbnRzIEZSLTM6IEZsZWV0IGRldGFpbCBlbmRwb2ludCB3aXRoIGNvbXBvc2l0aW9uIGFuZCBtZXRhZGF0YVxuICogXG4gKiBSZXNwb25zZSBEVE86IHsgXG4gKiAgIHN1Y2Nlc3M6IGJvb2xlYW4sIFxuICogICBkYXRhOiB7IFxuICogICAgIGZsZWV0OiB7IFxuICogICAgICAgX2lkOiBzdHJpbmcsIFxuICogICAgICAgbmFtZTogc3RyaW5nLCBcbiAqICAgICAgIGxvY2F0aW9uQ29vcmQ6IHN0cmluZywgXG4gKiAgICAgICBvd25lck5hbWU6IHN0cmluZywgXG4gKiAgICAgICB1bml0czogQXJyYXk8e3VuaXRLZXk6IHN0cmluZywgbmFtZTogc3RyaW5nLCBjb3VudDogbnVtYmVyfT4sIFxuICogICAgICAgc2l6ZUNyZWRpdHM6IG51bWJlciBcbiAqICAgICB9IFxuICogICB9IFxuICogfVxuICovXG5yb3V0ZXIuZ2V0KCcvOmlkJywgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXE6IEF1dGhSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIGNvbnN0IGZsZWV0SWQgPSBTdHJpbmcocmVxLnBhcmFtcy5pZCB8fCAnJykudHJpbSgpO1xuICBpZiAoIWZsZWV0SWQpIHtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5CQURfUkVRVUVTVCkuanNvbih7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIGVycm9yOiAnSW52YWxpZCBmbGVldCBpZCdcbiAgICB9KTtcbiAgfVxuXG4gIGNvbnN0IHVzZXIgPSByZXEudXNlciEgYXMgYW55O1xuICBcbiAgLy8gUmVzb2x2ZSBlbXBpcmUgdXNpbmcgZXN0YWJsaXNoZWQgcGF0dGVybiAoRlItMTQpXG4gIGNvbnN0IGVtcGlyZVJvdyA9IGF3YWl0IEVtcGlyZVJlc29sdXRpb25TZXJ2aWNlLnJlc29sdmVFbXBpcmVCeVVzZXJPYmplY3QodXNlcik7XG4gIGlmICghZW1waXJlUm93KSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuTk9UX0ZPVU5EKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6IEVSUk9SX01FU1NBR0VTLkVNUElSRV9OT1RfRk9VTkRcbiAgICB9KTtcbiAgfVxuXG4gIGNvbnN0IGVtcGlyZUlkID0gU3RyaW5nKGVtcGlyZVJvdy5pZCk7XG4gIGNvbnN0IGVtcGlyZU5hbWUgPSBTdHJpbmcoKGVtcGlyZVJvdyBhcyBhbnkpLm5hbWUgfHwgJ1Vua25vd24nKTtcblxuICAvLyBRdWVyeSBmbGVldCBieSBJRCB3aXRoIGVtcGlyZSBvd25lcnNoaXAgY2hlY2tcbiAgY29uc3QgeyBkYXRhOiBmbGVldCwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgLmZyb20oREJfVEFCTEVTLkZMRUVUUylcbiAgICAuc2VsZWN0KCdpZCwgbmFtZSwgbG9jYXRpb25fY29vcmQsIHVuaXRzLCBzaXplX2NyZWRpdHMnKVxuICAgIC5lcShEQl9GSUVMRFMuQlVJTERJTkdTLklELCBmbGVldElkKVxuICAgIC5lcShEQl9GSUVMRFMuQlVJTERJTkdTLkVNUElSRV9JRCwgZW1waXJlSWQpXG4gICAgLnNpbmdsZSgpO1xuXG4gIGlmIChlcnJvcikge1xuICAgIGlmIChlcnJvci5jb2RlID09PSAnUEdSU1QxMTYnKSB7IC8vIE5vIHJvd3MgcmV0dXJuZWRcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLk5PVF9GT1VORCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogRVJST1JfTUVTU0FHRVMuRkxFRVRfTk9UX0ZPVU5EXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuSU5URVJOQUxfU0VSVkVSX0VSUk9SKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6ICdGYWlsZWQgdG8gZmV0Y2ggZmxlZXQgZGV0YWlscydcbiAgICB9KTtcbiAgfVxuXG4gIC8vIFBhcnNlIGFuZCBmb3JtYXQgZmxlZXQgY29tcG9zaXRpb24gKEZSLTcpXG4gIGNvbnN0IHVuaXRzID0gQXJyYXkuaXNBcnJheShmbGVldC51bml0cykgPyBmbGVldC51bml0cyA6IFtdO1xuICBjb25zdCBjb21wb3NpdGlvbiA9IHVuaXRzLm1hcCgodTogYW55KSA9PiB7XG4gICAgY29uc3QgdW5pdEtleSA9IFN0cmluZyh1Py51bml0S2V5IHx8IHU/LnVuaXRfa2V5IHx8ICcnKTtcbiAgICBsZXQgdW5pdE5hbWUgPSB1bml0S2V5O1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzcGVjID0gZ2V0VW5pdFNwZWModW5pdEtleSBhcyBhbnkpO1xuICAgICAgdW5pdE5hbWUgPSBzcGVjPy5uYW1lIHx8IHVuaXRLZXk7XG4gICAgfSBjYXRjaCB7XG4gICAgICAvLyBGYWxsYmFjayB0byBrZXkgaWYgc3BlYyBub3QgZm91bmRcbiAgICB9XG4gICAgcmV0dXJuIHsgXG4gICAgICB1bml0S2V5LCBcbiAgICAgIG5hbWU6IHVuaXROYW1lLCBcbiAgICAgIGNvdW50OiBOdW1iZXIodT8uY291bnQgfHwgMCkgXG4gICAgfTtcbiAgfSk7XG5cbiAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICBzdWNjZXNzOiB0cnVlLFxuICAgIGRhdGE6IHtcbiAgICAgIGZsZWV0OiB7XG4gICAgICAgIF9pZDogU3RyaW5nKGZsZWV0LmlkKSxcbiAgICAgICAgbmFtZTogU3RyaW5nKGZsZWV0Lm5hbWUpLFxuICAgICAgICBsb2NhdGlvbkNvb3JkOiBTdHJpbmcoZmxlZXQubG9jYXRpb25fY29vcmQgfHwgJycpLFxuICAgICAgICBvd25lck5hbWU6IGVtcGlyZU5hbWUsXG4gICAgICAgIHVuaXRzOiBjb21wb3NpdGlvbixcbiAgICAgICAgc2l6ZUNyZWRpdHM6IE51bWJlcihmbGVldC5zaXplX2NyZWRpdHMgfHwgMCksXG4gICAgICB9XG4gICAgfVxuICB9KTtcbn0pKTtcblxuLyoqXG4gKiBJbml0aWF0ZSBmbGVldCBtb3ZlbWVudCB0byBhIGRlc3RpbmF0aW9uXG4gKiBQT1NUIC9hcGkvZ2FtZS9mbGVldHMvOmlkL21vdmVcbiAqIEJvZHk6IHsgZGVzdGluYXRpb25Db29yZDogc3RyaW5nIH1cbiAqIFxuICogSW1wbGVtZW50cyBGUi00OiBGbGVldCBtb3ZlbWVudCBlbmRwb2ludCB0byBpbml0aWF0ZSBmbGVldCBtb3ZlbWVudFxuICogXG4gKiBSZXF1ZXN0IEJvZHk6IHsgZGVzdGluYXRpb25Db29yZDogc3RyaW5nIH1cbiAqIFJlc3BvbnNlIERUTzogeyBcbiAqICAgc3VjY2VzczogYm9vbGVhbiwgXG4gKiAgIGRhdGE6IHsgbW92ZW1lbnQ6IGFueSB9LCBcbiAqICAgbWVzc2FnZT86IHN0cmluZyxcbiAqICAgZXJyb3I/OiBzdHJpbmcsXG4gKiAgIGNvZGU/OiBzdHJpbmdcbiAqIH1cbiAqL1xucm91dGVyLnBvc3QoJy86aWQvbW92ZScsIGFzeW5jSGFuZGxlcihhc3luYyAocmVxOiBBdXRoUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICBjb25zdCBmbGVldElkID0gU3RyaW5nKHJlcS5wYXJhbXMuaWQgfHwgJycpLnRyaW0oKTtcbiAgaWYgKCFmbGVldElkKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuQkFEX1JFUVVFU1QpLmpzb24oe1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjogJ0ludmFsaWQgZmxlZXQgaWQnXG4gICAgfSk7XG4gIH1cblxuICAvLyBWYWxpZGF0ZSByZXF1ZXN0IGJvZHlcbiAgY29uc3QgeyBkZXN0aW5hdGlvbkNvb3JkIH0gPSByZXEuYm9keSBhcyB7IGRlc3RpbmF0aW9uQ29vcmQ/OiBzdHJpbmcgfTtcbiAgaWYgKCFkZXN0aW5hdGlvbkNvb3JkIHx8IHR5cGVvZiBkZXN0aW5hdGlvbkNvb3JkICE9PSAnc3RyaW5nJykge1xuICAgIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLkJBRF9SRVFVRVNUKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6ICdkZXN0aW5hdGlvbkNvb3JkIGlzIHJlcXVpcmVkJ1xuICAgIH0pO1xuICB9XG5cbiAgY29uc3QgdXNlciA9IHJlcS51c2VyISBhcyBhbnk7XG4gIFxuICAvLyBSZXNvbHZlIGVtcGlyZSB1c2luZyBlc3RhYmxpc2hlZCBwYXR0ZXJuIChGUi0xNClcbiAgY29uc3QgZW1waXJlUm93ID0gYXdhaXQgRW1waXJlUmVzb2x1dGlvblNlcnZpY2UucmVzb2x2ZUVtcGlyZUJ5VXNlck9iamVjdCh1c2VyKTtcbiAgaWYgKCFlbXBpcmVSb3cpIHtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5OT1RfRk9VTkQpLmpzb24oe1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjogRVJST1JfTUVTU0FHRVMuRU1QSVJFX05PVF9GT1VORFxuICAgIH0pO1xuICB9XG5cbiAgY29uc3QgZW1waXJlSWQgPSBTdHJpbmcoZW1waXJlUm93LmlkKTtcblxuICB0cnkge1xuICAgIC8vIFVzZSBleGlzdGluZyBGbGVldE1vdmVtZW50U2VydmljZSB0byBoYW5kbGUgdGhlIGZsZWV0IGRpc3BhdGNoXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgRmxlZXRNb3ZlbWVudFNlcnZpY2UuZGlzcGF0Y2hGbGVldChcbiAgICAgIGZsZWV0SWQsXG4gICAgICBlbXBpcmVJZCxcbiAgICAgIHsgZGVzdGluYXRpb25Db29yZCB9XG4gICAgKTtcblxuICAgIGlmICghcmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgIC8vIE1hcCBzZXJ2aWNlIGVycm9yIGNvZGVzIHRvIGFwcHJvcHJpYXRlIEhUVFAgc3RhdHVzIGNvZGVzIChGUi0xNSlcbiAgICAgIGxldCBzdGF0dXNDb2RlOiBudW1iZXIgPSBIVFRQX1NUQVRVUy5CQURfUkVRVUVTVDsgLy8gRGVmYXVsdCB0byBiYWQgcmVxdWVzdFxuICAgICAgc3dpdGNoIChyZXN1bHQuY29kZSkge1xuICAgICAgICBjYXNlICdGTEVFVF9OT1RfRk9VTkQnOlxuICAgICAgICAgIHN0YXR1c0NvZGUgPSBIVFRQX1NUQVRVUy5OT1RfRk9VTkQ7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ0VNUFRZX0ZMRUVUJzpcbiAgICAgICAgY2FzZSAnRkxFRVRfQUxSRUFEWV9NT1ZJTkcnOlxuICAgICAgICBjYXNlICdBTFJFQURZX0FUX0RFU1RJTkFUSU9OJzpcbiAgICAgICAgY2FzZSAnSU5WQUxJRF9ERVNUSU5BVElPTic6XG4gICAgICAgICAgc3RhdHVzQ29kZSA9IEhUVFBfU1RBVFVTLkJBRF9SRVFVRVNUO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdESVNQQVRDSF9FUlJPUic6XG4gICAgICAgICAgc3RhdHVzQ29kZSA9IEhUVFBfU1RBVFVTLklOVEVSTkFMX1NFUlZFUl9FUlJPUjtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBzdGF0dXNDb2RlID0gSFRUUF9TVEFUVVMuQkFEX1JFUVVFU1Q7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXMuc3RhdHVzKHN0YXR1c0NvZGUpLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IHJlc3VsdC5lcnJvciB8fCAnRmFpbGVkIHRvIG1vdmUgZmxlZXQnXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBTdWNjZXNzIHJlc3BvbnNlIChGUi0xMilcbiAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IHsgbW92ZW1lbnQ6IHJlc3VsdC5tb3ZlbWVudCB9LFxuICAgICAgbWVzc2FnZTogJ0ZsZWV0IG1vdmVtZW50IGluaXRpYXRlZCBzdWNjZXNzZnVsbHknXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW5pdGlhdGluZyBmbGVldCBtb3ZlbWVudDonLCBlcnJvcik7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuSU5URVJOQUxfU0VSVkVSX0VSUk9SKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6ICdGYWlsZWQgdG8gaW5pdGlhdGUgZmxlZXQgbW92ZW1lbnQnXG4gICAgfSk7XG4gIH1cbn0pKTtcblxuZXhwb3J0IGRlZmF1bHQgcm91dGVyO1xuXG5cblxuXG4iXSwidmVyc2lvbiI6M30=