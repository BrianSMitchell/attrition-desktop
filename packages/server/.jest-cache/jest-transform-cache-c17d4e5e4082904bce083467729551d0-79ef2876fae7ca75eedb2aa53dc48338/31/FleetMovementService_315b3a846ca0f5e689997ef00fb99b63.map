{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\services\\fleets\\FleetMovementService.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\services\\fleets\\FleetMovementService.ts"],"sourcesContent":["import { supabase } from '../../config/supabase';\nimport { getIO } from '../../index';\nimport { ERROR_MESSAGES } from '../../constants/response-formats';\nimport { DB_TABLES, DB_FIELDS } from '../../constants/database-fields';\nimport { getUnitSpec } from '@game/shared';\nexport interface CoordinateParsed {\n  server: string;\n  galaxy: number;\n  region: number;\n  system: number;\n  body: number;\n}\n\nexport interface FleetDispatchRequest {\n  destinationCoord: string;\n}\n\nexport interface FleetDispatchResult {\n  success: boolean;\n  movement?: any;\n  error?: string;\n  code?: string;\n}\n\nexport interface FleetStatusResult {\n  success: boolean;\n  fleet?: any;\n  movement?: any;\n  error?: string;\n}\n\nexport interface FleetRecallResult {\n  success: boolean;\n  movement?: any;\n  error?: string;\n  code?: string;\n}\n\nexport class FleetMovementService {\n  /**\n   * Parse coordinate string into components\n   */\n  static parseCoordinate(coord: string): CoordinateParsed {\n    const match = coord.match(/^([A-Z])(\\d{2}):(\\d{2}):(\\d{2}):(\\d{2})$/);\n    if (!match) {\n      throw new Error(`Invalid coordinate format: ${coord}`);\n    }\n\n    return {\n      server: match[1],\n      galaxy: parseInt(match[2], 10),\n      region: parseInt(match[3], 10),\n      system: parseInt(match[4], 10),\n      body: parseInt(match[5], 10),\n    };\n  }\n\n  /**\n   * Calculate distance between two coordinates\n   */\n  static calculateDistance(from: string, to: string): number {\n    const fromCoord = this.parseCoordinate(from);\n    const toCoord = this.parseCoordinate(to);\n\n    // Calculate distance using galactic coordinate system\n    // Galaxy level = 1000 units, Region = 100 units, System = 10 units, Body = 1 unit\n    const galaxyDist = Math.abs(fromCoord.galaxy - toCoord.galaxy) * 1000;\n    const regionDist = Math.abs(fromCoord.region - toCoord.region) * 100;\n    const systemDist = Math.abs(fromCoord.system - toCoord.system) * 10;\n    const bodyDist = Math.abs(fromCoord.body - toCoord.body) * 1;\n\n    // Use largest distance as base (only travel the farthest distance needed)\n    return Math.max(galaxyDist, regionDist, systemDist, bodyDist);\n  }\n\n  /**\n   * Calculate fleet speed based on slowest unit\n   */\n  static calculateFleetSpeed(units: Array<{ unitKey: string; count: number }>): number {\n    let slowestSpeed = Infinity;\n\n    for (const unit of units) {\n      if (unit.count > 0) {\n        const unitSpec = getUnitSpec(unit.unitKey as any);\n        if (unitSpec && unitSpec.speed !== undefined) {\n          slowestSpeed = Math.min(slowestSpeed, unitSpec.speed);\n        }\n      }\n    }\n\n    // Default speed if no units have speed defined\n    return slowestSpeed === Infinity ? 1 : slowestSpeed;\n  }\n\n  /**\n   * Calculate travel time in hours\n   */\n  static calculateTravelTime(distance: number, fleetSpeed: number): number {\n    // Base travel time formula: distance / (speed * speedMultiplier)\n    const baseSpeedMultiplier = 10; // Adjust this to balance travel times\n    const travelTimeHours = distance / (fleetSpeed * baseSpeedMultiplier);\n\n    // Minimum travel time of 5 minutes\n    return Math.max(travelTimeHours, 0.083);\n  }\n\n  /**\n   * Validate destination coordinate\n   */\n  static async validateDestination(destinationCoord: string, empireId: string): Promise<{ valid: boolean; error?: string }> {\n    try {\n      // Parse coordinate format\n      this.parseCoordinate(destinationCoord);\n\n      // Check if destination exists in universe\n      const { data: location, error } = await supabase\n        .from(DB_TABLES.LOCATIONS)\n        .select('coord')\n        .eq('coord', destinationCoord)\n        .maybeSingle();\n\n      if (error || !location) {\n        return { valid: false, error: 'Destination does not exist in the universe' };\n      }\n\n      // For now, allow movement to any location\n      return { valid: true };\n    } catch (error) {\n      return { valid: false, error: 'Invalid coordinate format' };\n    }\n  }\n\n  /**\n   * Dispatch a fleet to a new location\n   */\n  static async dispatchFleet(\n    fleetId: string,\n    empireId: string,\n    request: FleetDispatchRequest\n  ): Promise<FleetDispatchResult> {\n    try {\n      // Find the fleet\n      const { data: fleet, error: fleetError } = await supabase\n        .from(DB_TABLES.FLEETS)\n        .select('*')\n        .eq(DB_FIELDS.BUILDINGS.ID, fleetId)\n        .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n        .maybeSingle();\n\n      if (fleetError || !fleet) {\n        return {\n          success: false,\n          error: ERROR_MESSAGES.FLEET_NOT_FOUND,\n          code: 'FLEET_NOT_FOUND',\n        };\n      }\n\n      // Check if fleet has any units\n      const units = fleet.units || [];\n      if (!units.length || units.every((u: any) => u.count === 0)) {\n        return {\n          success: false,\n          error: 'Fleet has no units to dispatch',\n          code: 'EMPTY_FLEET',\n        };\n      }\n\n      // Check if fleet is already moving\n      const { data: existingMovement, error: movementCheckError } = await supabase\n        .from(DB_TABLES.FLEET_MOVEMENTS)\n        .select(DB_FIELDS.BUILDINGS.ID)\n        .eq(DB_FIELDS.FLEET_MOVEMENTS.FLEET_ID, fleetId)\n        .in(DB_FIELDS.TECH_QUEUE.STATUS, ['pending', 'travelling'])\n        .maybeSingle();\n\n      if (movementCheckError) {\n        console.error('Error checking for existing movement:', movementCheckError);\n      }\n\n      if (existingMovement) {\n        return {\n          success: false,\n          error: 'Fleet is already moving',\n          code: 'FLEET_ALREADY_MOVING',\n        };\n      }\n\n      // Validate destination\n      const destinationValidation = await this.validateDestination(request.destinationCoord, empireId);\n      if (!destinationValidation.valid) {\n        return {\n          success: false,\n          error: destinationValidation.error || 'Invalid destination',\n          code: 'INVALID_DESTINATION',\n        };\n      }\n\n      // Can't move to same location\n      if (fleet.location_coord === request.destinationCoord) {\n        return {\n          success: false,\n          error: 'Fleet is already at the destination',\n          code: 'ALREADY_AT_DESTINATION',\n        };\n      }\n\n      // Calculate movement parameters\n      const distance = this.calculateDistance(fleet.location_coord, request.destinationCoord);\n      const fleetSpeed = this.calculateFleetSpeed(units);\n      const travelTimeHours = this.calculateTravelTime(distance, fleetSpeed);\n\n      const departureTime = new Date();\n      const estimatedArrivalTime = new Date(departureTime.getTime() + travelTimeHours * 60 * 60 * 1000);\n\n      // Create movement record\n      const { data: movement, error: createError } = await supabase\n        .from(DB_TABLES.FLEET_MOVEMENTS)\n        .insert({\n          empire_id: empireId,\n          fleet_id: fleetId,\n          origin_coord: fleet.location_coord,\n          destination_coord: request.destinationCoord,\n          units: units,\n          size_credits: fleet.size_credits,\n          departure_time: departureTime.toISOString(),\n          estimated_arrival_time: estimatedArrivalTime.toISOString(),\n          status: 'travelling',\n          travel_time_hours: travelTimeHours,\n          fleet_speed: fleetSpeed,\n          distance: distance,\n        })\n        .select()\n        .single();\n\n      if (createError) {\n        console.error('Error creating fleet movement:', createError);\n        return {\n          success: false,\n          error: 'Failed to dispatch fleet',\n          code: 'DISPATCH_ERROR',\n        };\n      }\n\n      // Emit socket event for fleet movement start\n      const socket = getIO();\n      if (socket) {\n        socket.to(`empire:${empireId}`).emit('fleet:movement', {\n          fleetId: fleetId,\n          originCoord: movement.origin_coord,\n          destinationCoord: movement.destination_coord,\n          departureTime: movement.departure_time,\n          estimatedArrivalTime: movement.estimated_arrival_time,\n          travelTimeHours: movement.travel_time_hours,\n          status: movement.status,\n        });\n      }\n\n      return {\n        success: true,\n        movement,\n      };\n    } catch (error) {\n      console.error('Error dispatching fleet:', error);\n      return {\n        success: false,\n        error: 'Failed to dispatch fleet',\n        code: 'DISPATCH_ERROR',\n      };\n    }\n  }\n\n  /**\n   * Get fleet status including movement information\n   */\n  static async getFleetStatus(fleetId: string, empireId: string): Promise<FleetStatusResult> {\n    try {\n      // Find the fleet\n      const { data: fleet, error: fleetError } = await supabase\n        .from(DB_TABLES.FLEETS)\n        .select('*')\n        .eq(DB_FIELDS.BUILDINGS.ID, fleetId)\n        .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n        .maybeSingle();\n\n      if (fleetError || !fleet) {\n        return {\n          success: false,\n          error: ERROR_MESSAGES.FLEET_NOT_FOUND,\n        };\n      }\n\n      // Find active movement\n      const { data: movement, error: movementError } = await supabase\n        .from(DB_TABLES.FLEET_MOVEMENTS)\n        .select('*')\n        .eq(DB_FIELDS.FLEET_MOVEMENTS.FLEET_ID, fleetId)\n        .in(DB_FIELDS.TECH_QUEUE.STATUS, ['pending', 'travelling'])\n        .maybeSingle();\n\n      if (movementError) {\n        console.error('Error fetching movement:', movementError);\n      }\n\n      // Get fleet composition with unit details\n      const units = fleet.units || [];\n      const fleetWithDetails = {\n        id: fleet.id,\n        name: fleet.name,\n        locationCoord: fleet.location_coord,\n        units: units.map((unit: any) => {\n          const unitSpec = getUnitSpec(unit.unitKey as any);\n          return {\n            unitKey: unit.unitKey,\n            name: unitSpec?.name || unit.unitKey,\n            count: unit.count,\n          };\n        }),\n        sizeCredits: fleet.size_credits,\n        isMoving: !!movement,\n        movement: movement\n          ? {\n              status: movement.status,\n              originCoord: movement.origin_coord,\n              destinationCoord: movement.destination_coord,\n              departureTime: movement.departure_time,\n              estimatedArrivalTime: movement.estimated_arrival_time,\n              travelTimeHours: movement.travel_time_hours,\n              fleetSpeed: movement.fleet_speed,\n              distance: movement.distance,\n            }\n          : null,\n      };\n\n      return {\n        success: true,\n        fleet: fleetWithDetails,\n        movement: movement || undefined,\n      };\n    } catch (error) {\n      console.error('Error getting fleet status:', error);\n      return {\n        success: false,\n        error: 'Failed to get fleet status',\n      };\n    }\n  }\n\n  /**\n   * Recall a fleet (if it hasn't arrived yet)\n   */\n  static async recallFleet(fleetId: string, empireId: string, reason?: string): Promise<FleetRecallResult> {\n    try {\n      // Find active movement\n      const { data: movement, error: findError } = await supabase\n        .from(DB_TABLES.FLEET_MOVEMENTS)\n        .select('*')\n        .eq(DB_FIELDS.FLEET_MOVEMENTS.FLEET_ID, fleetId)\n        .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n        .in(DB_FIELDS.TECH_QUEUE.STATUS, ['pending', 'travelling'])\n        .maybeSingle();\n\n      if (findError || !movement) {\n        return {\n          success: false,\n          error: 'No active movement found for this fleet',\n          code: 'NO_ACTIVE_MOVEMENT',\n        };\n      }\n\n      // Check if fleet has already arrived\n      if (movement.status === 'arrived') {\n        return {\n          success: false,\n          error: 'Fleet has already arrived and cannot be recalled',\n          code: 'ALREADY_ARRIVED',\n        };\n      }\n\n      // Update movement status to recalled\n      const { data: updatedMovement, error: updateError } = await supabase\n        .from(DB_TABLES.FLEET_MOVEMENTS)\n        .update({\n          status: 'recalled',\n          recall_time: new Date().toISOString(),\n          recall_reason: reason || 'Recalled by player',\n        })\n        .eq(DB_FIELDS.BUILDINGS.ID, movement.id)\n        .select()\n        .single();\n\n      if (updateError) {\n        console.error('Error recalling fleet:', updateError);\n        return {\n          success: false,\n          error: 'Failed to recall fleet',\n          code: 'RECALL_ERROR',\n        };\n      }\n\n      return {\n        success: true,\n        movement: updatedMovement,\n      };\n    } catch (error) {\n      console.error('Error recalling fleet:', error);\n      return {\n        success: false,\n        error: 'Failed to recall fleet',\n        code: 'RECALL_ERROR',\n      };\n    }\n  }\n\n  /**\n   * Process fleet arrivals (to be called by a background job)\n   */\n  static async processArrivals(): Promise<void> {\n    try {\n      const currentTime = new Date();\n\n      // Find all movements that should have arrived\n      const { data: arrivals, error } = await supabase\n        .from(DB_TABLES.FLEET_MOVEMENTS)\n        .select('*')\n        .eq(DB_FIELDS.TECH_QUEUE.STATUS, 'travelling')\n        .lte('estimated_arrival_time', currentTime.toISOString());\n\n      if (error) {\n        console.error('Error fetching fleet arrivals:', error);\n        return;\n      }\n\n      for (const movement of arrivals || []) {\n        await this.processArrival(movement);\n      }\n    } catch (error) {\n      console.error('Error processing fleet arrivals:', error);\n    }\n  }\n\n  /**\n   * Process a single fleet arrival\n   */\n  private static async processArrival(movement: any): Promise<void> {\n    try {\n      // Update fleet location\n      const { error: fleetUpdateError } = await supabase\n        .from(DB_TABLES.FLEETS)\n        .update({ location_coord: movement.destination_coord })\n        .eq(DB_FIELDS.BUILDINGS.ID, movement.fleet_id);\n\n      if (fleetUpdateError) {\n        console.error(`Error updating fleet location for movement ${movement.id}:`, fleetUpdateError);\n        return;\n      }\n\n      // Update movement status\n      const { error: movementUpdateError } = await supabase\n        .from(DB_TABLES.FLEET_MOVEMENTS)\n        .update({\n          status: 'arrived',\n          actual_arrival_time: new Date().toISOString(),\n        })\n        .eq(DB_FIELDS.BUILDINGS.ID, movement.id);\n\n      if (movementUpdateError) {\n        console.error(`Error updating movement status for ${movement.id}:`, movementUpdateError);\n        return;\n      }\n\n      // Emit WebSocket event for fleet arrival\n      const socket = getIO();\n      if (socket) {\n        socket.to(`empire:${movement.empire_id}`).emit('fleet:arrived', {\n          fleetId: movement.fleet_id,\n          destinationCoord: movement.destination_coord,\n          arrivalTime: new Date().toISOString(),\n        });\n      }\n\n      console.log(`✈️  Fleet ${movement.fleet_id} arrived at ${movement.destination_coord}`);\n    } catch (error) {\n      console.error(`Error processing arrival for movement ${movement.id}:`, error);\n    }\n  }\n}\n\n\n"],"version":3}