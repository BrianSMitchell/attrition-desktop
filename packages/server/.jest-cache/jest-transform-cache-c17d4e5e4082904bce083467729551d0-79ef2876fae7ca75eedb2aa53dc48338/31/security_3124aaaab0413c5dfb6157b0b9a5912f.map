{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\routes\\security.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\routes\\security.ts"],"sourcesContent":["import { Router, Response } from 'express';\r\nimport { asyncHandler } from '../middleware/errorHandler';\r\nimport { authenticate, AuthRequest } from '../middleware/auth';\r\nimport { authRateLimit } from '../middleware/rateLimiting';\r\nimport { securityMonitor, SecurityEventType } from '../utils/securityMonitor';\r\nimport { HTTP_STATUS } from '../constants/response-formats';\r\nimport { API_ENDPOINTS } from '../constants/api-endpoints';\r\nimport jwt from 'jsonwebtoken';\n\r\n\r\nconst router: Router = Router();\r\n\r\n// All security endpoints require authentication and are rate limited\r\nrouter.use(authenticate);\r\nrouter.use(authRateLimit);\r\n\r\n/**\r\n * Get security statistics and metrics\r\n */\r\nrouter.get('/stats', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const timeWindow = parseInt(req.query.hours as string) || 24;\r\n  const timeWindowMs = timeWindow * 60 * 60 * 1000;\r\n\r\n  const stats = securityMonitor.getStatistics(timeWindowMs);\r\n  \r\n  res.json({\r\n    success: true,\r\n    data: {\r\n      timeWindow: `${timeWindow} hours`,\r\n      ...stats,\r\n      timestamp: new Date().toISOString()\r\n    }\r\n  });\r\n}));\r\n\r\n/**\r\n * Get active security alerts\r\n */\r\nrouter.get('/alerts', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const activeAlerts = securityMonitor.getActiveAlerts();\r\n  \r\n  res.json({\r\n    success: true,\r\n    data: {\r\n      alerts: activeAlerts,\r\n      count: activeAlerts.length,\r\n      timestamp: new Date().toISOString()\r\n    }\r\n  });\r\n}));\r\n\r\n/**\r\n * Get security events for the current user\r\n */\r\nrouter.get('/events', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const userId = (req.user as any)._id.toString();\r\n  const limit = parseInt(req.query.limit as string) || 50;\r\n  const hours = parseInt(req.query.hours as string) || 24;\r\n  \r\n  // Get recent events for this user\r\n  const cutoff = Date.now() - (hours * 60 * 60 * 1000);\r\n  const userEvents = (securityMonitor as any).events\r\n    .filter((e: any) => \r\n      e.userId === userId && \r\n      e.timestamp.getTime() > cutoff\r\n    )\r\n    .sort((a: any, b: any) => b.timestamp.getTime() - a.timestamp.getTime())\r\n    .slice(0, limit);\r\n\r\n  res.json({\r\n    success: true,\r\n    data: {\r\n      events: userEvents,\r\n      count: userEvents.length,\r\n      timeWindow: `${hours} hours`,\r\n      userId,\r\n      timestamp: new Date().toISOString()\r\n    }\r\n  });\r\n}));\r\n\r\n/**\r\n * Get current user's active sessions\r\n */\r\nrouter.get('/sessions', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const userId = (req.user as any)._id.toString();\r\n  \r\n  // Access private userSessions map\r\n  const userSessions = (securityMonitor as any).userSessions.get(userId) || [];\r\n  const activeSessions = userSessions.filter((s: any) => s.isActive);\r\n  \r\n  // Sanitize session data for response\r\n  const sanitizedSessions = activeSessions.map((session: any) => ({\r\n    sessionId: session.sessionId,\r\n    ip: session.ip,\r\n    userAgent: session.userAgent,\r\n    loginTime: session.loginTime,\r\n    lastActivity: session.lastActivity,\r\n    deviceFingerprint: {\r\n      hash: session.deviceFingerprint.hash.substring(0, 8) + '...',\r\n      userAgent: session.deviceFingerprint.userAgent.substring(0, 50),\r\n      acceptLanguage: session.deviceFingerprint.acceptLanguage,\r\n      ipNetwork: session.deviceFingerprint.ipNetwork\r\n    }\r\n  }));\r\n\r\n  res.json({\r\n    success: true,\r\n    data: {\r\n      sessions: sanitizedSessions,\r\n      count: sanitizedSessions.length,\r\n      userId,\r\n      timestamp: new Date().toISOString()\r\n    }\r\n  });\r\n}));\r\n\r\n/**\r\n * Revoke a specific session (security action)\r\n */\r\nrouter.delete('/sessions/:sessionId', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const userId = (req.user as any)._id.toString();\r\n  const sessionId = req.params.sessionId;\r\n  \r\n  if (!sessionId) {\r\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({\r\n      success: false,\r\n      error: 'Session ID is required'\r\n    });\r\n  }\r\n  \r\n  // Find and revoke the session\r\n  const userSessions = (securityMonitor as any).userSessions.get(userId) || [];\r\n  const session = userSessions.find((s: any) => s.sessionId === sessionId && s.isActive);\r\n  \r\n  if (!session) {\r\n    return res.status(HTTP_STATUS.NOT_FOUND).json({\r\n      success: false,\r\n      error: 'Session not found or already inactive'\r\n    });\r\n  }\r\n  \r\n  // Revoke the session\r\n  securityMonitor.revokeSession(session);\r\n  \r\n  res.json({\r\n    success: true,\r\n    message: 'Session revoked successfully',\r\n    data: {\r\n      sessionId,\r\n      revokedAt: new Date().toISOString()\r\n    }\r\n  });\r\n}));\r\n\r\n/**\r\n * Revoke all sessions except current (logout from all other devices)\r\n */\r\nrouter.delete('/sessions', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const userId = (req.user as any)._id.toString();\r\n  const currentToken = req.headers.authorization?.split(' ')[1];\r\n  \r\n  if (!currentToken) {\r\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({\r\n      success: false,\r\n      error: 'Current token not found'\r\n    });\r\n  }\r\n  \r\n  // Get current token JTI to preserve current session\r\n  const currentTokenDecoded = jwt.decode(currentToken) as { jti?: string };\r\n  const currentJti = currentTokenDecoded?.jti;\r\n  \r\n  // Find and revoke all other sessions\r\n  const userSessions = (securityMonitor as any).userSessions.get(userId) || [];\r\n  let revokedCount = 0;\r\n  \r\n  for (const session of userSessions) {\r\n    if (session.isActive && session.tokenJti !== currentJti) {\r\n      securityMonitor.revokeSession(session);\r\n      revokedCount++;\r\n    }\r\n  }\r\n  \r\n  res.json({\r\n    success: true,\r\n    message: `${revokedCount} sessions revoked successfully`,\r\n    data: {\r\n      revokedSessions: revokedCount,\r\n      currentSessionPreserved: !!currentJti,\r\n      revokedAt: new Date().toISOString()\r\n    }\r\n  });\r\n}));\r\n\r\n/**\r\n * Security health check endpoint\r\n */\r\nrouter.get(API_ENDPOINTS.SYSTEM.HEALTH, asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const stats = securityMonitor.getStatistics(60 * 60 * 1000); // Last hour\r\n  const activeAlerts = securityMonitor.getActiveAlerts();\r\n  \r\n  const health = {\r\n    status: 'healthy',\r\n    checks: {\r\n      monitoringActive: true,\r\n      alertsCount: activeAlerts.length,\r\n      eventsProcessed: stats.totalEvents,\r\n      highRiskEvents: stats.riskDistribution.critical + stats.riskDistribution.high\r\n    }\r\n  };\r\n  \r\n  // Determine overall health status\r\n  if (activeAlerts.length > 10) {\r\n    health.status = 'warning';\r\n  }\r\n  if (activeAlerts.length > 50 || health.checks.highRiskEvents > 100) {\r\n    health.status = 'critical';\r\n  }\r\n  \r\n  res.json({\r\n    success: true,\r\n    data: health,\r\n    timestamp: new Date().toISOString()\r\n  });\r\n}));\r\n\r\n/**\r\n * Record a manual security event (for testing or manual reporting)\r\n */\r\nrouter.post('/events', asyncHandler(async (req: AuthRequest, res: Response) => {\r\n  const { type, details } = req.body;\r\n  \r\n  if (!type || !Object.values(SecurityEventType).includes(type)) {\r\n    return res.status(HTTP_STATUS.BAD_REQUEST).json({\r\n      success: false,\r\n      error: 'Valid event type is required',\r\n      validTypes: Object.values(SecurityEventType)\r\n    });\r\n  }\r\n  \r\n  const event = securityMonitor.recordEvent({\r\n    type,\r\n    userId: (req.user as any)._id.toString(),\r\n    ip: req.ip || 'unknown',\r\n    userAgent: req.get('User-Agent') || 'unknown',\r\n    details: details || {}\r\n  });\r\n  \r\n  res.json({\r\n    success: true,\r\n    message: 'Security event recorded',\r\n    data: {\r\n      eventId: event.id,\r\n      type: event.type,\r\n      riskScore: event.riskScore,\r\n      timestamp: event.timestamp\r\n    }\r\n  });\r\n}));\r\n\r\nexport default router;\r\n\r\n\r\n\r\n"],"version":3}