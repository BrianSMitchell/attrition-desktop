{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\services\\hybridGameLoopService.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\services\\hybridGameLoopService.ts"],"sourcesContent":["import { supabase } from '../config/supabase';\n\n// Constants imports for eliminating hardcoded values\nimport { DB_TABLES, DB_FIELDS } from '../constants/database-fields';\n\nimport { ResourceService } from './resources/ResourceService';\nimport { BuildingService } from './buildingService';\nimport { CapacityService } from './bases/CapacityService';\nimport { TechService } from './tech/TechService';\nimport { getTechSpec, getTechCreditCostForLevel, getUnitSpec } from '@game/shared';\nimport { emitFleetUpdate } from '../utils/socketManager';\nimport { FleetMovementService } from './fleets/FleetMovementService';\nimport { SupabaseCompletionService } from './completionService';\nimport { CitizenService } from './bases/CitizenService';\n\nimport { STATUS_CODES } from '@game/shared';\nimport { ENV_VARS } from '@game/shared';\nimport { EconomyService } from '../services/economy/EconomyService';\n\nexport class HybridGameLoopService {\n  private static instance: HybridGameLoopService;\n  private completionCheckInterval: NodeJS.Timeout | null = null;\n  private resourceUpdateInterval: NodeJS.Timeout | null = null;\n  private maintenanceInterval: NodeJS.Timeout | null = null;\n  private isRunning = false;\n\n  private constructor() {}\n\n  static getInstance(): HybridGameLoopService {\n    if (!HybridGameLoopService.instance) {\n      HybridGameLoopService.instance = new HybridGameLoopService();\n    }\n    return HybridGameLoopService.instance;\n  }\n\n  /**\n   * Start the hybrid game loop with different intervals for different systems\n   */\n  start(): void {\n    if (this.isRunning) {\n      if (process.env[ENV_VARS.DEBUG_RESOURCES] === 'true') {\n        console.log('Hybrid game loop is already running');\n      }\n      return;\n    }\n\n    if (process.env[ENV_VARS.DEBUG_RESOURCES] === 'true') {\n      console.log('üéÆ Starting HYBRID game loop with optimized intervals');\n    }\n    this.isRunning = true;\n\n    // CRITICAL SYSTEMS: Check completions frequently (10 seconds)\n    // This makes the game feel responsive for unit/tech completions\n    this.completionCheckInterval = setInterval(async () => {\n      try {\n        await this.processCompletions();\n      } catch (error) {\n        console.error('Error in completion processing:', error);\n      }\n    }, 10000); // 10 seconds - much more responsive!\n\n    // RESOURCE SYSTEMS: Update resources moderately (60 seconds) \n    // Resources don't need to be instant - 1 minute is fine\n    this.resourceUpdateInterval = setInterval(async () => {\n      try {\n        await this.updateEmpireResources();\n      } catch (error) {\n        console.error('Error in resource updates:', error);\n      }\n    }, 60000); // 1 minute\n\n    // MAINTENANCE SYSTEMS: Run cleanup infrequently (5 minutes)\n    // Things like research completion, cleanup, etc.\n    this.maintenanceInterval = setInterval(async () => {\n      try {\n        await this.processMaintenanceTasks();\n      } catch (error) {\n        console.error('Error in maintenance tasks:', error);\n      }\n    }, 300000); // 5 minutes\n\n    if (process.env[ENV_VARS.DEBUG_RESOURCES] === 'true') {\n      console.log('‚úÖ Hybrid game loop started:');\n      console.log('   üîÑ Completions: Every 10 seconds (responsive)');\n      console.log('   üí∞ Resources: Every 60 seconds (efficient)');\n      console.log('   üßπ Maintenance: Every 5 minutes (lightweight)');\n    }\n  }\n\n  /**\n   * Stop all game loop intervals\n   */\n  stop(): void {\n    if (this.completionCheckInterval) {\n      clearInterval(this.completionCheckInterval);\n      this.completionCheckInterval = null;\n    }\n    if (this.resourceUpdateInterval) {\n      clearInterval(this.resourceUpdateInterval);\n      this.resourceUpdateInterval = null;\n    }\n    if (this.maintenanceInterval) {\n      clearInterval(this.maintenanceInterval);\n      this.maintenanceInterval = null;\n    }\n    \n    this.isRunning = false;\n    if (process.env[ENV_VARS.DEBUG_RESOURCES] === 'true') {\n      console.log('üõë Hybrid game loop stopped');\n    }\n  }\n\n  /**\n   * REAL-TIME: Check for completions when user is actively playing\n   * Call this whenever a user performs an action (login, build, etc.)\n   */\n  async checkUserCompletions(empireId: string): Promise<void> {\n    if (process.env[ENV_VARS.DEBUG_RESOURCES] === 'true') {\n      console.log(`üîç Checking completions for active empire: ${empireId}`);\n    }\n    \n    try {\n      const results = await Promise.all([\n        this.processEmpireUnitCompletions(empireId),\n        this.processEmpireTechCompletions(empireId),\n        this.processEmpireBuildingCompletions(empireId),\n        this.processEmpireDefenseCompletions(empireId),\n        this.processEmpireFleetArrivals(empireId)\n      ]);\n\n      const [unitResults, techResults, buildingResults, defenseResults, fleetResults] = results;\n      \n      if (unitResults.completed > 0 || techResults.completed > 0 || buildingResults.completed > 0 || defenseResults.completed > 0 || fleetResults > 0) {\n        console.log(`‚úÖ Immediate completions for empire ${empireId}: units=${unitResults.completed} tech=${techResults.completed} buildings=${buildingResults.completed} defense=${defenseResults.completed} fleets=${fleetResults}`);\n      }\n    } catch (error) {\n      console.error(`Error checking user completions for empire ${empireId}:`, error);\n    }\n  }\n\n  /**\n   * FREQUENT: Process all completion systems (10 second interval)\n   */\n  private async processCompletions(): Promise<void> {\n    try {\n      const [techStats, unitStats, defenseStats, buildingStats, fleetArrivals] = await Promise.all([\n        this.processTechQueue(),\n        this.processUnitQueue(),\n        this.processDefenseQueue(),\n        this.processBuildingQueue(),\n        this.processFleetArrivals()\n      ]);\n\n      // Only log if there was actual activity\n      const totalActivity = techStats.completed + unitStats.completed + defenseStats.completed + buildingStats.activatedCount + fleetArrivals;\n      if (totalActivity > 0) {\n        if (process.env[ENV_VARS.DEBUG_RESOURCES] === 'true') {\n          console.log(\n            `[HybridLoop] completions: tech=${techStats.completed} units=${unitStats.completed} defense=${defenseStats.completed} buildings=${buildingStats.activatedCount} fleets=${fleetArrivals}`\n          );\n        }\n      }\n    } catch (error) {\n      console.error('‚ùå Error in completion processing:', error);\n    }\n  }\n\n  /**\n   * MODERATE: Update empire resources (60 second interval)\n   */\n  private async updateEmpireResources(): Promise<void> {\n    try {\n      // Get all empires that have been active in the last 24 hours\n      const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);\n\n      const { data: activeEmpires, error } = await supabase\n        .from(DB_TABLES.EMPIRES)\n        .select(DB_FIELDS.BUILDINGS.ID)\n        .or(`last_resource_update.gte.${oneDayAgo.toISOString()},last_resource_update.is.null`);\n\n      if (error) {\n        console.error('Error fetching active empires from Supabase:', error);\n        return;\n      }\n\n      let updated = 0;\n      let errors = 0;\n\n      for (const empire of activeEmpires || []) {\n        try {\n          const empireId = empire.id;\nawait ResourceService.updateEmpireResources(empireId);\nawait ResourceService.updateEmpireCreditsAligned(empireId);\n          // Update per-base citizens for this empire\nawait CitizenService.updateEmpireBases(empireId);\n          updated++;\n        } catch (empError) {\n          errors++;\n          console.error(`Error updating resources for empire ${empire.id}:`, empError);\n        }\n      }\n\n      if (process.env[ENV_VARS.DEBUG_RESOURCES] === 'true') {\n        console.log(`[HybridLoop] resources updated: ${updated}/${activeEmpires?.length || 0} empires`);\n      }\n    } catch (error) {\n      console.error('Error in resource updates:', error);\n    }\n  }\n\n  /**\n   * INFREQUENT: Process maintenance tasks (5 minute interval)\n   */\n  private async processMaintenanceTasks(): Promise<void> {\n    if (process.env[ENV_VARS.DEBUG_RESOURCES] === 'true') {\n      console.log('üßπ Running maintenance tasks...');\n    }\n    \n    try {\n      // Complete finished research projects\n      const researchCompleted = await this.completeResearchProjects();\n      \n      // Activate any pending research if credits and capacity are available\n      const techActivated = await this.activatePendingTech();\n\n      if (researchCompleted > 0 || techActivated.activated > 0) {\n        if (process.env[ENV_VARS.DEBUG_RESOURCES] === 'true') {\n          console.log(`[HybridLoop] maintenance: research=${researchCompleted} techActivated=${techActivated.activated}`);\n        }\n      }\n    } catch (error) {\n      console.error('‚ùå Error in maintenance tasks:', error);\n    }\n  }\n\n  // ===== EMPIRE-SPECIFIC COMPLETION METHODS =====\n  \n  /**\n   * Check unit completions for a specific empire\n   */\n  private async processEmpireUnitCompletions(empireId: string): Promise<{ completed: number; errors: number }> {\n    const now = new Date();\n    let completed = 0;\n    let errors = 0;\n\n    try {\n      const { data: dueItems, error } = await supabase\n        .from(DB_TABLES.UNIT_QUEUES)\n        .select('*')\n        .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n        .eq(DB_FIELDS.TECH_QUEUE.STATUS, 'pending')\n        .lte(DB_FIELDS.TECH_QUEUE.COMPLETES_AT, now.toISOString());\n\n      if (error) {\n        console.error('Error fetching due unit items:', error);\n        errors++;\n        return { completed, errors };\n      }\n\n      for (const item of dueItems || []) {\n        try {\n          // Use existing completion logic adapted for Supabase\n          await this.completeUnitItem(item);\n          completed++;\n        } catch (err) {\n          errors++;\n          console.error('Error completing unit for empire:', err);\n        }\n      }\n    } catch (error) {\n      console.error(`Error processing empire ${empireId} unit completions:`, error);\n    }\n\n    return { completed, errors };\n  }\n\n  /**\n   * Check tech completions for a specific empire\n   */\n  private async processEmpireTechCompletions(empireId: string): Promise<{ completed: number; errors: number }> {\n    const now = new Date();\n    let completed = 0;\n    let errors = 0;\n\n    try {\n      const { data: dueItems, error } = await supabase\n        .from(DB_TABLES.TECH_QUEUES)\n        .select('*')\n        .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n        .eq(DB_FIELDS.TECH_QUEUE.STATUS, 'pending')\n        .lte(DB_FIELDS.TECH_QUEUE.COMPLETES_AT, now.toISOString());\n\n      if (error) {\n        console.error('Error fetching due tech items:', error);\n        errors++;\n        return { completed, errors };\n      }\n\n      for (const item of dueItems || []) {\n        try {\n          // Use existing completion logic adapted for Supabase\n          await this.completeTechItem(item);\n          completed++;\n        } catch (err) {\n          errors++;\n          console.error('Error completing tech for empire:', err);\n        }\n      }\n    } catch (error) {\n      console.error(`Error processing empire ${empireId} tech completions:`, error);\n    }\n\n    return { completed, errors };\n  }\n\n  /**\n   * Check building completions for a specific empire\n   */\n  private async processEmpireBuildingCompletions(empireId: string): Promise<{ completed: number; errors: number }> {\n    let completed = 0;\n    let errors = 0;\n\n    try {\n      const now = new Date();\n\n      const { data: buildings, error } = await supabase\n        .from(DB_TABLES.BUILDINGS)\n        .select('*')\n        .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n        .eq(DB_FIELDS.BUILDINGS.IS_ACTIVE, false)\n        .lte(DB_FIELDS.BUILDINGS.CONSTRUCTION_COMPLETED, now.toISOString());\n\n      if (error) {\n        console.error('Error fetching due buildings:', error);\n        errors++;\n        return { completed, errors };\n      }\n\n      for (const building of buildings || []) {\n        try {\n          // Handle upgrade vs new building\n          const newLevel = building.pending_upgrade\n            ? Math.max(1, Number(building.level || 0)) + 1\n            : Math.max(1, Number(building.level || 0));\n\n          // Update building as completed\n          const { error: updateError } = await supabase\n            .from(DB_TABLES.BUILDINGS)\n            .update({\n              level: newLevel,\n              is_active: true,\n              pending_upgrade: false,\n              construction_completed: null\n            })\n            .eq(DB_FIELDS.BUILDINGS.ID, building.id);\n\n          if (updateError) {\n            console.error('Error updating building:', updateError);\n            errors++;\n            continue;\n          }\n\n          completed++;\n\n          // Schedule next queued building at this base\n          try {\n            await BuildingService.scheduleNextQueuedForBase(empireId, building.location_coord);\n          } catch (schedErr) {\n            console.error('Error scheduling next building:', schedErr);\n          }\n        } catch (err) {\n          errors++;\n          console.error('Error completing building for empire:', err);\n        }\n      }\n    } catch (error) {\n      console.error(`Error processing empire ${empireId} building completions:`, error);\n    }\n\n    return { completed, errors };\n  }\n\n  /**\n   * Check defense completions for a specific empire  \n   */\n  private async processEmpireDefenseCompletions(empireId: string): Promise<{ completed: number; errors: number }> {\n    const now = new Date();\n    let completed = 0;\n    let errors = 0;\n\n    try {\n      const { data: dueItems, error } = await supabase\n        .from(DB_TABLES.DEFENSE_QUEUES)\n        .select('*')\n        .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n        .eq(DB_FIELDS.TECH_QUEUE.STATUS, 'pending')\n        .lte(DB_FIELDS.TECH_QUEUE.COMPLETES_AT, now.toISOString());\n\n      if (error) {\n        console.error('Error fetching due defense items:', error);\n        errors++;\n        return { completed, errors };\n      }\n\n      for (const item of dueItems || []) {\n        try {\n          const { error: updateError } = await supabase\n            .from(DB_TABLES.DEFENSE_QUEUES)\n            .update({ status: 'completed' })\n            .eq(DB_FIELDS.BUILDINGS.ID, item.id);\n\n          if (updateError) {\n            console.error('Error updating defense item:', updateError);\n            errors++;\n          } else {\n            completed++;\n          }\n        } catch (err) {\n          errors++;\n          console.error('Error completing defense for empire:', err);\n        }\n      }\n    } catch (error) {\n      console.error(`Error processing empire ${empireId} defense completions:`, error);\n    }\n\n    return { completed, errors };\n  }\n\n  /**\n   * Check fleet arrivals for a specific empire\n   */\n  private async processEmpireFleetArrivals(empireId: string): Promise<number> {\n    const now = new Date();\n    let completed = 0;\n\n    try {\n      const { data: dueArrivals, error } = await supabase\n        .from(DB_TABLES.FLEET_MOVEMENTS)\n        .select('*')\n        .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n        .eq(DB_FIELDS.TECH_QUEUE.STATUS, 'travelling')\n        .lte('estimated_arrival_time', now.toISOString());\n\n      if (error) {\n        console.error('Error fetching due fleet arrivals:', error);\n        return completed;\n      }\n\n      if (dueArrivals && dueArrivals.length > 0) {\n        // Use the existing SupabaseFleetMovementService to process arrivals\nawait FleetMovementService.processArrivals();\n        completed = dueArrivals.length;\n      }\n    } catch (error) {\n      console.error(`Error processing empire ${empireId} fleet arrivals:`, error);\n    }\n\n    return completed;\n  }\n\n  // ===== HELPER METHODS (Extracted from your original code) =====\n\n  private async completeUnitItem(item: any): Promise<void> {\n    // Your existing unit completion logic adapted for Supabase\n    const { data: empire, error: empireError } = await supabase\n      .from(DB_TABLES.EMPIRES)\n      .select('*')\n      .eq(DB_FIELDS.BUILDINGS.ID, item.empire_id)\n      .maybeSingle();\n\n    if (empireError || !empire) {\n      // Mark as cancelled if empire is missing\n      await supabase\n        .from(DB_TABLES.UNIT_QUEUES)\n        .update({ status: 'cancelled' })\n        .eq(DB_FIELDS.BUILDINGS.ID, item.id);\n      return;\n    }\n\n    // Mark unit queue item as completed\n    await supabase\n      .from(DB_TABLES.UNIT_QUEUES)\n      .update({ status: 'completed' })\n      .eq(DB_FIELDS.BUILDINGS.ID, item.id);\n\n    // Add to fleet logic... (adapted for Supabase)\n    const baseCoord = String(item.location_coord || '');\n    const empireId = empire.id;\n\n    // Find most recent stationed fleet at this base; if none, create a new one with auto-generated name\n    const { data: existingFleets, error: fleetError } = await supabase\n      .from(DB_TABLES.FLEETS)\n      .select('*')\n      .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n      .eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, baseCoord)\n      .order(DB_FIELDS.BUILDINGS.CREATED_AT, { ascending: false })\n      .limit(1);\n\n    if (fleetError) {\n      console.error('Error fetching existing fleets:', fleetError);\n      return;\n    }\n\n    let fleet = existingFleets?.[0];\n\n    if (!fleet) {\n      const nextNum = Math.max(1, Number(empire.next_fleet_number || 1));\n      const name = `Fleet ${nextNum}`;\n\n      // Increment nextFleetNumber for the empire\n      await supabase\n        .from(DB_TABLES.EMPIRES)\n        .update({ next_fleet_number: nextNum + 1 })\n        .eq(DB_FIELDS.BUILDINGS.ID, empire.id);\n\n      const { data: newFleet, error: createError } = await supabase\n        .from(DB_TABLES.FLEETS)\n        .insert({\n          empire_id: empireId,\n          location_coord: baseCoord,\n          name,\n          units: [],\n          size_credits: 0\n        })\n        .select('*')\n        .single();\n\n      if (createError) {\n        console.error('Error creating new fleet:', createError);\n        return;\n      }\n\n      fleet = newFleet;\n    }\n\n    const key = String(item.unit_key || '');\n    const spec = getUnitSpec(key as any);\n    const unitCredits = Number(spec?.creditsCost || 0);\n\n    const currentUnits = fleet.units || [];\n    type UnitInfo = { unitKey: string; count: number };\n    const existing = currentUnits.find((u: UnitInfo) => u.unitKey === key);\n\n    let updatedUnits;\n    if (existing) {\n      updatedUnits = currentUnits.map((u: UnitInfo) =>\n        u.unitKey === key ? { ...u, count: u.count + 1 } : u\n      );\n    } else {\n      updatedUnits = [...currentUnits, { unitKey: key, count: 1 }];\n    }\n\n    const newSizeCredits = Math.max(0, Number(fleet.size_credits || 0)) + unitCredits;\n\n    // Update fleet in database\n    const { error: fleetUpdateError } = await supabase\n      .from(DB_TABLES.FLEETS)\n      .update({\n        units: updatedUnits,\n        size_credits: newSizeCredits\n      })\n      .eq(DB_FIELDS.BUILDINGS.ID, fleet.id);\n\n    if (fleetUpdateError) {\n      console.error('Error updating fleet:', fleetUpdateError);\n      return;\n    }\n\n    // Emit Socket.IO event to notify client of fleet update\n    const unitCount = updatedUnits.reduce((sum: number, u: UnitInfo) => sum + u.count, 0);\n    const fleetId = fleet.id;\n    emitFleetUpdate(empireId, {\n      fleetId,\n      locationCoord: fleet.location_coord,\n      name: fleet.name,\n      sizeCredits: newSizeCredits,\n      unitCount,\n      unitAdded: {\n        unitKey: key,\n        creditsCost: unitCredits\n      }\n    });\n  }\n\n  private async completeTechItem(item: any): Promise<void> {\n    // Your existing tech completion logic adapted for Supabase\n    const { data: empire, error: empireError } = await supabase\n      .from(DB_TABLES.EMPIRES)\n      .select('*')\n      .eq(DB_FIELDS.BUILDINGS.ID, item.empire_id)\n      .maybeSingle();\n\n    if (empireError || !empire) {\n      // Mark as cancelled if empire is missing\n      await supabase\n        .from(DB_TABLES.TECH_QUEUES)\n        .update({ status: 'cancelled' })\n        .eq(DB_FIELDS.BUILDINGS.ID, item.id);\n      return;\n    }\n\n    // Promote tech level to the queued target level (multi-level support)\n    const techLevels = (empire as any).tech_levels || {};\n    const targetLevel = Math.max(1, Number(item.level || 1));\n    const currentLevel = Number(techLevels[item.tech_key] || 0);\n    techLevels[item.tech_key] = Math.max(currentLevel, targetLevel);\n\n    // Update empire with new tech level\n    const { error: empireUpdateError } = await supabase\n      .from(DB_TABLES.EMPIRES)\n      .update({ tech_levels: techLevels })\n      .eq(DB_FIELDS.BUILDINGS.ID, empire.id);\n\n    if (empireUpdateError) {\n      console.error('Error updating empire tech levels:', empireUpdateError);\n      return;\n    }\n\n    // Mark queue item as completed\n    await supabase\n      .from(DB_TABLES.TECH_QUEUES)\n      .update({ status: 'completed' })\n      .eq(DB_FIELDS.BUILDINGS.ID, item.id);\n  }\n\n  // ===== REAL IMPLEMENTATIONS FROM ORIGINAL GAME LOOP =====\n\n  /**\n   * Process technology queue completions\n   */\n  private async processTechQueue(): Promise<{ completed: number; cancelled: number; errors: number }> {\n    // Use Supabase service for tech queue processing\n    return await SupabaseCompletionService.completeTechQueue();\n  }\n\n  /**\n   * Process unit queue completions\n   */\n  private async processUnitQueue(): Promise<{ completed: number; cancelled: number; errors: number }> {\n    // Use Supabase service for unit queue processing\n    return await SupabaseCompletionService.completeUnitQueue();\n  }\n\n  /**\n   * Process building queue completions\n   * Activates buildings whose construction time has completed\n   */\n  private async processBuildingQueue(): Promise<{ activatedCount: number; activatedIds: string[] }> {\n    try {\n      // Use the existing BuildingService method\n      const result = await BuildingService.completeDueConstructions();\n      \n      if (result.activatedCount > 0) {\n        console.log(`[HybridLoop] buildings activated: ${result.activatedCount}`);\n      }\n      \n      return result;\n    } catch (error) {\n      console.error('Error processing building queue:', error);\n      return { activatedCount: 0, activatedIds: [] };\n    }\n  }\n\n  /**\n   * Defense queue (citizen capacity):\n   * - Complete due items (status=pending, completesAt <= now). For now we just mark completed.\n   * - For bases without an in-progress item, schedule the earliest pending waiting item using current citizen capacity\n   */\n  private async processDefenseQueue(): Promise<{ completed: number; activated: number; errors: number }> {\n    // Use Supabase service for defense queue processing\n    const result = await SupabaseCompletionService.completeDefenseQueue();\n    return { completed: result.completed, activated: 0, errors: result.errors };\n  }\n\n  /**\n   * Complete research projects that have finished\n   */\n  private async completeResearchProjects(): Promise<number> {\n    let completedCount = 0;\n    try {\n      const now = new Date();\n\n      // Find research projects that should be completed\n      const { data: completedProjects, error } = await supabase\n        .from(DB_TABLES.RESEARCH_PROJECTS)\n        .select('*')\n        .eq(DB_FIELDS.RESEARCH_PROJECTS.IS_COMPLETED, false)\n        .filter('research_progress', 'gte', 'research_cost');\n\n      if (error) {\n        console.error('Error fetching completed research projects:', error);\n        return completedCount;\n      }\n\n      for (const project of completedProjects || []) {\n        try {\n          // Update project as completed\n          const { error: updateError } = await supabase\n            .from(DB_TABLES.RESEARCH_PROJECTS)\n            .update({\n              is_completed: true,\n              completed_at: now.toISOString()\n            })\n            .eq(DB_FIELDS.BUILDINGS.ID, project.id);\n\n          if (updateError) {\n            console.error('Error updating research project:', updateError);\n            continue;\n          }\n\n          // Apply research benefits to empire\n          await this.applyResearchBenefits(project);\n\n          completedCount++;\n          console.log(`[HybridLoop] research completed name=\"${project.name}\" empire=${project.empire_id}`);\n        } catch (err) {\n          console.error('Error finalizing research project:', err);\n        }\n      }\n    } catch (error) {\n      console.error('Error completing research projects:', error);\n    }\n    return completedCount;\n  }\n\n  /**\n   * Apply research project benefits to empire\n   */\n  private async applyResearchBenefits(project: any): Promise<void> {\n    try {\n      const { data: empire, error } = await supabase\n        .from(DB_TABLES.EMPIRES)\n        .select('*')\n        .eq(DB_FIELDS.BUILDINGS.ID, project.empire_id)\n        .maybeSingle();\n\n      if (error || !empire) {\n        console.error('Error fetching empire for research benefits:', error);\n        return;\n      }\n\n      // Phase A: No direct empire.technology mutation.\n      // Completed ResearchProjects contribute via EconomyService.getResearchCreditBonuses().\n      // Placeholder for future benefits application (e.g., unlocking buildings/units).\n      return;\n    } catch (error) {\n      console.error('Error applying research benefits:', error);\n    }\n  }\n\n  /**\n   * Try to activate earliest pending research items that are waiting for credits/capacity.\n   * For each pending item without completesAt or not charged:\n   * - Check base research capacity > 0\n   * - Check empire credits >= cost for desired level\n   * - Charge credits, compute ETA, and set completesAt\n   */\n  private async activatePendingTech(): Promise<{ activated: number; skipped: number; errors: number }> {\n    let activated = 0;\n    let skipped = 0;\n    let errors = 0;\n    try {\n      const now = new Date();\n\n      // Find pending items that are not yet scheduled (no completesAt) or not charged\n      const { data: items, error } = await supabase\n        .from(DB_TABLES.TECH_QUEUES)\n        .select('*')\n        .eq(DB_FIELDS.TECH_QUEUE.STATUS, 'pending')\n        .or('completes_at.is.null,completes_at.eq.,charged.eq.false')\n        .order(DB_FIELDS.BUILDINGS.CREATED_AT, { ascending: true });\n\n      if (error) {\n        console.error('Error fetching pending tech items:', error);\n        errors++;\n        return { activated, skipped, errors };\n      }\n\n      for (const item of items || []) {\n        try {\n          const { data: empire, error: empireError } = await supabase\n            .from(DB_TABLES.EMPIRES)\n            .select('*')\n            .eq(DB_FIELDS.BUILDINGS.ID, item.empire_id)\n            .maybeSingle();\n\n          if (empireError || !empire) {\n            // Mark as cancelled if empire is missing\n            const { error: cancelError } = await supabase\n              .from(DB_TABLES.TECH_QUEUES)\n              .update({ status: 'cancelled' })\n              .eq(DB_FIELDS.BUILDINGS.ID, item.id);\n\n            if (cancelError) {\n              console.error('Error cancelling tech queue item:', cancelError);\n            }\n\n            // Defensive backfill: ensure identityKey exists for legacy docs missing it\n            const empireIdStr = String(item.empire_id || '');\n            const techKeyMissing = item.tech_key;\n            const levelMissing = Math.max(1, Number(item.level || 1));\n            if (!item.identity_key && techKeyMissing) {\n              const { error: updateError } = await supabase\n                .from(DB_TABLES.TECH_QUEUES)\n                .update({ identity_key: `${empireIdStr}:${techKeyMissing}:${levelMissing}` })\n                .eq(DB_FIELDS.BUILDINGS.ID, item.id);\n\n              if (updateError) {\n                console.error('Error updating identity_key:', updateError);\n              }\n            }\n\n            skipped++;\n            continue;\n          }\n\n          const empireIdStr = String(empire.id);\n          const baseCoord = item.location_coord as string;\n\n          // Re-evaluate capacity at this base\n          const { research } = await CapacityService.getBaseCapacities(empireIdStr, baseCoord);\n          const cap = Math.max(0, Number(research?.value || 0));\n          if (cap <= 0) {\n            skipped++;\n            continue;\n          }\n\n          // Determine desired level and compute cost\n          const techKey = item.tech_key;\n          const desiredLevel = Math.max(1, Number(item.level || 1));\n          const spec = getTechSpec(techKey);\n          const creditsCost = getTechCreditCostForLevel(spec, desiredLevel);\n\n          // Require sufficient credits now; otherwise remain pending\n          if (empire.credits < creditsCost) {\n            skipped++;\n            continue;\n          }\n\n          // Schedule completesAt based on current capacity\n          const hours = creditsCost / cap;\n          const etaMinutes = Math.max(1, Math.ceil(hours * 60));\n          const completesAt = new Date(now.getTime() + etaMinutes * 60 * 1000);\n\n          // Update queue item with scheduling info\n          const { error: updateError } = await supabase\n            .from(DB_TABLES.TECH_QUEUES)\n            .update({\n              completes_at: completesAt.toISOString(),\n              charged: true,\n              identity_key: item.identity_key || `${empireIdStr}:${techKey}:${desiredLevel}`\n            })\n            .eq(DB_FIELDS.BUILDINGS.ID, item.id);\n\n          if (updateError) {\n            console.error('Error updating tech queue item:', updateError);\n            errors++;\n            continue;\n          }\n\n          // Charge credits after successful scheduling\n          const { error: creditError } = await supabase\n            .from(DB_TABLES.EMPIRES)\n            .update({ credits: empire.credits - creditsCost })\n            .eq(DB_FIELDS.BUILDINGS.ID, empire.id);\n\n          if (creditError) {\n            console.error('Error deducting credits for tech:', creditError);\n            errors++;\n            continue;\n          }\n\n          activated++;\n          console.log(`[HybridLoop] tech activated key=${techKey} base=${baseCoord} level=${desiredLevel} etaMinutes=${etaMinutes}`);\n        } catch (err) {\n          errors++;\n          console.error('Error activating tech queue item:', err);\n        }\n      }\n    } catch (err) {\n      console.error('Error in activatePendingTech:', err);\n    }\n    return { activated, skipped, errors };\n  }\n\n  /**\n   * Process fleet arrivals - fleets that have completed their travel time\n   * This is critical for MMO gameplay - fleets need to arrive promptly!\n   */\n  private async processFleetArrivals(): Promise<number> {\n    try {\n      const currentTime = new Date();\n\n      // Query arrivals from Supabase\n      const { data: arrivals, error } = await supabase\n        .from(DB_TABLES.FLEET_MOVEMENTS)\n        .select(DB_FIELDS.BUILDINGS.ID)\n        .eq(DB_FIELDS.TECH_QUEUE.STATUS, 'travelling')\n        .lte('estimated_arrival_time', currentTime.toISOString());\n\n      if (error) {\n        console.error('Error fetching fleet arrivals from Supabase:', error);\n        return STATUS_CODES.SUCCESS;\n      }\n\n      // Process arrivals using SupabaseFleetMovementService\n      if (arrivals && arrivals.length > 0) {\nawait FleetMovementService.processArrivals();\n        console.log(`[HybridLoop] fleet arrivals processed: ${arrivals.length}`);\n      }\n\n      return arrivals?.length || 0;\n    } catch (error) {\n      console.error('Error processing fleet arrivals in hybrid loop:', error);\n      return STATUS_CODES.SUCCESS;\n    }\n  }\n\n  isGameLoopRunning(): boolean {\n    return this.isRunning;\n  }\n\n  getStatus() {\n    return {\n      isRunning: this.isRunning,\n      intervals: {\n        completions: '10 seconds',\n        resources: '60 seconds', \n        maintenance: '300 seconds'\n      }\n    };\n  }\n}\n\n// Export singleton instance\nexport const hybridGameLoop = HybridGameLoopService.getInstance();\n\n\n"],"version":3}