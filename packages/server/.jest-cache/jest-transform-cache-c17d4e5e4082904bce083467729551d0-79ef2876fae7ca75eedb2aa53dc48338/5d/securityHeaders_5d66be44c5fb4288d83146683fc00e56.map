{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\middleware\\securityHeaders.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\middleware\\securityHeaders.ts"],"sourcesContent":["import helmet from 'helmet';\r\nimport { Request, Response, NextFunction } from 'express';\r\nimport { HTTP_STATUS } from '../constants/response-formats';\r\nimport { ENV_VARS, ENV_VALUES } from '@game/shared';\r\n\r\n\r\n/**\r\n * Comprehensive security headers middleware\r\n * Implements OWASP recommended security headers for production hardening\r\n * \r\n * Key security features:\r\n * - HSTS (HTTP Strict Transport Security)\r\n * - Content Security Policy (CSP)\r\n * - X-Frame-Options, X-Content-Type-Options\r\n * - CSRF protection headers\r\n * - XSS protection and referrer policy\r\n */\r\n\r\n/**\r\n * Content Security Policy configuration\r\n * This complements the client-side CSP meta tag with server-side enforcement\r\n */\r\nconst cspConfig = {\r\n  directives: {\r\n    defaultSrc: [\"'self'\"],\r\n    scriptSrc: [\r\n      \"'self'\",\r\n      \"'unsafe-inline'\", // Required for Vite-generated inline scripts\r\n      \"blob:\"           // Required for dynamic worker scripts\r\n    ],\r\n    styleSrc: [\r\n      \"'self'\",\r\n      \"'unsafe-inline'\" // Required for Tailwind CSS and Vite-generated styles\r\n    ],\r\n    imgSrc: [\r\n      \"'self'\",\r\n      \"data:\",    // For base64 encoded images\r\n      \"blob:\",    // For dynamically generated images\r\n      \"https:\"    // For external images\r\n    ],\r\n    connectSrc: [\r\n      \"'self'\",\r\n      \"https:\",   // HTTPS API calls\r\n      \"http:\",    // HTTP API calls (dev mode)\r\n      \"ws:\",      // WebSocket connections (dev)\r\n      \"wss:\"      // Secure WebSocket connections (prod)\r\n    ],\r\n    mediaSrc: [\"'self'\", \"blob:\"],\r\n    fontSrc: [\"'self'\", \"data:\"],\r\n    objectSrc: [\"'none'\"],           // Disable object/embed elements\r\n    baseUri: [\"'self'\"],             // Restrict base tag URLs\r\n    formAction: [\"'self'\"],          // Restrict form submissions\r\n    frameAncestors: [\"'none'\"],      // Prevent framing (clickjacking protection)\r\n    upgradeInsecureRequests: []      // Upgrade HTTP to HTTPS\r\n  },\r\n  reportOnly: false // Set to true for testing, false for enforcement\r\n};\r\n\r\n/**\r\n * HSTS (HTTP Strict Transport Security) configuration\r\n * Enforces HTTPS connections and prevents protocol downgrade attacks\r\n */\r\nconst hstsConfig = {\r\n  maxAge: 31536000,        // 1 year (recommended minimum)\r\n  includeSubDomains: true, // Apply to all subdomains\r\n  preload: true           // Eligible for browser preload lists\r\n};\r\n\r\n/**\r\n * Permissions Policy configuration\r\n * Controls which browser features and APIs can be used\r\n */\r\nconst permissionsPolicyConfig = {\r\n  // Disable potentially dangerous features\r\n  accelerometer: [],\r\n  'ambient-light-sensor': [],\r\n  autoplay: ['self'], // Allow autoplay only from same origin\r\n  camera: [], // Disable camera access\r\n  'encrypted-media': ['self'],\r\n  fullscreen: ['self'],\r\n  geolocation: [], // Disable geolocation\r\n  gyroscope: [],\r\n  magnetometer: [],\r\n  microphone: [], // Disable microphone access\r\n  midi: [],\r\n  payment: [], // Disable payment request API\r\n  'picture-in-picture': [],\r\n  'publickey-credentials-get': [], // Disable WebAuthn for now\r\n  'sync-xhr': [], // Disable synchronous XHR\r\n  'usb': [], // Disable USB API\r\n  'web-share': [],\r\n  'xr-spatial-tracking': [] // Disable WebXR\r\n};\r\n\r\n/**\r\n * Create comprehensive security headers middleware\r\n * @param isDevelopment - Whether running in development mode\r\n * @returns Express middleware function\r\n */\r\nexport function createSecurityHeadersMiddleware(isDevelopment = false) {\r\n  // In development, we might want less strict CSP for debugging\r\n  const cspDirectives = isDevelopment ? {\r\n    ...cspConfig.directives,\r\n    // In development, we might allow additional sources\r\n    connectSrc: [\r\n      \"'self'\",\r\n      \"https:\",\r\n      \"http:\",\r\n      \"ws:\",\r\n      \"wss:\",\r\n      \"http://localhost:*\", // Allow localhost connections\r\n      \"ws://localhost:*\",   // Allow localhost WebSockets\r\n      \"https://localhost:*\" // Allow localhost HTTPS\r\n    ]\r\n  } : cspConfig.directives;\r\n\r\n  return helmet({\r\n    // Content Security Policy\r\n    contentSecurityPolicy: {\r\n      directives: cspDirectives,\r\n      reportOnly: isDevelopment // Only report violations in dev, enforce in prod\r\n    },\r\n\r\n    // HTTP Strict Transport Security (always enable for testing)\r\n    hsts: hstsConfig,\r\n\r\n    // X-Frame-Options: Prevent clickjacking\r\n    frameguard: {\r\n      action: 'deny' // Completely prevent framing\r\n    },\r\n\r\n    // X-Content-Type-Options: Prevent MIME sniffing\r\n    noSniff: true,\r\n\r\n    // X-XSS-Protection: Enable XSS filtering (legacy but still useful)\r\n    xssFilter: true,\r\n\r\n    // Referrer Policy: Control referrer information\r\n    referrerPolicy: {\r\n      policy: ['strict-origin-when-cross-origin']\r\n    },\r\n\r\n    // Permissions Policy: Control browser features and APIs\r\n    // Note: Some versions of helmet might not support this, fallback gracefully\r\n    ...(() => {\r\n      try {\r\n        return {\r\n          permissionsPolicy: {\r\n            features: permissionsPolicyConfig\r\n          }\r\n        };\r\n      } catch {\r\n        // Fallback if permissions policy is not supported\r\n        console.warn('?? Permissions Policy not supported in this Helmet version');\r\n        return {};\r\n      }\r\n    })(),\r\n\r\n    // Hide X-Powered-By header\r\n    hidePoweredBy: true,\r\n\r\n    // DNS Prefetch Control: Control DNS prefetching\r\n    dnsPrefetchControl: {\r\n      allow: false // Disable DNS prefetching for privacy\r\n    },\r\n\r\n    // Cross-Origin Embedder Policy\r\n    crossOriginEmbedderPolicy: {\r\n      policy: 'require-corp' // Require explicit CORP headers\r\n    },\r\n\r\n    // Cross-Origin Opener Policy\r\n    crossOriginOpenerPolicy: {\r\n      policy: 'same-origin' // Prevent cross-origin access to window object\r\n    },\r\n\r\n    // Cross-Origin Resource Policy\r\n    crossOriginResourcePolicy: {\r\n      policy: 'cross-origin' // Allow cross-origin requests (needed for API)\r\n    },\r\n\r\n    // Expect-CT: Certificate Transparency enforcement (commented out - not supported in current Helmet version)\r\n    // expectCt: {\r\n    //   maxAge: 86400, // 24 hours\r\n    //   enforce: process.env[ENV_VARS.NODE_ENV] === ENV_VALUES.PRODUCTION,\r\n    //   reportUri: process.env[ENV_VARS.SECURITY_REPORT_URI] || undefined\r\n    // }\r\n  });\r\n}\r\n\r\n/**\r\n * Additional CSRF protection middleware\r\n * Implements SameSite cookie attributes and validates origins\r\n */\r\nexport function csrfProtectionMiddleware(req: Request, res: Response, next: NextFunction) {\r\n  // Store original cookie function\r\n  const originalCookie = res.cookie.bind(res);\r\n  \r\n  // Override cookie function with secure defaults\r\n  res.cookie = function(name: string, value: any, options: any = {}) {\r\n    // Ensure secure cookie settings in production\r\n    const secureOptions = {\r\n      ...options,\r\n      httpOnly: true,           // Prevent XSS access to cookies\r\n      secure: process.env[ENV_VARS.NODE_ENV] === ENV_VALUES.PRODUCTION, // HTTPS only in production\r\n      sameSite: 'strict' as const,  // Strict SameSite policy\r\n      maxAge: options.maxAge || 24 * 60 * 60 * 1000 // 24 hours default\r\n    };\r\n    \r\n    return originalCookie(name, value, secureOptions);\r\n  };\r\n\r\n  // Origin validation for state-changing operations\r\n  if (['POST', 'PUT', 'DELETE', 'PATCH'].includes(req.method)) {\r\n    const origin = req.get('Origin') || req.get('Referer');\r\n    const allowedOrigins = process.env[ENV_VARS.CORS_ORIGIN]\r\n      ? process.env[ENV_VARS.CORS_ORIGIN]!.split(',').map(o => o.trim()).filter(Boolean)\r\n      : ['http://localhost:5173', 'http://localhost:5174'];\r\n\r\n    if (origin) {\r\n      const isAllowed = allowedOrigins.some(allowed => {\r\n        // Handle URL objects and string comparisons\r\n        try {\r\n          const originUrl = new URL(origin);\r\n          const allowedUrl = allowed.startsWith('http') ? new URL(allowed) : null;\r\n          \r\n          if (allowedUrl) {\r\n            return originUrl.origin === allowedUrl.origin;\r\n          } else {\r\n            return origin.includes(allowed);\r\n          }\r\n        } catch {\r\n          return origin === allowed;\r\n        }\r\n      });\r\n\r\n      if (!isAllowed && process.env[ENV_VARS.NODE_ENV] === ENV_VALUES.PRODUCTION) {\r\n        return res.status(HTTP_STATUS.FORBIDDEN).json({\r\n          success: false,\r\n          error: 'Forbidden: Invalid origin'\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  next();\r\n}\r\n\r\n/**\r\n * Security headers validation middleware\r\n * Logs security header violations and suspicious activities\r\n */\r\nexport function securityLoggingMiddleware(req: Request, res: Response, next: NextFunction) {\r\n  // Log suspicious patterns\r\n  const suspiciousPatterns = [\r\n    /(<script|javascript:|data:text\\/html)/i,  // Script injection attempts\r\n    /(union\\s+select|drop\\s+table|insert\\s+into)/i, // SQL injection patterns\r\n    /(\\.\\.|\\/etc\\/|\\/proc\\/)/i,               // Path traversal attempts\r\n    /(exec|system|cmd|powershell)/i           // Command injection patterns\r\n  ];\r\n\r\n  const userAgent = req.get('User-Agent') || '';\r\n  const queryString = JSON.stringify(req.query);\r\n  const bodyString = JSON.stringify(req.body);\r\n\r\n  const isSuspicious = suspiciousPatterns.some(pattern => \r\n    pattern.test(userAgent) || \r\n    pattern.test(queryString) || \r\n    pattern.test(bodyString)\r\n  );\r\n\r\n  if (isSuspicious) {\r\n    console.warn(`?? Suspicious request detected:`, {\r\n      ip: req.ip,\r\n      method: req.method,\r\n      url: req.url,\r\n      userAgent: userAgent.substring(0, 200), // Truncate for logging\r\n      timestamp: new Date().toISOString()\r\n    });\r\n  }\r\n\r\n  next();\r\n}\r\n\r\n/**\r\n * Export default middleware stack\r\n */\r\nexport default function securityHeadersStack(isDevelopment = false) {\r\n  return [\r\n    createSecurityHeadersMiddleware(isDevelopment),\r\n    csrfProtectionMiddleware,\r\n    securityLoggingMiddleware\r\n  ];\r\n}\r\n\r\n\r\n"],"version":3}