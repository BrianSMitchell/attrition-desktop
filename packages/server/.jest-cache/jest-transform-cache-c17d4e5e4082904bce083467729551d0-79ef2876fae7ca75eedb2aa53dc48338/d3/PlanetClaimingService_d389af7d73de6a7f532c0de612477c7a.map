{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\services\\PlanetClaimingService.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\services\\PlanetClaimingService.ts"],"sourcesContent":["import { supabase } from '../config/supabase';\r\n\r\n// Constants imports for eliminating hardcoded values\r\nimport { DB_TABLES, DB_FIELDS } from '../constants/database-fields';\r\n\r\n/**\r\n * PlanetClaimingService - Handles planet claiming and starter setup logic\r\n * Eliminates feature envy by centralizing planet-related operations for new users\r\n */\r\nexport class PlanetClaimingService {\r\n  /**\r\n   * Find an available starter planet for new users\r\n   * @returns Promise<string | null> - Coordinate of available planet or null\r\n   */\r\n  static async findAvailableStarterPlanet(): Promise<string | null> {\r\n    const candidate = await supabase\r\n      .from(DB_TABLES.LOCATIONS)\r\n      .select('coord')\r\n      .eq(DB_FIELDS.CREDIT_TRANSACTIONS.TYPE, 'planet')\r\n      .is(DB_FIELDS.LOCATIONS.OWNER_ID, null)\r\n      .limit(1)\r\n      .single();\r\n\r\n    return candidate.data?.coord || null;\r\n  }\r\n\r\n  /**\r\n   * Claim a planet atomically for a user\r\n   * @param coord - Planet coordinate to claim\r\n   * @param userId - User ID claiming the planet\r\n   * @returns Promise<boolean> - true if claim was successful\r\n   */\r\n  static async claimPlanet(coord: string, userId: string): Promise<boolean> {\r\n    const claim = await supabase\r\n      .from(DB_TABLES.LOCATIONS)\r\n      .update({ owner_id: userId })\r\n      .eq('coord', coord)\r\n      .is(DB_FIELDS.LOCATIONS.OWNER_ID, null)\r\n      .select('coord')\r\n      .single();\r\n\r\n    return !!claim.data;\r\n  }\r\n\r\n  /**\r\n   * Setup starter colony for new user\r\n   * @param empireId - Empire ID for the colony\r\n   * @param locationCoord - Coordinate where colony will be placed\r\n   * @returns Promise<void>\r\n   */\r\n  static async createStarterColony(empireId: string, locationCoord: string): Promise<void> {\r\n    await supabase\r\n      .from(DB_TABLES.COLONIES)\r\n      .insert({\r\n        empire_id: empireId,\r\n        location_coord: locationCoord,\r\n        name: 'Home Base'\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Place starter building on planet for new user\r\n   * @param locationCoord - Planet coordinate for building placement\r\n   * @param empireId - Empire ID that owns the building\r\n   * @returns Promise<void>\r\n   */\r\n  static async placeStarterBuilding(locationCoord: string, empireId: string): Promise<void> {\r\n    await supabase\r\n      .from(DB_TABLES.BUILDINGS)\r\n      .insert({\r\n        location_coord: locationCoord,\r\n        empire_id: empireId,\r\n        type: 'habitat',\r\n        display_name: 'Urban Structures',\r\n        catalog_key: 'urban_structures',\r\n        level: 1,\r\n        construction_completed: new Date().toISOString(),\r\n        is_active: true,\r\n        credits_cost: 0,\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Setup complete starter planet with colony and building\r\n   * @param empireId - Empire ID for the setup\r\n   * @param locationCoord - Planet coordinate for setup\r\n   * @returns Promise<void>\r\n   */\r\n  static async setupStarterPlanet(empireId: string, locationCoord: string): Promise<void> {\r\n    // Create colony and starter building (best-effort - don't fail if building creation fails)\r\n    await this.createStarterColony(empireId, locationCoord);\r\n\r\n    try {\r\n      await this.placeStarterBuilding(locationCoord, empireId);\r\n    } catch (error) {\r\n      // Log but don't fail - colony creation is more critical\r\n      console.warn('[PlanetClaimingService] Failed to place starter building:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Complete onboarding process for new user\r\n   * @param userId - User ID for onboarding\r\n   * @param empireId - Empire ID for the user\r\n   * @param startingCoordinate - Starting coordinate for the user\r\n   * @returns Promise<void>\r\n   */\r\n  static async completeUserOnboarding(userId: string, empireId: string, startingCoordinate: string): Promise<void> {\r\n    await supabase\r\n      .from(DB_TABLES.USERS)\r\n      .update({\r\n        empire_id: empireId,\r\n        starting_coordinate: startingCoordinate\r\n      })\r\n      .eq(DB_FIELDS.BUILDINGS.ID, userId);\r\n  }\r\n\r\n  /**\r\n   * Get planet details by coordinate\r\n   * @param coord - Planet coordinate to lookup\r\n   * @returns Promise<Planet | null> - Planet details or null if not found\r\n   */\r\n  static async getPlanetByCoord(coord: string): Promise<any | null> {\r\n    const planet = await supabase\r\n      .from(DB_TABLES.LOCATIONS)\r\n      .select('*')\r\n      .eq('coord', coord)\r\n      .eq(DB_FIELDS.CREDIT_TRANSACTIONS.TYPE, 'planet')\r\n      .single();\r\n\r\n    return planet.data;\r\n  }\r\n\r\n  /**\r\n   * Check if planet is available for claiming\r\n   * @param coord - Planet coordinate to check\r\n   * @returns Promise<boolean> - true if planet is available\r\n   */\r\n  static async isPlanetAvailable(coord: string): Promise<boolean> {\r\n    const planet = await this.getPlanetByCoord(coord);\r\n    return planet !== null && planet.owner_id === null;\r\n  }\r\n}"],"version":3}