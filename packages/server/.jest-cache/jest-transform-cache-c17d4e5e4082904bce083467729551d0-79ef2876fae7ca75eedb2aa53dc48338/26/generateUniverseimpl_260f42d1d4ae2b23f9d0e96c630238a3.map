{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\scripts\\generateUniverse.impl.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\scripts\\generateUniverse.impl.ts"],"sourcesContent":["import 'dotenv/config';\r\nimport path from 'path';\r\nimport { config as dotenvConfig } from 'dotenv';\r\nimport seedrandom from 'seedrandom';\r\nimport { supabase } from '../config/supabase';\r\nimport { DB_TABLES } from '../constants/database-fields';\r\n// Removed legacy database type check - we're fully on Supabase now\r\nimport {\r\n  formatCoord,\r\n  randomInt,\r\n  pickStarKindFromCoord,\r\n  getStarKindModifiers,\r\n  pickTerrainFromCoord,\r\n  computePlanetStats,\r\n} from '@game/shared';\r\n\r\n// Ensure we load env from packages/server/.env when run directly\r\ndotenvConfig({ path: path.resolve(__dirname, '../../.env') });\r\n\r\nconst UNIVERSE_CONFIG = {\r\n  serverName: 'A',\r\n  galaxyCount: 2,\r\n  regionCount: 100,\r\n  maxSystemsPerRegion: 50,\r\n  minSystemsPerRegion: 1,\r\n  maxBodiesPerSystem: 20,\r\n  minBodiesPerSystem: 1,\r\n  seed: 'alpha-universe-2024',\r\n};\r\n\r\nasync function universeExistsForServer(server: string): Promise<boolean> {\r\n  const { count, error } = await supabase\r\n    .from(DB_TABLES.LOCATIONS)\r\n    .select('*', { count: 'exact', head: true })\r\n    .like('coord', `${server}%`);\r\n  if (error) {\r\n    throw new Error(`Failed to check existing universe: ${error.message}`);\r\n  }\r\n  return (count ?? 0) > 0;\r\n}\r\n\r\nexport async function generateUniverse() {\r\n  // We're fully migrated to Supabase, no need to check database type\r\n\r\n  console.log('üåå Starting Supabase universe generation for server:', UNIVERSE_CONFIG.serverName);\r\n\r\n  if (await universeExistsForServer(UNIVERSE_CONFIG.serverName)) {\r\n    console.log(`‚ö†Ô∏è  Universe for server ${UNIVERSE_CONFIG.serverName} already exists in Supabase.`);\r\n    console.log('    Skipping generation. Delete existing rows from public.locations to regenerate.');\r\n    return;\r\n  }\r\n\r\n  const rng = seedrandom(UNIVERSE_CONFIG.seed);\r\n  const originalRandom = Math.random;\r\n  Math.random = rng;\r\n\r\n  try {\r\n    const rows: any[] = [];\r\n\r\n    console.log('üìä Generation parameters:');\r\n    console.log(`  - Galaxies: ${UNIVERSE_CONFIG.galaxyCount}`);\r\n    console.log(`  - Regions per galaxy: ${UNIVERSE_CONFIG.regionCount}`);\r\n    console.log(`  - Systems per region: ${UNIVERSE_CONFIG.minSystemsPerRegion}-${UNIVERSE_CONFIG.maxSystemsPerRegion}`);\r\n    console.log(`  - Bodies per system: ${UNIVERSE_CONFIG.minBodiesPerSystem}-${UNIVERSE_CONFIG.maxBodiesPerSystem}`);\r\n    console.log(`  - Seed: ${UNIVERSE_CONFIG.seed}`);\r\n\r\n    for (let galaxyId = 0; galaxyId < UNIVERSE_CONFIG.galaxyCount; galaxyId++) {\r\n      console.log(`üåå Generating galaxy ${galaxyId}...`);\r\n\r\n      for (let regionId = 0; regionId < UNIVERSE_CONFIG.regionCount; regionId++) {\r\n        const systemCount = randomInt(\r\n          UNIVERSE_CONFIG.minSystemsPerRegion,\r\n          UNIVERSE_CONFIG.maxSystemsPerRegion,\r\n        );\r\n\r\n        const usedPositions = new Set<number>();\r\n\r\n        for (let i = 0; i < systemCount; i++) {\r\n          // Unique system position within 0..99\r\n          let systemPosition: number;\r\n          do {\r\n            systemPosition = randomInt(0, 99);\r\n          } while (usedPositions.has(systemPosition));\r\n          usedPositions.add(systemPosition);\r\n\r\n          // Central star (body 0)\r\n          const starCoord = formatCoord({\r\n            server: UNIVERSE_CONFIG.serverName,\r\n            galaxy: galaxyId,\r\n            region: regionId,\r\n            system: systemPosition,\r\n            body: 0,\r\n          });\r\n\r\n          const starKind = pickStarKindFromCoord(starCoord, 101);\r\n          const orbitModifiers = Array.from({ length: 8 }, (_, idx) => {\r\n            const pos = idx + 1;\r\n            const mods = getStarKindModifiers(starKind, pos);\r\n            return {\r\n              position: pos,\r\n              solarEnergyDelta: mods.solarEnergyDelta,\r\n              fertilityDelta: mods.fertilityDelta,\r\n              resourceDelta: {\r\n                metal: mods.resourceDelta?.metal ?? 0,\r\n                gas: mods.resourceDelta?.gas ?? 0,\r\n                crystals: mods.resourceDelta?.crystals ?? 0,\r\n              },\r\n            };\r\n          });\r\n\r\n          rows.push({\r\n            coord: starCoord,\r\n            type: 'star',\r\n            star_overhaul: {\r\n              kind: starKind as any,\r\n              orbitModifiers,\r\n              notes: undefined,\r\n            },\r\n            owner_id: null,\r\n          });\r\n\r\n          // Bodies (1..19)\r\n          const bodyCount = randomInt(\r\n            UNIVERSE_CONFIG.minBodiesPerSystem,\r\n            UNIVERSE_CONFIG.maxBodiesPerSystem,\r\n          );\r\n          const maxBodiesForPlanets = Math.min(bodyCount, 19);\r\n\r\n          for (let bodyId = 1; bodyId <= maxBodiesForPlanets; bodyId++) {\r\n            const coord = formatCoord({\r\n              server: UNIVERSE_CONFIG.serverName,\r\n              galaxy: galaxyId,\r\n              region: regionId,\r\n              system: systemPosition,\r\n              body: bodyId,\r\n            });\r\n\r\n            const bodyType = Math.random() < 0.7 ? 'planet' : 'asteroid';\r\n            const SCALE = 100;\r\n            const orbitPosition = Math.min(bodyId, 8);\r\n            const isAsteroid = bodyType !== 'planet';\r\n            const terrainType = pickTerrainFromCoord(coord, bodyId, isAsteroid);\r\n\r\n            const comp = computePlanetStats({\r\n              kind: starKind as any,\r\n              terrain: terrainType as any,\r\n              position: orbitPosition,\r\n            });\r\n\r\n            const row = {\r\n              coord,\r\n              type: bodyType,\r\n              orbit_position: orbitPosition,\r\n              terrain: {\r\n                type: terrainType,\r\n                baseline: comp.baselineTerrain,\r\n              },\r\n              position_base: comp.basePosition,\r\n              star_applied: {\r\n                solarEnergyDelta: comp.starMods.solarEnergyDelta,\r\n                fertilityDelta: comp.starMods.fertilityDelta,\r\n                resourceDelta: {\r\n                  metal: comp.starMods.resourceDelta?.metal ?? 0,\r\n                  gas: comp.starMods.resourceDelta?.gas ?? 0,\r\n                  crystals: comp.starMods.resourceDelta?.crystals ?? 0,\r\n                },\r\n              },\r\n              result: comp.result,\r\n              owner_id: null,\r\n            } as const;\r\n\r\n            rows.push(row);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    console.log('üíæ Saving locations to Supabase...');\r\n    const batchSize = 1000;\r\n    let saved = 0;\r\n    for (let i = 0; i < rows.length; i += batchSize) {\r\n      const batch = rows.slice(i, i + batchSize);\r\n      const { error } = await supabase\r\n        .from(DB_TABLES.LOCATIONS)\r\n        .upsert(batch, { onConflict: 'coord' });\r\n      if (error) {\r\n        throw new Error(`Upsert failed at batch starting ${i}: ${error.message}`);\r\n      }\r\n      saved += batch.length;\r\n      const progress = Math.round((saved / rows.length) * 100);\r\n      console.log(`  üìä Progress: ${progress}% (${saved}/${rows.length})`);\r\n    }\r\n\r\n    console.log('‚úÖ Supabase universe generation completed successfully!');\r\n  } finally {\r\n    Math.random = originalRandom;\r\n  }\r\n}\r\n\r\nif (require.main === module) {\r\n  generateUniverse()\r\n    .catch((e) => {\r\n      console.error('üí• Script failed:', e);\r\n      process.exit(1);\r\n    })\r\n    .then(() => process.exit(0));\r\n}\r\n"],"version":3}