{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\services\\UserManagementService.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\services\\UserManagementService.ts"],"sourcesContent":["import bcrypt from 'bcryptjs';\nimport { supabase } from '../config/supabase';\n\n// Constants imports for eliminating hardcoded values\nimport { DB_TABLES, DB_FIELDS } from '../constants/database-fields';\n\nimport { GAME_CONSTANTS } from '@game/shared';\n/**\n * UserManagementService - Handles user creation, validation, and profile management\n * Eliminates feature envy by centralizing user-related database operations\n */\nexport class UserManagementService {\n  /**\n   * Validate user input data\n   * @param email - User's email address\n   * @param username - User's username\n   * @param password - User's password\n   * @returns Object with normalized data or error message\n   */\n  static validateUserInput(email: string, username: string, password: string): { \n    isValid: boolean; \n    error?: string; \n    data?: { normEmail: string; normUsername: string; password: string; }\n  } {\n    const normEmail = String(email || '').trim().toLowerCase();\n    const normUsername = String(username || '').trim();\n\n    if (!normEmail || !normUsername || !password || password.length < 6) {\n      return { isValid: false, error: 'Invalid registration details' };\n    }\n\n    return { \n      isValid: true, \n      data: { normEmail, normUsername, password } \n    };\n  }\n\n  /**\n   * Check if user with email or username already exists\n   * @param email - Email to check\n   * @param username - Username to check\n   * @returns Promise<boolean> - true if user exists, false otherwise\n   */\n  static async checkUserExists(email: string, username: string): Promise<boolean> {\n    const existing = await supabase\n      .from(DB_TABLES.USERS)\n      .select(DB_FIELDS.BUILDINGS.ID)\n      .or(`email.eq.${email},username.eq.${username}`)\n      .limit(1);\n\n    return existing.data !== null && existing.data.length > 0;\n  }\n\n  /**\n   * Create a new user with hashed password\n   * @param email - User's email address\n   * @param username - User's username\n   * @param password - User's plain text password\n   * @returns Promise<User> - Created user record\n   */\n  static async createUser(email: string, username: string, password: string): Promise<any> {\n    // Hash password\n    const salt = await bcrypt.genSalt(12);\n    const hashed = await bcrypt.hash(password, salt);\n\n    // Create user row\n    const userInsert = await supabase\n      .from(DB_TABLES.USERS)\n      .insert({ \n        email, \n        username, \n        password_hash: hashed, \n        credits: GAME_CONSTANTS.STARTING_CREDITS, \n        experience: 0 \n      })\n      .select('id, email, username')\n      .single();\n\n    if (userInsert.error) {\n      throw userInsert.error;\n    }\n\n    return userInsert.data;\n  }\n\n  /**\n   * Get user by email for login\n   * @param email - Email to lookup\n   * @returns Promise<User | null> - User record or null if not found\n   */\n  static async getUserByEmail(email: string): Promise<any | null> {\n    const userQuery = await supabase\n      .from(DB_TABLES.USERS)\n      .select('id, email, username, password_hash, empire_id, starting_coordinate')\n      .eq(DB_FIELDS.USERS.EMAIL, email)\n      .maybeSingle();\n\n    return userQuery.data;\n  }\n\n  /**\n   * Verify user password\n   * @param password - Plain text password\n   * @param hashedPassword - Hashed password from database\n   * @returns Promise<boolean> - true if password matches\n   */\n  static async verifyPassword(password: string, hashedPassword: string): Promise<boolean> {\n    return await bcrypt.compare(password, hashedPassword);\n  }\n\n  /**\n   * Update user's last login timestamp\n   * @param userId - User ID to update\n   */\n  static async updateLastLogin(userId: string): Promise<void> {\n    await supabase\n      .from(DB_TABLES.USERS)\n      .update({ last_login: new Date().toISOString() })\n      .eq(DB_FIELDS.BUILDINGS.ID, userId);\n  }\n\n  /**\n   * Update user with empire association and starting coordinate\n   * @param userId - User ID to update\n   * @param empireId - Empire ID to associate\n   * @param startingCoordinate - Starting coordinate for user\n   */\n  static async updateUserWithEmpire(userId: string, empireId: string, startingCoordinate: string): Promise<void> {\n    await supabase\n      .from(DB_TABLES.USERS)\n      .update({ \n        empire_id: empireId, \n        starting_coordinate: startingCoordinate,\n        last_login: new Date().toISOString() \n      })\n      .eq(DB_FIELDS.BUILDINGS.ID, userId);\n  }\n\n  /**\n   * Get user by ID with basic profile information\n   * @param userId - User ID to lookup\n   * @returns Promise<User | null> - User record or null if not found\n   */\n  static async getUserById(userId: string): Promise<any | null> {\n    const userQuery = await supabase\n      .from(DB_TABLES.USERS)\n      .select('id, email, username, empire_id, starting_coordinate')\n      .eq(DB_FIELDS.BUILDINGS.ID, userId)\n      .maybeSingle();\n\n    return userQuery.data;\n  }\n}"],"version":3}