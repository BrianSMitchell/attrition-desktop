f5401ad7dfb3da68b5f0de02b738bf4e
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
jest.mock('@game/shared', () => ({
    getUnitSpec: jest.fn()
}));
const shared_1 = require("@game/shared");
// Mock getUnitSpec
const shared_2 = require("@game/shared");
const shared_3 = require("@game/shared");
const mockGetUnitSpec = shared_1.getUnitSpec;
/**
 * Calculate fleet size in credits based on unit composition (FR-6)
 * @param units - Array of fleet units with unitKey and count
 * @returns Total credits value of the fleet
 */
function calculateFleetSizeCredits(units) {
    if (!Array.isArray(units)) {
        return shared_3.STATUS_CODES.SUCCESS;
    }
    let totalCredits = 0;
    for (const unit of units) {
        const unitKey = unit?.unitKey || unit?.unit_key;
        const count = Number(unit?.count || 0);
        if (unitKey && count > 0) {
            try {
                const unitSpec = (0, shared_1.getUnitSpec)(unitKey);
                if (unitSpec && typeof unitSpec.creditsCost === 'number') {
                    totalCredits += unitSpec.creditsCost * count;
                }
            }
            catch {
                // Ignore units with missing specs
            }
        }
    }
    return totalCredits;
}
describe('Fleet Utils', () => {
    beforeEach(() => {
        jest.clearAllMocks();
    });
    describe('calculateFleetSizeCredits', () => {
        it('should calculate total credits for valid units', () => {
            mockGetUnitSpec.mockImplementation((unitKey) => {
                switch (unitKey) {
                    case 'fighter':
                        return { key: 'fighter', name: 'Fighter', creditsCost: 100, techPrereqs: [] };
                    case 'bomber':
                        return { key: 'bomber', name: 'Bomber', creditsCost: 250, techPrereqs: [] };
                    default:
                        throw new Error('Unit not found');
                }
            });
            const units = [
                { unitKey: 'fighter', count: 10 },
                { unitKey: 'bomber', count: 5 }
            ];
            const result = calculateFleetSizeCredits(units);
            expect(result).toBe(2250); // (10 * 100) + (5 * 250)
        });
        it('should handle empty units array', () => {
            const result = calculateFleetSizeCredits([]);
            expect(result).toBe(0);
        });
        it('should handle null/undefined units', () => {
            const result = calculateFleetSizeCredits(null);
            expect(result).toBe(0);
        });
        it('should ignore units with zero count', () => {
            mockGetUnitSpec.mockReturnValue({ key: 'test', name: 'Test', creditsCost: 100, techPrereqs: [] });
            const units = [
                { unitKey: 'fighter', count: 0 },
                { unitKey: 'bomber', count: 5 }
            ];
            const result = calculateFleetSizeCredits(units);
            expect(result).toBe(shared_2.HTTP_STATUS.INTERNAL_SERVER_ERROR); // Only bomber counts
        });
        it('should handle units with missing specs gracefully', () => {
            mockGetUnitSpec.mockImplementation((unitKey) => {
                if (unitKey === 'fighter') {
                    return { key: 'fighter', name: 'Fighter', creditsCost: 100, techPrereqs: [] };
                }
                throw new Error('Unit not found');
            });
            const units = [
                { unitKey: 'fighter', count: 10 },
                { unitKey: 'invalid_unit', count: 5 }
            ];
            const result = calculateFleetSizeCredits(units);
            expect(result).toBe(1000); // Only fighter counts
        });
        it('should handle both unitKey and unit_key formats', () => {
            mockGetUnitSpec.mockReturnValue({ key: 'test', name: 'Test', creditsCost: 100, techPrereqs: [] });
            const units = [
                { unitKey: 'fighter', count: 5 },
                { unit_key: 'bomber', count: 3 }
            ];
            const result = calculateFleetSizeCredits(units);
            expect(result).toBe(800); // (5 * 100) + (3 * 100)
        });
        it('should handle units with non-numeric creditsCost', () => {
            mockGetUnitSpec.mockImplementation((unitKey) => {
                switch (unitKey) {
                    case 'fighter':
                        return { key: 'fighter', name: 'Fighter', creditsCost: 100, techPrereqs: [] };
                    case 'special':
                        return { key: 'special', name: 'Special', creditsCost: null, techPrereqs: [] }; // Non-numeric
                    default:
                        return { key: 'default', name: 'Default', techPrereqs: [] };
                }
            });
            const units = [
                { unitKey: 'fighter', count: 5 },
                { unitKey: 'special', count: 3 }
            ];
            const result = calculateFleetSizeCredits(units);
            expect(result).toBe(shared_2.HTTP_STATUS.INTERNAL_SERVER_ERROR); // Only fighter counts
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFByb2plY3RzXFxBdHRyaXRpb25cXHBhY2thZ2VzXFxzZXJ2ZXJcXHNyY1xcX190ZXN0c19fXFxmbGVldFV0aWxzLnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7QUFLQSxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQy9CLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0NBQ3ZCLENBQUMsQ0FBQyxDQUFDO0FBUEoseUNBQTJDO0FBRTNDLG1CQUFtQjtBQUNuQix5Q0FBMkM7QUFDM0MseUNBQTRDO0FBSzVDLE1BQU0sZUFBZSxHQUFHLG9CQUFzRCxDQUFDO0FBRS9FOzs7O0dBSUc7QUFDSCxTQUFTLHlCQUF5QixDQUFDLEtBQW9FO0lBQ3JHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDMUIsT0FBTyxxQkFBWSxDQUFDLE9BQU8sQ0FBQztJQUM5QixDQUFDO0lBRUQsSUFBSSxZQUFZLEdBQUcsQ0FBQyxDQUFDO0lBRXJCLEtBQUssTUFBTSxJQUFJLElBQUksS0FBSyxFQUFFLENBQUM7UUFDekIsTUFBTSxPQUFPLEdBQUcsSUFBSSxFQUFFLE9BQU8sSUFBSSxJQUFJLEVBQUUsUUFBUSxDQUFDO1FBQ2hELE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxJQUFJLEVBQUUsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRXZDLElBQUksT0FBTyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUN6QixJQUFJLENBQUM7Z0JBQ0gsTUFBTSxRQUFRLEdBQUcsSUFBQSxvQkFBVyxFQUFDLE9BQWMsQ0FBQyxDQUFDO2dCQUM3QyxJQUFJLFFBQVEsSUFBSSxPQUFPLFFBQVEsQ0FBQyxXQUFXLEtBQUssUUFBUSxFQUFFLENBQUM7b0JBQ3pELFlBQVksSUFBSSxRQUFRLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQztnQkFDL0MsQ0FBQztZQUNILENBQUM7WUFBQyxNQUFNLENBQUM7Z0JB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QUFDLGtEQUFrRCxFQUFFLEdBQUcsRUFBRTtZQUMxRCxlQUFlLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxPQUFlLEVBQUUsRUFBRTtnQkFDckQsUUFBUSxPQUFPLEVBQUUsQ0FBQztvQkFDaEIsS0FBSyxTQUFTO3dCQUNaLE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBZ0IsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLEVBQUUsRUFBRSxDQUFDO29CQUN2RixLQUFLLFNBQVM7d0JBQ1osT0FBTyxFQUFFLEdBQUcsRUFBRSxTQUFnQixFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLElBQVcsRUFBRSxXQUFXLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxjQUFjO29CQUM5Rzt3QkFDRSxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQWdCLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsRUFBRSxFQUFTLENBQUM7Z0JBQzlFLENBQUM7WUFDSCxDQUFDLENBQUMsQ0FBQztZQUVILE1BQU0sS0FBSyxHQUFHO2dCQUNaLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFO2dCQUNoQyxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRTthQUNqQyxDQUFDO1lBRUYsTUFBTSxNQUFNLEdBQUcseUJBQXlCLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDaEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxvQkFBVyxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxzQkFBc0I7UUFDaEYsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxQcm9qZWN0c1xcQXR0cml0aW9uXFxwYWNrYWdlc1xcc2VydmVyXFxzcmNcXF9fdGVzdHNfX1xcZmxlZXRVdGlscy50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdldFVuaXRTcGVjIH0gZnJvbSAnQGdhbWUvc2hhcmVkJztcblxuLy8gTW9jayBnZXRVbml0U3BlY1xuaW1wb3J0IHsgSFRUUF9TVEFUVVMgfSBmcm9tICdAZ2FtZS9zaGFyZWQnO1xuaW1wb3J0IHsgU1RBVFVTX0NPREVTIH0gZnJvbSAnQGdhbWUvc2hhcmVkJztcbmplc3QubW9jaygnQGdhbWUvc2hhcmVkJywgKCkgPT4gKHtcbiAgZ2V0VW5pdFNwZWM6IGplc3QuZm4oKVxufSkpO1xuXG5jb25zdCBtb2NrR2V0VW5pdFNwZWMgPSBnZXRVbml0U3BlYyBhcyBqZXN0Lk1vY2tlZEZ1bmN0aW9uPHR5cGVvZiBnZXRVbml0U3BlYz47XG5cbi8qKlxuICogQ2FsY3VsYXRlIGZsZWV0IHNpemUgaW4gY3JlZGl0cyBiYXNlZCBvbiB1bml0IGNvbXBvc2l0aW9uIChGUi02KVxuICogQHBhcmFtIHVuaXRzIC0gQXJyYXkgb2YgZmxlZXQgdW5pdHMgd2l0aCB1bml0S2V5IGFuZCBjb3VudFxuICogQHJldHVybnMgVG90YWwgY3JlZGl0cyB2YWx1ZSBvZiB0aGUgZmxlZXRcbiAqL1xuZnVuY3Rpb24gY2FsY3VsYXRlRmxlZXRTaXplQ3JlZGl0cyh1bml0czogQXJyYXk8eyB1bml0S2V5Pzogc3RyaW5nOyB1bml0X2tleT86IHN0cmluZzsgY291bnQ6IG51bWJlciB9Pik6IG51bWJlciB7XG4gIGlmICghQXJyYXkuaXNBcnJheSh1bml0cykpIHtcbiAgICByZXR1cm4gU1RBVFVTX0NPREVTLlNVQ0NFU1M7XG4gIH1cblxuICBsZXQgdG90YWxDcmVkaXRzID0gMDtcbiAgXG4gIGZvciAoY29uc3QgdW5pdCBvZiB1bml0cykge1xuICAgIGNvbnN0IHVuaXRLZXkgPSB1bml0Py51bml0S2V5IHx8IHVuaXQ/LnVuaXRfa2V5O1xuICAgIGNvbnN0IGNvdW50ID0gTnVtYmVyKHVuaXQ/LmNvdW50IHx8IDApO1xuICAgIFxuICAgIGlmICh1bml0S2V5ICYmIGNvdW50ID4gMCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgdW5pdFNwZWMgPSBnZXRVbml0U3BlYyh1bml0S2V5IGFzIGFueSk7XG4gICAgICAgIGlmICh1bml0U3BlYyAmJiB0eXBlb2YgdW5pdFNwZWMuY3JlZGl0c0Nvc3QgPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgdG90YWxDcmVkaXRzICs9IHVuaXRTcGVjLmNyZWRpdHNDb3N0ICogY291bnQ7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2gge1xuICAgICAgICAvLyBJZ25vcmUgdW5pdHMgd2l0aCBtaXNzaW5nIHNwZWNzXG4gICAgICB9XG4gICAgfVxuICB9XG4gIFxuICByZXR1cm4gdG90YWxDcmVkaXRzO1xufVxuXG5kZXNjcmliZSgnRmxlZXQgVXRpbHMnLCAoKSA9PiB7XG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICB9KTtcblxuICBkZXNjcmliZSgnY2FsY3VsYXRlRmxlZXRTaXplQ3JlZGl0cycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNhbGN1bGF0ZSB0b3RhbCBjcmVkaXRzIGZvciB2YWxpZCB1bml0cycsICgpID0+IHtcbiAgICAgIG1vY2tHZXRVbml0U3BlYy5tb2NrSW1wbGVtZW50YXRpb24oKHVuaXRLZXk6IHN0cmluZykgPT4ge1xuICAgICAgICBzd2l0Y2ggKHVuaXRLZXkpIHtcbiAgICAgICAgICBjYXNlICdmaWdodGVyJzpcbiAgICAgICAgICAgIHJldHVybiB7IGtleTogJ2ZpZ2h0ZXInIGFzIGFueSwgbmFtZTogJ0ZpZ2h0ZXInLCBjcmVkaXRzQ29zdDogMTAwLCB0ZWNoUHJlcmVxczogW10gfTtcbiAgICAgICAgICBjYXNlICdib21iZXInOlxuICAgICAgICAgICAgcmV0dXJuIHsga2V5OiAnYm9tYmVyJyBhcyBhbnksIG5hbWU6ICdCb21iZXInLCBjcmVkaXRzQ29zdDogMjUwLCB0ZWNoUHJlcmVxczogW10gfTtcbiAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbml0IG5vdCBmb3VuZCcpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgY29uc3QgdW5pdHMgPSBbXG4gICAgICAgIHsgdW5pdEtleTogJ2ZpZ2h0ZXInLCBjb3VudDogMTAgfSxcbiAgICAgICAgeyB1bml0S2V5OiAnYm9tYmVyJywgY291bnQ6IDUgfVxuICAgICAgXTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gY2FsY3VsYXRlRmxlZXRTaXplQ3JlZGl0cyh1bml0cyk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKDIyNTApOyAvLyAoMTAgKiAxMDApICsgKDUgKiAyNTApXG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBlbXB0eSB1bml0cyBhcnJheScsICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGNhbGN1bGF0ZUZsZWV0U2l6ZUNyZWRpdHMoW10pO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZSgwKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIG51bGwvdW5kZWZpbmVkIHVuaXRzJywgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gY2FsY3VsYXRlRmxlZXRTaXplQ3JlZGl0cyhudWxsIGFzIGFueSk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKDApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBpZ25vcmUgdW5pdHMgd2l0aCB6ZXJvIGNvdW50JywgKCkgPT4ge1xuICAgICAgbW9ja0dldFVuaXRTcGVjLm1vY2tSZXR1cm5WYWx1ZSh7IGtleTogJ3Rlc3QnIGFzIGFueSwgbmFtZTogJ1Rlc3QnLCBjcmVkaXRzQ29zdDogMTAwLCB0ZWNoUHJlcmVxczogW10gfSk7XG5cbiAgICAgIGNvbnN0IHVuaXRzID0gW1xuICAgICAgICB7IHVuaXRLZXk6ICdmaWdodGVyJywgY291bnQ6IDAgfSxcbiAgICAgICAgeyB1bml0S2V5OiAnYm9tYmVyJywgY291bnQ6IDUgfVxuICAgICAgXTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gY2FsY3VsYXRlRmxlZXRTaXplQ3JlZGl0cyh1bml0cyk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKEhUVFBfU1RBVFVTLklOVEVSTkFMX1NFUlZFUl9FUlJPUik7IC8vIE9ubHkgYm9tYmVyIGNvdW50c1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgdW5pdHMgd2l0aCBtaXNzaW5nIHNwZWNzIGdyYWNlZnVsbHknLCAoKSA9PiB7XG4gICAgICBtb2NrR2V0VW5pdFNwZWMubW9ja0ltcGxlbWVudGF0aW9uKCh1bml0S2V5OiBzdHJpbmcpID0+IHtcbiAgICAgICAgaWYgKHVuaXRLZXkgPT09ICdmaWdodGVyJykge1xuICAgICAgICAgIHJldHVybiB7IGtleTogJ2ZpZ2h0ZXInIGFzIGFueSwgbmFtZTogJ0ZpZ2h0ZXInLCBjcmVkaXRzQ29zdDogMTAwLCB0ZWNoUHJlcmVxczogW10gfTtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuaXQgbm90IGZvdW5kJyk7XG4gICAgICB9KTtcblxuICAgICAgY29uc3QgdW5pdHMgPSBbXG4gICAgICAgIHsgdW5pdEtleTogJ2ZpZ2h0ZXInLCBjb3VudDogMTAgfSxcbiAgICAgICAgeyB1bml0S2V5OiAnaW52YWxpZF91bml0JywgY291bnQ6IDUgfVxuICAgICAgXTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gY2FsY3VsYXRlRmxlZXRTaXplQ3JlZGl0cyh1bml0cyk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKDEwMDApOyAvLyBPbmx5IGZpZ2h0ZXIgY291bnRzXG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBib3RoIHVuaXRLZXkgYW5kIHVuaXRfa2V5IGZvcm1hdHMnLCAoKSA9PiB7XG4gICAgICBtb2NrR2V0VW5pdFNwZWMubW9ja1JldHVyblZhbHVlKHsga2V5OiAndGVzdCcgYXMgYW55LCBuYW1lOiAnVGVzdCcsIGNyZWRpdHNDb3N0OiAxMDAsIHRlY2hQcmVyZXFzOiBbXSB9KTtcblxuICAgICAgY29uc3QgdW5pdHMgPSBbXG4gICAgICAgIHsgdW5pdEtleTogJ2ZpZ2h0ZXInLCBjb3VudDogNSB9LFxuICAgICAgICB7IHVuaXRfa2V5OiAnYm9tYmVyJywgY291bnQ6IDMgfVxuICAgICAgXTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gY2FsY3VsYXRlRmxlZXRTaXplQ3JlZGl0cyh1bml0cyk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKDgwMCk7IC8vICg1ICogMTAwKSArICgzICogMTAwKVxuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgdW5pdHMgd2l0aCBub24tbnVtZXJpYyBjcmVkaXRzQ29zdCcsICgpID0+IHtcbiAgICAgIG1vY2tHZXRVbml0U3BlYy5tb2NrSW1wbGVtZW50YXRpb24oKHVuaXRLZXk6IHN0cmluZykgPT4ge1xuICAgICAgICBzd2l0Y2ggKHVuaXRLZXkpIHtcbiAgICAgICAgICBjYXNlICdmaWdodGVyJzpcbiAgICAgICAgICAgIHJldHVybiB7IGtleTogJ2ZpZ2h0ZXInIGFzIGFueSwgbmFtZTogJ0ZpZ2h0ZXInLCBjcmVkaXRzQ29zdDogMTAwLCB0ZWNoUHJlcmVxczogW10gfTtcbiAgICAgICAgICBjYXNlICdzcGVjaWFsJzpcbiAgICAgICAgICAgIHJldHVybiB7IGtleTogJ3NwZWNpYWwnIGFzIGFueSwgbmFtZTogJ1NwZWNpYWwnLCBjcmVkaXRzQ29zdDogbnVsbCBhcyBhbnksIHRlY2hQcmVyZXFzOiBbXSB9OyAvLyBOb24tbnVtZXJpY1xuICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICByZXR1cm4geyBrZXk6ICdkZWZhdWx0JyBhcyBhbnksIG5hbWU6ICdEZWZhdWx0JywgdGVjaFByZXJlcXM6IFtdIH0gYXMgYW55O1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgY29uc3QgdW5pdHMgPSBbXG4gICAgICAgIHsgdW5pdEtleTogJ2ZpZ2h0ZXInLCBjb3VudDogNSB9LFxuICAgICAgICB7IHVuaXRLZXk6ICdzcGVjaWFsJywgY291bnQ6IDMgfVxuICAgICAgXTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gY2FsY3VsYXRlRmxlZXRTaXplQ3JlZGl0cyh1bml0cyk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKEhUVFBfU1RBVFVTLklOVEVSTkFMX1NFUlZFUl9FUlJPUik7IC8vIE9ubHkgZmlnaHRlciBjb3VudHNcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==