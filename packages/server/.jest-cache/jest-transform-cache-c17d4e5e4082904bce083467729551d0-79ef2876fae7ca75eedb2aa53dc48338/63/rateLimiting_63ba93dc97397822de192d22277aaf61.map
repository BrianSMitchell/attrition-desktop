{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\middleware\\rateLimiting.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\middleware\\rateLimiting.ts"],"sourcesContent":["import rateLimit from 'express-rate-limit';\r\nimport { Request, Response, NextFunction } from 'express';\r\nimport { HTTP_STATUS } from '../constants/response-formats';\r\nimport { ENV_VARS, ENV_VALUES } from '@game/shared';\r\n\r\n\r\n// Store for tracking failed login attempts per IP\r\nconst loginAttempts = new Map<string, { count: number; lastAttempt: number; lockedUntil?: number }>();\r\n\r\n// Clean up old entries periodically (every 15 minutes)\r\nsetInterval(() => {\r\n  const now = Date.now();\r\n  const CLEANUP_AGE = 15 * 60 * 1000; // 15 minutes\r\n  \r\n  for (const [ip, data] of loginAttempts.entries()) {\r\n    if (now - data.lastAttempt > CLEANUP_AGE && (!data.lockedUntil || now > data.lockedUntil)) {\r\n      loginAttempts.delete(ip);\r\n    }\r\n  }\r\n}, 15 * 60 * 1000);\r\n\r\n// General rate limiter for auth endpoints (relaxed for private game)\r\nexport const authRateLimit = rateLimit({\r\n  windowMs: 15 * 60 * 1000, // 15 minutes\r\n  max: process.env[ENV_VARS.NODE_ENV] === ENV_VALUES.PRODUCTION ? 100 : HTTP_STATUS.OK, // More lenient for private game - 100 per 15min in production\r\n  message: {\r\n    success: false,\r\n    error: 'Too many requests from this IP, please try again later.',\r\n  },\r\n  standardHeaders: true,\r\n  legacyHeaders: false,\r\n});\r\n\r\n// Login rate limiter (relaxed for private game)\r\nexport const loginRateLimit = rateLimit({\r\n  windowMs: 15 * 60 * 1000, // 15 minutes\r\n  max: process.env[ENV_VARS.NODE_ENV] === ENV_VALUES.PRODUCTION ? 30 : 50, // More lenient for private game - 30 per 15min in production\r\n  message: {\r\n    success: false,\r\n    error: 'Too many login attempts from this IP, please try again later.',\r\n  },\r\n  standardHeaders: true,\r\n  legacyHeaders: false,\r\n  skipSuccessfulRequests: true, // Don't count successful requests\r\n});\r\n\r\n// Account lockout middleware\r\nexport const accountLockout = (req: Request, res: Response, next: NextFunction) => {\r\n  const ip = req.ip || (req.socket && req.socket.remoteAddress) || 'unknown';\r\n  const now = Date.now();\r\n  const attempt = loginAttempts.get(ip);\r\n\r\n  // Check if IP is currently locked out\r\n  if (attempt && attempt.lockedUntil && now < attempt.lockedUntil) {\r\n    const remainingTime = Math.ceil((attempt.lockedUntil - now) / 1000 / 60); // minutes\r\n    return res.status(HTTP_STATUS.TOO_MANY_REQUESTS).json({\r\n      success: false,\r\n      error: `Account temporarily locked due to too many failed attempts. Try again in ${remainingTime} minutes.`,\r\n    });\r\n  }\r\n\r\n  // Clear lockout if expired\r\n  if (attempt && attempt.lockedUntil && now >= attempt.lockedUntil) {\r\n    loginAttempts.delete(ip);\r\n  }\r\n\r\n  next();\r\n};\r\n\r\n// Track failed login attempts\r\nexport const trackFailedLogin = (req: Request) => {\r\n  const ip = req.ip || (req.socket && req.socket.remoteAddress) || 'unknown';\r\n  const now = Date.now();\r\n  const attempt = loginAttempts.get(ip) || { count: 0, lastAttempt: 0 };\r\n\r\n  attempt.count += 1;\r\n  attempt.lastAttempt = now;\r\n\r\n  // Lock account after 5 failed attempts\r\n  if (attempt.count >= 5) {\r\n    attempt.lockedUntil = now + (30 * 60 * 1000); // 30 minutes lockout\r\n    console.warn(`IP ${ip} locked out for 30 minutes after ${attempt.count} failed login attempts`);\r\n  }\r\n\r\n  loginAttempts.set(ip, attempt);\r\n};\r\n\r\n// Clear failed attempts on successful login\r\nexport const clearFailedAttempts = (req: Request) => {\r\n  const ip = req.ip || (req.socket && req.socket.remoteAddress) || 'unknown';\r\n  loginAttempts.delete(ip);\r\n};\r\n\r\n// Registration rate limiter (relaxed for private game usage)\r\nexport const registerRateLimit = rateLimit({\r\n  windowMs: 60 * 60 * 1000, // 1 hour\r\n  max: process.env[ENV_VARS.NODE_ENV] === ENV_VALUES.PRODUCTION ? 20 : 30, // More lenient for private game - 20 per hour in production\r\n  message: {\r\n    success: false,\r\n    error: 'Too many registration attempts from this IP, please try again later.',\r\n  },\r\n  standardHeaders: true,\r\n  legacyHeaders: false,\r\n});\r\n\r\n// Token refresh rate limiter\r\nexport const refreshRateLimit = rateLimit({\r\n  windowMs: 15 * 60 * 1000, // 15 minutes\r\n  max: process.env[ENV_VARS.NODE_ENV] === ENV_VALUES.PRODUCTION ? 100 : HTTP_STATUS.INTERNAL_SERVER_ERROR, // Allow more frequent refreshes\r\n  message: {\r\n    success: false,\r\n    error: 'Too many token refresh requests, please try again later.',\r\n  },\r\n  standardHeaders: true,\r\n  legacyHeaders: false,\r\n});\r\n\r\n\r\n\r\n"],"version":3}