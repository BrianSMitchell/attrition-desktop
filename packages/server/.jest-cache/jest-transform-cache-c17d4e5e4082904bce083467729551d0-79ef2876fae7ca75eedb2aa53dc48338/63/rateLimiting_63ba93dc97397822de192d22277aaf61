953fd4ca64389e41ef77677966fff7b2
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.refreshRateLimit = exports.registerRateLimit = exports.clearFailedAttempts = exports.trackFailedLogin = exports.accountLockout = exports.loginRateLimit = exports.authRateLimit = void 0;
const express_rate_limit_1 = __importDefault(require("express-rate-limit"));
const response_formats_1 = require("../constants/response-formats");
const shared_1 = require("@game/shared");
// Store for tracking failed login attempts per IP
const loginAttempts = new Map();
// Clean up old entries periodically (every 15 minutes)
setInterval(() => {
    const now = Date.now();
    const CLEANUP_AGE = 15 * 60 * 1000; // 15 minutes
    for (const [ip, data] of loginAttempts.entries()) {
        if (now - data.lastAttempt > CLEANUP_AGE && (!data.lockedUntil || now > data.lockedUntil)) {
            loginAttempts.delete(ip);
        }
    }
}, 15 * 60 * 1000);
// General rate limiter for auth endpoints (relaxed for private game)
exports.authRateLimit = (0, express_rate_limit_1.default)({
    windowMs: 15 * 60 * 1000, // 15 minutes
    max: process.env[shared_1.ENV_VARS.NODE_ENV] === shared_1.ENV_VALUES.PRODUCTION ? 100 : response_formats_1.HTTP_STATUS.OK, // More lenient for private game - 100 per 15min in production
    message: {
        success: false,
        error: 'Too many requests from this IP, please try again later.',
    },
    standardHeaders: true,
    legacyHeaders: false,
});
// Login rate limiter (relaxed for private game)
exports.loginRateLimit = (0, express_rate_limit_1.default)({
    windowMs: 15 * 60 * 1000, // 15 minutes
    max: process.env[shared_1.ENV_VARS.NODE_ENV] === shared_1.ENV_VALUES.PRODUCTION ? 30 : 50, // More lenient for private game - 30 per 15min in production
    message: {
        success: false,
        error: 'Too many login attempts from this IP, please try again later.',
    },
    standardHeaders: true,
    legacyHeaders: false,
    skipSuccessfulRequests: true, // Don't count successful requests
});
// Account lockout middleware
const accountLockout = (req, res, next) => {
    const ip = req.ip || (req.socket && req.socket.remoteAddress) || 'unknown';
    const now = Date.now();
    const attempt = loginAttempts.get(ip);
    // Check if IP is currently locked out
    if (attempt && attempt.lockedUntil && now < attempt.lockedUntil) {
        const remainingTime = Math.ceil((attempt.lockedUntil - now) / 1000 / 60); // minutes
        return res.status(response_formats_1.HTTP_STATUS.TOO_MANY_REQUESTS).json({
            success: false,
            error: `Account temporarily locked due to too many failed attempts. Try again in ${remainingTime} minutes.`,
        });
    }
    // Clear lockout if expired
    if (attempt && attempt.lockedUntil && now >= attempt.lockedUntil) {
        loginAttempts.delete(ip);
    }
    next();
};
exports.accountLockout = accountLockout;
// Track failed login attempts
const trackFailedLogin = (req) => {
    const ip = req.ip || (req.socket && req.socket.remoteAddress) || 'unknown';
    const now = Date.now();
    const attempt = loginAttempts.get(ip) || { count: 0, lastAttempt: 0 };
    attempt.count += 1;
    attempt.lastAttempt = now;
    // Lock account after 5 failed attempts
    if (attempt.count >= 5) {
        attempt.lockedUntil = now + (30 * 60 * 1000); // 30 minutes lockout
        console.warn(`IP ${ip} locked out for 30 minutes after ${attempt.count} failed login attempts`);
    }
    loginAttempts.set(ip, attempt);
};
exports.trackFailedLogin = trackFailedLogin;
// Clear failed attempts on successful login
const clearFailedAttempts = (req) => {
    const ip = req.ip || (req.socket && req.socket.remoteAddress) || 'unknown';
    loginAttempts.delete(ip);
};
exports.clearFailedAttempts = clearFailedAttempts;
// Registration rate limiter (relaxed for private game usage)
exports.registerRateLimit = (0, express_rate_limit_1.default)({
    windowMs: 60 * 60 * 1000, // 1 hour
    max: process.env[shared_1.ENV_VARS.NODE_ENV] === shared_1.ENV_VALUES.PRODUCTION ? 20 : 30, // More lenient for private game - 20 per hour in production
    message: {
        success: false,
        error: 'Too many registration attempts from this IP, please try again later.',
    },
    standardHeaders: true,
    legacyHeaders: false,
});
// Token refresh rate limiter
exports.refreshRateLimit = (0, express_rate_limit_1.default)({
    windowMs: 15 * 60 * 1000, // 15 minutes
    max: process.env[shared_1.ENV_VARS.NODE_ENV] === shared_1.ENV_VALUES.PRODUCTION ? 100 : response_formats_1.HTTP_STATUS.INTERNAL_SERVER_ERROR, // Allow more frequent refreshes
    message: {
        success: false,
        error: 'Too many token refresh requests, please try again later.',
    },
    standardHeaders: true,
    legacyHeaders: false,
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFByb2plY3RzXFxBdHRyaXRpb25cXHBhY2thZ2VzXFxzZXJ2ZXJcXHNyY1xcbWlkZGxld2FyZVxccmF0ZUxpbWl0aW5nLnRzIiwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLDRFQUEyQztBQUUzQyxvRUFBNEQ7QUFDNUQseUNBQW9EO0FBR3BELGtEQUFrRDtBQUNsRCxNQUFNLGFBQWEsR0FBRyxJQUFJLEdBQUcsRUFBd0UsQ0FBQztBQUV0Ryx1REFBdUQ7QUFDdkQsV0FBVyxDQUFDLEdBQUcsRUFBRTtJQUNmLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUN2QixNQUFNLFdBQVcsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLGFBQWE7SUFFakQsS0FBSyxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxJQUFJLGFBQWEsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDO1FBQ2pELElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQztZQUMxRixhQUFhLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzNCLENBQUM7SUFDSCxDQUFDO0FBQ0gsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7QUFFbkIscUVBQXFFO0FBQ3hELFFBQUEsYUFBYSxHQUFHLElBQUEsNEJBQVMsRUFBQztJQUNyQyxRQUFRLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLEVBQUUsYUFBYTtJQUN2QyxHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBUSxDQUFDLFFBQVEsQ0FBQyxLQUFLLG1CQUFVLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLDhCQUFXLENBQUMsRUFBRSxFQUFFLDhEQUE4RDtJQUNwSixP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QUM7SUFDeEMsUUFBUSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUFFLGFBQWE7SUFDdkMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQVEsQ0FBQyxRQUFRLENBQUMsS0FBSyxtQkFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyw4QkFBVyxDQUFDLHFCQUFxQixFQUFFLGdDQUFnQztJQUN6SSxPQUFPLEVBQUU7UUFDUCxPQUFPLEVBQUUsS0FBSztRQUNkLEtBQUssRUFBRSwwREFBMEQ7S0FDbEU7SUFDRCxlQUFlLEVBQUUsSUFBSTtJQUNyQixhQUFhLEVBQUUsS0FBSztDQUNyQixDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFByb2plY3RzXFxBdHRyaXRpb25cXHBhY2thZ2VzXFxzZXJ2ZXJcXHNyY1xcbWlkZGxld2FyZVxccmF0ZUxpbWl0aW5nLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByYXRlTGltaXQgZnJvbSAnZXhwcmVzcy1yYXRlLWxpbWl0JztcclxuaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQgeyBIVFRQX1NUQVRVUyB9IGZyb20gJy4uL2NvbnN0YW50cy9yZXNwb25zZS1mb3JtYXRzJztcclxuaW1wb3J0IHsgRU5WX1ZBUlMsIEVOVl9WQUxVRVMgfSBmcm9tICdAZ2FtZS9zaGFyZWQnO1xyXG5cclxuXHJcbi8vIFN0b3JlIGZvciB0cmFja2luZyBmYWlsZWQgbG9naW4gYXR0ZW1wdHMgcGVyIElQXHJcbmNvbnN0IGxvZ2luQXR0ZW1wdHMgPSBuZXcgTWFwPHN0cmluZywgeyBjb3VudDogbnVtYmVyOyBsYXN0QXR0ZW1wdDogbnVtYmVyOyBsb2NrZWRVbnRpbD86IG51bWJlciB9PigpO1xyXG5cclxuLy8gQ2xlYW4gdXAgb2xkIGVudHJpZXMgcGVyaW9kaWNhbGx5IChldmVyeSAxNSBtaW51dGVzKVxyXG5zZXRJbnRlcnZhbCgoKSA9PiB7XHJcbiAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcclxuICBjb25zdCBDTEVBTlVQX0FHRSA9IDE1ICogNjAgKiAxMDAwOyAvLyAxNSBtaW51dGVzXHJcbiAgXHJcbiAgZm9yIChjb25zdCBbaXAsIGRhdGFdIG9mIGxvZ2luQXR0ZW1wdHMuZW50cmllcygpKSB7XHJcbiAgICBpZiAobm93IC0gZGF0YS5sYXN0QXR0ZW1wdCA+IENMRUFOVVBfQUdFICYmICghZGF0YS5sb2NrZWRVbnRpbCB8fCBub3cgPiBkYXRhLmxvY2tlZFVudGlsKSkge1xyXG4gICAgICBsb2dpbkF0dGVtcHRzLmRlbGV0ZShpcCk7XHJcbiAgICB9XHJcbiAgfVxyXG59LCAxNSAqIDYwICogMTAwMCk7XHJcblxyXG4vLyBHZW5lcmFsIHJhdGUgbGltaXRlciBmb3IgYXV0aCBlbmRwb2ludHMgKHJlbGF4ZWQgZm9yIHByaXZhdGUgZ2FtZSlcclxuZXhwb3J0IGNvbnN0IGF1dGhSYXRlTGltaXQgPSByYXRlTGltaXQoe1xyXG4gIHdpbmRvd01zOiAxNSAqIDYwICogMTAwMCwgLy8gMTUgbWludXRlc1xyXG4gIG1heDogcHJvY2Vzcy5lbnZbRU5WX1ZBUlMuTk9ERV9FTlZdID09PSBFTlZfVkFMVUVTLlBST0RVQ1RJT04gPyAxMDAgOiBIVFRQX1NUQVRVUy5PSywgLy8gTW9yZSBsZW5pZW50IGZvciBwcml2YXRlIGdhbWUgLSAxMDAgcGVyIDE1bWluIGluIHByb2R1Y3Rpb25cclxuICBtZXNzYWdlOiB7XHJcbiAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgIGVycm9yOiAnVG9vIG1hbnkgcmVxdWVzdHMgZnJvbSB0aGlzIElQLCBwbGVhc2UgdHJ5IGFnYWluIGxhdGVyLicsXHJcbiAgfSxcclxuICBzdGFuZGFyZEhlYWRlcnM6IHRydWUsXHJcbiAgbGVnYWN5SGVhZGVyczogZmFsc2UsXHJcbn0pO1xyXG5cclxuLy8gTG9naW4gcmF0ZSBsaW1pdGVyIChyZWxheGVkIGZvciBwcml2YXRlIGdhbWUpXHJcbmV4cG9ydCBjb25zdCBsb2dpblJhdGVMaW1pdCA9IHJhdGVMaW1pdCh7XHJcbiAgd2luZG93TXM6IDE1ICogNjAgKiAxMDAwLCAvLyAxNSBtaW51dGVzXHJcbiAgbWF4OiBwcm9jZXNzLmVudltFTlZfVkFSUy5OT0RFX0VOVl0gPT09IEVOVl9WQUxVRVMuUFJPRFVDVElPTiA/IDMwIDogNTAsIC8vIE1vcmUgbGVuaWVudCBmb3IgcHJpdmF0ZSBnYW1lIC0gMzAgcGVyIDE1bWluIGluIHByb2R1Y3Rpb25cclxuICBtZXNzYWdlOiB7XHJcbiAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgIGVycm9yOiAnVG9vIG1hbnkgbG9naW4gYXR0ZW1wdHMgZnJvbSB0aGlzIElQLCBwbGVhc2UgdHJ5IGFnYWluIGxhdGVyLicsXHJcbiAgfSxcclxuICBzdGFuZGFyZEhlYWRlcnM6IHRydWUsXHJcbiAgbGVnYWN5SGVhZGVyczogZmFsc2UsXHJcbiAgc2tpcFN1Y2Nlc3NmdWxSZXF1ZXN0czogdHJ1ZSwgLy8gRG9uJ3QgY291bnQgc3VjY2Vzc2Z1bCByZXF1ZXN0c1xyXG59KTtcclxuXHJcbi8vIEFjY291bnQgbG9ja291dCBtaWRkbGV3YXJlXHJcbmV4cG9ydCBjb25zdCBhY2NvdW50TG9ja291dCA9IChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xyXG4gIGNvbnN0IGlwID0gcmVxLmlwIHx8IChyZXEuc29ja2V0ICYmIHJlcS5zb2NrZXQucmVtb3RlQWRkcmVzcykgfHwgJ3Vua25vd24nO1xyXG4gIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XHJcbiAgY29uc3QgYXR0ZW1wdCA9IGxvZ2luQXR0ZW1wdHMuZ2V0KGlwKTtcclxuXHJcbiAgLy8gQ2hlY2sgaWYgSVAgaXMgY3VycmVudGx5IGxvY2tlZCBvdXRcclxuICBpZiAoYXR0ZW1wdCAmJiBhdHRlbXB0LmxvY2tlZFVudGlsICYmIG5vdyA8IGF0dGVtcHQubG9ja2VkVW50aWwpIHtcclxuICAgIGNvbnN0IHJlbWFpbmluZ1RpbWUgPSBNYXRoLmNlaWwoKGF0dGVtcHQubG9ja2VkVW50aWwgLSBub3cpIC8gMTAwMCAvIDYwKTsgLy8gbWludXRlc1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuVE9PX01BTllfUkVRVUVTVFMpLmpzb24oe1xyXG4gICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgZXJyb3I6IGBBY2NvdW50IHRlbXBvcmFyaWx5IGxvY2tlZCBkdWUgdG8gdG9vIG1hbnkgZmFpbGVkIGF0dGVtcHRzLiBUcnkgYWdhaW4gaW4gJHtyZW1haW5pbmdUaW1lfSBtaW51dGVzLmAsXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8vIENsZWFyIGxvY2tvdXQgaWYgZXhwaXJlZFxyXG4gIGlmIChhdHRlbXB0ICYmIGF0dGVtcHQubG9ja2VkVW50aWwgJiYgbm93ID49IGF0dGVtcHQubG9ja2VkVW50aWwpIHtcclxuICAgIGxvZ2luQXR0ZW1wdHMuZGVsZXRlKGlwKTtcclxuICB9XHJcblxyXG4gIG5leHQoKTtcclxufTtcclxuXHJcbi8vIFRyYWNrIGZhaWxlZCBsb2dpbiBhdHRlbXB0c1xyXG5leHBvcnQgY29uc3QgdHJhY2tGYWlsZWRMb2dpbiA9IChyZXE6IFJlcXVlc3QpID0+IHtcclxuICBjb25zdCBpcCA9IHJlcS5pcCB8fCAocmVxLnNvY2tldCAmJiByZXEuc29ja2V0LnJlbW90ZUFkZHJlc3MpIHx8ICd1bmtub3duJztcclxuICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xyXG4gIGNvbnN0IGF0dGVtcHQgPSBsb2dpbkF0dGVtcHRzLmdldChpcCkgfHwgeyBjb3VudDogMCwgbGFzdEF0dGVtcHQ6IDAgfTtcclxuXHJcbiAgYXR0ZW1wdC5jb3VudCArPSAxO1xyXG4gIGF0dGVtcHQubGFzdEF0dGVtcHQgPSBub3c7XHJcblxyXG4gIC8vIExvY2sgYWNjb3VudCBhZnRlciA1IGZhaWxlZCBhdHRlbXB0c1xyXG4gIGlmIChhdHRlbXB0LmNvdW50ID49IDUpIHtcclxuICAgIGF0dGVtcHQubG9ja2VkVW50aWwgPSBub3cgKyAoMzAgKiA2MCAqIDEwMDApOyAvLyAzMCBtaW51dGVzIGxvY2tvdXRcclxuICAgIGNvbnNvbGUud2FybihgSVAgJHtpcH0gbG9ja2VkIG91dCBmb3IgMzAgbWludXRlcyBhZnRlciAke2F0dGVtcHQuY291bnR9IGZhaWxlZCBsb2dpbiBhdHRlbXB0c2ApO1xyXG4gIH1cclxuXHJcbiAgbG9naW5BdHRlbXB0cy5zZXQoaXAsIGF0dGVtcHQpO1xyXG59O1xyXG5cclxuLy8gQ2xlYXIgZmFpbGVkIGF0dGVtcHRzIG9uIHN1Y2Nlc3NmdWwgbG9naW5cclxuZXhwb3J0IGNvbnN0IGNsZWFyRmFpbGVkQXR0ZW1wdHMgPSAocmVxOiBSZXF1ZXN0KSA9PiB7XHJcbiAgY29uc3QgaXAgPSByZXEuaXAgfHwgKHJlcS5zb2NrZXQgJiYgcmVxLnNvY2tldC5yZW1vdGVBZGRyZXNzKSB8fCAndW5rbm93bic7XHJcbiAgbG9naW5BdHRlbXB0cy5kZWxldGUoaXApO1xyXG59O1xyXG5cclxuLy8gUmVnaXN0cmF0aW9uIHJhdGUgbGltaXRlciAocmVsYXhlZCBmb3IgcHJpdmF0ZSBnYW1lIHVzYWdlKVxyXG5leHBvcnQgY29uc3QgcmVnaXN0ZXJSYXRlTGltaXQgPSByYXRlTGltaXQoe1xyXG4gIHdpbmRvd01zOiA2MCAqIDYwICogMTAwMCwgLy8gMSBob3VyXHJcbiAgbWF4OiBwcm9jZXNzLmVudltFTlZfVkFSUy5OT0RFX0VOVl0gPT09IEVOVl9WQUxVRVMuUFJPRFVDVElPTiA/IDIwIDogMzAsIC8vIE1vcmUgbGVuaWVudCBmb3IgcHJpdmF0ZSBnYW1lIC0gMjAgcGVyIGhvdXIgaW4gcHJvZHVjdGlvblxyXG4gIG1lc3NhZ2U6IHtcclxuICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgZXJyb3I6ICdUb28gbWFueSByZWdpc3RyYXRpb24gYXR0ZW1wdHMgZnJvbSB0aGlzIElQLCBwbGVhc2UgdHJ5IGFnYWluIGxhdGVyLicsXHJcbiAgfSxcclxuICBzdGFuZGFyZEhlYWRlcnM6IHRydWUsXHJcbiAgbGVnYWN5SGVhZGVyczogZmFsc2UsXHJcbn0pO1xyXG5cclxuLy8gVG9rZW4gcmVmcmVzaCByYXRlIGxpbWl0ZXJcclxuZXhwb3J0IGNvbnN0IHJlZnJlc2hSYXRlTGltaXQgPSByYXRlTGltaXQoe1xyXG4gIHdpbmRvd01zOiAxNSAqIDYwICogMTAwMCwgLy8gMTUgbWludXRlc1xyXG4gIG1heDogcHJvY2Vzcy5lbnZbRU5WX1ZBUlMuTk9ERV9FTlZdID09PSBFTlZfVkFMVUVTLlBST0RVQ1RJT04gPyAxMDAgOiBIVFRQX1NUQVRVUy5JTlRFUk5BTF9TRVJWRVJfRVJST1IsIC8vIEFsbG93IG1vcmUgZnJlcXVlbnQgcmVmcmVzaGVzXHJcbiAgbWVzc2FnZToge1xyXG4gICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICBlcnJvcjogJ1RvbyBtYW55IHRva2VuIHJlZnJlc2ggcmVxdWVzdHMsIHBsZWFzZSB0cnkgYWdhaW4gbGF0ZXIuJyxcclxuICB9LFxyXG4gIHN0YW5kYXJkSGVhZGVyczogdHJ1ZSxcclxuICBsZWdhY3lIZWFkZXJzOiBmYWxzZSxcclxufSk7XHJcblxyXG5cclxuXHJcbiJdLCJ2ZXJzaW9uIjozfQ==