{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\services\\bases\\StatsService.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\services\\bases\\StatsService.ts"],"sourcesContent":["import { supabase } from '../../config/supabase';\nimport {\n  getBuildingSpec,\n  type BuildingKey,\n  computeEnergyBalance,\n  getDefensesList,\n} from '@game/shared';\n\n// Constants imports for eliminating hardcoded values\nimport { DB_TABLES, DB_FIELDS } from '../../constants/database-fields';\nimport { CapacityService } from '../bases/CapacityService';\n\n/**\n * Population capacity per Urban Structures level equals the planet's fertility.\n * i.e., capacity contribution = level * fertility.\n * This ties starting population to fertility since new bases get a free L1 Urban.\n */\n\n\nexport interface BaseStatsDTO {\n  area: {\n    total: number;\n    used: number;\n    free: number;\n  };\n  energy: {\n    produced: number;\n    consumed: number;\n    balance: number;\n    rawBalance?: number; // exposed for UI parity without reservations\n    projectedBalance?: number; // alias of balance for clarity\n  };\n  population: {\n    used: number;\n    capacity: number;\n    free: number;\n  };\n  citizens: {\n    count: number;\n    perHour: number;\n  };\n  ownerIncomeCredPerHour: number;\n}\n\n/**\n * Compute base budgets visible to the player for a given empire and location.\n * - Only counts active buildings for the given empire at that coord\n * - Uses shared building catalog to aggregate area/energy/pop/economy\n * - Urban Structures provide population capacity per level equal to the planet's fertility\n */\nexport class StatsService {\n  static async getBaseStats(empireId: string, locationCoord: string): Promise<BaseStatsDTO> {\n    // 1) Environment totals from Overhaul (area, etc.)\n    const { data: location, error: locationError } = await supabase\n      .from(DB_TABLES.LOCATIONS)\n      .select(DB_FIELDS.LOCATIONS.RESULT)\n      .eq('coord', locationCoord)\n      .maybeSingle();\n\n    if (locationError) {\n      console.error('[BaseStatsService] Error fetching location:', locationError);\n    }\n\n    const areaTotal = Math.max(0, Number((location as any)?.result?.area ?? 0));\n    const fertility = Math.max(\n      0,\n      Number(\n        (location as any)?.result?.fertility ??\n          (location as any)?.properties?.fertility ??\n          0\n      )\n    );\n\n    // Extract per-planet resource values for solar/gas plants\n    const solarEnergy = Math.max(0, Number((location as any)?.result?.solarEnergy ?? 0));\n    const gasResource = Math.max(0, Number((location as any)?.result?.yields?.gas ?? 0));\n\n    // 2) Get all buildings for this empire at this location\n    const { data: buildings, error: buildingsError } = await supabase\n      .from(DB_TABLES.BUILDINGS)\n      .select('level, catalog_key, is_active, pending_upgrade, construction_started, construction_completed')\n      .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n      .eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, locationCoord);\n\n    if (buildingsError) {\n      console.error('[BaseStatsService] Error fetching buildings:', buildingsError);\n    }\n\n    let areaUsed = 0;\n    let areaReserved = 0;\n    let populationUsed = 0;\n    let populationReserved = 0;\n    let populationCapacity = 0;\n    let ownerIncome = 0;\n\n    // Separate active buildings from those under construction\n    const activeBuildings: Array<{ key: string; level: number; isActive: boolean }> = [];\n    const constructionQueue: Array<{ key: string; level: number }> = [];\n\n    for (const b of (buildings || [])) {\n      const isActive = (b as any).is_active === true;\n      const pendingUpgrade = (b as any).pending_upgrade === true;\n      const level = Math.max(0, Number((b as any).level || 0));\n      const catalogKey = (b as any).catalog_key as BuildingKey | undefined;\n\n      if (!catalogKey) {\n        console.warn(\"[BaseStatsService] skip: missing catalogKey _id=%s\", (b as any)._id?.toString?.());\n        continue;\n      }\n\n      const spec = getBuildingSpec(catalogKey);\n      const areaReq = Math.max(0, Number(spec.areaRequired ?? 0));\n      const popReq = Math.max(0, Number(spec.populationRequired ?? 0));\n\n      const countsAsActive = (isActive || pendingUpgrade) && level > 0;\n      const isUnderConstruction = !isActive && (b as any).construction_completed; // queued step exists\n\n      if (countsAsActive) {\n        // Count current active level even while upgrading (pendingUpgrade=true)\n        activeBuildings.push({ key: catalogKey, level, isActive: true });\n        areaUsed += level * areaReq;\n        populationUsed += level * popReq;\n\n        // Population capacity from Urban Structures\n        if (catalogKey === 'urban_structures') {\n          populationCapacity += level * fertility;\n        }\n\n        // Owner Income (credits/hour)\n        const econ = Math.max(0, Number(spec.economy || 0));\n        ownerIncome += level * econ;\n      }\n\n      if (isUnderConstruction) {\n        // Under construction - count reservation for the next step only\n        const targetLevel = level > 0 ? level + 1 : 1; // If upgrading, next level; if new, level 1\n        constructionQueue.push({ key: catalogKey, level: targetLevel });\n        // Reserve area and population for this single step\n        areaReserved += areaReq;\n        populationReserved += popReq;\n      }\n    }\n\n    // Calculate current energy (active buildings only)\n    const currentEnergy = computeEnergyBalance({\n      buildingsAtBase: activeBuildings,\n      location: { solarEnergy, gasYield: gasResource },\n      includeQueuedReservations: false, // Don't include reservations in current balance\n    });\n\n    // Incorporate completed defenses into energy (consumption/production)\n    // Each completed defense queue item counts as one level of that defense at the base.\n    const { data: completedDefenses, error: completedDefensesError } = await supabase\n      .from(DB_TABLES.DEFENSE_QUEUE)\n      .select(DB_FIELDS.DEFENSE_QUEUE.DEFENSE_KEY)\n      .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n      .eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, locationCoord)\n      .eq(DB_FIELDS.TECH_QUEUE.STATUS, 'completed');\n\n    if (completedDefensesError) {\n      console.error('[BaseStatsService] Error fetching completed defenses:', completedDefensesError);\n    }\n\n    const defenseSpecByKey = new Map<string, { energyDelta: number; name: string }>();\n    for (const d of getDefensesList()) {\n      defenseSpecByKey.set(String((d as any).key), { energyDelta: Number((d as any).energyDelta || 0), name: String((d as any).name || String((d as any).key)) });\n    }\n\n    const defenseCountByKey = new Map<string, number>();\n    for (const it of (completedDefenses || [])) {\n      const k = String((it as any).defense_key || '');\n      if (!k) continue;\n      defenseCountByKey.set(k, (defenseCountByKey.get(k) || 0) + 1);\n    }\n\n    let defenseProduced = 0;\n    let defenseConsumed = 0;\n    for (const [k, count] of defenseCountByKey.entries()) {\n      const spec = defenseSpecByKey.get(k);\n      const delta = Number(spec?.energyDelta || 0);\n      if (delta >= 0) defenseProduced += count * delta;\n      else defenseConsumed += count * Math.abs(delta);\n    }\n\n    const producedWithDef = currentEnergy.produced + defenseProduced;\n    const consumedWithDef = currentEnergy.consumed + defenseConsumed;\n    const rawBalanceWithDef = producedWithDef - consumedWithDef;\n\n    // Calculate projected energy (with construction queue) and reserve queued negatives (buildings + defenses)\n    let projectedBalance = rawBalanceWithDef;\n    let reservedNegative = 0;\n\n    if (constructionQueue.length > 0) {\n      // Only count negative energy deltas from the construction queue\n      for (const item of constructionQueue) {\n        const spec = getBuildingSpec(item.key as BuildingKey);\n        const delta = Number(spec?.energyDelta || 0);\n        if (delta < 0) {\n          reservedNegative += delta; // Single step reservation\n        }\n      }\n    }\n\n    // Also reserve queued negative energy from scheduled defense items at this base\n    try {\n      const now = new Date();\n      const { data: scheduledDefense, error: scheduledDefenseError } = await supabase\n        .from(DB_TABLES.DEFENSE_QUEUE)\n        .select(DB_FIELDS.DEFENSE_QUEUE.DEFENSE_KEY)\n        .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n        .eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, locationCoord)\n        .eq(DB_FIELDS.TECH_QUEUE.STATUS, 'pending')\n        .gt(DB_FIELDS.TECH_QUEUE.COMPLETES_AT, now.toISOString());\n\n      if (scheduledDefenseError) {\n        console.error('[BaseStatsService] Error fetching scheduled defenses:', scheduledDefenseError);\n      }\n\n      for (const it of (scheduledDefense || [])) {\n        const k = String((it as any).defense_key || '');\n        if (!k) continue;\n        const spec = defenseSpecByKey.get(k);\n        const delta = Number(spec?.energyDelta || 0);\n        if (delta < 0) reservedNegative += delta; // single step reservation per queued defense\n      }\n    } catch {}\n\n    projectedBalance = rawBalanceWithDef + reservedNegative;\n\n    const areaFree = Math.max(0, areaTotal - (areaUsed + areaReserved));\n    const populationFree = Math.max(0, populationCapacity - (populationUsed + populationReserved));\n\n    // Citizens: fetch per-hour from CapacityService and current count from Colony\n    let citizensPerHour = 0;\n    let citizensCount = 0;\n    try {\n      const caps = await CapacityService.getBaseCapacities(empireId, locationCoord);\n      citizensPerHour = Math.max(0, Number((caps as any)?.citizen?.value || 0));\n      const { data: colony, error: colonyError } = await supabase\n        .from(DB_TABLES.COLONIES)\n        .select('citizens')\n        .eq(DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)\n        .eq(DB_FIELDS.BUILDINGS.LOCATION_COORD, locationCoord)\n        .maybeSingle();\n\n      if (colonyError) {\n        console.error('[BaseStatsService] Error fetching colony:', colonyError);\n      }\n      citizensCount = Math.max(0, Number((colony as any)?.citizens || 0));\n    } catch {}\n\n    return {\n      area: {\n        total: areaTotal,\n        used: areaUsed + areaReserved,\n        free: areaFree,\n      },\n      energy: {\n        produced: producedWithDef,\n        consumed: consumedWithDef,\n        balance: projectedBalance, // For backwards compatibility, show projected when construction/defense is active\n        rawBalance: rawBalanceWithDef, // Current balance including completed defenses and without reservations\n        projectedBalance: projectedBalance, // Includes reservations from structures and scheduled defenses\n      },\n      population: {\n        used: populationUsed + populationReserved,\n        capacity: populationCapacity,\n        free: populationFree,\n      },\n      citizens: {\n        count: citizensCount,\n        perHour: citizensPerHour,\n      },\n      ownerIncomeCredPerHour: ownerIncome,\n    };\n  }\n}\n"],"version":3}