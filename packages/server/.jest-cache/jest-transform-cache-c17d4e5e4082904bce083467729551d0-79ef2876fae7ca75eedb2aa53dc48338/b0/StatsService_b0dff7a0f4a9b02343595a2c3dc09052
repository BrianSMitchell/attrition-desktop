3efdbe85bc48ddf93771e53a20d87b7a
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.StatsService = void 0;
const supabase_1 = require("../../config/supabase");
const shared_1 = require("@game/shared");
// Constants imports for eliminating hardcoded values
const database_fields_1 = require("../../constants/database-fields");
const CapacityService_1 = require("../bases/CapacityService");
/**
 * Compute base budgets visible to the player for a given empire and location.
 * - Only counts active buildings for the given empire at that coord
 * - Uses shared building catalog to aggregate area/energy/pop/economy
 * - Urban Structures provide population capacity per level equal to the planet's fertility
 */
class StatsService {
    static async getBaseStats(empireId, locationCoord) {
        // 1) Environment totals from Overhaul (area, etc.)
        const { data: location, error: locationError } = await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.LOCATIONS)
            .select(database_fields_1.DB_FIELDS.LOCATIONS.RESULT)
            .eq('coord', locationCoord)
            .maybeSingle();
        if (locationError) {
            console.error('[BaseStatsService] Error fetching location:', locationError);
        }
        const areaTotal = Math.max(0, Number(location?.result?.area ?? 0));
        const fertility = Math.max(0, Number(location?.result?.fertility ??
            location?.properties?.fertility ??
            0));
        // Extract per-planet resource values for solar/gas plants
        const solarEnergy = Math.max(0, Number(location?.result?.solarEnergy ?? 0));
        const gasResource = Math.max(0, Number(location?.result?.yields?.gas ?? 0));
        // 2) Get all buildings for this empire at this location
        const { data: buildings, error: buildingsError } = await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.BUILDINGS)
            .select('level, catalog_key, is_active, pending_upgrade, construction_started, construction_completed')
            .eq(database_fields_1.DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)
            .eq(database_fields_1.DB_FIELDS.BUILDINGS.LOCATION_COORD, locationCoord);
        if (buildingsError) {
            console.error('[BaseStatsService] Error fetching buildings:', buildingsError);
        }
        let areaUsed = 0;
        let areaReserved = 0;
        let populationUsed = 0;
        let populationReserved = 0;
        let populationCapacity = 0;
        let ownerIncome = 0;
        // Separate active buildings from those under construction
        const activeBuildings = [];
        const constructionQueue = [];
        for (const b of (buildings || [])) {
            const isActive = b.is_active === true;
            const pendingUpgrade = b.pending_upgrade === true;
            const level = Math.max(0, Number(b.level || 0));
            const catalogKey = b.catalog_key;
            if (!catalogKey) {
                console.warn("[BaseStatsService] skip: missing catalogKey _id=%s", b._id?.toString?.());
                continue;
            }
            const spec = (0, shared_1.getBuildingSpec)(catalogKey);
            const areaReq = Math.max(0, Number(spec.areaRequired ?? 0));
            const popReq = Math.max(0, Number(spec.populationRequired ?? 0));
            const countsAsActive = (isActive || pendingUpgrade) && level > 0;
            const isUnderConstruction = !isActive && b.construction_completed; // queued step exists
            if (countsAsActive) {
                // Count current active level even while upgrading (pendingUpgrade=true)
                activeBuildings.push({ key: catalogKey, level, isActive: true });
                areaUsed += level * areaReq;
                populationUsed += level * popReq;
                // Population capacity from Urban Structures
                if (catalogKey === 'urban_structures') {
                    populationCapacity += level * fertility;
                }
                // Owner Income (credits/hour)
                const econ = Math.max(0, Number(spec.economy || 0));
                ownerIncome += level * econ;
            }
            if (isUnderConstruction) {
                // Under construction - count reservation for the next step only
                const targetLevel = level > 0 ? level + 1 : 1; // If upgrading, next level; if new, level 1
                constructionQueue.push({ key: catalogKey, level: targetLevel });
                // Reserve area and population for this single step
                areaReserved += areaReq;
                populationReserved += popReq;
            }
        }
        // Calculate current energy (active buildings only)
        const currentEnergy = (0, shared_1.computeEnergyBalance)({
            buildingsAtBase: activeBuildings,
            location: { solarEnergy, gasYield: gasResource },
            includeQueuedReservations: false, // Don't include reservations in current balance
        });
        // Incorporate completed defenses into energy (consumption/production)
        // Each completed defense queue item counts as one level of that defense at the base.
        const { data: completedDefenses, error: completedDefensesError } = await supabase_1.supabase
            .from(database_fields_1.DB_TABLES.DEFENSE_QUEUE)
            .select(database_fields_1.DB_FIELDS.DEFENSE_QUEUE.DEFENSE_KEY)
            .eq(database_fields_1.DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)
            .eq(database_fields_1.DB_FIELDS.BUILDINGS.LOCATION_COORD, locationCoord)
            .eq(database_fields_1.DB_FIELDS.TECH_QUEUE.STATUS, 'completed');
        if (completedDefensesError) {
            console.error('[BaseStatsService] Error fetching completed defenses:', completedDefensesError);
        }
        const defenseSpecByKey = new Map();
        for (const d of (0, shared_1.getDefensesList)()) {
            defenseSpecByKey.set(String(d.key), { energyDelta: Number(d.energyDelta || 0), name: String(d.name || String(d.key)) });
        }
        const defenseCountByKey = new Map();
        for (const it of (completedDefenses || [])) {
            const k = String(it.defense_key || '');
            if (!k)
                continue;
            defenseCountByKey.set(k, (defenseCountByKey.get(k) || 0) + 1);
        }
        let defenseProduced = 0;
        let defenseConsumed = 0;
        for (const [k, count] of defenseCountByKey.entries()) {
            const spec = defenseSpecByKey.get(k);
            const delta = Number(spec?.energyDelta || 0);
            if (delta >= 0)
                defenseProduced += count * delta;
            else
                defenseConsumed += count * Math.abs(delta);
        }
        const producedWithDef = currentEnergy.produced + defenseProduced;
        const consumedWithDef = currentEnergy.consumed + defenseConsumed;
        const rawBalanceWithDef = producedWithDef - consumedWithDef;
        // Calculate projected energy (with construction queue) and reserve queued negatives (buildings + defenses)
        let projectedBalance = rawBalanceWithDef;
        let reservedNegative = 0;
        if (constructionQueue.length > 0) {
            // Only count negative energy deltas from the construction queue
            for (const item of constructionQueue) {
                const spec = (0, shared_1.getBuildingSpec)(item.key);
                const delta = Number(spec?.energyDelta || 0);
                if (delta < 0) {
                    reservedNegative += delta; // Single step reservation
                }
            }
        }
        // Also reserve queued negative energy from scheduled defense items at this base
        try {
            const now = new Date();
            const { data: scheduledDefense, error: scheduledDefenseError } = await supabase_1.supabase
                .from(database_fields_1.DB_TABLES.DEFENSE_QUEUE)
                .select(database_fields_1.DB_FIELDS.DEFENSE_QUEUE.DEFENSE_KEY)
                .eq(database_fields_1.DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)
                .eq(database_fields_1.DB_FIELDS.BUILDINGS.LOCATION_COORD, locationCoord)
                .eq(database_fields_1.DB_FIELDS.TECH_QUEUE.STATUS, 'pending')
                .gt(database_fields_1.DB_FIELDS.TECH_QUEUE.COMPLETES_AT, now.toISOString());
            if (scheduledDefenseError) {
                console.error('[BaseStatsService] Error fetching scheduled defenses:', scheduledDefenseError);
            }
            for (const it of (scheduledDefense || [])) {
                const k = String(it.defense_key || '');
                if (!k)
                    continue;
                const spec = defenseSpecByKey.get(k);
                const delta = Number(spec?.energyDelta || 0);
                if (delta < 0)
                    reservedNegative += delta; // single step reservation per queued defense
            }
        }
        catch { }
        projectedBalance = rawBalanceWithDef + reservedNegative;
        const areaFree = Math.max(0, areaTotal - (areaUsed + areaReserved));
        const populationFree = Math.max(0, populationCapacity - (populationUsed + populationReserved));
        // Citizens: fetch per-hour from CapacityService and current count from Colony
        let citizensPerHour = 0;
        let citizensCount = 0;
        try {
            const caps = await CapacityService_1.CapacityService.getBaseCapacities(empireId, locationCoord);
            citizensPerHour = Math.max(0, Number(caps?.citizen?.value || 0));
            const { data: colony, error: colonyError } = await supabase_1.supabase
                .from(database_fields_1.DB_TABLES.COLONIES)
                .select('citizens')
                .eq(database_fields_1.DB_FIELDS.BUILDINGS.EMPIRE_ID, empireId)
                .eq(database_fields_1.DB_FIELDS.BUILDINGS.LOCATION_COORD, locationCoord)
                .maybeSingle();
            if (colonyError) {
                console.error('[BaseStatsService] Error fetching colony:', colonyError);
            }
            citizensCount = Math.max(0, Number(colony?.citizens || 0));
        }
        catch { }
        return {
            area: {
                total: areaTotal,
                used: areaUsed + areaReserved,
                free: areaFree,
            },
            energy: {
                produced: producedWithDef,
                consumed: consumedWithDef,
                balance: projectedBalance, // For backwards compatibility, show projected when construction/defense is active
                rawBalance: rawBalanceWithDef, // Current balance including completed defenses and without reservations
                projectedBalance: projectedBalance, // Includes reservations from structures and scheduled defenses
            },
            population: {
                used: populationUsed + populationReserved,
                capacity: populationCapacity,
                free: populationFree,
            },
            citizens: {
                count: citizensCount,
                perHour: citizensPerHour,
            },
            ownerIncomeCredPerHour: ownerIncome,
        };
    }
}
exports.StatsService = StatsService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFByb2plY3RzXFxBdHRyaXRpb25cXHBhY2thZ2VzXFxzZXJ2ZXJcXHNyY1xcc2VydmljZXNcXGJhc2VzXFxTdGF0c1NlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQUEsb0RBQWlEO0FBQ2pELHlDQUtzQjtBQUV0QixxREFBcUQ7QUFDckQscUVBQXVFO0FBQ3ZFLDhEQUEyRDtBQWtDM0Q7Ozs7O0dBS0c7QUFDSCxNQUFhLFlBQVk7SUFDdkIsTUFBTSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsUUFBZ0IsRUFBRSxhQUFxQjtRQUMvRCxtREFBbUQ7UUFDbkQsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLGFBQWEsRUFBRSxHQUFHLE1BQU0sbUJBQVE7YUFDNUQsSUFBSSxDQUFDLDJCQUFTLENBQUMsU0FBUyxDQUFDO2FBQ3pCLE1BQU0sQ0FBQywyQkFBUyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUM7YUFDbEMsRUFBRSxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUM7YUFDMUIsV0FBVyxFQUFFLENBQUM7UUFFakIsSUFBSSxhQUFhLEVBQUUsQ0FBQztZQUNsQixPQUFPLENBQUMsS0FBSyxDQUFDLDZDQUE2QyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBQzlFLENBQUM7UUFFRCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUUsUUFBZ0IsRUFBRSxNQUFNLEVBQUUsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUUsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FDeEIsQ0FBQyxFQUNELE1BQU0sQ0FDSCxRQUFnQixFQUFFLE1BQU0sRUFBRSxTQUFTO1lBQ2pDLFFBQWdCLEVBQUUsVUFBVSxFQUFFLFNBQVM7WUFDeEMsQ0FBQyxDQUNKLENBQ0YsQ0FBQztRQUVGLDBEQUEwRDtRQUMxRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUUs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dHJpdGlvblxccGFja2FnZXNcXHNlcnZlclxcc3JjXFxzZXJ2aWNlc1xcYmFzZXNcXFN0YXRzU2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzdXBhYmFzZSB9IGZyb20gJy4uLy4uL2NvbmZpZy9zdXBhYmFzZSc7XG5pbXBvcnQge1xuICBnZXRCdWlsZGluZ1NwZWMsXG4gIHR5cGUgQnVpbGRpbmdLZXksXG4gIGNvbXB1dGVFbmVyZ3lCYWxhbmNlLFxuICBnZXREZWZlbnNlc0xpc3QsXG59IGZyb20gJ0BnYW1lL3NoYXJlZCc7XG5cbi8vIENvbnN0YW50cyBpbXBvcnRzIGZvciBlbGltaW5hdGluZyBoYXJkY29kZWQgdmFsdWVzXG5pbXBvcnQgeyBEQl9UQUJMRVMsIERCX0ZJRUxEUyB9IGZyb20gJy4uLy4uL2NvbnN0YW50cy9kYXRhYmFzZS1maWVsZHMnO1xuaW1wb3J0IHsgQ2FwYWNpdHlTZXJ2aWNlIH0gZnJvbSAnLi4vYmFzZXMvQ2FwYWNpdHlTZXJ2aWNlJztcblxuLyoqXG4gKiBQb3B1bGF0aW9uIGNhcGFjaXR5IHBlciBVcmJhbiBTdHJ1Y3R1cmVzIGxldmVsIGVxdWFscyB0aGUgcGxhbmV0J3MgZmVydGlsaXR5LlxuICogaS5lLiwgY2FwYWNpdHkgY29udHJpYnV0aW9uID0gbGV2ZWwgKiBmZXJ0aWxpdHkuXG4gKiBUaGlzIHRpZXMgc3RhcnRpbmcgcG9wdWxhdGlvbiB0byBmZXJ0aWxpdHkgc2luY2UgbmV3IGJhc2VzIGdldCBhIGZyZWUgTDEgVXJiYW4uXG4gKi9cblxuXG5leHBvcnQgaW50ZXJmYWNlIEJhc2VTdGF0c0RUTyB7XG4gIGFyZWE6IHtcbiAgICB0b3RhbDogbnVtYmVyO1xuICAgIHVzZWQ6IG51bWJlcjtcbiAgICBmcmVlOiBudW1iZXI7XG4gIH07XG4gIGVuZXJneToge1xuICAgIHByb2R1Y2VkOiBudW1iZXI7XG4gICAgY29uc3VtZWQ6IG51bWJlcjtcbiAgICBiYWxhbmNlOiBudW1iZXI7XG4gICAgcmF3QmFsYW5jZT86IG51bWJlcjsgLy8gZXhwb3NlZCBmb3IgVUkgcGFyaXR5IHdpdGhvdXQgcmVzZXJ2YXRpb25zXG4gICAgcHJvamVjdGVkQmFsYW5jZT86IG51bWJlcjsgLy8gYWxpYXMgb2YgYmFsYW5jZSBmb3IgY2xhcml0eVxuICB9O1xuICBwb3B1bGF0aW9uOiB7XG4gICAgdXNlZDogbnVtYmVyO1xuICAgIGNhcGFjaXR5OiBudW1iZXI7XG4gICAgZnJlZTogbnVtYmVyO1xuICB9O1xuICBjaXRpemVuczoge1xuICAgIGNvdW50OiBudW1iZXI7XG4gICAgcGVySG91cjogbnVtYmVyO1xuICB9O1xuICBvd25lckluY29tZUNyZWRQZXJIb3VyOiBudW1iZXI7XG59XG5cbi8qKlxuICogQ29tcHV0ZSBiYXNlIGJ1ZGdldHMgdmlzaWJsZSB0byB0aGUgcGxheWVyIGZvciBhIGdpdmVuIGVtcGlyZSBhbmQgbG9jYXRpb24uXG4gKiAtIE9ubHkgY291bnRzIGFjdGl2ZSBidWlsZGluZ3MgZm9yIHRoZSBnaXZlbiBlbXBpcmUgYXQgdGhhdCBjb29yZFxuICogLSBVc2VzIHNoYXJlZCBidWlsZGluZyBjYXRhbG9nIHRvIGFnZ3JlZ2F0ZSBhcmVhL2VuZXJneS9wb3AvZWNvbm9teVxuICogLSBVcmJhbiBTdHJ1Y3R1cmVzIHByb3ZpZGUgcG9wdWxhdGlvbiBjYXBhY2l0eSBwZXIgbGV2ZWwgZXF1YWwgdG8gdGhlIHBsYW5ldCdzIGZlcnRpbGl0eVxuICovXG5leHBvcnQgY2xhc3MgU3RhdHNTZXJ2aWNlIHtcbiAgc3RhdGljIGFzeW5jIGdldEJhc2VTdGF0cyhlbXBpcmVJZDogc3RyaW5nLCBsb2NhdGlvbkNvb3JkOiBzdHJpbmcpOiBQcm9taXNlPEJhc2VTdGF0c0RUTz4ge1xuICAgIC8vIDEpIEVudmlyb25tZW50IHRvdGFscyBmcm9tIE92ZXJoYXVsIChhcmVhLCBldGMuKVxuICAgIGNvbnN0IHsgZGF0YTogbG9jYXRpb24sIGVycm9yOiBsb2NhdGlvbkVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgLmZyb20oREJfVEFCTEVTLkxPQ0FUSU9OUylcbiAgICAgIC5zZWxlY3QoREJfRklFTERTLkxPQ0FUSU9OUy5SRVNVTFQpXG4gICAgICAuZXEoJ2Nvb3JkJywgbG9jYXRpb25Db29yZClcbiAgICAgIC5tYXliZVNpbmdsZSgpO1xuXG4gICAgaWYgKGxvY2F0aW9uRXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ1tCYXNlU3RhdHNTZXJ2aWNlXSBFcnJvciBmZXRjaGluZyBsb2NhdGlvbjonLCBsb2NhdGlvbkVycm9yKTtcbiAgICB9XG5cbiAgICBjb25zdCBhcmVhVG90YWwgPSBNYXRoLm1heCgwLCBOdW1iZXIoKGxvY2F0aW9uIGFzIGFueSk/LnJlc3VsdD8uYXJlYSA/PyAwKSk7XG4gICAgY29uc3QgZmVydGlsaXR5ID0gTWF0aC5tYXgoXG4gICAgICAwLFxuICAgICAgTnVtYmVyKFxuICAgICAgICAobG9jYXRpb24gYXMgYW55KT8ucmVzdWx0Py5mZXJ0aWxpdHkgPz9cbiAgICAgICAgICAobG9jYXRpb24gYXMgYW55KT8ucHJvcGVydGllcz8uZmVydGlsaXR5ID8/XG4gICAgICAgICAgMFxuICAgICAgKVxuICAgICk7XG5cbiAgICAvLyBFeHRyYWN0IHBlci1wbGFuZXQgcmVzb3VyY2UgdmFsdWVzIGZvciBzb2xhci9nYXMgcGxhbnRzXG4gICAgY29uc3Qgc29sYXJFbmVyZ3kgPSBNYXRoLm1heCgwLCBOdW1iZXIoKGxvY2F0aW9uIGFzIGFueSk/LnJlc3VsdD8uc29sYXJFbmVyZ3kgPz8gMCkpO1xuICAgIGNvbnN0IGdhc1Jlc291cmNlID0gTWF0aC5tYXgoMCwgTnVtYmVyKChsb2NhdGlvbiBhcyBhbnkpPy5yZXN1bHQ/LnlpZWxkcz8uZ2FzID8/IDApKTtcblxuICAgIC8vIDIpIEdldCBhbGwgYnVpbGRpbmdzIGZvciB0aGlzIGVtcGlyZSBhdCB0aGlzIGxvY2F0aW9uXG4gICAgY29uc3QgeyBkYXRhOiBidWlsZGluZ3MsIGVycm9yOiBidWlsZGluZ3NFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcbiAgICAgIC5mcm9tKERCX1RBQkxFUy5CVUlMRElOR1MpXG4gICAgICAuc2VsZWN0KCdsZXZlbCwgY2F0YWxvZ19rZXksIGlzX2FjdGl2ZSwgcGVuZGluZ191cGdyYWRlLCBjb25zdHJ1Y3Rpb25fc3RhcnRlZCwgY29uc3RydWN0aW9uX2NvbXBsZXRlZCcpXG4gICAgICAuZXEoREJfRklFTERTLkJVSUxESU5HUy5FTVBJUkVfSUQsIGVtcGlyZUlkKVxuICAgICAgLmVxKERCX0ZJRUxEUy5CVUlMRElOR1MuTE9DQVRJT05fQ09PUkQsIGxvY2F0aW9uQ29vcmQpO1xuXG4gICAgaWYgKGJ1aWxkaW5nc0Vycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdbQmFzZVN0YXRzU2VydmljZV0gRXJyb3IgZmV0Y2hpbmcgYnVpbGRpbmdzOicsIGJ1aWxkaW5nc0Vycm9yKTtcbiAgICB9XG5cbiAgICBsZXQgYXJlYVVzZWQgPSAwO1xuICAgIGxldCBhcmVhUmVzZXJ2ZWQgPSAwO1xuICAgIGxldCBwb3B1bGF0aW9uVXNlZCA9IDA7XG4gICAgbGV0IHBvcHVsYXRpb25SZXNlcnZlZCA9IDA7XG4gICAgbGV0IHBvcHVsYXRpb25DYXBhY2l0eSA9IDA7XG4gICAgbGV0IG93bmVySW5jb21lID0gMDtcblxuICAgIC8vIFNlcGFyYXRlIGFjdGl2ZSBidWlsZGluZ3MgZnJvbSB0aG9zZSB1bmRlciBjb25zdHJ1Y3Rpb25cbiAgICBjb25zdCBhY3RpdmVCdWlsZGluZ3M6IEFycmF5PHsga2V5OiBzdHJpbmc7IGxldmVsOiBudW1iZXI7IGlzQWN0aXZlOiBib29sZWFuIH0+ID0gW107XG4gICAgY29uc3QgY29uc3RydWN0aW9uUXVldWU6IEFycmF5PHsga2V5OiBzdHJpbmc7IGxldmVsOiBudW1iZXIgfT4gPSBbXTtcblxuICAgIGZvciAoY29uc3QgYiBvZiAoYnVpbGRpbmdzIHx8IFtdKSkge1xuICAgICAgY29uc3QgaXNBY3RpdmUgPSAoYiBhcyBhbnkpLmlzX2FjdGl2ZSA9PT0gdHJ1ZTtcbiAgICAgIGNvbnN0IHBlbmRpbmdVcGdyYWRlID0gKGIgYXMgYW55KS5wZW5kaW5nX3VwZ3JhZGUgPT09IHRydWU7XG4gICAgICBjb25zdCBsZXZlbCA9IE1hdGgubWF4KDAsIE51bWJlcigoYiBhcyBhbnkpLmxldmVsIHx8IDApKTtcbiAgICAgIGNvbnN0IGNhdGFsb2dLZXkgPSAoYiBhcyBhbnkpLmNhdGFsb2dfa2V5IGFzIEJ1aWxkaW5nS2V5IHwgdW5kZWZpbmVkO1xuXG4gICAgICBpZiAoIWNhdGFsb2dLZXkpIHtcbiAgICAgICAgY29uc29sZS53YXJuKFwiW0Jhc2VTdGF0c1NlcnZpY2VdIHNraXA6IG1pc3NpbmcgY2F0YWxvZ0tleSBfaWQ9JXNcIiwgKGIgYXMgYW55KS5faWQ/LnRvU3RyaW5nPy4oKSk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzcGVjID0gZ2V0QnVpbGRpbmdTcGVjKGNhdGFsb2dLZXkpO1xuICAgICAgY29uc3QgYXJlYVJlcSA9IE1hdGgubWF4KDAsIE51bWJlcihzcGVjLmFyZWFSZXF1aXJlZCA/PyAwKSk7XG4gICAgICBjb25zdCBwb3BSZXEgPSBNYXRoLm1heCgwLCBOdW1iZXIoc3BlYy5wb3B1bGF0aW9uUmVxdWlyZWQgPz8gMCkpO1xuXG4gICAgICBjb25zdCBjb3VudHNBc0FjdGl2ZSA9IChpc0FjdGl2ZSB8fCBwZW5kaW5nVXBncmFkZSkgJiYgbGV2ZWwgPiAwO1xuICAgICAgY29uc3QgaXNVbmRlckNvbnN0cnVjdGlvbiA9ICFpc0FjdGl2ZSAmJiAoYiBhcyBhbnkpLmNvbnN0cnVjdGlvbl9jb21wbGV0ZWQ7IC8vIHF1ZXVlZCBzdGVwIGV4aXN0c1xuXG4gICAgICBpZiAoY291bnRzQXNBY3RpdmUpIHtcbiAgICAgICAgLy8gQ291bnQgY3VycmVudCBhY3RpdmUgbGV2ZWwgZXZlbiB3aGlsZSB1cGdyYWRpbmcgKHBlbmRpbmdVcGdyYWRlPXRydWUpXG4gICAgICAgIGFjdGl2ZUJ1aWxkaW5ncy5wdXNoKHsga2V5OiBjYXRhbG9nS2V5LCBsZXZlbCwgaXNBY3RpdmU6IHRydWUgfSk7XG4gICAgICAgIGFyZWFVc2VkICs9IGxldmVsICogYXJlYVJlcTtcbiAgICAgICAgcG9wdWxhdGlvblVzZWQgKz0gbGV2ZWwgKiBwb3BSZXE7XG5cbiAgICAgICAgLy8gUG9wdWxhdGlvbiBjYXBhY2l0eSBmcm9tIFVyYmFuIFN0cnVjdHVyZXNcbiAgICAgICAgaWYgKGNhdGFsb2dLZXkgPT09ICd1cmJhbl9zdHJ1Y3R1cmVzJykge1xuICAgICAgICAgIHBvcHVsYXRpb25DYXBhY2l0eSArPSBsZXZlbCAqIGZlcnRpbGl0eTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIE93bmVyIEluY29tZSAoY3JlZGl0cy9ob3VyKVxuICAgICAgICBjb25zdCBlY29uID0gTWF0aC5tYXgoMCwgTnVtYmVyKHNwZWMuZWNvbm9teSB8fCAwKSk7XG4gICAgICAgIG93bmVySW5jb21lICs9IGxldmVsICogZWNvbjtcbiAgICAgIH1cblxuICAgICAgaWYgKGlzVW5kZXJDb25zdHJ1Y3Rpb24pIHtcbiAgICAgICAgLy8gVW5kZXIgY29uc3RydWN0aW9uIC0gY291bnQgcmVzZXJ2YXRpb24gZm9yIHRoZSBuZXh0IHN0ZXAgb25seVxuICAgICAgICBjb25zdCB0YXJnZXRMZXZlbCA9IGxldmVsID4gMCA/IGxldmVsICsgMSA6IDE7IC8vIElmIHVwZ3JhZGluZywgbmV4dCBsZXZlbDsgaWYgbmV3LCBsZXZlbCAxXG4gICAgICAgIGNvbnN0cnVjdGlvblF1ZXVlLnB1c2goeyBrZXk6IGNhdGFsb2dLZXksIGxldmVsOiB0YXJnZXRMZXZlbCB9KTtcbiAgICAgICAgLy8gUmVzZXJ2ZSBhcmVhIGFuZCBwb3B1bGF0aW9uIGZvciB0aGlzIHNpbmdsZSBzdGVwXG4gICAgICAgIGFyZWFSZXNlcnZlZCArPSBhcmVhUmVxO1xuICAgICAgICBwb3B1bGF0aW9uUmVzZXJ2ZWQgKz0gcG9wUmVxO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENhbGN1bGF0ZSBjdXJyZW50IGVuZXJneSAoYWN0aXZlIGJ1aWxkaW5ncyBvbmx5KVxuICAgIGNvbnN0IGN1cnJlbnRFbmVyZ3kgPSBjb21wdXRlRW5lcmd5QmFsYW5jZSh7XG4gICAgICBidWlsZGluZ3NBdEJhc2U6IGFjdGl2ZUJ1aWxkaW5ncyxcbiAgICAgIGxvY2F0aW9uOiB7IHNvbGFyRW5lcmd5LCBnYXNZaWVsZDogZ2FzUmVzb3VyY2UgfSxcbiAgICAgIGluY2x1ZGVRdWV1ZWRSZXNlcnZhdGlvbnM6IGZhbHNlLCAvLyBEb24ndCBpbmNsdWRlIHJlc2VydmF0aW9ucyBpbiBjdXJyZW50IGJhbGFuY2VcbiAgICB9KTtcblxuICAgIC8vIEluY29ycG9yYXRlIGNvbXBsZXRlZCBkZWZlbnNlcyBpbnRvIGVuZXJneSAoY29uc3VtcHRpb24vcHJvZHVjdGlvbilcbiAgICAvLyBFYWNoIGNvbXBsZXRlZCBkZWZlbnNlIHF1ZXVlIGl0ZW0gY291bnRzIGFzIG9uZSBsZXZlbCBvZiB0aGF0IGRlZmVuc2UgYXQgdGhlIGJhc2UuXG4gICAgY29uc3QgeyBkYXRhOiBjb21wbGV0ZWREZWZlbnNlcywgZXJyb3I6IGNvbXBsZXRlZERlZmVuc2VzRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgICAuZnJvbShEQl9UQUJMRVMuREVGRU5TRV9RVUVVRSlcbiAgICAgIC5zZWxlY3QoREJfRklFTERTLkRFRkVOU0VfUVVFVUUuREVGRU5TRV9LRVkpXG4gICAgICAuZXEoREJfRklFTERTLkJVSUxESU5HUy5FTVBJUkVfSUQsIGVtcGlyZUlkKVxuICAgICAgLmVxKERCX0ZJRUxEUy5CVUlMRElOR1MuTE9DQVRJT05fQ09PUkQsIGxvY2F0aW9uQ29vcmQpXG4gICAgICAuZXEoREJfRklFTERTLlRFQ0hfUVVFVUUuU1RBVFVTLCAnY29tcGxldGVkJyk7XG5cbiAgICBpZiAoY29tcGxldGVkRGVmZW5zZXNFcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignW0Jhc2VTdGF0c1NlcnZpY2VdIEVycm9yIGZldGNoaW5nIGNvbXBsZXRlZCBkZWZlbnNlczonLCBjb21wbGV0ZWREZWZlbnNlc0Vycm9yKTtcbiAgICB9XG5cbiAgICBjb25zdCBkZWZlbnNlU3BlY0J5S2V5ID0gbmV3IE1hcDxzdHJpbmcsIHsgZW5lcmd5RGVsdGE6IG51bWJlcjsgbmFtZTogc3RyaW5nIH0+KCk7XG4gICAgZm9yIChjb25zdCBkIG9mIGdldERlZmVuc2VzTGlzdCgpKSB7XG4gICAgICBkZWZlbnNlU3BlY0J5S2V5LnNldChTdHJpbmcoKGQgYXMgYW55KS5rZXkpLCB7IGVuZXJneURlbHRhOiBOdW1iZXIoKGQgYXMgYW55KS5lbmVyZ3lEZWx0YSB8fCAwKSwgbmFtZTogU3RyaW5nKChkIGFzIGFueSkubmFtZSB8fCBTdHJpbmcoKGQgYXMgYW55KS5rZXkpKSB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBkZWZlbnNlQ291bnRCeUtleSA9IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KCk7XG4gICAgZm9yIChjb25zdCBpdCBvZiAoY29tcGxldGVkRGVmZW5zZXMgfHwgW10pKSB7XG4gICAgICBjb25zdCBrID0gU3RyaW5nKChpdCBhcyBhbnkpLmRlZmVuc2Vfa2V5IHx8ICcnKTtcbiAgICAgIGlmICghaykgY29udGludWU7XG4gICAgICBkZWZlbnNlQ291bnRCeUtleS5zZXQoaywgKGRlZmVuc2VDb3VudEJ5S2V5LmdldChrKSB8fCAwKSArIDEpO1xuICAgIH1cblxuICAgIGxldCBkZWZlbnNlUHJvZHVjZWQgPSAwO1xuICAgIGxldCBkZWZlbnNlQ29uc3VtZWQgPSAwO1xuICAgIGZvciAoY29uc3QgW2ssIGNvdW50XSBvZiBkZWZlbnNlQ291bnRCeUtleS5lbnRyaWVzKCkpIHtcbiAgICAgIGNvbnN0IHNwZWMgPSBkZWZlbnNlU3BlY0J5S2V5LmdldChrKTtcbiAgICAgIGNvbnN0IGRlbHRhID0gTnVtYmVyKHNwZWM/LmVuZXJneURlbHRhIHx8IDApO1xuICAgICAgaWYgKGRlbHRhID49IDApIGRlZmVuc2VQcm9kdWNlZCArPSBjb3VudCAqIGRlbHRhO1xuICAgICAgZWxzZSBkZWZlbnNlQ29uc3VtZWQgKz0gY291bnQgKiBNYXRoLmFicyhkZWx0YSk7XG4gICAgfVxuXG4gICAgY29uc3QgcHJvZHVjZWRXaXRoRGVmID0gY3VycmVudEVuZXJneS5wcm9kdWNlZCArIGRlZmVuc2VQcm9kdWNlZDtcbiAgICBjb25zdCBjb25zdW1lZFdpdGhEZWYgPSBjdXJyZW50RW5lcmd5LmNvbnN1bWVkICsgZGVmZW5zZUNvbnN1bWVkO1xuICAgIGNvbnN0IHJhd0JhbGFuY2VXaXRoRGVmID0gcHJvZHVjZWRXaXRoRGVmIC0gY29uc3VtZWRXaXRoRGVmO1xuXG4gICAgLy8gQ2FsY3VsYXRlIHByb2plY3RlZCBlbmVyZ3kgKHdpdGggY29uc3RydWN0aW9uIHF1ZXVlKSBhbmQgcmVzZXJ2ZSBxdWV1ZWQgbmVnYXRpdmVzIChidWlsZGluZ3MgKyBkZWZlbnNlcylcbiAgICBsZXQgcHJvamVjdGVkQmFsYW5jZSA9IHJhd0JhbGFuY2VXaXRoRGVmO1xuICAgIGxldCByZXNlcnZlZE5lZ2F0aXZlID0gMDtcblxuICAgIGlmIChjb25zdHJ1Y3Rpb25RdWV1ZS5sZW5ndGggPiAwKSB7XG4gICAgICAvLyBPbmx5IGNvdW50IG5lZ2F0aXZlIGVuZXJneSBkZWx0YXMgZnJvbSB0aGUgY29uc3RydWN0aW9uIHF1ZXVlXG4gICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgY29uc3RydWN0aW9uUXVldWUpIHtcbiAgICAgICAgY29uc3Qgc3BlYyA9IGdldEJ1aWxkaW5nU3BlYyhpdGVtLmtleSBhcyBCdWlsZGluZ0tleSk7XG4gICAgICAgIGNvbnN0IGRlbHRhID0gTnVtYmVyKHNwZWM/LmVuZXJneURlbHRhIHx8IDApO1xuICAgICAgICBpZiAoZGVsdGEgPCAwKSB7XG4gICAgICAgICAgcmVzZXJ2ZWROZWdhdGl2ZSArPSBkZWx0YTsgLy8gU2luZ2xlIHN0ZXAgcmVzZXJ2YXRpb25cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEFsc28gcmVzZXJ2ZSBxdWV1ZWQgbmVnYXRpdmUgZW5lcmd5IGZyb20gc2NoZWR1bGVkIGRlZmVuc2UgaXRlbXMgYXQgdGhpcyBiYXNlXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgICBjb25zdCB7IGRhdGE6IHNjaGVkdWxlZERlZmVuc2UsIGVycm9yOiBzY2hlZHVsZWREZWZlbnNlRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgICAgIC5mcm9tKERCX1RBQkxFUy5ERUZFTlNFX1FVRVVFKVxuICAgICAgICAuc2VsZWN0KERCX0ZJRUxEUy5ERUZFTlNFX1FVRVVFLkRFRkVOU0VfS0VZKVxuICAgICAgICAuZXEoREJfRklFTERTLkJVSUxESU5HUy5FTVBJUkVfSUQsIGVtcGlyZUlkKVxuICAgICAgICAuZXEoREJfRklFTERTLkJVSUxESU5HUy5MT0NBVElPTl9DT09SRCwgbG9jYXRpb25Db29yZClcbiAgICAgICAgLmVxKERCX0ZJRUxEUy5URUNIX1FVRVVFLlNUQVRVUywgJ3BlbmRpbmcnKVxuICAgICAgICAuZ3QoREJfRklFTERTLlRFQ0hfUVVFVUUuQ09NUExFVEVTX0FULCBub3cudG9JU09TdHJpbmcoKSk7XG5cbiAgICAgIGlmIChzY2hlZHVsZWREZWZlbnNlRXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignW0Jhc2VTdGF0c1NlcnZpY2VdIEVycm9yIGZldGNoaW5nIHNjaGVkdWxlZCBkZWZlbnNlczonLCBzY2hlZHVsZWREZWZlbnNlRXJyb3IpO1xuICAgICAgfVxuXG4gICAgICBmb3IgKGNvbnN0IGl0IG9mIChzY2hlZHVsZWREZWZlbnNlIHx8IFtdKSkge1xuICAgICAgICBjb25zdCBrID0gU3RyaW5nKChpdCBhcyBhbnkpLmRlZmVuc2Vfa2V5IHx8ICcnKTtcbiAgICAgICAgaWYgKCFrKSBjb250aW51ZTtcbiAgICAgICAgY29uc3Qgc3BlYyA9IGRlZmVuc2VTcGVjQnlLZXkuZ2V0KGspO1xuICAgICAgICBjb25zdCBkZWx0YSA9IE51bWJlcihzcGVjPy5lbmVyZ3lEZWx0YSB8fCAwKTtcbiAgICAgICAgaWYgKGRlbHRhIDwgMCkgcmVzZXJ2ZWROZWdhdGl2ZSArPSBkZWx0YTsgLy8gc2luZ2xlIHN0ZXAgcmVzZXJ2YXRpb24gcGVyIHF1ZXVlZCBkZWZlbnNlXG4gICAgICB9XG4gICAgfSBjYXRjaCB7fVxuXG4gICAgcHJvamVjdGVkQmFsYW5jZSA9IHJhd0JhbGFuY2VXaXRoRGVmICsgcmVzZXJ2ZWROZWdhdGl2ZTtcblxuICAgIGNvbnN0IGFyZWFGcmVlID0gTWF0aC5tYXgoMCwgYXJlYVRvdGFsIC0gKGFyZWFVc2VkICsgYXJlYVJlc2VydmVkKSk7XG4gICAgY29uc3QgcG9wdWxhdGlvbkZyZWUgPSBNYXRoLm1heCgwLCBwb3B1bGF0aW9uQ2FwYWNpdHkgLSAocG9wdWxhdGlvblVzZWQgKyBwb3B1bGF0aW9uUmVzZXJ2ZWQpKTtcblxuICAgIC8vIENpdGl6ZW5zOiBmZXRjaCBwZXItaG91ciBmcm9tIENhcGFjaXR5U2VydmljZSBhbmQgY3VycmVudCBjb3VudCBmcm9tIENvbG9ueVxuICAgIGxldCBjaXRpemVuc1BlckhvdXIgPSAwO1xuICAgIGxldCBjaXRpemVuc0NvdW50ID0gMDtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY2FwcyA9IGF3YWl0IENhcGFjaXR5U2VydmljZS5nZXRCYXNlQ2FwYWNpdGllcyhlbXBpcmVJZCwgbG9jYXRpb25Db29yZCk7XG4gICAgICBjaXRpemVuc1BlckhvdXIgPSBNYXRoLm1heCgwLCBOdW1iZXIoKGNhcHMgYXMgYW55KT8uY2l0aXplbj8udmFsdWUgfHwgMCkpO1xuICAgICAgY29uc3QgeyBkYXRhOiBjb2xvbnksIGVycm9yOiBjb2xvbnlFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcbiAgICAgICAgLmZyb20oREJfVEFCTEVTLkNPTE9OSUVTKVxuICAgICAgICAuc2VsZWN0KCdjaXRpemVucycpXG4gICAgICAgIC5lcShEQl9GSUVMRFMuQlVJTERJTkdTLkVNUElSRV9JRCwgZW1waXJlSWQpXG4gICAgICAgIC5lcShEQl9GSUVMRFMuQlVJTERJTkdTLkxPQ0FUSU9OX0NPT1JELCBsb2NhdGlvbkNvb3JkKVxuICAgICAgICAubWF5YmVTaW5nbGUoKTtcblxuICAgICAgaWYgKGNvbG9ueUVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tCYXNlU3RhdHNTZXJ2aWNlXSBFcnJvciBmZXRjaGluZyBjb2xvbnk6JywgY29sb255RXJyb3IpO1xuICAgICAgfVxuICAgICAgY2l0aXplbnNDb3VudCA9IE1hdGgubWF4KDAsIE51bWJlcigoY29sb255IGFzIGFueSk/LmNpdGl6ZW5zIHx8IDApKTtcbiAgICB9IGNhdGNoIHt9XG5cbiAgICByZXR1cm4ge1xuICAgICAgYXJlYToge1xuICAgICAgICB0b3RhbDogYXJlYVRvdGFsLFxuICAgICAgICB1c2VkOiBhcmVhVXNlZCArIGFyZWFSZXNlcnZlZCxcbiAgICAgICAgZnJlZTogYXJlYUZyZWUsXG4gICAgICB9LFxuICAgICAgZW5lcmd5OiB7XG4gICAgICAgIHByb2R1Y2VkOiBwcm9kdWNlZFdpdGhEZWYsXG4gICAgICAgIGNvbnN1bWVkOiBjb25zdW1lZFdpdGhEZWYsXG4gICAgICAgIGJhbGFuY2U6IHByb2plY3RlZEJhbGFuY2UsIC8vIEZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSwgc2hvdyBwcm9qZWN0ZWQgd2hlbiBjb25zdHJ1Y3Rpb24vZGVmZW5zZSBpcyBhY3RpdmVcbiAgICAgICAgcmF3QmFsYW5jZTogcmF3QmFsYW5jZVdpdGhEZWYsIC8vIEN1cnJlbnQgYmFsYW5jZSBpbmNsdWRpbmcgY29tcGxldGVkIGRlZmVuc2VzIGFuZCB3aXRob3V0IHJlc2VydmF0aW9uc1xuICAgICAgICBwcm9qZWN0ZWRCYWxhbmNlOiBwcm9qZWN0ZWRCYWxhbmNlLCAvLyBJbmNsdWRlcyByZXNlcnZhdGlvbnMgZnJvbSBzdHJ1Y3R1cmVzIGFuZCBzY2hlZHVsZWQgZGVmZW5zZXNcbiAgICAgIH0sXG4gICAgICBwb3B1bGF0aW9uOiB7XG4gICAgICAgIHVzZWQ6IHBvcHVsYXRpb25Vc2VkICsgcG9wdWxhdGlvblJlc2VydmVkLFxuICAgICAgICBjYXBhY2l0eTogcG9wdWxhdGlvbkNhcGFjaXR5LFxuICAgICAgICBmcmVlOiBwb3B1bGF0aW9uRnJlZSxcbiAgICAgIH0sXG4gICAgICBjaXRpemVuczoge1xuICAgICAgICBjb3VudDogY2l0aXplbnNDb3VudCxcbiAgICAgICAgcGVySG91cjogY2l0aXplbnNQZXJIb3VyLFxuICAgICAgfSxcbiAgICAgIG93bmVySW5jb21lQ3JlZFBlckhvdXI6IG93bmVySW5jb21lLFxuICAgIH07XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==