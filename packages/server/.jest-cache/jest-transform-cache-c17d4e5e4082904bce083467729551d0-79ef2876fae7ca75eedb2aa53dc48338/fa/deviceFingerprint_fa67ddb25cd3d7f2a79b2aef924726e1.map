{"file":"C:\\Projects\\Attrition\\packages\\server\\src\\utils\\deviceFingerprint.ts","mappings":"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","names":[],"sources":["C:\\Projects\\Attrition\\packages\\server\\src\\utils\\deviceFingerprint.ts"],"sourcesContent":["import crypto from 'crypto';\r\nimport { Request } from 'express';\r\n\r\nimport { STATUS_CODES } from '@game/shared';\r\nexport interface DeviceFingerprint {\r\n  hash: string;\r\n  userAgent: string;\r\n  acceptLanguage: string;\r\n  ipNetwork: string; // First 3 octets of IP for some privacy\r\n}\r\n\r\n/**\r\n * Generate a device fingerprint based on request characteristics\r\n * This helps detect token usage from different devices/browsers\r\n */\r\nexport const generateDeviceFingerprint = (req: Request): DeviceFingerprint => {\r\n  const userAgent = req.get('User-Agent') || 'unknown';\r\n  const acceptLanguage = req.get('Accept-Language') || 'unknown';\r\n  \r\n  // Get IP address (handle different proxy scenarios)\r\n  const ip = req.ip || \r\n             req.connection.remoteAddress || \r\n             (req.headers['x-forwarded-for'] as string)?.split(',')[0]?.trim() ||\r\n             'unknown';\r\n  \r\n  // Use only first 3 octets of IP for privacy (network-level identification)\r\n  const ipNetwork = ip.split('.').slice(0, 3).join('.') + '.0';\r\n  \r\n  // Create fingerprint hash from various characteristics\r\n  const fingerprintData = [\r\n    userAgent,\r\n    acceptLanguage,\r\n    ipNetwork,\r\n    // Could add more characteristics like Accept headers, etc.\r\n  ].join('|');\r\n  \r\n  const hash = crypto.createHash('sha256').update(fingerprintData).digest('hex');\r\n  \r\n  return {\r\n    hash,\r\n    userAgent,\r\n    acceptLanguage,\r\n    ipNetwork\r\n  };\r\n};\r\n\r\n/**\r\n * Compare two device fingerprints for similarity\r\n * Returns a score from 0 (no match) to 1 (perfect match)\r\n */\r\nexport const compareDeviceFingerprints = (fp1: DeviceFingerprint, fp2: DeviceFingerprint): number => {\r\n  let score = 0;\r\n  let factors = 0;\r\n  \r\n  // Exact hash match\r\n  if (fp1.hash === fp2.hash) {\r\n    return 1.0;\r\n  }\r\n  \r\n  // User agent similarity (most important)\r\n  if (fp1.userAgent === fp2.userAgent) {\r\n    score += 0.6;\r\n  } else if (fp1.userAgent.includes(fp2.userAgent.split(' ')[0]) || \r\n             fp2.userAgent.includes(fp1.userAgent.split(' ')[0])) {\r\n    score += 0.3; // Same browser family\r\n  }\r\n  factors++;\r\n  \r\n  // IP network match\r\n  if (fp1.ipNetwork === fp2.ipNetwork) {\r\n    score += 0.3;\r\n  }\r\n  factors++;\r\n  \r\n  // Language match  \r\n  if (fp1.acceptLanguage === fp2.acceptLanguage) {\r\n    score += 0.1;\r\n  }\r\n  factors++;\r\n  \r\n  return factors > 0 ? score / factors : 0;\r\n};\r\n\r\n/**\r\n * Check if a device fingerprint is suspicious\r\n */\r\nexport const isSuspiciousFingerprint = (current: DeviceFingerprint, previous: DeviceFingerprint): boolean => {\r\n  const similarity = compareDeviceFingerprints(current, previous);\r\n  \r\n  // If similarity is very low, it might be a different device\r\n  if (similarity < 0.3) {\r\n    return true;\r\n  }\r\n  \r\n  // Check for obvious spoofing attempts\r\n  if (current.userAgent.includes('curl') || \r\n      current.userAgent.includes('wget') || \r\n      current.userAgent.includes('bot') ||\r\n      current.userAgent === 'unknown') {\r\n    return true;\r\n  }\r\n  \r\n  return false;\r\n};\r\n\r\n/**\r\n * Sanitize fingerprint data for logging (remove sensitive info)\r\n */\r\nexport const sanitizeFingerprint = (fp: DeviceFingerprint) => {\r\n  return {\r\n    hash: fp.hash.substring(0, 8) + '...', // Only show first 8 chars\r\n    userAgent: fp.userAgent.substring(0, 50) + (fp.userAgent.length > 50 ? '...' : ''),\r\n    acceptLanguage: fp.acceptLanguage,\r\n    ipNetwork: fp.ipNetwork\r\n  };\r\n};\r\n"],"version":3}