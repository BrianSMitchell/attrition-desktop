name: Cross-Browser Testing

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      browser_matrix:
        description: 'Browser matrix to test (all, desktop, mobile, electron)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - desktop
          - mobile
          - electron
          - specialty
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - auth
          - dashboard
          - game
          - forms
          - navigation
          - api
          - accessibility

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'
  PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/ms-playwright

jobs:
  setup:
    name: Setup Test Environment
    runs-on: ubuntu-latest
    outputs:
      test-matrix: ${{ steps.matrix.outputs.matrix }}
      should-run-tests: ${{ steps.changes.outputs.should-run }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for relevant changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "schedule" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should-run=true" >> $GITHUB_OUTPUT
          else
            # Check if there are changes in relevant directories
            git diff --name-only HEAD~1 HEAD | grep -E '\.(ts|tsx|js|jsx|vue|svelte|html|css|scss|json)$|playwright\.config|package\.json|\.github/workflows' && echo "should-run=true" >> $GITHUB_OUTPUT || echo "should-run=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate test matrix
        id: matrix
        run: |
          BROWSER_MATRIX="${{ github.event.inputs.browser_matrix || 'all' }}"
          
          if [ "$BROWSER_MATRIX" = "desktop" ]; then
            MATRIX='["chrome", "firefox", "safari", "edge"]'
          elif [ "$BROWSER_MATRIX" = "mobile" ]; then
            MATRIX='["chrome-mobile", "firefox-mobile", "safari-mobile"]'
          elif [ "$BROWSER_MATRIX" = "electron" ]; then
            MATRIX='["electron-main"]'
          elif [ "$BROWSER_MATRIX" = "specialty" ]; then
            MATRIX='["chrome-hidpi", "chrome-slow-network", "chrome-a11y", "chrome-dark"]'
          else
            MATRIX='["chrome", "firefox", "safari", "edge", "chrome-mobile", "firefox-mobile", "safari-mobile", "electron-main"]'
          fi
          
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  build-app:
    name: Build Application
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should-run-tests == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: |
          pnpm --filter @game/shared build
          pnpm --filter @game/client build
          pnpm --filter @game/desktop build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            packages/web/dist/
            packages/desktop/dist/
            packages/api/dist/
          retention-days: 1

  cross-browser-tests:
    name: Cross-Browser Tests (${{ matrix.project }})
    runs-on: ${{ matrix.os }}
    needs: [setup, build-app]
    if: needs.setup.outputs.should-run-tests == 'true'
    timeout-minutes: 45
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # Chrome Tests
          - project: chrome
            os: ubuntu-latest
            browser: chromium
          - project: chrome-mobile
            os: ubuntu-latest
            browser: chromium
          - project: chrome-hidpi
            os: ubuntu-latest
            browser: chromium
          - project: chrome-slow-network
            os: ubuntu-latest
            browser: chromium
          - project: chrome-a11y
            os: ubuntu-latest
            browser: chromium
          - project: chrome-dark
            os: ubuntu-latest
            browser: chromium
          - project: chrome-perf
            os: ubuntu-latest
            browser: chromium
          
          # Firefox Tests
          - project: firefox
            os: ubuntu-latest
            browser: firefox
          - project: firefox-mobile
            os: ubuntu-latest
            browser: firefox
          
          # Safari Tests (macOS only)
          - project: safari
            os: macos-latest
            browser: webkit
          - project: safari-mobile
            os: macos-latest
            browser: webkit
          
          # Edge Tests
          - project: edge
            os: windows-latest
            browser: chromium
          
          # Electron Tests
          - project: electron-main
            os: windows-latest
            browser: chromium
          
          # Tablet Tests
          - project: tablet-chrome
            os: ubuntu-latest
            browser: chromium
          
          # International Tests
          - project: chrome-es
            os: ubuntu-latest
            browser: chromium
          - project: chrome-fr
            os: ubuntu-latest
            browser: chromium
          - project: chrome-utc
            os: ubuntu-latest
            browser: chromium

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile
          cd e2e/cross-browser
          pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: |
          cd e2e/cross-browser
          npx playwright install ${{ matrix.browser }} --with-deps

      - name: Setup test environment
        run: |
          # Create test data directories
          mkdir -p e2e/test-results/cross-browser-output
          mkdir -p e2e/test-results/cross-browser-html-report
          
          # Set environment variables
          echo "BASE_URL=http://localhost:3000" >> $GITHUB_ENV
          echo "API_URL=http://localhost:3001/api" >> $GITHUB_ENV
          echo "TEST_ENV=ci" >> $GITHUB_ENV
          echo "HEADLESS=true" >> $GITHUB_ENV

      - name: Start test servers
        run: |
          # Start API server
          cd packages/api
          npm start &
          API_PID=$!
          echo "API_PID=$API_PID" >> $GITHUB_ENV
          
          # Start web server
          cd packages/web
          npm start &
          WEB_PID=$!
          echo "WEB_PID=$WEB_PID" >> $GITHUB_ENV
          
          # Wait for servers to be ready
          npx wait-on http://localhost:3001/health http://localhost:3000 --timeout 60000

      - name: Run cross-browser tests
        id: tests
        run: |
          cd e2e/cross-browser
          
          TEST_SUITE="${{ github.event.inputs.test_suite || 'all' }}"
          
          if [ "$TEST_SUITE" = "all" ]; then
            npx playwright test --project=${{ matrix.project }}
          else
            npx playwright test tests/$TEST_SUITE/ --project=${{ matrix.project }}
          fi
        env:
          PLAYWRIGHT_HTML_REPORT: ../test-results/cross-browser-html-report-${{ matrix.project }}

      - name: Stop test servers
        if: always()
        run: |
          if [ ! -z "$API_PID" ]; then kill $API_PID || true; fi
          if [ ! -z "$WEB_PID" ]; then kill $WEB_PID || true; fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.project }}
          path: |
            e2e/test-results/cross-browser-output/
            e2e/test-results/cross-browser-html-report-${{ matrix.project }}/
            e2e/test-results/cross-browser-results.json
            e2e/test-results/cross-browser-junit.xml
          retention-days: 7

      - name: Upload failure screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-screenshots-${{ matrix.project }}
          path: |
            e2e/test-results/cross-browser-output/**/*.png
            e2e/test-results/cross-browser-output/**/*.webm
          retention-days: 7

  visual-regression-tests:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    needs: [setup, build-app]
    if: needs.setup.outputs.should-run-tests == 'true'
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile
          cd e2e/visual
          pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: |
          cd e2e/visual
          npx playwright install chromium --with-deps

      - name: Start test servers
        run: |
          cd packages/api
          npm start &
          cd packages/web
          npm start &
          npx wait-on http://localhost:3001/health http://localhost:3000 --timeout 60000

      - name: Run visual regression tests
        run: |
          cd e2e/visual
          npx playwright test
        env:
          HEADLESS: true

      - name: Upload visual test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-test-results
          path: |
            e2e/test-results/visual-output/
            e2e/test-results/visual-html-report/
          retention-days: 7

  aggregate-results:
    name: Aggregate Test Results
    runs-on: ubuntu-latest
    needs: [cross-browser-tests, visual-regression-tests]
    if: always() && needs.setup.outputs.should-run-tests == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          merge-multiple: true
          path: aggregated-results/

      - name: Download visual test results
        uses: actions/download-artifact@v4
        with:
          name: visual-test-results
          path: aggregated-results/visual/

      - name: Generate aggregated report
        run: |
          cd aggregated-results/
          
          # Create summary report
          echo "# Cross-Browser Test Results" > test-summary.md
          echo "" >> test-summary.md
          echo "## Test Execution Summary" >> test-summary.md
          echo "- **Date**: $(date)" >> test-summary.md
          echo "- **Commit**: ${{ github.sha }}" >> test-summary.md
          echo "- **Branch**: ${{ github.ref_name }}" >> test-summary.md
          echo "" >> test-summary.md
          
          # Parse JUnit results if available
          if ls cross-browser-junit.xml >/dev/null 2>&1; then
            echo "## Test Results by Browser" >> test-summary.md
            # Parse JUnit XML and extract results
            # This would need a proper XML parser in a real implementation
            echo "Results parsed from JUnit XML files" >> test-summary.md
          fi
          
          # List all generated artifacts
          echo "" >> test-summary.md
          echo "## Available Artifacts" >> test-summary.md
          find . -name "*.html" -o -name "*.json" | head -20 | while read file; do
            echo "- $file" >> test-summary.md
          done

      - name: Upload aggregated results
        uses: actions/upload-artifact@v4
        with:
          name: aggregated-test-results
          path: aggregated-results/
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'aggregated-results/test-summary.md';
            
            if (fs.existsSync(path)) {
              const summary = fs.readFileSync(path, 'utf8');
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## Cross-Browser Test Results ðŸŒ\n\n${summary}\n\n[View detailed results in the Actions artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
              });
            }

  performance-analysis:
    name: Performance Analysis
    runs-on: ubuntu-latest
    needs: [cross-browser-tests]
    if: always() && needs.setup.outputs.should-run-tests == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-chrome-perf
          path: perf-results/

      - name: Analyze performance results
        run: |
          cd perf-results/
          
          # Create performance report
          echo "# Performance Analysis Report" > performance-report.md
          echo "" >> performance-report.md
          echo "## Performance Metrics" >> performance-report.md
          
          # Parse performance data from test results
          if [ -f "cross-browser-results.json" ]; then
            echo "Performance data found in test results" >> performance-report.md
            # In a real implementation, you would parse the JSON and extract performance metrics
          fi
          
          # Check for performance regressions
          echo "" >> performance-report.md
          echo "## Performance Regression Analysis" >> performance-report.md
          echo "Comparing against baseline performance metrics..." >> performance-report.md

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-analysis
          path: perf-results/performance-report.md
          retention-days: 30

  deploy-reports:
    name: Deploy Test Reports
    runs-on: ubuntu-latest
    needs: [aggregate-results]
    if: always() && needs.setup.outputs.should-run-tests == 'true' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download aggregated results
        uses: actions/download-artifact@v4
        with:
          name: aggregated-test-results
          path: reports/

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: reports/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  notify-results:
    name: Notify Test Results
    runs-on: ubuntu-latest
    needs: [cross-browser-tests, visual-regression-tests]
    if: always() && needs.setup.outputs.should-run-tests == 'true'
    
    steps:
      - name: Determine overall status
        id: status
        run: |
          if [ "${{ needs.cross-browser-tests.result }}" = "failure" ] || [ "${{ needs.visual-regression-tests.result }}" = "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          elif [ "${{ needs.cross-browser-tests.result }}" = "success" ] && [ "${{ needs.visual-regression-tests.result }}" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          else
            echo "status=partial" >> $GITHUB_OUTPUT
            echo "color=warning" >> $GITHUB_OUTPUT
          fi

      - name: Notify Slack
        if: env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "Cross-Browser Test Results",
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.color }}",
                  "fields": [
                    {
                      "title": "Status",
                      "value": "${{ steps.status.outputs.status }}",
                      "short": true
                    },
                    {
                      "title": "Branch",
                      "value": "${{ github.ref_name }}",
                      "short": true
                    },
                    {
                      "title": "Commit",
                      "value": "${{ github.sha }}",
                      "short": true
                    },
                    {
                      "title": "Results",
                      "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>",
                      "short": true
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create GitHub issue on failure
        if: failure() && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Cross-Browser Tests Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Cross-Browser Test Failure Report
            
            The cross-browser tests have failed on the main branch.
            
            **Details:**
            - **Commit**: ${{ github.sha }}
            - **Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Timestamp**: ${new Date().toISOString()}
            
            **Failed Jobs:**
            - Cross-Browser Tests: ${{ needs.cross-browser-tests.result }}
            - Visual Regression Tests: ${{ needs.visual-regression-tests.result }}
            
            Please review the test results and fix any failing tests.
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'testing', 'cross-browser']
            });

# Allow GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write
  issues: write
  pull-requests: write
