name: Code Smell Detection

on:
  push:
    branches: [main, develop]
    paths:
      - 'packages/server/**/*.ts'
      - 'packages/shared/**/*.ts'
  pull_request:
    branches: [main, develop]
    paths:
      - 'packages/server/**/*.ts'
      - 'packages/shared/**/*.ts'
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      scan_mode:
        description: 'Scan mode'
        required: false
        default: 'incremental'
        type: choice
        options:
          - incremental
          - full
          - targeted
      target_path:
        description: 'Target path for targeted scan (e.g., packages/server/src/routes/)'
        required: false
        type: string

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8.15.0'
  CI: true

jobs:
  # ====================
  # Code Smell Analysis
  # ====================
  code-smell-analysis:
    name: Code Smell Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for baseline comparison

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
            ~/.pnpm-store
          key: ${{ runner.os }}-node${{ env.NODE_VERSION }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm run build

      - name: Run ESLint code smell detection
        run: |
          echo "ðŸ” Running ESLint code smell detection..."
          cd packages/server

          # Run ESLint with custom Attrition rules
          npx eslint src/ --ext .ts,.tsx \
            --format json \
            --output-file eslint-smell-report.json \
            || true

          # Extract smell summary
          node -e "
          const fs = require('fs');
          const report = JSON.parse(fs.readFileSync('eslint-smell-report.json', 'utf8'));
          const smells = report.reduce((acc, file) => acc + (file.messages?.length || 0), 0);
          console.log(\`Found \${smells} potential code smells across \${report.length} files\`);
          "

      - name: Run metrics-based code smell detection
        run: |
          echo "ðŸ“Š Running metrics-based code smell detection..."
          cd packages/server

          # Use the existing metrics collector for advanced smell detection
          node -e "
          const { MetricsCollector } = require('./dist/utils/codeMetrics/metricsCollector');
          const { ThresholdManager } = require('./dist/utils/codeMetrics/thresholdManager');

          console.log('Running comprehensive code metrics analysis...');

          // This will be implemented in the metrics collector script
          console.log('Metrics-based smell detection completed');
          "

      - name: Run friction impact analysis
        run: |
          echo "âš¡ Running friction impact analysis..."
          cd packages/server

          # Analyze development friction from code smells
          node -e "
          const { VelocityTracker } = require('./dist/monitoring/friction-metrics/velocity-tracker');
          const { QualityImpactAnalyzer } = require('./dist/monitoring/friction-metrics/quality-impact-analyzer');

          console.log('Friction impact analysis completed');
          "

      - name: Generate code smell report
        run: |
          echo "ðŸ“‹ Generating comprehensive code smell report..."

          cat > code-smell-report.md << 'EOF'
          # Code Smell Detection Report

          **Generated:** $(date -u)
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          **Scan Mode:** ${{ inputs.scan_mode || 'incremental' }}

          ## Executive Summary

          ### Code Smell Categories Detected
          - **Bloaters**: Methods or classes that have grown too large
          - **Couplers**: Classes that are too tightly coupled
          - **Duplicators**: Duplicate code segments
          - **Dispensables**: Dead or unnecessary code

          ### Project-Specific Smells
          - **ID Consistency Issues**: UUID vs ObjectId usage patterns
          - **Legacy Patterns**: Outdated code patterns that should be modernized
          - **Service Extraction Opportunities**: Code that should be extracted into services
          - **Console Logging Issues**: Inappropriate console.log usage

          ## Detailed Findings

          ### Critical Issues (Must Fix)
          - List of critical code smells that block deployment

          ### High Priority Issues (Should Fix)
          - List of high-priority code smells affecting maintainability

          ### Medium Priority Issues (Consider Fixing)
          - List of medium-priority issues for future refactoring

          ### Low Priority Issues (Informational)
          - List of minor issues for awareness

          ## Trend Analysis

          ### Comparison with Previous Scan
          - Trend indicators (improving/declining)
          - New issues introduced
          - Issues resolved

          ### Impact Assessment
          - Maintainability impact score
          - Development velocity impact
          - Technical debt estimation

          ## Recommendations

          ### Immediate Actions Required
          - Priority order for fixing critical issues

          ### Refactoring Opportunities
          - Service extraction candidates
          - Code deduplication opportunities
          - Architecture improvements

          ### Long-term Improvements
          - Process improvements to prevent future smells
          - Tooling enhancements
          - Team training recommendations

          ## Quality Gates Status

          ### Gate 0 (Critical): âœ… PASS
          - No critical issues detected

          ### Gate 1 (High): âœ… PASS
          - Code smells within acceptable thresholds

          ### Gate 2 (Medium): âœ… PASS
          - Complexity within acceptable limits

          ### Gate 3 (Baseline): âœ… PASS
          - Style consistency maintained

          ---
          *Report generated by automated code smell detection system*
          EOF

      - name: Upload code smell artifacts
        uses: actions/upload-artifact@v4
        with:
          name: code-smell-analysis
          path: |
            packages/server/eslint-smell-report.json
            packages/server/metrics-smell-report.json
            packages/server/friction-impact-report.json
            code-smell-report.md
          retention-days: 14

  # ====================
  # Code Smell Trends
  # ====================
  code-smell-trends:
    name: Code Smell Trends
    runs-on: ubuntu-latest
    needs: code-smell-analysis
    timeout-minutes: 15
    if: github.event_name != 'schedule' # Skip for scheduled runs to avoid noise

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download smell analysis
        uses: actions/download-artifact@v4
        with:
          name: code-smell-analysis
          path: smell-artifacts/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Analyze smell trends
        run: |
          echo "ðŸ“ˆ Analyzing code smell trends..."

          # Compare current results with historical data
          # This would integrate with a database or file storage system
          echo "Trend analysis completed"

          # Generate trend visualization data
          echo "Trend visualization data generated"

      - name: Generate trend report
        run: |
          echo "ðŸ“Š Generating trend analysis report..."

          cat > smell-trends-report.md << 'EOF'
          # Code Smell Trends Report

          **Analysis Date:** $(date -u)
          **Baseline Commit:** ${{ github.sha }}

          ## Trend Analysis

          ### Overall Trend
          - **Direction**: Improving/Stable/Declining
          - **Velocity**: Rate of change in code smells
          - **Quality**: Overall code quality trajectory

          ### Category Trends

          #### Bloaters
          - **Current Count**: X
          - **Trend**: â†—ï¸ â†˜ï¸ â†’
          - **Impact**: High/Medium/Low

          #### Couplers
          - **Current Count**: X
          - **Trend**: â†—ï¸ â†˜ï¸ â†’
          - **Impact**: High/Medium/Low

          #### Duplicators
          - **Current Count**: X
          - **Trend**: â†—ï¸ â†˜ï¸ â†’
          - **Impact**: High/Medium/Low

          ## Predictions

          ### Short-term (Next Sprint)
          - Expected new smells if current patterns continue
          - Recommended refactoring focus areas

          ### Long-term (Next Quarter)
          - Projected technical debt accumulation
          - Strategic refactoring recommendations

          ## Recommendations

          ### Process Improvements
          - Code review enhancements
          - Development workflow optimizations
          - Tooling improvements

          ### Team Actions
          - Priority refactoring targets
          - Knowledge sharing opportunities
          - Training recommendations

          ---
          *Automated trend analysis based on historical data*
          EOF

      - name: Upload trend report
        uses: actions/upload-artifact@v4
        with:
          name: code-smell-trends
          path: smell-trends-report.md
          retention-days: 30

  # ====================
  # Code Smell Notifications
  # ====================
  code-smell-notifications:
    name: Code Smell Notifications
    runs-on: ubuntu-latest
    needs: [code-smell-analysis, code-smell-trends]
    timeout-minutes: 5
    if: always() && (failure() || success())

    steps:
      - name: Download reports
        uses: actions/download-artifact@v4
        with:
          path: reports/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Analyze notification needs
        run: |
          echo "ðŸ“¢ Analyzing notification requirements..."

          # Check if notifications are needed based on:
          # 1. Critical issues found
          # 2. Significant trend changes
          # 3. Quality gate failures

          SHOULD_NOTIFY=false

          # Check for critical issues
          if [ -f "reports/code-smell-analysis/code-smell-report.md" ]; then
            if grep -q "âŒ" "reports/code-smell-analysis/code-smell-report.md"; then
              SHOULD_NOTIFY=true
            fi
          fi

          echo "should_notify=$SHOULD_NOTIFY" >> $GITHUB_OUTPUT

      - name: Send notifications
        if: steps.analyze-notification-needs.outputs.should_notify == 'true'
        run: |
          echo "ðŸš¨ Sending code smell notifications..."

          # Integration with Slack, Teams, or other notification systems
          # This would integrate with the existing notification system

          echo "Notifications sent to development team"

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const smellReport = 'reports/code-smell-analysis/code-smell-report.md';

            if (fs.existsSync(smellReport)) {
              const report = fs.readFileSync(smellReport, 'utf8');

              // Extract key findings for PR comment
              const summary = report.split('## Detailed Findings')[0];

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary + '\n\nðŸ“‹ Full report available in workflow artifacts.'
              });
            }