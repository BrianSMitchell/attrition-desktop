name: Social Media Updates

on:
  # Trigger on pushes to main branch
  push:
    branches:
      - main
  
  # Trigger on new releases
  release:
    types: [published]
  
  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      message:
        description: 'Custom message to post'
        required: false
        type: string

jobs:
  post-to-social:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Get the last 2 commits to compare changes
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Generate commit summary
      id: commit-info
      run: |
        # Get the latest commit info
        COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
        COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
        COMMIT_HASH=$(git log -1 --pretty=format:"%h")
        
        # Get changed files summary
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | head -5)
        FILES_COUNT=$(git diff --name-only HEAD~1 HEAD | wc -l)
        
        # Detect the type of changes
        if echo "$CHANGED_FILES" | grep -q "packages/client"; then
          CHANGE_TYPE="üéÆ Client"
        elif echo "$CHANGED_FILES" | grep -q "packages/server"; then
          CHANGE_TYPE="‚öôÔ∏è Server"
        elif echo "$CHANGED_FILES" | grep -q "packages/desktop"; then
          CHANGE_TYPE="üñ•Ô∏è Desktop"
        else
          CHANGE_TYPE="üîß Core"
        fi
        
        # Create tweet content based on event type
        if [ "${{ github.event_name }}" = "release" ]; then
          TWEET_TEXT="üöÄ New Attrition release ${{ github.event.release.tag_name }} is live! ${{ github.event.release.name }} - Play now and experience the latest improvements! üéÆ #GameDev #MMO #IndieGame #Gaming"
        else
          TWEET_TEXT="$CHANGE_TYPE update pushed to Attrition! üìù $COMMIT_MESSAGE üîß $FILES_COUNT files updated üë®‚Äçüíª by $COMMIT_AUTHOR - Development never stops! üí™ #GameDev #MMO #IndieGame #Coding"
        fi
        
        echo "tweet_text<<EOF" >> $GITHUB_OUTPUT
        echo "$TWEET_TEXT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
        echo "files_count=$FILES_COUNT" >> $GITHUB_OUTPUT
        echo "change_type=$CHANGE_TYPE" >> $GITHUB_OUTPUT
    
    - name: Post to Twitter
      run: |
        # Use custom message if provided via manual trigger, otherwise use generated message
        TWEET_TEXT="${{ github.event.inputs.message }}"
        if [ -z "$TWEET_TEXT" ]; then
          TWEET_TEXT="${{ steps.commit-info.outputs.tweet_text }}"
        fi
        
        echo "üìù Posting tweet: $TWEET_TEXT"
        
        # Post to Twitter using our custom script
        node .github/scripts/post-to-twitter.js "$TWEET_TEXT"
      env:
        TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
        TWITTER_API_KEY_SECRET: ${{ secrets.TWITTER_API_KEY_SECRET }}
        TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
        TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
    
    - name: Create commit comment
      if: github.event_name == 'push'
      uses: actions/github-script@v7
      with:
        script: |
          const tweet_text = `${{ steps.commit-info.outputs.tweet_text }}`;
          
          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `üê¶ **Social Media Update Posted**\n\n${tweet_text}\n\n---\n*Automated by Social Media Workflow*`
          });