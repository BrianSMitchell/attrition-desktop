name: Social Media Updates

on:
  # Trigger on pushes to main branch
  push:
    branches:
      - main
  
  # Trigger on new releases
  release:
    types: [published]
  
  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      message:
        description: 'Custom message to post (optional - will enhance with AI if provided)'
        required: false
        type: string
      tone:
        description: 'Content tone for AI generation'
        required: false
        default: 'auto'
        type: choice
        options:
        - auto
        - excited
        - professional
        - casual
      platform:
        description: 'Target platform'
        required: false
        default: 'twitter'
        type: choice
        options:
        - twitter
        - linkedin
      dry_run:
        description: 'Test mode - generate content but do not post'
        required: false
        default: false
        type: boolean

jobs:
  post-to-social:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Get the last 2 commits to compare changes
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    # Note: Removed legacy commit summary generation
    # Context-aware social media posting now handles intelligent content generation
    
    - name: Install Dependencies
      run: |
        # Install dependencies for enhanced social media posting
        npm install
    
    - name: Context-Aware Social Media Post
      run: |
        # Set up variables from workflow inputs or defaults
        TONE="${{ github.event.inputs.tone || 'auto' }}"
        PLATFORM="${{ github.event.inputs.platform || 'twitter' }}"
        DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
        CUSTOM_MESSAGE="${{ github.event.inputs.message }}"
        
        # Override tone based on event type if not manually specified
        if [ "${{ github.event.inputs.tone }}" = "" ] && [ "${{ github.event_name }}" = "release" ]; then
          TONE="excited"
        fi
        
        # Build command arguments
        ARGS="--tone $TONE --platform $PLATFORM"
        
        if [ "$DRY_RUN" = "true" ]; then
          ARGS="$ARGS --dry-run"
        fi
        
        # Execute with or without custom message
        if [ -n "$CUSTOM_MESSAGE" ]; then
          echo "üìù Using custom message with AI enhancement"
          echo "Message: $CUSTOM_MESSAGE"
          echo "Tone: $TONE, Platform: $PLATFORM, Dry Run: $DRY_RUN"
          node scripts/lib/context-aware-social-post.js $ARGS "$CUSTOM_MESSAGE"
        else
          echo "ü§ñ Using full AI-powered context-aware content generation"
          echo "Tone: $TONE, Platform: $PLATFORM, Dry Run: $DRY_RUN"
          node scripts/lib/context-aware-social-post.js $ARGS
        fi
      env:
        # Twitter API credentials
        TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
        TWITTER_API_KEY_SECRET: ${{ secrets.TWITTER_API_KEY_SECRET }}
        TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
        TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        # AI service credentials for context-aware content generation
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    
    - name: Create commit comment
      if: github.event_name == 'push'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `ü§ñ **Context-Aware Social Media Update Posted**\n\nüé® AI-powered content generated and posted based on development activity\n\n‚ú® **Features used:**\n- Git commit analysis\n- Project structure analysis  \n- Intelligent tone selection\n- Context-aware content generation\n\n---\n*Powered by Context Analysis Engine*`
          });
