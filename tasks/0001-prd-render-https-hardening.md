# PRD: Render HTTPS Health/Redirect Hardening (Reverse Proxy TLS)

## 1. Introduction / Overview
This feature ensures the backend behaves correctly when deployed behind a reverse proxy (Render) that terminates TLS at the edge. Our server currently enforces HTTPS and runs an internal HTTPS health monitor designed for "self-hosted HTTPS." On Render, there is no local HTTPS server listening on localhost:443—TLS is handled by Render—so the internal monitor reports false failures (e.g., "HTTPS server not listening on port 443", certificate validation failed) and logs periodic CRITICAL alerts.

Goal: Provide a robust, production-safe configuration that:
- Detects reverse proxy TLS environments and disables local HTTPS health checks.
- Avoids HTTP→HTTPS redirect warnings generated by our own probes.
- Keeps security headers and HTTPS enforcement intact for real traffic.
- Documents behavior and testing expectations for junior developers.

Primary environment: Render.com (reverse proxy terminating TLS)

## 2. Goals
1. Eliminate recurring CRITICAL/ERROR log noise about localhost:443 when running on Render.
2. Maintain HTTPS enforcement (via proxy) and security headers for user-facing traffic.
3. Provide a health endpoint behavior that clearly communicates "reverse proxy SSL mode".
4. Keep development support for local HTTPS testing intact (FORCE_HTTPS=true) without affecting production on Render.
5. Document configuration, environment variables, and verification steps suitable for a junior developer.

## 3. User Stories
- As a developer deploying to Render, I want the server to recognize reverse proxy TLS so that internal HTTPS checks don’t fail and pollute logs.
- As a developer, I want a clear health endpoint response in reverse proxy mode so I can quickly see that TLS is correctly handled by the proxy.
- As a developer, I want to preserve strong security headers and HTTP→HTTPS behavior for end users while avoiding false positives from internal checks.

## 4. Functional Requirements
1. Reverse Proxy Detection
   1.1. The server must detect reverse proxy TLS mode via environment flags (USE_REVERSE_PROXY_SSL=true and/or RENDER=true).
   1.2. When in reverse proxy mode, the server must not attempt local HTTPS probes to https://localhost:443.

2. HTTPS Health Monitoring
   2.1. In reverse proxy mode, periodic HTTPS monitoring must be disabled.
   2.2. The /api/https-health route must respond with HTTP 200 and a message indicating that local HTTPS checks are skipped due to reverse proxy TLS termination.
   2.3. The response should include a minimal structured payload that clarifies the reason (e.g., "Reverse proxy SSL termination detected; local HTTPS endpoint not expected. Skipping local checks.").

3. HTTP→HTTPS Enforcement Behavior
   3.1. In production behind a proxy, the server must rely on X-Forwarded-Proto to determine secure requests.
   3.2. The HTTPS redirect middleware must not repeatedly warn on health endpoints due to internal probes.
   3.3. The middleware must continue to enforce HTTPS for real traffic (browser/API clients) as observed via proxy headers.

4. Security Headers
   4.1. Security headers (via helmet and related middleware) must remain enabled in production.
   4.2. The /health and /api/status endpoints must return appropriate security headers when accessed via HTTPS through the proxy.

5. Configuration & Documentation
   5.1. The PRD and repository docs must list relevant environment variables and their meaning:
       - NODE_ENV, PORT, HTTPS_PORT (optional), USE_REVERSE_PROXY_SSL, RENDER, CORS_ORIGIN, HTTPS_HEALTH_CHECK_INTERVAL_MINUTES (optional for non-proxy mode).
   5.2. Provide a step-by-step verification guide for Render deployment.

## 5. Non-Goals (Out of Scope)
- Running a local HTTPS listener in production on Render (TLS is handled by Render).
- Certificate pinning or advanced certificate validation against edge certs.
- Changing the global helmet/CSP policy beyond verifying current behavior on health/status endpoints.
- WAF, CDN routing policies, or DNS configuration beyond Render’s standard setup.
- Multi-cloud reverse proxy abstraction (we remain Render-focused in scope).

## 6. Design Considerations (Optional)
- Health Experience: In reverse proxy mode, /api/https-health should clearly communicate that local TLS checks are bypassed and that TLS is expected to be terminated upstream.
- Logs: Prefer INFO level logs that confirm reverse proxy detection and explicitly note that local monitoring is disabled. Avoid noisy warnings.
- Backwards Compatibility: For non-proxy/self-hosted deployments, local HTTPS monitoring can remain available when a local HTTPS server is actually in use.

## 7. Technical Considerations (Optional)
- Reverse Proxy Detection: Use either USE_REVERSE_PROXY_SSL=true or the presence of RENDER=true (Render sets RENDER by default) to enable proxy-aware behavior.
- Trust Proxy: app.set('trust proxy', 1) should remain enabled so req.secure and req.get('X-Forwarded-Proto') are correct behind Render.
- Middleware Order: Keep security and HTTPS redirect middleware early, but ensure they do not generate self-induced warnings.
- Environment Variables:
  - NODE_ENV=production
  - USE_REVERSE_PROXY_SSL=true (recommended explicit flag)
  - RENDER=true (Render default)
  - PORT=3001 (or rely on Render’s assigned PORT)
  - HTTPS_PORT (used only for self-hosted HTTPS testing)
  - HTTPS_HEALTH_CHECK_INTERVAL_MINUTES (used only when not in reverse proxy mode)
  - CORS_ORIGIN (existing behavior preserved)

## 8. Success Metrics
- 0 recurring CRITICAL/ERROR HTTPS health alerts in Render logs over 24–48 hours post-deploy.
- /api/status returns { secure: true } when accessed via the Render URL over HTTPS.
- /api/https-health returns HTTP 200 with a clear message that reverse proxy TLS is enabled and local checks are skipped.
- No repeating “PRODUCTION HTTP→HTTPS redirect” warnings caused by internal probes.
- Security headers present on /health and /api/status when accessed via HTTPS through the proxy.

## 9. Open Questions
- Should we unify flags and rely solely on RENDER=true, or keep USE_REVERSE_PROXY_SSL for explicitness in other reverse proxy providers (e.g., Cloudflare, Nginx ingress)?
- Do we want a runtime toggle (e.g., admin route or env) to temporarily enable local HTTPS checks for debugging in non-Render environments?
- Should we add an optional upstream verification (e.g., ping a known external HTTPS URL) strictly for connectivity sanity, without conflating it with local TLS health?
